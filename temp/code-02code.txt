


/*******************************************************************************
 File : \code\adpt\cache\cacheFile.php 
*******************************************************************************/
<?php
/**
 * php文件缓存类 FileCache<br/>
 * @author Jerryli(hzjerry@gmail.com)
 * @version V0.20130513
 * @package
 * @example
 * <pre>
 * $oFC = new cacheFile('./tmp/'); //创建文件缓存类
 * $sKey = 'ab_123'; //缓存键值
 * $data = $oFC->get($sKey); //取得缓存
 * if(is_null($data))
 * &nbsp;&nbsp;$oFC->set($sKey, array('name'=>'ttt', 'datetime'=>date('Y-m-d H:i:s')), 10); //缓存不存在创建缓存
 * print_r($data);
 * </pre>
 */

//define('DIR_VARS', '/@vary');
 
final class cacheFile{
	
	private static $cacPath  = null; //缓存目录
	const cacExp = 3600; //默认缓存失效时间(1小时)

	function __construct($setPath='/cache/'){
		if(is_null(self::$cacPath)) self::$cacPath = DIR_DTMP.$setPath;	
	}

	/**
	 * 读取缓存<br />
	 * 返回: 缓存内容,字符串或数组；缓存为空或过期返回null
	 */
	function get($sKey){
		if(empty($sKey)) return false;
		$sFile  = self::getFileName($sKey);
		if(!file_exists($sFile)) return null;
		$handle = fopen($sFile,'rb');
		if(intval(fgets($handle)) > time()){ //未失效期，取出数据
			$sData = fread($handle, filesize($sFile)); 
			fclose($handle);
			return unserialize($sData);
		}else{	//已经失效期
			fclose($handle);
			return null;
		}
	}

	//写入缓存
	function set($sKey, $mVal, $iExpire=null){
		if(empty($sKey)) return false;
		$sFile = self::getFileName($sKey,1); //echo $sFile;
		if(!$sFile) return false;
		$aBuf = array();
		$aBuf[] = time() + ((empty($iExpire)) ? self::cacExp : intval($iExpire));
		$aBuf[] = serialize($mVal);
		$handle = fopen($sFile,'wb');/*写入文件操作*/
		fwrite($handle, implode("\n", $aBuf));
		fclose($handle);
		return true;
	}

	//删除指定的缓存键值
	function del($sKey){
		if(empty($sKey)) return false;
		@unlink(self::getFileName($sKey));
		return true;
	}

	/**
	 * 获取缓存文件全路径<br />
	 * 返回: 缓存文件全路径<br />
	 * $sKey的值会被转换成md5(),并分解为3级目录进行访问
	 */
	static function getFileName($sKey,$mkdir=0){
		if(empty($sKey)) return false;
		$key_md5 = md5($sKey);
		$aFileName = array();
		$aFileName[] = rtrim(self::$cacPath,'/');
		$aFileName[] = $key_md5{0} . $key_md5{1};
		$aFileName[] = $key_md5{2} . $key_md5{3};
		$aFileName[] = $key_md5{4} . $key_md5{5};
		$aFileName[] = strlen($sKey)>32 ? $key_md5 : basStr::filKey($sKey); 
		if($mkdir){
			$base = $aFileName[0];
			foreach(array(1,2,3) as $k){
				$tmp = $base.'/'.$aFileName[$k];
				if(!is_dir($tmp)){
					$flag = mkdir($tmp, 0666);
					if(!$flag) return false;
				}
				$base = $tmp;
			}
		}
		return implode('/', $aFileName);
	}

}
?>


/*******************************************************************************
 File : \code\adpt\cache\cacheMemc.php 
*******************************************************************************/
<?php
// 是一个原生版本，完全在php框架内开发的。
class cacheMemc {
	private $mmc = NULL;
    private $group = ''; 
    private $ver = 0;
    function __construct( $mcfgs = array() ) {
		$this->mmc = new Memcache;
		if( empty($mcfgs) ) {
			$mcfgs['MEM_SERVER'] = array(array('127.0.0.1', 11211));
			$mcfgs['MEM_GROUP'] = '';
		}
		foreach($mcfgs['MEM_SERVER'] as $config) {
			call_user_func_array(array($this->mmc, 'addServer'), $config);
		}
		$this->group = $mcfgs['MEM_GROUP'];
		$this->ver = intval( $this->mmc->get($this->group.'_ver') );
    }

	//读取缓存
    function get($key) {
		return $this->mmc->get($this->group.'_'.$this->ver.'_'.$key);
    }
	
	//设置缓存
    function set($key, $value, $expire = 1800) {
		return $this->mmc->set($this->group.'_'.$this->ver.'_'.$key, $value, 0, $expire);
    }
	
	//自增1
	function inc($key, $value = 1) {
		 return $this->mmc->increment($this->group.'_'.$this->ver.'_'.$key, $value);
    }
	
	//自减1
	function des($key, $value = 1) {
		 return $this->mmc->decrement($this->group.'_'.$this->ver.'_'.$key, $value);
    }
	
	//删除
	function del($key) {
		return $this->mmc->delete($this->group.'_'.$this->ver.'_'.$key);
	}
	
	//全部清空
    function clear() {
        return  $this->mmc->set($this->group.'_ver', $this->ver+1); 
    }	
}



/*******************************************************************************
 File : \code\adpt\cache\cacheMemd.php 
*******************************************************************************/
<?php
// 建立在libmemcached的基础上，memcached版本的功能更全一些。 
class cacheMemd {
	private $mmc = NULL;
    private $group = ''; 
    private $ver = 0;
    function __construct( $mcfgs = array() ) {
		$this->mmc = new Memcached;
		if( empty($mcfgs) ) {
			$mcfgs['MEM_SERVER'] = array(array('127.0.0.1', 11211));
			$mcfgs['MEM_GROUP'] = '';
		}
		foreach($mcfgs['MEM_SERVER'] as $config) {
			call_user_func_array(array($this->mmc, 'addServer'), $config);
		}
		$this->group = $mcfgs['MEM_GROUP'];
		$this->ver = intval( $this->mmc->get($this->group.'_ver') );
    }

	//读取缓存
    function get($key) {
		return $this->mmc->get($this->group.'_'.$this->ver.'_'.$key);
    }
	
	//设置缓存
    function set($key, $value, $expire = 1800) {
		return $this->mmc->set($this->group.'_'.$this->ver.'_'.$key, $value, $expire);
    }
	
	//自增1
	function inc($key, $value = 1) {
		 return $this->mmc->increment($this->group.'_'.$this->ver.'_'.$key, $value);
    }
	
	//自减1
	function des($key, $value = 1) {
		 return $this->mmc->decrement($this->group.'_'.$this->ver.'_'.$key, $value);
    }
	
	//删除
	function del($key) {
		return $this->mmc->delete($this->group.'_'.$this->ver.'_'.$key);
	}
	
	//全部清空
    function clear() {
        return  $this->mmc->set($this->group.'_ver', $this->ver+1); 
    }	
}



/*******************************************************************************
 File : \code\adpt\cache\cacheSaem.php 
*******************************************************************************/
<?php
// Memcache@新浪云平台
class cacheSaem {
	private $mmc = NULL;
    private $group = ''; 
    private $ver = 0;
    function __construct( $mcfgs = array() ) {
		$this->mmc = memcache_init();
		$this->group = $mcfgs['SAE_MEM_GROUP'];
		$this->ver = intval( memcache_get($this->mmc, $this->group.'_ver') ); 
    }

	//读取缓存
    function get($key) {
		$expire = memcache_get($this->mmc, $this->group.'_'.$this->ver.'_time_'.$key);
		if(intval($expire) > time() ) {
			 return memcache_get($this->mmc, $this->group.'_'.$this->ver.'_'.$key);
		} else {
			return false;
		}
    }
	
	//设置缓存
    function set($key, $value, $expire = 1800) {
		$expire = ($expire == -1)? time()+365*24*3600 : time() + $expire;
		memcache_set($this->mmc, $this->group.'_'.$this->ver.'_time_'.$key, $expire);//写入缓存时间
		return memcache_set($this->mmc, $this->group.'_'.$this->ver.'_'.$key, $value);
    }
	
	//自增1
	function inc($key, $value = 1) {
		  return $this->set($key, intval($this->get($key)) + intval($value), -1);
    }
	
	//自减1
	function des($key, $value = 1) {
		 return $this->set($key, intval($this->get($key)) - intval($value), -1);
    }
	
	//删除
	function del($key) {
		return $this->set($key, '', 0);
	}
	
	//全部清空
    function clear() {
        return  memcache_set($this->mmc, $this->group.'_ver', $this->ver+1); 
    }
	
}


/*******************************************************************************
 File : \code\adpt\cron\clear_acts.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// 1. 可用:db,stamp
// 2. 返回:$rdo = pass/fail

$rdo = 'fail';

$stnow = $stamp; // 432000=5day, 86400=1天 active_online

$db->table('active_admin')->where("stime<'".($stnow-432000)."'")->delete(); 
$db->table('active_online')->where("stime<'".($stnow-432000)."'")->delete(); 	
$db->table('active_session')->where("exp<'".($stnow-3600)."'")->delete();

$rdo = 'pass';




/*******************************************************************************
 File : \code\adpt\cron\clear_logs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// 1. 可用:db,stamp
// 2. 返回:$rdo = pass/fail

$rdo = 'fail';

$stnow = $stamp; // 432000=5day, 86400=1天 active_online

foreach(array('logs_syact','logs_detmp','plus_smsend') as $tab){
	$db->table($tab)->where("atime<'".($stnow-60*86400)."'")->delete();
}
$db->table('logs_dbsql')->where("atime<'".($stnow-86400)."'")->delete();

$rdo = 'pass';




/*******************************************************************************
 File : \code\adpt\cron\clear_wex.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// 1. 可用:db,stamp
// 2. 返回:$rdo = pass/fail

$rdo = 'fail';

$stnow = $stamp; // 432000=5day, 86400=1天 active_online

foreach(array('wex_locate','wex_msgget','wex_msgsend','wex_qrcode') as $tabid){
	$whrex = $tabid=='wex_qrcode' ? " AND sid>'123000'" : '';
	$db->table($tabid)->where("atime<'".($stnow-432000)."'")->delete();
}

$rdo = 'pass';




/*******************************************************************************
 File : \code\adpt\cron\demo_file.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// 1. 可用:db,stamp
// 2. 返回:$re = array('rdo'=>'pass/fail')

$rdo = 'fail';

usleep(5);
// dosth

$rdo = 'pass';

/*

$db->table('active_online')->where("stime<'".($stnow-432000)."'")->delete(); 	
$db->table($this->tab)->data($data)->where("kid='$file'")->update(); 
$list = $db->table($tab)->field($cfg[1])->where($cfg[0])->select();
	foreach($list as $row){
		$fa = explode(',',$cfg[1]);
	}
}
			
*/




/*******************************************************************************
 File : \code\adpt\dbdrv\db_mysql.php 
*******************************************************************************/
<?php
//mysql数据库基类
class db_mysql {
	
	public $link;	
	public $lastID = 0;
	public $affRows = 0;
	public $dbName = '';
	public $config = array();
	
    // 初始化,是否支持mysqli
    function __construct(){
        if(!function_exists('mysql_connect')){
			glbError::show('mysql NOT SUPPERT!'); 
        } 
    }
	//连接数据库
	function connect($config=array()){ 
		$this->dbName = $config['db_name'];
		$this->config = $config; 
		if(!empty($config['db_conn'])){
			if(!$this->link = @mysql_pconnect($config['db_host'].':'.$config['db_port'], $config['db_user'], $config['db_pass'])){
				$this->error('mysql_connect Error!');
			}
		}else{
			if(!$this->link = @mysql_connect($config['db_host'].':'.$config['db_port'], $config['db_user'], $config['db_pass'])){
				$this->error('mysql_connect Error!');
			}
		}
		if($this->link){
			// if($this->version() > '5.0.1')
			mysql_query("SET character_set_connection=".$config['db_cset'].", character_set_results=".$config['db_cset'].", character_set_client=binary", $this->link);
			mysql_query("SET sql_mode=''", $this->link);
			return mysql_select_db($config['db_name'], $this->link);
		}
	}

	//查询sql语句// select
	function query($sql, $re='def'){
		if(!($res = mysql_query($sql, $this->link))){
			$this->error('MySQL Query Error', $sql);
		}
		if($re=='def'){ //关系数组
			$data = array();
			while($row=mysql_fetch_array($res, 1)) $data[]=$row;
			return $data;
		}else{ //MYSQL_NUM(2) : MYSQL_ASSOC(1) :MYSQL_BOTH(3) 
			$mode = intval($re); $mode = $mode==2 ? 2 : 1;
			return mysql_fetch_array($res, $mode);
		}
	}
	function arr($sql) { // fetch_array
		return $this->query($sql);
	}
	function row($sql, $type=1) { // row
		return $this->query($sql, $type);
	}
	function val($sql) { // val
		$row = $this->row($sql, 2); 
		return @$row[0];
	}
    // 执行语句(update, delete insert, other)
    function run($sql, $rTimer=0){ 
		if(!($query = mysql_query($sql, $this->link))){
			$this->error('MySQL Query Error', $sql);
		}
		if($rTimer) return 0; // Timer Return
		$this->affRows = mysql_affected_rows($this->link);
		if(preg_match("/^\s*(INSERT\s+INTO|REPLACE\s+INTO)\s+/i", $sql)) {
			$this->lastID = ($id = mysql_insert_id($this->link)) >= 0 ? $id : 0;
		}
		return $this->lastID;
        //如果 AUTO_INCREMENT 的列的类型是 BIGINT，则 mysql_insert_id() 返回的值将不正确。
        //可以在 SQL 查询中用 MySQL 内部的 SQL 函数 LAST_INSERT_ID() 来替代。
        //$rs = mysql_query("Select LAST_INSERT_ID() as lid",$this->linkID);
        //$row = mysql_fetch_array($rs);
        //return $row["lid"];
	}
	
	// 取得数据表的字段信息
	function fields($tab){
		$q = mysql_query("show full fields from $tab", $this->link);
		$a = array();
		while($r=mysql_fetch_assoc($q)){
			$k = $r['Field']; 
			$t['name'] = $k;
			$t['type'] = $r['Type'];
			$t['notnull'] = $r['Null']==='NO';
			$t['default'] = $r['Default'];
			$t['primary'] = $r['Key']==='PRI'; //!empty()
			$t['autoinc'] = $r['Extra']==='auto_increment';
			$t['Comment'] =  $r['Comment'];
			$a[$k] = $t;	
		}
		return $a;
	}
	// 取得数据库的表信息
	function tables(){
		$dbname = $this->dbName;
		$q = mysql_query("SHOW TABLES FROM $dbname", $this->link);
		$a = array();
		while($r = mysql_fetch_row($q)){ 
			$a[] = $r[0];
		}
		return $a;
	}
	// 取得数据库的表信息
	function tabinfo(){
		$dbname = $this->dbName;
		$q = mysql_query("SHOW TABLE STATUS", $this->link);
		$a = array();
		while($r = mysql_fetch_array($q,1)){
			$a[] = $r; 
		}
		return $a;
	}
	// 取得创建表sql
	function create($tab){
		$q = mysql_query("SHOW CREATE TABLE $tab", $this->link);
		$r = mysql_fetch_row($q);
		return $r[1];
	}
	
	//返回quoteSql语句
	function quoteSql($sql){
		return mysql_real_escape_string($sql);
	}
	
	//输出错误信息
	function error($message='', $sql='') {
		$sql = basDebug::hidInfo($sql,1);
		$func = @$this->config['efunc'];
		if($func) return $func($message);
		$error = (($this->link) ? mysql_error($this->link) : mysql_error());
		$errorno = intval(($this->link) ? mysql_errno($this->link) : mysql_errno());
		$str= "	<i>Info</i>: $message<br>
				<i>SQL</i>: $sql<br>
				<i>Detail</i>: $error<br>
				<i>Code</i>:$errorno"; 
		glbError::show($str); 
	}
	//释放结果内存
	function free($query) {
		return mysql_free_result($query);
	}

	function close(){
		if($this->link) @mysql_close($this->link);
	}
	function __destruct(){
		$this->close();
	}
}




/*******************************************************************************
 File : \code\adpt\dbdrv\db_mysqli.php 
*******************************************************************************/
<?php
//mysqli数据库基类
class db_mysqli {
	
	public $link;	
	public $lastID = 0;
	public $affRows = 0;
	public $dbName = '';
	public $config = array();
	
    // 初始化,是否支持mysqli
    function __construct(){
        if(!function_exists('mysqli_connect')){
			glbError::show('mysqli NOT SUPPERT!'); 
        } 
    }
	//连接数据库
	function connect($config=array()){
		$this->dbName = $config['db_name'];
		$this->config = $config; 
		if(!$this->link = @mysqli_connect($config['db_host'], $config['db_user'], $config['db_pass'], $config['db_name'], $config['db_port'])) {
			$this->error('mysqli_connect Error!');
		}else{
			mysqli_query($this->link, "SET character_set_connection=".$config['db_cset'].", character_set_results=".$config['db_cset'].", character_set_client=binary");
		}
		/*/ 
		mysqli_query($this->link, "SET sql_mode=''");
		return mysqli_select_db($this->link, $config['db_name']);
		//*/
	}
	
	//查询sql语句// select
	function query($sql, $re='def'){
		if(!($res = mysqli_query($this->link, $sql))){
			$this->error('MySQL Query Error', $sql);
		}
		if($re=='def'){ //关系数组
			$data = array();
			while($row=mysqli_fetch_array($res, 1)) $data[]=$row;
			return $data;
		}else{ //MYSQL_NUM(2) : MYSQL_ASSOC(1) :MYSQL_BOTH(3) 
			$mode = intval($re); $mode = $mode==2 ? 2 : 1;
			return mysqli_fetch_array($res, $mode);
		}
	}
	function arr($sql) { // fetch_array
		return $this->query($sql);
	}
	function row($sql, $type=1) { // row
		return $this->query($sql, $type);
	}
	function val($sql) { // val
		$row = $this->row($sql, 2);
		return @$row[0];
	}
    // 执行语句(update, delete insert, other)
    function run($sql, $rTimer=0){ 
		if(!($query = mysqli_query($this->link, $sql))){
			$this->error('MySQL Query Error', $sql);
		}
		if($rTimer) return 0; // Timer Return
		$this->affRows = mysqli_affected_rows($this->link);
		if(preg_match("/^\s*(INSERT\s+INTO|REPLACE\s+INTO)\s+/i", $sql)) {
			$this->lastID = ($id = mysqli_insert_id($this->link)) >= 0 ? $id : 0;
		}
		return $this->lastID;
        //如果 AUTO_INCREMENT 的列的类型是 BIGINT，则 mysqli_insert_id() 返回的值将不正确。
        //可以在 SQL 查询中用 MySQL 内部的 SQL 函数 LAST_INSERT_ID() 来替代。
        //$rs = mysqli_query($this->linkID, "Select LAST_INSERT_ID() as lid");
        //$row = mysqli_fetch_array($rs);
        //return $row["lid"];
	}
	
	// 取得数据表的字段信息
	function fields($tab){
		$q = mysqli_query($this->link, "show full fields from $tab");
		$a = array();
		if($q){
		while($r=mysqli_fetch_assoc($q)){
			$k = $r['Field']; 
			$t['name'] = $k;
			$t['type'] = $r['Type'];
			$t['notnull'] = $r['Null']==='NO';
			$t['default'] = $r['Default'];
			$t['primary'] = $r['Key']==='PRI'; //!empty()
			$t['autoinc'] = $r['Extra']==='auto_increment';
			$t['Comment'] =  $r['Comment'];
			$a[$k] = $t;	
		} }
		return $a;
	}
	// 取得数据库的表信息
	function tables(){
		$dbname = $this->dbName;
		$q = mysqli_query($this->link, "SHOW TABLES FROM $dbname"); 
		$a = array();
		while($r = mysqli_fetch_row($q)){
			$a[] = $r[0]; 
		}
		return $a;
	}
	// 取得数据库的表信息
	function tabinfo(){
		$dbname = $this->dbName;
		$q = mysqli_query($this->link, "SHOW TABLE STATUS");
		$a = array();
		while($r = mysqli_fetch_array($q,1)){
			$a[] = $r; 
		}
		return $a;
	}
	// 取得创建表sql
	function create($tab){ 
		$q = mysqli_query($this->link, "SHOW CREATE TABLE $tab");
		$r = mysqli_fetch_row($q); 
		return $r[1];
	}
	
	//返回quoteSql语句
	function quoteSql($sql){
		return mysqli_real_escape_string($this->link,$sql);
	}

	//输出错误信息
	function error($message='', $sql='') { 
		$sql = basDebug::hidInfo($sql,1);
		$func = @$this->config['efunc'];
		if($func) return $func($message);
		@$error = (($this->link) ? mysqli_error($this->link) : mysqli_error());
		@$errorno = intval(($this->link) ? mysqli_errno($this->link) : mysqli_errno());
		$str = "	<i>Info</i>: $message<br>
				<i>SQL</i>: $sql<br>
				<i>Detail</i>: $error<br>
				<i>Code</i>:$errorno"; 
		glbError::show($str); 
	}
	//释放结果内存
	function free($query) {
		return mysqli_free_result($query);
	}

	function close(){
		if($this->link) @mysqli_close($this->link);
	}
	function __destruct(){
		$this->close();
	}

}



/*******************************************************************************
 File : \code\adpt\dbdrv\db_pdox.php 
*******************************************************************************/
<?php
// PDO数据库驱动 
class db_pdox{

	public $pdo = null;
	public $lastID = 0;
	public $affRows = 0;
	public $dbName = '';
	public $config = array();
	public $dbType = ''; //默认mysql
	public $sql = '';

    // 初始化,是否支持PDO
    function __construct(){
        if(!class_exists('PDO')){
			glbError::show('PDO NOT SUPPERT!'); 
        } 
    }
    // 连接数据库
    function connect($config='') { 
		if(empty($config['db_dsn'])){
			$this->dbType = empty($config['db_type']) ? 'mysql' : $config['db_type'];
			$config['db_dsn'] = $this->dbType.':host='.$config['db_host'].';dbname='.$config['db_name'].';port='.$config['db_port'].'';
		} 
		// $this->dbName = $config['db_name'];
		$this->config = $config; 
	
		if(!empty($config['db_conn'])) {
			$config['params'][PDO::ATTR_PERSISTENT] = true;
		}
		try{
			@$this->pdo = new PDO( $config['db_dsn'], $config['db_user'], $config['db_pass']);
			@$this->pdo->exec('SET NAMES '.$config['db_cset']);
		}catch(PDOException $e){
			$this->error($e->getMessage());
		}
		/*
		if(!$this->pdo) {
			$e = new PDOException;
			$this->error($e->getMessage());
		}*/
		
    }

    // 执行查询 返回数据集// select
    function query($sql, $re='def'){ 
		$this->sql = $sql;
		$res = $this->pdo->query($sql); 
		//try{
		if($res){
			$res->setFetchMode($re=='1' ? PDO::FETCH_NUM : PDO::FETCH_ASSOC); 
		}else{ 
			$this->error();
		}
		return $re=='all' ? $res->fetchAll() : $res;
    }
	function arr($sql) { // fetch_array
		return $this->query($sql, 'all');
	}
	function row($sql) { // row
		return $this->query($sql)->fetch();
	}
	function val($sql) { // val
		return $this->query($sql, 1)->fetchColumn();
	}
    // 执行语句(update, delete insert, other)
    function run($sql, $rTimer=0){ 
        $affRows = $this->pdo->exec($sql);
		if($rTimer) return 0; // Timer Return
		$this->affRows = $affRows;
		if(preg_match("/^\s*(INSERT\s+INTO|REPLACE\s+INTO)\s+/i", $sql)) {
			 switch($this->dbType) {
				case 'PGSQL':
				case 'SQLITE':
				case 'MSSQL':
				case 'SQLSRV':
				case 'IBASE':
				case 'mysql':
					$this->lastID = $this->pdo->lastInsertId();
					break;
				case 'ORACLE':
				case 'OCI':
					$sequenceName = $this->table;
					$vo = $this->pdo->query("SELECT {$sequenceName}.currval currval FROM dual");
					$this->lastID = $vo?$vo[0]["currval"]:0;
			}
		}
		return $this->affRows;
    }

	// 取得创建表sql
	function create($tab){ 
		$res = $this->query("SHOW CREATE TABLE $tab")->fetch();
		return $res['Create Table'];
	}
    // 取得数据表的字段信息
    function fields($tableName) {
		switch($this->dbType) {
			case 'MSSQL':
			case 'SQLSRV':
				$sql   = "SELECT   column_name as 'Name',   data_type as 'Type',   column_default as 'Default',   is_nullable as 'Null'
						  FROM    information_schema.tables AS t
						  JOIN    information_schema.columns AS c
						  ON  t.table_catalog = c.table_catalog
						  AND t.table_schema  = c.table_schema
						  AND t.table_name    = c.table_name
						  WHERE   t.table_name = '$tableName'";
				break;
			case 'SQLITE':
				$sql   = 'PRAGMA table_info ('.$tableName.') ';
				break;
			case 'ORACLE':
			case 'OCI':
				$sql   = "SELECT a.column_name \"Name\",data_type \"Type\",decode(nullable,'Y',0,1) notnull,data_default \"Default\",decode(a.column_name,b.column_name,1,0) \"pk\" "
				  ."FROM user_tab_columns a,(SELECT column_name FROM user_constraints c,user_cons_columns col "
				  ."WHERE c.constraint_name=col.constraint_name AND c.constraint_type='P' and c.table_name='".strtoupper($tableName)
				  ."') b where table_name='".strtoupper($tableName)."' and a.column_name=b.column_name(+)";
				break;
			case 'PGSQL':
				$sql   = 'select fields_name as "Name",fields_type as "Type",fields_not_null as "Null",fields_key_name as "Key",fields_default as "Default",fields_default as "Extra" from table_msg('.$tableName.');';
				break;
			case 'IBASE':
				break;
			case 'MYSQL':
			default:
				$sql   = 'DESCRIBE '.$tableName;//备注: 驱动类不只针对mysql，不能加``
		}
        $result = $this->query($sql);
        $info   =   array();
        if($result) {
            foreach ($result as $key => $val) {
                $val            =   array_change_key_case($val);
                $val['name']    =   isset($val['name'])?$val['name']:"";
                $val['type']    =   isset($val['type'])?$val['type']:"";
                $name           =   isset($val['field'])?$val['field']:$val['name'];
                $info[$name]    =   array(
                    'name'    => $name ,
                    'type'    => $val['type'],
                    // 'notnull' => (bool)(((isset($val['null'])) && ($val['null'] === '')) || ((isset($val['notnull'])) && ($val['notnull'] === ''))), // not null is empty, null is yes
                    'notnull' => $val['null']==='NO',
					'default' => isset($val['default'])? $val['default'] :(isset($val['dflt_value'])?$val['dflt_value']:""),
                    'primary' => isset($val['key'])?strtolower($val['key']) == 'pri':(isset($val['pk'])?$val['pk']:false),
                    'autoinc' => isset($val['extra'])?strtolower($val['extra']) == 'auto_increment':(isset($val['key'])?$val['key']:false),
					'Comment' => @$val['Comment'], //Comment, COLUMN_COMMENT
                );
				//$info[$name]    =   $val;
            }
        }
        return $info;
    }
    // 取得数据库的表信息
    function tables() {
		switch($this->dbType) {
		case 'ORACLE':
		case 'OCI':
			$sql   = 'SELECT table_name FROM user_tables';
			break;
		case 'MSSQL':
		case 'SQLSRV':
			$sql   = "SELECT TABLE_NAME	FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'";
			break;
		case 'PGSQL':
			$sql   = "select tablename as Tables_in_test from pg_tables where  schemaname ='public'";
			break;
		case 'IBASE':
			// 暂时不支持
			throw_exception(L('_NOT_SUPPORT_DB_').':IBASE');
			break;
		case 'SQLITE':
			$sql   = "SELECT name FROM sqlite_master WHERE type='table' "
					 . "UNION ALL SELECT name FROM sqlite_temp_master "
					 . "WHERE type='table' ORDER BY name";
			 break;
		case 'MYSQL':
		default:
			$sql    = 'SHOW TABLES ';
		}
        $result = $this->query($sql);
        $info   =   array();
        foreach ($result as $key => $val) {
            $info[$key] = current($val);
        }
        return $info;
    }
	
    // 取得数据库的表信息(仅mysql)
    function tabinfo() {
		$result = $this->arr('SHOW TABLE STATUS');
        return $result;
	}

	//返回quoteSql语句
	function quoteSql($sql){
		return $this->pdo->quote($sql);
	}

	// 数据库错误信息
    function error($msg='', $sql=''){ 
		$sql = basDebug::hidInfo($sql,1);
		$func = @$this->config['efunc'];
		if($func) return $func($message);
        if(empty($msg)){
			if($this->PDOStatement) {
				$error = $this->PDOStatement->errorInfo();
				$this->error = '<i>Info</i>: '.$error[1].':'.$error[2].'<br>';
			}else{
				$this->error = '';
			}
			if('' != @$this->queryStr){
				$this->error .= "<i>SQL</i>: ".$this->queryStr.'<br>';
			}else{
				$this->error .= "<i>SQL</i>: ".$this->sql.'<br>';
			}
		}else{
			$this->error = $msg;	
		}
		glbError::show($msg); 
    }
	
    // 释放查询结果
    function free() {
        $this->PDOStatement = null;
    }
    // 关闭数据库
    function close() {
        $this->pdo = null;
    }
	function __destruct(){
		$this->close();
	}

}



/*******************************************************************************
 File : \code\adpt\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\adpt\ipapi\ipBaidu.php 
*******************************************************************************/
<?php
// 获取ip地址-Sina
class ipBaidu{
	
	public $url = 'http://api.map.baidu.com/location/ip?ak=3GGtGlCtbAGa1GYK70XFX2Rb&coor=bd09ll&ip='; 
	public $cset = 'utf-8';
	
	// 获取数据
    //function getAddr($ip){}
	
	// 过滤处理
	function fill($addr){
		$addr = json_decode($addr,1); 
		if(!empty($addr['address'])){
			$addr = $addr['address'];
		}elseif(!empty($addr['message'])){
			//dump($addr);
			$addr = $addr['message'].'('.$addr['status'].')'; 
		}else{
			$addr = var_export($addr,1);
		}
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\ipapi\ipIp138.php 
*******************************************************************************/
<?php
// 获取ip地址-Ip138
class ipIp138{
	
	public $url = 'http://www.ip138.com/ips138.asp?action=2&ip='; 
	public $cset = 'gb2312';
	
	// 获取数据
    //function getAddr($ip, $text=1){}
	
	// 过滤处理
	function fill($addr){
		//江苏省盐城市  联通
		//<ul class="ul1"><li>本站主数据：江苏省盐城市  联通</li><li>参考数据一：江苏省盐城市 联通</li></ul>
		$arrText = array('<ul class="ul1"><li>','</li><li>'); 
		$addr = basElm::getVal($addr, $arrText);
		$addr = substr($addr,18) ;
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\ipapi\ipLocal.php 
*******************************************************************************/
<?php
/*
 * 算法代码：
http://www.fuziba.com/2012/08/01/php%E8%AF%BB%E5%8F%96%E7%BA%AF%E7%9C%9Fip%E6%95%B0%E6%8D%AE%E5%BA%93/
 * 地址库：
http://pc6.com/softview/SoftView_41490.html (纯真IP数据库)
下载安装，把qqwry.dat提取出来放到[/ilibs/ip_qqwry.dat]；最后卸载...
为保持本代码的瘦小，默认没有这个数据库文件，2014年6月15日对应的大小为9M，为本程序的几倍！
*/
// 获取ip地址
class ipLocal{
	
	public $url = 'local'; 
	public $cset = 'gb2312'; //bin,gb2312
	
	// 获取数据
    function getAddr($ip){
		//IP数据文件路径
		$dat_path = DIR_STATIC.'/ilibs/ip_qqwry.dat';
		//打开IP数据文件
		if(!$fd = @fopen($dat_path, 'rb')){
			return 'ip_qqwry.dat  Error';
		}
		
		//分解IP进行运算，得出整形数
		$ipNum = extIPAddr::ip2long($ip); 
		//获取IP数据索引开始和结束位置
		$DataBegin = fread($fd, 4);
		$DataEnd = fread($fd, 4);
		$ipbegin = implode('', unpack('L', $DataBegin));
		if($ipbegin < 0) $ipbegin += pow(2, 32);
		$ipend = implode('', unpack('L', $DataEnd));
		if($ipend < 0) $ipend += pow(2, 32);
		$ipAllNum = ($ipend - $ipbegin) / 7 + 1;
	 
		$BeginNum = 0;
		$EndNum = $ipAllNum;
		$ip1num = $ip2num = 0; //Peace修正Notic错误
		$ipAddr1 = $ipAddr2 = ''; //Peace修正Notic错误
	 
		//使用二分查找法从索引记录中搜索匹配的IP记录
		while($ip1num>$ipNum || $ip2num<$ipNum) {
			$Middle= intval(($EndNum + $BeginNum) / 2);
			//偏移指针到索引位置读取4个字节
			fseek($fd, $ipbegin + 7 * $Middle);
			$ipData1 = fread($fd, 4);
			if(strlen($ipData1) < 4) {
				fclose($fd);
				return 'System Error';
			}
			//提取出来的数据转换成长整形，如果数据是负数则加上2的32次幂
			$ip1num = implode('', unpack('L', $ipData1));
			if($ip1num < 0) $ip1num += pow(2, 32);
			//提取的长整型数大于我们IP地址则修改结束位置进行下一次循环
			if($ip1num > $ipNum) {
				$EndNum = $Middle;
				continue;
			}
			//取完上一个索引后取下一个索引
			$DataSeek = fread($fd, 3);
			if(strlen($DataSeek) < 3) {
				fclose($fd);
				return 'System Error';
			}
			$DataSeek = implode('', unpack('L', $DataSeek.chr(0)));
			fseek($fd, $DataSeek);
			$ipData2 = fread($fd, 4);
			if(strlen($ipData2) < 4) {
				fclose($fd);
				return 'System Error';
			}
			$ip2num = implode('', unpack('L', $ipData2));
			if($ip2num < 0) $ip2num += pow(2, 32);
			//没找到提示未知
			if($ip2num < $ipNum) {
				if($Middle == $BeginNum) {
					fclose($fd);
					return 'Unknown';
				}
				$BeginNum = $Middle;
			}
		}
	   $ipFlag = fread($fd, 1);
		if($ipFlag == chr(1)) {
			$ipSeek = fread($fd, 3);
			if(strlen($ipSeek) < 3) {
				fclose($fd);
				return 'System Error';
			}
			$ipSeek = implode('', unpack('L', $ipSeek.chr(0)));
			fseek($fd, $ipSeek);
			$ipFlag = fread($fd, 1);
		}
	 
		if($ipFlag == chr(2)) {
			$AddrSeek = fread($fd, 3);
			if(strlen($AddrSeek) < 3) {
				fclose($fd);
				return 'System Error';
			}
			$ipFlag = fread($fd, 1);
			if($ipFlag == chr(2)) {
				$AddrSeek2 = fread($fd, 3);
				if(strlen($AddrSeek2) < 3) {
					fclose($fd);
					return 'System Error';
				}
				$AddrSeek2 = implode('', unpack('L', $AddrSeek2.chr(0)));
				fseek($fd, $AddrSeek2);
			} else {
				fseek($fd, -1, SEEK_CUR);
			}
	 
			while(($char = fread($fd, 1)) != chr(0))
				$ipAddr2 .= $char;
	 
			$AddrSeek = implode('', unpack('L', $AddrSeek.chr(0)));
			fseek($fd, $AddrSeek);
	 
			while(($char = fread($fd, 1)) != chr(0))
				$ipAddr1 .= $char;
		} else {
			
			fseek($fd, -1, SEEK_CUR);
			while(($char = fread($fd, 1)) != chr(0))
				$ipAddr1 .= $char;
	 
			$ipFlag = fread($fd, 1);
			if($ipFlag == chr(2)) {
				$AddrSeek2 = fread($fd, 3);
				if(strlen($AddrSeek2) < 3) {
					fclose($fd);
					return 'System Error';
				}
				$AddrSeek2 = implode('', unpack('L', $AddrSeek2.chr(0)));
				fseek($fd, $AddrSeek2);
			} else {
				fseek($fd, -1, SEEK_CUR);
			}
			while(($char = fread($fd, 1)) != chr(0)){
				$ipAddr2 .= $char;
			}
		}
		fclose($fd);
	 
		//最后做相应的替换操作后返回结果
		if(preg_match('/http/i', $ipAddr2)) {
			$ipAddr2 = '';
		}
		$ipaddr = "$ipAddr1 $ipAddr2";
		
		$ipaddr = comConvert::autoCSet($ipaddr,"gb2312",cfg('sys.cset'));
		return $ipaddr; //mb_convert_encoding($ipaddr,"utf-8","gb2312");
	}
	
	// 过滤处理
	function fill($addr){
		//美国 CZ88.NET 
		$addr = preg_replace('/CZ88.Net/is', '', $addr);
		$addr = preg_replace('/^s*/is', '', $addr);
		$addr = preg_replace('/s*$/is', '', $addr);
		if(preg_match('/http/i', $addr) || $addr == '') {
			$addr = 'Unknown';
		}
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\ipapi\ipPcoln.php 
*******************************************************************************/
<?php
// 获取ip地址-Pcoln
class ipPcoln{
	
	public $url = 'http://whois.pconline.com.cn/jsFunction.jsp?callback=jsShow&ip='; 
	public $cset = 'gb2312';
	
	// 获取数据
    //function getAddr($ip, $text=1){}
	
	// 过滤处理
	function fill($addr){
		//江苏省盐城市 联通',' 
		//if (window.jsShow){jsShow('江苏省盐城市 联通','');} 
		$arrText = array("jsShow('","');}");
		$addr = basElm::getVal($addr, $arrText);
		$addr = str_replace("','",',',$addr);
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\ipapi\ipS1616.php 
*******************************************************************************/
<?php
// 获取ip地址-S1616
class ipS1616{
	
	public $url = 'http://chaxun.1616.net/s.php?type=ip&output=json&callback=data&v='; 
	public $cset = 'utf-8';
	
	// 获取数据
    //function getAddr($ip, $text=1){}
	
	// 过滤处理
	function fill($addr){
		//江苏省盐城市 联通 
		//data({"Ip":"122.96.199.133","Isp":"江苏省盐城市 联通","Browser":"","OS":"Windows 7","QueryResult":1}) 
		$arrText = array('Isp":"','","Browser');
		$addr = basElm::getVal($addr, $arrText);
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\ipapi\ipSina.php 
*******************************************************************************/
<?php
// 获取ip地址-Sina
class ipSina{
	
	public $url = 'http://int.dpool.sina.com.cn/iplookup/iplookup.php?ip='; 
	public $cset = 'gb2312';
	
	// 获取数据
    //function getAddr($ip){}
	
	// 过滤处理
	function fill($addr){
		//1	14.216.0.0		14.222.255.255	中国	广东	东莞		电信
		//1	152.72.131.0	152.72.245.255	美国	威斯康星州	Racine
		$addr = preg_replace("/\d{1,3}([.][0-9]{1,3}){3,15}/",'',$addr);
		$addr = str_replace(array("1\t","\t\t"),"",$addr);
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\ipapi\ipTaobao.php 
*******************************************************************************/
<?php
// 获取ip地址-Taobao
class ipTaobao{
	
	public $url = 'http://ip.taobao.com/service/getIpInfo.php?ip='; 
	public $cset = 'utf-8';
	//read:        http://ip.taobao.com/
	
	// 获取数据
    //function getAddr($ip, $text=1){}
	
	// 过滤处理
	function fill($addr){
		//中国,CN,华东,300000,江苏省,320000,盐城市,320900,,-1,联通,100026,122.96.199.133 
		//{"code":0,"data":{"country":"\u4e2d\u56fd","country_id":"CN","area":"\u534e\u4e1c","area_id":"300000","region":"\u6c5f\u82cf\u7701","region_id":"320000","city":"\u76d0\u57ce\u5e02","city_id":"320900","county":"","county_id":"-1","isp":"\u8054\u901a","isp_id":"100026","ip":"122.96.199.133"}}
		$arr = json_decode($addr,1);
		$addr = implode(',',empty($arr['data']) ? '-' : $arr['data']);
		$addr = preg_replace("/\d{1,3}([.][0-9]{1,3}){3,15}/",'',$addr);
		return $addr;
	}
}




/*******************************************************************************
 File : \code\adpt\smsapi\api_cfgs.php 
*******************************************************************************/
<?php

$_apis = array(

	'winic' => array(
		'name' => '移动商务',
		'home' => 'http://www.winic.org/',
		'unit' => '元', // 余额单位(元 或 条)
		'admin' => 'http://www.900112.com/', //如无此项可不填
		'note' => 'HTTP发送,内容不支持空格换行',
		'nmem' => 'HTTP发送,内容不支持空格换行', //会员提示
	),
	'cr6868' => array(
		'name' => '创瑞传媒',
		'home' => 'http://www.cr6868.com/',
		'unit' => '条', // 余额单位(元 或 条)
		'admin' => 'http://web.cr6868.com/login.aspx', //如无此项可不填
		'note' => '信息中不能含&#特殊字符，具体咨询短信供应商。',
		'nmem' => '', //会员提示
	),
	'emhttp' => array(
		'name' => '亿美(http)',
		'unit' => '元', // 余额单位(元 或 条)
		'home' => 'http://www.emay.cn/', 
		'admin' => '', //
		'note' => '亿美软通接口(http调用), 新亿美用户建议首选本调用方式, 不需要login操作。',
		'nmem' => '', //会员提示
	),
	'dxqun' => array(
		'name' => '短信群',
		'unit' => '条', // 余额单位(元 或 条)
		'home' => 'http://www.dxqun.com/',
		'admin' => 'http://1.dxton.com/', //如无此项可不填
		'note' => '',
		'nmem' => '', //会员提示
	),
	'bucp' => array(
		'name' => '博星(ws)',
		'unit' => '条', // 余额单位(元 或 条)
		'home' => 'http://www.bucp.net/', 
		'admin' => 'http://117.79.237.3:8060/webservice.asmx', //http://sdkhttp.eucp.b2m.cn/sdk/SDKService
		'note' => '',
		'nmem' => '', //会员提示
	),
	'0test' => array(
		'name' => '流程测试',
		'unit' => '条', // 余额单位(元 或 条)
		'home' => '', //如无此项可不填
		'admin' => '', //如无此项可不填
		'note' => '测试接口,用于测试系统其它流程,提供[充值<a href="?file={file}&act=chargeUp&charge=20" target="_blank">[+20</a>|<a href="?file={file}&act=chargeUp&charge=-20" target="_blank">-20]</a>操作]<br />具体操作不会发短信,仅写一个文件记录表示发短信; <br />',
		'nmem' => '测试接口,用于测试系统其它流程。', //会员提示
	),

);

/*
	'emay' => array(
		'name' => '亿美(ws)',
		'unit' => '元', // 余额单位(元 或 条)
		'home' => 'http://www.emay.cn/', 
		'admin' => '', //http://sdkhttp.eucp.b2m.cn/sdk/SDKService
		'note' => '亿美软通接口(Services调用), 第一次使用时,需使用[<a href="include/sms/extra_act.php?act=login" target="_blank">登录(login)</a>]操作; 如有问题请联系亿美相关人员指定Key值。<br />',
		'nmem' => '', //会员提示
	),
	'bucp' => array(
		'name' => '博星(ws)',
		'unit' => '条', // 余额单位(元 或 条)
		'home' => 'http://www.bucp.net/', 
		'admin' => 'http://117.79.237.3:8060/webservice.asmx', //http://sdkhttp.eucp.b2m.cn/sdk/SDKService
		'note' => '',
		'nmem' => '', //会员提示
	),
*/



/*******************************************************************************
 File : \code\adpt\smsapi\sms_0test.php 
*******************************************************************************/
<?php

/**
 * 仅测试使用，用于测试系统其它流程；
 * 具体操作不会发短信，仅写一个文件记录表示发短信
 */
class sms_0test{
	
	public $userid; // 序列号
	public $userpw; // 密码
	public $bfile; // 余额文件

	// 初始化
	function __construct($cfgs=array()){
		$this->userid = $cfgs['user'];
		$this->userpw = $cfgs['pass'];
		// 余额 
		$file = "store/0test_balance.txt"; 
		comFiles::chkDirs($file,'tmp');
		$file = DIR_DTMP."/$file"; 
		if(!file_exists($file)){
			$fp = fopen($file, 'wb');
			$fee = rand(50,100);
			flock($fp, 2); fwrite($fp, $fee); fclose($fp);
		}
		$this->bfile = $file;
	}
	
	// 具体操作不会发短信
	function sendSMS($mobiles,$content){
		$rnd = rand(1,1000); 
		if($rnd<900){ // 模拟,90%情况下成功
			// 扣钱 test_balance.txt
			return array(1,"OK");
		}else{
			return array(-1,lang('sms_fail'));
		}
	}
	
	// 余额查询 
	function getBalance(){
		$rnd = rand(1,1000);
		if($rnd<990){ // 模拟,99.0%情况下成功
			$cnt = comFiles::get($this->bfile);
			return array('1',$cnt);
		}else{
			return array('-1',lang('sms_fail'));
		}	
	}
	
	// 充值
	function chargeUp($count){
		$rnd = rand(1,1000);
		if($rnd<900){ // 模拟,90%情况下成功
			$cnt = comFiles::get($this->bfile);
			$cnt += $count;
			$fp = fopen($this->bfile, 'wb');
			flock($fp, 2); fwrite($fp, $cnt); fclose($fp);
			return array('1',$cnt);
		}else{
			return array('-1',lang('sms_fail'));
		}	
	}
	
	// 扣费
	function deductingCharge($count){
		$cnt = comFiles::get($this->bfile);
		$cnt -= $count; 
		if((float)$cnt<0) $cnt = 0; 
		$fp = fopen($this->bfile, 'wb');
		flock($fp, 2); fwrite($fp, $cnt); fclose($fp);
		return array(1,$cnt);
	}

}

// 附加说明
// none



/*******************************************************************************
 File : \code\adpt\smsapi\sms_bucp.php 
*******************************************************************************/
<?php
// sms_bucp；
//http://sdk2.entinfo.cn/z_send.aspx?sn=SDK-DHX-010-xxx&pwd=222&mobile=13712748215&content=Test你好
//http://sdk2.entinfo.cn/z_balance.aspx?sn=SDK-DHX-010-xxx&pwd=222
//http://117.79.237.3:8060/webservice.asmx/

class sms_bucp{
	
	public $userid; // 序列号
	public $userpw; // 密码/Key 
	public $baseurl = 'http://sdk2.entinfo.cn/'; 
	public $arr = array(); // 参数
	public $way = 0; // http方式; 0-自动,1-curl_init, 2-fsockopen, 3-file_get_contents
	
	// 初始化
	function __construct($cfgs=array()){
		$this->arr['sn'] = $this->userid = $cfgs['user'];
		$this->arr['pwd'] = $this->userpw = $cfgs['pass'];
		$this->way && comHttp::setWay($this->way);
	}
	
	// 发送短信；(gb2312编码)
	function sendSMS($mobiles,$content){
		if(is_array($mobiles)) $mobiles = implode(',',$mobiles);
		$content = comConvert::autoCSet($content,cfg('sys.cset'),"gb2312");
		$arr = $this->arr;
		$arr['mobile'] = $mobiles;
		$arr['content'] = $content;
		$html = comHttp::doPost("{$this->baseurl}z_send.aspx?", $arr, 3); //var_dump($html);   
		$re = $this->fmtInfo($html); //var_dump($re);  
		return $re;
	}
	
	// 余额查询 
	function getBalance(){
		//return array(1,1234);
		$url = "z_balance.aspx?sn=$this->userid&pwd=$this->userpw"; 
		$html = comHttp::doGet("{$this->baseurl}$url", 3); //var_dump($html);  
		$re = $this->fmtInfo($html,1); //var_dump($re);  
		return $re;
	}
	
	function fmtInfo($html,$isq=0){
		if($isq){
			$re = $html<0 ? array('-1',"[".$this->reInfo($html)."]") : array(1,$html);
		}else{
			$re = in_array($html,array('0','1')) ? array('1',"发送OK") : array('-1',"Error:[".$this->reInfo($html)."]");
		}
		return $re;
	}
	
	// 返回值-描述 对应表
	function reInfo($no){
		$a = array(
			'0'=>'成功',
			'-1'=>'发送失败',
			'-2'=>'参数错误',
			'-3'=>'序列号密码错误',
		);	
		return isset($a[$no]) ? $no.':'.$a[$no] : "$no:(未知错误)";
	}
	
}



/*******************************************************************************
 File : \code\adpt\smsapi\sms_cr6868.php 
*******************************************************************************/
<?php
/**
*** 以下问题, 请与短信供应上联络：
-1- (和平鸽)你们那个接口，延时厉害啊！(前天我在你们网站测试时，是很快的。)
--- 创瑞短信公司的客户经理 您现在不是免审,早上这一块发短信的人又多。延时肯定的会有的。
#2# 当发送含有一些关键字时；
### 当时显示发送成功，其实没有发送成功；
### 进cr6868.com网站后台可发现有“驳回”提示；
### 但我们系统已经是按当时状态(成功)的来处理，这个是个问题。
 */
// sms_cr6868；
class sms_cr6868{
	
	public $userid; // 序列号
	public $userpw; // 密码
	public $baseurl = 'http://web.cr6868.com/asmx/smsservice.aspx';
	public $arr = array(); // 参数
	public $way = 1; // http方式

	// 初始化
	function __construct($cfgs=array()){
		$this->arr['name'] = $this->userid = $cfgs['user'];
		$this->arr['pwd'] = $this->userpw = $cfgs['pass'];
		comHttp::$way = $this->way;
	}
	
	/**
	 * sms_cr6868；
	 * 发送内容（1-500 个汉字）UTF-8编码
	 * http://web.cr6868.com/asmx/smsservice.aspx?name=13537432147&pwd=xxx&content=test测试msg[和平鸽]&mobile=13537432147&type=pt
	 */
	function sendSMS($mobiles,$content){
		if(is_array($mobiles)) $mobiles = implode(',',$mobiles);
		$content = str_replace(array(' ','　',"\r","\n","&","#"),'',$content); // 短信内容不支持空格???
        //$content = str_replace(array('[',']'),array('【','】'),$content); // 具体咨询短信供应商
		$content = comConvert::autoCSet($content,cfg('sys.cset'),"utf-8");
		$arr = $this->arr;
		$arr['type'] = 'pt';
		$arr['content'] = $content; //urlencode($content); 
		$arr['mobile'] = $mobiles; 
		$html = comHttp::doPost("$this->baseurl", $arr, 3); 
		$re = $this->fmtInfo($html); //var_dump($html); 
		//if($re[0]=='1') $re[1] = '发送成功';
		return $re;		
	}
	
	/**
	 * 余额查询 
	 * @return double 余额
	 */
	function getBalance(){
		//return array(1,1234);
		$arr = $this->arr;
		$html = comHttp::doGet("$this->baseurl?name=$this->userid&pwd=$this->userpw&type=balance", 3); //var_dump($html);  
		$re = $this->fmtInfo($html);
		//if(substr($html,0,1)=='.') $html = "0$html";
		if($re[0]=='1') $re[1] = substr($re[1],2);
		return $re;	
	}

	/**
	 * 返回值-描述 对应表
	 - 0,type is not true ,
	 - 0,6
	 - 10,用户名或密码错误
	 - 1:0,20150414130559306617 
	 re stat,res
	 */
	function fmtInfo($html)
	{
		@$arr = explode(',',$html);
		if(empty($html) || strpos($html,',')<=0){
			return array('',"sms-Server Error:[$html]");	
		}elseif($arr[0]==='0'){
			return array('1',$html);	
		}else{
			return array('-1',"Error:[$html]");	
		}
	}

}

/*
'0'  => '操作成功', 
'1'  => '含有敏感词汇！', 
'2'  => '余额不足',
'3'  => '没有号码',
'4'  => '包含sql语句',
'10' => '账号不存在',
'11' => '账号注销',
'12' => '账号停用',
'13' => 'IP鉴权失败',
'14' => '格式错误',
'-1' => '系统异常',
'-2' => '其它错误！',
*/



/*******************************************************************************
 File : \code\adpt\smsapi\sms_dxqun.php 
*******************************************************************************/
<?php
// sms_dxqun；
class sms_dxqun{
		
	public $userid; // 序列号	
	public $userpw; // 密码
	public $baseurl = 'http://http.chinasms.com.cn'; // http://http.dxsms.com, http://http.chinasms.com.cn	
	public $post; // post对象

	// 初始化
	function __construct($cfgs=array()){
		$this->arr['uid'] = $this->userid = $cfgs['user'];
		$this->arr['pwd'] = $this->userpw = $cfgs['pass'];;
	}
	
	/** sms_dxqun；
	 * 超过70个字符会自动分多条发送。短信内容不支持空格(webservice接口支持)。
	 * 建议每次提交在100个号内，超过请自行做循环
	 * 每次GET提交请不要大于100个号码。Post方式每次提交请不要大于5000个号码，多个手机号码用 , 英文逗号隔
	 * HTTP接口发送和接收的短信内容必须是GB2312编码。HTTP发送,内容不支持空格
	 */
	function sendSMS($mobiles,$content){
		if(is_array($mobiles)) $mobiles = implode(',',$mobiles);
		$content = comConvert::autoCSet($content,cfg('sys.cset'),"gb2312");
		$content = str_replace(array(' ','　',"\r","\n"),'',$content); // 短信内容不支持空格???
		$arr = $this->arr;
		$arr['phone'] = $mobiles;
		$arr['message'] = $content;
		$html = comHttp::doPost("{$this->baseurl}/tx/", $arr, 3); 
		echo basStr::filText($html);
		// 100{&}13912341234||短信测试回复||2008-05-27 12:10:11||1068112227282{&}15912343333||短信测试回复2||2008-05-27 13:11:11||106811222728200
		if(empty($html)){
			return array('-1','(sms-Server Error)');
		}elseif(substr($html,0,3)>'100'){
			$emsg = $this->reInfo(substr($html,0,3));
			return array('-1',"$emsg"); 	
		}else{
			return array('1','OK'); 	
		}
	}
	
	// 余额查询 
	function getBalance(){
		$path = "/mm/?uid={$this->userid}&pwd=".md5($this->userpw)."";
		$html = comHttp::doPost("{$this->baseurl}/mm/", $this->arr, 3); 
		// 100||22348
		if(empty($html)){
			return array('-1','(sms-Server Error)');
		}elseif(substr($html,0,5)=='100||'){
			return array('1', substr($html,5));
		}else{
			return array('-1',$this->reInfo(substr($html,0,3)));
		}
	}
	
	// 返回值-描述 对应表
	function reInfo($no){
		$a = array(
			'100' => '发送成功',
			'101' => '验证失败！',
			'102' => '短信不足！',
			'103' => '操作失败！',
			'104' => '非法字符！',
			'105' => '内容过多！',
			'106' => '号码过多！',
			'107' => '频率过快！',
			'108' => '号码内容空',
			'109' => '账号冻结！', 
			'110' => '禁止频繁单条发送！',
			'111' => '系统暂定发送！',
			'112' => '号码错误！',
			'113' => '定时时间格式不对！',
			'114' => '账号被锁，10分钟后登录！',
			'115' => '连接失败！',
			'116' => '禁止接口发送！',
			'117' => '绑定IP不正确！',
			'120' => '系统升级！',
		);	
		return isset($a[$no]) ? $no.':'.$a[$no] : "$no:(未知错误)";
	}

}



/*******************************************************************************
 File : \code\adpt\smsapi\sms_emhttp.php 
*******************************************************************************/
<?php
// sms_emhttp；
class sms_emhttp{
	
	public $userid; // 序列号
	public $userpw; // 密码/Key
	var $urlmap = array(
		'3SDK' => 'http://sdkhttp.eucp.b2m.cn/sdkproxy/',
		'6SDK' => 'http://sdk4report.eucp.b2m.cn:8080/sdkproxy/',
		'_NUL' => 'http://sdkhttp.eucp.b2m.cn/sdkproxy/', //按官方文档
	);
	public $baseurl = '';
	public $arr = array(); // 参数
	public $way = 0; // http方式
	
	// 初始化
	function __construct($cfgs=array()){
		$this->arr['cdkey'] = $this->userid = $cfgs['user'];
		$this->arr['password'] = $this->userpw = $cfgs['pass'];
		$fix = substr($this->userid,0,4);
		if(isset($this->urlmap[$fix])){
			$this->baseurl = $this->urlmap[$fix];	
		}else{
			$this->baseurl = $this->urlmap['_NUL'];	
		}
		$this->way && comHttp::setWay($this->way);
	}
	
	// 发送短信；(utf-8编码)
	function sendSMS($mobiles,$content){
		if(is_array($mobiles)) $mobiles = implode(',',$mobiles);
		$content = comConvert::autoCSet($content,cfg('sys.cset'),"utf-8");
		$arr = $this->arr;
		$arr['phone'] = $mobiles;
		$arr['message'] = $content;
		$html = comHttp::doPost("{$this->baseurl}sendsms.action", $arr, 3); //var_dump(basStr::filText($html));  
		$re = $this->fmtInfo($html); //var_dump($re);
		if($re[0]=='1') $re[1] = '发送成功';
		return $re;
	}
	
	// 余额查询 
	function getBalance(){
		//return array(1,123.4);
		$url = "querybalance.action?cdkey=$this->userid&password=$this->userpw";
		$html = comHttp::doGet("{$this->baseurl}$url", 3); //var_dump(basStr::filText($html));  
		$re = $this->fmtInfo($html,1); //var_dump($re);
		return $re;
	}
	
	// 返回值-描述 对应表
	// - ...<error>0</error><message>-1103.0</message>
	// - ...<error>0</error><message>3718.2</message>
	function fmtInfo($html,$isq=0){
		$erno = basElm::getVal($html,'error'); 
		$emsg = basElm::getVal($html,'message'); 
		if(empty($html)){ 
			return array('',"sms-Server Error:[$html]");	
		}elseif($isq && substr($emsg,0,1)=='-'){ 
			$erno = str_replace(array(".0"),array(''),$emsg); 
			$erstr = $this->reState($erno);
			return array('-1',"Error:[$erstr]");	
		}elseif($isq){ 
			return array('1',$emsg);	
		}elseif($erno==='0'){ 
			return array('1',$emsg);	
		}else{ 
			$erstr = $this->reState($erno);
			return array('-1',"Error:[$erstr]");
		}
	}
	
	// 返回值-描述 对应表
	function reState($no){
		$a = array(
			'-1'=>'系统异常',
			'-101'=>'命令不被支持',
			'-102'=>'用户信息删除失败',
			'-103'=>'用户信息更新失败',
			'-104'=>'指令超出请求限制',
			'-111'=>'企业注册失败',
			'-117'=>'发送短信失败',
			'-118'=>'获取MO失败',
			'-119'=>'获取Report失败',
			'-120'=>'更新密码失败',
			'-122'=>'用户注销失败',
			'-110'=>'用户激活失败',
			'-123'=>'查询单价失败',
			'-124'=>'查询余额失败',
			'-125'=>'设置MO转发失败',
			'-127'=>'计费失败零余额',
			'-128'=>'计费失败余额不足',
			'-1100'=>'序列号错误,序列号不存在内存中,或尝试攻击的用户',
			'-1102'=>'序列号正确,Password错误',
			'-1103'=>'序列号正确,Key错误',
			'-1104'=>'序列号路由错误',
			'-1105'=>'序列号状态异常 未用1',
			'-1106'=>'序列号状态异常 已用2 兼容原有系统为0',
			'-1107'=>'序列号状态异常 停用3',
			'-1108'=>'序列号状态异常 停止5',
			'-113'=>'充值失败',
			'-1131'=>'充值卡无效',
			'-1132'=>'充值卡密码无效',
			'-1133'=>'充值卡绑定异常',
			'-1134'=>'充值卡状态异常',
			'-1135'=>'充值卡金额无效',
			'-190'=>'数据库异常',
			'-1901'=>'数据库插入异常',
			'-1902'=>'数据库更新异常',
			'-1903'=>'数据库删除异常',
		);	
		return isset($a[$no]) ? $no.':'.$a[$no] : "$no:(未知错误)";
	}

}



/*******************************************************************************
 File : \code\adpt\smsapi\sms_eshang.php 
*******************************************************************************/
<?php
// sms_eshang；
class sms_eshan{
		
	public $userid; // 用户名	
	public $userpw; // 密钥	
	public $baseurl = 'http://sms.eshang8.com/jdk/';	
	public $xml; // post对象

	function __construct($cfgs=array()){
		$this->userid = $cfgs['user'];
		$this->userpw = $cfgs['pass'];
		$this->xml = new DOMDocument();
		//$this->getInit();
	}
	
	/** sms_eshang8；
	 * 信息内容(GBK编码)，包含中文的短信长度小于等于70个字符，纯英文的短信长度小于等于150个字符
	 */
	function sendSMS($mobiles,$content){
		if(is_array($mobiles)) $mobiles = implode(',',$mobiles);
		if($mcharset=='utf-8') $content = iconv($mcharset,'gbk',$content); 
		//$content = str_replace(array(' ','　',"\r","\n"),'',$content); // 短信内容不支持空格???
		// >70字分割 ?????????????? 
		$content = urlencode($content); 
		$path = "?esname={$this->userid}&key={$this->userpw}&phone=$mobiles&msg=$content&smskind=1";
		$this->xml->load("$this->baseurl$path");
		return $this->reInfo();
	}
	
	// 余额查询 
	function getBalance(){
		$path = "?esname={$this->userid}&key={$this->userpw}&smskind=1";
		$this->xml->load("$this->baseurl$path");
		return $this->reInfo('PayCount');
	}
	
	// 返回值-描述 对应表
	function reInfo($flag=''){
		$root1 = $this->xml->getElementsByTagName("root")->item(0); 
		$cnt = $root1->getElementsByTagName( "PayCount" )->item(0)->nodeValue;
		$res = $root1->getElementsByTagName( "result" )->item(0)->nodeValue;
		$err = $root1->getElementsByTagName( "ErrorDesc" )->item(0)->nodeValue;
		if($mcharset!='utf-8') $err = iconv('utf-8','gbk',$err); 
		$no = $res; 
		if($no=='1') $no = '-1';
		if($no=='0') $no = '1'; //成功统一返回1
		$a = array( //0成功 1发送失败2参数错误3屏蔽字4验证失败
			'-1' => '发送失败',
			'1'   => '操作成功',
			'2' => '参数错误！',
			'3' => '屏蔽字！',
			'4' => '验证失败！',
		);
		$msg = isset($a[$no]) ? $a[$no] : '(未知错误)';
		if($flag=='PayCount'){
			if(substr($cnt,0,1)=='.') $html = "0$cnt";
			if($res=='1') return array('1',$cnt); 
			else return array('-1',0); 
		}
		return array($no,$msg);
	}

}



/*******************************************************************************
 File : \code\adpt\smsapi\sms_winic.php 
*******************************************************************************/
<?php
// sms_winic；
class sms_winic{
	
	public $userid; // 序列号
	public $userpw; // 密码
	public $baseurl = 'http://service.winic.org';
	public $post; // post对象

	// 初始化
	function __construct($cfgs=array()){
		$this->arr['uid'] = $this->userid = $cfgs['user'];
		$this->arr['pwd'] = $this->userpw = $cfgs['pass'];
		$this->arr['id'] = $this->userid;
	}
	
	/** sms_winic；
	 * 超过70个字符会自动分多条发送。短信内容不支持空格(webservice接口支持)。
	 * 建议每次提交在100个号内，超过请自行做循环
	 * 每次GET提交请不要大于100个号码。Post方式每次提交请不要大于5000个号码，多个手机号码用 , 英文逗号隔
	 * HTTP接口发送和接收的短信内容必须是GB2312编码。HTTP发送,内容不支持空格
	 */
	function sendSMS($mobiles,$content){
		if(is_array($mobiles)) $mobiles = implode(',',$mobiles);
		$content = comConvert::autoCSet($content,cfg('sys.cset'),"gb2312");
		$content = str_replace(array(' ','　',"\r","\n"),'',$content); // 短信内容不支持空格???
		$arr = $this->arr;
		$arr['to'] = $mobiles;
		$arr['content'] = $content;
		$html = comHttp::doPost("{$this->baseurl}/sys_port/gateway/", $arr, 3); 
		//echo basStr::filText($html);
		// -02/Send:2/Consumption:0/Tmoney:0/sid:
		if(empty($html)){
			return array('-1','(sms-Server Error)');
		}elseif(substr($html,0,3)=='nul' || substr($html,0,1)=='-'){
			$emsg = $this->reInfo(substr($html,0,3));
			return array('-1',"$emsg"); 	
		}else{
			return array('1','OK'); 	
		}
	}
	
	// 余额查询
	function getBalance(){ 
		$html = comHttp::doPost("{$this->baseurl}:8009/webservice/public/remoney.asp", $this->arr, 3); 
		unset($this->arr['uid']);
		//echo basStr::filText($html);
		// .5
		if(empty($html)){
			return array('-1','(sms-Server Error)');
		}elseif(substr($html,0,3)=='nul' || substr($html,0,1)=='-'){
			$emsg = $this->reInfo(substr($html,0,3));
			return array('-1',"$emsg"); 	
		}else{
			if(substr($html,0,1)=='.') $html = "0$html";
			return array('1',$html); 	
		}
	}
	
	// 返回值-描述 对应表
	function reInfo($no){
		$a = array(
			'nul' => '无接收数据',
			'000' => '操作成功',
			'-01' => '当前账号余额不足！',
			'-02' => '当前用户ID错误！',
			'-03' => '当前密码错误！',
			'-04' => '参数不够或参数内容的类型错误！',
			'-05' => '手机号码格式不对！',
			'-06' => '短信内容编码不对！',
			'-07' => '短信内容含有敏感字符！',
			'-09' => '系统维护中.. ',
			'-10' => '手机号码数量超长！', //短信内容超长！（70个字符）目前已取消
			'-11' => '短信内容超长！',
			'-12' => '其它错误！',
		);	
		return isset($a[$no]) ? $no.':'.$a[$no] : "$no:(未知错误)";
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wmpBasic.php 
*******************************************************************************/
<?php
/**
 * Class wmpBasic 基本接口，随微信规则更新
 *
 * 获取access token
 * 获取微信服务器IP地址
 */

class wmpBasic{

	public $cfg = array();
	public $actoken = '';
	
	// @var int access_token的有效期,目前为2个小时
	private $act_life = '90m'; //秒(1.5h) (200/2000次/天)
	
	// 获取access_token接口调用请求(网址)
	private $act_url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s";
	
	// 获取微信服务器IP地址接口调用请求(网址)
	private $ip_url = 'https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=%s';

	function __construct($cfg=array()){
		$this->cfg = $cfg;
		$this->actoken = $this->getAccessToken();
		comHttp::setWay(1);
	}
    
	// 从缓存取；没有的化,先更新获取,再存缓存
    function getAccessToken($upd=0){
		global $_cbase; 
		if(!empty($_cbase['weixin']['actiks'][$this->cfg['appid']])){
			return $_cbase['weixin']['actiks'][$this->cfg['appid']];
		}
		$cfile = wysBasic::getCfpath($this->cfg['appid'], 'actik'); 
		$upath = tagCache::chkUpd($cfile,$this->act_life,0);
		if($upath){ 
			$data = @comFiles::get($cfile);
			$save = 0;
		}else{
			$url = sprintf($this->act_url,$this->cfg['appid'],$this->cfg['appsecret']); 
			$data = comHttp::doGet($url,3); 
			$databak = $data; //print_r($data);
			$save = 1;
		} 
		$data = wysBasic::jsonDecode($data,$this->act_url); //print_r($data);
		/*if(!empty($data['errcode'])){
			return wysBasic::debugError($data['errcode'],$data,$url,1);
		}*/
		if($save && !empty($data['access_token'])){ 
			$data && comFiles::put($cfile,$databak);
		}
		if(empty($data['access_token'])){ //一个进程中只取一次,保存供后续使用 //  && !empty($data['access_token'])
			$_cbase['weixin']['actiks'][$this->cfg['appid']] = @$data['access_token'];
		}
		return empty($data['access_token']) ? '' : $data['access_token'];
		
	}
	
	static function checkSignature($wecfg=array()){
		if(empty($wecfg['token'])) return false;
		$signature = @$_GET["signature"];
        $timestamp = @$_GET["timestamp"];
        $nonce = @$_GET["nonce"]; 
		$tmpArr = array($wecfg['token'], $timestamp, $nonce);
		sort($tmpArr, SORT_STRING); 
		$tmpStr = implode( $tmpArr );
		$tmpStr = sha1( $tmpStr );
		if( $tmpStr == $signature ){
			return true;
		}else{
			return false;
		}
	}
	
    //验证消息真实性
    static function checkValid($wecfg=array()){        
        if(!self::checkSignature($wecfg)) return false;
		#if(!strpos($_SERVER["HTTP_USER_AGENT"],'MicroMessenger')) return false;
		//测试号:HTTP_USER_AGENT=Mozilla/4.0
		//ip判断 ??? 又要远程抓一次数据，不要了。
		return true;
    }
	
    //获取微信服务器ip列表
    function getWeixinIP(){    
        $data = comHttp::doGet(sprintf($this->ip_url,$this->actoken),3); 
		return wysBasic::jsonDecode($data,$this->ip_url); 
    }



}



/*******************************************************************************
 File : \code\adpt\wechat\wmpError.php 
*******************************************************************************/
<?php
// 错误信息
// 随微信规则更新

class wmpError{
	
    static $errTab = array(
        '-1' => '系统繁忙，此时请开发者稍候再试',
        '0' => '请求成功',
        '40001' => '获取access_token时AppSecret错误，或者access_token无效。请开发者认真比对AppSecret的正确性，或查看是否正在为恰当的公众号调用接口',
        '40002' => '不合法的凭证类型',
        '40003' => '不合法的OpenID，请开发者确认OpenID（该用户）是否已关注公众号，或是否是其他公众号的OpenID',
        '40004' => '不合法的媒体文件类型',
        '40005' => '不合法的文件类型',
        '40006' => '不合法的文件大小',
        '40007' => '不合法的媒体文件id',
        '40008' => '不合法的消息类型',
        '40009' => '不合法的图片文件大小',
        '40010' => '不合法的语音文件大小',
        '40011' => '不合法的视频文件大小',
        '40012' => '不合法的缩略图文件大小',
        '40013' => '不合法的AppID，请开发者检查AppID的正确性，避免异常字符，注意大小写',
        '40014' => '不合法的access_token，请开发者认真比对access_token的有效性（如是否过期），或查看是否正在为恰当的公众号调用接口',
        '40015' => '不合法的菜单类型',
        '40016' => '不合法的按钮个数',
        '40017' => '不合法的按钮个数',
        '40018' => '不合法的按钮名字长度',
        '40019' => '不合法的按钮KEY长度',
        '40020' => '不合法的按钮URL长度',
        '40021' => '不合法的菜单版本号',
        '40022' => '不合法的子菜单级数',
        '40023' => '不合法的子菜单按钮个数',
        '40024' => '不合法的子菜单按钮类型',
        '40025' => '不合法的子菜单按钮名字长度',
        '40026' => '不合法的子菜单按钮KEY长度',
        '40027' => '不合法的子菜单按钮URL长度',
        '40028' => '不合法的自定义菜单使用用户',
        '40029' => '不合法的oauth_code',
        '40030' => '不合法的refresh_token',
        '40031' => '不合法的openid列表',
        '40032' => '不合法的openid列表长度',
        '40033' => '不合法的请求字符，不能包含\uxxxx格式的字符',
        '40035' => '不合法的参数',
        '40038' => '不合法的请求格式',
        '40039' => '不合法的URL长度',
        '40050' => '不合法的分组id',
        '40051' => '分组名字不合法',
        '40117' => '分组名字不合法',
        '40118' => 'media_id大小不合法',
        '40119' => 'button类型错误',
        '40120' => 'button类型错误',
        '40121' => '不合法的media_id类型',
        '40132' => '微信号不合法',
        '41001' => '缺少access_token参数',
        '41002' => '缺少appid参数',
        '41003' => '缺少refresh_token参数',
        '41004' => '缺少secret参数',
        '41005' => '缺少多媒体文件数据',
        '41006' => '缺少media_id参数',
        '41007' => '缺少子菜单数据',
        '41008' => '缺少oauth code',
        '41009' => '缺少openid',
        '42001' => 'access_token超时，请检查access_token的有效期，请参考基础支持-获取access_token中，对access_token的详细机制说明',
        '42002' => 'refresh_token超时',
        '42003' => 'oauth_code超时',
        '43001' => '需要GET请求',
        '43002' => '需要POST请求',
        '43003' => '需要HTTPS请求',
        '43004' => '需要接收者关注',
        '43005' => '需要好友关系',
        '44001' => '多媒体文件为空',
        '44002' => 'POST的数据包为空',
        '44003' => '图文消息内容为空',
        '44004' => '文本消息内容为空',
        '45001' => '多媒体文件大小超过限制',
        '45002' => '消息内容超过限制',
        '45003' => '标题字段超过限制',
        '45004' => '描述字段超过限制',
        '45005' => '链接字段超过限制',
        '45006' => '图片链接字段超过限制',
        '45007' => '语音播放时间超过限制',
        '45008' => '图文消息超过限制',
        '45009' => '接口调用超过限制',
        '45010' => '创建菜单个数超过限制',
        '45015' => '回复时间超过限制',
        '45016' => '系统分组，不允许修改',
        '45017' => '分组名字过长',
        '45018' => '分组数量超过上限',
        '46001' => '不存在媒体数据',
        '46002' => '不存在的菜单版本',
        '46003' => '不存在的菜单数据',
        '46004' => '不存在的用户',
        '47001' => '解析JSON/XML内容错误',
        '48001' => 'api功能未授权，请确认公众号已获得该接口，可以在公众平台官网-开发者中心页中查看接口权限',
        '50001' => '用户未授权该api',
        '50002' => '用户受限，可能是违规后接口被封禁',
        '61451' => '参数错误(invalid parameter)',
        '61452' => '无效客服账号(invalid kf_account)',
        '61453' => '客服帐号已存在(kf_account exsited)',
        '61454' => '客服帐号名长度超过限制(仅允许10个英文字符，不包括@及@后的公众号的微信号)(invalid kf_acount length)',
        '61455' => '客服帐号名包含非法字符(仅允许英文+数字)(illegal character in kf_account)',
        '61456' => '客服帐号个数超过限制(10个客服账号)(kf_account count exceeded)',
        '61457' => '无效头像文件类型(invalid file type)',
        '61450' => '系统错误(system error)',
        '61500' => '日期格式错误',
        '61501' => '日期范围错误',
        '9001001' => 'POST数据参数不合法',
        '9001002' => '远端服务不可用',
        '9001003' => 'Ticket不合法',
        '9001004' => '获取摇周边用户信息失败',
        '9001005' => '获取商户信息失败',
        '9001006' => '获取OpenID失败',
        '9001007' => '上传文件缺失',
        '9001008' => '上传素材的文件类型不合法',
        '9001009' => '上传素材的文件尺寸不合法',
        '9001010' => '上传失败',
        '9001020' => '帐号不合法',
        '9001021' => '已有设备激活率低于50%，不能新增设备',
        '9001022' => '设备申请数不合法，必须为大于0的数字',
        '9001023' => '已存在审核中的设备ID申请',
        '9001024' => '一次查询设备ID数量不能超过50',
        '9001025' => '设备ID不合法',
        '9001026' => '页面ID不合法',
        '9001027' => '页面参数不合法',
        '9001028' => '一次删除页面ID数量不能超过10',
        '9001029' => '页面已应用在设备中，请先解除应用关系再删除',
        '9001030' => '一次查询页面ID数量不能超过50',
        '9001031' => '时间区间不合法',
        '9001032' => '保存设备与页面的绑定关系参数错误',
        '9001033' => '门店ID不合法',
        '9001034' => '设备备注信息过长',
        '9001035' => '设备申请参数不合法',
        '9001036' => '查询起始值begin不合法',
		//'remote' => '查询起始值begin不合法',
		//'40125' => 'invalid appsecret',
    );
    
    static function errGet( $code ){
        if( isset(self::$errTab[$code]) ){
            return "[$code]".self::$errTab[$code];
        }
        return "未知错误[{$code}](unKnow)。";
    }
}



/*******************************************************************************
 File : \code\adpt\wechat\wmpJssdk.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

class wmpJssdk extends wmpBasic{

	private $cacheFull = '';
	// @var int access_token的有效期,目前为2个小时
	private $act_life = 5400; //秒(1.5h) (200/2000次/天)

	function __construct($cfg=array()){
		parent::__construct($cfg); 
		$this->cacheInit();
	}

	function getSignPackage() {
		$jsapiTicket = $this->getJsApiTicket();
		// 注意 URL 一定要动态获取，不能 hardcode.
		$protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
		$url = "$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
		$timestamp = time();
		$nonceStr = $this->createNonceStr();
		// 这里参数的顺序要按照 key 值 ASCII 码升序排序
		$string = "jsapi_ticket=$jsapiTicket&noncestr=$nonceStr&timestamp=$timestamp&url=$url";
		$signature = sha1($string);
		$signPackage = array(
			"appId"     => $this->cfg['appid'],
			"nonceStr"  => $nonceStr,
			"timestamp" => $timestamp,
			"url"       => $url,
			"signature" => $signature,
			"rawString" => $string
		);
		return $signPackage; 
	}

	private function createNonceStr($length = 16) {
		$chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
		$str = "";
		for($i = 0; $i < $length; $i++) {
			$str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
		}
		return $str;
	}

	private function getJsApiTicket() {
	// jsapi_ticket 应该全局存储与更新，以下代码以写入到文件中做示例
	$data = json_decode(comFiles::get($this->cacheFull));
	if ($data->expire_time < time()) {
		$accessToken = $this->getAccessToken();
		// 如果是企业号用以下 URL 获取 ticket
		// $url = "https://qyapi.weixin.qq.com/cgi-bin/get_jsapi_ticket?access_token=$accessToken";
		$url = "https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&access_token=$accessToken";
		$res = comHttp::doGet($url,3);
		$res = json_decode($res);
		$ticket = $res->ticket; 
		if ($ticket) {
			$data->expire_time = time() + $this->act_life;
			$data->jsapi_ticket = $ticket;
			$this->cacheSave($data);
		}
	}else{
		$ticket = $data->jsapi_ticket;
	} //echo $ticket;
	return $ticket;
	}

	private function cacheInit() {
		$this->cacheFull = DIR_DTMP.str_replace('(appid)',$this->cfg['appid'],wysBasic::$cache_path['jstik']); 
		if(!file_exists($this->cacheFull)){ 
			$this->cacheSave(array('jsapi_ticket'=>'','expire_time'=>''));
		}
		//die($this->cacheFull);
	}
  
	private function cacheSave($data) {
		$fp = fopen($this->cacheFull, "w");
		fwrite($fp, json_encode($data));
		fclose($fp);
	}

  /*private function getAccessToken(){}*/
  /*private function httpGet($url){}*/
  
}




/*******************************************************************************
 File : \code\adpt\wechat\wmpMaterial.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 素材管理接口
// 随微信规则更新 7000009:请求语义服务失败 

class wmpMaterial extends wmpBasic{
	
	private $tupUrl = 'https://api.weixin.qq.com/cgi-bin/media/upload?access_token=%s&type=%s';
	private $tgetUrl = 'https://api.weixin.qq.com/cgi-bin/media/get?access_token=%s&media_id=%s';
	
	private $mnewsUrl = 'https://api.weixin.qq.com/cgi-bin/material/add_news?access_token=%s';
	private $mnimgUrl = 'https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token=%s';
	private $maddUrl = 'https://api.weixin.qq.com/cgi-bin/material/add_material?access_token=%s';
	
	private $mlistUrl = 'https://api.weixin.qq.com/cgi-bin/material/batchget_material?access_token=%s'; //这个接口每天调用上限只有10此左右
	private $mdelUrl = 'https://api.weixin.qq.com/cgi-bin/material/del_material?access_token=%s';
	
	function __construct($cfg=array()){ 
		parent::__construct($cfg); 
	}
   // 新增临时素材
    function tmpUpload($path,$type='image'){
		$url = sprintf($this->tupUrl,$this->actoken,$type);
		$paras['media'] = '@'.wysMaterial::getLocal($path); 
		$data = comHttp::doPost($url, $paras, 5); 
		return wysBasic::jsonDecode($data,$this->tupUrl);
    }
	// 获取临时素材
    function tmpGet($media_id){
		$url = sprintf($this->tgetUrl,$this->actoken,$media_id);
		return $url;
	}
	
	// 新增其他类型永久素材
    function matAdd($path){
		$url = sprintf($this->maddUrl,$this->actoken);
		$paras['media'] = '@'.wysMaterial::getLocal($path);
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->maddUrl);
	}
	
	// 新增永久图文素材
	// articles:包含:$title,$medid,$content,$url
	// 
    function matNews($articles,$author='system',$digest=0,$cpic=0){
		$url = sprintf($this->mnewsUrl,$this->actoken);
		$paras['articles'] = array();
		foreach($articles as $k=>$v){
			$paras['articles'][] = array(
				"title" => $v['title'],
				"thumb_media_id" => $v['medid'],
				"author" => $author,
				"digest" => $k==$digest ? 1 : 0,
				"show_cover_pic" => $k==$cpic ? 1 : 0,
				"content" => $v['content'],
				"content_source_url" => $v['url'],
			);	
		}
		$paras = wysBasic::jsonEncode($paras);
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->mnewsUrl);
	}
    
	// 获取素材列表
	// $type = 图片（image）、视频（video）、语音 （voice）、图文（news）
    function mgetList($type,$offset=0,$count=20){
		$url = sprintf($this->mlistUrl,$this->actoken);
		$paras = "{\"type\":\"$type\",\"offset\":$offset,\"count\":$count}";
		//$paras['media'] = '@'.wysMaterial::getLocal($path);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->mlistUrl);
	}
	
	// 删除永久素材
    function mdelMedia($media_id){
		$url = sprintf($this->mdelUrl,$this->actoken);
		$paras = "{\"media_id\":\"$media_id\"}";
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->mdelUrl);
	}
	
    /** 获取媒体（具体保存媒体由相关代码实现）
     */
    function loadMedia($mediaid){
		if(strpos($mediaid,'://')){ //文件url格式
			$url = $mediaid;	
			//最近更新，永久图片素材新增后，将带有URL返回给开发者，开发者可以在腾讯系域名内使用（腾讯系域名外使用，图片将被屏蔽）。
		}else{
			$url = sprintf($this->tgetUrl, $this->actoken, $mediaid);
		} 
		$media = comHttp::doGet($url, 3); 
		return $media; //失败为NULL
    }

}



/*******************************************************************************
 File : \code\adpt\wechat\wmpMenu.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 菜单管理
// 随微信规则更新

class wmpMenu extends wmpBasic{

    protected $menuUrl = 'https://api.weixin.qq.com/cgi-bin/menu/%s?access_token=%s';
	protected $oauth = NULL;
	
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}
	
    // 查询当前使用的自定义菜单结构
    function menuGet(){
        $url = sprintf($this->menuUrl, 'get', $this->actoken);
		$data = comHttp::doGet($url,3);
		return wysBasic::jsonDecode($data,$this->menuUrl);
    }
    
	// 创建菜单
    function menuCreate($mcfg=array()){ 
		$ucfg['button'] = $mcfg;
		$url = sprintf($this->menuUrl, 'create', $this->actoken); 
		$paras = wysBasic::jsonEncode($ucfg); 
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->menuUrl);
    }    
	
    // 删除当前使用的自定义菜单
    function menuDelete(){
        $url = sprintf($this->menuUrl, 'delete', $this->actoken);
		$data = comHttp::doGet($url,3);
		return wysBasic::jsonDecode($data,$this->menuUrl);
    }
	
}



/*******************************************************************************
 File : \code\adpt\wechat\wmpMsgmass.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 群发信息
// 随微信规则更新
// 除文本外消息外，其它接口需要相应的media_id

class wmpMsgmass extends wmpBasic{
	
	protected $msgSend = "https://api.weixin.qq.com/cgi-bin/message/mass/send";
	protected $msgSall = "https://api.weixin.qq.com/cgi-bin/message/mass/sendall";
	protected $msgSurl = "";
	protected $upVideo = "https://file.api.weixin.qq.com/cgi-bin/media/uploadvideo";
	protected $msgTpl = "https://api.weixin.qq.com/cgi-bin/message/template/send"; 
	
	function __construct($cfg=array()){
		if(strpos(@$cfg['kid'],'08_')) die('Forbid');
		parent::__construct($cfg); 
	}	

    /**群发Tpl消息
     */
    function sendTpl($openids, $tpl, $data, $link=''){
		$openids = explode(',', $openids);
		$res = array();
		defined('WERR_RETURN') || define('WERR_RETURN',1); //错误信息返回
		foreach ($openids as $openid) {
			$url = $this->msgTpl."?access_token={$this->actoken}";
			$paras = '{"touser":"'.$openid.'","template_id":"'.$tpl.'","url":"'.$link.'","data":{'.$data.'}}';
			//dump($paras);
			$data = comHttp::doPost($url, $paras, 3); 
			$res[$openid] = wysBasic::jsonDecode($data,$this->msgTpl);
		}
		return $res;
    }

    /**群发文本客服消息
     */
    function sendText($content, $group_id=0){
		$content = wysBasic::jsonEncode($content); 
		$filter = $this->getFilter($group_id);
		$url = $this->msgSurl."?access_token={$this->actoken}";
		$paras = '{'.$filter.',"msgtype":"text","text":{"content":'.$content.'}}';
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->msgSurl);
    }

    /**
     * 群发图片客服消息
     */
    function sendImage($media_id, $group_id=0) {
		$filter = $this->getFilter($group_id);
		$url = $this->msgSurl."?access_token={$this->actoken}";
		$paras = '{'.$filter.',"msgtype":"image","image":{"media_id":'.$media_id.'}}';
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->msgSurl);
    }

    /**
     * 群发语音客服消息
     */
    function sendVoice($media_id, $group_id=0) {
		$filter = $this->getFilter($group_id);
		$url = $this->msgSurl."?access_token={$this->actoken}";
		$paras = '{'.$filter.',"msgtype":"voice","voice":{"media_id":'.$media_id.'}}';
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->msgSurl);
    }

    /**
     * 群发视频客服消息
	 * 注意分两次getResource，详情请看官方文档
     */
    function sendVideo($media_id, $group_id=0, $title='', $description='') {
		$url = $this->upVideo."?access_token={$this->actoken}";
		$msgup = array();
		$msgup['media_id'] = $media_id;
		$msgup['title'] = $title;
		$msgup['description'] = $description;
		$paras = wysBasic::jsonEncode($message); //echo $paras;
		$data = comHttp::doPost($url, $paras, 3);  
		$re = wysBasic::jsonDecode($data,$this->upVideo);
		if(!empty($re['media_id'])){
			$filter = $this->getFilter($group_id);
			$url = $this->msgSurl."?access_token={$this->actoken}";
			$paras = '{'.$filter.',"msgtype":"mpvideo","mpvideo":{"media_id":'.$re['media_id'].'}}';
			$data = comHttp::doPost($url, $paras, 3);  
			return wysBasic::jsonDecode($data,$this->msgSurl);
		}
    }

    /**
     * 群发图文客服消息
     */
    function sendNews($media_id, $group_id=0) {
		$filter = $this->getFilter($group_id);
		$url = $this->msgSurl."?access_token={$this->actoken}";
		$paras = '{'.$filter.',"msgtype":"mpnews","mpnews":{"media_id":'.$media_id.'}}';
		$data = comHttp::doPost($url, $paras, 3);  
		return wysBasic::jsonDecode($data,$this->msgSurl);
    }
	
    /**
     * 群发卡券消息
     */
    function sendCard($card_id, $group_id=0) {
		$filter = $this->getFilter($group_id);
		$url = $this->msgSurl."?access_token={$this->actoken}";
		$paras = '{'.$filter.',"msgtype":"wxcard","wxcard":{"card_id":'.$card_id.'}}';
		$data = comHttp::doPost($url, $paras, 3);  
		return wysBasic::jsonDecode($data,$this->msgSurl);
    }
	
	// group_id: 0:  群发所有；
	//     非0数字:  按会员组群发；
	//     openid1,openid2…:   按openid群发【订阅号不可用，服务号认证后可用】
    function getFilter($group_id=0){
		$re = '';
		$this->msgSurl = $this->msgSall;
		if(empty($group_id)){
			$re = '"filter":{"is_to_all":true}';
		}elseif(is_int($group_id)){
			$re = '"filter":{"is_to_all":false,"group_id":"'.$group_id.'"}';
		}else{
			$re = '"touser":["'.str_replace(',','","',$group_id).'"]';
			$this->msgSurl = $this->msgSend;
		}
		return $re;
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wmpMsgresp.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 被动回复信息(这里只组消息结构,不能直接die，因为可能下发消息后，还有继续其它操作)
// 随微信规则更新

class wmpMsgresp extends wmpBasic{
	
	public $reAuto = 'https://api.weixin.qq.com/cgi-bin/get_current_autoreply_info?access_token=';
	public $post = NULL;
	//public $return = '';
	
	//function __destory(){  }
	function __construct($post,$cfg=array()){
		if(!empty($cfg)){
			parent::__construct($cfg); 
		}
		$this->post = $post;
		//$this->return = $return;
	}

     function rebHead($type='text'){
		$from = @$this->post->FromUserName;
        $to = @$this->post->ToUserName; //Trying to get property of non-object in
		$data = "<ToUserName><![CDATA[$from]]></ToUserName>";
		$data .= "<FromUserName><![CDATA[$to]]></FromUserName>";
		$data .= "<CreateTime>".time()."</CreateTime>";
		$data .= "<MsgType><![CDATA[$type]]></MsgType>";
		return $data;
	}
	
     function rebEnd($data){
		 $data = "<xml>$data</xml>";
		 return $data;
	 }
	 
	 // 回复text消息
	 function remText($text, $conv=1){
		$data = $this->rebHead('text');
		$data .= "<Content><![CDATA[$text]]></Content>";
		return $this->rebEnd($data);
	}
	
    // 回复Image消息
    function remImage($mediaid) {
		$data = $this->rebHead('image');
		$data .= "<Image><MediaId><![CDATA[$mediaid]]></MediaId></Image>";
		return $this->rebEnd($data);
    }

    // 回复语音消息
    function remVoice($mediaid) {
		$data = $this->rebHead('voice');
		$data .= "<Voice><MediaId><![CDATA[$mediaid]]></MediaId></Voice>";
		return $this->rebEnd($data);
    }

    // 回复视频消息
    function remVideo($mediaid, $title="", $description="") {
		$dext = "<Title><![CDATA[$title]]></Title><Description><![CDATA[$description]]></Description>";
		$data = $this->rebHead('video');
		$data .= "<Video><MediaId><![CDATA[$mediaid]]></MediaId>$dext</Video>";
		return $this->rebEnd($data);
    }

    // 回复音乐消息
    function remMusic($title = '', $description = '', $url = '', $hq_url = '') {
		$dext = "<Title><![CDATA[$title]]></Title><Description><![CDATA[$description]]></Description>";
		$dext .= "<MusicUrl><![CDATA[$url]]></MusicUrl><HQMusicUrl><![CDATA[$hq_url]]></HQMusicUrl>";
		$data = $this->rebHead('music');
		$data .= "<Music>$dext</Music>";
		return $this->rebEnd($data);
    }
	
	// 回复新闻消息
	function remNews($news){
		$data = $this->rebHead('news');
		$list = isset($news['title']) ? array($news) : $news;
		$cnt = 0; $recs = "";
		foreach($list as $news){
			if(empty($news['title'])) continue;
			$cnt++;
			$urls = array('url','picurl');
			foreach ($urls as $key) {
				if(!empty($news[$key])){
					$news[$key] = wysBasic::fmtUrl($news[$key]);
				}
			}
			$recs .= "<item>";
			$recs .= "<Title><![CDATA[{$news['title']}]]></Title>";
			empty($news['desc']) || $recs .= "<Description><![CDATA[{$news['desc']}]]></Description>";
			empty($news['picurl']) || $recs .= "<PicUrl><![CDATA[{$news['picurl']}]]></PicUrl>"; //大图360*200，小图200*200
			empty($news['url']) || $recs .= "<Url><![CDATA[{$news['url']}]]></Url>";
			$recs .= "</item>";
		}
		$data .= "<ArticleCount>$cnt</ArticleCount><Articles>$recs</Articles>";
		return $this->rebEnd($data);
	}
	
	// 获取自动回复规则
	function getRule($actoken=''){
		$url = $this->reAuto."{$actoken}";
		$data = comHttp::doGet($url, 3);
		return wysBasic::jsonDecode($data,$this->reAuto);
	}
	
	function getMethod($type){
		$method = 're'.ucfirst(strtolower($this->post->$type)); 
		if(method_exists($this,$method)){
			return $method;
		}elseif(method_exists($this,"{$method}Base")){
			return "{$method}Base";
		}else{
			wysBasic::debugError("getMethod:$method",$this->post,'');
		}
	}

	//保存地理位置(发送位置/自动上报)共用(本来放这有点不合适,但为了共用一段代码...)
	//type=0, 返回地址信息
    function savePos($type='auto'){ 
		$row = $this->_db->table('wex_locate')->where("openid='{$this->post->FromUserName}' AND appid='{$this->cfg['appid']}'")->find();
		if(!$type) return $row;
		$data = array(
			'type' => $type,
			'latitude' => $type=='auto' ? $this->post->Latitude : $this->post->Location_X,
			'longitude' => $type=='auto' ? $this->post->Longitude : $this->post->Location_Y,
			'extra' => $type=='auto' ? $this->post->Precision : $this->post->Scale, //Label
			'atime' => time(),
		); 
		if($row){
			$this->_db->table('wex_locate')->data($data)->where("openid='{$this->post->FromUserName}' AND appid='{$this->cfg['appid']}'")->update();  
		}else{ 
			$data = $data + array(
				'appid' => $this->cfg['appid'],
				'openid' => $this->post->FromUserName,
			); //print_r($data);
			$this->_db->table('wex_locate')->data($data)->insert();
		}
	}
	
}



/*******************************************************************************
 File : \code\adpt\wechat\wmpMsgsend.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
/**
 * 发送消息 > 客服接口-发消息
 * 随微信规则更新
 *
 * 当用户主动发消息给公众号的时候（包括发送信息、点击自定义菜单、订阅事件、扫描二维码事件、支付成功事件、用户维权），微信将会把消息数据推送给开发者，开发者在一段时间内（目前修改为48小时）可以调用客服消息接口，通过POST一个JSON数据包来发送消息给普通用户，在48小时内不限制发送次数。
 */

class wmpMsgsend extends wmpBasic{
	
	protected $msgSend = "https://api.weixin.qq.com/cgi-bin/message/custom/send";
	
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}	

    /**发送文本客服消息
     *
     * @param $openid
     * @param $content
     *
     * @return bool|mixed
     */
    function sendText($openid, $content){
		$url = $this->msgSend."?access_token={$this->actoken}";
		$message = array();
		$message['touser'] = $openid;
		$message['msgtype'] = "text";
		$message['text']['content'] = $content;
		$paras = wysBasic::jsonEncode($message);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->msgSend);
    }

    /**
     * 发送图片客服消息
     *
     * @param $openid
     * @param $mediaid
     *
     * @return bool|mixed
     */
    function sendImage($openid, $mediaid) {
		$url = $this->msgSend."?access_token={$this->actoken}";
		$message = array();
        $message['touser'] = $openid;
        $message['msgtype'] = "image";
        $message['image']['media_id'] = $mediaid;
		$paras = wysBasic::jsonEncode($message);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->msgSend);
    }

    /**
     * 发送语音客服消息
     *
     * @param $openid
     * @param $media_id
     *
     * @return bool|mixed
     */
    function sendVoice($openid, $media_id) {
		$url = $this->msgSend."?access_token={$this->actoken}";
		$message = array();
		$message['touser'] = $openid;
		$message['msgtype'] = "voice";
		$message['voice']['media_id'] = $media_id;
		$paras = wysBasic::jsonEncode($message);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->msgSend);
		
    }

    /**
     * 发送视频客服消息
     *
     * @param        $openid
     * @param        $media_id
     * @param string $title
     * @param string $description
     *
     * @return bool|mixed
     */
    function sendVideo($openid, $media_id, $title = "", $description = "") {
		$url = $this->msgSend."?access_token={$this->actoken}";
		$message = array();
		$message['touser'] = $openid;
		$message['msgtype'] = "video";
		$message['video']['media_id'] = $media_id;
		$message['video']['title'] = $title;
		$message['video']['description'] = $description;
		$paras = wysBasic::jsonEncode($message);
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->msgSend);
		
    }

    /**
     * 发送音乐客服消息
     *
     * @param        $openid
     * @param        $url
     * @param        $hq_url
     * @param        $media_id
     * @param string $title
     * @param string $description
     *
     * @return bool|mixed
     */
    function sendMusic($openid, $url, $hq_url, $media_id, $title = "", $description = "") {
		$url = $this->msgSend."?access_token={$this->actoken}";
		$message = array();
		$message['touser'] = $openid;
		$message['msgtype'] = "music";
		$message['music']['title'] = $title;
		$message['music']['description'] = $description;
		$message['music']['musicurl'] = $url;
		$message['music']['hqmusicurl'] = $hq_url;
		$message['music']['thumb_media_id'] = $media_id;
		$paras = wysBasic::jsonEncode($message);
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->msgSend);
		
    }

    /**
     * 发送图文客服消息
     *
     * @param $openid
     * @param $items
     *
     * @return bool|mixed
     * @throws Exception
     */
    function sendNews($openid, $items) {
		$url = $this->msgSend."?access_token={$this->actoken}";
		$message = array();
		$message['touser'] = $openid;
		$message['msgtype'] = "news";
		if ($items && is_array($items)){
			foreach ($items as $item){
				if (is_array($item) && (isset($item['title']) || isset($item['description']) || isset($item['picurl']) || isset($item['url']))){
					$it['title'] = isset($item['title']) ? $item['title'] : "";
					$it['description'] = isset($item['description']) ? $item['description'] : "";
					$it['url'] = isset($item['url']) ? $item['url'] : "";
					$it['picurl'] = isset($item['picurl']) ? $item['picurl'] : "";
					if ($it['title'] && $it['description'] && $it['url'] && $it['picurl'])
						$message['news']['articles'][] = $it;
				}
			}
		}
		$paras = wysBasic::jsonEncode($message);
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->msgSend);
		
    }

}



/*******************************************************************************
 File : \code\adpt\wechat\wmpOauth.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 网页授权
// 随微信规则更新

class wmpOauth extends wmpBasic{
	
	// 获取code的链接
    private $accodeUrl = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=%s&redirect_uri=%s&response_type=code&scope=%s&state=%s#wechat_redirect';
    
	// 获取网页授权调用凭证access_token的链接
	private $actokenUrl = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&secret=%s&code=%s&grant_type=authorization_code';
	
	// 获取通过授权的微信用的基本信息
	private $acuinfoUrl = 'https://api.weixin.qq.com/sns/userinfo?access_token=%s&openid=%s&lang=zh_CN';
    
	//刷新access_token
	private $acupdUrl = 'https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=APPID&grant_type=refresh_token&refresh_token=REFRESH_TOKEN';
	
    // 获取的access_token信息
    protected $accessToken;
    
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}
    
    /**
     * 第三方网页通过Oauth2.0获取用户授权
     * 获取code
     */
    function getCode($redirect, $scope='', $state='system') {
        //$redirect = urlencode($redirect);
		$redirect = str_replace(array("?&","&","#"),array("?","%26","%23"),$redirect);
		$scope = in_array($scope,array('snsapi_base','snsapi_userinfo')) ? $scope : 'snsapi_base';
        return sprintf($this->accodeUrl,$this->cfg['appid'],$redirect,$scope,$state);  
    }

    /**
     * 通过code获取access_token
     */
    function getACToken($code){
    	if($this->accessToken == null){
    		$url = sprintf($this->actokenUrl,$this->cfg['appid'],$this->cfg['appsecret'],$code);
			$accessInfo = comHttp::doGet($url,3); 
    		$this->accessToken = $accessToken = json_decode($accessInfo,true);
    		if(isset($accessToken['errcode'])){
    			return array('errcode'=>$accessToken['errcode'],'errmsg'=>$accessToken['errmsg'],'result'=>null);
    		}
    	} 
        return array('errcode'=>0,'errmsg'=>'','result'=>$this->accessToken);
    }

    /**
     * 第三方网页通过Oauth2.0获取用户授权
     * 刷新access_token
     */
    function oauthRefresh($refresh_token) {
        //return self::get(self::$links['oauth_refresh'] . "?appid={$this->appid}&grant_type=refresh_token&refresh_token={$refresh_token}");
    }

    /**
     * 第三方网页通过Oauth2.0获取用户权限
     * 获取用户信息，仅限scope为snsapi_userinfo
     */
    function getUserInfo($actoken, $openid) {
        $url = sprintf($this->acuinfoUrl,$actoken,$openid);
		$data = comHttp::doGet($url,3);
		return wysBasic::jsonDecode($data,$this->acuinfoUrl);
    }

}



/*******************************************************************************
 File : \code\adpt\wechat\wmpQrcode.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 生成带参数的二维码
// 随微信规则更新

class wmpQrcode extends wmpBasic{

    protected $qrcode_ticket = 'https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=';
    protected $qrcode_show = 'https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=';
	protected $short_url = 'https://api.weixin.qq.com/cgi-bin/shorturl?access_token=';
    
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}

    /**
     * 创建二维码ticket
     * @param array $data 参数
     */
    function qrcodeTicket($sid,$type='temp',$exp=86400){ //7天（即604800秒）
		$url = $this->qrcode_ticket."{$this->actoken}";
		$cfg = array(
			'temp' => "{'expire_seconds': $exp, 'action_name': 'QR_SCENE', 'action_info': {'scene': {'scene_id': $sid}}}",
			'fnum' => "{'action_name': 'QR_LIMIT_SCENE', 'action_info': {'scene': {'scene_id': $sid}}}",
			'fstr' => "{'action_name': 'QR_LIMIT_STR_SCENE', 'action_info': {'scene': {'scene_str': '$sid'}}}",
		);
		$paras = isset($cfg[$type]) ? $cfg[$type] : $cfg['temp'];
		$paras = str_replace("'",'"',$paras);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->qrcode_ticket);
    }
	
    /**
     * 通过ticket换取二维码(地址)
     */
    function qrcodeShowurl($ticket){
		if(is_array($ticket)) $ticket = $ticket['ticket'];
		return $this->qrcode_show."{$ticket}";
    }
	
    /**
     * 长链接转短链接接口
     */
    function shortUrl($longurl){
		$url = $this->short_url."{$this->actoken}";
		$paras = "{\"action\":\"long2short\",\"long_url\":\"$longurl\"}"; 
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->short_url);
    }
	
}



/*******************************************************************************
 File : \code\adpt\wechat\wmpSemantic.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 语义理解接口
// 随微信规则更新 7000009:请求语义服务失败 

class wmpSemantic extends wmpBasic{
	
	private $yuyiUrl = 'https://api.weixin.qq.com/semantic/semproxy/search';
	
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}
    
    //
    function getResult($q, $city, $category, $uid){
		$url = $this->yuyiUrl."?access_token={$this->actoken}";
		$message = array();
		$message['q'] = $q;
		$message['city'] = $city;
		$message['category'] = $category;
		$message['uid'] = $uid;
		$data = comHttp::doPost($url, $message, 3); //{"ret":7000001}
		return wysBasic::jsonDecode($data,$this->yuyiUrl);
    }

}



/*******************************************************************************
 File : \code\adpt\wechat\wmpUser.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 关注用户相关
// 随微信规则更新

class wmpUser extends wmpBasic{
	
	protected $user_list = 'https://api.weixin.qq.com/cgi-bin/user/get?access_token=%s&next_openid=%s'; 
	protected $user_info = 'https://api.weixin.qq.com/cgi-bin/user/info?access_token=%s&openid=%s&lang=zh_CN';
	protected $user_remark = 'https://api.weixin.qq.com/cgi-bin/user/info/updateremark?access_token=%s';
	protected $user_batchget = 'https://api.weixin.qq.com/cgi-bin/user/info/batchget?access_token=%s';
	
	protected $group_get = 'https://api.weixin.qq.com/cgi-bin/groups/get?access_token=%s';
    protected $group_create = 'https://api.weixin.qq.com/cgi-bin/groups/create?access_token=%s';
    protected $group_rename = 'https://api.weixin.qq.com/cgi-bin/groups/update?access_token=%s';
	protected $group_delete = 'https://api.weixin.qq.com/cgi-bin/groups/delete?access_token=%s';
    protected $group_getid = 'https://api.weixin.qq.com/cgi-bin/groups/getid?access_token=%s';
    protected $group_move = 'https://api.weixin.qq.com/cgi-bin/groups/members/update?access_token=%s';
	
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}	
	
	//批量获取用户基本信息
	//$users : string / array()
	function getUserBatch($users,$re=0){ //
		$url = sprintf($this->user_batchget, $this->actoken);
		if(is_string($users)){
			$users = explode(',',$users);	
		}
		$udata = '';
		foreach($users as $v){
			if(empty($v)) continue;
			$udata .= (empty($udata) ? '' : ',')."{\"openid\":\"$v\",\"lang\":\"zh-CN\"}"; 
		}
		$paras = "{\"user_list\":[$udata]}";
		$data = comHttp::doPost($url, $paras, 5); 
		if($re) return $data;
		return wysBasic::jsonDecode($data,$this->user_batchget);
	}
	
	// 列表
    function getUserInfoList($next=''){ 
		$url = sprintf($this->user_list, $this->actoken, $next);
		$data = comHttp::doGet($url."",5); 
		return wysBasic::jsonDecode($data,$this->user_list); 
    }
	
	// 用户信息
	function getUserInfo($openid){ 
		$url = sprintf($this->user_info, $this->actoken, $openid);	
		$data = comHttp::doGet($url,3);
		return wysBasic::jsonDecode($data,$this->user_info);
	}

	// 设置用户备注名
	function setUserRemark($openid,$rename){ //
		$url = sprintf($this->user_remark, $this->actoken);
		$paras = array(
			'openid' => $openid,
			'remark' => $rename,
		);
		$paras = wysBasic::jsonEncode($paras);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->user_remark);
	}

	function groupList(){  
		$url = sprintf($this->group_get, $this->actoken);	
		$data = comHttp::doGet($url,3); 
		return wysBasic::jsonDecode($data,$this->group_get); 
	}
	
	function groupCreate($gname){  
		$url = sprintf($this->group_create, $this->actoken);	
		$paras = array('group'=>array('name'=>$gname,));
		$paras = wysBasic::jsonEncode($paras);
		$data = comHttp::doPost($url, $paras, 3); 
		return wysBasic::jsonDecode($data,$this->group_create); 
	}
	
	function groupRename($gid,$gname){  
		$url = sprintf($this->group_rename, $this->actoken);	
		$paras = array('group'=>array('id'=>$gid,'name'=>$gname,));
		$paras = wysBasic::jsonEncode($paras);
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->group_rename); 
	}

	function groupDelete($gid){  
		$url = sprintf($this->group_delete, $this->actoken);	
		$paras = '{"group":{"id":"'.$gid.'"}}';
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->group_delete); 
	}
	
	function groupMove($openid,$gid){  
		$url = sprintf($this->group_move, $this->actoken);	
		$paras = '{"openid":"'.$openid.'","to_groupid":'.$gid.'}';
		$data = comHttp::doPost($url, $paras, 3);
		return wysBasic::jsonDecode($data,$this->group_move); 
	}

	
    /**
     * 坐标转换
     * @return array 返回json格式的ip列表
     */
    static function convMap($map='',$type=0){    
		$mar = explode(',',preg_replace('/[^\d|\,|\.]/', '', $map)); 
		$mar[1] = empty($mar[1]) ? '0' : $mar[1];
		$data = file_get_contents("http://api.map.baidu.com/ag/coord/convert?from=0&to=4&x=$mar[1]&y=$mar[0]");
		// from=0比from=2更准确 : 0表示地球坐标，2表示火星坐标，4表示百度坐标(所以这个原始坐标是地球坐标)
		$data = json_decode($data); //print_r($data);;
		if(empty($data->error)){
			$mapx = base64_decode($data->x);
			$mapy = base64_decode($data->y);
		}else{
			$mapx = $mar[1];
			$mapy = $mar[0];	
		}
		return array("$mapx,$mapy",'x'=>$mapx,'y'=>$mapy);
    }
	
	//static function getUserInfo($openid,$actoken=''){	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wysBasic.php 
*******************************************************************************/
<?php
// 对接本系统基本函数和配置
// 如果本系统修改,就改这个文件，不用改wmp*文件

class wysBasic{
	
    static $cfgs = array();
	static $tiks = array();
	
	static $cache_path = array(
		'actik' => "/weixin/actik_(appid).cac_txt",
		'jstik' => "/weixin/jstik_(appid).cac_txt",
	);
	
	//替换地址
	static function fmtUrl($url, $enc=0){ 
		global $_cbase;
		$a1 = array("{svrtxmao}","{svrtxcode}","{svrtxjia}");
		$a2 = array($_cbase['server']['txmao'],$_cbase['server']['txcode'],$_cbase['server']['txjia']);
		$url = str_replace($a1,$a2,$url);
		$root = PATH_PROJ;
		if(!strpos($url,'?')) $url .= '?'; 
		$from = array('{root}','?&',);
		$to = array($root,'?');
		$url = str_replace($from, $to, $url);
		if(!strstr($url,'://')){
			$home = $_cbase['run']['rsite']; 
			$url = "$home$url";
		}
		$enc && $url = str_replace(array("&","#"),array("%26","%23"),$url);
		return $url;
	}

	static function debugError($msg='',$arr=array(),$url='',$die=0){
		if(is_array($arr) && !empty($arr['errcode'])){
			$msg = wmpError::errGet($arr['errcode']);
			if(strpos($msg,'(unKnow)') && !empty($arr['errmsg'])){
				$msg = '['.$arr['errcode'].']'.$arr['errmsg'];
			}
			$msg = "$url<br>$msg";
		}elseif(is_object($arr) || is_array($arr)){ 
			$msg .= "$url<br>".var_export($arr,1); 
		}else{
			$msg .= "$url<br>".$arr;
		} 
		$msg && $msg = "$msg<br>";
		$debug = cfg('weixin.debug');
		if(defined('WERR_RETURN') && empty($die)){ 
			$arr['message'] = $msg;
			$arr['url'] = $url;
			return $arr; 
		}else{ 
			if(defined('RUN_WECHAT')){
				basDebug::bugLogs('weixin',$msg,'detmp','db');
			}
			if(defined('RUN_WECHAT') && empty($debug)){
				die(''); //这个回复微信服务器
			}else{
				if(defined('RUN_MOB')){ 
					echo "\n<meta name='viewport' content='width=device-width, initial-scale=1'>";
				}
				die($msg); //这个给人看的
			}
		}
	}
	
    //把数据转成JSON格式（让支持中文显示）
	static function jsonEncode($datas){ 
		return comParse::jsonEncode($datas);
	}
	
	static function jsonDecode($data,$url=''){ 
		if(empty($data)) return self::debugError($url.'<br>[Remote]获取远程数据错误，请检查php扩展和服务器环境<br>','');
		$arr = json_decode($data,1); //print_r($data); 
		if(!empty($arr['errcode'])){
			return self::debugError($arr['errcode'],$arr,$url);
		}else{
			return $arr;	
		}
	}
	
	// 返回系统配置/参数：(说明)
	// -> $key=kid,appid
    static function getConfig($val='admin', $key='kid'){
		$ckey = "$val-$key"; 
		if(isset(self::$cfgs[$ckey])){ 
			return self::$cfgs[$ckey]; 
		}
		$db = glbDBObj::dbObj();
		$recfg = $db->table('wex_apps')->where("$key='$val'")->find();
		return empty($recfg) ? array() : $recfg;
	}
	
	// 返回缓存文件路径
    static function getCfpath($key, $type='actik'){
		//comFiles::chkDirs('weixin','tmp',0);
		$cfile = DIR_DTMP.str_replace('(appid)',$key,self::$cache_path[$type]);
		return $cfile;
	}
	
	// clearCache
    static function clearCache($id){
		$cfg = self::getConfig($id);
	    foreach(self::$cache_path as $_pk=>$path){
		  $cfile = DIR_DTMP.str_replace('(appid)',$cfg['appid'],$path);
		  @unlink($cfile);
	    }
	}
	
}



/*******************************************************************************
 File : \code\adpt\wechat\wysEvent.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 事件响应操作
// 如果本系统修改,就改这个文件，不用改wmp*文件
// 各扩展系统需求变化很大,re开头的方法都加Base,扩展类里面不加Base,先检测执行无Base的方法,在找含有Base的方法

class wysEvent extends wmpMsgresp{

	public $_db = NULL;
	public $qrexpired = '5'; //5分钟过期...
	public $qrInfo = array();
	
	// 常用值
	public $eventKey = ''; //二维码场景ID
	public $fromName = ''; //微信open_id(用户ID)
	public $ghUser = ''; //开发者微信号
	public $subScanmsg = ''; //扫描关注消息
	
	public $sflag = ''; //扫描随机标记,用于安全检查

	function __construct($post,$wecfg){ 
		parent::__construct($post,$wecfg); 
		$method = $this->getMethod('Event'); 
		$this->_db = glbDBObj::dbObj();
		$this->init(); //echo $method;
		//setQrtable
		return $this->$method();
	}
	
	function init(){
		$this->eventKey = $this->post->EventKey; 
		$this->fromName = $this->post->FromUserName; 
		$this->ghUser = $this->post->ToUserName; 
	}
	
    // 取消关注事件
    function reUnsubscribeBase($re=0){ 
		//取消会员绑定,(是否删除会员？！)
		//$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();
		#if($re) return;
		die('');
	}
    
    // 响应关注/扫描带参数二维码事件
    function reSubscribeBase(){ 
		//查找关键字...
		$weres = new wysReply($this->post,$this->cfg,1); 
		$reauto = $weres->getKeyList('','follow_autoreply_info'); 
		$this->subScanmsg = empty($reauto) ? "您好，欢迎您关注 ".cfg('sys_name')."。\n" : "$reauto\n";
		if(!empty($this->eventKey)){ //未关注用户，扫描带参数二维码事件
			$this->eventKey = str_replace('qrscene_','',$this->eventKey);
			return $this->reScan();
		}
		die($this->remText($this->subScanmsg)); //回复
    }
    
	// 用户已关注时,扫描带参数二维码的事件推送
    function reScanBase(){ 
		if(!in_array(strlen($this->eventKey),array(5,10))){ die(''); }
		$this->qrInfo = $this->getQrinfo($this->eventKey); 
		$modKey = ucfirst(strtolower($this->qrInfo['smod'])); //echo "($modKey.$this->eventKey)";
		if(empty($modKey)){
			die($this->remText("二维码已过期，请重新获取二维码再操作！[$modKey:$this->eventKey]"));
		}
		$method = $this->getEvnact("scan$modKey",'scan'); //echo "<br>($method)";
		return $this->$method();
    }
	// ex
    function reScan($fromSub=''){
		return $this->reScanBase($fromSub);
	}

	// scan_Extra:无对应操作的处理
	function scan_Extra(){
		$msg = "无对应操作：[{$this->post->EventKey}], 请联系管理员！";
		$msg = $this->remText($msg);
		die($msg);
	}

	
    // 响应上报地理位置事件, 这里保存供使用
	// 用户同意上报地理位置后，每次进入公众号会话时，都会在进入时上报地理位置，或在进入会话后每5秒上报一次地理位置，
	// 公众号可以在公众平台网站中修改以上设置。
    function reLocationBase(){ 
		$this->savePos('auto');
		die('');
    }
    
    // 响应点击事件（即根据用户点击的按钮响应相应的回复）
    function reClickBase(){ 
		$eventKey = ucfirst(strtolower($this->eventKey)); 
		$eventKey = str_replace(array('_','-'),'',$eventKey);
		$method = $this->getEvnact("click$eventKey",'click');
		return $this->$method();
    }
	
	// 点击自定义菜单:无对应操作的处理
	function click_Extra(){
		$msg = "无对应操作：[{$this->post->EventKey}], 请联系管理员！";
		$msg = $this->remText($msg);
		die($msg);
	}
	
	// 用户点击自定义跳转URL菜单 事件处理
	function reViewBase(){
		die('');
	}
	
    // 摇一摇事件:ShakearoundUserShake
    function reShakearoundusershakeBase(){ 
		die('');
	}
	
	//获取场景二维码数据
    function getQrinfo($sid){
		$timeNmin = time()-($this->qrexpired*60*2); //10分钟 //saveState
		$row = $this->_db->table('wex_qrcode')->where("sid='$sid' AND atime>'$timeNmin'")->find();
		$this->sflag = basKeyid::kidRand(24,8);
		$this->_db->table('wex_qrcode')->data(array('sflag'=>$this->sflag,'openid'=>$this->fromName,))->where("sid='$sid'")->update();
		return $row;
	}
	
	function getEvnact($mcomm,$fix){ //echo "$mcomm,$fix"; 
		return method_exists($this,$mcomm) ? $mcomm : (method_exists($this,"{$mcomm}Base") ? "{$mcomm}Base" : "{$fix}_Extra"); 
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wysMaterial.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 素材管理接口
// 如果本系统修改,就改这个文件，不用改wmp*文件

class wysMaterial extends wmpMaterial{
	
	function __construct($cfg=array()){
		parent::__construct($cfg); 
	}
	
	function getName($fdata){
		$header = strtoupper(bin2hex($fdata));
		$cfg = $this->cfgTypes();
		$ename = 'unknow';
		foreach(array(6,4,) as $k){ //14,12,10,8,
			$chi = substr($header,0,$k); 
			if(isset($cfg[$chi])){
				$ename = $cfg[$chi];
			}
		}
		$bname = date('Y-md-His-').basKeyid::kidTemp();
		return "$bname.$ename";
	} 
	
	function cfgTypes(){
        return array(
			//请按key顺序排列，如果前N位相同，则往后加两位
			'424D' => 'bmp',
			'4749' => 'gif',
			'4949' => 'tif',
			'8950' => 'png',
			'FFD8' => 'jpg',
			/* 需要的化，根据以下扩展吧
			// 视频格式手机支持的一般是mp4和3gp    音频一般是mp3 acc
			array("FFD8FFE1","jpg"),
			array("89504E47","png"),
			array("47494638","gif"),
			array("49492A00","tif"),
			array("424D","bmp"),
			array("41433130","dwg"),
			array("38425053","psd"),
			array("7B5C727466","rtf"),
			array("3C3F786D6C","xml"),
			array("68746D6C3E","html"),
			array("44656C69766572792D646174","eml"),
			array("CFAD12FEC5FD746F","dbx"),
			array("2142444E","pst"),
			array("D0CF11E0","xls/doc"),
			array("5374616E64617264204A","mdb"),
			array("FF575043","wpd"),
			array("252150532D41646F6265","eps/ps"),
			array("255044462D312E","pdf"),
			array("E3828596","pwl"),
			array("504B0304","zip"),
			array("52617221","rar"),
			array("57415645","wav"),
			array("41564920","avi"),
			array("2E7261FD","ram"),
			array("2E524D46","rm"),
			array("000001BA","mpg"),
			array("000001B3","mpg"),
			array("6D6F6F76","mov"),
			array("3026B2758E66CF11","asf"),
			array("4D546864","mid"),
			*/
		);
    }

	static function getLocal($path){ 
		return DIR_STATIC.$path;
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wysMenu.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 本系统菜单操作
// 如果本系统修改,就改这个文件，不用改wmp*文件

class wysMenu extends wmpMenu{
//class wysBasic{
	
	public $oauth = NULL;
	
	function __construct($cfg=array()){
		if(strpos($cfg['kid'],'08_')) die('Forbid');
		parent::__construct($cfg); //$this->wxmenu = new cls_wecMenu($cfg);
		$this->oauth = new wmpOauth($cfg);
	}
	
	// 08格式的menu数组，
	function get(){ 
		$menu = $this->menuGet(); //print_r($menu);
		$re=array(); $i=0; $j=0; 
		if(isset($menu['menu']['button'])){
			$menu = $menu['menu']['button']; 
			foreach($menu as $k=>$v){
				$i++; $j=0;
				if(empty($v['sub_button'])){
					$val = isset($v['url']) ? $v['url'] : $v['key'];
					$re["{$i}0"] = array('type'=>$v['type'], 'name'=>$v['name'], 'val'=>$val, );
				}else{
					$re["{$i}0"] = array('name'=>$v['name']);
					foreach($v['sub_button'] as $k2=>$v2){
						$j++; 
						$val = isset($v2['url']) ? $v2['url'] : $v2['key'];
						$re["$i$j"] = array('type'=>$v2['type'], 'name'=>$v2['name'], 'val'=>$val, );
					}
				}
			}
		}
		return $re;
	}

	// {$mobileurl},{cms_abs},oauth=base/uinfo,
	function create($mcfg=array()){ 
		$menu = array(); $re = array(); 
		for($i=1;$i<=3;$i++){
			if(empty($mcfg["{$i}0"]['name'])) continue;
			$rei = array();
			$rei['name'] = $mcfg["{$i}0"]['name'];
			$subs = array();
			for($j=1;$j<=5;$j++){
				if(empty($mcfg["{$i}{$j}"]['name'])) continue;
				$name = $mcfg["{$i}{$j}"]['name'];
				$val = $this->fmtUrl($mcfg["{$i}{$j}"]['val']);
				$type = strpos($val,'://') ? 'view' : 'click'; //其它操作?! 
				$key = $type=='view' ? 'url' : 'key';
				$subs[] = array('type'=>$type, 'name'=>$name, $key=>$val, );
			}
			if(empty($subs)){
				$val = $this->fmtUrl($mcfg["{$i}0"]['val']);
				$type = $rei['type'] = strpos($val,'://') ? 'view' : 'click'; //其它操作?! 
				$key = $type=='view' ? 'url' : 'key';
				$rei[$key] = $val;
			}else{
				$rei['sub_button'] = $subs;
			}
			$re[] = $rei; 
		} 
		return $this->menuCreate($re);
	}

	// delete
	function del(){ 
		return $this->menuDelete();
	}
	
	//此方法，扩展需求比较多
	function fmtUrl($url, $enc=0){ 
		if(basStr::isKey($url,2,255)){
			//; Mylocal, Haibao
		}elseif(substr($url,0,13)=='oauth:snsapi_'){
			$a = explode(':',$url); // oauth:scope:state:{root}/mob.php
			$dir = substr($url,strlen($a[0])+strlen($a[1])+strlen($a[2])+3);
			$dir .= "&kid"."=".$this->cfg['kid'];
			$dir = self::fmtUrl($dir, 1);
			$url = $this->oauth->getCode($dir, $a[1], $a[2]); 
		}else{ // strpos($url,'://'), substr($url,0,7)=='{root}/'
			return wysBasic::fmtUrl($url, $enc);
			// http://www.d.com, {root}/mob.php
		}
		return $url;
	}
	
	static function getMenuData($appid){ 
		$db = glbDBObj::dbObj();
		$re = array(); 
		$data = $db->table('wex_menu')->where("appid='$appid'")->select(); 
		foreach($data as $row){
			$re[$row['key']] = $row;
		} //echo "<pre>"; print_r($re);
		return $re;
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wysQrcode.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 事件响应操作
// 如果本系统修改,就改这个文件，不用改wmp*文件

class wysQrcode extends wmpQrcode{

	public $_db = NULL;
	public $qrexpired = '5'; //5分钟过期...
	public $uniqueid = '';
	//public $maxsid = '2147000648'; //2^32=4,294,967,296; 2^31=2,147,483,648;  //mt_rand(): max(-5090297) is smaller than min(1001000123) 

	function __construct($wecfg){ 
		parent::__construct($wecfg); 
		$this->uniqueid = usrPerm::getUniqueid();
		$this->_db = glbDBObj::dbObj();
	}

    function getQrcode($smod, $type='temp', $extp=''){
		return $type=='temp' ? $this->getQTemp($smod,$extp) : $this->getQLimit($smod,$extp);
		/*
		这些数字区间，看怎样规划更合理...??? 
		// 1-10000               : 1-1万(固定二维码:保留区)
		// 10001-99999           : 10001-99999(固定二维码:使用区)
		//  100000<1000123       : 10-100万 保留(固定)
		// [1-9]+[999,999]       : 测试(临时二维码)
		// [100-428]+[9,999,999] : 正式使用(临时二维码)
		// 同类sid,5分钟内获取一个相同的ID,10分中后失效,
		
		//login
		//sendaid_7654321
		//sendmid_1234567
		//uparc_3
		//upcu_4
		*/
	}

	// 正式使用(临时二维码) [100-428]+[9,999,999] : 
	// 同类sid,5分钟内获取一个相同的ID,10分中后失效,(设置给微信的为最大值：7天（即604800秒）), 定时清理1天内的数据
    function getQTemp($smod, $extp=''){
		$stamp = time();
		$timeNmin = $stamp-($this->qrexpired*60); //5分钟
		$row = $this->_db->table('wex_qrcode')->where("auser='$this->uniqueid' AND smod='$smod' AND atime>'$timeNmin'")->find();
		if($row){ 
			$this->_db->table('wex_qrcode')->data(array('atime'=>$stamp,'extp'=>$extp,))->where("auser='$this->uniqueid' AND smod='$smod'")->update();
			$sid = $row['sid']; 
			$ticket = $row['ticket']; 
		}else{
			$sid = mt_rand(100,428).mt_rand(1000123,4967296);
			while($this->_db->table('wex_qrcode')->where("sid='$sid'")->find()){
				$sid = mt_rand(100,428).mt_rand(1000123,4967296); //如果访问量很多，是否计数等待??? 
			}
			$qrdata = $this->qrcodeTicket($sid, 'temp'); 
			$ticket = $qrdata['ticket']; 
			$data = array(
				'sid' => $sid,
				'smod' => $smod,
				'extp' => $extp, //Label
				'ticket' => $ticket,
				'atime' => $stamp,
				'auser' => $this->uniqueid,
			); 
			$this->_db->table('wex_qrcode')->data(basReq::in($data))->insert();
		}
		$ret = array('sid'=>$sid, 'ticket'=>$ticket, 'url'=>$this->qrcodeShowurl($ticket));
		return $ret;
	}

	// 正式使用(固定二维码) [10012,99987] :
	// 同类sid,5分钟内获取一个相同的ID,10分中后失效, (不用清理)
    function getQLimit($smod, $extp=''){
		$stamp = time();
		$timeNmin = $stamp-($this->qrexpired*60); //5分钟
		$row = $this->_db->table('wex_qrcode')->where("auser='$this->uniqueid' AND smod='$smod' AND atime>'$timeNmin'")->find();
		if($row){ 
			$this->_db->table('wex_qrcode')->data(array('atime'=>$stamp,'extp'=>$extp,))->where("auser='$this->uniqueid' AND smod='$smod' AND atime>'$timeNmin'")->update();
			$sid = $row['sid']; 
			$ticket = $row['ticket'];
		}else{
			$sid = mt_rand(10012,99987);  
			while($this->_db->table('wex_qrcode')->where("sid='$sid' AND atime>'$timeNmin'")->find()){
				$sid = mt_rand(10012,99987); //如果访问量很多，是否计数等待??? 
			}
			$row = $this->_db->table('wex_qrcode')->where("sid='$sid'")->find(); //可能存在，可能不存在...
			$data = array(
				'smod' => $smod,
				'extp' => $extp, //Label
				'atime' => $stamp,
				'auser' => $this->uniqueid,
			); //print_r($row);
			if(empty($row['ticket'])){
				$qrdata = $this->qrcodeTicket($sid, 'fnum'); 
				$ticket = $qrdata['ticket']; 
				$data = $data + array(
					'sid' => $sid,
					'ticket' => $ticket,
				); 
				$this->_db->table('wex_qrcode')->data(basReq::in($data))->insert();
			}else{
				$ticket = $row['ticket'];
				$this->_db->table($tabid)->data($data)->where("sid='$sid'")->update();  
			}

		}
		$ret = array('sid'=>$sid, 'ticket'=>$ticket, 'url'=>$this->qrcodeShowurl($ticket));
		return $ret;
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wysReply.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 消息回复（被动回复）
// 如果本系统修改,就改这个文件，不用改wmp*文件
// 各扩展系统需求变化很大,re开头的方法都加Base,扩展类里面不加Base,先检测执行无Base的方法,在找含有Base的方法
// - 实现:1.关键字回复, 
// -      2.传图(后续利用)
// -      3.地理位置消息(是否保存??? 供需要时调用)

class wysReply extends wmpMsgresp{
	
	public $_db = NULL;
	
	function __construct($post,$cfg,$re=0){ 
		parent::__construct($post,$cfg); 
		$this->_db = glbDBObj::dbObj(); 
		if($re) return;
		$method = $this->getMethod('MsgType');
		return $this->$method();
	}
	
	// 文本消息
    function reTextBase($re=0){  
		$detail = $this->post->Content;
		//获取关键字
		$reauto = $this->getKeyList($detail); 
		//保存收到的消息... (开关???)
		$retype = empty($reauto['rexml']) ? '-' : 'Auto'; 
		$this->saveMsg('text', $detail, $retype);
		if(empty($reauto['rexml'])){ 
			if($re) return '';
			die('');
		}
		$rexml = $reauto['rexml']; 
		//保存回复消息... 
		$this->saveReply($reauto); 
		//回复消息给微信服务器... 
		if($re) return $rexml;
		die($rexml); 
    }

	// 地理位置消息
    function reLocationBase(){ 
		$this->savePos('send');
		die('');    
    }

	// 图片消息
    function reImageBase($re=0){ 
		$stamp = time();
		$picUrl = $this->post->PicUrl;
		$this->saveMsg('image', $picUrl, '-', $this->post->MediaId);
		//保持会话不过期
		$timeNmin = $stamp-(5*60);
		$this->_db->table('wex_qrcode')->data(array('atime'=>$stamp))->where("openid='{$this->post->FromUserName}' AND smod='upload' AND atime>'$timeNmin'")->update(); 
		if($re) return;
		die('');
    }
	
	// 语音消息
    function reVoiceBase(){ 
		//return $this->remText("remVoice:xxx");  
		die('');   
    }	

	// 视频消息
    function reVideoBase(){ 
		//return $this->remText("remVideo:xxx");  
		die(''); 
    }

	// 小视频消息
    function reShortvideo(){ 
		//return $this->remText("remShortvideo:xxx"); 
		die(''); 
    }
	
	// 链接消息
    function reLinkBase(){ 
		//return $this->remText("remLink:xxx");  
		die('');   
    }	

	//获取关键字列表(本系统的)
    function getKeyList($detail,$relist='0'){ 
		$klist = array(); 
		$list = $this->_db->table('wex_keyword')->where("appid='{$this->cfg['appid']}'")->select(); 
		if($list){ foreach($list as $row){
			$key = $row['keyword']=='follow_autoreply_info' ? $row['keyword'] : $row['kid'];
			$klist[$key] = $row;
		} } //print_r($this->cfg);
		if($relist=='follow_autoreply_info' && isset($klist['follow_autoreply_info'])){
			return $klist['follow_autoreply_info']['detail'];
		}else{
			unset($klist['follow_autoreply_info']);	
		}
		if($relist) return $klist;
		$retype = ''; $rexml = ''; $remsg = '';
		//查找关键字,获取自动回复内容
		foreach($klist as $v){
			if(empty($v['keyword'])) continue;
			preg_match("/".str_replace(',','|',$v['keyword'])."/i",$detail,$rea);
			if(!empty($rea)){ //考虑回复其它类型的消息？//strstr($detail,$v['keyword'])
				$remsg .= $v['detail'];
				if(!empty($v['picurl'])){
					$remsg .= "\n<img src='".wysBasic::fmtUrl($v['picurl'])."'>\n";
				}
				if(!empty($v['url'])){
					$remsg .= "\n<a href='".wysBasic::fmtUrl($v['url'])."'>详情 >> </a>";
				}
				$retype = $v['type']; 
				$retype || $retype = 'text';
				$method = 'rem'.ucfirst($retype);
				$rexml = method_exists($this,$method) ? $this->$method($remsg) : '';
				break;
			}
		}
		return array('type'=>$retype, 'rexml'=>$rexml, 'remsg'=>$remsg);
	}
	
	//保存信息
    function saveMsg($retype, $detail, $restat='Auto', $media_id=''){ //已Auto自动回复
		$data = array(
			'kid' => basKeyid::kidTemp(),
			'type' => $retype,
			'detail' => basReq::in($detail),
			'restate' => $restat,
			'atime' => time(),
			'appid' => $this->cfg['appid'],
			'openid' => $this->post->FromUserName,
		);
		$media_id && $data['media_id'] = $media_id;
		$this->_db->table('wex_msgget')->data($data)->insert();
	}
	
	//保存回复消息
    function saveReply($reauto){ 
		$data = array(
			'kid' => basKeyid::kidTemp(),
			'type' => $reauto['type'],
			'detail' => basReq::in($reauto['remsg']),
			'atime' => time(),
			'appid' => $this->cfg['appid'],
			'openid' => $this->post->FromUserName,
		); 
		$this->_db->table('wex_msgsend')->data($data)->insert();
	}

}



/*******************************************************************************
 File : \code\adpt\wechat\wysTester.php 
*******************************************************************************/
<?php
// 用于测试

class wysTester{
	
	public $post = NULL;

	// showUrl
	static function showUrl($url){ 	
		//$url = urldecode($url);
		$p1 = strpos($url,'redirect_uri='); $p1 = $p1+strlen('redirect_uri=');
		$p2 = strpos($url,'&response_type');
		$url = substr($url,$p1,$p2-$p1);
		$url = str_replace(array("%26","%23","?&",),array("&","#","?",),$url);
		return $url;
	}


	// 组随机测试信息
	static function showInfo($info){ 	
		//$info = preg_replace("/\s+/", '', $info);
		$info = str_replace("><",">\n<",$info);
		$info = str_replace(array(">\n<![CDATA[","]]>\n</"),array("><![CDATA[","]]></"),$info); 
		$info = str_replace(array("<",">"),array("&lt;","&gt;"),$info);
		$info = preg_replace("/\s(?=\s)/","\\1",$info);
		return "\n$info\n";
	}
	
	// 组随机测试事件
	static function getEvent($ext,$val=''){	
		$post = self::getPost();
		$weMsg = new wmpMsgresp($post,$cfg);
		$data = $weMsg->rebHead('event');
		if($ext=='Subscribe' || $ext=='Unsubscribe'){
			$data .= "<Event><![CDATA[".strtolower($ext)."]]></Event>";
		}elseif($ext=='Scan'){
			$ekey = empty($val) ? mt_rand(100001,2147483123) : $val;
			$data .= "<Event><![CDATA[SCAN]]></Event>";
			$data .= "<EventKey><![CDATA[1".mt_rand(100123,999123)."]]></EventKey>";
			$data .= "<Ticket><![CDATA[Ticket_".basKeyid::kidRand()."]]></Ticket>";
		}elseif($ext=='Location'){ 
			$data .= "<Event><![CDATA[LOCATION]]></Event>";
			$data .= "<Latitude>".(mt_rand(250012,400987)/10000)."</Latitude>";
			$data .= "<Longitude>".(mt_rand(990125,1209876)/10000)."</Longitude>";
			$data .= "<Precision>".mt_rand(80,120)."</Precision>";
		}elseif($ext=='Click'){
			$ekey = empty($val) ? "M".mt_rand(80,120) : $val;
			$data .= "<Event><![CDATA[CLICK]]></Event>";
			$data .= "<EventKey>$ekey</EventKey>";
		}elseif($ext=='View'){
			$data .= "<Event><![CDATA[VIEW]]></Event>";
			$data .= "<EventKey><![CDATA[www.".basKeyid::kidRand().".com]]></EventKey>";
		}else{ 
			
		}
		$data = $weMsg->rebEnd($data); 
		return $data;	
	}	
	
	// 组随机测试信息
	static function getMessage($mtxt=''){	
		$post = self::getPost();
		$weMsg = new wmpMsgresp($post);
		//$func = 'msg'.ucfirst($ext);
		//$parr = array('x'=>mt_rand(250012,400987)/10000, 'y'=>mt_rand(990125,1209876)/10000, 'scale'=>mt_rand(10,15), 'lable'=>'(lable位置信息)', 'title'=>'标题'.basKeyid::kidRand(), 'desc'=>'简述', 'url'=>'http://www.domain-'.basKeyid::kidRand().'.com/');
		$mtxt = empty($mtxt) ? '你好:'.basKeyid::kidRand() : $mtxt; 
		//$para = $func=='remText' ? $mtxt : $parr;
		$data = $weMsg->remText($mtxt);
		return $data;	
	}
	
	// 组随机Post信息
	static function getPost(){
		$from = "from_".basKeyid::kidRand();
		$to = "to_".basKeyid::kidRand();
		$data = "<xml><ToUserName>$to</ToUserName><FromUserName>$from</FromUserName></xml>";
		$post = simplexml_load_string($data, 'SimpleXMLElement', LIBXML_NOCDATA);
		return $post;
	}

	// 组测试signature
	static function getSignurl($wecfg=array(), $apiurl=''){
        $timestamp = time();
        $nonce = mt_rand(100001,2147483123);
		$tmpArr = array($wecfg['token'], $timestamp, $nonce);
		sort($tmpArr, SORT_STRING); // use SORT_STRING rule
		$tmpStr = implode( $tmpArr );
		$tmpStr = sha1( $tmpStr );
		$signature = $tmpStr;
		$echostr = basKeyid::kidRand(32);
		$url = $apiurl ? $apiurl : "{root}/plus/api/wechat.php";
		if(!strpos($url,'?')) $url .= '?';
		$url .= "&signature=$signature&timestamp=$timestamp&nonce=$nonce&echostr=$echostr";
		$url = wysBasic::fmtUrl($url);
		//$url = str_replace($from, $to, $url);
		return $url;
	}
	
}




/*******************************************************************************
 File : \code\adpt\wechat\wysUser.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 用户相关操作
// 如果本系统修改,就改这个文件，不用改wmp*文件

class wysUser extends wmpUser{

	public $_db = NULL;

	function __construct($cfg=array()){
		parent::__construct($cfg);
		$this->_db = glbDBObj::dbObj();
	}
	
	//得到一个可用的本系统用户名
    static function fmtUserName($user=''){  
		if(is_array($user) && !empty($user['nickname'])){
			$username = $user['nickname'];
		}elseif(is_object($user) && !empty($user->nickname)){
			$username = $user->nickname;
		}else{
			$username = basKeyid::kidRand('24',8);
		}
		$username = basStr::filKey(comConvert::pinyinMain($username));
		if(strlen($username)>15) $username = substr($username,0,15);
		while(self::fmtUserCheck($username)){
			$username = substr($username,0,9).'_'.basKeyid::kidRand('24',3);
		}
		return $username;
	}
    static function fmtUserCheck($username=''){ 
		$db = glbDBObj::dbObj();
		$row = $db->table('users_uacc')->where("uname='$username'")->find();
		return empty($row) ? 0 : 1;
	}

	// 设置录登录状态
    static function setLoginLogger($openid=''){ 
		$db = glbDBObj::dbObj();
		$row = $db->table('users_uppt')->where("pptmod='weixin' AND pptuid='$openid'")->find();
		if($row){ //cls_message::show(" .... 完善跳转 ... 绑定了直接登录");	
			usrBase::setLogin('m',$row['uname']);
		}
		return $row['uname'];
		//未绑定,进入模版
	}
	// 设置扫描登录完成
    static function setScanLogin($scene,$openid='',$username=0){ 
		$db = glbDBObj::dbObj();
		self::setLoginLogger($openid); //,'sflag'=>$username
		$db->table("wex_qrcode")->data(array('stat'=>'LoginOK','openid'=>"$openid"))->where("sid='$scene'")->update();
	}
	
	// 添加用户
    static function addUser($openid,$uname,$password,$nick='',$umod='person'){ 
		$rins = usrMember::addUser($umod,$uname,$password,$nick); //,$mtel='',$memail=''
		if(isset($rins['uid'])){ 
			usrMember::bindUser($uname,'weixin',$openid);
			$uid = $rins['uid'];
			$autocheck = $rins['check'];
			$msg = "会员注册成功，请重新注册。";
		}else{
			$uid = 0;
			$autocheck = 0;
			$msg = "会员注册失败，请重新注册。";	
		}
		return array('uid'=>$uid, 'uname'=>$uname, 'password'=>$password,'autocheck'=>$autocheck, 'msg'=>$msg);
	}
	
	//绑定用户
    static function bindUser($openid,$uname,$password){  
		if(empty($uname)) die('错误:'.__FUNCTION__); //原则上没有这个情况
		$db = glbDBObj::dbObj();
		$ubase = $db->table('users_uacc')->where("uname='$uname'")->find();
		$umod = $ubase['umods']; $dbpass = $ubase['upass'];
		$upass = comConvert::sysPass($uname,$password,$umod);
		if($dbpass!=$upass){  
		   $uid = 0;
		   $msg = '密码错误'; //cls_message::show('密码错误',axaction(1,M_REFERER));
		   $res = 0;
		}else{
			usrMember::bindUser($uname,'weixin',$openid);
			$uid = $ubase['uid'];
			$msg = '绑定成功';
			$res = 1;
			usrBase::setLogin('m',$uname);
		}
		return array('uid'=>$uid, 'res'=>$res, 'msg'=>$msg);
	}
	
	// 扫描过来 : setPwd
    static function resetPwd($openid,$scene,$uname){ 
		if(empty($openid)) die('错误:'.__FUNCTION__); //原则上没有这个情况
		$db = glbDBObj::dbObj();
		$uppt = $db->table('users_uppt')->where("pptmod='weixin' AND pptuid='$openid'")->find();
		if(empty($uppt)) return "重置失败，未绑定帐号(a)！";
		$ubase = $db->table('users_uacc')->where("uname='{$uppt['uname']}'")->find();
		if(empty($ubase)) return "重置失败，未绑定帐号(b)！";
		$password = basKeyid::kidRand('24',8);
		$upass = comConvert::sysPass($uname,$password,$ubase['umods']);
		$db->table('users_uacc')->data(array('upass'=>$password))->where("uname='{$uppt['uname']}'")->update();
		$db->table('wex_qrcode')->data(array('atime'=>0))->where("sid='{$scene}'")->update();
		$msg = "您的登录帐号为：{$uname}。<br>";
		$msg .= "您的密码重置为：{$password}。";
		return $msg;
	}

}



/*******************************************************************************
 File : \code\adpt\weuser\wexControl.php 
*******************************************************************************/
<?php
/**
 * Class wexControl
 */

class wexControl{

	private $error = 0;
	private $kid = '';
	private $cfg = array();
	private $ignoreEvents = array(
		'qualification_verify_success', 'qualification_verify_fail', 'naming_verify_success',
		'naming_verify_fail', 'annual_renew', 'verify_expired', // 微信认证事件推送, 
	); //忽略事件

	function __construct(){
		
		#die(basReq::val('echostr',''));

		$actys = basReq::val('actys',''); 
		$this->kid = basReq::val('kid','admin');
		$this->cfg = wysBasic::getConfig($this->kid); 
		
		if($echostr=basReq::val('echostr','')){
			$this->checkSign($echostr);
		}
		
		$data = file_get_contents('php://input'); //@$GLOBALS["HTTP_RAW_POST_DATA"]; 
		if(!empty($data)){ 
			$this->replyPost($data); 
		} 
		
		if(!empty($actys)){ //getUinfo,getQrcode,chkLogin,chkUpload
			$data = $this->$actys();
			die($data);
		}
		
		$this->error("Error: q=[{$_SERVER['QUERY_STRING']}], data=[$data]", $data); 
		
	}
    
	// 处理post
    function replyPost($data){
		define('RUN_WECHAT','1');
		$post = simplexml_load_string($data, 'SimpleXMLElement', LIBXML_NOCDATA);
		//print_r($post);
		if(empty($post->MsgType)){ 
			$this->error("Error Code/Null MsgType"); 
		}else{
			if($post->MsgType=='event'){ //接收事件推送
				//忽略事件
				if(!empty($post->CardId)){ //卡券事件推送(<CardId>)
					$class = 'Card';
				}elseif(!empty($post->PoiId)){ //(门店)审核事件推送(<PoiId>)
					$class = 'Store';
				}elseif(!empty($post->OrderId)){ //订单付款通知(<OrderId>), 
					$class = 'Order';
				}elseif(in_array($post->Event,$this->ignoreEvents)){ //忽略事件
					$this->ignore();
				}else{
					$class = 'Event'; 
				}
			}else{ //接收一般信息,作相关响应,如关键字回复
				$class = 'Reply';
			} 
			//$this->error("Error Class: [$class]", $post);
			$clsex = 'wex'.$class.ucfirst(strtolower($this->kid));
			$class = 'wys'.$class;
			$class = class_exists($clsex) ? $clsex : (class_exists($class) ? $class : ''); //echo $class;
			if($class){ 
				new $class($post, $this->cfg);
			}else{
				$this->error("Error Class: [$class]");
			}
		}
	}
	
	function checkSign($echoStr){
		if(wmpBasic::checkSignature($this->cfg)){
			die($echoStr);	
		}else{
			$error = 'Error: checkSignature';
		}
	}
	
	function ignore(){
		//save;	
		die('');
	}
	
	function error($msg, $post){
		wysBasic::debugError($msg, $post);	
	}

	//微信扫描二维码登录
	function chkLogin(){
		global $_cbase;
		$uniqueid = usrPerm::getUniqueid();
		$db = glbDBObj::dbObj(); 
		$scene = basReq::val('scene',''); 
		$extp = basReq::val('extp',''); 
		$stampys = basReq::val('stampys',''); 
		$signys = basReq::val('signys',''); 
		$signenc = md5($_cbase['safe']['api'].$stampys.$extp); 
		if(empty($extp) || (($_cbase['run']['stamp']-$stampys)>5*60) || $signenc!=$signys){
			$res['error'] = '登录失败';
			$res['message'] = "超时或认证失败，请重新扫描。"; 
			$re = "var data = ".comParse::jsonEncode($res).""; 
			return $re;
		}
		$whrstr = "sid='$scene' AND stat='LoginOK' AND extp='$extp' AND auser='$uniqueid' AND smod='login'"; //安全吗？!!! 
		$row = $db->table('wex_qrcode')->where("$whrstr AND atime>'".($_cbase['run']['stamp']-5*60)."'")->find();
		if(!empty($row['openid'])){ //!empty($row['extp']) && 
			$uname = wysUser::setLoginLogger($row['openid']);
			$this->status['error'] = '';
			$this->status['message'] = "登录成功。";
			$this->status['uname'] = $uname;
			$db->table('wex_qrcode')->data(array('atime'=>'0'))->where("sid='$scene'")->update(); 
		}else{
			$this->status['error'] = '登录失败';
			$this->status['message'] = "未扫描确认。";	
		}
		$re = "var data = ".comParse::jsonEncode($this->status)."";
		return $re;
	}

	//检查传图
	function chkUpload(){
		global $_cbase;
		$uniqueid = usrPerm::getUniqueid();
		$db = glbDBObj::dbObj(); 
		$scene = basReq::val('scene',''); 
		$extp = basReq::val('extp',''); 
		$stampys = basReq::val('stampys',''); 
		$signys = basReq::val('signys',''); 
		$signenc = md5($_cbase['safe']['api'].$stampys.$extp); 
		if(empty($extp) || (($_cbase['run']['stamp']-$stampys)>60*60) || $signenc!=$signys){
			$res['error'] = 'errorCheck';
			$res['message'] = "超时或认证失败，请重新扫描。";	
			$re = "var data = ".comParse::jsonEncode($res).""; 
			return $re;
		}
		$whrstr = "sid='$scene' AND extp='$extp' AND auser='$uniqueid' AND smod='upload'"; //安全吗？!!! 
		$row = $db->table('wex_qrcode')->where("$whrstr AND atime>'".($_cbase['run']['stamp']-5*60)."'")->find();
		if(!empty($row['openid'])){
			$list = $db->table('wex_msgget')->where("openid='{$row['openid']}' AND `type`='image' AND atime>'".($_cbase['run']['stamp']-5*60)."'")->select(); 
			if($list){ foreach($list as $r){
				$res['res'][] = $r;
			}	}
			$res['message'] = "近5分钟传的图…";
			$res['error'] = '';
		}else{
			$res['error'] = "noScan";	
			$res['message'] = "还未扫描。";	
		}
		$res = "var data = ".comParse::jsonEncode($res)."";
		return $res;
	}
	
    function loadFile(){ 
		$mediaid = basReq::val('mediaid','',255);
		$wmat = new wmpMaterial($this->cfg);
		$data = $wmat->loadMedia($mediaid);
		if(strstr($data,'"errmsg"')){
			$data = json_decode($data,1);
			die("[{$data['errcode']}]{$data['errmsg']}");
		}else{
			//comFiles::put('./aaa.jpg.txt',$data);
			header("Content-type:image/jpeg");
			die($data);	
		}
	}
	
    function getQrcode(){ //注意:用总站的wecfg
		global $_cbase;
		$qrmod = basReq::val('qrmod','login'); 
		#$this->chkQropen($qrmod);
		$extp = basReq::val('extp',''); 
		//if(strlen($extp)<6){  }
		$wxqr = new wysQrcode($this->cfg); 
		$qrcode = $wxqr->getQrcode($qrmod, 'limit', $extp); 
		$qrcode['stampys'] = $_cbase['run']['stamp']; //注意:用总站的wecfg
		$qrcode['signys'] = md5($_cbase['safe']['api'].$qrcode['stampys'].$extp); 
		$re = "var data = ".json_encode($qrcode)."";
		return $re;
	}
	
    function getUinfo(){
		//权限?!
		#if($re0==3) die("没有权限"); 
		$ustr = basReq::val('ustr','',2048); 
		$weixin = new wmpUser($this->cfg);
		$data = $weixin->getUserBatch($ustr,1);
		$re = "var data = $data;";
		return $re;
	}
	
    function kidExists(){
		$db = glbDBObj::dbObj();
		$kid = basReq::ark('fm','kid','Key'); 
		$oldval = basReq::val('oldval'); 
		if(strlen($kid)<3){
			echo "[kid]错误！";
		}elseif($kid===$oldval){
			die("success");
		}elseif($flag=$db->table('wex_apps')->where("kid='$kid'")->find()){
			echo "[$kid]已被占用！";
		}else{
			die("success");
		}
    }
    function appidExists(){
		$db = glbDBObj::dbObj();
		$appid = basReq::ark('fm','appid','Key');
		$oldval = basReq::val('oldval'); 
		if(strlen($appid)<6){
			echo "[appid]错误！";
		}elseif($appid===$oldval){
			die("success");
		}elseif($flag=$db->table('wex_apps')->where("appid='$appid'")->find()){
			echo "[$appid]已被占用！";
		}else{
			die("success");
		}
    }
	
}



/*******************************************************************************
 File : \code\adpt\weuser\wexEventAdmin.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 事件响应操作

class wexEventAdmin extends wysEvent{

	//public $haibaoMediaid = 'I7mPnzk9v0tF6nHiEmy0sDbtRksBp4pVHSYBZvdROjc';
	//public $haibaoPicurl = 'http://yscode.txjia.com/uimgs/logo/haibao.jpg';

	function __construct($post,$wecfg){ 
		parent::__construct($post,$wecfg); 
	}

	function scanLogin(){
		$msg = $this->scanLoginBase();
		die($this->remText($msg));
	}
	function scanLoginBase(){
		$msg = $this->subScanmsg;
		$qrInfo = $this->getQrinfo($this->eventKey);
		$row = $this->_db->table('users_uppt')->where("pptuid='{$this->fromName}' AND pptmod='weixin'")->find();
		//用授权链接..., 安全...
		$wxmenu = new wysMenu($this->cfg);
		if(!$row){  
			$msg .= "您未用微信扫描登录过本站账户:";
			$mname = '';
			$url = $this->oauthUrl($mname,'binding');
			$msg .= "\n<a href='$url'>点击绑定或添加账户</a>。";
		}else{
			$msg .= "欢迎使用微信扫描登录:";
			$mname = $row['uname'];
			$url = $this->oauthUrl($mname,'dologin');
			$msg .= "\n<a href='$url'>点击确认登录</a>。";
		} 

		return $msg;
	}
	
	function scanGetpw(){
		$msg = $this->scanGetpwBase();
		die($this->remText($msg));
	}
	// 点击找回密码(用于电脑端,客户端不需要密码登录)
	function scanGetpwBase(){ 
		//直接发微信信息...
		$msg = $this->subScanmsg;
		$row = $this->_db->table('users_uppt')->where("pptuid='{$this->fromName}' AND pptmod='weixin'")->find();
		if(!$row){  
		   $msg .= "您未用微信扫描登录过本站账户:\n 1. 请点[微信登录]相关链接绑定或注册帐号！\n 2. 在微信菜单中点相关链接绑定或注册帐号！";
		}else{
			$msg .= "欢迎使用微信扫描找回密码:";
			$mname = $row['uname'];
			$url = $this->oauthUrl($mname,'dogetpw'); 
			$msg .= "\n<a href='$url'>点击重置密码</a>。";
		}
		return $msg;
	}
	// 登录绑定:mbind
	function scanMbind(){
		$msg = $this->scanMbindBase();
		die($this->remText($msg));
	}
	// 登录绑定:mbind
	function scanMbindBase(){ 
		//直接发微信信息...
		$msg = $this->subScanmsg;
		$row = $this->_db->table('users_uppt')->where("pptuid='{$this->fromName}' AND pptmod='weixin'")->find();
		//dump($this->qrInfo);
		$mname = comConvert::sysRevert($this->qrInfo['extp'], 1, '', 600);
		if(!$row){  
			$url = $this->oauthUrl($mname,'mbindDone'); 
		   	$msg .= "欢迎绑定微信:\n 请点[<a href='$url'>现在绑定</a>]确认！";
		}else{
		   	$mold = $row['uname'];
			$url = $this->oauthUrl($mname,'mbindChange');
		   	$msg .= "您的微信以前已经绑定: [{$mold}] \n 现在可 [<a href='$url'>更换绑定</a>] ";
			$url = $this->oauthUrl($mname,'mbindExit');  
		   	$msg .= " 或 [<a href='$url'>解除绑定</a>] ！";
		}
		return $msg;
	}
	function scanUploadBase($re=0){
		$msg = "您已开启微信传图模式，点击左下的小键盘图标，发送你需要上传的图片吧。";
		if($re) return $msg;
		die($this->remText($msg));
	}
	function scanSend(){
		$msg = $this->scanSendBase();
		die($this->remText($msg));
		//die("dd");	
	}
	function scanSendBase(){
		$qrInfo = $this->getQrinfo($this->eventKey);
		if(strpos($qrInfo['extp'],',')){
			$qrInfo['extp'] = explode(',',$qrInfo['extp']);
			$qrInfo['extp'] = $qrInfo['extp'][0];
		}
		$this->sendCfgs = explode('.',$qrInfo['extp']);
		$this->getSendInfo($this->sendCfgs[0], @$this->sendCfgs[1]);
		if($this->sendCfgs[0]=='cargo'){
			$fields = array('title'=>'商品','brand'=>'品牌','xinghao'=>'型号','guige'=>'规格','price'=>'价格');
			$plink = 'mob';
		}elseif(in_array($this->sendCfgs[0],array('company','govern','organize'))){ 
			$fields = array(
				'company'=>'商家','ftype'=>'行业','mname'=>'联系人','mtitle'=>'称呼','mtel'=>'联系电话',
				'memail'=>'邮件','maddr'=>'地址','mweb'=>'网址'
			);
			$plink = 'chn';
		}
		$msg = $this->getSendText($this->sendCfgs[0].'.'.@$this->sendCfgs[1],$fields,$plink);
		return $msg;
		/*
		# 商家[company]资料
		行业 ftype 
		联系人 mname （称呼mtitle）
		联系电话 mtel
		邮件 memail
		地址 maddr
		网址 mweb
		详情：>>> 
		# 商品[title]信息:
		品牌 brand
		型号 xinghao
		规格 guige
		价格 price
		详情：>>> 
		*/
	}
	
	// 点击自定义菜单:Mylocal
	function clickMylocal(){
		$pinfo = $this->savePos(0);
		if(empty($pinfo)){
			$msg = "未能检测到您的地理位置信息；请重新关注,提示【是否允许公众号使用其地理位置】时选【是】即可使用本功能。";
		}else{
			$url = "{root}/mob.php?mkv=user-wxlocal";
			$wem = new wysMenu($this->cfg);
			$url = $wem->fmtUrl($url);
			$msg = "您的位置信息是：\n[{$pinfo['longitude']},{$pinfo['latitude']}]！\n";
			$msg .= " 您可以使用以下服务：\n";
			$msg .= " <a href='$url&map={$pinfo['latitude']},{$pinfo['longitude']}&type=company'>企业会员</a>；\n";
			$msg .= " <a href='$url&map={$pinfo['latitude']},{$pinfo['longitude']}&type=govern'>政府机构</a>；\n";
			$msg .= " <a href='$url&map={$pinfo['latitude']},{$pinfo['longitude']}&type=organize'>非盈利组织</a>；\n";
		}
		die($this->remText($msg));
	}
	
	// 点击自定义菜单:Txworks
	function clickTxworks(){
		$news = array( //较好的效果为大图360*200，小图200*200,  小语交互,微简历,微名片
			array('title'=>'学无止境','desc'=>'英语学习，国学教育，数字数学','url'=>'{svrtxcode}/learn/index.htm?','picurl'=>'{svrtxcode}/uimgs/zohe/pi.gif',),
			array('title'=>'[国学]《弟子规》拼音版','desc'=>'','url'=>'{svrtxcode}/learn/cn-dizigui.htm?','picurl'=>'',),
			array('title'=>'[英语]迪斯尼神奇英语','desc'=>'','url'=>'{svrtxcode}/learn/disney.htm?','picurl'=>'',),
			array('title'=>'[数字数学]算24游戏','desc'=>'','url'=>'{svrtxcode}/learn/ms-suan24.htm?','picurl'=>'',),
			//array('title'=>'','desc'=>'','url'=>'?','picurl'=>'',),
			array('title'=>'[智力]称鸡蛋','desc'=>'','url'=>'{svrtxcode}/about/egg.htm?','picurl'=>'{svrtxcode}/uimgs/logo/gezi1-40x.jpg',),
			array('title'=>'[健康保健]保护视力-眼保健操','desc'=>'','url'=>'{svrtxcode}/health/cmshili.htm?','picurl'=>'',),
			array('title'=>'[健康保健]食物相克查询','desc'=>'','url'=>'{svrtxcode}/health/cmxke.htm?','picurl'=>'',),
			array('title'=>'[应用]全国城市-天气预报','desc'=>'','url'=>'{svrtxcode}/about/tianqi.htm?','picurl'=>'{svrtxcode}/uimgs/logo/gezi-fly.gif',),
		); 
		die($this->remNews($news));
	}
	
	// 点击自定义菜单:Cnarea
	function clickCnarea(){
		$arr = glbConfig::read('china');
		$str = "回复下面括号里的两个字母获取详细信息：\n";
		foreach($arr['i'] as $k=>$v){
			if(empty($v['pid'])){
				$key = substr($k,2);
				$str .= "[$key]".$v['title']."\n";
			}
		}
		die($this->remText($str));
	}

	// 点击自定义菜单:Haibao
	function clickHaibao(){
		$hb = cfg('weixin.haibaoMediaid');
		die($this->remImage($hb));
	}
	
	# (文档/会员)的信息(仅数据)
	function getSendInfo($mod,$kid){ 
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$pid = @$_groups[$mod]['pid'];
		$fid = substr($pid,0,1).'id';
		$data = $dext = array();
		if(in_array($pid,array('docs','users'))){
			$tabid = glbDBExt::getTable($mod);
			$data = $db->table($tabid)->where("$fid='$kid'")->find();
		}
		if(in_array($pid,array('docs'))){
			$tabid = glbDBExt::getTable($mod,1);
			$dext = $db->table($tabid)->where("$fid='$kid'")->find();
			$dext && $data += $dext; 
		} //print_r($data);
		$this->sendInfo = $data;
	}
	function getSendText($key,$fields,$tplink=''){ 
		$i = 0; $s = '';
		$_groups = glbConfig::read('groups');
		foreach($fields as $k=>$v){
			$val = $this->sendInfo[$k];
			if(isset($_groups[$k]) && $_groups[$k]['pid']=='types'){
				$vmcfg = glbConfig::read($k); 
				$vname = comTypes::getLnks(comTypes::getLays($vmcfg['i'],$val),'[v]');
				$val = empty($vname) ? $val : $vname;
			}
			if($i==0){
				$s .= "$v [$val] 资料\n"; 
			}else{
				$s .= "$v: $val\n"; 	
			}
			$i++;
		} //print_r($this->sendInfo);
		if(strpos($tplink,'{kid}')){
			$link = str_replace(array('{kid}'),$key,wysBasic::fmtUrl($tplink));
		}elseif($tplink){
			$link = wysBasic::fmtUrl(vopUrl::fout("$tplink:$key"));
		}
		$s .= "\n<a href='$link'>详情：>> </a>\n";
		return $s;
	}
	// $url : url / uname
	function oauthUrl($url, $state, $cope='snsapi_base'){ 
		if(!strpos($url,'.php')){
			$mname = $url;
			$url = "{root}/mob.php?mkv=user-wxlogin&scene={$this->eventKey}&mname=$mname&sflag={$this->sflag}";
		}
		$wem = new wysMenu($this->cfg);
		return $wem->fmtUrl("oauth:$cope:$state:$url");
	}

}

/*

*/




/*******************************************************************************
 File : \code\adpt\weuser\wexEventPeace.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 事件响应操作

class wexEventPeace extends wexEventAdmin{

	function construct($post,$wecfg){ 
		parent::__construct($post,$wecfg); 
	}

}



/*******************************************************************************
 File : \code\adpt\weuser\wexEventPeays.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 事件响应操作

class wexEventPeays extends wexEventAdmin{

	function construct($post,$wecfg){ 
		parent::__construct($post,$wecfg); 
	}

}



/*******************************************************************************
 File : \code\adpt\weuser\wexReplyAdmin.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 消息回复（被动回复）

class wexReplyAdmin extends wysReply{
	
	public $_db = NULL;
	
	function __construct($post,$cfg,$re=0){ 
		parent::__construct($post,$cfg); 
	}
	
	// 文本消息
    function reText(){  
		$detail = $this->post->Content; 
		if(strlen($detail)==2){ // && basStr::isKey($detail,2)
			$detail = "cn$detail";
			$arr = glbConfig::read('china'); 
			if(isset($arr['i']["$detail"])){
				$str = '';
				foreach($arr['i'] as $k=>$v){
					if($k==$detail){
						$str .= "[$k]".$v['title']." (".$v['cfgs'].") 详情如下：";	
					} //
					$link1 = $link2 = '';
					if($v['pid']==$detail){
						$map = explode('map=',str_replace(array("\r","\n"),array('',''),$v['cfgs']));
						if(!empty($map[1]) && count(explode(',',$map[1]))==2){
							$mpoint = explode(',',$map[1]);
						}else{
							$mpoint = array();
						} 
						$link1 = "<a href='http://m.baidu.com/s?word={$v['title']}'>[$k]{$v['title']}</a>";
						//$link2 = empty($mpoint) ? "" : "<a href='".(wysBasic::fmtUrl('{root}/run/mob.php'))."mkv=user-wxlocal&map={$mpoint[1]},{$mpoint[0]}'>地图</a>";
						$link2 = empty($mpoint) ? "" : "\n坐标：$map[1]";
						$str .= "\n{$link1} {$link2}"; 
					}
				} //echo strlen($str);
				die($this->remText($str));
			}
		}
		$this->reTextBase();
    }
	
}



/*******************************************************************************
 File : \code\adpt\weuser\wexReplyPeace.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 消息回复（被动回复）

class wexReplyPeace extends wexReplyAdmin{
	
	public $_db = NULL;
	
	function __construct($post,$cfg,$re=0){ 
		parent::__construct($post,$cfg); 
	}
	
}



/*******************************************************************************
 File : \code\adpt\weuser\wexReplyPeays.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 消息回复（被动回复）

class wexReplyPeays extends wexReplyAdmin{
	
	public $_db = NULL;
	
	function __construct($post,$cfg,$re=0){ 
		parent::__construct($post,$cfg); 
	}
	
}



/*******************************************************************************
 File : \code\adpt\weuser\wexReplyTest1.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 消息回复（被动回复）

class wexReplyTest1 extends wysReply{
	
	public $_db = NULL;
	
	function __construct($post,$cfg,$re=0){ 
		parent::__construct($post,$cfg); 
	}
	
}



/*******************************************************************************
 File : \code\cfgs\boot\bootskip.php 
*******************************************************************************/
<?php
/* Demo: 
  $_cbase['skip']['_all_'] = true;
  require(dirname(__FILE__).'/run/_paths.php'); 
  // $_cbase['skip']['robot'] = true; //单独用
  // $_cbase['skip']['db'] = true; //单独用
  // $_cbase['skip']['uchr7'] = true; //单独用
  // $_cbase['handler']['shutdown'] = true; //单独用 
  // Access-Control-Allow-Origin ??
  // X-Frame-Options ??
*/

// _all_方案:所有
if(isset($_cbase['skip']['_all_'])){
	$_cbase['skip']['error'] = true;
	$_cbase['skip']['session'] = true;
}

// _session_方案:除[session]所有
if(isset($_cbase['skip']['_sess_'])){
	$_cbase['skip']['error'] = true;
	//$_cbase['skip']['session'] = true;
}



/*******************************************************************************
 File : \code\cfgs\boot\bootstart.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$_pbase = empty($_cbase) ? array() : $_cbase; //把前置_cbase备份
//$_cbase = array(); run.outer, skip.*, tpl.tpl_dir, 

// 运行时常用变量,越是最先运行越准确
$_cbase['run']['timer']  = microtime(1); 
$_cbase['run']['memory'] = memory_get_usage(); 
$_cbase['run']['aclass'] = array(); //

// 加载系统函数,配置
require(DIR_CODE.'/core/blib/system.php'); 
require(DIR_CODE.'/cfgs/boot/const.cfg.php'); //基本设置const: 可被后台设置,页面设置覆盖
require(DIR_DTMP.'/dset/_score.cfg.php'); //后台设置_score: 其次,可被页面设置覆盖
//以下会处理[页面设置_pbase];         //页面设置_pbase: 最优先

// 加载启动文件
if(empty($_cbase['run']['outer'])){ 
	// 加载autoload
	autoLoad_ys::init();
	// run常规处理
	basEnv::runPbase($_pbase); unset($_pbase); //处理_pbase 
	basEnv::runVersion(); // 系统信息,魔术变量,时区
	basEnv::runConst(); // const,
	basEnv::runCbase(); // 前置处理,运行时常用变量
	basEnv::runSkips(); // 处理skips
	safComm::urlQstr7(); // QUERY-7参数检测 
	basLang::auto(); // Lang
	// run扩展
}

/// 其它处理参考 ///////////////////////////////////

// forTest
#echo "runInfo:"; print_r(basDebug::runInfo()); 




/*******************************************************************************
 File : \code\cfgs\boot\cfg_adbug.php 
*******************************************************************************/
<?php

$out_user = 'utools'; // 如果有_config.php，则使用_config.php中的设置；
$out_pass = 'upass'; // 请每次使用,都改个新密码；否则安全问题,请后果自负！
$can_upfile = '1'; //是否可上传文件,移除BOM,扫描站点外目录
$can_reset = '1'; //是否可reset 

/*
*/


/*******************************************************************************
 File : \code\cfgs\boot\cfg_db.php 
*******************************************************************************/
<?php

// 数据库 - 基本配置

$_cfgs['db_class']   = 'mysqli'; // 数据库类(class),mysqli(推荐),pdox(用于PDO扩展),mysql(PHP5.5+不能使用)
$_cfgs['db_host']    = 'localhost'; // 数据库主机(pdox连接不使用)
$_cfgs['db_name']    = 'txmao_main'; // 数据库名(pdox连接不使用) 
$_cfgs['db_port']    = '3306'; // 数据库端口，mysql默认是3306，一般不需要修改
$_cfgs['db_user']    = 'root'; // 数据库用户名
$_cfgs['db_pass']    = ''; // 数据库密码	

// 数据库 - 高级配置
#$_cfgs['db_dsn']  = 'mysql:host=localhost;dbname=peace_v30'; //pdox连接access使用
$_cfgs['db_type']   = 'mysql'; // 数据库类型,mysql; 目前只支持此类型数据库 
$_cfgs['db_conn']   = false; // true表示使用永久连接，false表示不适用永久连接，一般不使用永久连接
$_cfgs['db_prefix'] = ''; // 数据库前缀pre_
$_cfgs['db_suffix'] = '_ys'; // 数据库前缀_suf
$_cfgs['db_cset']   = 'utf8';// 数据库编码

// 数据库缓存
$_cfgs['dc_on']      = 0; //
$_cfgs['dc_type']    = ''; // cacheMemd,cacheMemc,cacheSaem
$_cfgs['dc_prefix']  = 'rfoDIa3f'; 
$_cfgs['dc_server']  = '127.0.0.1';
$_cfgs['dc_port']    = '11211';
$_cfgs['dc_pconn']   = '1';
$_cfgs['dc_tmout']   = '600';
$_cfgs['dc_size']    = '15'; //M

/*
$_cfgs['db_name'] = 'xpeace_v304'; // 数据库名(pdox连接不使用) peace_v30,test_v30
$_cfgs['db_prefix'] = 'pre_'; // 数据库前缀pre_
$_cfgs['db_suffix'] = '_suf'; // 数据库前缀_suf
//*/



/*******************************************************************************
 File : \code\cfgs\boot\cfg_load.php 
*******************************************************************************/
<?php
//类的自动加载规范(路径)

//* 核心类库(前缀及目录对照表)
$_cfgs['acdir'] =  array(
	'core/blib' => 'bas',//基本类库
	'core/clib' => 'com',//常规类库
	'core/elib' => 'ext',//扩展类库,安全检测
	'core/glib' => 'adm,fld,glb,saf',//全局专项类库:管理函数,字段处理,全局公用,安全检测
	'core/vops' => 'tag,vop',//标签类库,显示类库
	'core/dops' => 'dop,usr',//数据操作类库,用户权限类库
	'core/sdev' => 'dev,exd,upd',//二次开发,数据扩展,更新相关
	'core/uext' => 'exa,exm,exv',//后台扩展,会员扩展,前台扩展
	'adpt/wechat' => 'wmp,wys',//微信类库
	'adpt/weuser' => 'wex',//微信扩展
	#'libu/libx1' => 'ex1',//自定义路径和前缀
	#'libu/dirx2' => 'ex2,dir',//自定义路径和前缀
	#'libu/catu3' => 'eu3,cat',//自定义路径和前缀
);//*/

// 符合上述配置的类文件（不使用命名空间(php5.2无)），放在code/下相关目录
// 上述配置未找到类文件的，会按以下第三方目录的规范去找类文件

//2. 第三方-pr4规范
$_cfgs['acpr4'] =  array(
	'Vdemo' => array('/Vdemo'), //vendor加载演示
	//'Monolog' => array('/Monolog'), 
	//'Symfony' => array('/Symfony'),
);

//3. 第三方-namespace规范
$_cfgs['acnsp'] =  array(
	//'Buzz' => array('/ksbuzz/lib'),
    //'Psr\\Log' => array('/psrlog'),
    //'Silex' => array('/silex/silex/src'),
);

//4. 自定义-classmap规范
$_cfgs['acmap'] =  array(
    //'basArray' => '~/core/blib/basArray.php',
    //'mTest1' => '/Vdemo/dir1/mapTest1.php',
    'Pimple' => '/pimple/lib/Pimple.php',
    //'dir\\Name' => '/dir/Name.php',
);

/*

*/




/*******************************************************************************
 File : \code\cfgs\boot\const.cfg.php 
*******************************************************************************/
<?php
// 常用参数
//$_cbase['run']['isDemo'] = 0; //演示站，不能提交数据
$_cbase['run']['defPort'] = 1; //默认端口，不带端口
$_cbase['run']['subDirs'] = array(
	'www.txjia.com' => 'txjia.com', //不要www.域名跳转
	'tiexinmao.duapp.com' => 'txmao.txjia.com', //跳转到主域名
	#'127.0.0.1' => '127.0.0.1', //测试
); //dir-跳转

/// 参数配置-根据需要配置 //////////////////////////////////////////////////////////////////////////////// 

// 系统参数
$_cbase['sys']['sn']      = '0BAB703D-127A-B479-1979-2010-0424X888'; //序列号
$_cbase['sys']['ver']     = '3.4'; // 版本号
$_cbase['sys']['cset']    = 'utf-8';// 系统编码
$_cbase['sys']['tmzone']  = '8'; //
$_cbase['sys']['tzcode']  = 'PRC'; // 时区+-12, 'ETC/GMT-8'
$_cbase['sys']['lang']    = 'en'; // 默认语言:根据语言包,可设置en,cn等

// Cookie
$_cbase['ck']['pre']      = '00v30_'; // Cookie前缀,8字符以内
$_cbase['ck']['domain']   = ''; // Cookie Domain
$_cbase['ck']['path']     = '/'; // Cookie Path

//调试日志配置
$_cbase['debug']['err_mode']  = '0'; //后台设置,是否开启调试模式，1,0(run=0)
$_cbase['debug']['err_save']  = 'file'; //记录方式: file, db, 
$_cbase['debug']['err_path']  = ''; //出错信息存放的目录，出错信息以天为单位存放，一般不需要修改 /erlog  
$_cbase['debug']['err_file']  = 'Y-md'; //文件格式: Y-md:1979-0913, Y-m-d: 1979-09-13
$_cbase['debug']['err_hand']  = true; //是否启动CP内置的错误处理，如果开启了xdebug，建议设置为false 
$_cbase['debug']['err_hkey']  = '(def)'; //E_ALL^E_WARNING^E_NOTICE;

$_cbase['debug']['log_save']  = ''; //记录方式: 空:不记录, Y-mdH, Y-md-H, db, 
$_cbase['debug']['pay_log'] = 1; //支付记录-调试标记

$_cbase['debug']['db_sql']  = ''; //记录方式: 空:不记录, Y-mdH, Y-md-H, db, 
$_cbase['debug']['db_acts'] = ',select,qSelect,find,'; //,delete,update,replace,insert,count,fields,tables,qOther,
$_cbase['debug']['db_area'] = array('RUN_FRONT','RUN_MOB',); //,'RUN_ADMIN','RUN_UMC','RUN_AJAX','RUN_DBSQL','RUN_DEV'
$_cbase['debug']['db_time'] = '100'; //0,10,100

//模板配置 
$_cbase['tpl']['tpl_ext'] = '.tpl.htm'; //模板后缀，建议为：[.tpl.htm]
$_cbase['tpl']['tpc_on']  = 0; //是否开启模板缓存，true开启,false不开启 
$_cbase['tpl']['tpc_ext'] = '.cac_php'; //模板缓存后缀,一般不需要修改 
$_cbase['tpl']['no_static'] = '(adm)'; //,umc
$_cbase['tpl']['def_static'] = 'chn';

// server
$_cbase['server']['txmao']  = 'http://txmao.txjia.com'; //txmao首页{svrtxmao}
$_cbase['server']['txcode'] = 'http://yscode.txjia.com'; //txcode首页{svrtxcode}
$_cbase['server']['txjia']  = 'http://txjia.com'; //txjia首页{svrtxjia}

//用户自定义配置
$_cbase['ucfg']['vimg']  = 'K'; // 0,H,K
$_cbase['ucfg']['ipapi'] = 'ip138'; // 默认IP地址接口, sina,taobao,pcoln,s1616
#$_cbase['ucfg']['czip']  = '0'; // zlib,gzip,0(不用了)
$_cbase['ucfg']['guid'] = 'Cook'; // UIP,Sess,Cook
$_cbase['ucfg']['city'] = '东莞'; //本地城市,订单算运费用
$_cbase['ucfg']['space'] = 30; //M空间大小
$_cbase['ucfg']['dbind'] = 0; //是否开启绑定子域名
$_cbase['ucfg']['ctab'] = 'F00,F0F,060,00F,F60,90F,F69,06F,099,606,60F,906,F6F'; //颜色表

/// 额外配置-根据需要配置 //////////////////////////////////////////////////////////////////////////////// 

// xdebug 

// weixin
$_cbase['weixin']['debug']  = true; 
$_cbase['weixin']['actiks']  = array(); 
$_cbase['weixin']['haibaoMediaid'] = 'I7mPnzk9v0tF6nHiEmy0sDbtRksBp4pVHSYBZvdROjc';
$_cbase['weixin']['haibaoPicurl'] = 'http://yscode.txjia.com/uimgs/logo/haibao.jpg';
$_cbase['weixin']['tplidIndoc'] = 'u6DK6CKG8TnCFGaOwglBPUPa_UvE3nwpQU-k8kP1YpA';

// indoc
$_cbase['indoc']['debug'] = true; 

// 3aks
$_cbase['3aks']['baiduip'] = '3GGtGlCtbAGa1GYK70XFX2Rb'; //百度地图




/*******************************************************************************
 File : \code\cfgs\boot\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\cfgs\excfg\ex_a3rd.php 
*******************************************************************************/
<?php

/*

'合作身份者ID，以2088开头的16位纯数字
partner         = "2088802931044344"

'安全检验码，以数字和字母组成的32位字符
key   			= "gunm2vfn3wtr7hhb66mm5easwguj5y8t"

dianyuanyuan0109@163.com
13790321373@163.com

sid_AliPay 58722687@qq.com
sid_PayPal elifebike@hotmail.com

*/

### alipay: =======================================================================

$pay_uinfo['demo']['partner']  = '2088012340123401234';
//合作身份者id，以2088开头的16位纯数字
$pay_uinfo['demo']['email']	  = 'demo@domain.com';
//收款支付宝账号
$pay_uinfo['demo']['key']      = '0123401234012340123401234';
//安全检验码，以数字和字母组成的32位字符
$pay_uinfo['demo']['sandbox']  = false;  
//设置在沙箱中运行，正式环境请设置为false,true

$pay_uinfo['ali']['partner']  = '2088311817647422';                 // 2088002033470355,                 2088311817647422
//合作身份者id，以2088开头的16位纯数字:                
$pay_uinfo['ali']['email']	  = '910377558@qq.com';         // fangyuwei2003@aliyun.com          910377558@qq.com
//收款支付宝账号:                                        
$pay_uinfo['ali']['key']      = 'jp4yhwpr7op6kexac3g623e8qshby59g'; // xt7oyie9cc50uo407j1h6y8x9kruavkf, jp4yhwpr7op6kexac3g623e8qshby59g
//安全检验码，以数字和字母组成的32位字符:             
$pay_uinfo['ali']['sandbox']  = false;  
//设置在沙箱中运行，正式环境请设置为false,true

# 提示：确认或复制文件 'cacert.pem' 到: /vendor/a3rd/alipay_class/

### tenpay: =======================================================================

$pay_uinfo['ten']['appid']   = "1202397201";
//设置财付通App-id: 财付通App注册时，由财付通分配   
$pay_uinfo['ten']['key']     = "cdb73ab93e390d4e9925f56e919d2618"; 
//签名密钥: 开发者注册时，由财付通分配 
$pay_uinfo['ten']['sandbox'] = false;  
//设置在沙箱中运行，正式环境请设置为false,true

### paypal: =======================================================================

$pay_uinfo['pal']['user']    = "seller_username_here"; 
$pay_uinfo['pal']['pass']    = "seller_password_here"; 
$pay_uinfo['pal']['sign']    = "seller_signature_here"; 
$pay_uinfo['pal']['sandbox'] = false;  
//设置在沙箱中运行，正式环境请设置为false,true

### qqconn: =======================================================================

$pay_uinfo['qqconn']['appid']    = "yourappid"; 
$pay_uinfo['qqconn']['appkey']    = "yourappkey";
$pay_uinfo['qqconn']['callback'] = "http://your domain/oauth/get_access_token.php";  

### testapi: =======================================================================

$pay_uinfo['test']['user']    = ""; 
$pay_uinfo['test']['pass']    = "";
$pay_uinfo['test']['sandbox'] = false;  




/*******************************************************************************
 File : \code\cfgs\excfg\ex_dmacc.php 
*******************************************************************************/
<?php
$_ex_dmacc = array(
	$_SERVER['HTTP_HOST'],
	//'yscode.txjia.com',
);



/*******************************************************************************
 File : \code\cfgs\excfg\ex_dmbind.php 
*******************************************************************************/
<?php
$_ex_dmbind = array(

	// /vary/html/cargo/2015-9c/h3h1.html
	// http://pro.my_domain.com/2015-9c/h3h1.html
	array(
		'{html}/xxx_cargo/`d#`', //用`d#`,`w#` 分别代表正则的 (\d+)(\w+)
		'http://pro.my_domain.com/\\1-', //使用\1的形式来实现反向引用
		'1', //1-用正则-自动格式化
	),
	
);

/*

// /vary/html/cargo/2015-9c/h3h1.html
// /pro1/2015-9c/h3h1.html
array(
	'{html}/cargo/', //{html}=PATH_HTML：/run/_paths.php中定义，html文档的相对目录
	'/pro1/',
	'0', //0-不用正则
),

// /vary/html/cargo/2015-9c/h3h1.html
// http://pro2.my_domain.com/2015-9c/h3h1.html
array(
	'{html}/cargo/`d#`', //用`d#`,`w#` 分别代表正则的 (\d+)(\w+)
	'http://pro2.my_domain.com/\\1-', //使用\1的形式来实现反向引用
	'1', //1-用正则-自动格式化
),

// 效果同上/08tools/yssina/vary/html/
array(
	'{html}\\/cargo\\/(\d+)\\-', 
	'http://pro3.my_domain.com/\\1-', 
	'2', //2-用正则-自由写正则
),

// 规则：正则表达式特殊字符有： . \ + * ? [ ^ ] $ ( ) { } = ! < > | : - 

*/
		


/*******************************************************************************
 File : \code\cfgs\excfg\ex_dmsubs.php 
*******************************************************************************/
?<?php
$_ex_dmsubs = array(

	'bj' => '北京', // http://bj.my_domain.cn/
	'sh' => '上海', // http://sh.my_domain.cn/
	'gz' => '广州', // http://gz.my_domain.cn/
	'dg' => '东莞', // http://dg.my_domain.cn/
	'sz' => '深圳', // http://sz.my_domain.cn/
	// ……
	'wm' => '无名', // http://wm.my_domain.cn/

	'_def' => array(
		'site' => 'dg',
		'domain' => 'my_domain.cn',
		'api' => 'ip138',
	),
	
);

/*

### 目标/规划：

- 复制本系统n份，做n个分站
- 实现：根据用户ip自动跳转到分站
- 提示，域名解析，自行解析或找域名提供商....
- 规划：见上配置


### 分析：

- 单个子站点，不用(需要)跳转，即不管访问者在那里，输入sh.my_domain.cn就是上海站；
- 如果输入 my_domain.cn / www.my_domain.cn 自动跳转到相应的分站；这样逻辑上其实非常简单：
- 专门建立一个 www.my_domain.com 或 my_domain.com ，用于跳转；
- 到此：跳转本身，完全可离开本系统自己DIY；思路分析到此为止；


### 配置实现

- 任一找一子站点，配置：\main\code\cfgs\excfg\ex_dmsubs.php，参数；
- 服务器设置：配置 www.my_domain.com 或 my_domain.com ，站点，跟目录指向上述站点的\main\root\plus\api\子目录；
- 服务器设置：配置 subdir.php为默认文档（Apache设置参数DirectoryIndex），其他默认文档请删除；


### 工具/调试
- 使用`?nav`显示调试工具；参考如下[连接提示]
- 使用`?debug`可进项跳转调试；
- 使用`?cfgs`获取分站列表，各分站可ajax调用，展示分站列表；
- 使用`?ip`可模拟ip跳转；
- 使用`?ip:debug`为综合模拟；


### 连接提示：

<li><a href='?nav'>nav</a></li>
<li><a href='?cfgs'>cfgs</a></li>
<li><a href='?html'>html</a></li>
<li><a href='?debug'>debug</a></li>
<li><a href='?121.13.197.187'>121.13.197.187</a></li>
<li><a href='?121.13.197.187:debug'>121.13.197.187:debug</a></li>

*/



/*******************************************************************************
 File : \code\cfgs\excfg\ex_filetype.php 
*******************************************************************************/
<?php

// 附件类型
$_ex_filetype = array( 
	//             // 第一个需要有个代表图标...
	'image' => array('pic', 'gif', 'jpg', 'jpeg', 'png'), 
	'flash' => array('swf', 'flv'), //{palyer}
	'video' => array('video', 'mov', 'avi', 'mpg', 'asf', 'rm', 'rmvb', 'ogg'),
	'audio' => array('audio', 'mp3', 'wav', 'wma', 'wmv', 'mid', ), //{palyer}
	'docus' => array('docus','doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'wps', 'et'),
	'file'  => array('xml', 'txt', 'htm', 'html', ),
	'ziper' => array('zip', 'rar', 'gz', 'bz2', '7z', 'cab'),
);	



/*******************************************************************************
 File : \code\cfgs\excfg\ex_ipstop.php 
*******************************************************************************/
<?php

$_ex_ipstop = array( //官方优先配置
	'256.257.258.*',
	'356.357.358.*',
);


/*******************************************************************************
 File : \code\cfgs\excfg\ex_mail.php 
*******************************************************************************/
<?php

// mail配置
$_ex_mail['type']   = "phpmailer"; // phpmailer,swiftmailer; 
$_ex_mail['smtp']   = 'smtp.163.com'; // SMTP 服务器
$_ex_mail['port']   = '25'; // SMTP 端口
$_ex_mail['check']  = '1'; // 1,0: SMTP 要求身份验证
$_ex_mail['from']   = 'xpigeon@163.com'; //发信人邮件地址
$_ex_mail['user']   = 'xpigeon@163.com'; //SMTP 身份验证帐户
$_ex_mail['pass']   = 'i.4green'; //SMTP 身份验证密码



/*******************************************************************************
 File : \code\cfgs\excfg\ex_outdb.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// 同步服务器 'http://master.domain.com/root';
$_ex_outdb['psyn']['server'] = 'http://127.0.0.1/txmao'; //同步服务器
$_ex_outdb['sign']['sapp'] = 'tiexinmao_demo_sapp'; //签名:sapp
$_ex_outdb['sign']['skey'] = 'X9040f@txmao-demo.skey'; //签名:skey
// 单独设置(暂未使用...)
#$_ex_outdb['sign_(jobid)']['sapp'] = ''; //签名:sapp
#$_ex_outdb['sign_(jobid)']['skey'] = ''; //签名:skey

// 外部数据库(键值不要用:psyn,sign,list等)
$_ex_outdb['list'] = array(
	'demodata' => '(Demo:Mysql-Import)导入演示数据',
	'dedecms' => '(Mysql:DedeCMS)织梦CMS', 
	'powereasy' => '(Access:PowerEasy)动易CMS',
	'u08house' => '(u08house)08旧房产',
	'newhouse' => '(newhouse)08新房产',
);

$_ex_outdb['demodata']['db_type'] = 'mysql';
$_ex_outdb['demodata']['db_dsn'] = 'mysql:host=localhost;dbname=odata_demo;port:3306';
$_ex_outdb['demodata']['db_name'] = 'odata_demo';
$_ex_outdb['demodata']['db_user'] = 'root';
$_ex_outdb['demodata']['db_pass'] = '';
$_ex_outdb['demodata']['db_cset'] = 'utf8';

$_ex_outdb['dedecms']['db_type'] = 'mysql';
$_ex_outdb['dedecms']['db_dsn'] = 'mysql:host=localhost;dbname=dedecms_v57;port:3306';
$_ex_outdb['dedecms']['db_name'] = 'dedecms_v57';
$_ex_outdb['dedecms']['db_user'] = 'root';
$_ex_outdb['dedecms']['db_pass'] = '';
$_ex_outdb['dedecms']['db_cset'] = 'gbk';

$_ex_outdb['powereasy']['db_type'] = 'MSSQL'; //???
$_ex_outdb['powereasy']['db_dsn'] = "odbc:driver={microsoft access driver (*.mdb)};dbq=".DIR_DTMP."/upath/powereasy.mdb";
$_ex_outdb['powereasy']['db_user'] = '';
$_ex_outdb['powereasy']['db_pass'] = '';
$_ex_outdb['powereasy']['db_cset'] = 'gbk';


// 旧版数据，（用于[更新升级]#导入旧版数据）
$_cfgs['db_name']   = 'txmao_v32'; // 数据库名(pdox连接不使用) 
$_cfgs['db_prefix'] = ''; // 数据库前缀pre_
$_cfgs['db_suffix'] = '_ys'; // 数据库前缀_suf
$_cfgs['db_cset']   = 'utf8';// 数据库编码
// db_host,db_port,db_user,db_pass使用相同的设置
$_ex_outdb['psyn']['odbcfgs'] = $_cfgs;

/*
使用PDO链接外部数据库；在PHP.INI配置文件中找到php_pdo.dll，php_pdo_odbc.dll等配置设置
*/

$_ex_outdb['u08house']['db_type'] = 'mysql'; //???
$_ex_outdb['u08house']['db_dsn'] = "mysql:host=192.168.1.60;dbname=dbhouse;port:3306";
$_ex_outdb['u08house']['db_user'] = '';
$_ex_outdb['u08house']['db_pass'] = '';
$_ex_outdb['u08house']['db_cset'] = 'gbk';

$_ex_outdb['newhouse']['db_type'] = 'mysql'; //???
$_ex_outdb['newhouse']['db_dsn'] = "mysql:host=192.168.1.60;dbname=newhouse;port:3306";
$_ex_outdb['newhouse']['db_user'] = '';
$_ex_outdb['newhouse']['db_pass'] = '';
$_ex_outdb['newhouse']['db_cset'] = 'utf8';




/*******************************************************************************
 File : \code\cfgs\excfg\ex_paras.php 
*******************************************************************************/
<?php

// paras扩展参数(按栏目/等级)
$_ex_paras['catid'] = array('demo','about','cargo'); 
$_ex_paras['grade'] = array('company','govern','organize'); 



/*******************************************************************************
 File : \code\cfgs\excfg\ex_sfdata.php 
*******************************************************************************/
<?php

// ...
$_ex_sfdata = array(
	// ---------------------------------------
	'tab_sys'=>'dgnet;txjia;elifebike;dongguan;chengzhou',
	'tab_spe'=>array(
		'spe1'=>array(
			'特殊字符1',
			'{;|;};~;;;'
		),
		'spe2'=>array(
			'特殊字符2',
			';■;□;◎;●;▲;●'
		),
	),
	'tab_key'=>array(
	
		'key2'=>array(
			'自定义过滤',
			'smw.com;13699850490;监控;探测;防盗;防暴;消防;报警;摄像机;邪教;赌博;独立;反动;暴力;色情;'
		),
		'key2'=>array(
			'发票证件',
			'发票;发 票;发.票;发`票;作弊;窃听;办证;车牌;身份证生成器;出售假币;办理证件;星级酒店;侦探设备;代办学历;'
		),
		'key2'=>array(
			'违禁品',
			'迷药;迷魂药;群发器;带开发票;监听器;窃听器;摇头丸;白粉;绑匪;绑架;黑势力;恶势力;艾司唑仑;舒乐安定;丸仔;拍丸;迷奸药;迷昏药;麻醉枪;三唑仑;佳静安定片;强效失意药;蒙汗药粉;古方迷香;拍肩神药;麻醉钢枪;麻醉乙醚;EstaZolam;群发;'
		),
		'key1'=>array(
			'文化领域',
			'福特基金会;二十一世纪基金会;富布赖特基金会;殷海光基金会;夏潮基金会;独立作家笔会;炎黄春秋杂志社;爱知行动项目;红枫妇女心理咨询中心;'
		),
		'key1'=>array(
			'其它',
			'鬼村;无界浏览器;升达毕业证;手机复制;天鹅之旅;盘古乐队;'
		),
		'key1'=>array(
			'法邪教',
			'法轮;falun;大法;宇宙大法;大善大忍;真善忍;一贯道;张宏堡;高层生命;生命系统;宇宙众生;李洪志;贺信彤;谢万军;真相;大师;得法;学法;心性;造业;迫害;魔难;得度;讲清真象;校度世人;迫害大法;洪法;明慧;minghui;圆满;正法;邪恶;放光明;正见网;大法之声;法网恢恢;练功;护法;恶人;践踏人权;'
		),
		'key1'=>array(
			'法轮功2',
			'暴行;盖棺定论;自焚;六一零;法轮功信徒;同修;突破封锁;张宏堡;阎庆新;中功;国际中功总会;圆顿;麒麟文化;金麒麟网;菩提功;菩提教会;龙华经;宏宝大法王;噶玛巴;金普提上师;菩提法门;中国影子政府;'
		),
		'key1'=>array(
			'赌博类',
			'赌球;博彩;六合彩;三公;外围;赌恒指;对冲;庄家;大庄;投注站;赔率;摇奖;开奖;出千;设局;特码;下盘;波胆;曾道人;肖中特;'
		),
		'key1'=>array(
			'枪支弹药',
			'枪支;弹药;手枪;防暴枪;两用枪;麻醉枪;武器;灭火枪;消防枪;电击枪;电子枪;红外枪;'
		),
		'key1'=>array(
			'独立',
			'伊扎布特;东突;三股势力;恐怖主义;偷越边境;潜入潜出;爆炸装置;藏独;疆独;达赖;转世;新疆独立;'
		),
		'key1'=>array(
			'民运类',
			'安琪;鲍彤;鲍戈;丁子霖;东海一;杜导斌;方觉;方励之;天安门事件;天安门真相;六四密件;新年致难友的公开信;人权组织;赦特组织;中国之春;北京之春;大纪元;美国之音;军事训练基地;民联;民阵;民主基金会;民主论坛;民主之家;民主之声;民主中国;中国民主联盟;中国工党;中国正义党;'
		),
		'key1'=>array(
			'领导类',
			'江ｘｘ;江猪西;江核心;江共;江责民;江贼民;汪泽民;汪择民;江小人;江绵恒;朱F基;朱基;胡紧套;十七大人事安排;戴海静;毛一鲜;黎阳平;新唐人;张小平;'
		),
		'key1'=>array(
			'反动暴力',
			'退党;反共;禁书;疆独;藏独;反华;黑社会;反政府;子女任职名单;对日强硬;西藏天葬;军长发威;恶搞晚会;枪决女犯;帝国之梦;投毒杀人;强硬发言;官商勾结;六四事件;血腥图片;枪决现场;高校暴乱;高校群体事件;大学骚乱;高校骚乱;高干子女;高干子弟;'
		),
		'key1'=>array(
			'色情类',
			'黄色;成人;A片;A级;三级;春宫;淫乱;兽交;口交;肛交;SEX;同性恋;买春;卖春;一条龙;陪睡觉;三陪;性服务;包办色情娱乐服务;色情表演;叫小姐;叫鸡;脱衣舞;男妓;北方客;北妹;阴茎;鸡巴;肉棒;小鸡鸡;我操;妓女;北姑;北妹;阴道;小穴;肉洞;嫩穴;淫水;'
		),
		'key1'=>array(
			'色情类2',
			'淫荡;处女;乳房;小丫;荡妇;大波;女人费;淫靡;春药;换妻;小电影;催情药;三级片;成人片;透视眼镜;远程偷拍;色情服务;成人电影;性伴侣;一夜情;'
		),
	
		'key1'=>array(
			'关键字1',
			'发?票;办?件'
		),
		'keyn'=>array(
			'关键字n', 
			'作?弊;窃?听'
		),
	),
	'tab_adv'=>array(
		'adv1'=>array(
			'广告连接1',
			'myadv.com;myadv.cn'
		),
		'advn'=>array(
			'广告连接n',
			'<a*</a>;[url]*[/url];[link]*[/link];[script*[/script];<script*</script>'
		),
		'advm'=>array(
			'极限n', //新广告法极限用语
			'xxx'
			// 国家级;世界级;最高级;最佳;最大;第一;唯一;首个;首选;最好;最大;精确;顶级;最高;最低;最;最具;最便宜;最新;最先进;最大程度;最新技术;最先进科学;国家级产品;填补国内空白;绝对;独家;首家;最新;最先进;第一品牌;金牌;名牌;优秀;最先;顶级;独家;全网销量第一;全球首发;全国首家;全网首发;世界领先;顶级工艺;最新科学;最新技术;最先进加工工艺;最时尚;极品;顶级;顶尖;终极;最受欢迎;王牌;销量冠军;第一(NO.1\Top1);极致;永久;王牌;掌门人;领袖品牌;独一无二;独家;绝无仅有;前无古人;史无前例;万能等
		),
	),
	// ---------------------------------------
	'plan'=>array(
		'title_en'=>array(
			'Words,4,mark',
			'NCom,2,mark,en',
			'NSpe1,mark,(all)',
			'NKey,1,stop,(all)',
		),
		'title_cn'=>array(
			'CNChr,2,mark',
			'NCom,2,mark,cn',
			'NSpe,1,mark,(all)',
			'NKey,1,stop,(all)',
		),
		'contect'=>array(
			'Words,4,mark',
			'NCom,2,mark,cn',
			'NKey,1,stop,(all)',
		),
	),
	
);


/*******************************************************************************
 File : \code\cfgs\excfg\ex_simpass.php 
*******************************************************************************/
<?php

$_ex_simpass = array(
	'admin', 'ADMIN', 
	'123456', '123321', 
);



/*******************************************************************************
 File : \code\cfgs\excfg\ex_sms.php 
*******************************************************************************/
<?php

// sms短信配置,不需要可删除此项
$_ex_sms['cfg_api']   = '0test'; // 0test,winic,cr6868,emhttp,dxqun,bucp
$_ex_sms['user']      = 'user_test'; 
$_ex_sms['pass']      = 'pass_test'; 
$_ex_sms['cfg_pr3']   = '111110'; 
$_ex_sms['cfg_pr4']   = ''; //
$_ex_sms['cfg_pr5']   = ''; //
$_ex_sms['price_api'] = '0.1'; //
$_ex_sms['price_mem'] = '0.15'; //



/*******************************************************************************
 File : \code\cfgs\excfg\ex_ujump.php 
*******************************************************************************/
<?php

### 子域名跳转配置

// domain
$_ex_ujump['domain'] = 'txjia.com'; 
// 分站配置,注意城市名称不要加“站/分站/市”等
$_ex_ujump['sites'] = array(
    'bj' => '北京', // http://bj.my_domain.cn/
    'sh' => '上海', // http://sh.my_domain.cn/
    'gz' => '广州', // http://gz.my_domain.cn/
    'dg' => '东莞', // http://dg.my_domain.cn/
    'sz' => '深圳', // http://sz.my_domain.cn/
    // ……
    'wm' => '无名', // http://wm.my_domain.cn/
);
// 未找到地区时的默认网站
$_ex_ujump['defsite'] = 'dg'; 



### 多语言版跳转配置

// 语言版本配置
$_ex_ujump['langs'] = array(
    'zh' => 'chn', 
    'en' => 'eng', 
    'fr' => 'fra', 
    'ru' => 'rus',
    'es' => 'esp',
    // ……
    'ko' => 'kor',
);
// 未找到匹配的语言版本
$_ex_ujump['deflang'] = 'chn'; 



### 短地址跳转配置

// redir配置
$_ex_ujump['redir'] = array(
    $_ex_redir['yscode'] = "http://yscode.txjia.com/", 
    $_ex_redir['baidu'] = 'https://www.baidu.com/', 
);




/*

### 目标：

- 复制n份程序代码，做n个分站
- 实现：根据用户ip自动跳转到分站
- 提示，域名解析，自行解析或找域名提供商....


### 规划：

- 北京站 http://bj.my_domain.cn/
- 上海站 http://sh.my_domain.cn/
- 广州站 http://gz.my_domain.cn/
- 东莞站 http://dg.my_domain.cn/
- 深圳站 http://sz.my_domain.cn/
- 无名站 http://wm.my_domain.cn/


### 分析：

- 单个子站点，不用(需要)跳转，即不管访问者在那里，输入sh.my_domain.cn就是上海站；
- 如果输入 my_domain.cn / www.my_domain.cn 自动跳转到相应的分站；
- 这样逻辑上其实非常简单：专门建立一个 www.my_domain.com 或 my_domain.com ，用于跳转；
- 到此：跳转本身，其实与程序已经没有多大关系，但ip判断，跳转代码等可用本系统的代码，也可完全不用；
- 思路分析到此为止；


### 本系统上扩展实现

- 原来的各分站，还是原始的系统，这样好啊，利于升级，维护！
- 在任意一个系统分站，添加一个目录如：subdir，扩展本功能；
- 准备活动：
> 建立分站配置表：(自行配置)
> 获得访问者ip地址：cls_envBase::OnlineIP() @ /libs/classes/common_08cms/envbase.cls.php
> 根据ip获得对应地址：$ip = new cls_ipAddr(); $addr = $ip->addr($ip); @ /libs/classes/api/ipAddr.cls.php
- subdir下建立一个index.php文件，根据上面提示写点代码 （自己写吧！）
- 服务器设置：设置 www.my_domain.com 或 my_domain.com ，站点，跟目录指向上述 subdir即可
- 就这么简单，跳转弄好了……


### 参考代码(subdir/index.php)：
 - ...



### 参考代码(subdir/config.php)：
 - ...



### 提示思路：

- 各分站调用所有分站列表
> 各分站做独立页，同步到各分站；
> 各分站也可调用 上述 www.my_domain.com 数据，免得每个分站维护，
   这里自己写扩展代码，用于各分站调用，自己处理模版……


### 完全diy

- 根据上述提示，分站跳转可完全脱离08cms系统，自己写相关代码即可
- 当然，上述subdir等目录，也不用建立在08cms系统下，自行规划


### 提示说明

- 要自动检测的分站，至少要为地区级，要实现 自动检测同一个地区级下的小区域是没有意义的；
- 自动检测分站原理是，按ip地址库中，匹配到的中文来判断的，即出现了"东莞"才会跳转到"东莞"分站；
- 有些ip地址库 的地址 类似如"广东省 联通统一出口"，那就根本 检测不到 "东莞"，也就不会跳转到"东莞"了。
- 手机端使用(没有意义)：
> 手机端检测的ip一般使用代理，用于判断分站跳转，没有意义；
> 当然，手机端有更准确的GPS，Wifi定位，但网页中无法调用，这里讨论无意义；


### 目前发布系统 说明：

- 家装自带站外分站设置，可使用自带设置，也可按上述设置；
- 汽车 前期版本，自带站内地区跳转；后续有改为：站内按地区读出地区相关信息
> 这里的跳转或按地区，都是同已站内（统一08cms系统）,上述的复制出n个分站是另一回事
- 目前发布的系统：定位为地方门户；
> 如果做分站，建议：按以上方式，一个分站，对应一个地区，对应一份程序
> 在同一个站点内，设置地区及分站（设置全国的分站）运营 可能并不太适合；


*/



/*******************************************************************************
 File : \code\cfgs\excfg\ex_vopfmt.php 
*******************************************************************************/
<?php
//模板显示格式

$_ex_vopfmt = array();

// 存储格式
$_ex_vopfmt['res'] = array( 
	'0' => array('about'), // yyyy-md-noid
	'1' => array('news'), // yyyy/md-noid默认
	'2' => array('cargo'), // yyyy-md/noid
	'3' => array('demo'), // yyyy/md/noid
);	

// 所有语言
$_ex_vopfmt['langs'] = array(
    'en' => array(
		'English',  
		'En'
    ),
	'cn' => array(
		'中文版',  
		'中'
	), 
);

// 所有模板
$_ex_vopfmt['tpl'] = array(
    'adm' => array(
    	array('cn'=>'管理中心', 'en'=>'Admin'),
    	'/root/run/adm.php'
    ),
	'chn' => array(
		'中文版',  
		'/chn.php'
	), 
	'dev' => array(
		'演示版',  
		'/dev.php'
	), 
	'doc' => array(
		'Guides',  
		'/doc.php'
	), 
	'mob' => array(
		array('cn'=>'手机版', 'en'=>'Mobile'),  
		'/mob.php'
	), 
	'umc' => array(
		array('cn'=>'会员中心', 'en'=>'User'),
		'/root/run/umc.php'
	), 
	//'demodir' => array('hello','/root/run/front.php'), 
);

// 各模块展示show
$_ex_vopfmt['show'] = array( 
	//'chn' => array('',''), 
	'dev' => array('demo'), 
	'umc' => array('indoc','faqs'), 
	'_defront_' => 'chn', //默认展示模板
	'_deadmin_' => 'adm', //默认管理模板
	'_hidden_' => array('adminer','inmem'), //无展示模块
);



/*******************************************************************************
 File : \code\cfgs\excfg\ex_wmark.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$_ex_wmark['type']   = 'text'; // 0,pic,text, 水印类型：pic-配置中的图片, text-配置中的文字
$_ex_wmark['stext']  = basEnv::topDomain($_SERVER['SERVER_NAME']); //水印文字内容('my_domain.com')
$_ex_wmark['plogo']  = '/skin/logo/logo-peace.gif'; //水印图片文件(root目录)
$_ex_wmark['width']  = '200'; //文字宽度
$_ex_wmark['height'] = '40'; //文字高度
$_ex_wmark['size']   = '24'; //文字大小
$_ex_wmark['font']   = '/media/fonts/simkai.ttf'; // //文字字体(static目录)
$_ex_wmark['ctext']  = '255'; // 文字颜色: #CCC
$_ex_wmark['cborder'] = '51'; // 文字边框: #333 

// 水印位置
// - (0-9,margin=10) 0-9:0为随机,其他代表上中下9个部分位置; margin:水印边距
// - (-10,20) 距离下方10px, 右方20px
$_ex_wmark['pos'] = array(0,10);




/*******************************************************************************
 File : \code\cfgs\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\cfgs\scfile\ex_fadm.php 
*******************************************************************************/
<?php

// dopFunc::modFile($_scdir,$mod) 使用
$scfgs = array( //官方优先配置
	//'demo' => "/emod/demo.php",
	'coitem' => "/emod/cocar.php",
);


/*******************************************************************************
 File : \code\cfgs\stinc\auto404.php 
*******************************************************************************/
<?php 
$aincfile = '/cfgs/stinc/err404.php';
include(dirname(__FILE__).'/autoinc.php');



/*******************************************************************************
 File : \code\cfgs\stinc\autoinc.php 
*******************************************************************************/
<?php 
//$aincfile = '/root/run/_paths.php';
//$aincfile = '/cfgs/stinc/err404.php';

function autoInc_ys($file=''){
	if(empty($file)) return $file;
	$path = ''; // -- 自动检测路径
	// /html/model/collum1/collum2/collum2/yyyy/m/d/id/
	for($i=0;$i<12;$i++){
		$path = empty($path) ? dirname(__FILE__) : dirname($path);
		$full = "$path$file";
		if(file_exists($full)){
			return $full;	
			break;
		} 
	}
	return '';
}

if(!empty($aincfile) && $aincpath=autoInc_ys($aincfile)){
	include($aincpath);
}
//echo DIR_ROOT;



/*******************************************************************************
 File : \code\cfgs\stinc\close_info.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
$cmsg = 'Site Closed!';
$sname = urlencode($_cbase['sys_name']);
?>
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title>Site Closed!</title>
<meta name='robots' content='noindex, nofollow'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
</head>
<body style="margin:10px">
<h1>Site Closed!</h1>
<p>Hi, <?php echo lang('core.cfg_close'); ?></p>
<hr>
<p>More Infomation you can find:</p>
<ul>
  <li>Find@ [<a href="http://www.baidu.com/s?wd=<?php echo $sname; ?>" target="_blank">baidu.com</a>].</li>
  <li>Find@ [<a href="http://www.google.com.hk/search?q=<?php echo $sname; ?>" target="_blank">google.com</a>].</li>
</ul>
<hr>
<footer>
<?php
echo "\n<li>".date('Y-m-d H:i:s').'</li>';
echo "\n<li>".$_SERVER['SERVER_SOFTWARE'].' PHP/'.PHP_VERSION.'</li>';
?>
</footer>
</body>
</html>
<?php
die(); //date('Y-m-d H:i:s')
?>



/*******************************************************************************
 File : \code\cfgs\stinc\err404.php 
*******************************************************************************/
<?php
$cmsg = '404 Not Found';
header('HTTP/1.1 '.$cmsg);
header('Status:'.$cmsg);
?>
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title>404 Not Found</title>
<meta name='robots' content='noindex, nofollow'>
</head>
<body style="margin:10px">
<h1>HTTP 404 Not Found</h1>
<p>The requested URL was not found on this server.</p>
<hr>
<p>More Infomation you can find:</p>
<ul>
  <li>Go to [<a href="/" target="_blank">Homepage</a>].</li>
  <li>Find@baidu.com [<a href="http://www.baidu.com/s?wd=HTTP 404 Error" target="_blank">HTTP 404 Error</a>].</li>
  <li>Find@google.com [<a href="http://www.google.com.hk/search?q=HTTP 404 Error" target="_blank">HTTP 404 Error</a>].</li>
</ul>
<hr>
<footer>
<?php
echo "\n<li>".date('Y-m-d H:i:s').'</li>';
echo "\n<li>".$_SERVER['SERVER_SOFTWARE'].' PHP/'.PHP_VERSION.'</li>';
?>
</footer>
</body>
</html>



/*******************************************************************************
 File : \code\cfgs\stinc\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\cfgs\stinc\sys_copy.php 
*******************************************************************************/
QQ:80893510 E-mail:xpigeon#163.com <br />
Copyright@2011 by Peace(XieYS) <?php echo lang('core.cfg_dggdcn'); ?>


/*******************************************************************************
 File : \code\cfgs\sycfg\sy_dmtop.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/*
$s = '.com.net.org.edu.gov.idx.int.mil.';
$s .= 'bar.biz.cat.pro.tel.top.vip.xxx.xyz.';
$s .= 'aero.arpa.asia.coop.club.host.info.mobi.name.jobs.site.tech.wang.';
$s .= 'store.space.press.';
$s .= 'museum.travel.online.';
$s .= 'website.';
$_my_dmtop['tops'] = ".$s.";
$_my_dmtop['keep3'] = ""; //需要增加第三节 .mex.com 
$_my_dmtop['keep2'] = ""; //只需要两节 .cn.net 
*/

// www.gdnet.dg.cn 则 part2=dg, part1=cn
// 2:只需要两节 .cn.net 
// 3:需要增加第三节 .mex.com 
$_sy_dmtop['part2.part1'] = ""; // 2,3

/*
https://www.whois365.com/cn/listtld
目前有 669 个 国际顶级域名 (gTLD) 及 290 个 国家及地区顶级域名 (ccTLD) 列于 IANA。
"全球 WHOIS 查询" 支持查询 597 个国际顶级域名 (gTLD) 及 137 个 国家及地区顶级域名 (ccTLD)。
另可查询 32 个 CentralNIC 域名。

*/



/*******************************************************************************
 File : \code\cfgs\sycfg\sy_fadvs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$_sy_fadvs = array (
    'title' => 
    array (
      'title' => '标题',
      'enable' => '1',
      'etab' => '0',
      'type' => 'input',
      'dbtype' => 'varchar',
      'dblen' => '255',
      'dbdef' => '',
      'vreg' => 'tit:2-60',
      'vtip' => '标题2-60字符',
      'vmax' => '60',
      'fmsize' => '360',
      'fmline' => '1',
      'fmtitle' => '1',
    ),
    'color' => 
    array (
      'title' => '标题颜色',
      'enable' => '1',
      'etab' => '0',
      'type' => 'input',
      'dbtype' => 'varchar',
      'dblen' => '12',
      'dbdef' => '',
      'vreg' => 'nul:str:4-7',
      'vtip' => '如:#FF00FF',
      'vmax' => '8',
      'fmsize' => '',
      'fmline' => '0',
      'fmtitle' => '0',
      'fmextra' => 'color',
      'fmexstr' => 'title',
    ),
    'ndb_repeat' => 
    array (
      'title' => '检查重复',
      'enable' => '1',
      'etab' => '0',
      'type' => 'hidden',
      'dbtype' => 'nodb',
      'dblen' => '255',
      'dbdef' => '',
      'vreg' => '',
      'vtip' => '',
      'vmax' => '0',
      'fmsize' => '',
      'fmline' => '0',
      'fmtitle' => '0',
      'fmextra' => 'repeat',
    ),
    'detail' => 
    array (
      'title' => '内容',
      'enable' => '1',
      'etab' => '0',
      'type' => 'text',
      'dbtype' => 'text',
      'dblen' => '0',
      'dbdef' => '',
      'vreg' => '',
      'vtip' => '',
      'vmax' => '24012',
      'fmsize' => '480x8',
      'fmline' => '1',
      'fmtitle' => '1',
      'fmextra' => 'text',
      'fmexstr' => '',
    ),

    'mpic' => 
    array (
      'title' => '缩略图',
      'enable' => '1',
      'etab' => '0',
      'type' => 'file',
      'dbtype' => 'varchar',
      'dblen' => '255',
      'dbdef' => '',
      'vreg' => 'nul:fix:image',
      'vtip' => 'gif/jpg/jpeg/png格式.',
      'vmax' => '255',
      'fmsize' => '',
      'fmline' => '1',
      'fmtitle' => '1',
    ),
    'url' => 
    array (
      'title' => 'Url地址',
      'enable' => '1',
      'etab' => '0',
      'type' => 'input',
      'dbtype' => 'varchar',
      'dblen' => '255',
      'dbdef' => '',
      'vreg' => 'nul:fix:uri',
      'vtip' => 'http://开头',
      'vmax' => '255',
      'fmsize' => '480',
      'fmline' => '1',
      'fmtitle' => '1',
    ),

    'click' => 
    array (
      'title' => '点击次数',
      'enable' => '1',
      'etab' => '0',
      'type' => 'input',
      'dbtype' => 'int',
      'dblen' => '10',
      'dbdef' => '0',
      'vreg' => 'n+i',
      'vtip' => '如:888',
      'vmax' => '8',
      'fmsize' => '',
      'fmline' => '1',
      'fmtitle' => '1',
    ),

);

// 实现多语言
$__ucfg = basLang::ucfg('fadvs');
foreach ($_sy_fadvs as $__key => $__val) {
  empty($__ucfg[$__key]) || $_sy_fadvs[$__key]['title'] = $__ucfg[$__key];
}
unset($__ucfg,$__pval,$__val);




/*******************************************************************************
 File : \code\cfgs\sycfg\sy_fdemo.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$_sy_fdemo = array(
	  'init_docs' => array(
		  'title'=>array('title'=>'标题','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'60',
			   'vreg'=>'tit:2-60','vtip'=>'标题2-60字符','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'mpic'=>array('title'=>'缩略图','etab'=>'0','type'=>'file','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:image','vtip'=>'gif/jpg/jpeg/png格式.','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'jump'=>array('title'=>'跳转地址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:uri','vtip'=>'http://开头','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'static'=>array('title'=>'静态格式','etab'=>'0','type'=>'input','enable'=>'0','vmax'=>'255',
			   'vreg'=>'nul:str:3-24','vtip'=>'yyyy-md-(no)','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'show'=>array('title'=>'是否显示','etab'=>'0','type'=>'select','enable'=>'1','vmax'=>'1',
			   'vreg'=>'str:1-1','vtip'=>'一定要选','dbtype'=>'int','dblen'=>'1','dbdef'=>'1',),
		  'top'=>array('title'=>'显示顺序','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'6',
			   'vreg'=>'n-i','vtip'=>'如:888','dbtype'=>'int','dblen'=>'10','dbdef'=>'888',),
		  'color'=>array('title'=>'标题颜色','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'8',
			   'vreg'=>'nul:str:4-7','vtip'=>'如:#FF00FF','dbtype'=>'varchar','dblen'=>'12','dbdef'=>'',),
		  'click'=>array('title'=>'点击次数','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'8',
			   'vreg'=>'n+i','vtip'=>'如:888','dbtype'=>'int','dblen'=>'10','dbdef'=>'0',),
	  ),
	  'init_dext' => array(
		  'detail'=>array('title'=>'内容','etab'=>'1','type'=>'text','enable'=>'1','vmax'=>'0',
			   'vreg'=>'str:10+','vtip'=>'内容10字符以上','dbtype'=>'mediumtext','dblen'=>'0','dbdef'=>NULL,),
		  'author'=>array('title'=>'作者','etab'=>'1','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'source'=>array('title'=>'来源','etab'=>'1','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'seo_key'=>array('title'=>'关键字','etab'=>'1','type'=>'input','enable'=>'0','vmax'=>'255',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'seo_des'=>array('title'=>'描述','etab'=>'1','type'=>'input','enable'=>'0','vmax'=>'255',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'seo_tag'=>array('title'=>'标签','etab'=>'1','type'=>'input','enable'=>'0','vmax'=>'255',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,), 
	  ),
	  'init_coms' => array(
		  'title'=>array('title'=>'标题','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'60',
			   'vreg'=>'tit:2-60','vtip'=>'标题2-60字符','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'detail'=>array('title'=>'内容','etab'=>'0','type'=>'text','enable'=>'1','vmax'=>'0',
			   'vreg'=>'str:10+','vtip'=>'内容10字符以上','dbtype'=>'text','dblen'=>'0','dbdef'=>NULL,),
		  'mname'=>array('title'=>'会员名称','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'str:2-24','vtip'=>'2-24字符','dbtype'=>'varchar','dblen'=>'24','dbdef'=>NULL,),
		  'mtel'=>array('title'=>'电话','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'fix:tel','vtip'=>'2-24字符','dbtype'=>'varchar','dblen'=>'24','dbdef'=>NULL,),
		  'memail'=>array('title'=>'邮件地址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:email','vtip'=>'如:peace@domain.com','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'miuid'=>array('title'=>'聊天号','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'120',
			   'vreg'=>'nul:str:5-120','vtip'=>'聊天号:QQ,MSN等','dbtype'=>'varchar','dblen'=>'120','dbdef'=>NULL,),
		  'mweb'=>array('title'=>'网址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:uri','vtip'=>'http://开头','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'maddr'=>array('title'=>'地址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'120',
			   'vreg'=>'nul:str:5-120','vtip'=>'详细地址','dbtype'=>'varchar','dblen'=>'120','dbdef'=>NULL,),
	  ),
  
	  'init_users' => array(
		  'company'=>array('title'=>'公司名称','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'str:2-48','vtip'=>'2-48字符','dbtype'=>'varchar','dblen'=>'96','dbdef'=>NULL,),
		  'mname'=>array('title'=>'会员名称','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'str:2-24','vtip'=>'2-24字符','dbtype'=>'varchar','dblen'=>'96','dbdef'=>NULL,),
		  'mfrom'=>array('title'=>'籍贯','etab'=>'1','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'96','dbdef'=>NULL,),
		  'ename'=>array('title'=>'英文名','etab'=>'0','type'=>'input','enable'=>'0','vmax'=>'96',
			   'vreg'=>'str:2-60','vtip'=>'标题2-60字符','dbtype'=>'varchar','dblen'=>'96','dbdef'=>NULL,),
		  'detail'=>array('title'=>'内容','etab'=>'1','type'=>'html','enable'=>'0','vmax'=>'0',
			   'vreg'=>'str:10+','vtip'=>'内容10字符以上','dbtype'=>'varchar','dblen'=>'0','dbdef'=>NULL,),
		  'mpic'=>array('title'=>'缩略图','etab'=>'0','type'=>'file','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:image','vtip'=>'gif/jpg/jpeg/png格式.','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'map'=>array('title'=>'地图','etab'=>'1','type'=>'input','enable'=>'0','vmax'=>'48',
			   'vreg'=>'','vtip'=>'','dbtype'=>'varchar','dblen'=>'48','dbdef'=>NULL,),
		  't400'=>array('title'=>'400电话','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'fix:tel','vtip'=>'2-24字符','dbtype'=>'varchar','dblen'=>'24','dbdef'=>NULL,),
		  't800'=>array('title'=>'800电话','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'fix:tel','vtip'=>'2-24字符','dbtype'=>'varchar','dblen'=>'24','dbdef'=>NULL,),
		  'mtitle'=>array('title'=>'联系人','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'str:2-24','vtip'=>'2-24字符','dbtype'=>'varchar','dblen'=>'24','dbdef'=>NULL,),
		  'mtel'=>array('title'=>'电话','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'24',
			   'vreg'=>'fix:tel','vtip'=>'7-24字符','dbtype'=>'varchar','dblen'=>'24','dbdef'=>NULL,),
		  'memail'=>array('title'=>'邮件地址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:email','vtip'=>'如:peace@domain.com','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'miuid'=>array('title'=>'聊天号','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'120',
			   'vreg'=>'nul:str:5-120','vtip'=>'聊天号:QQ,MSN等','dbtype'=>'varchar','dblen'=>'120','dbdef'=>NULL,),
		  'mweb'=>array('title'=>'网址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'255',
			   'vreg'=>'nul:fix:uri','vtip'=>'http://开头','dbtype'=>'varchar','dblen'=>'255','dbdef'=>NULL,),
		  'maddr'=>array('title'=>'地址','etab'=>'0','type'=>'input','enable'=>'1','vmax'=>'120',
			   'vreg'=>'nul:str:5-120','vtip'=>'详细地址','dbtype'=>'varchar','dblen'=>'120','dbdef'=>NULL,),
			   
	  ),

);

// 实现多语言
$__ucfg = basLang::ucfg('fdemo');
foreach ($_sy_fdemo as $__pk => $__pval) {
	foreach ($__pval as $__key => $__val) {
	  empty($__ucfg[$__key]) || $_sy_fdemo[$__pk][$__key]['title'] = $__ucfg[$__key];
	}
}
unset($__ucfg,$__pval,$__val);




/*******************************************************************************
 File : \code\cfgs\sycfg\sy_fkeywd.php 
*******************************************************************************/
<?php
$_sy_fkeywd = array(
	// mysql-keywords
	'add','all','alter','analyze','and','as','asc','asensitive','auto_increment','bdb','before','berkeleydb','between','bigint','binary','blob','both','by',
	'call','cascade','case','change','char','character','check','collate','column','columns','condition','connection','constraint','continue','create','cross','current_date','current_time','current_timestamp','cursor',
	'database','databases','day_hour','day_microsecond','day_minute','day_second','dec','decimal','declare','default','delayed','delete','desc','describe','deterministic','distinct','distinctrow','div','double','drop',
	'else','elseif','end','enclosed','escaped','exists','exit','explain','false','fetch','fields','float','for','force','foreign','found','frac_second','from','fulltext','grant','group','having','high_priority','hour_microsecond','hour_minute','hour_second',
	'if','ignore','in','index','infile','inner','innodb','inout','insensitive','insert','int','integer','interval','into','io_thread','is','iterate','join','key','keys','kill',
	'leading','leave','left','like','limit','lines','load','localtime','localtimestamp','lock','long','longblob','longtext','loop','low_priority',
	'master_server_id','match','mediumblob','mediumint','mediumtext','middleint','minute_microsecond','minute_second','mod','natural','not','no_write_to_binlog','null','numeric',
	'on','optimize','option','optionally','or','order','out','outer','outfile','precision','primary','privileges','procedure','purge','read','real','references','regexp','rename','repeat','replace','require','restrict','return','revoke','right','rlike',
	'second_microsecond','select','sensitive','separator','set','show','smallint','some','soname','spatial','specific','sql','sqlexception','sqlstate','sqlwarning','sql_big_result','sql_calc_found_rows','sql_small_result',
	'sql_tsi_day','sql_tsi_frac_second','sql_tsi_hour','sql_tsi_minute','sql_tsi_month','sql_tsi_quarter','sql_tsi_second','sql_tsi_week','sql_tsi_year','ssl','starting','straight_join','striped',
	'table','tables','terminated','then','timestampadd','timestampdiff','tinyblob','tinyint','tinytext','to','trailing','true','undo','union','unique','unlock','unsigned','update','usage','use','user_resources','using','utc_date','utc_time','utc_timestamp',
	'values','varbinary','varchar','varcharacter','varying','when','where','while','with','write','xor','year_month','zerofill',
	// mysql-functions
	'abs','acos','adddate','addtime','aes_encrypt','aes_decrypt','against','ascii','asin','atan','avg','benchmark','bin','bit_and','bit_or','bitcount','bitlength',
	'cast','ceiling','char','char_length','character_length','charset','coalesce','coercibility','collation','compress','concat','concat_ws','conection_id','conv','convert','convert_tz','cos','cot','count','crc32','curdate','current_user','currval','curtime',
	'database','date_add','date_diff','date_format','date_sub','day','dayname','dayofmonth','dayofweek','dayofyear','decode','default','degrees','des_decrypt','des_encrypt','elt','encode','encrypt','exp','export_set','extract',
	'field','find_in_set','floor','format','found_rows','from_days','from_unixtime','get_format','get_lock','group_concat','greatest','hex','hour','if','ifnull','in','inet_aton','inet_ntoa','insert','instr','interval','is_free_lock','is_used_lock',
	'last_day','last_insert_id','lcase','least','left','length','ln','load_file','localtime','localtimestamp','locate','log','log2','log10','lower','lpad','ltrim',
	'make_set','makedate','maketime','master_pos_wait','match','max','md5','microsecond','mid','min','minute','mod','month','monthname','nextval','now','nullif','oct','octet_length','old_password','ord',
	'password','period_add','period_diff','pi','position','pow','power','quarter','quote','radians','rand','release_lock','repeat','replace','reverse','right','round','row_count','rpad','rtrim',
	'sec_to_time','second','session_user','sha','sha1','sign','soundex','space','sqrt','std','stddev','stddev_pop','stddev_samp','strcmp','str_to_date','subdate','substring','substring_index','subtime','sum','sysdate','system_user',
	'tan','time','timediff','timestamp','timestampadd','timestampdiff','time_format','time_to_sec','to_days','trim','truncate',
	'ucase','uncompress','uncompressed_length','unhex','unix_timestamp','upper','user','utc_date','utc_time','utc_timestamp','uuid','var_pop','var_samp','variance','version','week','weekday','weekofyear','year','yearweek',
	// mysql-types
	'tinyint','smallint','mediumint','int','bigint','decimal','float','double',
	'date','datetime','timestamp','time','year',
	'char','varchar','tinytext','text','mediumtext','longtext',
	'enum','set','no',
	'bit','binary','varbinary','tinyblob','blob','mediumblob','longblob',
	'geometry','point','linestring','polygon','multipoint','multilinestring','multipolygon','geometrycollection',
);



/*******************************************************************************
 File : \code\cfgs\sycfg\sy_keepid.php 
*******************************************************************************/
<?php
$_sy_keepid = '
,suser,|,user,
,sysmodel,|,test,model,cbase,suser,pbase,catid,grade,passpt,home,info,common,
,sysfield,|,kid,did,uid,cid,aid,sid,uname,
,aip,atime,auser,eip,etime,euser,
,pagebar,|,page,prec,pjump,ptype,pkey,
,sysdir,|,cache,code,html,root,static,ures,vendor,vendui,plus,run,skin,tools,index,
,inittable,|,init_advs,init_coms,init_dext,init_docs,init_types,init_users,
,sysuserid,|,admin,master,peace,lihan,xiecy,shierly,xieys,
,sysvariable,|,api,act,file,view,mod,parts,
,abase,cbase,db,dop,so,cv,fm,
,vop,vob,tplname,tag,close,imcfg,extra,first,route,script,query,
,tpl,|,store,static,adm,app,chn,dev,eng,mob,umc,res,
,jsvars,|,jselm,jsElm,
,fix,pre,|,exp,cnt,seo,tex,
,search,|,stype,sfid,sfop,sfkw,
'; 

//u?_,ex_,rel,



/*******************************************************************************
 File : \code\cfgs\sycfg\sy_modstat.php 
*******************************************************************************/
<?php
$_sy_modstat = array(
	'docs' => array('cargo','news','topic','faqs','indoc'),
	'coms' => array('corder','gbook','nrem','inread','trem'),
	'users' => array('person','adminer','inmem','company','organize'),
	'advs' => array('adtext','adpic','adblock',),
);




/*******************************************************************************
 File : \code\cfgs\sycfg\sy_pubcfg.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
global $_cbase;

//发布配置
$ocfgs = glbConfig::read('outdb','ex');

//main,vary,vimp
$_sy_pubcfg = array();

//1. dirs
$_sy_pubcfg['dirs'] = array(
	'code'=>DIR_CODE,
	'root'=>DIR_ROOT,
	'dtmp'=>DIR_DTMP,
	'html'=>DIR_HTML,
	'ures'=>DIR_URES,
	'static'=>DIR_STATIC,
	'vendor'=>DIR_VENDOR,
	'vendui'=>DIR_VENDUI,
);

//2. copy
$_sy_pubcfg['copy'] = array(
	'robots.txt',
	'chn.php',
	'dev.php',
	'doc.php',
	'mob.php',
	'index.php',
);

//3. ids
$_sy_pubcfg['ids'] =  array(
	array('dtmp','/dset/_score.cfg.php',array('close_chn'=>'1')), //安装标记
);

//4. parts
$_sy_pubcfg['parts'] =  array(
	'main' => array('code','root'),
	'vary' => array('dtmp','html','ures'),
	'vimp' => array('static','vendor','vendui'),
);

//5. cdemo
// - 是否有个-cdemo文件
// - 替换
$_sy_pubcfg['cdemo'] =  array(
	'code/cfgs/excfg/ex_mail.php' =>'',
	'code/cfgs/excfg/ex_sms.php' =>'',
	'code/cfgs/excfg/ex_a3rd.php' =>'',
	'root/run/_paths.php' => array(
		array("'/txmao'",),
		array("''",),
	), 
	'code/cfgs/boot/cfg_db.php' => array(
		array("'".glbDBObj::getCfg('db_name')."';", "'".glbDBObj::getCfg('dc_prefix')."';", ),
		array("'".devSetup::setDbname()."';",       "'".basKeyid::kidRand('f',5)."';",),
	),
	'code/cfgs/boot/cfg_adbug.php' => array(
		array("'ut.<rnd8>';",                       "'up.<rnd12>';",),
		array("'ut.".basKeyid::kidRand('f',8)."';", "'up.".basKeyid::kidRand('f',12)."';",),
	),	
	'code/cfgs/boot/const.cfg.php' => array( 
		array("'".$_cbase['ck']['pre']."';", "'".$_cbase['sys']['sn']."';",),
		array("'".basKeyid::kidRand('f',5)."';", "'".comConvert::sysSn()."';",), 
	), //sn, ver, sign
	'code/cfgs/excfg/ex_outdb.php' => array( 
		array("'".$ocfgs['sign']['sapp']."';",   "'".$ocfgs['sign']['skey']."';",   "'".$ocfgs['psyn']['server']."';",), 
		array("'".basKeyid::kidRand('k',24)."';", "'".basKeyid::kidRand('f',36)."';", "'http://master.domain.com/root';",),
	), 
);

//6. rndata
$_sy_pubcfg['rndata'] =  array(
	//'tab' => array("kid IN ('admin','peace')",'token,appid,appsecret'),
	'base_paras' => array("model='prsafe'",'val'),
	'wex_apps' => array("1=1",'token,appsecret'),
	'bext_paras:1' => array("kid='push_token'",'detail'),
	'bext_paras:2' => array("kid='push_site'",'detail',array('detail'=>'www.your_domain.com')),
);

//7. skip-dirs
$_sy_pubcfg['skip'] =  array(
	'vendor' => array('ks-buzz','Monolog','psrlog','silex','Symfony'),
);
//8. skip-files
$_sy_pubcfg['skfiles'] =  array(
	'wetest.php', // a3rd/weixin_pay/
	'_setfix_path.txt', // dtmp:/store/
	'_setup_lock.txt',
	'_setup_step.txt',
	'simkai.ttf', // static:/media/fonts/
	'hello.3gpp', // static:/media/sample
	'movecar.3gp',
	'sample.avi',
	'sample.flv',
	'ZoomImg.rar',
	'demo-book1.xls',
	'demo-word.doc',
	'demo-ppt.pptx',
	'xbbs_Dance.gif', // static:/media/collect/
	'xbbs_Pazz.gif',
	'xditu.jpg',
	'zuowen_shangxin.jpg',
	'temp_480x200.jpg',
	'dbdic-cn.cac_htm', // vary:/dtmp/store/
	'dbdic-en.cac_htm',
	'_auto.cfg_php',
	'_china.cfg_php',
	'_world.cfg_php',
	'CN-tab.php', // static:/media/iptabs/
	'haibao.jpg', // static:/media/cover/
	'100-gushi.jpg', // static:/file_demo1/
	'cacert.pem', // vendor:/a3rd/alipay_class/
);




/*******************************************************************************
 File : \code\cfgs\sycfg\sy_sysids.php 
*******************************************************************************/
<?php
$_sy_sysids = array(
	'GET' => array('fm','fs'), //get,post
	'Title' => array('file','bsend','fs_do','kid','did','uid','uname','cid','sid','aid','pid','isadd'),
	'Key' => array('mod','view','parts','act'), 
	'N' => array('dialog','frame',), //Number
);


/*******************************************************************************
 File : \code\cfgs\sycfg\sy_uachk.php 
*******************************************************************************/
<?php
$_sy_uachk = array(
	//Spider名称关键字
	'spname' => 'Bot|Crawl|Spider|slurp|sohu-search|lycos|robozilla', 
	//Browser名称关键字
	'browsers' => 'MSIE|Netscape|Opera|Konqueror|Mozilla|Trident', 
	//Spider-UserAgent名称关键字
	'spkeywd' => "blackberry|configuration\\/cldc|hp |hp-|htc |htc_|htc-|iemobile|kindle|midp|mmp|motorola|mobile|nokia|opera mini|opera |Googlebot-Mobile|YahooSeeker|android|iphone|ipod|mobi|palm|palmos|pocket|portalmmm|ppc;|smartphone|sonyericsson|sqh|spv|symbian|treo|up.browser|up.link|vodafone|windows ce|xda |xda_",
);


/*******************************************************************************
 File : \code\cfgs\sycfg\sy_updvnow.php 
*******************************************************************************/
<?php
// 
$_sy_updvnow['compcfgs'] = array(

	'cfgs/boot/cfg_adbug.php',	
	'cfgs/boot/cfg_db.php',
	'cfgs/boot/cfg_load.php',
	'cfgs/boot/const.cfg.php',
	
	'cfgs/excfg/ex_a3rd.php',
	'cfgs/excfg/ex_ipstop.php',
	'cfgs/excfg/ex_mail.php',
	'cfgs/excfg/ex_outdb.php',
	'cfgs/excfg/ex_paras.php',
	'cfgs/excfg/ex_sfdata.php',
	'cfgs/excfg/ex_simpass.php',
	'cfgs/excfg/ex_sms.php',
	'cfgs/excfg/ex_vopfmt.php',
	'cfgs/excfg/ex_wmark.php',
	
	'cfgs/scfile/ex_fadm.php',
	
	'cfgs/sycfg/sy_keepid.php',
	'cfgs/sycfg/sy_urdirs.php',
	
	'run/_paths.php', 
	
);

$_sy_updvnow['dellist'] = array(
	
	# - delete list ~ 2016-05-18
	'root/:.htaccess,robots.txt',
	'root/run/:chn.php,dev.php,mob.php',
	'code/tpls/chn/m_user/',
	'code/flow/cron/',
	'root/tools/setup/update.php',
	'readme.htm',
);




/*******************************************************************************
 File : \code\cfgs\sycfg\sy_urdirs.php 
*******************************************************************************/
<?php
// 附件资源管理:菜单/目录
$_sy_urdirs = array(
	'basic'   => array('comms','static','icons/basic'),
	'logo'    => array('comms','wrskin','skin/logo'),
	'collect' => array('comms','static','media/collect'),
	'sample'  => array('comms','static','media/sample'),
	'icon18'  => array('icons','static','icons/file18'),
	'icon36'  => array('icons','static','icons/file32'),
	'icona'   => array('icons','wrskin','skin/a_img'),
	'office'  => array('files','static','file_office'),
	'image'   => array('files','static','file_image'),
	'video'   => array('files','static','file_video'),
	'audio'   => array('files','static','file_audio'),
	'demo1'   => array('files','static','file_demo1'),
	//'demo2'   => array('files','static','file_demo2'),
);



/*******************************************************************************
 File : \code\core\blib\basArray.php 
*******************************************************************************/
<?php

// Array类
class basArray{	
	
	// 按数组值长度获取部分项
	static function lenParts($ara,$arb,$nlen,$mlen=15) {
		if(empty($ara)) return array();
		$rea = $reb = array();
		foreach ($ara as $k=>$val) {
			$len = mb_strlen($val,'UTF8');
			if($len>=$mlen){
				$len = $mlen;
			}
			if($nlen==$len){
				$rea[] = $val;
				$reb[] = $arb[$k];
			} 
		} //dump($rea); dump($reb);
		return array($rea,$reb);
	}

	// 按数组值长度排序
	static function lenOrder($arr,$mlen=15,$re='lenkey') {
		if(empty($arr)) return array();
		$arb = $arc = array(); // 
		foreach($arr as $val){
			$len = mb_strlen($val,'UTF8');
			if($len>=$mlen) $len = $mlen;
			$arb[$len][] = $val;
		}
		if($re=='lenkey'){
			return $arb;
		}
		for($i=$mlen; $i>=1; $i--) { 
			if(empty($arb[$i])) continue;
			$arc = array_merge($arc,$arb[$i]);
		}
		return $arc;
	}

	// 从Object转化为array
	static function fromObject($obj,$skip='') {
	    $ref = new ReflectionClass($obj); 
	    $props = $ref->getProperties(); 
	    $arr = array();
        if($skip=='def'){ 
            $skips = array('top','auser','atime','aip','euser','etime','eip'); 
        }else{
            $skips = array();
        }
	    foreach ($props as $prop) {
            $prop->setAccessible(true);
            $key = $prop->getName();
            if(in_array($key,$skips)){
                continue;
            }
            $arr[$key] = @$prop->getValue($obj);
            $prop->setAccessible(false);
	    }
	    return $arr;
    }
	// 从文件获取array
	// cfgs: start, end, len
	// skips: array('//','---','###') 
	static function fromFile($file,$cfgs=array()){
		if(!file_exists($file)) return array();
		$arr = file($file); $re = array(); 
		$cfgs['len'] = isset($cfgs['len']) ? $cfgs['len'] : 6;
		foreach($arr as $row){
			$row = str_replace(array("\r","\n"),'',$row);
			if(!empty($cfgs['start']) && strpos($row,$cfgs['start'])){
				$re = array();
				continue;
			}
			if(!empty($cfgs['end']) && strpos($row,$cfgs['end'])){
				break;
			}
			if(!empty($cfgs['len']) && strlen($row)<$cfgs['len']){
				continue;
			}
			if(!empty($cfgs['skips']) && self::inStr($cfgs['skips'],$row)){
				continue;
			}
			$re[] = $row;	
		}
		return $re;
	}
	
	// 从字段获得option的array
	static function opaFields($items,$types=''){  
		$a = array();
		foreach($items as $k=>$v){ 
			if(empty($types) || strstr($types,$v['dbtype'])){
				$a[$k] = $v['title'];
			}
		}
		return $a;
	}
	// 从类别获得option的array
	static function opaItems($items,$types='',$frame=1){  
		$a = array();
		foreach($items as $k=>$v){ 
			$k2 = ($frame && !empty($v['frame'])) ? "^group^$k" : $k;
			$a[$k2] = (@$v['deep']>'1' ? str_repeat('&nbsp;',2*@$v['deep']) : '').$v['title'];
		}
		return $a;
	}
	
	// 比较数组:
	// basArray::cmpArr($new,$old,'Item'); //code,item
	static function cmpArr($new,$old,$type='code'){
		$method = "cmp$type"; 
		$res = array('new'=>'','old'=>''); 
		foreach(array('new','old') as $key){ 
			foreach($$key as $ki=>$val){ 
				$one = self::$method(($key=='new' ? $old : $new),$val,$ki);
				$res[$key] .= "<li class='$one[1]'>$one[0]</li>\n";
			}
		}
		similar_text(var_export($new,1),var_export($old,1),$per);
		$res['per'] = $per;
		return $res;
	}
	// 在一个数组中，比较一行配置代码；
	static function cmpCode($arr,$val){
		$valbak = $val;
		$val = trim(str_replace(array('<','>',"\n","\r"),array('&lt;','&gt;','',''),$val));
		$fphp = self::inArr($arr,'<?');
		$fnote = substr($val,0,2)=='//' || substr($val,0,1)=='#';
		if(strlen($val)<3 || ($fphp && $fnote)){
			$cls = 'gray'; $val .= "";
		}elseif(!in_array($valbak,$arr)){
			$cls = 'cF00';
			if(strpos($val,",") && strstr($val,'define(')){
				$tmp = explode(",",$val);
				if(!empty($tmp[0]) && self::inArr($arr,trim($tmp[0]))){ 
					$val = $tmp[0].",<span class='c00F'>".substr($val,strlen($tmp[0])+1)."</span>"; 
					$cls = ''; 
				}
			}elseif(strpos($val,'=')){
				$tmp = explode('=',$val);
				if(!empty($tmp[0]) && self::inArr($arr,trim($tmp[0]))){
					$val = $tmp[0]."=<span class='c00F'>".substr($val,strlen($tmp[0])+1)."</span>"; 
					$cls = ''; 
				}
			}
		}else{
			$cls = '';	
		}
		return array($val,$cls);
	}
	// 在一个数组中，比较另一数组的一项；
	static function cmpItem($arr,$val,$ki){
		$cls = ''; $valbak = $val; //备份用于比较, 以下转码用于显示
		$val = trim(str_replace(array('<','>',"\n","\r"),array('&lt;','&gt;','',''),$val));
		if(is_numeric($ki)){ //数字键
			$cls = in_array($valbak,$arr) ? '' : 'cF00'; 
		}elseif(!isset($arr[$ki])){ //不存在
			$cls = 'cF00'; 
		}elseif($arr[$ki]!=$valbak){ //不相等
			$val = "<span class='c00F'>$val</span>"; 
		}
		$val = "[$ki] => $val";
		return array($val,$cls);
	}
	
	// 检测str中,是否包含$arr中的某项
	// $arr="aaa|bbb"; 可以是|分割的字符串
	// basArray::inStr(array('org','com','net'),'xys@163.com');
	static function inStr($arr,$str){  
		if(empty($str)) return false;
		if(is_string($arr)) $arr = explode('|',$arr); 
		foreach($arr as $v){ 
			if(strstr($str,$v)){
				return true;
			}
		}
		return false;
	}
	
	// 检测$arr中，是否某项包含了str字符串
	// $arr="aaa|bbb"; 可以是|分割的字符串
	// basArray::inArr(array('163.org','163.com','163.net'),'.cn');
	static function inArr($arr,$str){  
		if(empty($str)) return false;
		if(is_string($arr)) $arr = explode('|',$arr); 
		foreach($arr as $v){ 
			if(strstr($v,$str)){
				return true;
			}
		}
		return false;
	}

	/** 
	 * 多维数组的合并(相同的字符串键名，后面的覆盖前面的) 
	 * @param array $array1 
	 * @param array $array2 (先判断array2是不为空的数组)
	 */  
	static function Merge($array1,$array2){ 
		if(is_array($array2) && !empty($array2)){//不是空数组的话  
			foreach($array2 as $k=>$v){  
				if(is_array($v) && !empty($v)){  
					if(isset($array1[$k])) $array1[$k] = self::Merge($array1[$k], $v);  
					else $array1[$k] = $v;  
				}else{  
					if(!empty($v)){
						$array1[$k] = $v;  
					}  
				}  
			}  
		}else{  
			$array1 = $array2;  
		}  
		return $array1;  
	} 
	
	// array next元素key
	static function nextKey($a,$key){
		$flag = 0; $no = 0;
		foreach($a as $k=>$v){
			$no++;
			if($flag){
				return $k;
			}
			if($k===$key){
				$flag = 1;
			}
		}
		return '';
	}
	
	/**
	 * 按数组中指定键的值，对数组进行排序
	 * 
	 * @param array  $array 	要排序的数组
	 * @param string $orderkey  指定排序的键，以其值排序
	 * @param bool   $keepkey 	数字键名是否需要保持不变
	 */ 
	static function msort(array &$array, $orderkey='top', $keepkey=false){
		if(!is_array($array) || empty($array) || !function_exists('array_multisort')) return;
		foreach($array as $k => $v){
			$vorder[$k] = $array[$k][$orderkey] = empty($v[$orderkey]) ? 0 : $v[$orderkey];
			$eorder[$k] = $k;
			if($keepkey) $array[$k]['_key'] = $k;
		}
		array_multisort($vorder,SORT_ASC,$eorder,SORT_ASC,$array);
		if($keepkey){
			$na = array();
			foreach($array as $k => $v){
				$key = $v['_key'];
				unset($v['_key']);
				$na[$key] = $v;
			}
			$array = $na;
		}
	}
	
	/**
	 * 根据$Key读取数组中的值			
	 * @param  array  		$array 				源数组
	 * @param  string  		$Key 				键名，支持'xx.kk.dd'得到$array['xx']['kk']['dd']
	 */
	static function get($array=array(), $Key=''){
		if(!is_array($array)) return NULL;
		if(!($KeyArray = self::ParseKey($Key))){
			return NULL;
		}
		foreach($KeyArray as $k){
			$array = isset($array[$k]) ? $array[$k] : NULL;
		}
		return $array;
	}
	
	/**
	 * 根据$Key设置数组中的值
	 * @param  string  		$Key 				键名，支持'xx.kk.dd'为$array['xx']['kk']['dd']赋值
	 * @param  string  		$value 值			需要设置的值
	 * @param  array  		$array 				源数组
	*/
	static function set(&$array, $Key='',$Value=0){
		if(!is_array($array)) return;
		if(!($KeyArray = self::ParseKey($Key))) return;
		$level = count($KeyArray) - 1;
		foreach($KeyArray as $k => $v){
			if($k < $level){
				$array[$v] = isset($array[$v]) && is_array($array[$v]) ? $array[$v] : array();
				$array = &$array[$v];
			}else{
				$array[$v] = $Value;
			}
		}
	}
	
	/**
	 * unsetVal
	 */
	static function unsetVal(&$arr,$unval){
		foreach($arr as $k => $v){
			if($v==$unval){
				unset($arr[$k]);
				break;
			}
		}
		return $arr;
	}

	/**
	 * 将组合键名(以'.'连接)分解为数组
	 * @param  string  $key			键名字串
	 * @param  string  $AllowDot	是否允许包含连接符'.'
	 */
	static function ParseKey($Key=''){
		$Key = preg_replace('/[^\w\.]/', '', (string)$Key);
		if($Key === '') return false;
		return explode('.',$Key);
	}
	
}




/*******************************************************************************
 File : \code\core\blib\basDebug.php 
*******************************************************************************/
<?php

// basDebug
class basDebug{	

	/* *****************************************************************************
	  *** debug通用代码 
	- var,bug前缀
	- by Peace(XieYS) 2012-02-18
	***************************************************************************** */
	
	// *** 显示变量 
	static function varShow($val,$flag=''){	
		echo "\r\n<pre style='line-height:150%;'>"; 
		if($flag) echo "[$flag]\r\n"; $flag = 0;
		if(is_array($val)) echo "[a:".count($val)."] "; 
		elseif(is_string($val)) echo "[s:".strlen($val)."] ";
		elseif(is_numeric($val)) echo "[n:".strlen($val)."] ";
		elseif(is_object($val)) echo "[obj] ";
		else{ echo "[unknow] "; } // ,"\n"
		echo str_replace(array('<','>'),array('&lt;','&gt;'),var_export($val,1));
		echo "</pre>\r\n";
	}
	// *** 变量列表
	static function varList($act,$url){
		$cnt=0; $sv=''; $sc=''; $se=''; $sf=1;
		foreach ($GLOBALS as $k => $v) { 
			if((is_array($v)&&$act=='arrs')||(is_object($v)&&$act=='objs')){
				echo "\r\n<a href='$url&_deKey=$k'>$k</a><br>";
				$cnt++;
			}else if((!is_array($v))&&(!is_object($v))&&$act=='vars'){
				if(isset($_SERVER[$k])) { $sf=0; $sv .= "$k, "; }
				if(isset($_COOKIE[$k])) { $sf=0; $sc .= "$k, "; }
				if(isset($_SESSION[$k])) { $sf=0; $se .= "$k, "; }
				if($sf) echo "\r\n$k=[".htmlspecialchars($v)."]<br>";  
				$cnt++; $sf=1;
			} 
		}
		$s = empty($sv)?'':"\r\n[_SERVER]: $sv<br>"; 
		$s .= empty($sc)?'':"\r\n[_COOKIE]: $sc<br>"; 
		$s .= empty($se)?'':"\r\n[_SESSION]: $se<br>"; 
		echo $s;
		return $cnt;
	}
	// *** 系统变量-控制台
	static function varMain($url="?_deTest=peaceTest"){ // eg: ?action=$action 
		$_deAct = isset($_GET['_deAct'])?$_GET['_deAct']:'vars'; 
		$_deKey = isset($_GET['_deKey'])?$_GET['_deKey']:'';	 
		if($_deAct=='info'){ ob_end_clean(); phpinfo(); die(); }
		echo "\n<div style='line-height:150%;'> Debug Menu: ";
		foreach(array('vars','arrs','objs','info') as $k) echo "\n<a href='$url&_deAct=$k'>$k</a>&nbsp;"; 
		echo "\nDebug Now: [".($_deKey?$_deKey:$_deAct)."]\n<hr>";
		if($_deKey!='') self::varShow($GLOBALS[$_deKey]); 
		else $_deKey = self::varList($_deAct,$url);
		echo "\n<hr>\n All: [$_deKey] End.";
		echo " Memory: ".round(memory_get_usage()/1024/1024, 3)." MB\n";
	}
	// 运行统计信息
	// tq : tpl, qstr, auto
	static function runInfo($tq='auto'){ 
		$run = cfg('run');
		$qtime = $run['qtime'];
		$rtime = microtime(1) - $run['timer'];
		if($rtime>1){
			$unit = 's'; 
			$qtime = number_format($qtime,4);
			$rtime = number_format($rtime,4);
		}else{
			$unit = 'ms';
			$qtime = number_format($qtime*1000,3);
			$rtime = number_format($rtime*1000,3);
		} // Done in 0.253444 sec(s), 12 queries .
		$info = "Done:$qtime/$rtime($unit); ";
		$info .= "".$run['query']."(queries)/".round(memory_get_usage()/1024/1024, 3)."(MB); ";
		$route = empty($_SERVER['PATH_INFO']) ? '' : "Route:".$_SERVER['PATH_INFO']."; ";
		$tpl = "Tpl:".(empty($run['tplname']) ? '(null)' : $run['tplname'])."; "; //tpl 
		$qstr = "[".(empty($_SERVER['QUERY_STRING']) ? '(null)' : $_SERVER['QUERY_STRING'])."] "; //qstr
		$auto = empty($route) ? (empty($run['tplname']) ? $qstr : $tpl) : $route;
		$info .= $$tq."Upd:".date('Y-m-d H:i:s')." "; // str_replace('T',' ',date(DATE_ATOM))
		return $info;
	}
	// 运行Load
	static function runLoad($pre=0){  
		$aclass = cfg('run.aclass');
		$fix = $pre ? 'pre' : '!--';
		$tmp = self::hidInfo($aclass);
		echo "\n".($pre ? '<pre>' : '<!--'); 
		print_r($tmp); 
		echo "</".($pre ? '</pre>' : '-->'); 
		
	}
	// 调试停止
	static function bugStop($url="?_deTest=peaceTest"){ 
		$_deAct = isset($_GET['_deAct'])?$_GET['_deAct']:''; 
		if($_deAct) self::varMain("$url&_deAct=$_deAct");
		else{
			foreach(array('vars','arrs','objs','info') as $k) echo "\n<a href='$url&_deAct=$k'>$k</a>&nbsp;"; 
			echo "\nMemory: ".round(memory_get_usage()/1024/1024, 3)." MB\n";
		}
		die();
	}
	// *** 系统参数
	static function bugPars($pars='',$from=array('GET','SESSION')){
		$re = ''; //'GET','POST','COOKIE','SESSION'
		$arr = explode(';',str_replace(array(','),';',$pars)); 
		foreach($arr as $k){
			foreach($from as $m){ 
				$f = "_$m"; $n = $GLOBALS[$f]; 
				$v = isset($n[$k]) ? $n[$k] : false; 
				if($v!==false) $re .= "$k($m)=$v; ";
			} 
		}
		return $re;
	}
	// *** 捕获系统状态信息
	static function bugInfo(){
		$info = array(); 
		$info['ram'] = memory_get_usage(); 
		$info['run'] = microtime(1); 
		$info['vp'] = $_SERVER['REQUEST_URI'];
		$info['rp'] = isset($_SERVER['HTTP_REFERER'])?$_SERVER['HTTP_REFERER']:'(null referer)';
		foreach(array('vp','rp') as $k){
			$info[$k] = str_replace(array("'","\\"),array("`","#"),$info[$k]);
		}
		$info['ip'] = basEnv::userIP(1);
		$info['ua'] = basEnv::userAG();
		return $info;
	}
	// *** 错误信息($msg):mod:file-保存到文件; db-数据库; (空)-输出
	static function bugLogs($act='',$msg=array(),$path='detmp',$mod=''){ 
		global $_cbase;
		$mod || $mod = $_cbase['debug']['log_save']; //show,db,file
		$info = self::bugInfo();
		$info['run'] = 1000*($info['run'] - $_cbase['run']['timer']);
		if(is_array($msg)){
			$re = '';
			foreach($msg as $k=>$v){ $v = is_array($v) ? '[Array]' : $v; $re .= "$k=$v; "; }
			$msg = $re;
		}
		if($mod!='db'){
			$data = "\nact=$act@".date('Y-m-d H:i:s',$_cbase['run']['stamp'])."<br>";
			$data .= "\nused=$info[run]/$info[ram]<br>";
			$data .= "\npage=$info[vp]<br>\nrp=$info[rp]<br>";
			$data .= "\nip=$info[ip]<br>\nua=$info[ua]<br>";
			$data .= "\n$msg<br>\n";
		}
		if(empty($mod) || $mod=='show'){ // show
			$dcss = "border:1px solid #F00; background-color:#FFFFCC; padding:8px; margin:5px; clear:both; display:block;";	
			print_r("\n\n<div style=\"$dcss\">$data</div>\n\n");
		}elseif($mod=='db'){
			$db = glbDBObj::dbObj();
			$kid = basKeyid::kidTemp();
			$vals = "'$kid','$act','$info[run]','$info[vp]','$info[rp]','".basReq::in($msg)."','$info[ip]','{$_cbase['run']['stamp']}','$info[ua]'";
			$db->db->run("INSERT INTO ".$db->table("logs_$path",2)."(kid,`act`,used,page,pref,note,aip,atime,aua)VALUES($vals)"); 	
		}else{ // file
			$data = str_replace("<br>\n","\n",$data);
			if(!$path){
				$file = "debug/".date('Y-md').".debug"; 
			}elseif(!strstr($path,"/")){
				$file = "debug/$path"; 
			}else{
				$file = $path; 
			} 
			if(!strstr($file,'debug/')) $ftmp = "debug/$file";
			else $ftmp = "$file"; 
			comFiles::chkDirs(str_replace("//","/",$ftmp),'tmp');
			$file = str_replace("//","/",DIR_DTMP."/$ftmp"); 
			$fh = fopen($file, "a+");
			fwrite($fh, "\n$data");
			fclose($fh);
		}
	}
	
	// 隐藏:根路径,表前后缀
	static function hidInfo($str='',$db=0){
		if(!$db){ // DIR_IMPS, DIR_VARS ,dirname(DIR_PROJ)
			$str = str_replace(array(DIR_PROJ,DIR_IMPS,DIR_VARS),'~',$str); 
		}else{
			$cdb = glbConfig::read('db','cfg');
			foreach(array('pre','suf') as $key){
				$fix = $cdb["db_{$key}fix"];
				if(!empty($fix)){
					$str = str_replace(array(" $fix","$fix "),array(" {pre}","{suf} ",),$str);
				}
			}
		}
		return $str;
	}

	
}




/*******************************************************************************
 File : \code\core\blib\basElm.php 
*******************************************************************************/
<?php

// Element基本html元素类
class basElm{	

	// option,"upd|更新;del|删除;show|启用", 符号;\n表示一行, 符号,|=分开键值
	//		"upd,更新;del|删除\nshow=启用"
	static function setOption($cfgs,$val='',$title='-<Null>-'){
		$title = $title=='-<Null>-' ? lang('core.opt_first') : $title;
		$cfgs = self::text2arr($cfgs); //print_r($cfgs);
		if($title) $cfgs = array(''=>$title) + $cfgs; 
		$str = '';
		foreach($cfgs as $k=>$v){ 
			$v = is_string($v) ? $v : $v['title']; // isset($v['title']), 某些环境下出错...
			if(strstr($k,'^group^')){
				$str .= "\n<optgroup label='$v'></optgroup>";
			}else{
				$def = "$val"==="$k" ? 'selected' : ''; 
				$str .= "\n<option value='$k' $def>$v</option>";	
			}
		}
		return $str;
	}
	// checkbox,
	static function setCBox($k0,$cfgs,$val='',$brn=0){
		$cfgs = self::text2arr($cfgs);
		$varr = empty($val) ? array() : explode(',',$val);
		$str = "\n<input id='fm[$k0][]' name='fm[$k0][]' type='hidden' value='' />"; 
		$i = 0; $j = 0;
		foreach($cfgs as $k=>$v){ $i++; $j++;
			$v = is_string($v) ? $v : $v['title'];
			$def = in_array($k,$varr) ? " checked='checked' " : '';
			if($brn && $j>$brn) { $str .= "<br>"; $j=1; }
			$str .= "\n<label><input type='checkbox' class='rdcb' name='fm[$k0][]' id='fm_{$k0}_$i' value='$k' $def>$v</label>";
		}
		return $str;
	} // array_shift(), array_filter()
	// radio,
	static function setRadio($k0,$cfgs,$val='',$brn=0){
		$cfgs = self::text2arr($cfgs);
		$str = ""; $i = 0; $j = 0;
		foreach($cfgs as $k=>$v){ $i++; $j++;
			$v = is_string($v) ? $v : $v['title'];
			$def = "$val"==="$k" ? " checked='checked' " : '';
			if($brn && $j>$brn) { $str .= "<br>"; $j=1; }
			$str .= "\n<label><input type='radio' class='rdcb' name='fm[$k0]' id='fm_{$k0}_$i' value='$k' $def>$v</label> ";
		}
		return $str;
	}
	
	// arr2text: full,外观图;side,侧面图;inn,内部图;att,附件图;
	static function arr2text($arr,$row=';',$col=','){ 
		if(is_string($arr)) $arr = self::text2arr($arr);
		$s = '';
		foreach($arr as $k=>$v){
			$s .= "$k$col$v$row";
		}
		return $s;
	}
	// form: text2arr
	static function text2arr($text){ 
		$_groups = glbConfig::read('groups'); 
		if(is_array($text)){
			if(isset($text['title']) && !empty($text['cfgs'])) return self::text2arr($text['cfgs']);
			return $text;
		}elseif(empty($text)){ 
			return array();
		}elseif(isset($_groups[$text])){ 
			$cfg = glbConfig::read($text); 
			$rei = $cfg['i']; 
			foreach($rei as $k=>$v){ 
				$re[$k] = $v['title'];
			}
		}elseif(strstr($text,'bext_paras.')){ //bext_paras.logmode_cn[.userkey]
			$re = glbDBExt::getExtp(substr($text,11));
		}elseif(strpos($text,'.') && !(strpos($text,"\n")||strpos($text,"\r"))){ //corder.ordstat
			$t = explode('.',$text);
			$mcfg = glbConfig::read($t[0]); 
			$re = self::text2arr($mcfg['f'][$t[1]]['cfgs']);
		}else{
			/*
			$text = str_replace(array(' ','|',','),array('','=','='),$text);
			$text = str_replace(array("\r\n","\n\r","\n","\r",";"),'&',$text);
			parse_str($text, $re);*/
			//*
			$a = self::line2arr($text,1,';'); $re = array();
			foreach($a as $v){ //fmadm=1234567890,abcdefg
				$v = str_replace(array(' '),'',$v);
				$t = explode("=",str_replace(array('|',','),'=',$v)); 
				$len0 = strlen($t[0]); $t[1] = isset($t[1]) ? $t[1] : $t[0]; //无=则[val=text],兼容[array('0'=>'')]，
				if($len0 && isset($t[1])) $re[$t[0]] = substr($v,$len0+1); 	
			}
		} // 不用array()-eval[]了*/
		return $re;
	}
	static function line2arr($text,$rea=1,$extf=''){ 
		if(!empty($extf)){ $text = str_replace($extf,"\n",$text); }
		$text = str_replace(array("\r\n","\r"),"\n",$text);
		$text = str_replace(array("\n\n\n\n","\n\n\n","\n\n"),"\n",$text);
		if($rea) $text = explode("\n",$text);
		return $text;
	}

	// 格式化标签
	static function fmtFlag($flag){  
		if(is_string($flag) && strpos($flag,'(*)')){ $af = explode('(*)',$flag); }
		else{ $af = is_array($flag) ? $flag : array("<$flag>","</$flag>"); }
		return $af;
	} 
	// 获取xml/html标签 的一个值 或 一个innerHTML
	// 标签法 ($data,'<div class="content">(*)</div>') 或 ($data,'class="content"(*)</div>','>')
	static function getVal($xStr,$flag,$fix=0){  
		$af = self::fmtFlag($flag); 	
		$p1 = strpos($xStr, $af[0]); $len1 = strlen($af[0]);
		if(empty($fix)){
			$p1 = $p1+$len1;
		}elseif(is_numeric($fix)){
			$p1 = $p1+$len1+$fix;
		}else{
 			$tmp = substr($xStr,$p1+$len1);
		 	$at['op'] = substr($fix,0,1); // +,-
			$at['val'] = substr($fix,1);  // <td>, </div>
			$pt = strpos($tmp, $at['val']); $lent = strlen($at['val']); 
			$pt = $at['op']=='+' ? $pt : $pt+$lent; 
			$p1 += $len1+$pt;
		}
		$xStr = substr($xStr,$p1); 
		$tag = '<'.strtolower(substr($af[1],2,strlen($af[1])-3)); // </div> -=> <div
		$a2 = explode($af[1],$xStr); $p2 = 0; // $a[1] = </div>, id="link" 
		foreach($a2 as $v2){
			if(strstr(strtolower($v2),$tag)){
				$p2 += strlen($v2)+strlen($af[1]);
			}else{
				$p2 += strlen($v2); 
				break;
			}
		} 
		$xStr = substr($xStr,0,$p2);
		return $xStr;
	}  
	// 获取xml/html标签 的一个值 或 一个innerHTML
	// 定点法 ($data,'<div class="content">(*)id="link"')
	static function getPos($xStr,$flag){  
		$af = self::fmtFlag($flag); 
		$p1 = strpos($xStr, $af[0]); 
		$xStr = is_int($p1) ? substr($xStr,$p1+strlen($af[0])) : '';
		$p2 = strpos($xStr, $af[1]); 
		$xStr = is_int($p2) ? substr($xStr, 0, $p2) : '';
		return $xStr;
	}
	// 获取xml/html标签 的一组值 或 一组innerHTML 加参数$no获取单个下标
	// 标签法 ($data,'<li class="cls22">(*)</li>') 或 ($data,'<li class(*)</li>')
	static function getArr($xStr,$flag,$no=-1){  
		$af = self::fmtFlag($flag); 
		$a2 = explode($af[0],$xStr); $re = array();
		foreach($a2 as $k2=>$v2){
			if($k2==0) continue;
			$p1 = substr($af[0],-1)!='>' ? strpos($v2,'>') : 0; 
			$p2 = strpos($v2,$af[1]);
			if(is_int($p2)){ 
				$re[] = substr($v2,$p1,$p2-$p1);
			}
		}
		if($no==-1) return $re;
		else return isset($re[$no]) ? $re[$no] : '';
	}
	// 获取xml/html标签 的一组值 或 一组innerHTML 加参数$no获取单个下标
	// 正则法 ($data,'<li class="cls1">(*)</li>') //  [\\d]{1,4}  
	static function getPreg($xStr,$flg1,$reg="[^\n|\r]{1,1200}",$no=-1){  
		$flag = preg_quote($flg1); // =\(\*\)
		$flag = str_replace("/","\\/",$flag);
		$flag = str_replace('\(\*\)',"($reg)",$flag); //echo "(($flag))";
		preg_match_all("/$flag/i",$xStr,$m);
		if($no==-2){
			return $m;
		}elseif($no==-1){
			return $m[1];
		}else{ 
			return isset($m[1][$no]) ? $m[1][$no] : '';
		}
	}
	// 获取xml/html标签 的一组属性 加参数$no获取单个下标
	// ($data,'witdh','val',1) 或 ($data,'href','url')
	static function getAttr($str,$flag,$reg='key',$no=-1){ 
		if(strlen($reg)<=3){
			$a = array(
				'key' => '[\w]{2,24}',
				'url' => '[^"|\'|>| ]{1,120}', //"\S*", 
				'val' => '[^>]{1,255}',
			);
			$reg = $a[$reg];
		} 
		preg_match_all("/\b$flag=[\"|']*($reg)[\"|']*/i",$str,$attr); 
		$ra = empty($attr[1]) ? array() : $attr[1];
		$re = ($no==-1 || strlen($no)==0) ? $ra : (isset($ra[$no]) ? $ra[$no] : ''); 
		return $re;
	}

}




/*******************************************************************************
 File : \code\core\blib\basEnv.php 
*******************************************************************************/
<?php

// Environment基本环境处理类
class basEnv{	

	// 处理_pbase
	static function runPbase($_pbase){
		global $_cbase;
		// 加载runskip
		if(isset($_cbase['skip'])){
			include(DIR_CODE.'/cfgs/boot/bootskip.php'); 
		}
		// 全局系统配置
		if(!empty($_pbase)){ 
			if(!empty($_pbase)) $_cbase = basArray::Merge($_cbase, $_pbase);
		}
	}

	// 系统信息,魔术变量,时区
	static function runVersion(){
		if(version_compare(PHP_VERSION,'5.4.0','<')) {
			ini_set('magic_quotes_runtime',0);
		}
		date_default_timezone_set(cfg('sys.tzcode'));		
	}
	// const,
	static function runConst(){
		/*
		define('IS_CGI',	 substr(PHP_SAPI, 0,3)=='cgi' ? 1 : 0 );
		define('IS_WIN',	 strstr(PHP_OS, 'WIN') ? 1 : 0 );
		define('IS_CLI',	 PHP_SAPI=='cli'? 1   :   0);
		//define('IN_APP',   0);
		define('IN_MOBILE',  self::isMobile());
		define('IN_ROBOT',   self::isRobot());
		*/
		define('KEY_TAB36',  '0123456789abcdefghijklmnopqrstuvwxyz'); // 极端情况下用
		define('KEY_TAB32',  '0123456789abcdefghjkmnpqrstuvwxy'); // - iloz (字形可能与数字012混淆)
		define('KEY_TAB30',  '123456789abcdfghjkmnpqrstuvwxy'); // - 0e + iloz (0字形,e读音易混淆)
		define('KEY_TAB24',  '3456789abcdfghjkpqstuvwxy'); // - 012eilmnorz(25) (去除字形读音易混淆者)
		define('KEY_NUM10',  '0123456789');
		define('KEY_NUM16',  '0123456789abcdef'); 
		define('KEY_CHR26',  'abcdefghijklmnopqrstuvwxyz');	

	}

	// 前置处理,运行时常用变量
	static function runCbase(){
		global $_cbase;
		// 运行时常用变量,
		$_cbase['run']['domain'] = $_SERVER['SERVER_NAME'];
		$_cbase['run']['dmtop'] = self::topDomain($_cbase['run']['domain']);
		$_cbase['run']['stamp'] = intval($_cbase['run']['timer']);
		$_cbase['run']['userag'] = self::userAG();
		$_cbase['run']['userip'] = self::userIP();
		$_cbase['run']['query'] = 0; //查询次数
		$_cbase['run']['qtime'] = 0; //查询时间
		$_cbase['run']['jsimp'] = ','; //imp-js:files
		$_cbase['run']['tplname'] = ''; //tpl:name
		$_cbase['run']['tplnow'] = ''; //tpl:now
		$_cbase['run']['tagnow'] = ''; //vopShow::tagParse()使用
		$_cbase['run']['tags'] = ''; //tag:files (未使用?)
		$_cbase['run']['tagjs'] = ''; //tag:files  (未使用?)
		$_cbase['run']['tmpFile'] = array();
		$_cbase['run']['jtype_mods'] = ''; //fldView::lists()使用
		$_cbase['run']['jtype_init'] = ''; //fldView::lists()使用
		$_cbase['run']['sobarnav'] = ''; //dopBSo->Form()使用,搜索条上的导航
		$_cbase['tpl']['tplpend'] = ''; //默认'',除非人工改变
		$_cbase['tpl']['tplpext'] = ''; //默认'',除非人工改变
		//$_cbase['mkv'] = array();
		$_cbase['run']['headed'] = '';
		self::sysHome(); //,topDomain,IP过滤
	}
	
	// 处理skips
	static function runSkips(){
		$skip = cfg('skip');
		// 错误处理类 
		if(!isset($skip['error'])){
			self::runError();
		}
		// *** robot
		if(isset($skip['robot'])){
			safBase::robotStop(); 
		}
		// 处理session
		if(!isset($skip['session'])){ 
			if(!session_id()) @session_start();
		}
	}

	// 加载错误处理类 
	static function runError(){
		global $_cbase;
		// 加载错误处理类 
		if(!isset($_cbase['skip']['error']) && $_cbase['debug']['err_hand']){
			ini_set('display_errors', 'On');
			if($_cbase['debug']['err_mode']){
				error_reporting(E_ALL); 
			}else{
				error_reporting(0); 
			}
			$hkey = $_cbase['debug']['err_hkey'];
			$hkey = ($hkey=='(def)' || intval($hkey)<=0) ? E_ALL^E_WARNING^E_NOTICE : $_cbase['debug']['err_hkey']; 
			set_exception_handler('except_handler_ys'); //注册异常处理函数
			set_error_handler('error_handler_ys',$hkey); //注册错误处理函数
		}
	}

	// 获取客户端软件信息
	static function userAG(){
		$ua = empty($_SERVER['HTTP_USER_AGENT']) ? '' : $_SERVER['HTTP_USER_AGENT'];
		//basStr::filTitle($_SERVER['HTTP_USER_AGENT'])
		$ua = str_replace(array("'","\\"),array("",""),$ua);
		return $ua;
	}
	
	// 获取客户端IP地址('::1','123.234.123.234, 127.0.0.1')(.:[ ])
	static function userIP($flag=0){
		$a = array('f'=>'HTTP_X_FORWARDED_FOR','a'=>'REMOTE_ADDR','c'=>'HTTP_CLIENT_IP');
		$ip = ''; //'r'=>'HTTP_X_REAL_FORWARDED_FOR',
		foreach($a as $k=>$v){
			$v = str_replace(' ','',$v);
			if(!empty($_SERVER[$v]) && !strstr($ip,$_SERVER[$v])){
				$ip .= ';'.($flag ? "$k," : '').$_SERVER[$v];
			}
		}
		if(basArray::inStr(array("'","\\"),$ip)) self::Stop('userIPError');
		$ip = substr($ip,1);
		return $ip;
	}

	// ---- 用户信息 判断 --------------------------------------- 
	
	// 是否搜索引擎来访
	static function isRobot($user_agent=''){
		$rbt = glbConfig::read('uachk','sy');
		$kw_spiders = $rbt['spname'];
		$kw_browsers = $rbt['browsers'];
		$user_agent || $user_agent = self::userAG();
		if(preg_match("/($kw_browsers)/i",$user_agent)){ //!strpos($user_agent,'://') && 
			return false;
		}elseif(preg_match("/($kw_spiders)/i",$user_agent)) return true;
		return false;
	}

	// 是否Weixin()
	static function isWeixin($key='',$ver=0){
		$uagent = $_SERVER['HTTP_USER_AGENT'];
		$wxpos = strpos($uagent, 'MicroMessenger');
		if($ver){
			preg_match('/.*?(MicroMessenger\/([0-9.]+))\s*/', $uagent, $matches);
			return $wxpos ? $matches[2] : '';
		}else{
			return $wxpos;
		}
	}
	
	// 是否Mobile(奇迹方舟(imiku.com))
	static function isMobile($ckey=''){
		if(isset($_SERVER['HTTP_X_WAP_PROFILE'])){
			return true;
		}
		if(isset($_SERVER['HTTP_VIA']) && stristr($_SERVER['HTTP_VIA'],"wap")){
			return true;
		}
		$rbt = glbConfig::read('uachk','sy');
		$kw_spkeywd = $rbt['spkeywd'];
		if(preg_match("/($kw_spkeywd)/i", $_SERVER['HTTP_USER_AGENT'])){
			return true;
		}
		if(isset($_SERVER['HTTP_ACCEPT'])){ //协议法，因为有可能不准确，放到最后判断
			$fwap = strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml'); // 如果只支持wml并且不支持html那一定是移动设备
			$fhtm = strpos($_SERVER['HTTP_ACCEPT'], 'text/html'); // 如果支持wml和html但是wml在html之前则是移动设备
			if (($fwap !== false) && ($fhtm === false || ($fwap < $fhtm))) {
		 		return true;
			} 
		}
		return false;
	}

	// topDomain
	static function topDomain($host){
		if(strpos($host,':/')){
			$host = parse_url($host,PHP_URL_HOST);
			//IPv6，这里得到的host有问题
		}
		$arr = explode('.',$host);
		if(!strpos($host,'.')){ //主机名形式:localhost/pcname; IPv6形式:FE80::1, ::1, 2000::1:2345:6789:abcd
			return $host;
		}elseif(is_numeric($arr[count($arr)-1])){ //IPv4
			return $host;
		}else{ //域名
			$cnt = count($arr); 
			$part1 = $arr[$cnt-1]; $part2 = $arr[$cnt-2];
			$re = "$part2.$part1"; //默认
			if($cnt>=3){
				$tcfg = glbConfig::read('dmtop','sy');
				$t3p = '.com.net.org.edu.gov.int.mil.';
				$re3 = $arr[$cnt-3].".$re";
				if(!empty($tcfg[$re])){
					$re = $tcfg[$re]==3 ? $re3 : $re;
				}elseif(strlen($part2)==2 && strlen($part1)==2){ //2.2 www.dg.gd.cn, www.88.cn
					$re = preg_match('/[a-z]{2}/',$part2) ? $re3 : $re;
				}elseif(strlen($part2)==2 && strlen($part1)==3){ //2.3 www.fyh.cn.com, www.88.com
					$re = strpos($t3p,$part1) ? $re3 : $re;
				}elseif(strlen($part2)==3 && strlen($part1)==2){ //3.2 www.txm.cn, www.net.cn
					$re = strpos($t3p,$part2) ? $re3 : $re;
				}
			}
			return $re;
		} 
	}
	// sysHome // HTTP_HOST = SERVER_NAME : SERVER_PORT
	static function sysHome(){
		global $_cbase;
		$host = $_SERVER["HTTP_HOST"]; 
		$http = (@$_SERVER['HTTPS']==='on') ? 'https' : 'http';
		// dir-跳转:$_cbase['run']['subDirs']
		if(isset($_cbase['run']['subDirs'][$host])){
			$host = $_cbase['run']['subDirs'][$host];
			$uri = $_SERVER['REQUEST_URI'];
			$dir = "$http://$host$uri";
			#$ref = empty($_SERVER["HTTP_REFERER"]) ? '' : $_SERVER["HTTP_REFERER"];
			header("Location:$dir");
		}
		$_cbase['run']['rsite'] = "$http://$host"; 
		$_cbase['run']['rmain'] = "$http://$host".PATH_PROJ; 
		$_cbase['run']['roots'] = "$http://$host".PATH_ROOT; 
	}

	// 缓冲区obSave(...)
	static function obSave($msg=''){
		$msg || $msg = "Contents... ";
		$file = __FUNCTION__;
		echo 'flag1';
		ob_start(); 
		echo $msg.date('Y-m-d H:i:s');
		$data = ob_get_contents();
		ob_end_clean(); 
		comFiles::put(DIR_DTMP."/@temp/test_$file.txt",$data);
		echo('flag2');		
	}
	
	// 缓冲区Start, 替代ob_start(...)
	static function obStart(){
		!ini_get('output_buffering') && ob_start();
	}
	// 缓冲区Clean, 替代ob_end_clean(),ob_clean()
	static function obClean($start=1){
		$obList = ob_list_handlers();
		$obLen = count($obList);
		while($obLen>0){
			ob_clean();
			//ob_end_clean(); //$type=='gzip'
			$obLen--;
		};
		if(!empty($start)) self::obStart();
	}
	// 缓冲区调试
	static function obDebug($start=1){
		$obList = ob_list_handlers();
		$obLen = count($obList);
		$str = "\n<hr>";
		while($obLen>0){
			$c = ob_get_contents();
			$str .= "Debug($obLen):$c<br>\n";
			ob_flush();
			$obLen--;
		};
		echo "$str<hr>";
	}
	static function obShow($data='obData',$die=1){
		basEnv::obClean();
		echo "$data";
		$die && die();
	}
}




/*******************************************************************************
 File : \code\core\blib\basJscss.php 
*******************************************************************************/
<?php

// basJscss类
class basJscss{	

	// imp css/js
	static function imp($path,$base='',$mod='auto'){
		global $_cbase; 
		if(!strpos($_cbase['run']['jsimp'],$path)){
			$_cbase['run']['jsimp'] .= "$path,";
		}else{
			return;	
		}
		if(strpos($path,'://')||strpos($path,'../')){
			$base = '';
		}elseif(in_array(substr($path,0,5),array('/plus','/skin'))){
			$base = PATH_ROOT;
			if(strpos($path,'/comjs.php')) $mod = 'js';
		}elseif($pcfg = comFiles::cfgDirPath($base,'path')){
			$base = $pcfg;	
		}else{
			$base = $base=='null' ? '' : (empty($base) ? PATH_ROOT : $base);	
		}
		$path = "$base$path";
		if(empty($mod) || $mod=='auto') $mod = strpos($path,'.css') ? 'css' : 'js'; 
		if(!empty($_cbase['tpl']['tpc_on'])){
			$_r = '_r='.time();
			$path .= strpos($path,'?') ? "&$_r" : "?$_r";
		}
		if($mod=='js') return self::jscode('',$path)."\n";
		else return "<link rel='stylesheet' type='text/css' href='$path'/>\n";
	}
	
	/*《"&<>》HTML
	《:/?=&#%》URL 
	《\/*?"<>|》FILE
	《'$[]{}》SQL,PHP,下标,变量
	《!()+,-.;@^_`~》安全13个 
	《*+-./@_》7个js-escape安全escape*/
	/* *****************************************************************************
	  *** js字符处理
	- js前缀
	- by Peace(XieYS) 2012-02-24
	***************************************************************************** */
	
	// keyid, subject('"<>\n\r), js
	static function Alert($xMsg,$xAct='prClose',$xAddr='',$head=0){
	  global $_cbase;
	  if($head && empty($_cbase['run']['headed'])) glbHtml::page();
	  if(empty($xAddr)) $xAddr = @$_SERVER["HTTP_REFERER"];
	  $s = "\n<script language='javascript'>\n";
	  $s .= "alert('$xMsg');\n";
	  switch ($xAct) { 
	  case "Back" : 
		$s .= "history.go($xAddr);\n";
		break; 
	  case "Close" : 
		$s .= "window.close();\n";
		break; 
	  case "prClose" : 
		if(@$_cbase['sys_open']==='4'){ 
			$s .= "parent.location.reload();\n";
		}else if(@$_cbase['sys_open']==='1'){ 
			$s .= "window.opener.location.reload();\n";
			$s .= "window.close();\n";
		}else{ 
			$s .= "window.close();\n";
		}
		break; 
	  case "Open" : 
		$s .= "window.open('$xAddr');\n";
		break; 
	  case "Redir" : 
		$s .= "location.href='$xAddr';\n";
		break;
	  default: 
		break; 
	  }
	  $s .= "</script>\n";
	  return $s;
	}
	// $enchf=1,编码html标记：尖括号，
	static function jsShow($xStr, $enchf=1){
	   $Tmp = $xStr;
	   $enchf && $Tmp = str_replace(array('<','>'),array('&lt;','&gt;'),$Tmp);
	   $Tmp = str_replace(array("\\","'",'"'),array("\\\\","\\'",'\\"'),$Tmp); 
	   $Tmp = str_replace(array("\r\n","\r","\n"),array("\\r\\n","\\r","\\n"),$Tmp);
	   return $Tmp;
	}
	static function jsKey($xStr) {
	   $xStr = str_replace(array('[',']',' '),array('_','_',''),$xStr);
	   $xStr = str_replace(array('/','-','.'),array('_','_','_'),$xStr);
	   return $xStr;	
	}
	// document.write
	static function write($xStr){ // ,array(),array()
		return "document.write('".self::jsShow($xStr, 0)."');";
	}
	static function jscode($code,$url=''){ 
		if($url){
			return "<script src='$url'></script>"; 
		}else{
			return "<script>\n$code</script>";
		}
	}
}


/*******************************************************************************
 File : \code\core\blib\basKeyid.php 
*******************************************************************************/
<?php

// basKeyid类
class basKeyid{	
	
	/* *****************************************************************************
	  *** format格式化ID 
	- fmt,get前缀
	- by Peace(XieYS) 2012-02-23
	----------------------------------------------------------------------------- -/
	 特殊字符表
	《!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~》// All:32
	《"&<>》HTML
	《:/?=&#%》URL/COOKIE 
	《\/*?"<>|》(WIN)FILE
	《'$[]{}》SQL,PHP,下标,变量
	《|:"';》session存数据库,特殊字符
	《!()+,-.;@^_`~》安全13个 
	《*+-./@_》7个js-escape安全escape
	《-._@》4个id安全字符:xie_ys@08-cms.com
	***************************************************************************** */
	
	// *** 格式化N位
	static function fmt099($str,$len){
		$s = "";
		for($i=1;$i<=$len-strlen($str);$i++) { 
			$s = $s."0";
		}
		return $s.$str;
	}
	// *** 格式化xBase进制
	static function fmtBase32($kTab,$xNum,$xBase,$xLen=6,$xDir='Right'){
		$sKey = $kTab=='' ? KEY_TAB32 : $kTab; $s0 = "";
		if($xBase==0){$xBase=16;}
		$n = $xNum; $m0 = pow($xBase,$xLen);
		if($n>$m0) {
			if($xDir=="Right") {
				$m1 = substr($n,strlen($m0)-$xLen,$xLen);  
				if($m1>$m0){ $m1 = substr($m1,1,strlen($m1)-1); }
			}else{
				$m1 = substr($n,0,$xLen);   
				if($m1>$m0){ $m1 = substr($m1,0,strlen($m1)-1); }
			}
			$n = $m1;
		}
		for($i=$xLen-1; $i>=0; $i--) {
			if($i>0){
				$ni = intval($n/(pow($xBase,$i)));
			}else{
				$ni = $n;
			}
			$si = $sKey{$ni};
			$s0 = $s0.$si; 
			$n = $n % pow($xBase,$i);
		} 
		return $s0;
	}
	// *** Time时间相关
	static function getYYYYMMDD($xDate=''){
		if(strlen($xDate)>4) $str = date("Ymd",strtotime($xDate));
		else $str = date("Ymd"); 
		return $str;
	}
	// re : 31829.010991;
	static function getTimer(){
		$t1 = date("His"); //084830 --- time() 函数返回当前时间的 Unix 时间戳。
		$a1 = explode(' ', microtime());  //0.81250100 1283820399
		$n = substr($t1,0,2)*3600+substr($t1,2,2)*60+substr($t1,4,2);
		return $n+$a1[0]; //31874.515625
	}
	// re: 837;
	static function getMSec($type=0){
		if($type) return microtime()*1000; //562.519
		$s = microtime(); 
		return substr($s,2,3); //562
	}
	
	/* *****************************************************************************
	  *** KeyID通用代码 
	- fmt,kid前缀
	- by Peace(XieYS) 2012-02-21
	***************************************************************************** */
	
	// *** 随机源table
	static function kidTable($Type='24'){
		$sSpe = '!"#$%&\'()*+,-./:;<=>?@[\]^_`{|}~'; //32个 
		$sSp1 = '!()+,-.;@^_`~'; // 安全13个 
		$sSp2 = '*+-./@_'; // 7个js-escape安全escape
		$sSp3 = '+-.@_'; // 5个绝对安全
		$sfula = KEY_NUM10.KEY_CHR26.strtoupper(KEY_CHR26);
		switch ($Type){ 
			case "0" : $sOrg = KEY_NUM10; break; 
			case "a" : $sOrg = KEY_CHR26; break;
			case "h" : $sOrg = KEY_NUM16; break; 
			case "H" : $sOrg = strtoupper(KEY_NUM16); break; 
			case "A" : $sOrg = strtoupper(KEY_CHR26); break; 
			case "k" : $sOrg = KEY_TAB32; break;
			case "30": $sOrg = KEY_TAB30; break;
			case "24": $sOrg = KEY_TAB24; break; 
			case "s" : $sOrg = $sSpe; break; 
			case "1" : $sOrg = $sSp1; break; 
			case "2" : $sOrg = $sSp2; break; 
			case "3" : $sOrg = $sSp2; break; 
			case "f" : $sOrg = $sfula; break; 
			case "fs" : $sOrg = $sfula.$sSpe; break; 
			case "fs1" : $sOrg = $sfula.$sSp1; break; 
			case "fs2" : $sOrg = $sfula.$sSp2; break; 
			case "fs3" : $sOrg = $sfula.$sSp3; break; 
			default  : $sOrg = KEY_TAB24."abcdf"; break; 
		}
		return $sOrg;
	}
	// *** 打乱的table
	// *** obj : 打乱obj...
	static function kidRTable($Type='24',$re='rnd',$obj=''){
		$sOrg = $bOrg = self::kidTable($Type);
		if($re=='org') return $sOrg;
		$sLen = strlen($sOrg); //$pLen = intval($sLen/2); //$str = '';
		for($j=0;$j<2;$j++){  //两次打乱
		for($i=0;$i<$sLen;$i++){
			$ch = $sOrg{mt_rand(0,$sLen-1)};
			$sOrg = $ch.str_replace($ch,'',$sOrg);
		} }
		if(empty($obj)) return $sOrg;
		//$sLen = strlen($obj);
		for($i=0;$i<$sLen;$i++){
			$ch1 = $sOrg{mt_rand(0,$sLen-1)};
			$ch2 = $bOrg{mt_rand(0,$sLen-1)};
			$obj = str_replace($ch1,$ch2,$obj);
		}
		return $obj;
	}
	// *** 随机码
	static function kidRand($Type='24',$Len=16){
		$sOrg = self::kidTable($Type);
		$sLen = strlen($sOrg); $str = '';
		if($Len<=0){
			for($i=0;$i<$sLen;$i++){
				$ch = $sOrg{mt_rand(0,$sLen-1)}; //echo $ch;
				$str .= $ch; 
				$sOrg = str_replace($ch,'',$sOrg);
				if($nLen==1){ $str .= $sOrg; break; }
			}
		}else{
			for($i=0;$i<$Len;$i++){
				$str .= $sOrg{mt_rand(0,$sLen-1)};
			}
		}
		return $str;
	}
	
	// *** 摸版ID
	// YYYY,YY,MM,DD,MD; HNSX,HNS
	static function kidTemp($xFmt='(def)',$xTime=''){
		$ktab32 = str_replace('e','',KEY_TAB32).'z';
		$sTmp = strtolower($xFmt); 
		if(empty($xTime)){
			$sDate = date("Ymd");
			$sTime = date("His"); 
		}else{
			$xTime = is_numeric($xTime) ? $xTime : strtotime($xTime);
			$sDate = date("Ymd",$xTime);
			$sTime = date("His",$xTime);
		} 
		$y4 = date("Y",strtotime($sDate)); 
		$md = $ktab32{substr($sDate,4,2)}.$ktab32{substr($sDate,6,2)}; 
		$h = $ktab32{substr($sTime,0,2)}; 
		$m = $ktab32{intval(substr($sTime,2,2)/2)+1};
		$s9 = substr($sTime,2,4).substr(microtime(),2,6); 
		$s6 = ''; for($i=0;$i<7;$i=$i+3) $s6 .= self::fmtBase32('',substr($s9,$i,3),32,2,'');
		if($xFmt=='0'){						   //2012-md
			$sTmp = "$y4-$md";
		}elseif($xFmt=='m-dh'){				   //2012m-dh
			$sTmp = "$y4".substr($md,0,1)."-".substr($md,1,1)."$h";
		}elseif($xFmt=='h'){					  //2012-9B-F
			$sTmp = "$y4-$md-$h";
		}elseif($xFmt=='hm'){					 //2012-9C-GC				
			$sTmp = "$y4-$md-$h$m";
		}elseif($xFmt=='hms'){					//2012-9C-GCD
			$ms = floor((substr($sTime,2,2)*60+substr($sTime,4,2))/4)+1; //3600-1
			$sTmp = "$y4-$md-$h".self::fmtBase32($ktab32,$ms,32,2,'');
		}elseif($xFmt=='3.4'){					//2012-9D-H33.AVEX 
			$ms = floor((substr($sTime,2,2)*60+substr($sTime,4,2))/4)+1;  
			$sTmp = "$y4-$md-$h".self::fmtBase32($ktab32,$ms,32,2,'').'.'.substr($s6,2,4);
		}elseif($xFmt=='4.5'){					//2012-9F-F289.06999
			$sTmp = "$y4-$md-$h".substr($s9,0,3).".".substr($s9,3,5);
		}elseif($xFmt=='5.6'){					//2012-9G-H1230.756894
			$sTmp = "$y4-$md-$h".substr($s9,0,4).".".substr($s9,4,6);
		}elseif(strpos(',4,5,6,7,',"$xFmt,")){  //2012-7H-DTX...
			$sTmp = "$y4-$md-$h".substr($s6,0,$xFmt-1);
		}else{									//2012-7K-DTX0PBD
			$sTmp = "$y4-$md-$h".$s6;
		}
		return $sTmp;
	} 
	
	static function kidAuto($xN=24){
		$str = date("Ymd"); 
		$sy = substr($str,0,4);
		$sm = substr($str,4,2);
		$sd = substr($str,6,2);
		$YMD = self::fmtBase32('',$sy*380+$sm*31+$sd,"16",6,"");
		$HMS = self::fmtBase32('',intval(self::getTimer()*100),16,6,"");
		$str = $YMD.$HMS;
		$n = $xN - strlen($str);
		if($n>0) { $str .= self::kidRand("",$n); }
		if($n<0) { $str .= substr($str,0,$xN); }
		return $str;
	}
	
	static function kidNext($kTab,$xOld,$xMin,$xStep,$mLen=5){
		$ktabs = $kTab=='' ? KEY_TAB32 : $kTab; 
		$nLen = strlen($xMin);
		$t1 = KEY_NUM10; $s="";
		$tf = $ktabs==KEY_TAB24 ? 'Chr' : "Num"; $tn = $t1; $hf = 0; // (进位) 
		if(strlen($xOld)<$nLen){ return $xMin; }
		else {
			$OldID = substr($xOld,0,strlen($xMin));
			for($i=$nLen;$i>=1;$i--) { 
				$c = substr($OldID,$i-1,1); 
				if(($tf!='Num')||($c>'9')||($i==1)) { $tf="Chr"; } 
				if(strlen($xMin)<$mLen){ $tf="Chr"; }
				if($tf=="Chr") { $tn = $ktabs; }
				$n = strpos($tn,$c); // 位置 0~N-1 或为空strlen($n)=0
				if(strlen($n)>0){
					$n = $n + $hf; 
					if($i==$nLen) { $n = $n+$xStep; }
					if($n>=strlen($tn)) {
						$n = $n-strlen($tn);
						$hf = 1;
					}else{
						$hf = 0;
					}
					$c = $tn{$n}; 
				}else{ //ILOZ不在列表中则
					$c = $c=='z' ? 'z' : chr(ord($c)+1); //echo "f.$c,";
				}
				$s = $c.$s;
			} 
			if($xOld>$s) return $xOld;
			return $s;
		}
	}
	
	static function keepCheck($key,$chk=1,$fix=1,$grp=0,$len=3){
		$groups = glbConfig::read('groups');
		$keepids = glbConfig::read('keepid','sy');
		if(strlen($key)<$len){
			return lang('core.kid_minlen',$len); //"请输入$len+个字符！";
		}
		if($chk && strpos($keepids,",$key,")){
			return lang('core.kid_keeped',$key); 
		}
		if($fix && strpos($key,"_")){
			$fix = strpos($key,0,strpos($key,'_'));
			if(strstr($keepids,",$fix,")) return lang('core.kid_preused',$key); 
		}
		if($grp && isset($groups[$key])){ 
			return lang('core.kid_ismodel',$key); 
		}
		return '';
	}

}




/*******************************************************************************
 File : \code\core\blib\basLang.php 
*******************************************************************************/
<?php

// basLang多语言类
class basLang{	
	
	static $_CACHES_LG = array();//将读取过的缓存暂存可重用

	// ('fsystem'), ('cfglibs.upload');
	static function ucfg($file, $key=0){
		if(strpos($file,'.')){
			$mk = explode(".",$file);
			$file = $mk[0];
			$key = $mk[1];
		} 
		$re = self::getCfgs($key, $file, 'ucfgs');
		return $re;
	}

	// {lang(core.view_times,$click)}
	// {lang(core.sys_name)}
	static function show($mk, $val='', $dir='kvphp'){
		$mk = str_replace("'",'',$mk);
		if(!strpos($mk,'.')) $mk = "core.$mk";
		$arr = explode('.',$mk); 
		$re = self::getCfgs($arr[1], $arr[0], $dir);
		if(strlen($val)>0){
			$re = str_replace('{val}',$val,$re);
		}
		if(strpos($re,'{val}')){
			$re = str_replace('{val}','',$re);
		}
		return $re;
	}
	
	// 多语言...
	static function getCfgs($key, $mod='core', $dir='kvphp'){
		$lang = cfg('sys.lang'); 
		if(isset(self::$_CACHES_LG[$mod])){
			$cfgs = self::$_CACHES_LG[$mod];
		}else{
			$flang = DIR_CODE."/lang/$dir/$mod-$lang.php"; 
			$cfgs = self::$_CACHES_LG[$mod] = file_exists($flang) ? include($flang) : array();	
		}
		if(empty($key)) return $cfgs;
		return isset($cfgs[$key]) ? $cfgs[$key] : '{'."$mod.$key".'}';
	}

	// {linc(file.part)} <大段文本>
	static function inc($file, $part='', $uarr=array()){
		$lang = cfg('sys.lang'); 
		$flang = DIR_CODE."/lang/ptinc/$file-$lang.php";
		include($flang); 
		if(isset($reinc[$part])){
			return $reinc[$part];
		}
	}	

	// 字段从数组中选个语言键值
	static function pick($key, $vals=array()){
		if(!is_array($vals)){
			return $vals;
		}
		$lang = cfg('sys.lang'); 
		if($key && isset($vals[$key])){
			return $vals[$key];
		}elseif(isset($vals[$lang])){
			return $vals[$lang];
		}else{
			return reset($vals);
		}
	}	
	
	// 前置处理,ucfg.lang
	// $_cbase['ucfg']['lang'] = '(auto)'; 
	static function auto(){
		global $_cbase; 
		if(empty($_cbase['ucfg']['lang'])) return;
		if($_cbase['ucfg']['lang']=='(auto)'){
			$ulang = basReq::val('lang');
			if(!empty($ulang)){
				$_cbase['sys']['lang'] = $ulang;
				return;
			}
			$lang = comCookie::oget('lang');
			if(!empty($lang)){
				$_cbase['sys']['lang'] = $lang;
				return;
			}
			$lang = substr($_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2);
			$_cbase['sys']['lang'] = $lang=='zh' ? 'cn' : 'en';
		} //dump($_cbase['sys']['lang']);
	}

	// links
	static function links($dir=''){
		$vopfmt = glbConfig::read('vopfmt','ex');
		$url = PATH_ROOT."/plus/ajax/redir.php?lang:{key}";
		if(empty($dir)){
			$tpl = "<a href='$url' title='{title}'>{mini}</a>";
		}elseif(strpos($dir,'</')){
			$tpl = str_replace('{url}',$url,$dir);
		}else{ // lang:cn:&recbl=redir
			$url .= ":&recbk=$dir"; 
			$tpl = "<a href='$url' title='{title}'>{mini}</a>";
		}
		$res = '';
		foreach ($vopfmt['langs'] as $key => $val) {
			$res .= "\n".str_replace(array('{key}','{title}','{mini}'),array($key,$val[0],$val[1]),$tpl);
		}
		return $res;

	}	

	// jimp
	static function jimp($path,$base='',$lang='(auto)',$injs=0){
		if($lang=='(auto)') $lang = cfg('sys.lang'); 
		$js1 = basJscss::imp($path,$base,'js')."\n";
		$pajs = str_replace('.js',"-$lang.js",$path);
		$js2 = basJscss::imp($pajs,$base,'js')."\n";
		$res = "$js1$js2";
		if($injs){
			$res = basJscss::write($res);
		}
		echo $res;
	}

}




/*******************************************************************************
 File : \code\core\blib\basMsg.php 
*******************************************************************************/
<?php

// String类
class basMsg{	
	
	// init
	static function init($xMsg,$clear=0){ //
		global $_cbase;
		if($clear){
			//ob_end_clean(); //清除了不好找...
			$_cbase['run']['jsimp'] = '';
		}
		if(strlen($_cbase['run']['jsimp'])<6){
			glbHtml::page(strip_tags($xMsg),1);
			 //glbHtml::page('imp'); 
			glbHtml::page('body');
		}
	}
	
	// js跳转
	static function dir($url=''){
		return "\n".basJscss::jscode("window.location.href='$url';")."\n";
	}

	// show
	static function show($xMsg,$xAct='Redir',$xAddr=array(),$head=0){
		$dialog = basReq::val('dialog','','');
		$recbk = basReq::val('recbk','','Html'); 
		if(empty($xAddr) && $recbk) $xAddr = $recbk; 
		if($xAct=='die'){
			@header("HTTP/1.1 404 Not Found");
			self::init($xMsg);
			echo "<p class='tc bold pa10'> $xMsg </p>";
			die(glbHtml::page('end'));
		}elseif($dialog){
			echo self::msgbox($xMsg,$xAct,$xAddr);
		}else{ 
			echo basJscss::Alert($xMsg,$xAct,$xAddr,$head);	  
		}
	}
	// xAddr : array(array('地址1','http://txjia.com/'),array('地址2','http://domain.com/'))
	static function msgbox($xMsg,$xAct='prClose',$xAddr=array()){
		global $_cbase; 
		$css = empty($xAddr) ? 'msg_1info' : 'msg_golist';
		$str = "<div id='msg_box' class='$css'>\n<table border='1' class='tblist'>";
		$str .= "\n<tr><th colspan='2' class='msg_th'>{$xMsg}！</th></tr>";
		if(!empty($xAddr) && is_array($xAddr)){ $i=0; 
			foreach($xAddr as $ar){ $i++;
			  $link = "<a href='$ar[1]'>$ar[0]</a>";
			  $str .= "\n<tr><td class='tc'>".($i>1 ? lang('core.msg_goto') : lang('core.msg_or'))."</td><td class='tl'>$link</td></tr>";
			  if($i==1){ $lnks = $link; $lnka = $ar; }
			}
			$str .= "\n<tr><td width='20%' class='tc'>".lang('core.msg_jumpto')."</td><td class='tc'>{$lnks}</td></tr>";
		} 
		$tm = empty($_cbase['msg_timea']) ? 1503 : $_cbase['msg_timea']; 
		$pwin = $_cbase['sys_open']=='1' ? 'window.opener' : 'parent'; //window.opener,parent
		$act = (!empty($xAddr) && !empty($lnka[1])) ? "$pwin.location.href='$lnka[1]'" : "$pwin.location.reload()";
		$actext = ($_cbase['sys_open']=='1') ? "setTimeout('window.close()',300);" : ''; 
		$act = "jeCenter('msg_box',50);setTimeout(\"$act;$actext;\",$tm);";
		$str .= "\n</table>\n</div>\n".basJscss::jscode($act)."\n";
		return $str;
	}	
}




/*******************************************************************************
 File : \code\core\blib\basNodef.php 
*******************************************************************************/
<?php

// basNodef
class basNodef{	
	
	static $_CACHES_LG = array();//将读取过的缓存暂存可重用
	
	// php5.5弃用了mysql扩展后,此函数也不可用了
	static function quoteSql($str,$noq=0){
		$db = glbDBObj::dbObj();
		$str = $db->quoteSql($str);
		if(empty($noq)){ 
			return $db->class=='pdox' ? $str : "'$str'";
		}else{ /* 不要括号 */ 
			return $db->class=='pdox' ? substr($str,1,strlen($str)-2) : $str;
		}
	}

	// 低版本用mime_content_type, 较高版本用finfo扩展, 都不能用则用table对照...
	static function mimeType($filename) {
		if(function_exists('finfo_open')){
			$finfo = finfo_open(FILEINFO_MIME);
			$mtype = finfo_file($finfo, $filename);
			finfo_close($finfo);
			return $mtype;			
		}elseif(function_exists('mime_content_type')) {
			return mime_content_type($filename);
		}else{
			return 'application/octet-stream';
		}
	}

}




/*******************************************************************************
 File : \code\core\blib\basReq.php 
*******************************************************************************/
<?php

// Request,表单,Url参数处理类
class basReq{	

	/* *****************************************************************************
	  *** system系统常用函数
	- get,xxx前缀
	- by Peace(XieYS) 2012-02-18
	***************************************************************************** */
	

	// Request Vars
	// Demo : extract(basReq::sysVars());
	static function sysVars(){
		$sy_sids = glbConfig::read('sysids','sy');
		$re = array();
		foreach($sy_sids['GET'] as $k){
			if(isset($_POST[$k])){
				$val = $_POST[$k];
			}elseif(isset($_GET[$k])){
				$val = $_GET[$k];	
			}else{
				$val = '';
			}
			$re[$k] = $val;
		}
		foreach(array('Title','Key','N') as $k0){
			$items = $sy_sids[$k0];
			foreach($items as $k){
				$def = $k0=='N' ? 0 : ($k0=='Key' ? 24 : 255);
				$val = self::val($k, '', $k0, $def);
				$re[$k] = $val;
			}
		} //print_r($re);
		return $re;
	}
	
	static function val($key,$def='',$type='Title',$len=255){ 
		if(isset($_POST[$key])){
			$val = $_POST[$key];
		}elseif(isset($_GET[$key])){
			$val = $_GET[$key];	
		}else{
			$val = '';
		}
		return is_array($val) ? $val : self::fmt($val,$def,$type,$len);
	}
	static function arr($fix,$type='Title',$len=255){ 
		//echo "<br>fix:"; print_r($fix);
		if(isset($_POST[$fix])){
			$val = $_POST[$fix];
		}elseif(isset($_GET[$fix])){
			$val = $_GET[$fix];	
		}else{
			$val = array();
		}
		if($type && !empty($val)){
			foreach($val as $k=>$v)	{
				$val[$k] = is_array($v) ? $v : self::fmt($v,'',$type,$len);
			}
		}
		return $val;
	}
	static function ark($fix,$key,$type='Title',$len=255){ 
		if(isset($_POST[$fix][$key])){
			$val = $_POST[$fix][$key];
		}elseif(isset($_GET[$fix][$key])){
			$val = $_GET[$fix][$key];	
		}else{
			$val = '';
		}
		return is_array($val) ? $val : self::fmt($val,'',$type,$len);
	}

	// type=D,N,Key,Title,Html
	static function fmt($data,$def='',$type='Title',$len=255){ 
	   if($type=='N'){
		  if(is_numeric($data)) return $data; 
		  else return $def;  
	   }elseif($type=='D'){
		  if(strtotime($data)) return $data; 
		  else return $def; 
	   }
	   switch ($type){ 
	   case "Key" : 
	   case "Title" : 
		  $Tmp = basStr::cutCount($data,$len);
		  $Tmp = $type=='Title' ? basStr::filTitle($Tmp) : basStr::filKey($Tmp,'-._@');
		  $Tmp = strlen($Tmp)==0 ? $def : $Tmp;
		  return $Tmp; break; 
	   case "Safe4" : 
		  $Tmp = basStr::filSafe4($data);
		  $Tmp = strlen($Tmp)==0 ? $def : $Tmp;
		  return $Tmp; break; 
	   default:  // Html
		  $Tmp = basStr::filHtml($data); 
		  $Tmp = strlen($Tmp)==0 ? $def : $Tmp;
		  //$Tmp = self::in($Tmp);
		  return $Tmp; break;  //处理 '"\
	  }  
	}
	
	// *** fmtNum
	static function fmtNum($num,$dec=2,$kdot=''){ 
		$num = number_format($num,$dec);
		if(empty($kdot)) $num = str_replace(',','',$num);
		return $num;
	}
	
	// *** 获取Checkbox安全数据
	static function getCBox($key,$re='s'){ 
		$a = self::arr($key);
		if($re=='s'){ // 返回字符串:array -> string
			$s = '';
			foreach($a as $v) $s .= (empty($s) ? '' : ',').$v.',';	
			return $s;
		}else{ // return array
			return $a;	
		}
	}
	
	static function in($data){
		if(is_string($data)){
			//$data=trim(htmlspecialchars($data));//防止被挂马，跨站攻击
			$data = addslashes($data);//防止sql注入
			return $data;
		}else if(is_array($data)){ //如果是数组采用递归过滤
			foreach($data as $key=>$value){
				 $data[$key]=self::in($value);
			}
			return $data;
		}else{
			return $data;
		}	
	}
	static function out($data){
		if(is_string($data)){
			return $data = stripslashes($data);
		}else if(is_array($data)){ //如果是数组采用递归过滤
			foreach($data as $key=>$value){
				 $data[$key]=self::out($value);
			}
			return $data;
		}else {
			return $data;
		}	
	}
	
	//获取REQUEST_URI
	//re:第几个参数,-2:array;-1:full; 
	static function getUri($re=-1,$ura='',$skip=''){
		if(!$ura){
			if(isset($_SERVER['REQUEST_URI'])){
				$uri = $_SERVER['REQUEST_URI'];
				if(strpos($uri,'?')>0){
					$pos = strpos($uri,'?');
					$ura = array(substr($uri,0,$pos),substr($uri,$pos));
				}else{
					$ura = array($uri,'');
				}
			}else{
				$ura = array($_SERVER['PHP_SELF']);
				if(isset($_SERVER['argv'])){
					$ura[] = $_SERVER['argv'][0];
				}else{
					$ura[] = $_SERVER['QUERY_STRING'];
				}
			}	
		}elseif(is_string($ura)){
			$ura = explode('?',"$ura");
		}
		if(!strstr($ura[1],'?')) $ura[1] = "?$ura[1]";
		if($ura[1]&&$skip){ //《"&<>》HTML《:/?=&#%》URL《\/*?"<>|》FILE
			$ura[1] = preg_replace("/[\?|\&]($skip)=[^\f\n\r\t\v\&\#]{0,80}/i",'',$ura[1]);	
		} //print_r($ura);
		if($re==-2) return $ura;
		elseif($re==-1) return implode($ura);
		elseif(isset($ura[$re])) return $ura[$re]; //'http://'.$_SERVER['HTTP_HOST'].
		else return '';
	}
	static function getURep($url,$key,$val=''){
		$url || $url = $_SERVER["REQUEST_URI"];
		$para = empty($val) ? '' : "$key=$val";
		if(strpos($url,"$key=")){
			$url = preg_replace("/$key=([^\f\n\r\t\v\&\#]{0,80})/i",$para,$url);	
		}else{
			$url = strpos($url,'?') ? $url : "$url?";
			$url .= "&$para";
			$url = str_replace(array("?&","&&"),array("?","&"),$url);	
		}
		return $url;
	}

	// $str = addslashes(preg_replace("/(=\s*['\"]?)($re)(.+?['\" >])/ies",'"$1"."<!cmsurl />"."$3"',stripslashes($str)));
	
}




/*******************************************************************************
 File : \code\core\blib\basSql.php 
*******************************************************************************/
<?php

// basSql类
class basSql{	
	
	// type=a/e; $re='arr/str'; ip=''
	static function logData($type='a',$ip='',$time=0,$user=''){ //,$re='arr'
		$run = cfg('run');
		$unow = usrBase::userObj();
		$cfg = array(
			'ip' => $ip ? $ip : $run['userip'],
			'time' => $time ? $time : $run['stamp'],
			'user' => $user ? $user : @$unow->uinfo['uname'],
		);
		$re = array();
		foreach($cfg as $k=>$v){
			$re["$type$k"] = $v;	
		}
		return $re;
	}
	
	// 2013-12-31; 5(天)
	static function whrDate($key,$val,$op,$cfg='isdate'){
		//'fmextra' => 'datetm'
		$val = preg_replace('/[^0-9A-Za-z,\.\-\ \:]/','',$val);
		if( in_array($key,array('atime','etime')) || @$cfg=='isdate' || @$cfg['f'][$key]['mfextra']=='datetm' ){
			if(is_numeric($val)){
				$valbase = strtotime(date('Y-m-d',time()));
				$val = $valbase - $val*86400;
			}else{ 
				$val = strtotime($val); 
			}
			if($op=='<' && strstr($val,':')) $val += 86401;	
		} //echo "<br>$val:$sql:".date('Y-m-d H:i:s',$val);
		$sql = " AND $key$op='$val'"; 
		return $sql;
	}
	
	/**
	 * 地图中参照物周边的查询子串
	 * @param int $x,$y	 	参照目标的坐标
	 * @param int $diff			指定范围，单位为km或度
	 * @param int $mode	 	计算模式，0按度数，1按实际距离//???
	 * @param string $fname		查询的字段名（包含表别名前缀）
	 * m.didu_0>=22.456 AND m.didu_0<=52.456 AND m.didu_1>=50.33 AND m.didu_1<=150.33
	 */
	static function whrMap($x,$y,$diff,$mode,$fname){		
		if(!$diff) return '';
		$mode = empty($mode) ? 0 : 1;
		$x = floatval($x);
		$y = floatval($y);
		$dfx = $dfy = $diff = abs(floatval($diff));
		if($mode == 1){
			$radius = 6371;//km
			$dfx = $diff / (2 * $radius * M_PI) * 360;
			$dfy = $diff / (2 * $radius * M_PI * cos(deg2rad($x))) * 360;
		}
		$re = $fname.'_x>='.($x - $dfx).' AND '.$fname.'_x<='.($x + $dfx);
		$re .= " AND {$fname}_y>=".($y - $dfy)." AND {$fname}_y<=".($y + $dfy)."";
		return $re;
		//$dmin = $y - $dfy; $dmax = $y + $dfy; // $dmin<-180 // $dmax>180 // $dfx>30 || $dfy>60
	}
	
	// 栏目，类别系的子类别
	static function whrTree($items,$key,$val){
		$ids = comTypes::getSubs($items,$val); 
		$ids = array_keys($ids); $ids[] = $val;
		$sql = " AND $key IN('".implode("','",$ids)."')";  
		return $sql;
	}
	
	// 单选/多选/单选按钮:可用用文字搜索
	static function whrScbr($cfgs,$sfid,$sfkw){
		$cfg = $cfgs[$sfid]; 
		$arr = basElm::text2arr($cfg); 
		if(isset($arr[$sfkw])){
			$sql = " AND $sfid='$sfkw' ";
		}else{
			$keys = array();
			foreach($arr as $k=>$v){
				similar_text($v,$sfkw,$per); 
				if($per>60){
					$keys[] = $k;
				}
			}
			if(!empty($keys)){
				$sql = " AND $sfid IN('".implode("','",$keys)."')";
			}else{
				$sql = " AND $sfid='((.null.))'";
			}
		} //print_r($sql);
		return $sql;
	}
	
	// ids : array, id1,id2...
	static function whrInids($ids,$sp=','){
		$arr = is_array($ids) ? $ids : explode($sp,$ids);
		$arr = array_unique(array_filter($arr));
		$arr = str_replace("'","",$arr);
		$str = empty($arr) ? '' : "'".implode("','",$arr)."'";
		return $str;
	}
	
	// 格式化sql		
	static function fmtShow($sql,$hlight=0){
		if($hlight=='2'){
			$arr = array("INNER JOIN","WHERE","ORDER BY","GROUP BY","LIMIT","FORCE INDEX",);
			$sql = basStr::filTrim($sql); 
			foreach($arr as $v) $sql = str_replace($v,"\n$v",$sql);	
			$sql = str_replace(") AND",") \n AND",$sql); 
		}else{
			require_once(DIR_VENDOR.'/sql-formatter/lib/SqlFormatter.php');
			$sql = SqlFormatter::format($sql, $hlight);			
		}
		return $sql;
	}
	static function fmtCount($str,$field='_rec_count_'){
		return $str ? preg_match('/^(.+?)\s+GROUP\s+BY(.+)$/is',$str,$arr) ? "SELECT COUNT(DISTINCT $arr[2]) ".stristr($arr[1],'FROM') : ("SELECT COUNT(*) AS $field ".stristr($str,'FROM')) : '';
	}
	
	/**
	 * 处理搜索关键字，处理后：可搜索%_特殊字符，
	 * demo: AND (a.subject ".fmtKeyWD($keyword).")";
	 *
	 * @param  string $keyword 要转换的字符串
	 * @param  string $multi =1时，*，空格当成通配符处理
	 * @return string $sqlstr 返回sql子字符串，包含 LIKE
	 */
	static function fmtKeyWD($keyword,$multi=1){
		$keyword = addcslashes($keyword,'%_');
		$multi && $keyword = str_replace(array(' ','*'),'%',$keyword);
		return " LIKE '%$keyword%' ";
	}
	
}


/*******************************************************************************
 File : \code\core\blib\basStr.php 
*******************************************************************************/
<?php

// String类 - by Peace(XieYS) 2012-02-18

class basStr{	

	// 匹配中文字符串

	// ($str,'100,ffff','3,5'), ($str,'cnchr','c124'), 
	static function getMatch($str,$case='cnchr',$len='c124'){
		$cfgs = array(
			'isasc' => array('{20}','{ff}'), // ascii码
			'noasc' => array('{100}','{ffff}'), //非ascii码
			'cnchr' => array('{4e00}','{9fbf}'), //中文
			//'dbstr' => "", //导出的db中文
		);
		$lens = array(
			'c124' => '{1,24}',
			'c196' => '{1,96}',
			'c204' => '{1,4}', //姓名
		);
		$cfg = isset($cfgs[$case]) ? $cfgs[$case] : explode(',',str_replace(",","},{",'{'.$case.'}'));
		$len = isset($lens[$len]) ? $lens[$len] : '{'.$len.'}'; "\{$len\}"; 
		if($case=='dbstr'){ //(is_array($cfg)){
			preg_match_all("/[\x{2000}-\x{9fa5}a-z0-9\/\:\,\.\_\-\[\]]{0,48}[\x{4e00}-\x{9fa5}]{1}[\x{2000}-\x{9fa5}a-z0-9\/\:\,\.\_\-\[\]]{0,96}/iu",$str,$m); 
		}else{
			preg_match_all("/[\x{$cfg[0]}-\x{$cfg[1]}]{$len}/u",$str,$m);
		}
		$res = empty($m[0]) ? array() : array_unique($m[0]);
		return $res;
	}

	// 计算字符串字节数，英文算一个字节,不管[GBK/utf-8]编码中文算两个字节
	static function chrCount($str){
		$ch = cfg('sys.cset')=='utf-8' ? 3 : 2; //中文宽度
		$length = strlen(preg_replace('/[\x00-\x7F]/', '', $str)); 
		if($length){
			return strlen($str) - $length + intval($length / $ch) * 2;
		}else{
			return strlen($str);
		}
		//return strlen(preg_replace('/([x4e00-x9fa5])/u','**',$str));
	}
	
	// *** 截取字符串，英文算一个,中文算一个 
	static function cutCount($str,$len=255){ 
		$ch = cfg('sys.cset')=='utf-8' ? 3 : 2; //中文宽度
		$n = strlen($str); //php函数原始长度
		$p = 0; //指针
		$cnt = 0; // 计数,英文算一个字符
		//echo "<br>$n - $cmax";
		if($n > $len) {
			for($i=0; $i<$n; $i++) {
				if($p>=$n) break; //结尾
				if($cnt>=$len) break; //最大文字个数
				if(ord($str[$p]) > 127) { $p += $ch; }
				else { $p++; }
				$cnt++;
			}
			return substr($str,0,$p);
		}else return $str;
		//$msg = cutstr($msg,$len,'');
	}
	
	// *** 截取字符串，得到等宽字符串
	static function cutWidth($string, $length=24, $etc='...') {  
		if(!$string) return ""; 
		$clen = cfg('sys.cset')=='utf-8' ? 3 : 2; //中文宽度
		$sLen=0; $width=0; $strcut=''; $length=$length*2; //中文宽计算
		if(strlen($string) > $length) {
			//将$length换算成实际UTF8格式编码下字符串的长度
			for($i = 0; $i < $length; $i++) {
				if ($sLen >= strlen($string)) { break; }
				if ($width >= $length) { break; }
				//当检测到一个中文字符时, //大概按一个汉字宽度相当于两个英文字符的宽度
				if(ord($string[$sLen]) > 127) { $sLen += $clen; $width += $clen; }
				else { $sLen += 1; $width += 1; }
			}
			return substr($string, 0, $sLen).$etc;
		}else return $string;
	}
	// *** 格式化数字,$type='Byte'显示占用空间
	static function showNumber($num, $type=0){
		$b = 0; $bfix = ''; // Byte
		if(is_numeric($num)){ $b = $num; }
		if($type==='Byte'){
			if($b>pow(1024,4)){
				$b = number_format($b/(pow(1024,4)),2)." (TB) ";
			}else if($b>pow(1024,3)) {
				$b = number_format($b/(pow(1024,3)),2)." (GB) ";
			}else if($b>pow(1024,2)) {
				$b = number_format($b/(pow(1024,2)),2)." (MB) ";
			}else if($b>pow(1024,1)) {
				$b = number_format($b/(pow(1024,1)),2)." (KB) ";
			}else{
				$b = $b." (B) ";
			}
			return $b;
		}else{
			return number_format($b,$type);
		}
		//return $b.(empty($sfix) ? $bfix : $sfix);
	}
	// *** 显示状态
	// "Y;N;X;-","已审;未审;未过;未知",$SetShow);
	static function showState($xState,$xMsg,$val){
		if($xMsg==""){ $xMsg=$xState; }
		$sc = '333,'.cfg('ucfg.ctab').',999'; $ac = explode(',',$sc); 
		$ak = explode(';',$xState); $am = explode(';',$xMsg);
		$j=0; $r="<span style='color:#CCC'>-</span>";
		for($i=0;$i<sizeof($ak);$i++) { 
			if($j>=sizeof($ac)) { $j=0; }
			if($val==$ak[$i]){
				$r = "<span style='color:#".$ac[$j]."'>".$am[$i]."</span>";
				break;
			}
			$j++;
		}
		return $r;
	}
	// *** 显示颜色
	static function showColor($Text,$Color){
		if(substr($Color,0,1)!='#') $Color='#'.$Color;
		$Text = str_replace('<',"&lt;",$Text);
		$Text = str_replace('>',"&gt;",$Text);
		if((strlen($Color)>3)&&($Color!='#000000')){ 
			$Text = "<span style='color:$Color'>$Text</span>"; 
		}
		return $Text;
	}
	
	// Filter转义/还原

	// *** 文本文件
	static function filText($xStr,$cbr=1){  
		if(is_array($xStr)) {
			foreach($xStr as $k => $v) $xStr[$k] = self::filText($v);
		}else{
			$xStr = htmlentities($xStr,ENT_QUOTES,"UTF-8"); //ENT_QUOTES:编码双引号和单引号
			$xStr = str_replace(array('<','>'),array('&lt;','&gt;'),$xStr);
			if($cbr) $xStr = nl2br($xStr);
		}
		return $xStr;
	}
	// *** 过滤危险的HTML
	static function filHtml($val){
		$string = $val;
		$searcharr = array("/(javascript|jscript|js|vbscript|vbs|about):/i","/on(mouse|exit|error|click|dblclick|key|load|unload|change|move|submit|reset|cut|copy|select|start|stop)/i","/<script([^>]*)>/i","/<iframe([^>]*)>/i","/<frame([^>]*)>/i","/<link([^>]*)>/i","/@import/i");
		$replacearr = array("\\1\n:","on\n\\1","&lt;script\\1&gt;","&lt;iframe\\1&gt;","&lt;frame\\1&gt;","&lt;link\\1&gt;","@\nimport");
		$string = preg_replace($searcharr,$replacearr,$string);
		$string = str_replace("&#","&\n#",$string);
		return $string;
	}
	// *** 从Html内容中截取字符串，
	static function filHText($xStr,$xLen=0) {
		$xStr = preg_replace("/<\!--.*?-->/si","",$xStr); //注释
		$xStr = strip_tags($xStr); 
		$xStr = str_replace(array('&nbsp;'),' ',$xStr); 
		$xStr = self::filTrim($xStr); 
		if($xLen) $xStr = self::cutWidth($xStr,$xLen);
		return $xStr; // nl2br($s);
	}
	// *** Form中字符编码
	static function filForm($xStr,$type=3) {
		$xStr = htmlentities($xStr,$type,"UTF-8"); //type=3=ENT_QUOTES:编码双引号和单引号
		return $xStr;
	}
	// *** Account过滤帐号
	static function filKey($str,$ext='_'){
	   $re = '';
	   if(strlen($str)){ //$str=0
		   $tmp = KEY_NUM10.KEY_CHR26.$ext; //-._@
		   $tab = strtoupper($tmp).strtolower($tmp); 
		   for($i=0;$i<strlen($str);$i++) { 
			   if(strstr($tab,substr($str,$i,1))) $re .= substr($str,$i,1);
		   }
	   }
	   return $re;
	}
	// *** Safe4过滤标题
	static function filSafe4($xStr,$exa=array('%')){
		$def = array('<','>','"',"'","\\"); //开始为前4个,\,%后续加上
		if(!empty($exa)){ 
			foreach($exa as $val) $def[] = $val;
		}
		$xStr = str_replace($def,'',$xStr); 
		return $xStr;
	}
	// *** Title过滤标题
	static function filTitle($xStr){
		$xStr = str_replace(array('<','>','"',"'","\\","\r","\n",'&','#'),'',$xStr); 
		return $xStr;
	}
	// *** 过滤空行和注释
	static function filNotes($str){
		$str = preg_replace('/\/\*(.*?)\*\//is','',$str);
		$str = preg_replace('/\/\/(.*?)\ /is','',$str);
		$str = preg_replace('( [\s| ]* )'," ",$str);
		$str = preg_replace("/<\!--.*?-->/si","",$str); //注释
		return $str; 
	}

	// 去除多余的空格和换行符
	static function filTrim($str,$mode=0){
		$str = trim($str);
		if($mode==1){ 
			// 去除多个空白
			$str = preg_replace("/[\s]{2,}/", '', $str);
		}elseif($mode==2){ 
			// 去除所有的空格和换行符
			$str = preg_replace("/\s+/", '', $str);
		}else{
			// 去除多余的空格和换行符，只保留(第)一个
			$str = preg_replace("/\s(?=\s)/","\\1",$str); 
		}
		return $str;
	}

	// Check字符处理

	static function isKey($str,$m1=3,$m2=12,$type='') {
		$new = self::filKey($str,$type);
		$len = strlen($new);
		return $str===$new && $len>=$m1 && $len<=$m2;
	}

	static function isMail($email) {
		return strlen($email) > 6 && preg_match("/^[\w\-\.]+@[\w\-\.]+(\.\w+)+$/", $email);
	}
	// 检查字符串是否是UTF8编码,是返回true,否则返回false
	static function isUtf8($str,$re='T/F'){
		$flag = mb_detect_encoding($str, array('ASCII','GB2312','GBK','BIG5','UTF-8'));
		if($re=='T/F'){
			return $flag === 'UTF-8';
		}else{
			return $flag;
		}
	}
	// 避免重复转utf-8，只转需要转的文档
	static private function isConv($str = ''){
		if(!$str) return FALSE;
		if(mb_detect_encoding($str,'UTF-8',TRUE) == 'UTF-8') return FALSE; //本就是UTF8的编码
		return TRUE;	
	}

	// 隐藏电话,手机,邮件,qq,ip的中间一部分
	// ('13712345678','',3) -> 137****5678
	static function subReplace($str,$char='',$dstart=0){
		$char = empty($char) ? '*' : $char;
		if(strpos($str,'@')>0){
			$a = explode('@',$str);
			$suf = '@'.$a[1];
			$str = $a[0];
		}else{
			$suf = '';
		}
		$len = strlen($str);
		if($len<3) return $str.$suf;
		if($len<6) $n = 2;
		else $n = 4;
		$start = $dstart ? $dstart : (($len-6)<1 ? 1 : $len-6);
		$re = ''; for($i=0;$i < $n;$i++) $re .= $char;
		$str = substr_replace($str,$re,$start,$n);
		return $str.$suf;
	}

}


/*******************************************************************************
 File : \code\core\blib\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\blib\system.php 
*******************************************************************************/
<?php 
/**
 * 类的自动加载
 * spl_autoload_register('func_name'); //可以多个...
 * spl_autoload_register(array('autoLoad_ys','load')); 	
 */
class autoLoad_ys{
	
	static $acdirs = array();
	static $cfgpr4 = array();
	static $cfgnsp = array();
	static $cfgmap = array();
	
	static $upath = array();
	
	// autoLoad_ys::ureg('/adpt/wechat'); //code目录下
	// autoLoad_ys::ureg('/a3rd/wechat',0); //root目录下
	static function ureg($upath,$pcode=1){
		$key = $pcode ? 'code' : 'root';
		if(empty(self::$upath[$key]) || !in_array($upath,self::$upath[$key])){ 
			self::$upath[$key][] = $upath;
		}
		spl_autoload_register(array(__CLASS__,'uload'));
	}
	static function uload($name){ 
		foreach(self::$upath as $key=>$kpath){ 
			foreach($kpath as $path){ 
				self::doinc($path."/$name.php",constant("DIR_".uppercase($key)));
			}
		}
	}
	
	static function init(){ 
		require DIR_CODE.'/cfgs/boot/cfg_load.php';
		self::$acdirs = $_cfgs['acdir'];
		self::$cfgpr4 = $_cfgs['acpr4'];
		self::$cfgnsp = $_cfgs['acnsp']; 
		self::$cfgmap = $_cfgs['acmap'];
		spl_autoload_register(array(__CLASS__,'cload')); 
		spl_autoload_register(array(__CLASS__,'vload')); 
	}
	// 核心类库
	static function cload($name){ 
		$path = ''; 
		if(isset(self::$cfgmap[$name])){ // 自定义-class-map
			if(substr(self::$cfgmap[$name],0,1)=='~'){
				$base = DIR_CODE;
				$file = substr(self::$cfgmap[$name],1);
			}else{
				$base = DIR_VENDOR;
				$file = self::$cfgmap[$name];
			} 
			return self::doinc($file,$base);
		}else{ // 按[前缀-目录]对照加载
			$fx3 = substr($name,0,3); //echo "<br>$name";
			foreach(self::$acdirs as $dir=>$fixs){ //
				if(strstr($fixs,$fx3)){ 
					return self::doinc("/$dir/$name.php",DIR_CODE);
				}
			}
		}
	}
	// 第三方
	static function vload($name){ 
		// -pr4规范
		foreach(self::$cfgpr4 as $k=>$v){ 
			if(!strstr($name,$k)) continue; //strpos比file_exists快多了吧？
			$file = str_replace('\\', '/', str_replace($k, $v[0].'/', $name)).'.php'; 
			return self::doinc($file,DIR_VENDOR);
		}
		// -namespace规范
		foreach(self::$cfgnsp as $k=>$v){ 
			if(!strstr($name,$k)) continue; //strpos比file_exists快多了吧？
			$file = str_replace('\\', '/', $v[0].'/'.$name).'.php'; 
			return self::doinc($file,DIR_VENDOR);
		}
		return ''; 
	}
	// inc
	static function doinc($file,$base=''){
		global $_cbase; 
		if(file_exists($base.$file)){ 
			$_cbase['run']['aclass'][] = $file;
			require($base.$file); 
		}
	}
}

/**
 * 权限判断函数
 * 用于未加载核心类库场合
 */
function bootPerm_ys($key='',$re='0',$exmsg=''){
	global $_cbase; // 不能用cfg()
	$tid = preg_replace("/[^\w]/", '', $_cbase['safe']['safil']); 
	$sid = 'pmSessid_'.$tid; //echo $sid;
	if($re=='sid') return $sid;
	$sval = @$_SESSION[$sid];
	if(empty($key)){
		$msg = empty($sval) ? '-' : '';
	}else{ 
		$msg = strstr($sval,$key) ? '' : "$key";
	} 
	if($msg){
		if(!empty($re)) return $msg;
		$exmsg && $exmsg = "<hr>$exmsg";
		die("NO Permission :<br>\n$msg$exmsg"); 
	}
}

/**
 * 一组别名（使用Symfony的dump后添加的）
 * 为保持最大兼容性，`core/blib|clib|elib`不建议用别名
 * 如果与其它程序一起使用，发现有如下函数冲突，请设置[run.outer]参数即可
 * 设置[run.outer]后，如需要用本系统方法，请用autoLoad_ys::init()加载即可
 */
if(empty($_cbase['run']['outer'])){ 
	// dump(格式化输出：变量，数组，Object)
	function dump($var){  
		basDebug::varShow($var);
	}
	// cfg(读取配置) cfg('sys.cset','cbase');
	function cfg($key,$mod='cbase',$defval=''){
		return glbConfig::get($key,$mod,$defval);
	}
	// lang(显示语言标识)
	function lang($mk, $val=''){
		if($val===0){ 
			echo basLang::show($mk, $val===0?'':$val);
		}else{ 
			return basLang::show($mk, $val);
		}
	}
	/*
	// dmap(按类型，键值输出所有变量，数组，Object)
	function dmap($url="?_deTest=peaceTest"){
		basDebug::varMain($url);
	}*/
	// read(读取缓存)
	function read($file,$dir='modcm',$type='inc'){
		return glbConfig::read($file,$dir,$type);
	}
	// req(获得get/post参数)
	function req($key,$def='',$type='Title',$len=255){
		return basReq::val($key,$def,$type,$len);
	}
}

/**
 * 一组handler函数
 */
/*
function uerr_handler($msg='') {  
	return $msg; 
}
*/
// 默认异常处理函数
function except_handler_ys($e) {  
	throw new glbError($e); 
}
// 默认错误处理函数
function error_handler_ys($Code,$Message,$File,$Line) {  
	throw new glbError(@$Code,$Message,$File,$Line); 
}
// 当php脚本执行完成,或者代码中调用了exit ,die这样的代码之后：要执行的函数
function shutdown_handler_ys() {  
	//echo "(shutdown)";
	basDebug::bugLogs('handler',"[msg]","shutdown-".date('Y-m-d').".debug",'file');
}

//(!function_exists('intl_is_failure'))



/*******************************************************************************
 File : \code\core\clib\comConvert.php 
*******************************************************************************/
<?php 

// 编码转化,加密类
class comConvert{				  
	
	// 加载-table数据 Peace/jianfan.txt
	static function impData($name,$part='',$re='arr'){   
		$f1 = 'start(!@~)'; $f2 = '(!@~)isend'; $f0 = '(split!@~flag)'; // 标记 
		$file = DIR_STATIC.'/ilibs'.$name; 
		if(file_exists($file)){
			$data = comFiles::get($file);
		}else{
			return '';
		} 
		$p1 = strpos($data,$f1)+10; $p2 = strpos($data,$f2);
		$data = substr($data,$p1,$p2-$p1);
		if($part){
			$len = strlen($part)+2;
			$p1 = strpos($data,"[$part]")+$len; $p2 = strpos($data,"[/$part]");
			$data = substr($data,$p1,$p2-$p1);
		}
		$data = basElm::line2arr($data,0);
		$data = str_replace(array("--"),"",$data);
		if(strpos($data,$f0)>0){
			$data = preg_replace('/\s/','',$data);
			return explode($f0,$data);
		}else{
			if($re=='arr'){
				$data = explode("\n",$data);
				$data = array_filter($data); //filter/slice
				return $data;
			}else{
				return $data;  
			}	
		}
	} // 'Peace/tmpdata.txt','model','Peace/jianfan.txt','Peace/pinyin.txt','','str'
	
	// 自动转换字符集 支持数组转换
	static function autoCSet($str,$from='gbk',$to='utf-8'){
		if(empty($str) || empty($from) || empty($to)) return $str;
		$from = strtoupper($from)=='UTF8'? 'utf-8':$from;
		$to = strtoupper($to)=='UTF8'? 'utf-8':$to;
		if( strtoupper($from) === strtoupper($to) || (is_scalar($str) && !is_string($str)) ){
			return $str; //如果编码相同或者非字符串标量则不转换
		}
		if(is_string($str) ) {
			if(function_exists('iconv')){
				return iconv($from,$to."//IGNORE",$str); 
			}elseif(function_exists('mb_convert_encoding')){
				return mb_convert_encoding ($str, $to, $from);
			}else{
				return $str;
			}
		}elseif(is_array($str)){
			foreach ( $str as $key => $val ) {
				$str[$key] = self::autoCSet($val,$from,$to);
				// 不考虑key转化
			}
			return $str;
		}else{
			return $str;
		}
	}
	
	// sn:3369512d-e369-czyx-xmao-2016-5w76dm47
	static function sysSn($area='czyx',$corp='xmao'){ 
		$time = str_replace('-','',basKeyid::kidTemp('6'));
		$enc = md5("$area.$time.$corp");
		$res = substr($enc,7,8).'-'.substr($enc,23,4);
		$res .= "-$area-$corp-";
		$res .= substr($time,0,4).'-'.substr($time,4,8);
		//echo "$time<br>$enc<br>$res";
		return $res;
	}
	
	static function sysPass($uid='',$upw='',$mod=''){ 
		if(empty($uid) || empty($upw)) return '(null)';
		$pfix = $mod=='adminer' ? cfg('safe.pass').$mod : 'pass';
		return self::sysEncode("$upw@$uid",$pfix,24);
	}
	// *** 加密MD5
	// $methods:md5,sha1,(md5比sha1快点)
	// $ukey = in_array($ukey,array('pass','form','api','js','other'))
	static function sysEncode($str,$ukey='other',$len=16,$methods='md5,sha1'){
		$safe = cfg('safe');
		$fmd5 = false; $fsh1 = false;
		$a = explode(',',$methods);
		foreach($a as $m){ 
			if(!in_array($m,array('md5','sha1'))) $m = 'sha1';
			if($m=='md5') $fmd5 = true; if($m=='fsh1') $fsh1 = true;
			$str = $m($str);
		}
		if(!$fmd5) $str = md5($str); if(!$fsh1) $str = sha1($str);
		$ukey || $ukey = 'other';
		$ukey = isset($safe[$ukey]) ? $safe[$ukey] : $ukey;
		$skey = $safe['site'];
		$ostr = "$skey@$str@$len@$ukey";
		$str = sha1($ostr).hash('ripemd128',$ostr); // 72位
		$len || $len = 16;
		return substr($str,(strlen($str)-$len)/2,$len); 
	}
	
	//加密解密，$key：密钥；$de：是否解密；$expire 过期时间
	static function sysRevert($str, $de=0, $key='', $exp=0){
		$key || $key = cfg('safe.other'); 
		$nn = 4; $key = md5($key); $res = '';
		$keya = md5(substr($key,0,16)); $keyb = md5(substr($key,16,16));
		if($de){
			$str = str_replace(array('.','_',),array('+','/',),$str);
			$keyc = substr($str,0,$nn);
			$ckey = $keya.md5($keya.$keyc); $ckn = strlen($ckey);
			$str =  base64_decode(substr($str,$nn));
		}else{
			$str = serialize($str);
			$keyc = substr(md5(microtime()), -$nn);
			$ckey = $keya.md5($keya.$keyc); $ckn = strlen($ckey);
			$str =  sprintf('%010d', $exp ? $exp+time() : 0).substr(md5($str.$keyb),0,16).$str;
		}
		$mm = strlen($str); $box = range(0,255); $rnd = array();
		for($i=0; $i<=255; $i++){ 
			$rnd[$i] = ord($ckey[$i % $ckn]);
		}
		for($j=$i=0; $i<256; $i++) {
			$j = ($j + $box[$i] + $rnd[$i]) % 256;
			$tmp = $box[$i]; $box[$i] = $box[$j]; $box[$j] = $tmp;
		}
		for($a=$j=$i=0; $i<$mm; $i++) {
			$a = ($a + 1) % 256;
			$j = ($j + $box[$a]) % 256;
			$tmp = $box[$a]; $box[$a] = $box[$j]; $box[$j] = $tmp;
			$res .= chr(ord($str[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));
		}
		if($de){
			if(substr($res,0,10)==0 || substr($res,0,10)-time()>0) {
				return unserialize(substr($res,26));
			}
			return '';
		}else{
			$res = base64_encode($res); 
			return $keyc.str_replace(array('+','/','='),array('.','_',''),$res);
		}
	}
	
	//base64编码(并加密/解密)
	static function sysBase64($s,$de=0,$key=''){
		if(empty($s)) return $s;
		$safe = cfg('safe');
		$org = basKeyid::kidRTable('f','org');
		$rnd = $safe['rndtab'].'.-'; $re = ''; 
		$fix = ($key ? $key : $safe['rndch6'])."^";
		if($de){ 
			for($i=0;$i<strlen($s);$i++){
				$ch = $s{$i}; $p = strpos($rnd,$ch); 
				$re .= $p===false ? $ch : $org{$p}; 
			}
			$s = $re;
		}else{
			$s = $fix.$s;	
		}
		$s = comParse::urlBase64($s,$de); 
		if($de){ 
			$s = substr($s,strlen($fix));
		}else{
			for($i=0;$i<strlen($s);$i++){
				$ch = $s{$i}; $p = strpos($org,$ch); 
				$re .= $p===false ? $ch : $rnd{$p}; 
			}
			$s = $re;
		}
		return $s;
	}

	static function jianfanMain($str,$type='j2f',$cset='3'){
		$jf=""; $p = 0; $len = strlen($str);
		if($type=='j2f'){
			$tab1 = self::jfcfgTab('Jian');
			$tab2 = self::jfcfgTab('Fan');
		}else{
			$tab2 = self::jfcfgTab('Jian');
			$tab1 = self::jfcfgTab('Fan');
		}
		for($i=0;$i<$len;$i++){   
			$ch = substr($str,$p,1);
			if(ord($ch)<128){ 
				$jf .= $ch;
				$p++;
			}else{
				$ch = substr($str,$p,$cset);
				$tp = strpos($tab1,",$ch"); 
				if($tp) $ch = substr($tab2,$tp+1,$cset);
				$jf .= "$ch";  
				$p += $cset; 
			}
			if($p>=$len) break;
		}   
		return $jf; 
	}
	
	static function pinyinOne($chr){
		$tab = self::pycfgTab();
		$p = strpos($tab,$chr); 
		$t = substr($tab,0,$p);
		$t = strrchr($t,"(");
		$p = strpos($t,")");
		$t = substr($t,1,$p-1);
		return $t;   
	}
	// 内页广告: 0-neiyeguanggao, 1-n, 9-nygg
	static function pinyinMain($str,$cset='3',$first=0){
	  $py=""; $p = 0; $len = strlen($str);
	  for($i=0;$i<$len;$i++){   
		  $ch = substr($str,$p,1);
		  if(ord($ch)<128){ 
			$py .= $ch;
			$p++;
		  }else{
			$ch = substr($str,$p,$cset);
			$tmp = self::pinyinOne($ch); 
			$py .= $first ? substr($tmp,0,1) : $tmp;  
			$p += $cset;  
		  }
		  if($first===1 && $py) return substr($py,0,1); 
		  if($p>=$len) break;
	  }
	  return $py; 
	}
	
	static function jfcfgTab($key){
		static $jfcfg_tab;
		if(!isset($jfcfg_tab)){ 
			$jfcfg_tab = self::impData('/jianfan.imp_txt');
		}
		$id = $key=='Fan' ? 1 : 0;
		return $jfcfg_tab[$id];
	}
	static function pycfgTab(){
		static $pycfg_tab;
		if(!isset($pycfg_tab)){ 
			$pycfg_tab = self::impData('/pinyin.imp_txt','','str');
		}
		return $pycfg_tab;
	}

}




/*******************************************************************************
 File : \code\core\clib\comCookie.php 
*******************************************************************************/
<?php
// sysCookie
class comCookie{	

	// *** Cookie操作 user@peace+pass@123456
	
	// mset :
	static function mset($gkey,$glife,$key='',$value='',$max=5){
		if(is_array($key)){
			$garr = $key;
			$max = 99;
		}else{
			$gtxt = self::oget($gkey);
			$garr = basElm::text2arr($gtxt); 
			$garr[$key] = $value; 
			if($gkey=='vcodes') $max = 3; //100B,最多40个,all-4K内
			//if($gkey=='clicks') $max = 5; //050B,最多80个,all-4K内
		}
		$str = ''; $n = 0; $cnt = count($garr);
		foreach($garr as $k=>$v){
			$n++;
			if(($cnt-$n) > $max) continue; 
			$str .= "$k=$v\n";
		} //echo "$gkey,$str,$glife";
		self::oset($gkey,$str,$glife);
	}
	// mget :
	static function mget($gkey,$key='(array)'){
		$gtxt = self::oget($gkey); 
		$garr = basElm::text2arr($gtxt); 
		if($key=='(array)') return $garr;
		return isset($garr[$key]) ? $garr[$key] : '';	
	}
	
	// set(k,'v',n),get(k),del(k,''),clear()
	// set/del
	static function oset($key='',$value='',$life=0,$pre='(def)'){
		global $_cbase; 
		$kbak = $key; $fset = 0;
		$ckpre = isset($_cbase['ck']['pre']) ? $_cbase['ck']['pre'] : 'sysCookie';
		$key = ($pre=='(def)'?$ckpre:$pre).$key; 
		$life && $life = time() + $life + $_cbase['sys']['tmzone']*3600; //,  + 72 * 3600
		$path = isset($_cbase['ck']['path']) ? $_cbase['ck']['path'] : '/'; 
		$domain = isset($_cbase['ck']['domain']) ? $_cbase['ck']['domain'] : '';
		$secure = $_SERVER['SERVER_PORT'] == 443 ? 1 : 0;
		//basDebug::bugLogs('test1',"($value),($life=".date('Y-m-d H:i:s',$life)."),$path,$domain,$secure");
		setcookie($key,$value,$life,$path,$domain,$secure); 
	}

	static function oget($key=''){
		global $_cbase; 
		$kbak = $key; $fset = 0;
		$ckpre = isset($_cbase['ck']['pre']) ? $_cbase['ck']['pre'] : 'sysCookie';
		$key = $ckpre.$key; 
		return isset($_COOKIE[$key]) ? $_COOKIE[$key] : '';
	}
	
}




/*******************************************************************************
 File : \code\core\clib\comFiles.php 
*******************************************************************************/
<?php

// Files类
class comFiles{	

	//重定义file_get_contents来兼容不支持此函数的PHP
	static function get($fname){
		//return file_get_contents($fname);
		if(!file_exists($fname) || is_dir($fname)){
			return '';
		}else{
			$fp = fopen($fname, 'r');
			$size = filesize($fname);
			if($size==0) return '';
			$ct = fread($fp, $size);
			fclose($fp);
			return $ct;
		}
	}

	//重定义file_put_contents来兼容不支持此函数的PHP
	static function put($fname, $data){
		//return file_put_contents($fname, $data);
		$fp = @fopen($fname, "w");
		if(!$fp){
			$re = FALSE;
		}elseif(flock($fp,LOCK_EX)){ // 排它性的锁定
			fwrite($fp, $data);
			flock($fp,LOCK_UN); // release lock
			fclose($fp);
			$re = TRUE;
		}else{
			$re = FALSE;
		}
		return $re;
	}

	// 移除BOM
	static function killBOM($str){ 
		$len = strlen($str); 
		if($len==0) return $str;
		$start = 0;
		for($i=0; $i<$len; $i++) {
			$chr = ord($str[$i]);
			if(in_array($chr,array(239,187,191))){
				$start++;
			}else{
				return $start ? substr($str,$start) : $str;
				break;
			}
		}
		return $str;
	}

	static function getTIcon($file){ 
		$cfg = glbConfig::read('filetype','ex');
		$type = $icon = 'unknow';
		$ext = strtolower(strrchr($file,"."));
		$ext = substr($ext,1);
		foreach($cfg as $k=>$v){
			if(in_array($ext,$v)){
				$icon = $v[0];
				$type = $k;
				break;
			}
		}
		return array('type'=>$type,'icon'=>$icon); //'unknow';
	}

	static function listScan($dir,$sub='',$skips=array()){
		$re = array();
		$handle = opendir($dir);
		while ($file = readdir($handle)) {
			if($file=='.'||$file=='..') continue;
			$key = "{$sub}$file";
			$fp = "$dir/$file"; 
			if(is_dir($fp)){ //不用:file_exists
				if(empty($sub) && !empty($skips) && in_array($file,$skips)) continue; 
				$re = array_merge($re,self::listScan($fp,"$sub$file/"));
			}else{
				$mtime = filemtime($fp);
				$re[$key] = array($mtime,filesize($fp));
			}
		}
		closedir($handle);
		return $re;
	}

	static function listDir($dir,$key=''){
		if(!is_dir($dir)) return array(); 
		$re = array('dir'=>array(),'file'=>array());
		// --- scandir();
		$handle = opendir($dir);
		while ($file = readdir($handle)) {
			if($file=='.'||$file=='..') continue;
			$fp = "$dir/$file";
			$mtime = filemtime($fp);
			if(is_file($fp)){
				$re['file'][$file] = array($mtime,filesize($fp));
			}else{
				$re['dir'][$file] = $mtime; 
			}
		}
		closedir($handle);
		if($key){ return $re[$key]; }
		return $re;
	}
	
	// 目录状态统计(大小,文件数,目录数)
	static function statDir($path){
		$msize = 0;
		$fcount = 0;
		$dcount = 0;
		if ($handle = opendir ($path)){
			while (false !== ($file = readdir($handle))){
				$nextpath = $path . '/' . $file;
				if ($file != '.' && $file != '..' && !is_link ($nextpath)){
					if (is_dir ($nextpath)){
						$dcount++;
						$result = self::statDir($nextpath);
						$msize += $result['nsize'];
						$fcount += $result['cfile'];
						$dcount += $result['cdir'];
					}elseif (is_file ($nextpath)){
						$msize += filesize ($nextpath);
						$fcount++;
					}
				}
			}
		}
		closedir($handle);
		$total['nsize'] = $msize;
		$total['cfile'] = $fcount;
		$total['cdir'] = $dcount;
		return $total;
	}

	static function chkDirs($subs,$flag='',$isfile=1){ 
		if(empty($subs)) return;
		if(strstr($subs,'../')) return;
		if($isfile){
			return self::chkDirs(dirname($subs),$flag,0);
		}
		$check = basStr::filKey($subs,'!()-@_~/'); //.+,;^`
		if($check!=$subs) return;
		$path = self::cfgDirPath($flag,'dir');
		$path || $path = DIR_DTMP;
		$a = explode('/',$subs); 
		$i = 0; $tmp = '';
		if(count($a)>0){
			foreach($a as $d){ 
				//if(empty($d)) return;
				if(!is_dir($path."$tmp/$d")){ 
					mkdir($path."$tmp/$d", 0777, true);	
					foreach(array('htm','html') as $var) @touch($path."$tmp/$d".'/index.'.$var);	
				}
				$tmp .= "/$d"; $i++;
				if($i==12) break;
			}
		}
	}

	//遍历删除目录和目录下所有文件
	static function delDir($dir,$delself=0,$keep='',$first=1){
		if(strlen($dir)<6) return false; //  /a/b  c:/a/b
		if(!defined('indo_Verset')){
			if(strstr($dir,DIR_CODE) || strstr($dir,DIR_ROOT) || strstr($dir,DIR_STATIC) || strstr($dir,DIR_VENDUI) || strstr($dir,DIR_VENDOR)) return false;
		}
		if($first){
			if(is_file($dir)){ return @unlink($dir); };
			if(in_array(substr($dir,-1,1),array('/',"\\"))){ $dir = substr($dir,strlen($dir)-1); }
			if(!is_dir($dir)){ return false; };
		}
		$handle = opendir($dir);
		while (($file = readdir($handle)) !== false){
			if ($file != "." && $file != ".."){
				if(in_array($file,array('index.htm','index.html')) && empty($delself)) continue;
				if($keep && strstr($keep,$file)) continue;
				is_dir("$dir/$file") ? self::delDir("$dir/$file",1,'',0):@unlink("$dir/$file");
			}
		}
		if(!empty($delself)){
			if (readdir($handle) == false){
				closedir($handle);
				@rmdir($dir);
			}
		}
	}
	
	// 是否可写 //if(is_writable($pfile)){}
	static function canWrite($dir){
		if(is_dir($dir)){
			$file = '/__'.basKeyid::kidTemp().'__.test';
			if($fp = @fopen($dir.$file, 'w')) {
				@fclose($fp);
				@unlink($dir.$file);
				$fwrite = 1;
			}else $fwrite = 0;
		}elseif(is_file($dir)){
			$fwrite = is_writable($dir);
		}else{
			$fwrite = 0;	
		}
		return $fwrite;
	}
	
	// 复制目录 : $src -> $dst
	// $skip : 忽略目录
	static function copyDir($src,$dst,$skip=array(),$skfile=array()) {  // 原目录，复制到的目录
		$dir = opendir($src);
		@mkdir($dst);
		while(false !== ( $file = readdir($dir)) ) {
			if (( $file != '.' ) && ( $file != '..' )) {
				if(is_dir($src.'/'.$file)){
					if(!empty($skip) && in_array($file,$skip)) continue;
					self::copyDir($src.'/'.$file, $dst.'/'.$file,$skip,$skfile);
				}else{
					if(!empty($skfile) && in_array($file,$skfile)) continue;
					copy($src.'/'.$file, $dst.'/'.$file);
				}
			}
		}
		closedir($dir);
	}
	
	/**
	 * 上传到的临时目录，后续再移动到正式目录
	 * @return string
	 */
	static function getTmpDir($isfull=1){
		$user = usrBase::userObj();
		$sid = empty($user->sinit['sid']) ? usrPerm::getUniqueid('Cook','sip') : $user->sinit['sid'];
		$path = "@udoc/$sid"; //$modFix-
		self::chkDirs($path,'tmp',0);
		return ($isfull ? DIR_DTMP.'/' : '')."$path"; //PATH_ROOT
	}
	
	static function fixTmpDir($path){
		$pos = strpos($path,"/@udoc/");
		$path = PATH_DTMP.substr($path,$pos);
		return $path;
	}
	
	/**
	 * 上传资源目录
	 * @return string
	 */
	static function getResDir($mod,$kid='',$isfull=1,$chkdir=0){
		$user = usrBase::userObj();
		if(empty($kid)){
			$kid = basReq::val('did');
			$kid || $kid = basReq::val('uid');
			$kid || $kid = basReq::val('cid');
			$kid || $kid = basReq::val('kid');
		}
		$kpath = $kid; 
		$fmts = vopTpls::etr1('res'); $fmt = 1; //yyyy/md-noid默认
		foreach($fmts as $k=>$v){
			if(in_array($mod,$v)){ $fmt = $k; }
		}
		if(strpos($kid,'-')){
			$ka = explode('-',$kid);
			if($fmt==1) $kpath = $ka[0].'/'.$ka[1].'-'.$ka[2];
			if($fmt==2) $kpath = $ka[0].'-'.$ka[1].'/'.$ka[2];
			if($fmt==3) $kpath = $ka[0].'/'.$ka[1].'/'.$ka[2];	
		}else{ // 加了一层目录,有些人不喜欢...
			$groups = glbConfig::read('groups');
			if(isset($groups[$mod]) && in_array($groups[$mod]['pid'],array('docs','users'))){
				$kpath = (empty($fmt) ? '' : "home/")."$kid";
			}elseif(isset($groups[$mod]) && in_array($groups[$mod]['pid'],array('types'))){
				$kpath = '';
			}else{ // coms 
				$kpath = $kid;
			}
		}
		$repath = empty($kpath) ? $mod : "$mod/$kpath";
		$chkdir && self::chkDirs($repath,'res',0);
		return ($isfull ? DIR_URES.'/' : '').$repath;
	}
	
	//移动临时文件夹中的文件
	static function moveTmpDir($str,$mod='',$kid='',$ishtml=0){
		global $_cbase;
		if($ishtml){ //a,img,embed,value?,
			preg_match_all("/\s+(src|href|value)=(\S+)[\s|>]+/i",$str,$arr); //3
			$ar2 = empty($arr[2]) ? array() : str_replace(array("\\",'"',"'"),array(),$arr[2]); 
			//echo "<pre>"; print_r($arr); die();
		}else{
			if(strpos($str,';')){ //pics
				$ar2 = explode(';',$str);
				foreach($ar2 as $k=>$v){
					$art = explode(',',$v);
					if(empty($art[0])) unset($ar2[$k]);
					else $ar2[$k] = str_replace(array("\r","\n",' '),array('','',''),$ar2[$k]);
				}
			}else{
				$ar2 = array($str);
			}
		} 
		$ar2 = array_unique(array_filter($ar2));
		if(empty($ar2)) return $str;
		$fix = PATH_DTMP."/@udoc/";
		foreach($ar2 as $v){
			if($org=strstr($v,$fix)){
				$orgfile = DIR_DTMP.substr($org,strlen(PATH_DTMP));
				$obj = self::getResDir($mod,$kid,0,1)."/".basename($org);
				if(in_array($org,$_cbase['run']['tmpFile'])){
					$str = str_replace($v,'{resroot}/'.$obj,$str);
					continue;
				}elseif(is_file($orgfile)){ 
					if($re=rename($orgfile,DIR_URES.'/'.$obj)){
						$str = str_replace($v,'{resroot}/'.$obj,$str);
						$_cbase['run']['tmpFile'][] = $org;
						continue;
					}
				}
			}
			$cfg = array(
				array('tmp','/@udoc/'), 
				array('res',"/$mod/"), 
				array('htm',"/$mod/"),
				array('stc',"/"), 
				array('vui',"/"), 
				array('vnd',"/"), 
				array('web',"/"),
			);
			foreach($cfg as $cv){
				$str = self::moveRepRoot($str,$v,$cv[0],$cv[1]);
			}
		} //die();
		return $str;
	}
	
	//替换root路径
	static function moveRepRoot($str,$v,$key,$fix=''){
		$rsite = cfg('run.rsite');
		$cfg = self::cfgDirPath($key,'arr');
		$res = $v;
		if(strpos($res,'://')>0){ //完整路径
			if(strpos($res,$rsite)===0){ //本地
				$res = str_replace($rsite,"",$res); 
			}else{ //外网(可处理远程图...)
				return $str;	
			}
		}
		if(strpos($res,$cfg[1].$fix)===0 && !empty($cfg[1])){
			$res = '{'.$key.'root}'.substr($res,strlen($cfg[1]));
			$str = str_replace($v,$res,$str);
		}
		return $str;
	}
	
	//part:dir,arr,else
	static function cfgDirPath($key,$part='dir'){
		@$cfg = array(
			'tmp'=>array(DIR_DTMP,	PATH_DTMP),
			'res'=>array(DIR_URES,	PATH_URES),
			'htm'=>array(DIR_HTML,	PATH_HTML),
			'stc'=>array(DIR_STATIC,  PATH_STATIC),
			'vui'=>array(DIR_VENDUI,  PATH_VENDUI),
			'vnd'=>array(DIR_VENDOR,  PATH_VENDOR),
			'tpl'=>array(vopTpls::path('tpl'),''), //可能没有定义
			'tpc'=>array(vopTpls::path('tpc'),''),
			'cod'=>array(DIR_CODE,	'{PATH_CODE}'),
			'web'=>array(DIR_ROOT,	PATH_ROOT),
		);
		$re = isset($cfg[$key]) ? $cfg[$key] : array('','');
		if($part=='arr') return $re;
		$id = $part=='dir' ? 0 : 1;
		return empty($re[$id]) ? $key : $re[$id];
	}
	
	//还原保存的文件夹
	static function revSaveDir($str,$part=''){
		$cfg = array(
			'tmp',
			'res',
			'htm',
			'stc',
			'vui',
			'vnd',
			'web',
		);
		
		foreach($cfg as $ck){
			$path = self::cfgDirPath($ck,$part);
			$str = str_replace(array('{'.$ck.'root}','{$'.$ck.'root}'),$path,$str); 
			//self::moveRepRoot($str,$v,$cv[0],$cv[1]);
		}
		return $str;
	}
	
}



/*******************************************************************************
 File : \code\core\clib\comHttp.php 
*******************************************************************************/
<?php
//数据采集，doGET,doPOST,文件下载，
class comHttp
{
	public static $way = 0;
	public static $ways = array(
		'1' => array('curl_init','curlCrawl'),
		'2' => array('fsockopen','socketCrawl'),
		'3' => array('file_get_contents','fileCrawl'),
	);

	//手动设置访问方式
	static function setWay($way){
		self::$way = intval($way);
	}

	//通过get方式获取数据
	static function doGet($url, $timeout=5, $header="") {	
		return self::doPost($url, array(), $timeout, $header);
	}
	//通过POST方式发送数据
	static function doPost($url, $parr=array(), $timeout=5, $header="") {
		if(empty($url)||empty($timeout)) return false;
		if(!preg_match('/^(http|https)/is',$url)) $url = "http://".$url;
		$method = ''; #self::$way = 2;
		if(isset(self::$ways[self::$way])){
			$method = self::$ways[self::$way][1];
		}else{
			foreach(self::$ways as $item) {
				if(function_exists($item[0])){
					$method = $item[1];
					break;
				}
			}
		} 
		return $method ? self::$method($url,$parr,$timeout,$header) : false;
	}
	
	//通过 curl get/post数据 ($data: str:xml,str:json,array)
	// $data:array('_ref'=>'http://down.chinaz.com/soft/37712.htm'); 来路模拟
	// $header:'X-FORWARDED-FOR:8.8.8.8'.PHP_EOL.'CLIENT-IP:8.8.8.8' //来源IP模拟
	static function curlCrawl($url, $data=array(), $timeout=5, $header="") {
		$header = self::_getHeader($header);
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, $url);
		if(isset($data['_ref'])){ //模拟来源地址
			curl_setopt($ch, CURLOPT_REFERER, $data['_ref']);
			unset($data['_ref']);
		}
		if(!empty($data)){
			curl_setopt($ch, CURLOPT_POST, true); 
			curl_setopt($ch, CURLOPT_POSTFIELDS, $data); 
		}
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
		curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);
		curl_setopt($ch, CURLOPT_HTTPHEADER, array($header));
		if(substr($url,0,8)=='https://'){
			curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
			curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
			curl_setopt($ch, CURLOPT_SSLVERSION, 1);
		}
		$result = curl_exec($ch); 
		curl_close($ch);
		return $result;
	}
	//通过 socket get/post数据
	static function socketCrawl($url, $data=array(), $timeout=5, $header="") {
		$header = self::_getHeader($header);
		$url = parse_url($url); $errno = 0; $errstr = '';
		$url["path"] = ($url["path"] == "" ? "/" : $url["path"]);
		$url["port"] = empty($url["port"]) ? 80 : $url["port"];
		$url["query"] = isset($url["query"]) ? $url["query"] : "";
		if(($fsock = fsockopen(gethostbyname($url["host"]), $url['port'], $errno, $errstr, $timeout)) < 0){
			return false;
		}
		$request = $url["path"].($url["query"] ? "?" . $url["query"] : ""); 
		$eol = PHP_EOL; $eol2 = $eol.$eol; 
		$in  = (empty($data) ? 'GET' : 'POST')." $request HTTP/1.0$eol";
		$in .= "Host: " . $url["host"] . "$eol$header";
		if(!empty($data)){
			$pstr = http_build_query($data);  
			$in .= "Content-type: application/x-www-form-urlencoded$eol";
			$in .= "Content-Length: " . strlen($pstr) . $eol;
			$in .= "Connection: Close$eol2$pstr$eol2";
		}else{
			$in .= "Connection: Close$eol2";
		}
		if(!fwrite($fsock, $in, strlen($in))){
			fclose($fsock);
			return false;
		}
		$out = null; 
		while($buff = @fgets($fsock, 2048)){
			$out .= $buff;
		}
		fclose($fsock);
		$pos = strpos($out, $eol2);
		$head = substr($out, 0, $pos);	
		$status = substr($head, 0, strpos($head, $eol));	
		if(preg_match("/^HTTP\/\d\.\d\s([\d]+)\s.*$/", $status, $matches)){
			if(intval($matches[1]) / 100 == 2){
				return substr($out, $pos + 4, strlen($out) - ($pos + 4));
			}else{ return false; }
		}else{ return false; }
	}
	//通过 file_get_contents 函数post数据
	static function fileCrawl($url, $data=array(), $timeout=5, $header=""){
		$header = self::_getHeader($header);
		$opts = array( 
			'http'=>array(
				'protocol_version'=>'1.0',//http协议版本(若不指定php5.2系默认为http1.0)
				'timeout' => $timeout ,
				'header'=> $header,  
				'method'=> (empty($data) ? 'GET' : 'POST'),
			)
		); 
		if(!empty($data)){
			$pstr = http_build_query($data); 
			$header .= "Content-length: ".strlen($pstr);
			$opts['http']['content'] = $pstr;
		}
		$context = stream_context_create($opts);	
		return @file_get_contents($url,false,$context);
	}
	
	//默认模拟的header头 
	static function _getHeader($header="", $restr=1){
		if(!empty($header)) return $header;
		$defs = array(
			'HTTP_USER_AGENT' => 'Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko',
		);
		$cfgs = array(
			'HTTP_ACCEPT' => 'Accept',
			'HTTP_ACCEPT_LANGUAGE' => 'Accept-Language',
			'HTTP_ACCEPT_CHARSET'=>'Accept-Charset',
			'HTTP_USER_AGENT' => 'User-Agent', 
		);
		$header = array();
		foreach($cfgs as $ks=>$kn){
			if(isset($_SERVER[$ks])){
				$header[] = "$kn: ".$_SERVER[$ks];
			}elseif(isset($defs[$ks])){
				$header[] = "$kn: ".$defs[$ks];
			}
		}
		// 乱码问题: 遇到了外部$_cbase中加入,这里添加
		// 'HTTP_ACCEPT_ENCODING' = 'Accept-Encoding: gzip, deflate';
		$restr && $header = implode(PHP_EOL,$header);
		return $header;
	}

	// 下载web中的(或URL)文件
	static function downLoad($url, $showname='', $expire=1800){
		self::downCheck($url, $showname, 1);
		basEnv::obClean();
		$type = basNodef::mimeType($url);
		//发送Http Header信息 开始下载
		header("Pragma: public");
		header("Cache-control: max-age=".$expire);
		//header('Cache-Control: no-store, no-cache, must-revalidate');
		header("Expires: " . gmdate("D, d M Y H:i:s",time()+$expire) . "GMT");
		header("Last-Modified: " . gmdate("D, d M Y H:i:s",time()) . "GMT");
		header("Content-Disposition: attachment; filename=".$showname);
		header("Content-Length: ".$length);
		header("Content-type: ".$type);
		header('Content-Encoding: none');
		header("Content-Transfer-Encoding: binary" );
		readfile($url);
		return true;
	}
    // 保存远程页面(图片)到本地
    static function downSave($url, $showname='', $curl=0){
        self::downCheck($url, $showname);
        if($curl){
            $data = self::curlCrawl($url);
        }else{
            ob_start();
            readfile($url);
            $data = ob_get_contents();
            ob_end_clean();
        }
        comFiles::put($showname, $data);
        return $showname;
    }
    // downCheck
    static function downCheck(&$url, &$showname, $chkexists=0){
		if(preg_match('/^http:\/\//',$url)){
			ini_set('allow_url_fopen', 'On');
		}
		if(empty($url) || ($chkexists && !file_exists($url))) {
			throw new \InvalidArgumentException("[$url]Not Exists!");
		}
        if(empty($showname)){
            $info = parse_url($url);
            $_path = explode("/",$info['path']);
            $showname = end($_path);
        }
    }
	
    // 格式化返回数据
    static function fmtContent($content){
        $content = trim($content); // BOM标记？空白行？
        if (!$content) { return ''; }
        // json
        if(substr($content,0,1)=='{'){
            $response = json_decode($content, true);
            if (JSON_ERROR_NONE !== json_last_error()) {
                parse_str($content, $response);
                return $response; 
            }
        }
        // xml
        if(substr($content,0,1)=='<'){
            $xml = @simplexml_load_string($content); 
            if(is_object($xml)) return $xml;
        }
        // html, text
        return $content;
    }

	//兼容方法(后续去掉)
	static function curlGet($url, $timeout=5, $header="") {	
		return self::curlCrawl($url, array(), $timeout, $header);
	}
	static function curlPost($url, $parr=array(), $timeout=5, $header="") {	
		return self::curlCrawl($url, $parr, $timeout, $header);
	}

}




/*******************************************************************************
 File : \code\core\clib\comImage.php 
*******************************************************************************/
<?php
//图像:缩略图/水印处理
class comImage{

	/**
	 +----------------------------------------------------------
	 * 取得图像信息
	 +----------------------------------------------------------
	 * @param string $image 图像文件名
	 +----------------------------------------------------------
	 * @return mixed
	 +----------------------------------------------------------
	 */
	static function info($img) {
		$imageInfo = getimagesize($img); // riff webpvp8 格式，不能获取到信息
		if( $imageInfo!== false)
		 {
			$imageType = strtolower(substr(image_type_to_extension($imageInfo[2]),1));
			$imageSize = filesize($img);
			$info = array(
				"width"=>$imageInfo[0],
				"height"=>$imageInfo[1],
				"type"=>$imageType,
				"size"=>$imageSize,
				"mime"=>$imageInfo['mime']
			);
			return $info;
		}else {
			return false;
		}
	}

	/**
	 +----------------------------------------------------------
	 * 生成缩略图
	 +----------------------------------------------------------
	 * @param string $image  原图
	 * @param string $thumbname 缩略图文件名
	 * @param string $type 图像格式 
	 * @param string $maxWidth  宽度
	 * @param string $maxHeight  高度
	 * @param boolean $interlace 启用隔行扫描
	 +----------------------------------------------------------
	 * @return void
	 +----------------------------------------------------------
	 */
	static function thumb($image,$thumbname,$type='',$maxWidth=120,$maxHeight=90,$interlace=true)
	{
		// 获取原图信息
		$info = self::info($image);
		if($info !== false){
			$srcWidth  = $info['width'];
			$srcHeight = $info['height'];
			$type = empty($type)?$info['type']:$type;
			$type = strtolower($type);
			$interlace  =  $interlace? 1:0;
			unset($info);
			$scale = min($maxWidth/$srcWidth, $maxHeight/$srcHeight); // 计算缩放比例
			if($scale>=1) { // 超过原图大小不再缩略
				$width   =  $srcWidth;
				$height  =  $srcHeight;
			}else{ // 缩略图尺寸
				$width  = (int)($srcWidth*$scale);
				$height = (int)($srcHeight*$scale);
			}
			// 载入原图
			$createFun = 'ImageCreateFrom'.($type=='jpg'?'jpeg':$type);
			$srcImg	= $createFun($image);
			//创建缩略图
			if($type!='gif' && function_exists('imagecreatetruecolor'))
				$thumbImg = imagecreatetruecolor($width, $height);
			else
				$thumbImg = imagecreate($width, $height);
			// 复制图片
			if(function_exists("ImageCopyResampled"))
				imagecopyresampled($thumbImg, $srcImg, 0, 0, 0, 0, $width, $height, $srcWidth,$srcHeight);
			else
				imagecopyresized($thumbImg, $srcImg, 0, 0, 0, 0, $width, $height,  $srcWidth,$srcHeight);
			if('gif'==$type || 'png'==$type) {
				$background_color  =  imagecolorallocate($thumbImg,  0,255,0);  //  指派一个绿色
				imagecolortransparent($thumbImg,$background_color);  //  设置为透明色，若注释掉该行则输出绿色的图
			}
			// 对jpeg图形设置隔行扫描
			if('jpg'==$type || 'jpeg'==$type) imageinterlace($thumbImg,$interlace);
			// 生成图片
			$imageFun = 'image'.($type=='jpg'?'jpeg':$type);
			$imageFun($thumbImg,$thumbname);
			imagedestroy($thumbImg);
			imagedestroy($srcImg);
			return $thumbname;
		 }
		 return false;
	}
	
	// 描边文字水印
	static function wmtext($image, $text, $waterPos=array(9,10)){
		//读取原图像文件
		$imageInfo = self::info($image);
		$image_w = $imageInfo['width']; //取得水印图片的宽
		$image_h = $imageInfo['height']; //取得水印图片的高
		//读取水印文字配置
		$waterInfo = glbConfig::read('wmark','ex');
		$w = $waterInfo['width']; //取得水印图片的宽
		$h = $waterInfo['height']; //取得水印图片的高ctext
		if($image_w<=$w || $image_h<=$h){
			return 'file too SMALL!';
		}
		$func = "imagecreatefrom" . $imageInfo['type'];
		$image_im = $func($image);
		$pos = self::_pos($image_w, $image_h, $w, $h, $waterPos);
		$posX = $pos[0]; $posY = $pos[1]; 
		//设定图像的混色模式
		imagealphablending($image_im, true);
		foreach(array('ctext','cborder') as $k){
			$$k = imagecolorallocate($image_im, $waterInfo[$k], $waterInfo[$k], $waterInfo[$k]);
		}
		$tfont = DIR_STATIC.$waterInfo['font'];
		$ia = array(1,-1,-1,1,0);
		$ja = array(1,1,-1,-1,0);
		for($i=0;$i<5;$i++){ //先4个象限移动1px,再到0,实现描边(Peace)
			$tcolor = empty($ia[$i]) ? $ctext : $cborder;
			imagettftext($image_im, $waterInfo['size'], 0, $posX+$ia[$i], $posY+$ja[$i], $tcolor, $tfont, $text); 
		}
		//生成水印后的图片
		$func = "image" . $imageInfo['type'];
		$func($image_im, $image);
		//释放内存
		$imageInfo = NULL;
		imagedestroy($image_im);
	}
	// 图片水印
	static function wmpic($image, $water, $waterPos=array(9,10)){
		//读取原图像文件
		$imageInfo = self::info($image);
		$image_w = $imageInfo['width']; //取得水印图片的宽
		$image_h = $imageInfo['height']; //取得水印图片的高
		//读取水印文件
		$waterInfo = self::info($water);
		$w = $waterInfo['width']; //取得水印图片的宽
		$h = $waterInfo['height']; //取得水印图片的高
		if($image_w<=$w || $image_h<=$h){
			return 'file too SMALL!';
		}
		$func = "imagecreatefrom" . $imageInfo['type'];
		$image_im = $func($image);
		$func = "imagecreatefrom" . $waterInfo['type'];
		$water_im = $func($water);
		$pos = self::_pos($image_w, $image_h, $w, $h, $waterPos);
		$posX = $pos[0]; $posY = $pos[1]; 
		//设定图像的混色模式
		imagealphablending($image_im, true);
		imagecopy($image_im, $water_im, $posX, $posY, 0, 0, $w, $h); //拷贝水印到目标文件
		//生成水印后的图片
		$func = "image" . $imageInfo['type'];
		$func($image_im, $image);
		//释放内存
		$waterInfo = $imageInfo = NULL;
		imagedestroy($image_im);
		imagedestroy($water_im);
	}
	
	 /**
	 * +----------------------------------------------------------
	 * 图片/文字:水印(watermark)
	 * +----------------------------------------------------------
	 * @$image  原图
	 * @$type 水印类型：0-按配置, pic-配置中的图片, text-配置中的文字, 图片path-图片水印, 其它-文字内容
	 * @$$waterPos 水印位置
	   - (0-9,margin=10) 0-9:0为随机,其他代表上中下9个部分位置; margin:水印边距
	   - (-10,20)		距离下方10px, 右方20px
	 * +----------------------------------------------------------
	 */
	static function wmark($image, $type=0, $waterPos=array()){
		if(!file_exists($image)){ //检查图片是否存在
			return 'file NOT exists!';
		}
		$wcfgs = glbConfig::read('wmark','ex');
		if(empty($waterPos)) $waterPos = $wcfgs['pos'];
		if(empty($type) || in_array($type,array('pic','text'))){
			if(empty($type)) $type = $wcfgs['type'];
			if($type=='pic' && file_exists(DIR_ROOT.$wcfgs['plogo'])){
				return self::wmpic($image, DIR_ROOT.$wcfgs['plogo'], $waterPos);
			}else{
				return self::wmtext($image, $wcfgs['stext'], $waterPos);
			}
		}elseif(file_exists($type)){
			return self::wmpic($image, $type, $waterPos);
		}else{
			return self::wmtext($image, $type, $waterPos);
		}
	}
	
	// 水印位置(0-9,margin=10), (+-x,+-y)
	static function _pos($image_w, $image_h, $w, $h, $waterPos=array(0,10)){
		$pos = $x = $waterPos[0]; //九宫格位置,坐标位置x
		$gap = $y = $waterPos[1]; //九宫格边距,坐标位置y
		$posX = $posY = 0;
		if(abs($pos)<10){
			switch ($pos) {
				case 1: //1为顶端居左
					$posX = $gap;
					$posY = $gap;
					break;
				case 2: //2为顶端居中
					$posX = ($image_w - $w) / 2;
					$posY = $gap;
					break;
				case 3: //3为顶端居右
					$posX = $image_w - $w - $gap;
					$posY = $gap;
					break;
				case 4: //4为中部居左
					$posX = $gap;
					$posY = ($image_h - $h) / 2;
					break;
				case 5: //5为中部居中
					$posX = ($image_w - $w) / 2;
					$posY = ($image_h - $h) / 2;
					break;
				case 6: //6为中部居右
					$posX = $image_w - $w - $gap;
					$posY = ($image_h - $h) / 2;
					break;
				case 7: //7为底端居左
					$posX = $gap;
					$posY = $image_h - $h - $gap;
					break;
				case 8: //8为底端居中
					$posX = ($image_w - $w) / 2;
					$posY = $image_h - $h - $gap;
					break;
				case 9: //9为底端居右
					$posX = $image_w - $w - $gap;
					$posY = $image_h - $h - $gap;
					break;
				default: //0,随机
					$posX = rand(0, ($image_w - $w));
					$posY = rand(0, ($image_h - $h));
					break;
			}
			if($posX<0) $posX = rand(0, ($image_w - $w));	
			if($posY<0) $posX = rand(0, ($image_h - $h));	
		}else{
			$posX = $x<0 ? $image_w + $x: $x;
			$posY = $y<0 ? $image_h + $y: $y;
		}
		return array($posX, $posY);
	}

}




/*******************************************************************************
 File : \code\core\clib\comPager.php 
*******************************************************************************/
<?php 

// 分页类
// 优化1: 多页提交，不重复计算记录数目
// 优化2: ORDER BY 主键，不用 OFFSET
class comPager{	
	// sql
	public  $sfrom = '';
	public  $where = '';
	// page
	//public  $paras = '?';
	public  $psize = 20; //分页大小
	public  $page = 1; //当前页
	// page para
	public  $prec = 0; //总记录数
	public  $ptype = 'start'; //first,prev,next,last
	public  $pkey = ''; 
	public  $pjump = 0; //jump
	// order	
	public  $order = ''; //排序字段,含前缀,如a.aid
	public  $orderb = ''; //排序字段,去掉了前缀,如aid
	public  $odesc = true;
	public  $opkey = false; 
	
	public  $rs = array();
	public  $bar = array();
	public  $sql = array('','');

	//function __destory(){  basDebug::bugLogs('page'); }
	function __construct($sfrom,$where,$psize=0,$order=''){ 
		$this->sfrom = $sfrom;
		$this->where = $where;
		$this->psize = $psize;
		$this->order = $order;
		if(strpos($order,'.')){
			$this->orderb = substr($order,strpos($order,'.')+1);
		}else{
			$this->orderb = $order;	
		}
		// init;
		$a = array('page','prec','pjump','ptype','pkey',); //'odesc','opkey',
		foreach($a as $k){
			if(!empty($_GET[$k])){ 
				$__v = basReq::val($k,'Key',24); //req($k); 
				if(in_array($k,array('page','prec','pjump',))) $__v = max(0,intval($__v));
				$this->$k = $__v;
			}
		}
		if(''!==$om=basReq::val('odesc','N',1)){ $this->odesc = $om; }
	}
	
	function set($key,$value=0){
		if(is_array($key)){
			foreach($key as $k=>$v) $this->set($k,$v);
		}else{
			$this->$key = $value;
		} // if(in_array($var,get_object_vars($this)))
	}
	
	function sql($cnt=''){ 
		$sfrom = ' SELECT '.$this->sfrom;
		if($cnt){
			$where = $this->where ? ' WHERE '.$this->where : '';
			$this->sql[1] = basSql::fmtCount($sfrom.$where,$cnt);
			return $this->sql[1];
		}else{
			$where = ' WHERE '.($this->where ? $this->where : '1=1');
			$ptype = $this->ptype;
			$pkey = $this->pkey;
			$odesc = $this->odesc;
			if($this->opkey&&$ptype){
				if($ptype=='start'){
					$where .= "";	
				}else if($ptype=='end'){
					$where .= "";
				}else if($ptype=='next'){ 
					if($odesc) $where .= " AND {$this->order}<'$pkey'";
					if(!$odesc) $where .= " AND {$this->order}>'$pkey'";
				}else if($ptype=='prev'){
					if($odesc) $where .= " AND {$this->order}>'$pkey'";
					if(!$odesc) $where .= " AND {$this->order}<'$pkey'";
				} 
				if($ptype=='end'){
					$lcnt = $this->prec%$this->psize;
					$lcnt = $lcnt ? $lcnt : $this->psize;
					$limit = ' LIMIT '.$lcnt; //echo "@@@$limit";
				}else{
					$limit = ' LIMIT '.$this->psize;
				}
				if($this->pjump) $limit = ' OFFSET '.($this->pjump*$this->psize);
			}else{
				$offset = ($this->page-1)*$this->psize;
				$limit = " LIMIT $offset,".$this->psize;
			}
			if($where==' WHERE 1=1') $where = "";
			if($ptype=='end'||$ptype=='prev'){
				$ord_in = ' ORDER BY '.$this->order.($this->odesc ? '' : ' DESC');
				$ord_out = ' ORDER BY '.$this->orderb.($this->odesc ? ' DESC' : '');
				$this->sql[0] = "SELECT * FROM ($sfrom $where $ord_in $limit) _tab__ $ord_out ";
			}else{
				$order = ' ORDER BY '.$this->order.($this->odesc ? ' DESC' : '');
				$this->sql[0] = $sfrom.$where.$order.$limit;
			} //echo "<br>{$this->sql[0]}";
			return $this->sql[0];
		}
	}
	function exe(){
		$db = glbDBObj::dbObj();
		$rs = $db->query($this->sql());
		if(!$this->prec){ 
			$rec = $db->query($this->sql('_rc_recs_'));
			$this->prec = $rec[0]['_rc_recs_'];
		} 
		$this->bar = $this->links();
		return $rs;
	}
	
	function show($kfirst='',$klast='',$type='',$pbase=''){
		$pbase = empty($pbase) ? basReq::getUri(-1,'','page|prec|ptype|pkey') : $pbase; 
		$pcnt = ceil($this->prec/$this->psize);
		$a = $this->bar; $bar = ''; $para = "&prec=$this->prec&page=";
		$p0 = array("{pfirst}","{pprev}","{pnext}","{plast}",);
		$p1 = array("{$para}1","$para".($this->page-1),"$para".($this->page+1),"$para".$pcnt,);
		if($this->opkey){
			$p1[0] .= "&ptype=start";
			$p1[1] .= "&ptype=prev&pkey=$kfirst";
			$p1[2] .= "&ptype=next&pkey=$klast";
			$p1[3] .= "&ptype=end";
		}
		foreach($a as $k=>$v){
			$v = str_replace($p0,$p1,$v);
			$v = str_replace("<li>","\n<li class='pg_$k'>",$v);
			$v = str_replace("{url}",$pbase,$v);
			$bar .= $v; $a[$k] = $v; 
		}
		return $bar;
	}
	
	private function links(){
		$pcnt = ceil($this->prec/$this->psize);
		$a = array(); //$bar = ''; 
		$sFirst = '&laquo;||'.basLang::show('page_First');   $sPrev = '&lt;|'.basLang::show('page_Prev');   
		$sNext = basLang::show('page_Next').'|&gt;';   $sLast = basLang::show('page_Last').'||&raquo;';
		$a['total'] = "<li>$this->prec</li>";
		$a['pagno'] = "<li>$this->page/$pcnt</li>";
		if($pcnt<=1){
			$a['first'] = "<li>$sFirst</li>";
			$a['prev']  = "<li>$sPrev</li>";
			$a['now']   = "<li>$this->page</li>";
			$a['next']  = "<li>$sNext</li>";
			$a['last']  = "<li>$sLast</li>";
		}elseif($this->page==$pcnt){
			$a['first'] = "<li><a href='{url}{pfirst}'>$sFirst</a></li>";
			$a['prev']  = "<li><a href='{url}{pprev}' >$sPrev</a></li>";
			$a['now']   = "<li>$this->page</li>";
			$a['next']  = "<li>$sNext</li>";
			$a['last']  = "<li>$sLast</li>";
		}elseif($this->page==1){
			$a['first'] = "<li>$sFirst</li>";
			$a['prev']  = "<li>$sPrev</li>";
			$a['now']   = "<li>$this->page</li>";
			$a['next']  = "<li><a href='{url}{pnext}' >$sNext</a></li>";
			$a['last']  = "<li><a href='{url}{plast}' >$sLast</a></li>";
		}else{
			$a['first'] = "<li><a href='{url}{pfirst}'>$sFirst</a></li>";
			$a['prev']  = "<li><a href='{url}{pprev}' >$sPrev</a></li>";
			$a['now']   = "<li>$this->page</li>";
			$a['next']  = "<li><a href='{url}{pnext}' >$sNext</a></li>";
			$a['last']  = "<li><a href='{url}{plast}' >$sLast</a></li>";
		}
		$a['goto'] = "<li><input type='text' id='goto' value='$this->page' maxlength='9' onchange=\"alert(1);\"/></li>";
		return $a;
	}
}




/*******************************************************************************
 File : \code\core\clib\comParse.php 
*******************************************************************************/
<?php 
/* string,array,file:解析类
 * serial : serEncode
 * json : jsonFormat,jsonDecode,jsonEncode,
 * xml(node): nodeParse
 * csv: csvPuts,csvGets
*/

// 编码转化,加密类
class comParse{	
	
	// base64,其它 -------------------------------------------------- 
	
	// 适合把中文用base64编码用于url传输(比url编码短,且都是安全字符),获取时用这个来解码
	// $s : 原字符串, 支持数组
	// $de : 0-编码, 1-解码, a-解码返回数组
	static function urlBase64($s,$de=0,$type='mkv'){
		$a2 = $type=='mkv' ? ".-" : "_~"; //《!()+,-.;@^_`~》安全13个
		if(is_array($s)) $s = basElm::arr2text($s,"\n",'=');
		if($de){
			$s = str_pad(strtr($s,$a2,"+/"),strlen($s)%4,'=',STR_PAD_RIGHT);
			$s = base64_decode($s);
			if($de=='a') $s = basElm::text2arr($s); 
		}else{
			$s = base64_encode($s);
			$s = rtrim(strtr($s,"+/",$a2),'=');
		}
		return $s;
	}
	// urlEncode,不转化中文 : 《:/?=&#%》URL 《"&<>》HTML
	static function urlEncode($str,$ext=0,$percent=0){ //url,ext,percent
		if($percent){
			$str = str_replace('%','%25',$str);
		} 
		$a = array( '#'   , '&' ); 
		$b = array( '%23' , '%26' ); 
		$str = str_replace($a,$b,$str);
		// $str = str_replace(array(' ','<','>','"',"'","\r","\n"),'',$str);, 不是参数
		$c = array( '+'   , ' ' , '"'   ,"'"   , '<'   , '>'   , "\r"  , "\n"  , "\\"  );
		$d = array( '%2B' , '+' , '%22' ,'%27' , '%3C' , '%3E' , '%0D' , '%0A' , '%5C' );
		if($ext){
			$str = str_replace($c,$d,$str);
		}
		return $str;
	}
	
	// json -------------------------------------------------- 
	
	static function csvGets($file) {
		$handle = fopen($file,'r'); 
		$arr = array();
		while ($data = fgetcsv($handle)) { //每次读取CSV里面的一行内容  
			$arr = $data; //此为一个数组，要获得每一个数据，访问数组下标即可  
		}  
		fclose($handle); 
		return $arr;
	}

	static function csvPuts($file, $data) {
		$handle = fopen($file, 'r+');
		foreach ($data as $line) {
			fputcsv($handle, $line);
		}
		fclose($handle);
	}

	// xml(node) -------------------------------------------------- 
	
	static function nodeParse($node) {
		$array = false;
		if ($node->hasAttributes()) {
			foreach ($node->attributes as $attr) {
				$array[$attr->nodeName] = $attr->nodeValue;
			}
		}
		if ($node->hasChildNodes()) {
			if ($node->childNodes->length == 1) {
				$array[$node->firstChild->nodeName] = getArray($node->firstChild);
			} else {
				foreach ($node->childNodes as $childNode) {
				if ($childNode->nodeType != XML_TEXT_NODE) {
					$array[$childNode->nodeName][] = self::nodeParse($childNode);
				} }
			}
		} else {
			return $node->nodeValue;
		}
		return $array;
	}
	// json -------------------------------------------------- 
	
	// 将数组转换为JSON字符串（兼容中文）
	static function jsonEncode($array) {		
		if(version_compare(PHP_VERSION,"5.4",">=")){
			$json = json_encode($array, JSON_UNESCAPED_UNICODE); 
		}else{
			self::jsonFormat($array, 'urlencode');
			$json = json_encode($array);
			$json = urldecode($json);
		} 
		$json = str_replace("\"},\"","\"}\n,\"",$json);
		$json = str_replace(",\",\"",",\"\n,\"",$json);
		return $json;
	}
	static function jsonDecode($str) { 
		$str = comFiles::killBOM($str);
		$str = trim($str); 
		$arr = json_decode($str,1);
		return $arr;
	}
	// 使用特定function对数组中所有元素做处理
	// $func 不用了，用self::jsonChinese代替
	static function jsonFormat(&$array, $func){ 
		if(!is_array($array)) return;
		static $recursive_counter = 0;
		if (++$recursive_counter > 1000) {
			glbError::show("possible deep recursion attack!"); 
		}
		foreach ($array as $key => $value) {
			if (is_array($value) && !empty($value)) {
				self::jsonFormat($array[$key], $func);
			} else {
				$array[$key] = self::jsonChinese($value);
				//$array[$key] = $func($value); // $func='urlencode'
			}
		}
		$recursive_counter--;
	}
	//  获取只编码中文的字符串（目前只支持UTF-8编码的字符串）
	static function jsonChinese($string){
		if (preg_match_all('/[\x7f-\xff]+/', (string) $string, $chinse)){
			$array = array();
			foreach ($chinse[0] as &$_chinse){
				$array[] = urlencode($_chinse);
			}
			$string = str_replace($chinse[0], $array, $string);
		}
		return $string;
	}
	
	// serialize -------------------------------------------------- 
	
	// 反序列化（将某些特殊字符的utf8编码转为asc码解析）不建议使用原生的unserialize。
	static function serEncode($str) { 
		$str = str_replace("\r", "", $str);
		$str = preg_replace('!s:(\d+):"(.*?)";!se', '"s:".strlen("$2").":\"$2\";"', $str ); 
		return unserialize($str); 
	}

}



/*******************************************************************************
 File : \code\core\clib\comSession.php 
*******************************************************************************/
<?php
// comSession
class comSession { 

	//public $guid = '';
	static $guid_ck = array();

	static function set($id,$val){ 
		$_SESSION[self::fill($id)] = self::fill($val);
	}
	static function get($id){ 
		return @$_SESSION[self::fill($id)];
	}
	// Session过滤
	static function fill($xStr){
		$xStr = str_replace(array('"',"'","\\",'|',':',';'),'',$xStr); //'<','>',
		return $xStr;
	}
	/*
	[ip] => 192.168.1.11 / sdltkfc6tdq8ijlui7lc68brh1
	[fix] => sessid@safil-.bbmU-dcxyE-XwrmC-ZDgoQ-pLTC+
	[enc] => 3bcf0114e73f64a55240b7c55fea7069
	[ua] => Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36
	*/
	static function guid($flg='',$nsp='',$mode=0){ //mode:Cook,Sess,UIP
		global $_cbase; 
		$sipck = empty($mode) ? $_cbase['ucfg']['guid'] : $mode;
		if(empty($sipck) || !in_array($sipck,array('Sess','UIP','Cook'))) $sipck = 'Cook'; 
		$func = "get$sipck";
		$sipck = self::$func($nsp);
		$ua = $_cbase['run']['userag']; 
		$fix = empty($nsp) ? (@$_cbase['safe']['site']) : $nsp; 
		strstr($flg,'time') && $fix .= '@'.$_cbase['run']['timer'];
		strstr($flg,'safil') && $fix .= '@'.$_cbase['safe']['safil'];
		$enc = md5($sipck.$fix.$ua); //,'fix'=>$fix
		return array('sip'=>$sipck,'sua'=>$ua,'sid'=>$enc);
	}
	
	// cookie
	static function getCook($nsp=''){
		if(!empty(self::$guid_ck[$nsp])) return self::$guid_ck[$nsp];
		$ua = md5(cfg('run.userag').$nsp);
		$ckey = "{$nsp}_".substr($ua,0,12);
		$cval = comCookie::oget($ckey);
		if(strlen($cval)<32){
			$cval = basKeyid::kidTemp().'-'.basKeyid::kidRand('24',9).'-'.substr($ua,9,9);
			comCookie::oset($ckey,$cval,31622400); //86400*366 = 31 622 400
		}
		self::$guid_ck[$nsp] = $cval;
		return self::$guid_ck[$nsp];
	}
	
	// session_id
	static function getSess($nsp=''){
		return session_id();
	}

	// 获取客户端真实IP(用于guid,session判断)
	static function getUIP($nsp=''){	
		if(!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){
			$list = explode(',',$_SERVER['HTTP_X_FORWARDED_FOR']);
			$ip = $_SERVER['REMOTE_ADDR'] = $list[0];
		}else{ //$_SERVER['HTTP_CLIENT_IP'] 是否判断?
			$ip = $_SERVER['REMOTE_ADDR'];
		} //修正...??? 
		return $ip;
	}

}



/*******************************************************************************
 File : \code\core\clib\comTypes.php 
*******************************************************************************/
<?php

// Types类
class comTypes{	
	
	// xxx
	static function getChars($arr,$deep='12345'){ 
		$a = array(); 
		foreach($arr as $k=>$v){
			if(!strstr($deep,$v['deep'])) continue;
			$v['kid'] = $k;
			$a[$v['char']][] = $v;
		}
		ksort($a);
		return $a;
	}
	
	// getSubs,所有pid以下的子分类
	static function getSubs($arr,$pid='0',$deep='12345',$ra=1){ 
		$start = '0'; $fdeep = '-1'; $a = array(); 
		foreach($arr as $k=>$v){
			if(!isset($v['deep'])) $v['deep'] = 1;
			if(!isset($v['pid'])) $v['pid'] = '0';
			if($start && $fdeep>$v['deep']) break;
			if($v['pid']===$pid){ 
				$start = '1'; 
				$fdeep = $v['deep'];
			}
			if($start && strstr($deep,$v['deep'])){
				$a[$k] = $v;
			}
		} //print_r($a);
		$re = empty($ra) ? count($a) : $a;
		return $re;
	}
	
	// getPars(所有最大级别pmax外的父分类)
	static function getPars($arr,$pmax='3'){ 
		$a = array();
		foreach($arr as $k=>$v){
			if($pmax==$v['deep']) continue;
			$a[$k] = $v;
		} 
		return $a;
	}
	
	// getLays(id对应的树形分类)
	static function getLays($arr,$id,$a=array()){ 
		$a[$id] = @$arr[$id]['title'];
		$pid = @$arr[$id]['pid'];
		if($pid){
			return self::getLays($arr,$pid,$a);	
		}else{ 
			if(count($a)>1) $a = array_reverse($a,1);
			return $a;
		}
	}
	
	// getLnks(arr对应的连接)
	static function getLnks($arr,$tpl="<a href='?key=[k]'>[v]</a>",$gap='?'){ 
		$str = '';
		foreach($arr as $k=>$v){
			$lnk = str_replace(array('[k]','[v]'),array($k,$v),$tpl);
			$str .= (empty($str) ? '' : $gap).$lnk;
		}
		return $str;
	}
	
	// getOptions(Select)
	static function getOpt($arr,$def='',$msg='',$frame=1){ 
		$_groups = glbConfig::read('groups'); 
		if(is_string($arr) && isset($_groups[$arr])){
			$imod = glbConfig::read($arr);
			$arr = $imod['i'];  
		}
		$a = basArray::opaItems($arr,'',$frame);
		return basElm::setOption($a,$def,empty($msg) ? '-<Null>-' : $msg);
	}
	

}



/*******************************************************************************
 File : \code\core\clib\comUpload.php 
*******************************************************************************/
<?php
/**
 * UEditor编辑器通用上传类
 */
class comUpload
{
	private $fileField; //文件域名
	private $file; //文件上传对象
	private $base64; //文件上传对象
	private $config; //配置信息
	private $oriName; //原始文件名
	private $fileName; //新文件名
	private $fullName; //完整文件名,即从当前配置目录开始的URL
	private $filePath; //完整文件名,即从当前配置目录开始的URL
	private $fileSize; //文件大小
	private $fileType; //文件类型
	private $stateInfo; //上传状态信息,
	public $stateMap = array();

	/**
	 * @param string $fileField 表单名称
	 * @param array $config 配置项
	 * @param type upload/remote/base64
	 */
	function __construct($fileField, $config, $type = "upload")
	{
		$this->stateMap = basLang::ucfg('cfglibs.upload');
		//dump($this->config); dump($this->stateMap);
		$this->stateMap['ERROR_TYPE_NOT_ALLOWED'] = $this->stateMap['ERROR_TYPE_NOT_ALLOWED'];
		$this->fileField = $fileField;
		$this->config = $config;
		$this->type = $type;
		if ($type == "remote") {
			$this->saveRemote();
		} else if($type == "base64") {
			$this->upBase64();
		} else {
			$this->upFile();
		}
	}

	/**
	 * 上传文件的主处理方法
	 * @return mixed
	 */
	private function upFile()
	{
		$file = $this->file = $_FILES[$this->fileField];
		if (!$file) {
			$this->stateInfo = $this->getStateInfo("ERROR_FILE_NOT_FOUND");
			return;
		}
		if ($this->file['error']) {
			$this->stateInfo = $this->getStateInfo($file['error']);
			return;
		} else if (!file_exists($file['tmp_name'])) {
			$this->stateInfo = $this->getStateInfo("ERROR_TMP_FILE_NOT_FOUND");
			return;
		} else if (!is_uploaded_file($file['tmp_name'])) {
			$this->stateInfo = $this->getStateInfo("ERROR_TMPFILE");
			return;
		}
		$this->oriName = $file['name'];
		$this->fileSize = $file['size'];
		$this->fileType = $this->getFileExt();
		$this->fullName = $this->getFullName();
		$this->fileName = $this->getFileName();
		//检查文件大小是否超出限制
		if (!$this->checkSize()) {
			$this->stateInfo = $this->getStateInfo("ERROR_SIZE_EXCEED");
			return;
		}
		//检查是否不允许的文件格式
		if (!$this->checkType()) {
			$this->stateInfo = $this->getStateInfo("ERROR_TYPE_NOT_ALLOWED");
			return;
		}
		//移动文件
		if ( !move_uploaded_file( $file[ "tmp_name" ] , $this->fullName ) ) {
			$this->stateInfo = $this->getStateInfo("ERROR_FILE_MOVE");
		}else{
			$this->stateInfo = $this->stateMap[0];
		}
	}

	/**
	 * 处理base64编码的图片上传
	 * @return mixed
	 */
	private function upBase64()
	{
		$base64Data = $_POST[$this->fileField];
		$img = base64_decode($base64Data);
		$this->fileSize = strlen($img);
		$this->oriName = 'base64_'.$this->fileSize.'_'.basKeyid::kidRand('f',4).'.png'; //$this->config['oriName']; //
		$this->fileType = $this->getFileExt();
		$this->fullName = $this->getFullName();
		$this->fileName = $this->getFileName();
		//检查文件大小是否超出限制
		if (!$this->checkSize()) {
			$this->stateInfo = $this->getStateInfo("ERROR_SIZE_EXCEED");
			return;
		}
		//移动文件
		if (!(comFiles::put($this->fullName, $img))) { //移动失败
			$this->stateInfo = $this->getStateInfo("ERROR_WRITE_CONTENT");
		} else { //移动成功
			$this->stateInfo = $this->stateMap[0];
		}

	}

	/**
	 * 拉取远程图片
	 * @return mixed
	 */
	private function saveRemote($imgUrl='')
	{
		if(empty($imgUrl)){
			$imgUrl = htmlspecialchars($this->fileField);
			$imgUrl = str_replace("&amp;", "&", $imgUrl); 
		}
		//http开头验证
		if (strpos($imgUrl, "http") !== 0) {
			$this->stateInfo = $this->getStateInfo("ERROR_HTTP_LINK");
			return;
		}
		//获取请求头并检测死链
		$heads = get_headers($imgUrl);
		if (!(stristr($heads[0], "200") && stristr($heads[0], "OK"))) {
			$this->stateInfo = $this->getStateInfo("ERROR_DEAD_LINK");
			return;
		}
		//格式验证(扩展名验证和Content-Type验证)
		//不认证：!in_array($fileType, $this->config['allowFiles']) 为了处理类似图片：http://mmbiz.qpic.cn/mmbiz/kCd...gtw/0
		$fileType = strtolower(strrchr($imgUrl, '.'));
		if (@stristr($heads['Content-Type'], "image")) { 
			$this->stateInfo = $this->getStateInfo("ERROR_HTTP_CONTENTTYPE");
			return;
		}//*/
		//打开输出缓冲区并获取远程图片
		ob_start();
		$context = stream_context_create(
			array('http' => array(
				'follow_location' => false // don't follow redirects
			))
		);
		readfile($imgUrl, false, $context);
		$img = ob_get_contents();
		ob_end_clean();
		preg_match("/[\/]([^\/]*)[\.]?[^\.\/]*$/", $imgUrl, $m);
		$this->oriName = $m ? $m[1]:"";
		$this->fileSize = strlen($img);
		$this->fileType = $this->getFileExt();
		$this->fullName = $this->getFullName();
		$this->fileName = $this->getFileName();
		//检查文件大小是否超出限制
		if (!$this->checkSize()) {
			$this->stateInfo = $this->getStateInfo("ERROR_SIZE_EXCEED");
			return;
		}
		//移动文件
		if (!(comFiles::put($this->fullName, $img))) { //移动失败
			$this->stateInfo = $this->getStateInfo("ERROR_WRITE_CONTENT");
		} else { //移动成功
			$this->stateInfo = $this->stateMap[0];
		} 

	}

	// 上传错误检查
	private function getStateInfo($errCode)
	{
		$msg = isset($this->stateMap[$errCode]) ? $this->stateMap[$errCode] : $this->stateMap["ERROR_UNKNOWN"];
		$msg = "$errCode:$msg";
		return $msg;
	}

	// 获取文件扩展名
	private function getFileExt()
	{
		$ext = strtolower(strrchr($this->oriName, '.'));
		if(empty($ext) && $this->type=='remote'){
			$ext = '.jpg';	
		} //处理类似图片:http://mmbiz.qpic.cn/mmbiz/kCd...gtw/0
		return $ext;
	}

	// 重命名文件
	private function getFullName()
	{
		$folder = comFiles::getTmpDir();
		return $folder . '/' . $this->getFileName();

	}

	// 获取文件名
	private function getFileName () {
		
		$ext = $this->getFileExt();
		$upren = basReq::val('upren','auto');
		if($upren=='auto'){ // || in_array($this->type,array('remote','base64'))
			$name = basKeyid::kidTemp().$ext;
		}else{
			if(in_array($this->type,array('remote','base64'))){
				$org = $this->oriName;
			}else {
				$org = str_replace(array($ext),array(''),$this->file["name"]);	
			}
			$org = basStr::filKey($org,'()-.@_~[]'); //-._@()[]
			$org = str_replace(array('‘','’','“','”'),array("[",']','[',']'),$org);
			$name ="{$org}~".basKeyid::kidRand('f',4).$ext;
		}
		return $this->fileName = strtolower($name);
		
	}

	// 文件类型检测
	private function checkType()
	{
		$flag = $this->config["allowFiles"]==='(supper)' ? true : in_array($this->getFileExt(), $this->config["allowFiles"]);
		return $flag;
	}
	// 文件大小检测
	private function checkSize()
	{
		$flag = $this->config["maxSize"]==='(supper)' ? true : $this->fileSize <= ($this->config["maxSize"]*1024 );
		return $flag;
	}

	/**
	 * 获取当前上传成功文件的各项信息
	 * @return array
	 */
	function getFileInfo()
	{
		return array(
			"state" => $this->stateInfo,
			"url" => comFiles::fixTmpDir($this->fullName),
			"title" => $this->fileName,
			"original" => $this->oriName,
			"type" => $this->fileType,
			"size" => $this->fileSize
		);
	}

}



/*******************************************************************************
 File : \code\core\clib\comVCode.php 
*******************************************************************************/
<?php
//生成验证码
class comVCode {

	private $im;			//图片对象
	private $imw = 160;	 //宽
	private $imh = 40;	  //高
	private $mod = '';	  //模块
	private $ttf = '';	  //字体文件
	private $code = '';	 //字符
	private $color = '';	//颜色

	function __construct($mod='(istest)', $ttf='', $type='0'){ 
		$this->mod = $mod; 
		$this->ttf = $ttf;
		$this->color = rand(1,2);  
		// 显示图片一般图片
		if(function_exists('imagecreate')){ 
			if($this->mod=='(emtel)'){
				$this->code = $type;
				$this->imw = 20+strlen($type)*20;
			}else{
				$this->code = self::strRand();
			}
			$this->im = imagecreate($this->imw, $this->imh); 
			safComm::formCVimg($this->mod, $this->code, 'save'); 
			$this->show();
		}else{ //bmp
			glbError::show("NO function:imagecreate!");
		}
	}
	
	// 显示
	function show(){ 	
		// 填充
		if(empty($type) || $this->mod=='(emtel)'){
			$color = imagecolorallocate($this->im, 255,255,255);
		}else{
			$color = imagecolorallocate($this->im, 1,1,1);
		}
		imagefill($this->im,0,0,$color);
		// 干扰: 线,点,特殊字符
		$this->rnd_lines();
		if($this->mod!='(emtel)'){
			$this->rnd_pixels();
			$this->rnd_chars();
		}
		// Draw字符,划边框
		$this->draw_str();
		imagerectangle($this->im, 0, 0, $this->imw-1, $this->imh-1, $this->rnd_color());
		// 文件格式
		$typa = array(1=>'gif', 2=>'png', 3=>'jpeg'); 
		$type = $typa[rand(1,3)]; 
		// output
		basEnv::obClean();
		header("Pragma:no-cache");
		header("Cache-control:no-cache");
		header("Content-type:image/$type");
		$func = "image$type"; //imagejpeg
		$func($this->im); 
		imagedestroy($this->im); 
	}
	
	// Draw字符
	function draw_str(){		
		for($i=0;$i<strlen($this->code);$i++) {
			$chr = $this->code[$i];
			if($this->mod=='(emtel)'){
				$size = 20;
			}elseif(ord($chr)>96){
				$size = mt_rand(22,26);
			}else{
				$size = mt_rand(16,20);
			}
			$angle = $this->mod=='(emtel)' ? 0			  : mt_rand(-30,30);
			$x	 = $this->mod=='(emtel)' ? $i*20+8		: mt_rand(10,20)+$i*26;
			$y	 = $this->mod=='(emtel)' ? mt_rand(27,29) : mt_rand(20,30);
			if(empty($this->ttf)){
				imagestring($this->im, mt_rand(1,5), $x, $y-15, $chr, $this->rnd_color($this->im));
			}else{
				$ffile = DIR_STATIC.'/media/fonts/'.$this->ttf.'.ttf'; 
				imagettftext($this->im, $size, $angle, $x, $y, $this->rnd_color(), $ffile, $chr); 
			}
		}
	}
	
	// 随机颜色
	function rnd_color($type=0){
		if(empty($type) || $this->mod=='(emtel)'){
			$xColArr = explode(";","20,220,20;20,220,40;20,240,20;20,240,40;40,220,20;40,220,40;40,240,20;40,240,40;20,20,220;20,20,240;20,40,220;20,40,240;40,20,220;40,20,240;40,40,220;40,40,240;220,20,20;220,20,40;220,20,220;220,20,240;220,40,20;220,40,40;220,40,220;220,40,240;240,20,20;240,20,40;240,20,220;240,20,240;240,40,20;240,40,40;240,40,220;240,40,240");			
		}else{ 
			$xColArr = explode(";","20,220,20;20,220,40;20,240,20;20,240,40;40,220,20;40,220,40;40,240,20;40,240,40;240,240,220;240,240,240;240,250,220;240,240,250;240,220,230;250,250,240;240,240,250;250,250,250;220,20,20;220,20,40;220,20,220;220,20,240;220,40,20;220,40,40;220,40,220;220,40,240;240,20,20;240,20,40;240,20,220;240,20,240;240,40,20;240,40,40;240,40,220;240,40,240");
		}
		$xColStr = explode(",",$xColArr[mt_rand(0,31)]);
		$xCol01 = $xColStr[0]+mt_rand(-12,12);
		$xCol02 = $xColStr[1]+mt_rand(-12,12);
		$xCol03 = $xColStr[2]+mt_rand(-12,12);
		$xColor = imagecolorallocate($this->im, $xCol01, $xCol02, $xCol03);
		return $xColor;
	}
	// 干扰线
	function rnd_lines(){ 
		$w = $this->imw-2;
		$h = $this->imh-2;
		$cnt = mt_rand(2,3);
		for($j=2;$j<$cnt;$j++){
			imageline($this->im
				, rand(2,$w),rand(2,$h),rand(2,$w),rand(2,$h)
				, $this->rnd_color($this->im)
			); //18
		}
	}
	// 干扰象素
	function rnd_pixels(){ //加入干扰象素
		for($i=0;$i<200;$i++){  
		   imagesetpixel($this->im, rand()%160 , rand()%100 , $this->rnd_color($this->im));	
		}
	}
	// 干扰字符
	function rnd_chars(){ 
		if(empty($this->ttf)){ return; }
		$im = $this->im;
		$imw = $this->imw;
		$imh = $this->imh;
		$cnt = mt_rand(2,3); //《!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~》// All:32 '+','-',
		$chars = array('!',"'",'(',')',',','.','/',":",";","?","^","_","`","~");
		for($i=1; $i<=$cnt; $i++){
			imagestring($im,mt_rand(1,5),mt_rand(1,$imw),mt_rand(1,$imh),$chars[mt_rand(0,4)],$this->rnd_color($im));
		}
	}
	
	// *** 随机码
	static function strRand(){
		$vimg = cfg('ucfg.vimg');
		$type = in_array($vimg,array('0','H','K')) ? $vimg : 'K';
		$str = basKeyid::kidRand($type,rand(3,5));
		return $str;
	}
	
}




/*******************************************************************************
 File : \code\core\clib\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\dops\dopAdvs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// dopAdvs(data OP for Advs)
class dopAdvs extends dopBase{	

	public $kfix = 'yyyy-md-';
	public $ktmp = '31';
	//public $tbuacc = '';
	public $_kid = 'aid';
	public $_kno = 'ano';	

	//function __destory(){  }
	function __construct($cfg){ 
		$mod = $cfg['kid'];
		parent::__construct($cfg,$cfg['pid']."_$mod");
		$this->typfid = $this->so->typfid = 'catid';
		$this->dskey  = $this->so->dskey  = 'title'; 
		$this->order  = $this->so->order  = basReq::val('order','atime');
		//$this->tbuacc  = 'users_uacc';
	}
	// 翻页条,批量操作
	function pgbar($idfirst,$idend){
		$pg = $this->pg->show($idfirst,$idend);
		$op = "".basElm::setOption("show|".lang('flow.op_show')."\ndel|".lang('flow.op_del')."\nhidden|".lang('flow.op_hide')."",'',lang('flow.op0_bacth'));
		dopFunc::pageBar($pg,$op);
	}
	// 搜索条 // check,fields
	function sobar($msg='',$width=30){ 
		$file = basReq::val('file');
		$mod = $this->mod;
		$sbar = "\n".$this->so->Type(120,lang('flow.op0_cat')); 
		$sbar .= "\n&nbsp; ".$this->so->Word(80,80,lang('flow.op0_filt'));
		$sbar .= "\n&nbsp; ".$this->so->Show(60);
		$sbar .= "\n&nbsp; ".$this->so->Order(array('aid' => lang('flow.dops_orduidd'),'aid-a' => lang('flow.dops_orduida'),));
		$updlink = ($this->cfg['etab']==4) ? lang('flow.op_upd') : "<a href='?file=$file&mod=$mod&view=list&umod=upd'>".lang('flow.op_upd')."</a>";
		$this->so->Form("[$updlink] | ".$sbar,$msg,$width);
	}
	
	// avLink // 
	function avLink($r){ 
		if($this->cfg['etab']==3){
			return '#';
		}elseif(!empty($r['pmod']) && !empty($r['pid']) && empty($r['url'])){
			return "/plus/ajax/redir.php?$r[pmod].$r[pid]";
		}else{
			return empty($r['url']) ? '#' : $r['url'];
		}
	}

	// PKey pMod,pKey资料
	function fmPKey(){ 
		$_groups = glbConfig::read('groups');
		$mod = $this->mod;
		$val = @$this->fmo['pid']; $val || $val = basReq::val('pid');
		$pmod = @$this->fmo['pmod'];
		$arr = admPFunc::modList(array('docs','users'),$pmod); //'coms',
		$sels = "<select id='fm[pmod]' name='fm[pmod]'>".basElm::setOption($arr,$pmod)."</select>";
		$item = "<input name='fm[pid]' type='text' id='fm[pid]' value='$val'> &nbsp; ";
		//$item .= "<input type='text' id='fm[refname]' value='' class='txt w240'>";
		$item .= "$sels<input type='button' value='".lang('flow.dops_fromdata')."' onclick=\"pickOpen('fm[pmod]','','fm[pid]','fm[title]',1)\" class='btn'>";
		glbHtml::fmae_row(lang('flow.dops_fromdata'),$item);
		glbHtml::fmae_row(lang('flow.dops_icat'),$this->fmType('catid').' &nbsp; '.lang('flow.dops_ishow').$this->fmShow());
		//echo "<tr><th>".lang('flow.dops_detail')."</th><th class='tr'>---</th></tr>\n";
	}

	// 属性设置
	function fmProp(){ 
		dopFunc::fmSafe();
		$mod = $this->mod;
		echo "<tr><th nowrap>".lang('flow.title_attrset')."</th><th class='tr'>---</th></tr>\n";
		$this->fmAE3();
	}
	// PKey pMod,pKey资料
	function svPKey($type='add'){ 
		$pid = preg_replace('/[^0-9A-Za-z\.\-]/','',@$this->fme['pid']);
		$pid && $this->fmv['pid'] = $pid;
		$this->fmv['pmod'] = @$this->fme['pmod'];
	}
	// svEKey，
	function svEKey(){
		$aid = basReq::val('aid');
		$this->svMoveFiles($aid);
		return preg_replace('/[^0-9A-Za-z\.\-]/','',$aid);
	}
	
}



/*******************************************************************************
 File : \code\core\dops\dopBase.php 
*******************************************************************************/
<?php
// dops : All Data & View OP Systems
// dopBase : 基本数据操作(Basic Data Operate) --- 列表,搜索,设置,编辑...
// for : docs,coms,user,advs,
class dopBase{	

	public $cfg = array();
	public $mod = '';
	public $file = '';
	public $aurl = array();
	public $btid = '';
	
	public $typfid = 'catalog';
	public $order = '';
	public $dskey = '';

	public $fmo = array(); // 原始数据(database),供表单设置初始值
	public $fmv = array(); // fields中：表单数据(基本表)
	public $fmu = array(); // fields中：表单数据(扩展表)
	public $fme = array(); // fields外数据：(ip,time,user,catid,grade...)
	
	public $pg = NULL;
	public $so = NULL;
	public $cv = NULL;
	
	// 栏目,等级; 搜索字段; 搜索like模式; 关键字; 范围字段:N,D; 最小范围; 最大范围；	
	public $skey = array('stype'=>'','sfid'=>'','sfop'=>'','sfkw'=>'','sfrng'=>'','srva'=>'','srvb'=>'');
	public $sopc = array('ll'=>'like%','lb'=>'%like%','lr'=>'%like','eq'=>'=','in'=>'IN');
	
	public $fext = array();
	public $db = NULL;

	//function __destory(){  }
	function __construct($cfg,$tabid=''){ 
		$this->db = glbDBObj::dbObj(); 
		$this->so = new dopBSo($cfg,$tabid);
		$this->cv = new dopBCv($cfg,$tabid);
		$this->so->skey = $this->cv->skey = $this->skey;
		$this->so->sopc = $this->cv->sopc = $this->sopc;
		$this->so->fext = $this->cv->fext = $this->fext = array(
			'aip' => array('title'=>lang('flow.log_aip'),'dbtype'=>'varchar',),
			'eip' => array('title'=>lang('flow.log_eip'),'dbtype'=>'varchar',),
			'atime' => array('title'=>lang('flow.log_atime'),'dbtype'=>'int',),
			'etime' => array('title'=>lang('flow.log_etime'),'dbtype'=>'int',),
		);
		$this->cfg = $cfg;
		$this->mod = empty($cfg['kid']) ? 0 : $cfg['kid'];
		$this->tbid = $tabid;
		$this->type = $cfg['pid']; 
		unset($GLOBALS['cfg']);
	}
	
	// 左上信息条
	function msgBar($msg='',$lnkadd=''){
		$mod = $this->mod;
		$file = basReq::val('file');
		$stype = basReq::val('stype');  
		$gname = $this->cfg['title'];
		empty($lnkadd) && $lnkadd = $this->cv->Url(lang('flow.dops_add2').'&gt;&gt;',0,"?file=$file&mod=$mod&view=form&stype=$stype&recbk=ref","");
		$lnkadd = str_replace("<a ","<a id='{$mod}_add' ",$lnkadd);
		if($msg && !strpos($msg,'<')) $msg = "<span class='cF00'>$msg</span>";
		$msg && $msg = $msg."<br>";
		$msg = "{$msg}[$gname]".lang('flow.dops_adm2')."<span class='span ph5'>|</span>$lnkadd";
		return $msg;
	}
		
	// 列表-记录集
	function getRecs($key='',$psize=0){
		$psize || $psize = cfg('show.apsize');
		$key = $key ? $key : $this->_kid; 
		$sfrom = "* FROM `".$this->db->pre.$this->tbid.$this->db->ext."` ";  
		$where = empty($this->so->whrstr) ? '' : (substr($this->so->whrstr,5)); //echo $where;
		$opkey = $this->order===$key ? 1 : 0;
		if(strpos($this->order,'-a')){
			$order = str_replace('-a','',$this->order);
			$odesc = 0;
		}else{
			$order = $this->order;
			$odesc = 1;
		} //echo "$sfrom,$where,($opkey),$odesc";
		$pg = new comPager($sfrom,$where,$psize,$order); 
		$pg->set('odesc',$odesc); // odesc/opkey
		$pg->set('opkey',$opkey);
		$rs = $pg->exe();
		$this->pg = $pg;
		return $rs;
	}
	
	// SetID，advs,docs,coms:共用此属性。
	function fmSetID(){ 
		$tabid = $this->cfg['pid']=='users' ? $this->tbuacc : $this->tbid;
		$_key = $this->cfg['pid']=='users' ? 'uid' : $this->_kid;
		$val = @$this->fmo[$_key];  
		if(empty($val)){ //echo $this->kfix.$this->ktmp;
			$kar = glbDBExt::dbAutID($tabid,$this->kfix,$this->ktmp);
			$kid = $kar[0]; $kno = $kar[1];
			$dis = "class='txt w180'";
		}else{
			$kid = $this->fmo[$_key]; 
			$kno = $this->fmo[$this->_kno];
			$dis = "class='txt w160 disc' readonly";	
		} 
		$item = "<input id='fm[$_key]' name='fm[$_key]' type='text' value='$kid' maxlength=24 $dis tip='".lang('flow.tip_slogs')."' />";
		$item .= "\n<input name='fm[$this->_kno]' type='hidden' value='$kno' />";
		return $item;
	}	
	// 表单-类别
	function fmType($key='catid',$w=150){ 
		$dval = empty($this->fmo[$key]) ? basReq::val('stype') : $this->fmo[$key];
		$str = "\n<select name='fm[$key]' id='fm[$key]' class='w$w' reg='tit:2-12'>"; 
		$str .= comTypes::getOpt($this->cfg['i'],$dval); 
		$str .= "</select>";
		return $str;
	}
	// def：0/1; 当前资料优先, 再次是模型设置优先, 最后用$def默认值
	function fmShow($def=1){
		$val = dopFunc::fmDefval($this,'show',$def);
		$item = basElm::setOption("1=".lang('flow.op_show')."\n0=".lang('flow.op_hide')."",$val,lang('flow.op0_show')); 
		$item = "\n<select name='fm[show]' class='w80' reg='n+i:' tip='".lang('flow.tip_ssel')."'>$item</select>";
		return $item;
	}
	function fmAELogs($type,$key){
		$run = cfg('run');
		$user = usrBase::userObj();
		if($type=='date'){
			$val = empty($this->fmo[$key]) ? $run['stamp'] : $this->fmo[$key];
			$val = date('Y-m-d H:i:s',$val); 
			echo basJscss::imp('/My97DatePicker/WdatePicker.js','vui'); 
			$iinp = "<input id='fm[$key]' name='fm[$key]' type='text' value='$val' class='txt w140' />";
			$item = "$iinp<span class='fldicon fdate' onClick=\"WdatePicker({el:'fm[$key]',dateFmt:'yyyy-MM-dd HH:mm:ss'})\" /></span>";
		}elseif($type=='user'){
			$val = empty($this->fmo[$key]) ? @$user->uinfo['uname'] : $this->fmo[$key];
			$item = "<input id='fm[$key]' name='fm[$key]' type='text' value='$val' maxlength=24 tip='".lang('flow.tip_suser')."' />";
		}elseif($type=='uip'){
			$val = empty($this->fmo[$key]) ? $run['userip'] : $this->fmo[$key];
			$item = "<input id='fm[$key]' name='fm[$key]' type='text' value='$val' maxlength=255 tip='".lang('flow.tip_sip')."' />";
		}
		return $item;
	}
	function fmAE3($hid=0){
		glbHtml::fmae_row(lang('flow.log_optime'),lang('flow.log_opadd').$this->fmAELogs('date','atime').' &nbsp; '.lang('flow.log_opedit').$this->fmAELogs('date','etime'),$hid);
		glbHtml::fmae_row(lang('flow.log_opuser'),  lang('flow.log_opadd').$this->fmAELogs('user','auser').' &nbsp; '.lang('flow.log_opedit').$this->fmAELogs('user','euser'),$hid);
		glbHtml::fmae_row(lang('flow.log_opip'),  lang('flow.log_opadd').$this->fmAELogs('uip','aip')   .' &nbsp; '.lang('flow.log_opedit').$this->fmAELogs('uip','eip'),   $hid);
	}

	// svAKey，
	function svAKey(){
		$tabid = $this->cfg['pid']=='users' ? $this->tbuacc : $this->tbid;
		$_key = $this->cfg['pid']=='users' ? 'uid' : $this->_kid;
		if(!empty($this->fme[$_key]) && !empty($this->fme[$this->_kno])){	
			$val = preg_replace('/[^0-9A-Za-z\.\-]/','',$this->fme[$_key]);
			if(!$this->db->table($tabid)->where($_key."='$val'")->find()){
				$kid = $val; 
				$kno = preg_replace('/[^0-9A-Za-z\.\-]/','',$this->fme[$this->_kno]);
			}
		}
		if(empty($kid) || empty($kno)){
			$kar = glbDBExt::dbAutID($tabid,$this->kfix,$this->ktmp);
			$kid = $kar[0]; $kno = $kar[1];	
		}
		$this->fmv[$_key] = $kid;	
		$this->fmv[$this->_kno] = $kno;
		$this->svMoveFiles($kid);
		extJifen::main(array_merge($this->cfg,$this->fme),'add','');
		return $this->fmv[$_key];
	}
	function svTypes(){
		$field = $this->cfg['pid']=='users' ? 'grade' : 'catid'; 
		if(isset($this->fme[$field])){
			$type = $this->fmv[$field] = preg_replace('/[^0-9A-Za-z\.\-]/','',$this->fme[$field]);
			$ccfg = glbConfig::read($this->mod,'_c'); //类别扩展属性 
			if(empty($ccfg[$type])) return;
			$cfield = $ccfg[$type];
			foreach($cfield as $k=>$v){
				if(isset($this->fme[$k])){ 
					$this->fmv[$k] = $this->fme[$k];
				}
			}
		}
	}
	// Fields。
	function svFields(){
		if(empty($_POST['fm'])) glbHtml::end('svFields@'.__CLASS__);
		$f = $this->cfg['f'];
		if(in_array($this->cfg['pid'],array('users','docs'))){
			$fc = glbConfig::read($this->mod,'_c'); 
			$fk = $this->cfg['pid']=='users' ? 'grade' : 'catid';
			$fv = @$_POST['fm'][$fk];
			if(isset($fc[$fv])){
				$f = $f+$fc[$fv]; 
			}
		}
		foreach($_POST['fm'] as $k=>$v){
		if(isset($f[$k])){ //$val = $v;
			if($f[$k]['dbtype']=='nodb') continue;
			$val = dopFunc::svFmtval($f,$this->mod,$k,$v);
			if(empty($f[$k]['etab'])) $this->fmv[$k] = $val;		
			else					  $this->fmu[$k] = $val;
		}else{
			$this->fme[$k] = $v;
		} }
		return;
	}
	function svMoveFiles($kid=''){
		$fall = $this->cfg['f'];
		foreach($fall as $f=>$cfg){ 
			$ext = @$cfg['fmextra'];
			$arr = array('fmv','fmu');
			foreach($arr as $k){
				if(($ext=='editor' || $ext=='pics' || $cfg['type']=='file')){
					$tmp = &$this->$k; 
					if(!empty($tmp[$f])){ 
						$tmp[$f] = comFiles::moveTmpDir($tmp[$f], $this->mod, $kid, $ext=='editor'?1:0); 
						break;
					}
				}
			}
		} 
	}
	// FALogs。
	function svAELogs(){
		$a = array('atime','etime','auser','euser','aip','eip');
		foreach($a as $k){
		if(isset($this->fme[$k])){ 
			$val = $this->fme[$k];	
			$val = preg_replace('/[^0-9A-Za-z,\.\-\ \:]/','',$val);
			if(in_array($k,array('atime','etime'))) $val = empty($val) ? $_cbase['run']['stamp'] : strtotime($val); 
			$this->fmv[$k] = $val;	
		} }
	}
	// svPrep 预处理
	function svPrep(){
		dopFunc::svSafe();
		$this->svFields();
		$this->svTypes();
		$this->svAELogs();
		if(isset($this->fme['show'])){ 
			$this->fmv['show'] = intval($this->fme['show']);
		}
	}
	// svEnd。
	function svEnd($id,$show=1){
		$this->svMoveFiles($id);
		if(in_array($this->cfg['pid'],array('docs','users'))){ //,'types'
			//是否判定cheched?
			$urls = vopStatic::updKid($this->mod,$id,'upd');
			$js = '';
			foreach($urls as $tpl=>$mkv){
				$js .= basJscss::jscode(0,PATH_ROOT."/plus/ajax/cron.php?static=updkid&tpldir=$tpl&mkv=$mkv");
			}
		}
		if($show) echo $js;
		return $js;
	}
	// opShow。
	function opShow($id,$op){
		$v = $op=='show' ? '1' : '0';
		$this->db->table($this->tbid)->data(array('show'=>$v))->where("$this->_kid='$id'")->update();
		return 1;
	}
	// opDelete。
	function opDelete($id){
		$this->opDelPubpre($id); //删之前执行
		$this->db->table($this->tbid)->where("$this->_kid='$id'")->delete(); 
		$this->opDelPublic($id); //删之后执行
		return 1;
	}
	// opDelPubpre。
	function opDelPubpre($id){ 
		if(!in_array($this->cfg['pid'],array('docs','users','coms'))) return;
		$fme = $this->db->field('aip,auser,atime')->table($this->tbid)->where("$this->_kid='$id'")->find();
		if(!empty($fme)) extJifen::main(array_merge($this->cfg,$fme),'del'); 
	}
	// opDelPublic。
	function opDelPublic($id){
		if(in_array($this->cfg['pid'],array('docs','users'))){ //,'types'
			vopStatic::clrFile($this->mod,$id);
			//if($this->cfg['pid']=='types') return;
			$res = vopStatic::updKid($this->mod,$id,'del');
			foreach($res as $file){
				@unlink($file);
			}
		}
	}

}



/*******************************************************************************
 File : \code\core\dops\dopBCv.php 
*******************************************************************************/
<?php

// dopBCv : 基本数据操作(data OP(base) for CellView) --- 单元格显示...
// for : dopBCv,
class dopBCv{	

	public $cfg = array();
	public $mod = '';
	public $typfid = 'catalog';
	public $order = '';
	public $dskey = '';
	public $urlstr = '';
	public $whrstr = '';

	//function __destory(){  }
	function __construct($cfg,$tabid){ 
		$this->cfg = $cfg;
		$this->mod = empty($cfg['kid']) ? 0 : $cfg['kid'];
		$this->tbid = $tabid;
		$this->type = $cfg['pid']; 
	}
	
	function PTitle($mod,$val,$url='',$len=32,$filed=''){ //,$kid='',$link=''
		$len = is_numeric($len) ? $len : 32;
		if($mod=='users'){
			$uinfo = usrBase::uget_minfo($val);	
			$re = @$uinfo['uname'];
			if(isset($uinfo['company'])) $re = $uinfo['company'];
		}else{
			$re = dopFunc::vgetTitle($mod,$val,$filed);
		}
		$re = basStr::filTitle($re);
		$re = empty($re) ? "<span class='cCCC'>---</span>" : $re;
		$re = basStr::cutWidth($re, $len);
		$re = dopFunc::vgetLink($re,$mod,'',$url); 
		echo "<td>".$re."</td>\n"; // class='tc'
	}
	// 显示项-Select
	function Select($val,$td=1){
		$val = "<input name='fs[$val]' type='checkbox' class='rdcb' value='1' />";
		if(empty($td)) return $val;
		return "<td class='tc'>$val</td>\n";
	}
	// 显示项-Title
	function Title($r,$td=1,$key='title',$url='',$len=32){ 
		$val = $r[$key]; 
		$val = basStr::cutWidth($val,$len);
		if(!empty($r['color'])) $val = "<span style='color:#{$r['color']}'>$val</span>"; 
		$_key = substr($this->type,0,1).'id'; 
		$val = dopFunc::vgetLink($val,$this->mod,$r[$_key],$url); 
		if(!empty($r['mpic'])){ 
			$ticon = comFiles::getTIcon($r['mpic']);
			$val = "<span class='c33F'>".($ticon['icon']=='pic' ? lang('core.bcv_pic') : lang('core.bcv_file'))."</span>$val"; 
		}
		if(empty($td)) return $val;
		return "<td class='tl'>$val</td>\n";
	}
	// 显示项-TKeys, winpop,select,cbox,
	function TKeys($r,$td=1,$key,$len=12,$null='',$color=1){
		$val = $r[$key]; $vbak = $val; $vre = array();
		$fc = @$this->cfg['f'][$key]; 
		$vre = vopCell::optArray($fc,$val,$color);
		if(empty($vre)){
			$val = empty($vbak) ? $null : $vbak;
		}else{
			$val = implode(',',$vre);
		}
		if(empty($td)) return $val;
		return "<td class='tc'>$val</td>\n"; 	
	}
	// 显示项-Types
	function Types($val,$td=1){
		$val = @$this->cfg['i'][$val]['title'];
		if(empty($td)) return $val;
		return "<td class='tc'>$val</td>\n"; 
	}
	// 显示项-Show
	function Show($val,$td=1){
		$val = glbHtml::null_cell($val);
		if(empty($td)) return $val;
		return "<td class='tc'>$val</td>\n";
	}
	// 显示项-Time
	function Time($val,$td=1,$fmt='',$end=0){
		if(empty($fmt)) $fmt='Y-m-d H:i';
		if($fmt=='y') $fmt='y-m-d H:i';
		if($fmt=='D') $fmt='Y-m-d';
		if($fmt=='d') $fmt='y-m-d';
		$val = empty($val) ? "<span class='cCCC'>---</span>" : date($fmt,$val);
		if(!empty($end)){
			$vc = date('Y-m-d',cfg('run.stamp'));
			$vd = substr($val,0,10); 
			if($vc===$vd){
				$val = "<span class='c00F'>$val</span>";
			}elseif($vc>$vd){
				$val = "<span class='cF00'>$val</span>";
			}
		}
		if(empty($td)) return $val;
		return "<td class='tc'>$val</td>\n"; 
	}
	// 显示项-Field
	function Field($val,$td=1,$len=6,$url=''){ 
		$val = basStr::cutWidth($val,$len,'..');
		$val = basStr::filTitle($val);
		$val = empty($val) ? "<span class='cCCC'>---</span>" : $val;
		if(!empty($url)) $val = "<a href='$url' target='_blank'>$val</a>";
		if(empty($td)) return $val;  
		return "<td class='tc'>$val</td>\n";
	}
	// 显示项-Url
	function Url($title,$td=1,$url,$twin='',$w=780,$h=560){ 
		if($twin=='frame'){ 
			$url .= "&frame=1";
			$twin = " target='_blank'";
		}elseif($twin=='blank'){
			$twin = " target='_blank'";
		}elseif(!empty($twin)){
			$twin = " onclick='return winOpen(this,\"$twin\",$w,$h);'";
		}else{
			$twin = '';
		}
		$val = "<a href='$url'$twin>$title</a>";
		if(empty($td)) return $val; 
		return "<td class='tc'>$val</td>\n";
	}
	
	// 显示项-set_opts
	function set_opts($key){ 
		//set_new|新建\nset_doing|处理中\nset_paid|已付款\nset_send|已发货\nset_return|退货\n
	
		//$val = $r[$key]; $vbak = $val; $vre = array();
		$fc = @$this->cfg['f'][$key];
		$ftype = @$fc['type']; $cfgs = @$fc['cfgs'];
		$extra = @$fc['fmextra']; $exstr = @$fc['fmexstr'];
			if($extra=='winpop' && isset($_groups[$exstr])){ 
				$arr = basElm::text2arr($exstr);
			}elseif(in_array($ftype,array('select','cbox'))){
				$arr = basElm::text2arr($cfgs);
			}
			//$va = explode(',',$val); 
			$re = "";
			foreach($arr as $k=>$v){
				$re .= "\nset_$k|".lang('core.bcv_set')."($k)$v";
			}

		return $re; 
	
	}

}




/*******************************************************************************
 File : \code\core\dops\dopBSo.php 
*******************************************************************************/
<?php

// dopBSo : 基本数据操作(data OP(base) for Search) --- 搜索...
// for : dopSo,
class dopBSo{	

	public $cfg = array();
	public $mod = '';
	public $typfid = 'catalog';
	public $order = '';
	public $dskey = ''; //默认搜索字段
	public $urlstr = '';
	public $whrstr = '';

	//function __destory(){  }
	function __construct($cfg,$tabid){ 
		$this->cfg = $cfg; 
		$this->mod = empty($cfg['kid']) ? 0 : $cfg['kid'];
		$this->tbid = $tabid;
		$this->type = $cfg['pid']; 
	}
	// 搜索项-类别
	function Type($w,$msg='(null)'){ 
		$stype = basReq::val('stype','','Key');
		if($stype){
			$this->urlstr .= "&stype=$stype";
			if(in_array($this->type,array('docs','advs'))){ 
				$this->whrstr .= basSql::whrTree($this->cfg['i'],$this->typfid,$stype);
			}elseif(in_array($this->type,array('users','xxxxx'))){
				$this->whrstr .= " AND $this->typfid='$stype'";
			}elseif(in_array($this->type,array('coms','xxxxx'))){
				$this->whrstr .= " AND $this->typfid='$stype'";
			}
		}
		if(in_array($this->type,array('coms','xxxxx'))){
			$str = "\n<input name='stype' type='text' class='w90' value='$stype'>";
		}else{
			$str = "\n<select name='stype' class='w$w'>"; 
			if($msg=='(null)') $msg=lang('flow.op0_type');
			$str .= comTypes::getOpt($this->cfg['i'],$stype,$msg,0); 
			$str .= "</select>";
		} 
		return $str;
	}
	// 搜索项-Keyword
	function Word($w1=80,$w2=90,$msg='(null)',$soarr=array()){ 
		if($msg=='(null)') $msg = lang('flow.op0_filt');
		$sfid = basReq::val('sfid',$this->dskey,'Key');
		$sfop = basReq::val('sfop','lb','Key');
		$sfkw = basReq::val('sfkw');
		if($sfkw && isset($this->cfg['f'][$sfid])){ 
			$this->urlstr .= "&sfid=$sfid&sfkw=$sfkw&sfop=$sfop";
			$fcfg = $this->cfg['f'][$sfid];
			// fmextra=winpop
			if(!empty($fcfg['type']) && in_array($fcfg['type'],array('select','cbox','radio'))){
				$this->whrstr .= basSql::whrScbr($this->cfg['f'],$sfid,$sfkw); //" AND `$sfid` LIKE '$sfkw%'";
			}else{
				if($sfop=='ll') $this->whrstr .= " AND `$sfid` LIKE '$sfkw%'";
				if($sfop=='lb') $this->whrstr .= " AND `$sfid` LIKE '%$sfkw%'";	
				if($sfop=='lr') $this->whrstr .= " AND `$sfid` LIKE '%$sfkw'";
				if($sfop=='eq') $this->whrstr .= " AND `$sfid`='$sfkw'";
			}
		} 
		$str  = "\n<select name='sfid' class='w$w1'>"; 
		$str .= $this->Options('char',$sfid,$soarr); 
		$str .= "</select>";
		$str .= "<select name='sfop' class='w$w2'>";
		$str .= basElm::setOption($this->sopc,$sfop,$msg);  
		$str .= "</select>";
		$str .= "<input name='sfkw' type='text' class='w90' value='$sfkw'>";
		return $str;
	}
	// 搜索项-范围
	function Area($w=90,$w2=90,$rfield=''){ 
		$sfrng = $rfield ? $rfield : basReq::val('sfrng','','Key');
		$srva = basReq::val('srva');
		$srvb = basReq::val('srvb');  
		if((!empty($srva) || !empty($srvb)) && (isset($this->cfg['f'][$sfrng]) || isset($this->fext[$sfrng]))){
			$this->urlstr .= "&sfrng=$sfrng&srva=$srva&srvb=$srvb";
			empty($srva) || $this->whrstr .= basSql::whrDate($sfrng,$srva,'>',$this->cfg);
			empty($srvb) || $this->whrstr .= basSql::whrDate($sfrng,$srvb,'<',$this->cfg);
		}
		if(empty($rfield)){
			$str = "\n<select name='sfrng' class='w$w'>";
			$str .= $this->Options('num',$sfrng); 
			$str .= "</select>";
		}else{
			$str = "\n<input name='sfrng' type='hidden' value='$rfield'>";
		}	
		$str .= "<input name='srva' type='text' class='w$w2' value='$srva'>~";
		$str .= "<input name='srvb' type='text' class='w$w2' value='$srvb'>";
		return $str;
	}
	// 搜索项-字段(select,winpop)
	function Field($key,$w=90){ 
		$_groups = glbConfig::read('groups');
		$val = basReq::val($key,'','Key');
		$fc = @$this->cfg['f'][$key];
		$ftype = @$fc['type']; $cfgs = @$fc['cfgs'];
		$extra = @$fc['fmextra']; $exstr = @$fc['fmexstr'];
		$opt = $str = '';	
		if($extra=='winpop' && isset($_groups[$exstr])){
			$opt = comTypes::getOpt($exstr,@$val,'-'.$fc['title'].'-','',0);	
		}elseif($ftype=='select' && isset($_groups[$cfgs])){
			$opt = comTypes::getOpt($cfgs,@$val,'-'.$fc['title'].'-','',0);	
		}elseif($ftype=='select' && $cfgs){
			$opt = basElm::setOption($cfgs,@$val,'-'.$fc['title'].'-','',0); 
		}elseif($ftype=='cbox' && $cfgs){
			$opt = basElm::setOption($cfgs,@$val,'-'.$fc['title'].'-','',0); 
		} 
		if($opt){
			$str = "\n<select name='$key' class='w$w'>$opt</select>";
		}
		if($val && isset($this->cfg['f'][$key])){
			$this->urlstr .= "&$key=$val";
			if($extra=='winpop' && isset($_groups[$exstr])){ //可能多选...
				$size = explode('x',$fc['fmsize'].'x');
				$_n = empty($size[1]) ? 1 : intval($size[1]);
				if($_n>1){
					$this->whrstr .= " AND $key LIKE '%$val%'";
				}else{
					$imod = glbConfig::read($exstr); 
					$this->whrstr .= basSql::whrTree($imod['i'],$key,$val);
				}
			}elseif($ftype=='select' && isset($_groups[$cfgs])){
				$imod = glbConfig::read($cfgs); 
				$this->whrstr .= basSql::whrTree($imod['i'],$key,$val);	
			}elseif($ftype=='select' && $cfgs){
				$this->whrstr .= " AND $key='$val'";	
			}elseif($ftype=='cbox' && $cfgs){
				$this->whrstr .= " AND $key LIKE '%$val%'";
			}  
		} 
		return $str;
	}
	// 搜索项-Show()
	function Show($w=70){ 
		$item = basElm::setOption("s1=".lang('flow.op_show')."\ns0=".lang('flow.op_hide')."",@$val,lang('flow.op0_show')); 
		$str = "\n<select name='show' class='w$w'>$item</select>";
		return $str;
	}
	// 搜索项-排序
	function Order($ord_now,$w=80,$msg='(null)',$opubs='-1'){ 
		if($msg=='(null)') $msg = lang('flow.op0_order');
		$ord_pub = $opubs==='-1' ? array('atime' => lang('flow.log_atime'),'etime' => lang('flow.log_etime')) : $opubs;
		$str = "\n<select name='order' class='w$w'>"; 
		$ords = array_merge($ord_pub,$ord_now);
		$str .= basElm::setOption($ords,$this->order,$msg); 
		$str .= "</select>";
		return $str;
	}
	// 搜索项-form
	function Form($bar,$msg,$w,$khid=array()){
		$run = cfg('run');
		$mod = $this->mod;
		$bar .= "\n&nbsp; <input name='sch_$mod' class='btn' type='submit' value='".lang('flow.dops_search')."'>";
		echo "\n<form id='fmid' name='fmid' method='GET' action='?".$this->urlstr."'>";
		empty($run['sobarnav']) || $bar = $run['sobarnav']."$bar";
		glbHtml::tab_bar($msg,$bar,$w,'tl');
		echo "\n<input name='file' type='hidden' value='".basReq::val('file')."' />";
		echo "\n<input name='mod' type='hidden' value='$mod' />";
		echo "\n<input name='view' type='hidden' value='".basReq::val('view')."' />";
		echo "\n<input name='pid' type='hidden' value='".basReq::val('pid')."' />";
		echo "\n<input name='part' type='hidden' value='".basReq::val('part')."' />";
		echo "\n<input name='act' type='hidden' value='".basReq::val('act')."' />";
		foreach($khid as $k=>$v){
			echo "\n<input name='$k' type='hidden' value='$v' />";
		}
		echo "\n</form>";
		//return $str;
	}

	// getOptions(Select)
	function Options($types='',$def='',$soarr=array()){ 
		if($types=='char'){
			$msg = lang('flow.op0_type');
			$ft = 'varchar';
		}elseif($types=='num'){
			$msg = lang('flow.op0_area');
			$ft = 'tinyint,int,float';
		}else{
			$msg = lang('flow.op0_search');
			$ft = '';	
		}
		if(!empty($soarr)){
			$arr = array();
			$soarr;
			foreach($soarr as $k=>$v){
				if(is_numeric($k))	{
					$arr[$v] = $v;
				}else{
					$arr[$k] = $v;	
				}
			} 
		}else{
			$arr = basArray::opaFields($this->cfg['f']+$this->fext,$ft);
		}
		return basElm::setOption($arr,$def,$msg);
	}

}



/*******************************************************************************
 File : \code\core\dops\dopCheck.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// dopCheck(data OP for Extra)
class dopCheck extends dopBase{	

	public $excfg = array();
	public $user = NULL;
	public $uname = '';
	public $ugrade = '';

	static function addInit($cfg=array(),$percheck=array()){ 
		$chk = new self($cfg);
		if(empty($chk->excfg)) return;
		foreach ($chk->excfg as $key => $val) {
			if(empty($val)) continue;
			$method = 'chk'.ucfirst(strtolower($key));
			if(substr($key,0,3)=='ap_'){
				$ngrade = substr($key,2);
				if($chk->ugrade==$ngrade){
					$chk->chkAllpub($val);
					unset($chk->excfg['allpub']);
				}
			}elseif(method_exists($chk,$method)){
				$chk->$method($val);
			}
		}
		#dump($chk->excfg);
	}

	function __construct($cfg=array()){ 
		parent::__construct($cfg);
		$this->excfg = basElm::text2arr($this->cfg['cfgs']);
		$this->user = usrBase::userObj('Member'); 
		$this->uname = empty($user->uinfo['uname']) ? '(null)' : $user->uinfo['uname'];
		$this->ugrade = empty($user->uperm['grade']) ? '(null)' : $user->uperm['grade'];
		$this->tabid = glbDBExt::getTable($this->cfg['kid']); 
	}

	// showdef=1

	// login=1(登录发布)
	// login=cvip,ccom(会员cvip,ccom等级:登录发布)
	function chkLogin($ngrades=0){ 
		$clogin = 1; 
		if(!is_numeric($ngrades)){
			if(strpos("(,$ngrades,)",",{$this->ugrade},")<=0){
				glbHtml::end(lang('flow.ck_grade',$ngrades));
			}
		}else{ 
			// stop
			if(strpos($this->ugrade,'stop')>0){
				glbHtml::end(lang('flow.ck_stop',$this->ugrade));
			}
			if($this->user->userFlag!='Login'){
				glbHtml::end(lang('flow.ck_login'));
			}
		}
	}
	
	// ap_ccom=500(会员ccom等级:发布总量) -> (500,'ccom')
	// allpub=100(会员发布总量)
	// skip_allpub=cvip,ovip(cvip,ovip不检测)
	function chkAllpub($num=0){ 
		if(!empty($this->excfg['skip_allpub'])){
			if(strpos("(,{$this->excfg['skip_allpub']},)",",{$this->ugrade},")>0){
				return;
			}
		}
		$cnt = $this->db->table($this->tabid)->where("auser='{$this->uname}'")->count();
		if($cnt>=$num){
			glbHtml::end(lang('flow.ck_all',$num));
		}
	}

	// ippub=5(ip日发布量)
	// skip_ippub=cvip,ovip(cvip,ovip不检测)
	function chkIppub($num=0){ 
		if(!empty($this->excfg['skip_ippub'])){
			if(strpos("(,{$this->excfg['skip_ippub']},)",",{$this->ugrade},")>0){
				return;
			}
		}
		$cnt = $this->db->table($this->tabid)->where("aip='".basEnv::userIP()."' AND atime>='".(time()-86400)."'")->count();
		if($cnt>=$num){
			glbHtml::end(lang('flow.ck_day',$num));
		}
	}

	// iprep=3(ip重复发布时间间隔)
	// skip_iprep=cvip,ovip(cvip,ovip不检测)
	function chkIprep($num=0){ 
		if(!empty($this->excfg['skip_iprep'])){
			if(strpos("(,{$this->excfg['skip_iprep']},)",",{$this->ugrade},")>0){
				return;
			}
		}
		$cnt = $this->db->table($this->tabid)->where("aip='".basEnv::userIP()."' AND atime>='".(time()-$num)."'")->count();
		//dump($cnt); dump($num);
		if($cnt>0){
			glbHtml::end(lang('flow.ck_rep',$num));
		}
	}

	static function headComm(){
		glbHtml::page(cfg('sys_name'),1);
		glbHtml::page('imadm','sadm.css');
		glbHtml::page('body',' style="padding:8px 5px 5px 5px;overflow-y:scroll;overflow-x:hidden;"'); 
	}

}

/*
showdef=1
login=1
ap_ccom=500  ap_xxx在allpub前面
allpub=100   skip_allpub=cvip,ovip
ippub=5      skip_ippub
iprep=3      skip_iprep
*/



/*******************************************************************************
 File : \code\core\dops\dopComs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// dopComs(data OP for Coms)
class dopComs extends dopBase{	

	public $kfix = 'yyyy-md-';
	public $ktmp = '31';
	//public $tbuacc = '';
	public $_kid = 'cid';
	public $_kno = 'cno';	

	//function __destory(){  }
	function __construct($cfg,$percheck=array()){ 
		$mod = $cfg['kid'];
		parent::__construct($cfg,$cfg['pid']."_$mod");
		if(!empty($percheck)){
			dopCheck::addInit($cfg,$percheck);
		}
		$this->typfid = $this->so->typfid = 'pid';
		$this->dskey  = $this->so->dskey  = 'title'; 
		$this->order  = $this->so->order  = basReq::val('order','atime');
		//$this->tbuacc  = 'users_uacc';
	}
	// 翻页条,批量操作
	function pgbar($idfirst,$idend,$exop=""){ //\ndnow|删除当前
		$pg = $this->pg->show($idfirst,$idend);
		$op = "".basElm::setOption(lang('flow.op_op3')."\n$exop",'',lang('flow.op0_bacth'));
		dopFunc::pageBar($pg,$op);
	}
	// 搜索条 // check,fields
	function sobar($msg='',$width=30){ 
		$mod = $this->mod;
		$sbar = "\n".$this->so->Type(90,'-pKey-'); 
		$sbar .= "\n&nbsp; ".$this->so->Word(80,80,lang('flow.op0_filt'));
		$sbar .= "\n&nbsp; ".$this->so->Show(60);
		$sbar .= "\n&nbsp; ".$this->so->Order(array('cid' => lang('flow.dops_ordkidd'),'cid-a' => lang('flow.dops_ordkida'),));
		$this->so->Form($sbar,$msg,$width);
	}

	// PKey pMod,pKey资料
	// hshow : 隐藏 显示开关
	// hrel ：隐藏 关联信息
	function fmPKey($hshow=0,$head=1,$hrel=0){ 
		$_groups = glbConfig::read('groups');
		$mod = $this->mod;
		$pid = @$this->fmo['pid']; 
		$pid || $pid = basReq::val('pid');
		$pmod = @$_groups[$mod]['pmod'];
		if($pmod){
			$pmname = $_groups[$pmod]['title'];
			$ptitle = $pid ? dopFunc::vgetTitle($pmod,$pid) : '';
			$item = "<input name='fm[pid]' type='text' id='fm[pid]' value='$pid' reg='fix:xid' readonly tip='".lang('flow.dc_c1024')."'> &nbsp; ";
			$item .= "<input type='text' id='fm2[refname]' value='$ptitle' class='txt w240' readonly>";
			$item .= "<input type='button' value='".lang('flow.dops_reldata')."' onclick=\"pickOpen('$pmod','','fm[pid]','fm2[refname]',1)\" class='btn'>";
		}else{
			$item = "<input id='fm[pid]' name='fm[pid]' type='text' value='".lang('flow.dc_norel')."' maxlength=24 class='txt w240 dis' disabled />";
		}
		glbHtml::fmae_row(lang('flow.dops_reldata'),$item,$hrel);
		glbHtml::fmae_row(lang('flow.dops_ishow'),$this->fmShow(),$hshow);
		if($head) echo "<tr><th>".lang('flow.dops_detail')."</th><th class='tr'>---</th></tr>\n";
	}

	// 属性设置
	function fmProp($head=1,$hid=0){ 
		dopFunc::fmSafe();
		$mod = $this->mod;
		if($head) echo "<tr><th nowrap>".lang('flow.title_attrset')."</th><th class='tr'>---</th></tr>\n";
		$this->fmAE3($hid);
	}
	// PKey pMod,pKey资料
	function svPKey($type='add'){ 
		$pid = preg_replace('/[^0-9A-Za-z\.\-]/','',@$this->fme['pid']);
		$pid && $this->fmv['pid'] = $pid;	
	}
	// svEKey，
	function svEKey(){
		$cid = basReq::val('cid');
		$this->svMoveFiles($cid);
		return preg_replace('/[^0-9A-Za-z\.\-]/','',$cid);
	}
	
}



/*******************************************************************************
 File : \code\core\dops\dopDocs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// dopDocs(data OP for Docs)
class dopDocs extends dopBase{	

	public $kfix  = 'yyyy-md-';
	public $ktmp  = '31';
	public $tbext = '';
	public $_kid = 'did';
	public $_kno = 'dno';

	//function __destory(){  }
	function __construct($cfg,$percheck=array()){ 
		$mod = $cfg['kid'];
		parent::__construct($cfg,$cfg['pid']."_$mod");
		if(!empty($percheck)){
			dopCheck::addInit($cfg,$percheck);
		}
		$this->typfid = $this->so->typfid = 'catid';
		$this->dskey  = $this->so->dskey  = 'title'; 
		$this->order  = $this->so->order  = basReq::val('order','did'); 
		$this->tbext  = "dext_$mod";
	}
	// 翻页条,批量操作
	function pgbar($idfirst,$idend){
		$pg = $this->pg->show($idfirst,$idend);
		$op = "".basElm::setOption(lang('flow.op_op3'),'',lang('flow.op0_bacth'));
		dopFunc::pageBar($pg,$op);
	}
	// 搜索条 // check,fields
	function sobar($msg='',$width=30){ 
		$mod = $this->mod;
		$sbar = "\n".$this->so->Type(90,lang('flow.op0_cat')); 
		if(method_exists($this,"sobar_$mod")){ //中间部分定制
			$sbar .= $this->{"sobar_$mod"}($msg,$width);
		}else{
			$sbar .= "\n&nbsp; ".$this->so->Word(80,80,lang('flow.op0_filt'));
			$sbar .= "\n&nbsp; ".$this->so->Show(60);
		}
		$sbar .= "\n&nbsp; ".$this->so->Order(array('did' => lang('flow.dops_ordkidd'),'did-a' => lang('flow.dops_ordkida'),),80);
		$this->so->Form($sbar,$msg,$width);
	}
	// 搜索条:模块(pro)扩展
	//function sobar_pro($msg='',$width=30){}
	
	// 属性设置
	function fmProp(){ 
		dopFunc::fmSafe();
		echo "<tr><th nowrap>".lang('flow.title_attrset')."</th><th class='tr'>---</th></tr>\n";
		glbHtml::fmae_row(lang('flow.title_attrtitle'),' &nbsp; ID:'.$this->fmSetID()); //'显示:'.$this->fmShow().
		$this->fmAE3();
	}
	// svEKey，
	function svEKey(){
		$this->svMoveFiles($this->fme['did']);
		return preg_replace('/[^0-9A-Za-z\.\-]/','',$this->fme['did']);
	}
	
	// opDelete。
	function opDelete($id){
		parent::opDelete($id);
		$this->db->table($this->tbext)->where("did='$id'")->delete();  	
		return 1;
	}
	// opCopy。
	function opCopy($id){ //docs,users
		// get-kid
		$kar = glbDBExt::dbAutID($this->tbid,$this->kfix,$this->ktmp);
		$kid = $kar[0]; $kno = $kar[1];	
		// insert-2
		foreach(array($this->tbid, $this->tbext) as $tabid){
			$fm = $this->db->table($tabid)->where("did='$id'")->find();
			$fm['did'] = $kid;
			$this->db->table($tabid)->data(basReq::in($fm))->insert();	
		}
		return 1;
	}
	
}



/*******************************************************************************
 File : \code\core\dops\dopExtra.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// dopExtra(data OP for Extra)
class dopExtra extends dopBase{	

	#public $ktmp = '22';
	public $_kid = 'kid';

	//function __destory(){  }
	function __construct($tab='',$cfg=array()){ 
		empty($cfg['pid']) && $cfg['pid'] = '';
		parent::__construct($cfg,$tab);
		if(isset($cfg['typfid'])) $this->typfid = $this->so->typfid = 'catid';
		$this->soset($cfg);
		$this->order  = $this->so->order  = basReq::val('order','atime');
	}
	// 翻页条,批量操作
	function pgbar($idfirst,$idend,$ops="(null)"){
		if($ops=='(null)') $ops="dele|".lang('op_delsel')."\ndnow|".lang('op_delnow')."";
		$pg = $this->pg->show($idfirst,$idend);
		$op = "".basElm::setOption($ops,'',lang('flow.op0_bacth'));
		dopFunc::pageBar($pg,$op);
	}
	// 搜索条 // check,fields
	function sobar($msg='',$width=30,$sor2='-1',$khid=array()){ 
		$mod = $this->mod; $sbar = ''; 
		$sbar .= "\n&nbsp; ".$this->so->Word(80,80,lang('flow.op0_filt'),$this->sofields);
		if(!empty($this->soarField)){
			$sbar .= "\n&nbsp; $this->soarMsg:".$this->so->Area(1,50,$this->soarField);
		}
		$sbar .= "\n&nbsp; ".$this->so->Order($this->soorders,100,lang('flow.op0_order'),$sor2);
		$this->so->Form($sbar,$msg,$width,$khid);
	}
	
	// opDelnow。
	function opDelnow($days=0){ 
		$where = empty($this->so->whrstr) ? '' : (substr($this->so->whrstr,5));
		if(empty($where)) return lang('msg_delxng');
		$this->db->table($this->tbid)->where($where)->delete(); 
		return lang('msg_delxok',basJscss::jsShow($where)); 
	}	
	// 搜索 init
	function soset($cfg=array()){ 
		$this->sofields = $cfg['sofields'];
		foreach($this->sofields as $k=>$v){
			if(is_numeric($k))	{
				$this->so->cfg['f'][$v] = $v;
			}else{
				$this->so->cfg['f'][$k] = $v;	
			}
		}
		$this->soorders = $cfg['soorders'];
		if(!empty($cfg['soarea'])){
			$this->soarField = $cfg['soarea'][0];
			$this->soarMsg = $cfg['soarea'][1];
			$this->so->fext = array($this->soarField=>$this->soarMsg);
		}
	}
	
}



/*******************************************************************************
 File : \code\core\dops\dopFunc.php 
*******************************************************************************/
<?php
// dopFunc : 基本操作 static函数
class dopFunc{	

	static function getMinfo($mod,$kid='',$fid=''){
		$db = glbDBObj::dbObj();
		$fid || $fid = glbDBExt::getKeyid($mod);
		$info = $db->table(glbDBExt::getTable($mod))->where("$fid='$kid'")->find(); 
		return $info; 
	}

	static function joinDext(&$re,$mod){
		$db = glbDBObj::dbObj();
		$ids = '';
		foreach($re as $k=>$v){
			$ids .= (empty($ids) ? '' : ',')."'".$v['did']."'";
		} //echo "$ids"; print_r($re);
		if(empty($ids)) return;
		$re1 = $db->table(glbDBExt::getTable($mod,1))->where("did IN($ids)")->select(); 
		$re2 = array();
		foreach($re1 as $k1=>$v1){ 
			$re2[$v1['did']] = $v1;
		} //print_r($re2);
		foreach($re as $k=>$v){
			if(isset($re2[$v['did']])){
				$re[$k] = $v + $re2[$v['did']];
			}
		} //print_r($re);
	}

	static function vgetLink($title,$mod='',$kid='',$link=''){
		if(empty($link)){ 
			$url = PATH_ROOT."/plus/ajax/redir.php?$mod.{$kid}";
		}elseif($link=='#'){
			return $title;
		}elseif(strpos($link,'://')){
			$url = $link;	
		}else{
			$url = PATH_ROOT.$link;	
		}
		$re = "<a href='$url' target='_blank'>$title</a>"; 
		return $re; 
	}

	// 获取字段值(标题,公司名,会员名)
	static function vgetTitle($mod,$val='',$field=''){
		$db = glbDBObj::dbObj(); $mcfg = glbConfig::read($mod); 
		$field || $field ="title,company,uid,uname,mname,mtel,memail"; 
		$field = self::vchkFields($field,self::vgetFields($mcfg['f'],'all','all'));
		$field = implode(',',array_keys($field)); 
		$field = explode(',',$field); $field = $field[0];
		$kid = substr($mcfg['pid'],0,1).'id'; if($kid=='uid') $kid='uname';
		$r = $db->table(glbDBExt::getTable($mod))->field($field)->where("$kid='$val'")->find(); 
		return empty($r[$field]) ? '' : $r[$field] ; 
	}
	
	// 获取字段(某种类型)
	static function vgetFields($fcfgs,$type='input,select',$dbtype='varchar'){
		$re = array();
		foreach($fcfgs as $k=>$v){
			if($type!='all' && !strstr($type,$v['type'])) continue;
			if($dbtype!='all' && !strstr($dbtype,$v['dbtype'])) continue;
			if(!empty($v['etab'])) continue;
			$re[$k] = $v['title'];	
		} 
		return $re;
	}
	// 检查字段(是否在可能的字段内)
	static function vchkFields($obj,$orgt){
		$org = array_keys($orgt);
		if(empty($obj)) return $orgt;
		$fields = is_string($obj) ? explode(',',$obj) : $obj;
		$re = array();
		foreach($fields as $k){
			if(in_array($k,$org)){
				$re[$k] = $orgt[$k];			
			}
		} 
		return $re;
	}
	// 排序字段()
	static function vordFields($obj){
		//$obj 
		foreach($obj as $k=>$v){
			$obj["$k-a"] = "$v".lang('flow.dops_ordasc');	
		}
		return array_merge($obj,array('atime'=>lang('flow.dops_ordtimd'),'atime-a'=>lang('flow.dops_ordtima')));
	}
	
	// 表单默认值 showdef=1/0
	static function fmDefval($obj,$key='show',$def=''){
		$data = $obj->fmo;
		if(isset($data[$key])){
			return $data[$key];
		}else{
			$val = ''; $key = "{$key}def"; 
			$arr = basElm::text2arr(@$obj->cfg['cfgs']);
			return isset($arr[$key]) ? $arr[$key] : $def;
		}
	}
	
	// fmSafe使用
	static function fmSafe($pid=''){ 
		//$cfg,$aurl;
		//return $str;
	}
	// svSafe使用
	static function svSafe($pid=''){ 
		//$cfg,$aurl;
		//return $str;
	}	

	// 翻页条
	static function pageBar($pgbar,$opbar,$opname='(null)',$jsFunc='fmSelAll'){
		$opname = $opname=='(null)' ? lang('flow.dops_exeu') : $opname;
		$pgbar = "<div class='pg_bar'>$pgbar</div>";
		$opstr = strpos($opbar,'</option>') ? "<select name='fs_do' class='w100'>$opbar</select>" : $opbar;
		$opbar = "<div class='w180 tc right'>$opstr";
		$opbar .= ($opname ? "<input name='bsend' class='btn' type='submit' value='$opname' />" : '')."</div>";
		echo "\n<tr><td class='tc' nowrap>\n";
		if($jsFunc) echo "<input name='fs_act' type='checkbox' class='rdcb' onClick='$jsFunc(this)' /></td>";
		echo "<td colspan='15'>$opbar$pgbar</td>\n";
		echo "\n</tr>";
	}

	// svFmtval。
	static function svFmtval($f,$mod,$k,$val){
		$fext = @$f[$k]['fmextra']; //参考fldView::fitem()
		if(is_array($val)) $val = implode(',',$val); //array
		if($fext=='editor'){
			$val = basReq::fmt($val,'','Html',2000123); //2000123=2M,  MEDIUMTEXT最大长度为16,777,215。
			$val = basReq::in($val);
			//$val = comFiles::moveTmpDir($val,$mod,'',1);
		}elseif($fext=='datetm'){  
			$totime = strtotime(basReq::fmt($val,'1979-09-13'));
			$val = empty($val) ? time() : (is_numeric($val) ? $val : $totime); 
		}elseif($fext=='color'){
			$val = preg_replace('/[^0-9A-Fa-f]/','',$val);
		}elseif($fext=='map'){
			$val = preg_replace('/[^0-9,\.]/','',$val);
		}elseif($fext=='winpop'){
			$val = preg_replace('/[^0-9A-Za-z,]/','',$val);	
		}elseif($fext=='pics'){
			$val = basStr::filSafe4($val); 	
			//$val = comFiles::moveTmpDir($val,$mod,'',0);
		}elseif($fext=='pick'){
			$val = is_array($val) ? implode(',',$val) : $val;
			$val = basStr::filTitle($val); 	
		}elseif(in_array($f[$k]['type'],array('select','cbox','radio'))){
			$val = is_array($val) ? implode(',',$val) : $val;
			$val = basStr::filTitle($val); 
		}elseif(in_array($f[$k]['type'],array('file'))){
			$val = str_replace(array('<','>','"',"'","\\","\r","\n",'*','|','?'),'',$val); 
			//$val = comFiles::moveTmpDir($val,$mod,'',0);
		}elseif(in_array($f[$k]['dbtype'],array('int','float'))){
			$val = basReq::fmt($val,'0','N');
		}elseif($f[$k]['dbtype']=='text'){ 
			$val = basReq::fmt($val,'','Html',24123); //24K
		}elseif($f[$k]['dbtype']=='varchar'){
			$val = basStr::filTitle($val);
		}else{
			$val = basReq::fmt($val,'','Html'); //255
			$val = basReq::in($val);
		}
		return $val;		
	}
	
	// modFile .. ???? 
	static function modFile($scbase,$mod,$type){ //模型脚本
		if(defined('RUN_ADMIN')){ //后台
			$udir = 'umod'; //用户扩展
			$edir = 'emod'; //系统扩展
			$ecfg = 'ex_fadm';
		}else{ //会员
			$udir = 'umou'; //用户扩展
			$edir = 'emod'; //系统扩展
			$ecfg = 'ex_fmem';
		}
		$re = '';
		require(DIR_CODE."/cfgs/scfile/$ecfg.php"); //$_scfile
		if(file_exists($_fex="$scbase/$udir/{$mod}.php")){
			$re = $_fex; 
		}elseif(file_exists($_fex="$scbase/$edir/{$mod}.php")){
			$re = $_fex; 
		}elseif(file_exists($_fex="$scbase/dops/{$type}_{$mod}.php")){
			$re = $_fex; 
		}elseif(isset($scfgs[$mod]) && file_exists($scbase.$scfgs[$mod])){
			$re = $scbase.$scfgs[$mod]; //以上配置:再次
		} 
		return $re;
	}
	
	// modAct .. ???? 
	static function modAct($scbase,$act,$mod,$type){ //act脚本
		if(defined('RUN_ADMIN')){ //后台
			$udir = 'uact';  //用户扩展
			$edir = 'eact'; //系统扩展
		}else{ //会员
			$udir = 'uacu'; //用户扩展 
			$edir = 'eacu'; //系统扩展
		}
		if(file_exists($_fex="$scbase/$udir/{$mod}_{$act}.php")){
			return $_fex; //扩展目录
		}elseif(file_exists($_fex="$scbase/$edir/{$mod}_{$act}.php")){
			return $_fex; //扩展脚本
		}elseif(file_exists($_fex="$scbase/dops/{$type}_{$act}.php")){
			return $_fex;
		}else{
			return '';	
		}
	}
	
}



/*******************************************************************************
 File : \code\core\dops\dopUser.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// dopUser(data OP for User)
class dopUser extends dopBase{	

	public $kfix = 'yyyy-md-';
	public $ktmp = '31';
	public $tbuacc = '';
	public $_kid = 'uid'; //uid在uacc表
	public $_kno = 'uno';
	
	//function __destory(){  }
	function __construct($cfg){ 
		$mod = $cfg['kid'];
		parent::__construct($cfg,$cfg['pid']."_$mod");
		$this->typfid = $this->so->typfid = 'grade';
		$this->dskey  = $this->so->dskey  = 'mname'; 
		$this->order  = $this->so->order  = basReq::val('order','uid');
		$this->tbuacc  = 'users_uacc';
	}
	// 翻页条,批量操作
	function pgbar($idfirst,$idend){
		$pg = $this->pg->show($idfirst,$idend);
		$op = "".basElm::setOption(lang('flow.op_op3'),'',lang('flow.op0_bacth'));
		dopFunc::pageBar($pg,$op);
	}
	// 搜索条 // check,fields
	function sobar($msg='',$width=30){ 
		$mod = $this->mod;
		$sbar = "\n".$this->so->Type(90,lang('du_gradeo')); 
		if(method_exists($this,"sobar_$mod")){ //中间部分定制
			$sbar .= $this->{"sobar_$mod"}($msg,$width);
		}else{
			$sbar .= "\n&nbsp; ".$this->so->Word(80,80,lang('flow.op0_filt'));
			$sbar .= "\n&nbsp; ".$this->so->Show(60);
		}
		$sbar .= "\n&nbsp; ".$this->so->Order(array('uname' => lang('flow.dops_orduidd'),'uname-a' => lang('flow.dops_orduida'),));
		$this->so->Form($sbar,$msg,$width);
	}
	// 搜索条_company
	function sobar_company($msg='',$width=30){ 
		$sbar = "\n&nbsp; ".$this->so->Field('ftype',$w=90);
		$sbar .= "\n&nbsp; ".$this->so->Word(80,80,lang('flow.op0_filt'));
		$sbar .= "<br />\n".$this->so->Show();
		$sbar .= "\n&nbsp; ".$this->so->Area(90);
		return $sbar;
	}

	// Account Info 账户资料
	function fmAccount(){ 
		glbHtml::fmae_row('ID',$this->fmSetID()); //'显示:'.$this->fmShow().
		//echo "<tr><th>账户资料</th><th class='tr'>---</th></tr>\n";
		glbHtml::fmae_row(lang('du_userid'),$this->fmSetUname().' &nbsp; '.lang('du_upass').$this->fmSetPW());
		//glbHtml::fmae_row('问题',$this->fmSetQA('getpwq').' &nbsp; 答案'.$this->fmSetQA('getpwa'));
		glbHtml::fmae_row(lang('du_gradet'),$this->fmType('grade',180).' &nbsp; '.lang('flow.dops_ishow').$this->fmShow());
		echo "<tr><th>".lang('flow.dops_detail')."</th><th class='tr'>---</th></tr>\n";
	}
	
	/*
	function fmSetQA($key){
		$val = $key=='getpwa' ? '' : @$this->fmo[$key]; 
		$nulmsg = $key=='getpwq' ? '' : "两个同时不为空则修改问题和答案";
		if(empty($val)){
			$nultip = ""; 
		}else{
			$nultip = "nul:"; 
		}
		$item = "<input id='fm[$key]' name='fm[$key]' type='text' value='$val' maxlength=24 class='txt w180' reg='{$nultip}key:6-24' tip='6-24字符' />$nulmsg";
		return $item;
	}*/
	function fmSetPW(){
		if(empty($this->fmo['uname'])){
			$nultip = ""; 
			$nulmsg = lang('admin.fad_up624');
		}else{
			$nultip = "nul:"; 
			$nulmsg = lang('du_empty');
		}
		$item = "<input id='fm[upass]' name='fm[upass]' type='text' value='' maxlength=24 class='txt w180' reg='{$nultip}key:6-24' tip='".lang('admin.fad_up624')."' />$nulmsg";
		return $item;
	}

	// SetID，会员使用-其它无此属性。
	function fmSetUname(){
		$mod = $this->mod;
		$val = @$this->fmo['uname']; 
		$len = empty($val) ? 'var:3-15' : 'var:2-24';
		$prop = " id='fm[uname]' name='fm[uname]' type='text' maxlength=24 reg='$len' tip='".lang('admin.fad_uid31546')."' ";
		if(empty($val)){
			$uname = 'm'.basKeyid::kidRand('24',5);
			$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=userExists&mod=$mod'"; 
			$item = "<input value='$uname' class='txt w180' $prop $vstr/>";
		}else{
			$item = "<input value='$val' class='txt w180 disc' $prop readonly/>";
		}
		return $item;
	}

	// 属性设置
	function fmProp(){ 
		dopFunc::fmSafe();
		$mod = $this->mod;
		echo "<tr><th nowrap>".lang('flow.title_attrset')."</th><th class='tr'>---</th></tr>\n";
		$this->fmAE3();
	}
	// Account Info 账户资料
	function svAccount($type='add'){ 
		$mod = $this->fme['umods'] = $this->mod; 
		$accs = array('uid','uno','uname','upass','umods'); //,'getpwq','getpwa'
		$data = array();
		foreach($accs as $k){
			$$k = $data[$k]= $this->fme[$k];
		}
		//$uname = $data['uname'];
		//$upass = $data['upass'];
		//$getpwq = $data['getpwq'];
		//$getpwa = $data['getpwa'];
		$upassOrg = $upass; //备份
		$upass = $data['upass'] = comConvert::sysPass($uname,$upass,$mod);
		//$data['getpwa'] = comConvert::sysPass($getpwq,$getpwa,$mod);
		#if($type=='edit' && empty($upassOrg)){
			#unset($data['upass']);
		//}elseif($type=='edit' && (empty($getpwq)||empty($getpwa))){
			//unset($data['getpwq']);
			//unset($data['getpwa']);
		#}
		foreach($accs as $k){
			if(in_array($k,array('uid','uname'))){
				$this->fmv[$k] = $$k;
				continue; //,'uname'
			}
			unset($this->fmv[$k]);
		}
		$this->fmv['uid'] = $uid;
		if($type=='edit' && !empty($upassOrg)){
			$this->db->table($this->tbuacc)->data(array('upass'=>$upass))->where("uid='$uid'")->update();
		}elseif($type=='add'){
			$this->db->table($this->tbuacc)->data(basReq::in($data))->insert();
		}
	}
	// svEKey，
	function svEKey(){
		$this->svMoveFiles($this->fme['uid']);
		return preg_replace('/[^0-9A-Za-z\.\-]/','',$this->fme['uid']);
	}
	
	// opDelete。
	function opDelete($id){
		parent::opDelete($id);
		$row = $this->db->table($this->tbuacc)->where("uid='$id'")->find();
		if(!empty($row)){
			$this->db->table('users_uppt')->where("uname='$row[uname]'")->delete();
			$this->db->table($this->tbuacc)->where("uid='$id'")->delete(); 
		}
		return 1;
	}
	// opCopy。
	function opCopy($id){ //docs,users
		// get-kid
		$kar = glbDBExt::dbAutID($this->tbid,$this->kfix,$this->ktmp);
		$kid = $kar[0]; $kno = $kar[1];	
		// insert-2
		foreach(array($this->tbid, $this->tbuacc) as $tabid){
			$fm = $this->db->table($tabid)->where("uid='$id'")->find();
			$fm['uid'] = $kid; 
			$fm['uname'] = substr($fm['uname'],0,3).'_'.basKeyid::kidRand('24',8);
			//upass
			$this->db->table($tabid)->data(basReq::in($fm))->insert();	
		}
		return 1;
	}
	
	// edit-pass。
	static function editPass($mod,$uname){ //docs,users
		$pwold = basReq::val('pwold');
		$pwnew = basReq::val('pwnew');
		$pwrep = basReq::val('pwrep'); 
		$oldpass = comConvert::sysPass($uname,$pwold,$mod);
		$newpass = comConvert::sysPass($uname,$pwnew,$mod);
		if(empty($pwnew) || $pwnew!==$pwrep){
			$remsg = lang('du_noteq');
		}elseif($this->db->table("users_uacc")->where("uname='$uname' AND upass='$oldpass'")->find()){
			$this->db->table("users_uacc")->data(array('upass'=>$newpass))->where("uname='$uname'")->update();
			$remsg = lang('du_editok');
		}else{
			$remsg = lang('du_erold');
		}
		return $remsg;
	}

	
}



/*******************************************************************************
 File : \code\core\dops\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\dops\usrAdmin.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// usrAdmin
class usrAdmin extends usrBase{	
	
	//public $sessid = '';
	
	function __construct() {
		parent::__construct('adminer'); 
	}
	
	//
	function login($uname='',$upass='',$ck=0){
		$re1 = $this->check_login($uname,$upass); 
		$re2 = $this->login_msg($re1);
		if($re1=='OK'){ //Session
			$this->setSess();
		}
		return array($re1,$re2);
	}
	
	// 
	function logout(){
		$re1 = $this->check_logout();
		if($re1!='Forbid'){ 
			comSession::set($this->sessid,''); 
		}else{
			//echo "$re1";	
		}
		return $re1;
	}
	
	function setSess(){
		$str = '';
		foreach(array('model','grade') as $k){
			$str .= (empty($str) ? '':'&')."$k=".@$this->uperm[$k];
		} 
		// model=adminer&grade=supper 
		if(strpos($str,'grade=supper')){
			$str .= "&pextra=pstools,psdev";
		}else{
			$str .= "&pextra=".@$this->uperm['pextra'];	
		} //echo $str;
		comSession::set($this->sessid,$str); 
	}
	
	static function getMkv($re='mkv'){
		$file = basReq::val('file'); 
		if(in_array(substr($file,0,1),array('.','/'))){
			return 'amain'; // 不能是 .和/ 开头; 
		}
		$frame = basReq::val('frame');
		if($frame && $file){
			$re = 'awtop';
		}elseif($file){
			$re = 'amain';
		}else{
			$re = '';
		}
		return $re;
	}

	static function opLogin(){	
		$user = usrBase::userObj('Admin');
		$act = basReq::val('act');
		if($act=='dologin'){ 
			$re2 = safComm::formCAll('fmadm'); 
			if(empty($re2[0])){ 
				$fm = $_POST['fm'];
				$res = $user->login($fm['uname'],$fm['upass']);
				$remsg = $res[0]=='OK' ? '' : $res[1];
				$remsg || header('Location:'."?");	
			}else{
				$remsg = lang('admin.oplogin_vform_err');	
			} 
		}elseif($act=='doout'){
			$user->logout();
			$remsg = lang('admin.oplogin_logout');	
		}
		$remsg = empty($remsg) ? lang('admin.oplogin_please_login') : $remsg; 
		return $remsg;
	} // # $remsg = "错误登录次数：{$user->usess['errno']}次；&nbsp; 锁定时间至：".date('Y-m-d H:i:s',$user->usess['stime']+$user->utmOut)."。";

}



/*******************************************************************************
 File : \code\core\dops\usrBase.php 
*******************************************************************************/
<?php

// usrBase
class usrBase{	

	public $userType = ''; //member/adminer
	public $userFlag = 'Guest'; //Login/Guest,Error
	public $usTable = ''; //online/admin
	public $utmOut = ''; //1200/2400
	public $udbUpd = 300; //db更新周期，5分钟
	//public $uckUpd = 20; //cookie更新周期，20秒
	public $errno = 0;
	public $sessid = '';
	
	public $sinit = array(); //初始sid,sip,sua数据
	public $usess = array(); //active会话数据
	public $uperm = array(); //用户权限
	public $uinfo = array(); //用户模型数据
	
	static $uobjs = array(); //用户对象
	public $db = NULL;
	
	function __construct($userType=''){
		$this->db = glbDBObj::dbObj(); 
		$this->sess_tout($userType);
		$this->sess_init();
		$this->check_cuser();
	}
	
	// re : Null, isLogin, Forbid, Info, array()
	function check_logout(){
		$_groups = glbConfig::read('groups');
		if($this->userFlag=='Error') return 'Forbid';
		if($this->userFlag!='Login') return 'notLogin'; 
		$this->userFlag = 'Guest';
		$this->uperm = array();
		$this->uinfo = array();
		$data = $this->sinit; $sid = $data['sid']; unset($data['sid'],$data['scode']);
		foreach(array('show','cfgs','grade') as $k){
			$data[$k] = $this->usess[$k] = '0';
		}
		$this->usess['errno'] = '0';
		$this->db->table($this->usTable)->data(basReq::in($data))->where("sid='$sid'")->update();
		return 'OK'; 
	}
	
	function login_msg($key){
		if(is_numeric($key)){
			$re = lang('usrb_ertimes',$key);
		}else{
			$ucfg = basLang::ucfg('cfglibs.usrbase');
			$re = isset($ucfg[$key]) ? $ucfg[$key] : "($key)".lang('usrb_erunknow');
		}
		return $re;
	}
	
	//
	static function setLogin($type='m', $uname=''){
		$db = glbDBObj::dbObj();
		if(empty($uname)) return;
		$user = self::userObj($type=='m' ? 'Member' : 'Admin');
		$user->uinfo = $user->uget_minfo($uname); 
		$data = $user->sinit; unset($data['scode']); 
		$data['uname'] = $user->uinfo['uname']; 
		$data['cfgs'] = '0';
		$data['grade'] = $user->uinfo['grade']; //grade=xstop处理???
		$data['errno'] = 0;
		$data['show'] = empty($user->uinfo['show']) ? '0' : $user->uinfo['show'];
		$usTable = $type=='m' ? 'active_online' : 'active_admin';
		if(!empty($user->usess)){
			$sid = $data['sid']; unset($data['sid']);
			$db->table($usTable)->data(basReq::in($data))->where("sid='$sid'")->update();
		}else{ 
			$db->table($usTable)->data(basReq::in($data))->insert();
		} 
	}
	
	// re : Null, isLogin, Forbid, Info, array()
	function check_login($uname='',$upass=''){
		$_groups = glbConfig::read('groups');
		if(empty($uname) || empty($upass)) return 'Null'; 
		$simpass = glbConfig::read('simpass','ex');
		if(in_array($upass,$simpass)) return 'SimPass'; 
		if($this->userFlag=='Error') return 'Forbid';
		if($this->userFlag=='Login') return 'isLogin'; 
		$uname = basStr::filKey($uname,'_'); 
		//echo "$uname,$upass,$this->userType = $epw;<br> ";
		$this->uinfo = $this->uget_minfo($uname,$upass); 
		if(empty($this->uinfo['show'])) return 'noChecked'; 
		$data = $this->sinit; unset($data['scode']);
		$data['uname'] = $uname; $data['show'] = '0'; $data['cfgs'] = '0';
		if($this->uinfo){ 
			$this->userFlag = 'Login';
			$data['grade'] = $this->uinfo['grade']; //grade=xstop处理???
			$data['errno'] = 0;
			$data['show'] = empty($this->uinfo['show']) ? '0' : $this->uinfo['show'];
			$this->uperm = $this->uget_perms($this->uinfo['grade']); 
			$this->uset_mlogs($uname,$this->uperm['model']);
			$re = 'OK';
		}else{ 
			$data['grade'] = '0';
			$data['errno'] = empty($this->usess) ? 1 : $this->usess['errno'] + 1;
			$re = $data['errno'];
		} 
		if(!empty($this->usess)){
			$sid = $data['sid']; unset($data['sid']);
			$this->db->table($this->usTable)->data(basReq::in($data))->where("sid='$sid'")->update();
		}else{ 
			$this->db->table($this->usTable)->data(basReq::in($data))->insert();
		}
		$this->usess = $data; 
		return $re;
	}
	
	//$re //Login/Guest,Error
	function check_cuser(){
		$stamp = time();
		$_groups = glbConfig::read('groups');
		$sid = $this->sinit['sid'];
		$this->usess = $this->uget_online($sid,'*'); 
		if(!empty($this->usess)){ // 判断: stime,errno,uid,grade,
			if($stamp-$this->usess['stime']>$this->utmOut){ //超时
				$this->userFlag = 'Guest';
			}elseif($this->usess['errno']>=$this->errno){ //错误
				$this->userFlag = 'Error';
			}else{ //登录正常
				$this->uperm = $this->uget_perms($this->usess['grade']);
				if($this->uperm){
					$this->userFlag = 'Login';
					if($stamp-$this->usess['stime']>$this->udbUpd){ //更新会话表
						$data = array('stime'=>$stamp);
						$this->db->table($this->usTable)->data(basReq::in($data))->where("sid='$sid'")->update();
					}
				}
				$this->uinfo = $this->uget_minfo($this->usess['uname']); //if(empty($this->uinfo['show']))  
			}		
		}
	}

	//...???
	function uget_online($sid,$field=''){
		$_groups = glbConfig::read('groups');
		$field || $field = '*';
		$res = $this->db->table($this->usTable)->field($field)->where("sid='$sid'")->find();
		return $res;	
	}

	//...
	static function uget_perms($grade){
		$grades = glbConfig::read('grade','dset');
		//print_r($grades);
		if(isset($grades[$grade])){
			$res = $grades[$grade];
		}else{
			$res = array();	
		}
		return $res;	
	}

	//...
	function uset_mlogs($uname,$umod,$user=''){
		global $_cbase;
		$_cbase['run']['skipDemo'] = 1;
		$user || $user = $uname;
		$data = array('eip'=>$this->sinit['sip'],'etime'=>$this->sinit['stime'],'euser'=>$user);
		$re1 = $this->db->table("users_$umod")->data(basReq::in($data))->where("uname='$uname'")->update();
		//$re2 = $this->db->table("users_uacc")->data(array('etime'=>$this->sinit['stime']))->where("uname='$uname'")->update();
		$_cbase['run']['skipDemo'] = 0;
	}

	//..., model,grade,checked
	static function uget_minfo($uname,$upass='',$unset=array('upass')){
		$db = glbDBObj::dbObj(); 
		$_groups = glbConfig::read('groups');
		$ubase = $db->table('users_uacc')->where("uname='$uname'")->find(); 
		$umod = $ubase['umods']; $dbpass = $ubase['upass'];
		if(!isset($_groups[$umod])) return array(); 
		if($upass && $dbpass!==comConvert::sysPass($uname,$upass,$umod)) return array();
		$uminf = $db->table("users_$umod")->where("uname='$uname'")->find(); // AND `show`='1'
		if(empty($uminf)) return array();
		if(!empty($ubase)){
			if(!empty($unset)){ foreach($unset as $k){
				unset($ubase[$k]);
			} }
			$uminf = $uminf + $ubase;
		} 
		return $uminf;	
	}
	
	//超时时间设置
	function sess_tout($userType=''){
		global $_cbase; 
		$madmin = intval(@$_cbase['tout_admin']);
		$member = intval(@$_cbase['tout_member']);
		//小时
		if($madmin<0.15) $madmin = 1; if($madmin>100) $madmin = 96; 
		if($member<0.15) $member = 4; if($member>100) $member = 96; 
		$this->userType = $userType;
		$this->usTable = $this->userType=='adminer' ? 'active_admin' : 'active_online'; 
		$this->errno = $this->userType=='adminer' ? 5 : 8; 
		$this->utmOut = 3600*($this->userType=='adminer' ? $madmin : $member);

		
	}
	//初始化seesion
	function sess_init(){
		global $_cbase; 
		$this->sessid = usrPerm::getSessid();
		$stime = $_cbase['run']['stamp'];
		$scode = comConvert::sysEncode($stime,$_cbase['safe']['safil']);
		$re = comSession::guid('safil','sessid');
		foreach(array('stime','scode') as $k) $re[$k] = $$k;
		$this->sinit = $re; 
	}
		
	// $uclass : 按uclass建立user对象, <Null>-Admin/Member-建立
	static function userObj($uclass=''){
		if(empty($uclass)){ 
			$uclass = defined('RUN_ADMIN') ? 'Admin' : array('Member','Admin');	
		}
		if(is_array($uclass)){
			foreach($uclass as $flag){
				$iuser = self::userObj($flag);
				if(!empty($iuser->uperm)){ 
					return $iuser;
				}
			}
			return NULL;
		}
		$uclass = $uclass=='Admin' ? 'usrAdmin' : 'usrMember';
		if(empty(self::$uobjs[$uclass])){ 
			self::$uobjs[$uclass] = new $uclass();
		}
		return self::$uobjs[$uclass];
	}
	
}



/*******************************************************************************
 File : \code\core\dops\usrMember.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// usrMember
class usrMember extends usrBase{
	
	//public $sessid = '';
	
	function __construct() {
		parent::__construct('member'); 
	}

	//
	function login($uname='',$upass='',$ck=0){
		$re1 = $this->check_login($uname,$upass); 
		$re2 = $this->login_msg($re1);
		if($re1=='OK'){ //Session
			//$this->setSess();
		}
		return array($re1,$re2);
	}
	
	// 
	function logout(){ 
		$re1 = $this->check_logout();
		if($re1!='Forbid'){ 
			comSession::set($this->sessid,''); 
		}else{
			//echo "$re1";	
		}
		return $re1;
	}
	
	// mod,uname,upass; mname,mtel,memail; company,uid,grade,check
	static function addUser($mod,$uname,$upass,$mname='',$mtel='',$memail='',$excfg=array()){ 
		$arr = array('uname','mname','mtel','memail'); foreach($arr as $k){ $$k = basStr::filTitle($$k); }
		if(isset($excfg['company'])) { $excfg['company'] = basStr::filTitle($excfg['company']); }
		$db = glbDBObj::dbObj(); 
		$re = array('erno'=>'','ermsg'=>'');
		$md = glbConfig::read($mod);
		if($md['pid']!='users'){
			$re['erno'] = "model:$mod:Error拢隆";
			$re['ermsg'] = "model[$mod]麓铆贸拢隆";
			return $re;
		}
		$uname = self::addUname($uname,$mod);
		$uarr = self::addUid(@$excfg['uid']); $uid = $uarr['uid']; $uno = $uarr['uno']; 
		@$mcfg = basElm::text2arr($md['cfgs']); 
		$defgrade = (isset($mcfg['defgrade']) && isset($md['i'][$mcfg['defgrade']])) ? $mcfg['defgrade'] : '';
		$grade = isset($excfg['grade']) ? $excfg['grade'] : $defgrade; 
		@$defshow = in_array($mcfg['defcheck'],array('Y','1')) ? '1' : 0;
		@$show = intval($excfg['check']) ? intval($excfg['check']) : $defshow; 
		$mname = $mname ? $mname : $uname; 
		$mtel = $mtel ? $mtel : '127-6666-8888'; 
		$memail = $memail ? $memail : "$mname@domain.com";
		$tabid = $md['pid']."_$mod";
		$upass = comConvert::sysPass($uname,$upass,$mod);
		$acc = array('uid'=>$uid,'uno'=>$uno,'uname'=>$uname,'upass'=>$upass,'umods'=>$mod,); 
		$dataex = basSql::logData();
		$db->table('users_uacc')->data($acc+$dataex)->insert(); 
		$umd = array('uid'=>$uid,'uname'=>$uname,'grade'=>$grade,'mname'=>$mname,'mtel'=>$mtel,'memail'=>$memail,'show'=>$show,);
		if(isset($md['f']['company']) && isset($excfg['company'])) $umd['company'] = $excfg['company']; 
		$db->table("users_$mod")->data($umd+$dataex)->insert();
		$re = array('uid'=>$uid,'grade'=>$grade,'check'=>$show,'uname'=>$uname,);
		extJifen::main(array_merge($md,array('uid'=>$uid,'auser'=>$uname)),'add','垄虏谩录路');
		return $re;
	}
	
	static function addUname($uname='',$mod=''){ 
		$db = glbDBObj::dbObj(); 
		$tabid = 'users_uacc'; $key = "uname";
		if(empty($uname)){
			$uname = substr($mod,0,1).str_replace('-','',basKeyid::kidTemp('5'));
		}
		$r = $db->table($tabid)->field($key)->where("$key='$uname'")->find(); //print_r($r);
		if(!empty($r[$key])){ 
			return self::addUname('',$mod);
		}
		return $uname;
	}
	
	static function addUid($uid=''){ 
		$db = glbDBObj::dbObj(); 
		$tabid = 'users_uacc'; $key = "uid";
		if(empty($uid)){
			$kar = glbDBExt::dbAutID($tabid,'yyyy-md-','31');
			$uid = $kar[0]; $uno = $kar[1];	
		}else{
			$uno = '1';	
		}
		$r = $db->table($tabid)->field($key)->where("$key='$uid'")->find(); //print_r($r);
		if(!empty($r[$key])){ 
			return self::addUid();
		}
		return array('uid'=>$uid,'uno'=>$uno);
	}
	
	static function bindUser($mname,$pptmod,$pptuid){ 
		$db = glbDBObj::dbObj();
		$db->table('users_uppt')->data(array('uname'=>$mname, 'pptmod'=>$pptmod, 'pptuid'=>$pptuid))->insert();
	}
	
	static function emailGetpw($uname, $memail){ 
		$db = glbDBObj::dbObj(); 
		$uinfo = self::uget_minfo($uname);
		if(!empty($uinfo['memail']) && $uinfo['memail']==$memail){
			$upass = basKeyid::kidRand('24',8);
			$dbpass = comConvert::sysPass($uname,$upass,$uinfo['umods']); 
			$db->table("users_uacc")->data(array('upass'=>$dbpass))->where("uname='$uname'")->update();
			$upass = comConvert::sysRevert($upass, 0, '', 3600);
			$url = vopUrl::fout('umc:0','',1)."?mkv=user-getpw&act=emshow&upass=$upass";
			$sys_name = cfg('sys_name'); 
			$mail = new extEmail();
			$subj = lang('usrm_emsubj');
			$data = basLang::inc('uless','userm_empw',array('uname'=>$uname,'sys_name'=>$sys_name,'url'=>$url));
			$re = $mail->send($memail,$subj,$data,$sys_name);
			$re = $re=='SentOK' ? lang('usrm_emtip') : lang('usrm_emeror');
		}else{
			$re = lang('usrm_eremail');
		}
		return $re;
	}	

}



/*******************************************************************************
 File : \code\core\dops\usrPerm.php 
*******************************************************************************/
<?php

// usrPerm : 单独分离出来
class usrPerm{	
	
	// 
	static function issup(){
		$user = usrBase::userObj('Admin');
		return @$user->uperm['grade']=='supper';
	}	
	
	// fix : '';end;full
	//usrPerm::run(array('pcheck,about','padd,about'));
	//usrPerm::run('pfile','admin/groups.php');
	static function run($key,$val='',$fix='end'){
		$msg = self::check($key,$val); 
		if(empty($fix)){
			return $msg;
		}elseif(in_array($fix,array('end','full'))){ 
			if($msg){
				if($fix=='full'){
					glbHtml::page();
					glbHtml::page('body');
				}
				$msg = str_replace('; ',"; <br>\n",$msg);
				$msg = "\n<p class='err'>NO Permission: <br>\n$msg</p>";
				die(glbHtml::page('end',$msg));
			}
		}elseif(in_array($fix,array('js'))){
			return $msg; /// ??? 
		}else{
			return $msg;
		}
	}
	
	// re : str, ''
	static function check($key,$val=''){
		$user = usrBase::userObj();
		if($key=='usess'){ 
			$str = comSession::get(self::getSessid()); 
			$re = strstr($str,$val) ? '' : "$key:$val";
			return $re;		
		}elseif(self::issup()){ 
			return ''; //超级管理员
		}elseif(is_array($key)){
			return self::pmArr($key);
		}else{
			return self::pmOne($key,$val);
		}
	}
	
	// utype,login,model,grade,p*,usess,
	// re: str, ''
	static function pmStr($key){
		$user = usrBase::userObj();
		$re = '';
		if(in_array($key,array('utype','uflag'))){
			$key = str_replace(array('utype','uflag'),array('usertType','userFlag'),$key);
			return $user->$key;
		}elseif(in_array($key,array('model','grade'))){
			return $user->uperm[$key];
		}elseif(substr($key,0,1)=='p' && isset($user->uperm[$key])){
			return $user->uperm[$key];
		}else{
			return '';
		}
	}
	
	// re : str, '', -
	static function pmOne($key,$val){
		if(empty($key) || empty($val)){
			return '-';
		}else{ 
			$str = self::pmStr($key); 
			if($key=='pfile' && $val=='(auto)') $val = basReq::arr('file'); 
			if(strpos($str,$val)){
				return '';
			}else{
				return "$key:$val";
			}
		}
	}
	
	// re : str, ''
	static function pmArr($arr){
		$re = '';
		foreach($arr as $v){
			$a = explode(',',"$v,");
			$rt = self::pmOne($a[0],$a[1]);
			if(!empty($rt)){
				$re .= (empty($re) ? '' : '; ')."$a[0]:$a[1]";
			}
		}
		return $re; 
	}
	
	// 从uperm['cfgs']中取得权限key(s)
	static function pmCfgs($cfgs='',$re='_arr'){
		$cfgs = is_object($cfgs) ? $cfgs->uperm['cfgs'] : (is_array($cfgs) ? $cfgs['cfgs'] : $cfgs);
		$a = basElm::text2arr($cfgs);
		if($re=='_arr'){ 
			return $a; 
		}else{
			return isset($a[$re]) ? $a[$re] : '';
		}	
	}
	
	// 取得Upload权限key(s)
	static function pmUpload($uobj=''){
		if(empty($uobj)){
			$uobj = usrBase::userObj();
		}
		if(@$uobj->uperm['grade']=='supper'){ 
			return array('upsize1'=>'(supper)','uptypes'=>'(supper)',);
		}
		$rcfg = self::pmCfgs($uobj->uperm['cfgs']);
		$rcfg['uptypes'] = array();
		$upex = empty($uobj->uperm['pextra']) ? array() : explode(',',$uobj->uperm['pextra']);
		if(!empty($upex)){
			$tcfg = glbConfig::read('filetype','ex');
			foreach($upex as $k){
				if(isset($tcfg[$k])){
					$rcfg['uptypes'] = array_merge($rcfg['uptypes'],$tcfg[$k]);
				}
			}
		}
		if($rcfg['uptypes']){
			$rcfg['uptypes'] = explode(',','.'.implode(',.',$rcfg['uptypes']));	
		}
		if(empty($rcfg['upsize1'])) $rcfg['upsize1'] = 10; //KB
		if(empty($rcfg['uptypes'])) $rcfg['uptypes'] = array('.gif', '.jpg'); //KB
		return $rcfg;
	}
	
	// type : array('sip'=>$sipck,'sua'=>$ua,'sid'=>$enc)
	static function getUniqueid($mode='Cook',$type='sip'){ //Unique
		$re = comSession::guid('safil','Uniqueid',$mode);
		return $re[$type];
	}
	
	// re : str,
	static function getSessid(){
		$tid = preg_replace("/[^\w]/", '', cfg('safe.safil'));
		return 'pmSessid_'.$tid;
	}
	
}



/*******************************************************************************
 File : \code\core\elib\extCache.php 
*******************************************************************************/
<?php
//缓存类
class extCache{
	protected  $cache = NULL;
	
	function __construct( $config = array()) {
		$cacheDriver = 'cp' . $type;
		require_once(DIR_CODE . '/adpt/cache/' . $cacheDriver . '.class.php');
		$this->cache = new $cacheDriver( $config );
	}

	//读取缓存
	function get($key) {
		return $this->cache->get($key);   
	}
	
	//设置缓存
	function set($key, $value, $expire = 1800) {
		return $this->cache->set($key, $value, $expire);
	}
	
	//自增1
	function inc($key, $value = 1) {
		return $this->cache->inc($key, $value);	
	}
	
	//自减1
	function des($key, $value = 1) {
		return $this->cache->des($key, $value);	
	}
	
	//删除
	function del($key) {
		return $this->cache->del($key);
	}
	
	//清空缓存
	function clear() {
		return $this->cache->clear();	
	}
}


/*******************************************************************************
 File : \code\core\elib\extCron.php 
*******************************************************************************/
<?php

// 计划任务类
 
class extCron{
	
	private $stamp = 0; 
	private $clock = '/store/_cron_lock.txt'; 
	private $rgap = '8m'; //时间间隔：5-10min
	
	private $db = NULL; 
	private $tab = 'bext_cron'; 
	private $jobs = array(); 
	private $jres = array(); 
		
	//function __destory(){  }
	function __construct($file=0,$upd=1){ 
		$this->init($file);
		$this->run();
		$upd && $this->update();
	}
	
	// init
	function init($file=0){
		$this->db = glbDBObj::dbObj();
		$this->stamp = time();
		if($file){
			$this->jobs = $this->db->table($this->tab)->where("kid='$file'")->select();
			return;
		} //print_r($this->jobs);
		if(!tagCache::chkUpd($this->clock,$this->rgap)){
			$this->jobs = $this->db->table($this->tab)->where("(exnext<'".$this->stamp."') AND enable=1")->select();
		}
	}
	
	// 运行列表
	function run(){
		if(!empty($this->jobs)){
			foreach($this->jobs as $row){
				$rdo = $this->rone($row['kid']);
				$next = $this->rnext($row,$rdo);
				$this->jres[$row['kid']] = array(
					'rdo' => $rdo, 
					'next' => $next,
				);
			}
		}
	}
	
	// 运行一个任务
	function rone($file){
		$db = $this->db;
		$stamp = $this->stamp;
		$file = "/adpt/cron/$file.php"; 
		if(file_exists(DIR_CODE.$file)){
			include_once(DIR_CODE.$file);
		}
		return empty($rdo) ? 'fail' : $rdo;
	}
	
	// 计算下次运行时间
	// excunit=w,d,h  excycle=1-127
	function rnext($row,$rdo){
		$cfgs = array(
			'w' => 7*86400,
			'd' => 86400,
			'h' => 3600,
		);
		$cunit = isset($cfgs[$row['excunit']]) ? $cfgs[$row['excunit']] : 30*86400;
		$cycle = intval($row['excycle'])>0 ? intval($row['excycle']) : 12;
		$ctime = $cycle * $cunit; //echo "$ctime = $cycle * $cunit";
		$stfix = date('i')*60 + date('s'); $stfix = $stfix > 1800 ? (3600-$stfix) : ($stfix-3600); //修正整点
		$exsecs = intval(substr($row['exsecs'],0,2))*60 + intval(substr($row['exsecs'],3,2)); 
		$next = $this->stamp + $stfix + $ctime + $exsecs; 
		return $next;
	}
	
	// update
	function update(){
		if(empty($this->jres)) return;
		foreach($this->jres as $file=>$row){
			$data = array('exlast'=>$this->stamp);
			if($row['rdo']=='pass') $data['exnext'] = $row['next'];
			$this->db->table($this->tab)->data($data)->where("kid='$file'")->update(); 
		}
		comFiles::put(DIR_DTMP.$this->clock,date('Y-m-d H:i:s'));
	}

}

/*

UPDATE bext_cron
	SET exnext = CASE kid
		WHEN '1' THEN '3'
		WHEN 2 THEN 4
		WHEN 3 THEN 5
	END,
	exlast = CASE kid
		WHEN 1 THEN '{$this->stamp}'
		WHEN 2 THEN 'New Title 2'
		WHEN 3 THEN 'New Title 3'
	END
WHERE id IN (1,2,3)

$display_order = array(
	1 => 4,
	2 => 1,
	3 => 2,
	4 => 3,
	5 => 9,
	6 => 5,
	7 => 8,
	8 => 9
);
$ids = implode(',', array_keys($display_order));
$sql = "UPDATE categories SET display_order = CASE id ";
foreach ($display_order as $id => $ordinal) {
	$sql .= sprintf("WHEN %d THEN %d ", $id, $ordinal);
}
$sql .= "END WHERE id IN ($ids)";
echo $sql;

*/



/*******************************************************************************
 File : \code\core\elib\extEmail.php 
*******************************************************************************/
<?php

// $m = new extEmail(); 
// $s = 'v01-Mail:'.$_cbase['mail']['type'].' : 邮件 : '.date('Y-m-d H:i');
// $c = comFiles::get('./mail_demo.htm');
// $m->send('xpigeon@163.com',$s,$c,'fromName-测试-Test');

class extEmail{
	
	public $type = ''; //phpmailer,swiftmailer
	public $cfg = array(); //
	public $umail = null;
	public $message = null;
	public $re = '';
	
	function __construct($type='',$cfg=array()){
		$this->cfg  = empty($cfg) ? glbConfig::read('mail','ex') : $cfg;
		$this->type = empty($type) ? $this->cfg['type'] : $type;
		$this->setServer($cfg);		
	}
	
	function setServer($cfg=array()){
		$this->cfg = empty($cfg) ? $this->cfg : $cfg;
		if($this->type=='phpmailer'){
			require_once DIR_VENDOR.'/PHPMailer/PHPMailerAutoload.php';
			$this->umail = new PHPMailer(true); 
			$this->umail->IsSMTP(); 
			$this->umail->CharSet = 'UTF-8'; //设置邮件的字符编码，这很重要，不然中文乱码 
			$this->umail->SMTPAuth = true; //开启认证 
			$this->umail->Host = $this->cfg['smtp']; 
			$this->umail->Port = $this->cfg['port']; 
			$this->umail->Username = $this->cfg['user']; 
			$this->umail->Password = $this->cfg['pass']; 
		}else{
			require_once DIR_VENDOR.'/swiftmailer/swiftmailer/lib/swift_required.php';
			$transport = Swift_SmtpTransport::newInstance($this->cfg['smtp'], $this->cfg['port'])
			  ->setUsername($this->cfg['user']) //注意中转邮箱要和下面的From 邮箱一致
			  ->setPassword($this->cfg['pass']);
			$this->umail = Swift_Mailer::newInstance($transport); 
			#$logger = new Swift_Plugins_Loggers_EchoLogger();
			#$mailer->registerPlugin(new Swift_Plugins_LoggerPlugin($logger)); 
			#$body_str = comFiles::get('./_demo_mailer.htm');
			$this->message = Swift_Message::newInstance(); 
		}
		//$this->umail = &$mail;
	}
	
	function send($to,$subject,$msg,$from=''){
		$re = 'SentOK';
		$from || $from = $this->cfg['from'];
		if($this->type=='phpmailer'){
			try {
				//$this->umail->IsSendmail(); //如果没有sendmail组件就注释掉，否则出现“Could not execute: /var/qmail/bin/sendmail ”的错误提示 
				#$this->umail->AddReplyTo("phpddt1990@163.com","mckee");//回复地址 
				$this->umail->From = $this->cfg['from']; 
				$this->umail->FromName = $from; //"www.txjia.com"; 
				if(strpos($to,',')){
					$toa = explode(',',$to);
					foreach($toa as $to1){
						if(!empty($to1)) $this->umail->AddAddress($to1); 
					}
				}else{
					$this->umail->AddAddress($to); 
				}
				$this->umail->Subject = $subject;
				$this->umail->Body = $msg; 
				#$this->umail->AltBody = "To view the message, please use an HTML compatible email viewer!"; //当邮件不支持html时备用显示，可以省略 
				$this->umail->WordWrap = 80; // 设置每行字符串的长度 
				#$this->umail->AddAttachment("f:/test.png"); //可以添加附件 
				$this->umail->IsHTML(true); 
				$this->umail->Send(); 
			} catch (phpmailerException $e) {
				$re = $e->errorMessage(); //Pretty error messages from PHPMailer
			} catch (Exception $e) {
				$re = $e->getMessage(); //Boring error messages from anything else!
			}
		}else{
			$tos = array();
			if(strpos($to,',')){
				$toa = explode(',',$to);
				foreach($toa as $to1){
					if(!empty($to1)) $tos[$to1] = $to1; 
				}
			}else{
				$tos = array($to => $to); 
			}
			try {
				$this->message
				->setEncoder(Swift_Encoding::get8BitEncoding())
				->setSubject($subject) 
				->setFrom(array($this->cfg['from'] => $from))
				->setTo($tos)
				->setBody($msg, 'text/html');
				#echo "\n<hr>message:<br>"; echo $this->message -> toString();
				$result = $this->umail->send($this->message); 
				#echo "\n<hr>logger:<br>";  echo $logger->dump();
			} catch (Exception $e) { 
				$re = $e->getMessage(); //Boring error messages from anything else!
			}
		}
		return $re;
	}
}

?>


/*******************************************************************************
 File : \code\core\elib\extExcel.php 
*******************************************************************************/
<?php
// 数据导出成Excel文件,暂不支持中文文件名称。尽量生成UTF-8编码的excel（包括从数据库取出来的数据转成UTF-8）,测试时某些WPS版本只支持UTF-8的编码
/* @example 
    $head1 = array('AA1','BB1');
    $data1 = array(array('1a','1ba'),array('1c','1d'));
    $head2 = array('AA2','BB2');
    $data2 = array(array('2a','2bb'),array('2c','2d'));
	$xls = new extExcel($charset); //默认UTF-8编码
	$xls->generateXMLHeader('ExcelName_'.date('Y-md-His',$timestamp));  //excel文件名
    $xls->setTable($head1,$data1);
    $xls->setTable($head2,$data2);
	$xls->generateXMLFoot();
*/

/**
* 导出 XML格式的 Excel 数据
*/
class extExcel{

    // 文档头标签
    private $header = "<?xml version=\"1.0\" encoding=\"%s\"?\>\n<Workbook xmlns=\"urn:schemas-microsoft-com:office:spreadsheet\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns:ss=\"urn:schemas-microsoft-com:office:spreadsheet\" xmlns:html=\"http://www.w3.org/TR/REC-html40\">";
    // 文档尾标签
    private $footer = "</Workbook>";

    // 内容编码
    private $sEncoding;
    // 是否转换特定字段值的类型
    private $bConvertTypes;
    // 生成的Excel内工作簿的个数
    private $cntSheet = 0;

    /** 构造函数
     * @param string $sEncoding 内容编码
     * @param boolean $bConvertTypes 是否转换特定字段值的类型
     */
    function __construct($sEncoding='UTF-8', $bConvertTypes=false){
        $this->bConvertTypes = $bConvertTypes;
        $this->sEncoding = $sEncoding;
    }
    // 
    function setTable($head,$data,$title=''){
        $this->worksheetStart($title);
        $this->setTableHeader($head);  //表字段名
        $this->setTableRows($data); //内容字段
        $this->worksheetEnd();
    }
   
    // 向客户端发送Excel头信息; $fname:文件名称,不能是中文 
    function generateXMLHeader($fname=''){
        $fname = $fname ? preg_replace('/[^aA-zZ0-9\_\-]/', '', $fname) : 'Book-'.date('md-His',time());
        header("Pragma: public");   header("Expires: 0");
        header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
        header("Content-Type: application/force-download");
        header("Content-Type: application/vnd.ms-excel; charset={$this->sEncoding}");
        header("Content-Transfer-Encoding: binary");
        header("Content-Disposition: attachment; filename={$fname}.xls");
        echo stripslashes(sprintf($this->header, $this->sEncoding));
    }
    // 向客户端发送Excel结束标签
    function generateXMLFoot(){
        echo $this->footer;
    }
   
    // 开启工作簿
    function worksheetStart($title=''){
        $this->cntSheet++;
        $title = preg_replace("/[\\\|:|\/|\?|\*|\[|\]]/", "", empty($title) ? 'Sheet'.($this->cntSheet) : $title);
        echo "\n<Worksheet ss:Name=\"" . substr($title, 0, 31) . "\">\n<Table>\n";
    }
    // 结束工作簿
    function worksheetEnd(){
        echo "</Table>\n</Worksheet>\n";
    }
    // 设置表头信息
    function setTableHeader($header=array()){
        echo $this->_parseRow($header);
    }
    // 设置表内行记录数据
    function setTableRows($rows=array()){
        foreach ($rows as $row) echo $this->_parseRow($row);
    }
   
    // 将传人的单行记录数组转换成 xml 标签形式
    private function _parseRow($row=array()){
        $cells = "";
        foreach ($row as $k => $v){
            $type = 'String';
            if ($this->bConvertTypes === true && is_numeric($v))
                $type = 'Number';
            $v = htmlentities($v, ENT_COMPAT, $this->sEncoding);
            $cells .= "<Cell><Data ss:Type=\"$type\">" . $v . "</Data></Cell>\n";
        }
        return "<Row>\n" . $cells . "</Row>\n";
    }

}




/*******************************************************************************
 File : \code\core\elib\extFtp.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(DIR_STATIC.'/ilibs/DeteFtp.cls_php'); 

class extFtp extends DeteFtp{
	
	static function __xxx($text){
		;
	}
	
}

/*
*/



/*******************************************************************************
 File : \code\core\elib\extIPAddr.php 
*******************************************************************************/
<?php

// 获取ip地址的地理位置信息
// $ip = new extIPAddr(); //sina,yodao,1616
// echo "\n<br>".$ip->get('182.96.199.133');

class extIPAddr{
	
	// 默认接口
	private $api = 'sina'; // sina
	private $class = ''; // ipSina
	
	// 配置接口
	function __construct($api='') { 
		$defapi = cfg('ucfg.ipapi', 'cbase', $this->api);
		$this->api = $api ? $api : $defapi; 
		$this->class = 'ip'.ucfirst($this->api);
		$file = DIR_CODE.'/adpt/ipapi/'.$this->class.'.php';
		if(file_exists($file)){
			require_once($file);	
		}else{
			$this->api = 'local';
			$this->class = 'ipLocal';
			require_once(DIR_CODE.'/adpt/ipapi/'.$this->class.'.php');		
		}
	}
	
	// 获取数据
	function addr($ip, $text=1){ 
		//if(empty($ip)) return '';
		//if(is_numeric($ip)) $ip = extIPAddr::long2ip($ip);
		//检查IP地址
		if(!preg_match("/\b(((?!\d\d\d)\d+|1\d\d|2[0-4]\d|25[0-5])(\b|\.)){4}/", $ip)) {
			return 'IP Error';
		}
		//检查内网ip地址  10.0.0.0~10.255.255.255,  172.16.0.0~172.31.255.255,  192.168.0.0~192.168.255.255
		$na = explode('.',$ip);
		if($na[0] == 10 || $na[0] == 127 || ($na[0] == 192 && $na[1] == 168) || ($na[0] == 172 && ($na[1] >= 16 && $na[1] <= 31))){
			return 'LAN'; //Local Area Network
		}
		require_once(DIR_CODE.'/adpt/ipapi/'.$this->class.'.php');
		$ipa = new $this->class();
		if(method_exists($ipa,'getAddr')){ //检查方法...
			$addr = $ipa->getAddr($ip);
		}else{
			$addr = $this->http($ipa->url,$ipa->cset,$ip);
		}
		if($text){
			$addr = $ipa->fill($addr); //各接口分别处理
		}
		return $addr;
	}
	
	// 转化:255.255.255.255=>4294967295
	static function ip2long($ip){ 
		return sprintf("%u", ip2long($ip)); 
	}
	// 转化:4294967295=>255.255.255.255
	static function long2ip($int){ 
		return long2ip($int); 
	}
	
	// Http获取数据
	function http($url, $cset, $ip){
		if(empty($ip)) return '';
		$addr = comHttp::doGet($url.$ip); //获取原始数据
		if(empty($addr)) return ''; 
		$addr = comConvert::autoCSet($addr,$cset,cfg('sys.cset'));
		return $addr;
	}


	// ipParts
	// n : 下标-0开始, pN-前面N部分(1开始), arr-返回数组, N3
	static function ipParts($ip, $n='p3'){
		$ip = trim($ip);
		$ip = str_replace(array(' ',';',','),'',$ip);
		$arr = explode('.',$ip);
		if($n=='arr'){
			return $arr;
		}
		if($n=='N3'){
			$num3 = $arr[0]*65536 + $arr[1]*256 + $arr[2];
			return $num3;
		}
		if(is_int($n) && $n>=0 && $n<count($arr)){
			return $arr[$n];
		}
		if(substr($n,0,1)=='p'){
			$n = substr($n,1);
			$str = '';
			for($i=0;$i<$n;$i++){
				$str = (empty($s)?'':'.').$arr[$i];
			}
			return $str;
		}
		return $ip;
	}

	// isLocal
	static function isLocal($ip, $isIntra=0){
		$local = array(
		    '127.0.0.1',
		    '::1',
		);
		$intra = array(
		    '192',
		    '10.',
		);
		$obj = $isIntra ? $intra : $local; 
		$ip = $isIntra ? substr($ip,0,3) : $local; 
		return in_array($ip,$obj) ? true : false;
	}

	// local,intra,ipv6,in.Code,unknow,
	static function inArea($area='CN', $ip=''){
		$ip || $ip = comSession::getUIP();
		if(self::isLocal($ip,0)) return 'local';
		if(self::isLocal($ip,1)) return 'intra';
		if(strpos("($ip)",':')) return 'ipv6';
		$ip3 = self::ipParts($ip, 'arr');
		$str3 = "$ip3[0].$ip3[1].$ip3[2]";
		$file = DIR_STATIC."/media/iptabs/$area-tab.php";
		include($file);
		if(strpos("($ipsStr)",";$str3;")){
			return "in.$area";
		}
		$num3 = $ip3[0]*65536 + $ip3[1]*256 + $ip3[2];
		$tabs = explode("\n",$ipsTab);
		foreach($tabs as $tmp){
			$tma = explode('~',$tmp);
			if($tma[0]<=$num3 && $num3<=$tma[1]){
				return "in.$area";
			}
		} 
		return 'unknow';
	}
	
}



/*******************************************************************************
 File : \code\core\elib\extJifen.php 
*******************************************************************************/
<?php

// 积分
 
class extJifen{
	
	//private $stamp = 0; 
		
	//function __destory(){  }
	function __construct($file=0,$upd=1){ 
		//$this->init($file);
	}
	
	static function update(){
		$db = glbDBObj::dbObj(); 
		$list = $db->table('bext_paras')->where("pid='jifen_grade'")->order('top')->select();
		$arr = array(); 
		foreach($list as $r){
			$arr[$r['kid']] = array('title'=>$r['title'],'numa'=>$r['numa'],'icon'=>$r['cfgs'],);
		}
		glbConfig::save($arr,'jifen','dset'); 
		return $arr;
	}
	
	static function grade($mark=0,$re='title'){
		$jfcfg = glbConfig::read('jifen','dset'); 
		$jftitle = lang('core.no_rank');
		$jfnow = array('kid'=>'-null-','title'=>$jftitle,'icon'=>'-null-'); 
		foreach($jfcfg as $k=>$v){
			if($v['numa']>=$mark){
				$jftitle = $v['title'];	
				$jfnow = array('kid'=>$k,'title'=>$jftitle,'icon'=>$v['cfgs']);
				return;
			}
		}
		return $re=='arr' ? $jfnow : $jftitle;
	}
	
	// act : add,del
	static function main($mcfg,$act,$msg=''){
		$db = glbDBObj::dbObj(); 
		$key = "cr$act";
		if(empty($mcfg[$key])){
			return;	
		}else{
			$mcfg[$key] = intval($mcfg[$key]);
		}
		// addcr
		$op = $act=='add' ? '+' : '-';
		$sql = "UPDATE ".$db->table('users_uacc',2)." SET ujifen=ujifen{$op}".$mcfg[$key]." WHERE uname='{$mcfg['auser']}'";
		$db->query($sql);
		// logger
		$data = basSql::logData('a');
		$data['kid'] = basKeyid::kidTemp('3.4').basKeyid::kidRand('24',4);
		$data['act'] = $act; 
		$data['uto'] = $mcfg['auser'];
		$data['jifen'] = $mcfg[$key];
		$data['jfmod'] = $mcfg['kid'];
		$data['note'] = $msg ? $msg : "{$mcfg['kid']}:$act";
		$db->table("logs_jifen")->data($data)->insert();
		//echo "<pre>"; print_r($mcfg); print_r($mcfg); die();
	}
	

}

/*

*/



/*******************************************************************************
 File : \code\core\elib\extMkdown.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(DIR_STATIC.'/ilibs/Parsedown.cls_php'); 

class extMkdown extends Parsedown{
	
	static function pdext($text,$mode=1){
		if($mode==1){
			$text = preg_replace("/[\r|\n]{1,2} [\-|\>]{1,2} /"," <br> &nbsp; -> ",$text);	
		}
		$text = self::pdorg($text);
		if($mode==1){
			$text = str_replace(array("<li>\n<p>"),array('<li ><p>● '),$text);
			$text = str_replace(array("<li>"),array('<li>● '),$text);
		}
		return $text;
	}
	
	static function pdorg($text){
		return self::instance()->parse($text);
	}
	
}

/*
+ uuuu
* tttt
 - xxxx
 > yyyy
--------------------------- 
$text = extMkdown::pdext($text);
$text = 'Hello **Parsedown**!';
$result = extMkdown::instance()->parse($text);
echo $result; # prints: <p>Hello <strong>Parsedown</strong>!</p>
*/



/*******************************************************************************
 File : \code\core\elib\extQRcode.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(DIR_STATIC.'/ilibs/QRcodeBase.cls_php'); 

/*
 * PHP QR Code encoder, Version: 1.1.4, Build: 2010100721
 * http://phpqrcode.sourceforge.net/
 * https://sourceforge.net/projects/phpqrcode/
  public static function png($text, $outfile = false, $level = QR_ECLEVEL_L, $size = 3, $margin = 4, $saveandprint=false) 
  public static function text($text, $outfile = false, $level = QR_ECLEVEL_L, $size = 3, $margin = 4) 
  public static function raw($text, $outfile = false, $level = QR_ECLEVEL_L, $size = 3, $margin = 4) 
  
 * 二维码最大容量是1850个大写字母,2710个数字,1108个字节,500多个汉字
  
 */
 
class extQRcode{
	
	public static function show($text, $size=3, $level=1, $margin=4, $type='png', $outfile=false){
		QRcode::$type($text, $outfile, $level, $size, $margin);
	}
}



/*******************************************************************************
 File : \code\core\elib\extQRform.php 
*******************************************************************************/
<?php

// extQRform:扫描二维码 认证表单 --- 警告:安全性有待讨论; 防止垃圾意义不大! 
// 既然图片认证码可识别,那二维码一样可识别,而且识别率更高更准确; 而设别等问题,可以伪造ua与header
// Peace看到如下地址(点登录)，异想天开的到的结果
// http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login

class extQRform{
	
	// cfgs
	private $db = NULL; 
	private $uid = ''; 
	private $mod = ''; 
	private $timeqr = 60;
	private $timeout = 600;
	
	// 配置接口
	function __construct() { 
		global $_cbase;
		$_cbase['run']['isDemo'] = 0;
		$this->db = glbDBObj::dbObj(); 
		$this->db = $this->db->table('pwec_qrcode');
		$uid = comSession::guid('','qr'); $this->uid = $uid['sid']; 
		$this->mod = basReq::val('mod','adm_login'); 
	}
	
	// 
	function qrVstr(){
		$run = cfg('run');
		$stamp = $run['stamp'];
		$uid = $this->uid; $mod = $this->mod;
		$oldata = $this->db->where("uid='$uid' AND mod='$mod'")->order("atime DESC")->find();
		if(!empty($oldata['atime']) && $stamp-$oldata['atime']<$this->timeqr){ 
			die('Time-Frequency');
		}else{
			$oldata = array();	
		}
		if(empty($oldata['sid'])){
			$sid = basKeyid::getYYYYMMDD().basKeyid::getTimer().basKeyid::kidRand('',12);
			$arr = array('mod'=>$mod,'uid'=>$uid,'sid'=>$sid,'stat'=>0,);
			$ext = array('auser'=>$run['userag'],);
			$this->db->data(basReq::in($arr+$ext))->insert();
		}else{
			$sid = $oldata['sid'];
			$stamp = $oldata['stamp'];
		}	
		$check = comConvert::sysEncode("$mod.$sid.$stamp",'',32); //$uid.
		$arr = array();
		foreach(array('uid','sid','check','stamp') as $k){
			$arr[$k] = $$k; 	
		}
		$str = comParse::jsonEncode($arr); 
		return $str;
	}
	
	// 
	function qrVauto(){ 
		$uid = $this->uid; $mod = $this->mod;
		$sid = basReq::val('sid','');
		$oldata = $this->db->where("sid='$sid' AND mod='$mod' AND uid='$uid'")->order("atime DESC")->find();
		if(!empty($oldata['atime']) && $oldata['stat']>0){ 
			$info = ""; 
			foreach(array('sid','mod','uid') as $k) $info .= "<input name='$k' type='hidden' value='".$$k."'>";
			$str = "(isOKStart!{$info}isOKEnd!)";
		}else{
			$str = "[Error!](sid='$sid' AND mod='$mod' AND uid='$uid')";
		}
		return $str;
	}
	// 
	function qrVres(){ 
		$run = cfg('run');
		$uid = $this->uid; $mod = $this->mod;
		$sid = basReq::val('sid','');
		$check = basReq::val('check','');
		$stamp = basReq::val('stamp','');
		$cenc = comConvert::sysEncode("$mod.$sid.$stamp",'',32); 
		$ctime = $run['stamp'];
		$flag = 'OK';
		if($ctime-$stamp>$this->timeout){ //10分钟有效
			$flag = "Error Timeout {$this->timeout}(s)";
		}elseif(!basEnv::isMobile()){
			$flag = 'Error NOT Mobile';
		}elseif($check==$cenc){ 
			$oldata = $this->db->where("sid='$sid' AND mod='$mod'")->order("atime DESC")->find();
			if(empty($oldata)){
				$flag = "Error Check:<br>check=$check<br>cenc=$cenc";
			}elseif($stamp-$oldata['atime']>1800){ 
				$oldata = array();
				$flag = "Error Check:<br>stamp=$stamp<br>atime={$oldata['atime']}"; 
			}else{
				$data = array('stat'=>1,'euser'=>cfg('run.userag')); // eip,etime
				$this->db->data(basReq::in($data))->where("sid='$sid' AND mod='$mod'")->update();
			}
		}else{
			$flag = 'Error Unknow!';
		}
		$arr = array();
		foreach(array('uid','sid','check','stamp','cenc','ctime') as $k){
			$arr[$k] = $$k; 	
		}
		return array($flag,$arr);
	}	
}



/*******************************************************************************
 File : \code\core\elib\extSeo.php 
*******************************************************************************/
<?php

// extSeo类
 
class extSeo{

	function bdLinks($data=''){
		https://www.baidu.com/s?wd=site%3Atxjia.com&pn=10
	}

	public $db = NULL;
	public $tabid = 'bext_paras';
	
	//function __destory(){  }
	function __construct(){ 
		$this->db = glbDBObj::dbObj();
		//$this->bpushCfg();
	}
	
	// 
	function createSmap($job=''){
		$jcfg = $this->db->table($this->tabid)->where("kid='$job'")->find(); //print_r($jcfg);
		$tfcfg = array(
			'daily'=>'Y-m-d','monthly'=>'Y-m','yearly'=>'Y',
			'always'=>'Y-m-d H:i:s','weekly'=>'Y-m-d',
		); 
		$a = basElm::line2arr($jcfg['note'],1,';'); $fdata = ''; 
		foreach($a as $tmp){
			if(empty($tmp)) continue;
			$b = explode(',',$tmp); //cargo,100,chn,monthly,0.7
			if(empty($exd)){
				$exd = new exdBase($b[0]);
			}else{
				$exd->minit($b[0]);	
			}
			$cfg = array('limit'=>$b[1],'order'=>$exd->mkid.':DESC'); //stype,limit(1-500),order(did:ASC),offset
			$data = $exd->odata($cfg,0,''); //print_r($data);
			foreach($data as $row){
				$url = vopUrl::fout("{$b[2]}:{$b[0]}.{$row[$exd->mkid]}",0,1); 
				$title = empty($row['title']) ? (empty($row['company']) ? @$row['mname'] : $row['company']) : $row['title'];
				$istr = $jcfg['cfgs']."\n";
				$istr = str_replace(array("(url)","(title)"),array($url,$title),$istr);
				$tfmt = @$tfcfg[$b[3]]; $stamp = empty($row['etime']) ? @$row['atime'] : $row['etime'];
				$time = $stamp ? date($tfmt,$stamp) : date('Y-m-d');
				$istr = str_replace(array("(freq)","(time)","(priority)"),array(@$b[3],$time,@$b[4]),$istr);
				$fdata .= $istr;
			}
		}
		$fdata && $jcfg['detail'] && $fdata = str_replace(array("(*)"),array($fdata),$jcfg['detail']);
		@mkdir(DIR_HTML."/map", 0777, true);
		$file = DIR_HTML."/map/$job"; //echo $fdata;
		$res = $fdata ? comFiles::put($file,$fdata) : 0;
		return $res;
	}	
	
	// 
	function bpushCfg(){
		if(!empty($this->pcfg)) return $this->pcfg;
		$list = $this->db->table($this->tabid)->where("pid='seo_push'")->order('top')->select(); 
		$data = array(); $d = array(''=>'','title'=>'','detail'=>'','top'=>'888',); //$n = 0; 
		if($list){ foreach($list as $row){
			$data[$row['kid']] = $row;
		}}
		foreach(array('site','token','time') as $k){
			if(empty($data["push_$k"])){
				$this->db->table($this->tabid)->data(array('kid'=>"push_$k",'pid'=>'seo_push',))->insert();
				$data["push_$k"] = array_merge($d,array('kid'=>"push_$k"));
			}
		}
		$this->pcfg = $data;
		return $this->pcfg;
	}
	
	// 
	function bpushRun($job='baidu_push.txt',$text=''){
		if(empty($text)){
			$file = DIR_HTML."/map/$job";
			$data = comFiles::get($file);
			@$updtime = filemtime($file);	
		}else{
			$data = $text;	
		}  
		$urls = str_replace(array(";","\r","\n\n"),"\n",$data);
		$pcfg = $this->bpushCfg(); //echo "($urls):".$this->pcfg['push_token']['detail'];
		if(empty($urls) || empty($this->pcfg['push_token']['detail'])){
			return array('ok'=>0,'msg'=>'Error:Data or API.');	
		}
		$api = "http://data.zz.baidu.com/urls?site=".$this->pcfg['push_site']['detail']."&token=".$this->pcfg['push_token']['detail'];
		// POST
		$header = 'Content-Type:text/plain';
		$restr = comHttp::curlCrawl($api, $urls, 5, $header);
		$rslog = strlen($restr)>180 ? substr($restr,0,150).'...'.substr($restr,strlen($restr)-20) : $restr;
		// 
		@$res = json_decode($restr);
		if(empty($restr) || empty($res)){
			$msg = 'Error:push-Empty';
		}elseif(!empty($res->success)){
			if(empty($text)){
				$this->db->table($this->tabid)->data(array('detail'=>time()))->where("kid='push_time'")->update();
				// 注意更新时间为生成文件的时间。
				comFiles::put($file,''); //清空旧资料
			}
			$msg = lang('push_ok').$rslog;
		}else{
			$msg = lang('push_ng').$rslog;
		}
		basDebug::bugLogs('bpushRun',$msg,'detmp','db');
		$nok = empty($res->success) ? 0 : $res->success;
		return array('nok'=>$nok,'msg'=>$msg);	
	}
	// 
	function bpushSql(){
		$ptime = empty($this->pcfg['push_time']['detail']) ? 0 : $this->pcfg['push_time']['detail'];
		$stamp = time(); //当前时刻
		$sbase = strtotime('2005-12-31'); //更新一个含早的时间:2000年,肯定还没有这些功能...
		if(empty($ptime)){
			$sql = " AND atime<='$stamp'"; 
		}else{
			$sql = " AND atime>='$ptime'"; //当前到上次推送时间
		}
		return $sql;
	}

}

/*

http://zhanzhang.baidu.com/linksubmit/index
http://data.zz.baidu.com/urls?site=www.example.com&token=9IFIpTzdC8rFs1vT

*/




/*******************************************************************************
 File : \code\core\elib\extSms.php 
*******************************************************************************/
<?php

// 手机短信接口类
 
class extSms{

	public  $cfg_mchar = 70; // 一条信息,文字个数(小灵通65个字)
	public  $cfg_mtels = 200; // 一次发送,最多200个手机号码个数
	
	public  $api	   = ''; //api接口类型(提供商)
	public  $smsdo	 = NULL; //api对象
	public  $cfgs	  = array(); //api配置
	
	public  $cnow	  = array('name'=>'-','unit'=>'-'); //now配置
	public  $amap	  = array(); //api列表
	//public  $name	  = ''; //name
	
	//function __destory(){  }
	function __construct(){ 
		require(DIR_CODE."/adpt/smsapi/api_cfgs.php"); // 加载
		$_cfgs = glbConfig::read('sms','ex');
		$api = @$_cfgs['cfg_api'];
		if($api && isset($_apis[$api])){ 
			$this->api = $api;
			$this->cfgs = $_cfgs; 
			$this->cnow = $_apis[$api];
			//$this->name = $this->cnow['name'];
			$class = "sms_$this->api";
			// 统一实例化一个 api对象 // load sms libs
			require(DIR_CODE."/adpt/smsapi/sms_{$this->api}.php"); // 加载
			$this->smsdo = new $class($_cfgs); 
		}
		$this->amap = $_apis;
	}
	
	// 短信接口是否关闭
	function isClosed(){
		if(empty($this->api)){
			return true;
		}else{
			return false;
		} //&&$sms_cfg_api!='(close)'
	}
	
	// 余额查询
	// 结果说明：array(1,1234.5): 成功,余额为1234.5；array(-1,'失败原因'): 
	function getBalance(){ 
		return $this->smsdo->getBalance();	
	}
	
	/** 短信发送，支持短信模版替换，
	 * @param	string	$mobiles 	手机号码,参考sendSMS()
	 * @param	string	$tpl 		支持模版，如：{$subject}{$name}标记
	 * @param	array	$source		替换源：array('subject'=>'hellow corp!','name'=>'peace',)
	 * @param	string	$type 		发送方式/发送身份,参考sendSMS()
	 * @return	array	---		结果数组,参考sendSMS()
	 **/
	function sendTpl($mobiles,$tpl,$source,$limit=1){
		$tpl = str_replace(array("\r\n","\r","\n"),array(' ',' ',' '),$tpl);
		if(preg_match_all('/{\s*(\$[a-zA-Z_]\w*)\s*}/i', $tpl, $matchs)){
			if(!empty($matchs[0])){
				foreach($matchs[0] as $v){
					$k = str_replace(array('{','$','}'),'',$v);
					$val = isset($source[$k]) ? $source[$k] : (isset($GLOBALS[$k]) ? $GLOBALS[$k] : "{\$$k}");
					$tpl = str_replace($v,$val,$tpl);
				}
			}
		}
		return $this->sendSMS($mobiles,$tpl,$limit);
	}
	
	/** 短信发送
	 * @param	string	$mobiles 	手机号码,array/string(英文逗号分开)
	 * @param	string	$content 	255个字符以内
	 * @param	string	$type 		发送方式,发送身份 ：
	 *					scom=默认,普通会员发送,检测余额, 
	 *					sadm=管理员(不检测余额), 
	 *					ctel=手机认证(不检测登陆,每次一个号码,70字以内)
	 *					$uid=会员id(整数),以$uid的用户发送并扣余额,(!!!)调用发送的地方请控制好权限,否则,会扣完$uid的余额
	 * @return	array	---		结果数组,如：array(1,'操作成功'): 
	 **/
	function sendSMS($mobiles,$content,$limit=1){
		$db = glbDBObj::dbObj();
		// 格式化 $mobiles,$content, 
		$atel = $this->telFormat($mobiles);
		$amsg = $this->msgCount($content);
		if(empty($atel)) return array('-2',lang('sms_errtel'));	
		if(empty($amsg[0])) return array('-2',lang('sms_errmsg'));
		$nmsg = count($atel)*$amsg[1];
		// 需扣费计算条数,检查余额
		$balance = $this->smsdo->getBalance(); 
		if((float)$balance[1]<=0){
			$mobiles = implode(',',$atel);
			$this->balanceWarn("--tels:$mobiles\n --cmsg:$content"); //写记录
			return array('-2',lang('sms_charge0'));		
		} //print_r("$limit,$limit<$nmsg");
		if($limit && $limit<$nmsg){
			return array('-2',lang('sms_charged'));	
		}
		// 发送及结果
		if(count($atel)>$this->cfg_mtels){ // 分组发送
			$groups = array_chunk($atel,$this->cfg_mtels);
			$res = array('-2',lang('sms_msenderr'));
			$flag = false; //成功标记
			foreach($groups as $group){ 
				$res_temp = $this->smsdo->sendSMS($group,$content);
				if($res_temp[0]=='1'){ //只要一组发送成功,则都算成功.
					$res = $res_temp;	
				}
			}
		}else{
			$res = $this->smsdo->sendSMS($atel,$content);
		}	
		// 写记录-db
		$stel = implode(',',$atel); 
		if(strlen($stel)>255) $stel = substr($stel,0,240).'...'.substr($stel,strlen($stel)-5,255);
		$data = array( 
			'kid'=>basKeyid::kidTemp(),
			'tel'=>$stel,'msg'=>basReq::in($amsg[0]),
			'res'=>implode(':',$res),'api'=>$this->api,'amount'=>$nmsg,
		);
		$db->table('plus_smsend')->data($data)->insert();
		// 扣钱 for 0test_balance.txt
		if($this->api=='0test' && $res[0]=='1'){
			$this->smsdo->deductingCharge($nmsg);
		}
		return $res;

	}
	
	/** 余额报警检测,余额报警记录
	 * @param	int		$flag 	int/string数字/
	 *					数字,多少小时被修改(记录了余额不足)过,
	 *					flag=str,记录信息内容
	 * @return	NULL	
	 **/
	function balanceWarn($flag){
		$file = "debug/balance_apiwarn.wlog"; 
		comFiles::chkDirs($file,'tmp');
		if(is_numeric($flag)){ //检查文件,多少时间(day)内修改过
			return tagCache::chkUpd("/$file",'24h');
		}else{ 
			$onlineip = cfg('run.userip'); $data = ''; 
			if(file_exists($file)){
				$data = comFiles::get($file);
			}
			$fp = fopen(DIR_DTMP."/$file", 'a');
			$data = date('Y-m-d H:i:s')."^ ".'mname'." ^ $onlineip \n $flag\r\n\r\n$data";
			flock($fp, 2); fwrite($fp, $data); fclose($fp);
		}
	}

	// 电话号码 格式化/过滤
	// 初始的电话号码array/string
	// 格式化并过滤后的电话号码
	function telFormat($tel){
		if(is_string($tel)){
			$tel = str_replace(array("-","("," ",')'),'',$tel);
			$tel = str_replace(array("\r\n","\r","\n",';'),',',$tel);
			$arr = explode(',',$tel);
		}else{
			$arr = $tel;	
		}
		$arr = array_filter($arr);
		$re = array();
		for($i=0;$i<count($arr);$i++){
			//  手机/^1\d{4,10}$/; 95168合法号码/^[1-9]{1}\d{4,10}$/; 0769-12345678小灵通
			if(preg_match('/^\d{5,12}$/',$arr[$i])) $re[] = $arr[$i];
		}
		return $re;	
	}
	// 短信内容 截取/计数
	// param	string	$msg 	初始的短信内容
	// param	int		$slen 	最多截取多少文字
	// return	array	$re		返回array(文字,信息条数,文字个数)
	function msgCount($msg,$slen=255){
		$cset = cfg('sys.cset');
		$cnt = mb_strlen($msg, $cset);
		if($cnt>255){
			$msg = mb_substr($str, 0, 250, $cset); 
			$cnt = 250;
		}
		if($cnt>$this->cfg_mchar){ // >70字
			$ncnt = ceil($cnt/($this->cfg_mchar-3)); //(70-3)个字算一条信息
		}else{
			$ncnt = 1;
		}
		return array($msg,$ncnt,$cnt); 
	}
	
	// 部分接口有此方法
	function chargeUp($charge){
		return $this->smsdo->chargeUp($charge);
	}

}



/*******************************************************************************
 File : \code\core\elib\extSpword.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(DIR_STATIC.'/ilibs/Splitword.cls_php'); 

/* Demo *************************************************************************************
	$str = ''; //保证gbk/gb2312编码，不是请先转化，结果请还原。
	$a_split = new SplitWord();
	$str = preg_replace("/&#?\\w+;/", ',', strip_tags($str));
	$str = $a_split->GetIndexText($a_split->SplitRMM($str),100);
************************************************************************************* ******/

class extSpword extends Splitword{
	
	static function main($str,$len=-1,$cset='utf-8'){
		if(!$str) return '';
		static $a_split;
		if(empty($a_aplit)){
			$a_split = new self();
		}
		$len = $len>0 ? $len*($cset=='utf-8' ? 3 : 2) : $len;
		$str = preg_replace("/&#?\\w+;/", ',', strip_tags($str));
		if(!in_array($cset,array('gb2312','gbk'))) $str = comConvert::autoCSet($str,$cset,'gbk');
		$str = $a_split->GetIndexText($a_split->SplitRMM($str),$len);
		if(!in_array($cset,array('gb2312','gbk'))) $str = comConvert::autoCSet($str,'gbk',$cset);
		return str_replace(' ',',',$str);
	}
	
}



/*******************************************************************************
 File : \code\core\elib\extSubdir.php 
*******************************************************************************/
<?php

// 分站跳转

class extSubdir{

	// list-显示
	static function list($arr,$url='1'){
		glbHtml::page();
		echo "<ur>\n";
		foreach ($arr as $key => $val) {
			echo "<li>";
			if(isset($val['url'])){
				echo "<a href='$val[url]'>$key($val[name])</a>";
			}elseif($url){
				echo "<a href='?$val'>$val</a>"; 
			}else{
				echo "$key = ($val)";
			}
			echo "</li>\n"; 
		}
		echo "</ur>\n";
		glbHtml::page('end');
	}

	// 获得跳转的url
	static function getDurl($uaddr){
        $sites = glbConfig::read('dmsubs','ex'); 
        $def = $sites['_def']; 
        unset($sites['_def']);
        $nkey = $def['site']; //未找到地区时的默认网站
        foreach($sites as $key=>$kname){
            if(strstr($uaddr,$kname)){
                $nkey = $key;
                break;        
            }
        }
        $nurl = "http://$nkey.{$def['domain']}/"; // 组装完整url
        return $nurl;
	}

	// 获得分站数据
	static function getCfgs(){
        $data = array();
        $sites = glbConfig::read('dmsubs','ex'); 
        $def = $sites['_def']; 
        unset($sites['_def']);
        foreach($sites as $key=>$kname){
            $data[$key] = array('name'=>$kname, 'url'=>"http://$key.{$def['domain']}/");
        }
        return $data;
	}

	// 获取ip对应地址
	static function getAddr($userip){
        $sites = glbConfig::read('dmsubs','ex'); 
        $api = $sites['_def']['api']; 
		$ipObj = new extIPAddr($api);
		$addr = $ipObj->addr($userip);
		#echo "$api,$userip,$addr";
        return $addr;
	}

}




/*******************************************************************************
 File : \code\core\elib\extYaml.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(DIR_VENDOR.'/Spyc/Spyc.php'); 


class extYaml extends Spyc{
	// Dumps array to YAML.
	static function adump($array, $indent = false, $wordwrap = false, $no_opening_dashes = false){
		return self::YAMLDump($array, false, false, false);
	}
	// Parses YAML file to array.
	static function fload($file){
		return self::YAMLLoad($file);
	}
	// Parses YAML str to array.
	static function sload($str){
		return self::YAMLLoadString($str);
	}
}


/* Demo *************************************************************************************

$fp_array = DIR_VENDOR.'/Spyc/cfg_array.php';
$fp_yaml = DIR_VENDOR.'/Spyc/cfg_yaml.yaml';

require($fp_array);
$str_yaml = file_get_contents($fp_yaml);

$yaml = extYaml::adump($cfg_array,4,60);
echo "\n[array dump to yaml:]"; basDebug::varShow($yaml);

echo "\n<hr>\n";

$Data = extYaml::fload($fp_yaml);
echo "\n[load yaml_file to array]<pre>"; basDebug::varShow($Data);

echo "\n<hr>\n";

$Data = extYaml::sload($str_yaml);
echo "\n[load yaml_string to array]"; basDebug::varShow($Data);

//************************************************************************************* ******/




/*******************************************************************************
 File : \code\core\elib\extZip.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
// 使用:php_zip.dll

class extZip{
	
	static function __xxx($text){
		;
	}
	
}

/*
*/



/*******************************************************************************
 File : \code\core\elib\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\glib\admAFunc.php 
*******************************************************************************/
<?php

// admAFunc 
class admAFunc{	
	
	static function umcVInit(){
		$db = glbDBObj::dbObj();
		$tabid = 'base_menu'; 
		$mlist = vopTpls::entry('umc');
		$dbcfg = $db->table($tabid)->where("model='mumem'")->order('pid,top,kid')->select();
		$mcfg = array(); 
		foreach($dbcfg as $k=>$v){
			$mcfg[$v['kid']] = $v;
		} //print_r($mcfg);
		foreach($mlist as $key=>$val){
			$mpos = strpos("$key)","-m)");
			$pid = $mpos ? 0 : substr($key,0,strpos($key,"-")).'-m';
			$deep = $mpos ? 1 : 2;
			$fm = array('pid'=>$pid,'enable'=>'1','deep'=>$deep,'note'=>$val,);
			if(isset($mcfg[$key])){
				unset($mcfg[$key]);
				$db->table($tabid)->data(basReq::in($fm))->where("model='mumem' AND kid='$key'")->update();  
			}else{ //echo "\nadd:$key,$pid,$deep, ";
				$fm = array_merge($fm,array('kid'=>$key,'title'=>'','model'=>'mumem','cfgs'=>'','top'=>'888',));
				$db->table($tabid)->data(basReq::in($fm))->insert();
			}
		}
		foreach($mcfg as $key=>$val){
			$db->table($tabid)->where("model='mumem' AND kid='$key'")->delete(); 
		} //print_r($mcfg);
	}
	
	// umcVmods
	
	// 所有[关联模型]为$mod的模型
	static function pmodSuns($mod='',$re='a'){
		$_groups = glbConfig::read('groups'); 
		$a = array(); if(!$mod) return $a;
		foreach($_groups as $k=>$v){
			if($mod==$v['pmod']){
				$a[] = $k;
			}
		}
		return $a;
	}
	// [关联模型]保存
	static function pmodSave($omod,$pmod=''){
		$oldPid = basReq::val('oldPid');
		if($oldPid && $oldPid===$pmod) return;
		if(empty($pmod)){ //取消
			glbDBExt::setOneField($omod,'pid','del');	
		}else{ //关联 drem(pid),demo(cnt_drem)
			$r = array('dbtype'=>'varchar(24)','dbdef'=>'','vreg'=>'0'); 
			glbDBExt::setOneField($omod,'pid','check',$r);	
		}
	}
	
	// modCopy, 
	// $fm:is_del,mod_id,
	// $cid:modid(pro),'',reset
	static function modCopy($mod, $tabid, $fm, $cid=''){
		$_groups = glbConfig::read('groups'); 
		$db = glbDBObj::dbObj();
		$org_arr = array('coms'=>'nrem','docs'=>'news','users'=>'person','types'=>'common','advs'=>'adpic');
		if($fm=='is_del'){
			$fm = $db->table($tabid)->where("kid='$cid'")->find();
			$dcnt = $db->table($tabid)->where("issys='0' AND kid='$cid'")->delete();	
			if($dcnt){ //删除成功...
				if(isset($org_arr[$mod])) glbDBExt::setfieldDemo($cid, "{$mod}_$cid"); 
				if($mod=='docs' && $fm['etab']) glbDBExt::setfieldDemo($cid, "dext_$cid"); 
				@unlink(DIR_DTMP."/modcm/_$cid.cfg.php"); //删除缓存
				if($mod=='docs' || $mod=='advs') $db->table('base_catalog')->where("model='$cid'")->delete();
				if($mod=='users') $db->table('base_grade')->where("model='$cid'")->delete();
			}
			return $dcnt ? lang('admin.aaf_delok') : lang('admin.aaf_errkeep');
		}elseif(is_string($fm) && isset($_groups[$fm]) && is_string($cid) && isset($_groups[$cid])){
			$fm_org = $db->table($tabid)->where("kid='$fm'")->find(); 
			$fm_now = $db->table($tabid)->where("kid='$cid'")->find();
			self::modCopy($mod, $tabid, 'is_del', $cid); //del
			self::modCopy($mod, $tabid, $fm_now, $fm); //copy
			return lang('admin.aaf_resetok');
		}elseif(is_array($fm) && $cid && empty($fm['org_tab'])){ //copy
			$fm_org = $db->table($tabid)->where("kid='$cid'")->find();
			$fm['etab'] = $fm_org['etab'];
			$fm['org_tab'] = "{$mod}_$cid";
			self::modCopy($mod, $tabid, $fm, $cid); //add
			return lang('admin.aaf_copyok');
		}elseif(is_array($fm)){ //add
			$id = basReq::in(@$fm['kid']);
			$org_tab = @$fm['org_tab']; unset($fm['org_tab']);
			$db->table($tabid)->data(basReq::in($fm))->insert();
			if(isset($org_arr[$mod])){
				$org_tab = empty($org_tab) ? "{$mod}_".$org_arr[$mod] : $org_tab;
				glbDBExt::setfieldDemo($id, "{$mod}_$id", $org_tab); 
				if($mod=='docs' && !empty($fm['etab'])){
					glbDBExt::setfieldDemo($id, "dext_$id", str_replace('docs_','dext_',$org_tab)); 	
				}
			}
			return lang('admin.aaf_addok');
		}else{
			return lang('admin.aaf_error');	
		}
		return $msg;
		
	}
		
	// upd config
	static function grpNav($pid,$mod){
		$_groups = glbConfig::read('groups');
		$file = basReq::val('file'); 
		$str = ''; 
		$ggap = ''; $top0 = '1';
		foreach($_groups as $k=>$v){
			if($v['pid']==$pid){ 
				$top1 = substr($v['top'],0,1);
				$str .= (($top0!=$top1)?'<br>':$ggap)."<a href='?mod=$k'>$v[title]</a>";	
				$ggap = ' | '; $top0 = $top1;
			}
		}
		$str = str_replace("?mod=","?file=$file&mod=",$str);
		$str = str_replace("&mod=$mod","&mod=$mod' class='cur",$str); 
		return $str;
	}

	// types,catalog,menus使用
	static function typLay($cfg,$aurl,$pid){ 
		if(empty($pid)){
			return lang('admin.aaf_ttype');
		}else{
			$str = "<a href='".basReq::getURep($aurl[1],'pid','0')."'>".lang('admin.aaf_top')."</a>?";
			$lnk = "<a href='".basReq::getURep($aurl[1],'pid','[k]')."'>[v]</a>";
			$str .= comTypes::getLnks(comTypes::getLays($cfg['i'],$pid),$lnk);
		}
		return $str;
	}
	

}



/*******************************************************************************
 File : \code\core\glib\admPFunc.php 
*******************************************************************************/
<?php

// admPFunc
class admPFunc{	

	// fileNav
	static function modList($pmods,$type='relmod'){	
		$_groups = glbConfig::read('groups'); 
		$a = array(); $pid = '';
		foreach($pmods as $pmod){
		foreach($_groups as $k=>$v){
			if($v['pid']==$pmod){
				if($pid!=$v['pid'] && count($pmods>1)){
					$a["^group^$v[pid]"] = "$v[pid]-{$_groups[$v['pid']]['title']}";
				}
				$a[$k] = "[$k]$v[title]";
				$pid = $v['pid'];
			}
		} }
		return $a;
	}
	
	// fileNav
	static function fileNav($now,$cfg=array()){
		$gap = "<span class='span ph5'>|</span>";
		$_cfg = basLang::ucfg('nava'); 
		if(is_string($cfg) && isset($_cfg[$cfg])) $cfg = $_cfg[$cfg];
		$str = ''; 
		foreach($cfg as $file=>$title){
			$cur = strstr($file,$now) ? "class='cur'" : '';
			if(strpos($file,'root}')){
				$file = str_replace(array('{root}','{$root}',),array(PATH_PROJ,PATH_PROJ,),$file);
			}else{
				$file = "?file=$file";
			}
			$str .= ($str ? $gap : '')."<a href='$file' $cur>$title</a>";	
		}
		return $str;
	}
	
	// fileNav
	static function fileNavTitle($now,$cfg=array()){
		$_cfg = basLang::ucfg('nava'); 
		if(is_string($cfg) && isset($_cfg[$cfg])) $cfg = $_cfg[$cfg];
		foreach($cfg as $file=>$title){
			if(strstr($file,$now)){ 
				return $title;
			}
		}
		return '';
	}

}



/*******************************************************************************
 File : \code\core\glib\admUFunc.php 
*******************************************************************************/
<?php

// UFunc 
class clsUFunc{	
	


}



/*******************************************************************************
 File : \code\core\glib\fldCfgs.php 
*******************************************************************************/
<?php

class fldCfgs{

	// 字段类型
	static function viewTypes(){
		return basLang::ucfg('cfglibs.fcfg_type');
	}
	
	// 字段插件
	static function viewPlugs(){
		return basLang::ucfg('cfglibs.fcfg_plug');		
	}

	// 数据类型
	static function dbTypes(){
		return basLang::ucfg('cfglibs.fcfg_dbtype');		
	}
	
	// 字段认证
	static function regTypes(){
		return basLang::ucfg('cfglibs.fcfg_vreg');	
	}
	
	// 添加参数
	static function addParas(){ 
		return array('type','fmextra','etab','kid','from');
	}
	
	
	
	// -------------------------------------
	
	// 保留字段
	static function setKeeps($key=''){
		$arr_0 = array('info','cfgs','fields','items','catalog','files');
		$arr_n = array_keys(basLang::ucfg('fsystem'));
		$arr_f = glbConfig::read('fkeywd','sy'); 
		return array_merge($arr_0,$arr_n,$arr_f);
	}
	
	// ==================================================================== 
	
	/* 'ename'=>array('title'=>'英文名','etab'=>'0','type'=>'input','enable'=>'0','vmax'=>'96',
		   'vreg'=>'str:2-60','vtip'=>'标题2-60字符','dbtype'=>'varchar','dblen'=>'96','dbdef'=>NULL,),
	// mymap|map|地图^varchar|255|-|str:|2|255 // nul:fix:image // tit:2-60 */
	static function addPick($mod,$re='str'){
		$_groups = glbConfig::read('groups'); 
		$db = glbDBObj::dbObj();
		$mpid = $_groups[$mod]['pid']; //echo $mpid;
		$ademo = self::addDemo('init_docs')+self::addDemo('init_dext')+self::addDemo('init_coms')+self::addDemo('init_users'); 
		$list = $db->table('base_fields')->where("model='$mod'")->select();
		$amods = array(-1); $b = array(); $s = ' &nbsp; '.lang('flow.fc_rftype'); $a = array();
		if($list) foreach($list as $r) $amods[] = $r['kid'];
		foreach($_groups as $k=>$v){ 
		if($v['pid']=='types'){
			if(in_array("type_$k",$amods)) continue;
			$data = "$k|input|winpop|0";
			$s .= " | <a href='#' onclick=\"gf_setDemoField('$data')\" class='span'>$v[title]</a>\r\n";
		}}
		$s .= "<br> &nbsp; ".lang('flow.fc_rffield');
		foreach($ademo as $k=>$v){
			if(in_array($k,$amods)) continue;
			if(!in_array($k,$a)){
				$data = "$k|$v[type]|".@$v['fmextra']."|".@$v['etab'].""; 
				$s .= " | <a href='#' onclick=\"gf_setDemoField('$data')\" class='span'>$v[title]</a>\r\n";
				$a[] = $k;
			}
		}
		return $s;
		//return $re=='str' ? $s : $a;
	}
	// 'exp_t01'=>'扩展参数-text-1', //<a href='#' onclick="gf_setDemoField('t400|input||0')" class='span'>XXXX</a>
	static function addType($mod,$catid){
		$ccfg = glbConfig::read($mod,'_c');
		$flist = basLang::ucfg('fsystem'); 
		$s = ' &nbsp; '.lang('flow.fc_rffield');
		foreach($flist as $k=>$v){
			if(strstr($k,'exp_')){
				$a = explode('-',$v);
				$type = str_replace("checkbox","cbox",$a[1]);
				$data = "$k|$type||0";
				if(isset($ccfg[$catid][$k])){
					$s .= " | <i class='span'>$v</i>\r\n";
				}else{
					$s .= " | <a href='#' onclick=\"gf_setDemoField('$data')\" class='span'>$v</a>\r\n";
				}
			}
		}
		return $s;
	}
	static function addDemo($mod){
		$tmp = glbConfig::read('fdemo','sy');
		return $tmp[$mod];
	
	}
	
	static function getSizeArray($cfg=array()){
		if(empty($cfg['fmsize'])){
			$size = array();
		}elseif(strpos($cfg['fmsize'],'.')){ //news.8
			$size = explode('.',$cfg['fmsize']);
		}else{ //360x8
			$size = explode('x',$cfg['fmsize'].'x');	
		}
		return $size;
	}
	
}


/*******************************************************************************
 File : \code\core\glib\fldEdit.php 
*******************************************************************************/
<?php

class fldEdit{

	//public $cfg = array();
	
	static function fmOrgData($tabid,$mod,$kid,$fm=array(),$catid=''){ 
		$_groups = glbConfig::read('groups'); 
		if(empty($kid)){
			if(!empty($fm['from'])){
				$ademo = fldCfgs::addDemo('init_docs')+fldCfgs::addDemo('init_dext')+fldCfgs::addDemo('init_coms')+fldCfgs::addDemo('init_users');
			}
			$def = array('title'=>'','dbtype'=>'varchar','val'=>'','key'=>''); 
			$from = isset($ademo[$fm['from']]) ? $ademo[$fm['from']] : array();
			if(isset($_groups[$fm['from']])){
				$from['title'] = $_groups[$fm['from']]['title'];
			} //如果键名为字符，且键名相同，数组相加会将最先出现的值作为结果
			$fm = $fm + $from + $def;
		}else{
			$db = glbDBObj::dbObj();
			$cawhr = ($catid) ? "AND catid='$catid'" : ""; //echo $cawhr;
			$fm = $db->table($tabid)->where("model='$mod' AND kid='$kid' $cawhr")->find(); 
		} 
		return $fm;
	}
	
	function __construct($mod,$cfg=array()){ 
		$_groups = glbConfig::read('groups');
		$this->mod = $mod;
		$this->pmod = $_groups[$mod]['pid'];
		$this->ispara = basReq::val('ispara','0');
		$this->cfg = $cfg; 
		$this->type = $cfg['type'];
		$this->fmextra = $cfg['fmextra'];
		$this->etab = empty($cfg['etab']) ? 0 : 1;
	} 
	// iTypeOpts
	function fmTypeOpts(){ 
		$types = fldCfgs::viewTypes();
		$plugs = fldCfgs::viewPlugs(); $plugstr = isset($plugs[$this->fmextra]) ? $plugs[$this->fmextra] : lang('admin.fe_noctrl');
		$etab = empty($this->etab)? lang('admin.fe_mtab') : lang('admin.fe_extab');
		$row  = "\n<select name='fm[type]'	class='w90'><option value='{$this->type}'>".$types[$this->type]."</option></select>";
		$row .= "\n<select name='fm[fmextra]' class='w90'><option value='{$this->fmextra}'>$plugstr</option></select>";
		$row .= "\n<select name='fm[etab]'	class='w90'><option value='{$this->etab}'>$etab</option></select>";
		glbHtml::fmae_row(lang('admin.fe_ftype'),$row);
	}
	
	// iPlusPara
	function fmPlusPara(){ 
		$_groups = glbConfig::read('groups'); 
		$oldval = empty($this->cfg['fmexstr']) ? '' : $this->cfg['fmexstr'];
		if($this->fmextra=='winpop'){
			if(empty($oldval) && isset($_groups[$this->cfg['from']])){
				$oldval = $this->cfg['from'];
				//if(empty($this->cfg['title'])) $this->cfg['title'] = $_groups[$oldval]['title'];
			}	
			$arr = array(); 
			foreach($_groups as $k=>$v){
				if($v['pid']=='types') $arr[$k] = "$k:$v[title]";
			}
			$row = "<select name='fm[fmexstr]' class='w150'>".basElm::setOption($arr,$oldval,lang('admin.fe_wdfrom'))."</select>";
			
		}elseif(in_array($this->fmextra,array('datetm','editor','color'))){ //,'map'
			$msgs = array('datetm'=>lang('admin.fe_tmfmt').':yyyy-M-d H:i:s','editor'=>lang('admin.fe_edtool').':full,exbar','color'=>lang('admin.fe_colorto').':title');
			$row = "<input name='fm[fmexstr]' type='text' value='{$oldval}' class='txt w120' maxlength='120' /> {$msgs[$this->fmextra]}";			
		}else{ // in_array($this->type,array('input','text','hidden'))
			echo "<input name='fm[fmexstr]' type='hidden' value='' />";
			return;	
		}
		glbHtml::fmae_row(lang('admin.fe_ctrlp'),$row);
	}	

	// iParaKeys
	function fmParaKeys(){ 
		if(empty($this->ispara)) return;
		$row = "<input name='fm[key]' type='text' value='{$this->cfg['key']}' class='txt w120' maxlength='24' id='fm[key]' tip='".lang('admin.fe_prfmt')."'/>";
		$row .= " &nbsp; ".lang('admin.fe_prval').": <input name='fm[val]' type='text' value='{$this->cfg['val']}' class='txt w120 disc' maxlength='12' id='fm[val]' disabled='disabled' />";
		glbHtml::fmae_row(lang('admin.fe_prkey'),$row);
	}

	// iKeyName
	function fmKeyName(){ 
		$enable = empty($this->cfg['enable']) ? '0' : '1';
		$top = empty($this->cfg['top']) ? '888' : $this->cfg['top'];
		$kid = empty($this->cfg['kid']) ? '' : $this->cfg['kid'];
		$title = empty($this->cfg['title']) ? '' : $this->cfg['title'];
		$ienable = "<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($enable=='1' ? 'checked' : '')." />"; //<input name='fm_enable' type='hidden' value='$fm[enable]' />
		glbHtml::fmae_row(lang('admin.fe_keyid'),"<input id='fm[kid]' name='fm[kid]' type='text' value='$kid' class='txt w150 disc' readonly /> &nbsp; ".lang('admin.fe_uesable')."$ienable");
		$itop = "<input name='fm[top]' type='text' value='$top' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fe_num25')."' />";
		glbHtml::fmae_row(lang('admin.fe_fname'),"<input id='fm[title]' name='fm[title]' type='text' value='$title' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fe_let212')."' /> &nbsp; ".lang('admin.fe_order')."$itop");
	}
		
	// iDbOpts
	function fmDbOpts(){ 
		if($this->fmextra=='editor'){
			$opts = "<option value='text'>text.(64K)".lang('admin.fe_ltext')."</option>";
			$opts .= "<option value='mediumtext' ".($this->cfg['dbtype']=='mediumtext' ? 'selected' : '').">medium.(16M)".lang('admin.fe_ltext')."</option>";
			$flen = 0;
		}elseif($this->fmextra=='datetm'){
			$opts = "<option value='int'>int.".lang('admin.fe_int')."</option>";
			$flen = 11;
		}elseif(in_array($this->fmextra,array('winpop','map','color'))){ 
			$opts = "<option value='varchar'>varchar.".lang('admin.fe_vchar')."</option>";
		}elseif(in_array($this->type,array('parts','repeat'))){ 
			$opts = "<option value='nodb'>nodb.".lang('admin.fe_nodb')."</option>";
			$flen = 0;
		}elseif(in_array($this->type,array('passwd','file'))){ 
			$opts = "<option value='varchar'>varchar.".lang('admin.fe_vchar')."</option>";
			$flen = 255;
		}elseif(in_array($this->type,array('text'))){ 
			$opts = "<option value='text'>text.(64K)".lang('admin.fe_ltext')."</option>";
			$flen = 0;			
		}else{
			$oldval = empty($this->cfg['dbtype']) ? 'xxxxx' : $this->cfg['dbtype'];
			$dbtypes = fldCfgs::dbTypes(); unset($dbtypes['text'],$dbtypes['mediumtext'],$dbtypes['nodb']);
			$opts = basElm::setOption($dbtypes,$oldval,lang('admin.fe_dbtype'));
		}
		$dblen = isset($flen) ? $flen : (empty($this->cfg['dblen']) ? '0' : $this->cfg['dblen']);
		@$dbdef = strlen($this->cfg['dbdef']) ? $this->cfg['dbdef'] : '';	
		$row = "\n<select name='fm[dbtype]' class='w150' reg='str:1-255'>$opts</select>"; //$dise = "disabled='disabled'";
		$row .= " &nbsp;&nbsp; ".lang('admin.fe_len')."<input name='fm[dblen]' type='text' value='$dblen' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fe_num25')."' id='fm[dblen]'/>";
		$row .= "<br><input name='fm[dbdef]' type='text' value='$dbdef' class='txt w150' maxlength='48' id='fm[dbdef]' />";
		glbHtml::fmae_row(lang('admin.fe_dbdef'),$row);
	}

	// iRegOpts
	function fmRegOpts(){ 	
		$vmax = empty($this->cfg['vmax']) ? '0' : $this->cfg['vmax'];
		$vtip = empty($this->cfg['vtip']) ? '' : $this->cfg['vtip'];
		$vreg = empty($this->cfg['vreg']) ? '' : $this->cfg['vreg'];	
		$fnull = '1'; $vtype = ''; $vmin = '0'; 
		if(!empty($this->cfg['vreg'])){
			$fnull = strstr($this->cfg['vreg'],'nul:') ? 'nul' : '0';
			$vtype = str_replace('nul:','',$this->cfg['vreg']);
			preg_match("/\:(\d+)\-/",$this->cfg['vreg'],$m);
			if(isset($m[1]) && is_numeric($m[1])) $vmin = $m[1];
			 
		}
		if($this->fmextra=='file'){
			$rtypes = array('fix:file'=>lang('admin.fe_file'), 'fix:image'=>lang('admin.fe_pic'),);
		}elseif(in_array($this->cfg['dbtype'],array('float','int'))){ 
			$rtypes = basLang::ucfg('cfglibs.fedit_numtype'); 
		}else{
			$rtypes = fldCfgs::regTypes(); unset($rtypes['fix:file'],$rtypes['fix:image'],$rtypes['n+i'],$rtypes['n-i'],$rtypes['n+d'],$rtypes['n-d']);
		}
		$opts = basElm::setOption($rtypes,$vtype,lang('admin.fe_vtype'));	
		$row = "\n<select name='fm_vtype' id='fm_vtype' class='w90' onChange='gf_setvType()'>$opts</select>";
		$row .= " &nbsp; ".lang('admin.fe_len')."<input name='fm_vlen' type='text' value='$vmin' class='txt w30' maxlength='5' reg='n+i' tip='".lang('admin.fe_minlen')."' id='fm_vlen' />";
		$row .= "-<input name='fm[vmax]' type='text' value='$vmax' class='txt w30' maxlength='5' reg='n+i' tip='".lang('admin.fe_maxlen')."' id='fm[vmax]' />";
		$row .= "<input name='setreg2' type='button' class='btn' value='".lang('admin.fe_set')."' onClick='gf_setvType()' />";
		$row .= "<br><input name='fm[vreg]' type='text' value='$vreg' class='txt w150' maxlength='255' id='fm[vreg]' tip='".lang('admin.fe_vrule')."' /> ".lang('admin.fe_vreg')."";
		$row .= "<br><input name='fm[vtip]' type='text' value='$vtip' class='txt w150' maxlength='255' tip='".lang('admin.fe_vtips')."' />";
		$row .= "\n<select name='fm_null' class='w90' onChange='gf_setvMust(this)'>".basElm::setOption(array('0'=>lang('admin.fe_must'),'nul'=>lang('admin.fe_nomust'),),$fnull,'')."</select>";
		glbHtml::fmae_row(lang('admin.fe_3title'),$row);
	}

	// iViewOpts
	function fmViewOpts(){
		$fmsize = empty($this->cfg['fmsize']) ? '' : $this->cfg['fmsize']; 
		$fmline = @$this->cfg['fmline'];
		$fmtitle = @$this->cfg['fmtitle'];
		$rtip = lang('admin.fe_tipsize');
		$row = "<input name='fm[fmsize]' type='text' value='$fmsize' class='txt w90' maxlength='12' tip='$rtip' />";
		$row .= "\n<select name='fm[fmline]' value='$fmsize' class='w90' tip='".lang('admin.fe_tipline')."'>".basElm::setOption(basLang::ucfg('cfglibs.fedit_vline'),$fmline,'')."</select>";
		$row .= "\n<select name='fm[fmtitle]' value='$fmtitle' class='w90' tip='".lang('admin.fe_tiptitle')."'>".basElm::setOption(basLang::ucfg('cfglibs.fedit_vltitle'),$fmtitle,'')."</select>";
		glbHtml::fmae_row(lang('admin.fe_shsize'),$row);
	}	

	// iRemCfgs
	function fmRemCfgs(){
		$cfgs = empty($this->cfg['cfgs']) ? '' : $this->cfg['cfgs'];
		$note = basLang::inc('uless','fldedit_note');
		glbHtml::fmae_row(lang('admin.fe_selarr'),"<textarea name='fm[cfgs]' rows='5' cols='50' wrap='off'>$cfgs</textarea>");
		glbHtml::fmae_row(lang('admin.fe_note'),"<textarea name='fm_note' rows='5' cols='50' wrap='wrap'>$note</textarea>");
	}

}


/*******************************************************************************
 File : \code\core\glib\fldView.php 
*******************************************************************************/
<?php

// Fields
class fldView{	

	// 认证str
	static function mkpar($mod='',$kid=''){
		$mod = $mod ? $mod : basReq::val('mod');
		$pid = cfg("$mod.pid", 'groups');
		$smod = $mod ? "&mod=$mod" : "&mod=$mod"; 
		$skid = $kid ? "&kid=$kid" : "&kid=".basReq::val(substr($pid,0,1).'id')."";
		return "$smod$skid";
	}
	
	// 认证str
	static function vstr($cfg,$size){
		$vstr = ''; 
		$tmp = explode('(|)',$cfg['vtip'].'(|)');
		$cfg['vtip'] = $tmp[0]; 
		if(!empty($cfg['vmax'])) $vstr .= " maxlength='$cfg[vmax]' ";
		if(!empty($cfg['vreg'])) $vstr .= " reg='$cfg[vreg]' ";
		if(!empty($cfg['vtip'])) $vstr .= " tip='$cfg[vtip]' ";
		if(isset($size[0])){
			$vstr .= " style='width:$size[0]px'; ";
		}
		return array($vstr,$tmp[1]);
	}
	// 编辑器-格式化(um不要格式化的)
	static function iedifmt($val){
		$eid = cfg('sys_editor', 'cbase', 'kind');
		if($eid=='um'){
			return $val;
		}else{
			return basStr::filForm($val);
		}
	}
	// 编辑器
	static function ieditor($k,$cfg,$val,$size,$vstr){ 
		$val = comFiles::revSaveDir($val,1);
		$item = '';	$smk = self::mkpar();
		$sys_editor = cfg('sys_editor');
		$eid = empty($sys_editor) ? 'kind' : $sys_editor;
		echo basJscss::imp("/plus/editor/api_$eid.php?eid=$eid$smk",'','js'); //&lang=
		$size = str_replace('x',',',$cfg['fmsize']); if(empty($size)) $size = '480x120';
		$bsbar = strstr(@$cfg['fmexstr'],'full') ? 'full' : 'base';
		$item = strstr(@$cfg['fmexstr'],'exbar') ? "<div id='fm_{$k}_bar' class='edt_bar'></div>" : '';
		if($eid=='um'){
			$item .= basJscss::imp('/edt_um/themes/default/css/umeditor.css','vui');
			$item .= "<textarea id='fm[$k]' name='fm[$k]' style='display:none;'></textarea>";
			$item .= "<script type='text/plain' id='fm_{$k}_' name='fm[$k]' style='width:{$cfg['fmsize'][0]}px;height:{$cfg['fmsize'][1]}px;'>".@$val."</script>";
		}else{
			$item .= "<textarea id='fm_{$k}_' name='fm[$k]'>".@$val."</textarea>";
		}
		$item .= basJscss::jscode("var editor_fm_{$k}_; edt_Init('fm[$k]','$bsbar',$size);"); 
		return $item;
	}
	// 日期时间
	static function idatetm($k,$cfg,$val,$size,$vstr,$iinp){
		$item = '';	
		echo basJscss::imp('/My97DatePicker/WdatePicker.js','vui'); 
		$fmt1 = empty($cfg['fmexstr']) ? 'Y-m-d' : $cfg['fmexstr'];
		$fmt2 = empty($fmt1) ? '' : ",dateFmt:'".str_replace(array('Y','m','d','H','i','s',),array('yyyy','MM','dd','HH','mm','ss',),$fmt1)."'"; 
		$val = empty($val) ? '' : date($fmt1,$val); 
		$iinp = "<input id='fm[$k]' name='fm[$k]' type='text' value='$val' class='txt' $vstr />";
		$item = "$iinp<span class='fldicon fdate' onClick=\"WdatePicker({el:'fm[$k]'$fmt2})\" /></span>";
		return $item;
	}
	// 类别pop选择
	static function iwinpop($k,$cfg,$val,$size,$vreg){
		global $_cbase; 
		$item = '';	
		$_md = empty($cfg['fmexstr']) ? 'china' : $cfg['fmexstr'];
		$_w = empty($size[0]) ? 420 : $size[0];
		$_n = empty($size[1]) ? 1 : $size[1];
		$_cfg = empty($cfg['cfgs']) ? '' : ",'{".$cfg['cfgs']."}'";
		$item = "<span id='fm_{$k}__pop'>$vreg</span>";
		$_cbase['run']['jtype_mods'] .= ",$_md";
		$_cbase['run']['jtype_init'] .= "var fm_{$k}__obj; popInit('fm[{$k}]','$_md',$_w,$_n,'$val'$_cfg);\n";
		return $item;
	}
	// file
	static function ifile($k,$cfg,$val,$size,$vstr,$mod='',$kid=''){
		$val = comFiles::revSaveDir($val);
		$item = '';	$smk = self::mkpar($mod,$kid);
		$ticon = comFiles::getTIcon($val);
		$id = $jsAct = $simg = '';
		if($ticon['icon']=='pic'){
			$id = $k.'_'.basename($val); $id = str_replace('.','___',str_replace('-','_',$id));
			$jsAct = " onmouseover=\"$('#$id').removeClass('idHidden');$('#$id').addClass('idShow');\" onmouseout=\"$('#$id').removeClass('idShow');$('#$id').addClass('idHidden');\" ";	
			$simg = "<br><span class='idHidden' id='$id'><img src='$val' onload='imgShow(this,360,240)' border='0' /></span>";
		}
		$item .= "<input id='fm_{$k}_' name='fm[{$k}]' type='text' value='$val' class='file' $vstr $jsAct>";
		$item .= "<input type='button' value='".lang('admin.fv_upload')."' onclick=\"winOpen('".PATH_ROOT."/plus/file/upone.php?fid=fm_{$k}_$smk','".lang('admin.fv_upfiles')."',360,120)\">";
		$item .= "<input type='button' value='".lang('admin.fv_view')."' onclick=\"winOpen('".PATH_ROOT."/plus/file/fview.php?fid=fm_{$k}_$smk','".lang('admin.fv_vfiles')."',720,480)\">";
		$item .= "<input type='button' value='".lang('admin.fv_clear')."' onclick=\"$('#fm_{$k}_').val('');\">$simg";
		return $item;
	}
	// pics
	static function ipics($k,$cfg,$val,$size,$vstr,$mod='',$kid=''){
		$val = comFiles::revSaveDir($val);
		$cfg['cfgs'] = empty($cfg['cfgs']) ? '' : basElm::arr2text($cfg['cfgs'],';','|');
		$item = '';	$smk = self::mkpar($mod,$kid);
		$item .= "<div id='fm_{$k}_out' class='mpic_out'>"; 
		$item .= "<div id='fm_{$k}_show'>{$cfg['cfgs']}</div>"; 
		$item .= "<div id='fm_{$k}_tarea' class='clear'><textarea name='fm[$k]' id='fm_{$k}_' style='display:none;'>$val</textarea></div>"; 
		$item .= "<input type='button' value='".lang('admin.fv_upload')."' onclick=\"winOpen('".PATH_ROOT."/plus/file/upbat.php?fid=fm_{$k}_$smk','".lang('admin.fv_upfiles')."',720,560)\">"; 
		$item .= "<input type='button' value='".lang('admin.fv_view')."' onclick=\"winOpen('".PATH_ROOT."/plus/file/fview.php?fid=fm_{$k}_$smk','".lang('admin.fv_vfiles')."',720,560)\">"; 
		$item .= "<input type='button' value='".lang('admin.fv_clear')."' onClick=\"mpic_clear('fm_{$k}_');\">";
		$item .= "</div>"; 
		$jpath = PATH_ROOT."/skin/a_jscss/multpic.js";
		$item .= basJscss::jscode("jQuery.getScript('$jpath',function(){ mpic_minit('fm_{$k}_'); })"); 
		return $item;
	}
	static function ipick($k,$cfg,$val,$size,$vstr,$mod='',$kid=''){
		$pmod = empty($size[0]) ? '' : $size[0];
		$pcnt = empty($size[1]) ? 1 : intval($size[1]);
		$para = "type='checkbox' class='rdcb' checked"; $item = '';
		if($val){
			$arr = explode(',',$val);
			foreach($arr as $v){
				$title = dopFunc::vgetTitle($pmod,$v); 
				$item .= "<span class='ph5'><input name='fm[{$k}][]' onClick='pickMul(this,1)' value='$v' $para />$title</span>";
			}
		}
		$item = "<div id='fm_{$k}_refname'>$item</div><input name='fm_{$k}_modpicks' id='fm_{$k}_modpicks' type='hidden' value='$pmod'>";
		$item .= "<input type='button' value='".lang('admin.fv_pick')."' onclick=\"pickOpen('fm_{$k}_modpicks','','fm[{$k}]','fm_{$k}_refname',$pcnt)\" class='btn'>";  
		// pmod,cnt, $ptitle = dopFunc::vgetTitle($pmod,$val); 
		return $item;
	}

	// fields-公共函数
	// form: item，一项的内容。
	static function fitem($k,$cfg,$vals=array()){
		$_groups = glbConfig::read('groups');
		$size = fldCfgs::getSizeArray($cfg);
		$tmp = self::vstr($cfg,$size); 
		$vstr = $tmp[0]; $vmsg = $tmp[1]; $item = '';
		$val = isset($vals[$k]) ? self::iedifmt($vals[$k]) : (isset($cfg['dbdef']) ? $cfg['dbdef'] : '');
		if($val==='' && !empty($cfg['dbdef'])) $val = $cfg['dbdef'];
		$iinp = "<input id='fm[$k]' name='fm[$k]' type='text' value='$val' class='txt' $vstr />";
		$ihid = "<input id='fm[$k]' name='fm[$k]' type='hidden' value='$val' />";
		$extra = @$cfg['fmextra']; //参考dopBase::chkFields()
		if($extra=='editor'){ //编辑器
			$item = self::ieditor($k,$cfg,$val,$size,$vstr);
		}elseif($extra=='datetm'){ //日期
			$item = self::idatetm($k,$cfg,$val,$size,$vstr,$iinp);
		}elseif($extra=='color'){ //颜色设置
			$_fid = empty($cfg['fmexstr']) ? 'title' : $cfg['fmexstr'];
			$item = "$ihid<span class='fldicon fcolor' onClick=\"colorPick('fm[$k]','fm[$_fid]')\">&nbsp;</span>";
			$item .= "<span id='fm[$k]_pop' class='color_out' style='display:none'></span>";
			if(strlen($val)>2) { $item .= basJscss::jscode("colorSet('$val','$_fid')"); } 
		}elseif($extra=='map'){ //地图
			$sys_map = cfg('sys_map');
			$mpid = empty($sys_map) ? 'baidu' : $sys_map;
			$item = "$iinp<span class='fldicon fmap' onClick=\"mapPick('$mpid','fm[$k]');\">&nbsp;</span>";
		}elseif($extra=='repeat'){ //检查重名 
			$act = "onclick=\"repeatCheck('".str_replace(',',"','",@$cfg['cfgs'])."','$k');\""; ;
			$item = "$ihid <input type='button' value='".lang('admin.fv_chkrep')."' id='fm_repeat_$k' $act class='btn'> ";
		}elseif($extra=='winpop'){ //winpop
			$item = self::iwinpop($k,$cfg,$val,$size,@$cfg['vreg']);
		}elseif($extra=='pics'){ //pics
			$item = self::ipics($k,$cfg,$val,$size,$vstr); 
		}elseif($extra=='pick'){ //pick
			$item = self::ipick($k,$cfg,$val,$size,$vstr); 
		}elseif($cfg['type']=='hidden'){ //隐藏
			$item = $ihid;
		}elseif($cfg['type']=='passwd'){
			$item = "<input id='fm[$k]' name='fm[$k]' type='password' autocomplete='off' class='txt' $vstr />";
		}elseif($cfg['type']=='select' && isset($_groups[@$cfg['cfgs']])){ //类别选择
			$item = comTypes::getOpt($cfg['cfgs'],$val);
			$item = "<select id='fm[$k]' name='fm[$k]' type='text' $vstr >$item</select>";
		}elseif($cfg['type']=='select'){ 
			$item = "<select id='fm[$k]' name='fm[$k]' type='text' $vstr >";
			$item .= basElm::setOption(@$cfg['cfgs'],$val)."</select>"; 
		}elseif($cfg['type']=='cbox'){
			$item = basElm:: setCBox($k,$cfg['cfgs'],$val); 
		}elseif($cfg['type']=='radio'){
			$item = basElm::setRadio($k,$cfg['cfgs'],$val);  
		}elseif($cfg['type']=='text'){
			$rows = empty($size[1]) ? '5' : $size[1];
			$item = "<textarea id='fm[$k]' name='fm[$k]' rows='$rows' class='txt' wrap='off' $vstr/>".$val."</textarea>"; 
		}elseif($cfg['type']=='file'){	
			$item = self::ifile($k,$cfg,$val,$size,$vstr);
		}else{
			$item = $iinp;
		} 
		$item .= $vmsg;
		if(empty($cfg['fmline']) && !empty($cfg['fmtitle'])) $item = $cfg['title'].$item; 
		return $item;
	}
	// form: (增加/修改):字段列表
	// 处理分组等。
	static function lists($mod,$vals=array(),$catid=''){
		global $_cbase;
		if($catid){ 
			$ccfg = glbConfig::read($mod,'_c'); 
			if(empty($ccfg[$catid])) return;
			$mfields = $ccfg[$catid]; 
		}else{
			${"_$mod"} = glbConfig::read($mod); 
			$mfields = ${"_$mod"}['f']; 
		}
		$skip = array('0');
		$_cbase['run']['jtype_mods'] = '';
		$_cbase['run']['jtype_init'] = '';
		foreach($mfields as $k=>$v){ 
			if($v['type']=='parts'){ //(分段字段...)
				echo "<tr><th>$v[title]</th><th class='tr'>$v[vtip]</th></tr>\n";
				continue;
			}elseif(!in_array($k,$skip)){
				$item = self::fitem($k,$v,$vals);
				$item = self::fnext($mfields,$k,$vals,$item,$skip);
				glbHtml::fmae_row($v['title'],$item);
			}
		}
		if(!empty($_cbase['run']['jtype_mods'])){
			$jpath = PATH_ROOT."/plus/ajax/comjs.php?act=jsTypes&mod=".$_cbase['run']['jtype_mods']."";
			echo basJscss::jscode("jQuery.getScript('$jpath',function(){\n".$_cbase['run']['jtype_init']."})"); 
		}	
	}
	// form: next field
	static function fnext($mfields,$k,$vals,$item,&$skip){
		$nkey = basArray::nextKey($mfields,$k);
		if($nkey && (empty($mfields[$nkey]['fmline']) || $mfields[$nkey]['type']=='hidden')){ 
			$item .= "\n".self::fitem($nkey,$mfields[$nkey],$vals);
			$skip[] = $nkey;
			return self::fnext($mfields,$nkey,$vals,$item,$skip);
		}else{
			return $item;
		}
	}
	
	// form: relat : 
	// ::relat("relpb,fm[catid],fm[brand]","fm[xinghao],$mod,$did")
	// ::relat("fm[grade]","fm[ftype],$mod,$uname,fm[grade]"); 
	static function relat($relat,$exchg=''){
		$jcmd = "relInit('".str_replace(",","','",$relat)."');";
		$jchg = "relCatid('".str_replace(",","','",$exchg)."');";
		if(strpos($relat,',')){ //relat+fields
			$tmpa = explode(',',$relat);
			$jpath = PATH_ROOT."/plus/ajax/comjs.php?act=jsRelat&mod=$tmpa[0]";
			$jstr = "\n $jcmd $jchg \$(jsElm.jeID('{$tmpa[1]}')).change(function(){ $jcmd $jchg });";
			$jstr = "jQuery.getScript('$jpath',function(){ {$jstr} })";
		}else{ //fields
			$jstr = "\n $jchg \$(jsElm.jeID('$relat')).change(function(){ $jchg });";
		}
		echo basJscss::jscode($jstr);
	}
}

//jQuery.getScript('/08tools/yssina/1/root/plus/ajax/comjs.php?act=jsRelat&mod=relyc',function(){
//relInit('relyc','fm[ygrade]','fm[course]');
//$(jsElm.jeID('fm[ygrade]')).change(function(){ relInit('relyc','fm[ygrade]','fm[course]'); });
//});



/*******************************************************************************
 File : \code\core\glib\glbConfig.php 
*******************************************************************************/
<?php

// Cache - 读写
class glbConfig{	

	public static $_CACHES_YS = array();//将读取过的缓存暂存可重用
	
	//先检查再读缓存
	static function cread($mod){ 
		$_groups = glbConfig::read('groups'); 
		$mcfg = isset($_groups[$mod]) ? glbConfig::read($mod) : array();
		return $mcfg;
	}

	// 获取自由参数: 
	// part.item.key ('parnav.group_a.title');
	static function parex($keys=''){
		$arr = explode('.',$keys); 
		if(empty($arr[0])) return '';
		$res = self::read("parex_{$arr[0]}",'dset');
		if(!empty($arr[2])){
			return isset($res[$arr[1]][$arr[2]]) ? $res[$arr[1]][$arr[2]] : '';
		}elseif(!empty($arr[1])){
			return isset($res[$arr[1]]) ? $res[$arr[1]] : '';
		}else{
			return $res;
		}
	}

	// read config
	// $_demo = read('demo');
	// $_sy_keepid = glbConfig::read('keepid','sy');
	// $dbcfg = read('db','cfg'); 
	static function read($file,$dir='modcm',$type='inc'){ 
		$modid = $file;
		if(in_array($dir,array('modcm','modex'))){ 
			$key = "_$file";
			$file = "/$dir/".$key.($dir=='modcm' ? ".cfg.php" : "cfg_php");
			$base = DIR_DTMP;
		}elseif(in_array($dir,array('_c'))){ //栏目配置
			$key = "_c_$file"; 
			$file = "/modex/$key.cfg.php";
			$base = DIR_DTMP;
			if(!file_exists(DIR_DTMP.$file)) return array();
		}elseif(in_array($dir,array('cfg'))){
			$key = "_cfg_$file"; $kk = "_cfgs"; 
			$file = "/cfgs/boot/cfg_$file.php";
			$base = DIR_CODE;
		}elseif(in_array($dir,array('dset'))){
			$key = "_$file";
			$file = "/dset/$key.cfg.php";
			$base = DIR_DTMP;
		}elseif(in_array($dir,array('sy','ex'))){
			$key = "_{$dir}_$file";
			$file = "/cfgs".($dir=='sy' ? "/sycfg" : "/excfg")."/".substr($key,1).".php";
			$base = DIR_CODE;
		}elseif(in_array($dir,array('va','vc','ve'))){
			$tpldir = cfg('tpl.tpl_dir');
			$key = "{$tpldir}_$file"; $kk = "_{$dir}_$file"; 
			$file = vopTpls::pinc("_config/{$dir}_$file",'',0); //pcfg("{$dir}_$file",0); 
			$base = DIR_CODE;
		}
		$file = "$base$file"; //echo "$dir,<br>";
		if($type=='inc'){ //返回数组(php用)
			$ck = "{$dir}_$key";
			if(!isset(self::$_CACHES_YS[$ck])){
				if(file_exists($file)){ // inc大文件，其实很占时间
					require($file); 
				}else{ 
					//glbError::show("Cache File[$file] Not Found!"); 
					return array();
				}
				$tmp = self::$_CACHES_YS[$ck] = isset($$kk) ? $$kk : $$key; 
				if(is_array($tmp) && (!empty($tmp['i'])) && is_string($tmp['i'])){
					 self::$_CACHES_YS[$ck]['i'] = self::tmpItems($modid);
				}
			}
			return self::$_CACHES_YS[$ck];
		}elseif($type=='json'){ //返回json(js用)
			require($file); $temp = $$key; // inc大文件，其实很占时间
			if(isset($temp['i'])&&is_string($temp['i'])){
				$file1 = DIR_DTMP."/modcm/$key.cfg.php"; 
				$data = comFiles::get($file1);
			}else{
				$arr = $temp['i'];
				$data = comParse::jsonEncode($arr);
			}
			return "var {$key}_obj = {'cfg':{'title':'$temp[title]','deep':'$temp[deep]'},'i':$data};";
		}else{
			return comFiles::get($file);
		}
	}

	// save config
	static function save($data,$file,$dir='modcm',$type='php'){
		$key = "_$file";
		$file = "$dir/_$file.cfg";
		comFiles::chkDirs($file,'tmp'); 
		$file = "/$file";
		if($type=='php'){
			if(is_array($data)){
				$data = var_export($data,1);
				$data = "\$$key = $data;";
			}
			$data = "<?php\n$data\n?>"; 
			$file .= ".php";
		}else{
			$file .= $type;
		} 
		comFiles::put(DIR_DTMP."$file",$data);
	}
	
	// ~tmp items
	static function tmpItems($mod,$itms=array()){
		$file = "modex/_$mod.cfg_php";
		comFiles::chkDirs($file,'tmp'); 
		$file = DIR_DTMP."/$file";
		if(!empty($itms)){ //save
			$data = comParse::jsonEncode($itms); 
			comFiles::put($file,$data); 
		}else{ //get
			$data = comFiles::get($file); 
	 		$itms = comParse::jsonDecode($data); 
			return $itms;
		}
	}
	
	//返回模型中cfg的数组
	static function mcfg($mod,$re='array'){ 
		$mcfg = self::read($mod);
		if($re=='text') return @$mcfg['cfgs'];
		$cfgs = basElm::text2arr(@$mcfg['cfgs']);
		if($re!='array'){
			return @$cfgs[$re];
		}else{
			return $cfgs;	
		}
	}
	
	//$_vc = vcfg('home'); //'news'
	static function vcfg($mod){ 
		$renull['c']['vmode'] = 'close';
		$tpldir = cfg('tpl.tpl_dir');
		if(empty($tpldir)) return $renull;
		$key = "{$tpldir}_$mod"; //检查缓存
		if(isset(self::$_CACHES_YS[$key])) return self::$_CACHES_YS[$key];
		$_groups = self::read('groups'); 
		if(!file_exists(vopTpls::pinc('_config/va_home'))) return array();
		$hcfgs = self::read('home','va'); 
		if($mod=='home'){ //首页
			$re = $hcfgs;
		}elseif(in_array($mod,$hcfgs['close'])){ //关闭模块
			$re = $renull; 
		}elseif(isset($hcfgs['imcfg'][$mod])){ 
			$re = self::read($hcfgs['imcfg'][$mod],'vc'); //导入模块
		}elseif(in_array($mod,$hcfgs['extra'])){ //扩展模块
			$re = self::read($mod,'ve'); 			
		}elseif(file_exists(vopTpls::pinc("_config/vc_$mod"))){ //常规模块
			$re = self::read($mod,'vc'); 
		}elseif(isset($_groups[$mod]) && $_groups[$mod]['pid']=='docs'){ //默认文档处理,(按va_docs)
			$re = self::read('docs','va');  
		}else{ //没有找到规则-当做关闭
			$re = $renull;	
		} //echo "$mod:"; print_r($re['c']); echo "<br>";
		$re['c']['etr'] = vopTpls::etr1(0,$tpldir);
		if(isset($re['c']['vmode']) && $re['c']['vmode']=='static' && empty($re['c']['stext'])){ 
			$re['c']['stext'] = $hcfgs['c']['stext']; //模块未设置后缀,则继承home的后缀
		}
		self::$_CACHES_YS[$key] = $re;
		return $re;
	}
	
	// $cset = get('sys.cset','cbase');
	// $v1 = get('adpic.pid','groups'); --- 只取一个值时可用这个
	static function get($key='is-arr',$mod,$defval=''){ 
		if($mod=='cbase'){
			global $_cbase; 
			$org = $_cbase;
		}else{
			$org = self::read($mod);
		}
		if($key=='is-arr'){
			return $org;
		}else{
			$re = basArray::get($org,$key);
			return $re ? $re : $defval;
		}
		//return  ? $org : basArray::get($org,$key);
	}
		
}



/*******************************************************************************
 File : \code\core\glib\glbCUpd.php 
*******************************************************************************/
<?php

// glbCUpd
class glbCUpd{	

	public static $_MAX_ITEMS = 72;//最大Item个数,超过用josn

	// upd rebuld
	static function upd_rebuld(){
		self::upd_groups();
		foreach($g1 as $k=>$v){
			if(in_array($k,array('score','sadm','smem','suser',))){ 
				self::upd_paras($k);
			}
			if($v['pid']=='groups') continue;
			//if($v['pid']=='types' && !empty($v['etab'])) continue; 
			self::upd_model($k); 
			self::upd_menus($mod);
		}
	}

	// upd config
	static function upd_groups(){
		$db = glbDBObj::dbObj();
		$grps = $db->table('base_model')->where("enable=1")->order('pid,top,kid')->select(); 
		$str = '';
		foreach($grps as $k=>$v){
			$arr[$v['kid']] = array('pid'=>$v['pid'],'title'=>$v['title'],'top'=>$v['top'],); 
			$arr[$v['kid']]['etab'] = $v['etab']; //'docs','types'
			$arr[$v['kid']]['deep'] = $v['deep']; //'docs','types','menus','advs'
			foreach(array('pmod') as $k){ //'cfgs','pmod','cradd','crdel'
				if(!empty($v[$k])) $arr[$v['kid']][$k] = $v[$k];
			}
		}
		glbConfig::save($arr,'groups');
	}
	
	// upd grade
	static function upd_grade(){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$list = $db->table('base_grade')->where("enable='1'")->order('model,top')->select(); 
		$arr = array();
		foreach($list as $k=>$v){ //print_r($v);
			$v['modname'] = $_groups[$v['model']]['title'];
			$v['grade'] = $v['kid'];
			foreach(array('model','modname','title','cfgs','note','grade') as $k){
				$arr[$v['kid']][$k] = @$v[$k];
			}
			foreach($v as $k2=>$v2){ if(substr($k2,0,1)=='p'){
				$arr[$v['kid']][$k2] = empty($v[$k2]) ? '' : $v[$k2];
			} } 
			self::upd_ipfile($arr[$v['kid']]);
		}
		glbConfig::save($arr,'grade','dset'); 
	}
	
	// upd model
	static function upd_model($mod=0){ 
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		if(empty($mod)) return;
		$v = $db->table('base_model')->where("kid='$mod'")->find(); 
		$arr = array('kid'=>$v['kid'],'pid'=>$v['pid'],'title'=>$v['title'],'enable'=>$v['enable']); 
		$arr['etab'] = $v['etab']; //'docs','types'
		$arr['deep'] = $v['deep']; //'docs','types','menus','advs'
		foreach(array('cfgs','pmod','cradd','crdel') as $k){
			if(!empty($v[$k])) $arr[$k] = $v[$k];
		} 
		if(in_array($v['pid'],array('docs','users','coms','types','score','sadm','smem','suser',))){ //'types',
			$arr['f'] = self::upd_fields($mod);
		}
		if(in_array($v['pid'],array('docs','users'))){ 
			$ccfg = self::upd_cfield($mod);
			if(!empty($ccfg)) glbConfig::save($ccfg,"c_$mod",'modex');
		}
		if(in_array($v['pid'],array('advs','docs','users','types','menus',))){ 
			$_cfg = array('advs'=>'itype','docs'=>'itype','users'=>'iuser','types'=>'itype','menus'=>'imenu');
			$func = 'upd_'.$_cfg[$v['pid']]; 
			$itms = self::$func($mod,$v); 
			if(count($itms)>self::$_MAX_ITEMS){
				glbConfig::tmpItems($mod,$itms);
				$arr['i'] = "$mod"; 
			}else{
				$arr['i'] = $itms; 
			}
			if($v['pid']=='advs'){
				$arr['f'] = self::upd_afield($v);
			}
		}
		if(!empty($v['cfgs'])) $arr['cfgs']=$v['cfgs']; 
		glbConfig::save($arr,$mod);
	}
	static function upd_afield($cfg){ 	
		$f = glbConfig::read('fadvs','sy');
		if($cfg['etab']==1){ unset($f['detail'],$f['mpic']); }
		if($cfg['etab']==2){ unset($f['detail']); }
		if($cfg['etab']==3){ 
			unset($f['mpic']); 
			$f['url']['title'] = lang('core.cupd_reprule');
			$f['url']['vreg'] = '';
			$f['url']['vtip'] = lang('core.msg_eg').'{root}[=]http://txjia.com/<br>'.lang('core.msg_or').'/path/[=]/peace/dev/imcat/root/';
		}
		return $f;
	}		
	// upd fields（考虑继承父级参数?）
	static function upd_cfield($mod=0){
		$db = glbDBObj::dbObj(); $f = array();
		$list = $db->table('bext_fields')->where("model='$mod'")->order('catid,enable DESC,top')->select(); 
		foreach($list as $k=>$v){
		if($v['enable']){
			$cid = $v['kid']; $catid = $v['catid']; 
			foreach($v as $i=>$u){ //kid,top,cfgs
				if(strstr(",title,enable,etab,type,dbtype,dblen,dbdef,vreg,vtip,vmax,fmsize,fmline,fmtitle,",",$i,"))
				$f[$catid][$cid][$i] = $u;
			} 
			if(!empty($v['key'])) $f[$catid][$cid]['key'] = $v['key'];
			if(!empty($v['cfgs'])) $f[$catid][$cid]['cfgs'] = $v['cfgs'];
			if(!empty($v['fmextra'])) $f[$catid][$cid]['fmextra'] = $v['fmextra'];
			if(!empty($v['fmexstr'])) $f[$catid][$cid]['fmexstr'] = $v['fmexstr'];
		}}
		return $f;
	}
	
	// upd fields
	static function upd_fields($mod=0){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		if(isset($_groups[$mod]) && in_array($_groups[$mod]['pid'],array('docs','users','coms','types'))){ 
			$tabid = 'base_fields';
		}else{
			$tabid = 'base_paras';
		}
		$f = array();
		$list = $db->table($tabid)->where("model='$mod'")->order('enable DESC,top')->select(); 
		foreach($list as $k=>$v){
		if($v['enable']){
			$cid = $v['kid'];
			foreach($v as $i=>$u){ //kid,top,cfgs
				if(strstr(",title,enable,etab,type,dbtype,dblen,dbdef,vreg,vtip,vmax,fmsize,fmline,fmtitle,",",$i,"))
				$f[$cid][$i] = $u;
			} 
			if(!empty($v['key'])) $f[$cid]['key'] = $v['key'];
			if(!empty($v['cfgs'])) $f[$cid]['cfgs'] = $v['cfgs'];
			if(!empty($v['fmextra'])) $f[$cid]['fmextra'] = $v['fmextra'];
			if(!empty($v['fmexstr'])) $f[$cid]['fmexstr'] = $v['fmexstr'];
		}}
		return $f;
	}
	
	// upd itype,icatalog
	static function upd_itype($mod,$cfg,$pid=0){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		if(in_array($cfg['pid'],array('docs','advs'))){
			$tabid = 'base_catalog';
		}else{
			$tabid = (empty($cfg['etab']) ? 'types_common' : 'types_'.$mod);
		}
		$arr = array(); 
		$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('top')->select();
		if($list){
		foreach($list as $v){
		  $k = $v['kid']; 
		  if(empty($v['enable'])) continue;
		  foreach($v as $k2=>$v2){
			if(!strstr(',pid,title,deep,frame,char,cfgs,',",$k2,")){
			  unset($v[$k2]); 
			}
		  }
		  if(!empty($v['cfgs'])) $v['cfgs'] = str_replace(array("\n","\r",";;"),array(";",";",";"),$v['cfgs']);
		  $arr[$k] = $v;
		  $find = $db->table($tabid)->where("model='$mod' AND pid='$k'")->find();
		  if($find) $arr += self::upd_itype($mod,$cfg,$k);
		}}
		return $arr;
	}
	// upd iuser
	static function upd_iuser($mod,$cfg,$pid=0){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$tabid = 'base_grade'; //$cfg['pid']=='docs' ? 'base_catalog' : (empty($cfg['etab']) ? 'types_common' : 'types_'.$mod);
		$arr = array(); 
		$list = $db->table($tabid)->where("model='$mod'")->order('top')->select();
		if($list){
		foreach($list as $v){
		  $k = $v['kid']; 
		  if(empty($v['enable'])) continue;
		  foreach($v as $k2=>$v2){
			if(!strstr(',pid,title,',",$k2,")){ //deep,frame,char,
			  unset($v[$k2]); 
			}
		  }
		  if(!empty($v['cfgs'])) $arr[$k]['cfgs'] = $v['cfgs'];
		  $arr[$k] = $v;  
		  //$find = $db->table($tabid)->where("model='$mod' AND pid='$k'")->find();
		  //if($find) $arr += self::upd_itype($mod,$cfg,$k);
		}}
		return $arr;
	}
	// upd imenu
	static function upd_imenu($mod,$cfg,$pid=0){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$tabid = 'base_menu';
		$arr = array(); 
		$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('top')->select();
		if($list){
		foreach($list as $v){
		  $k = $v['kid']; 
		  if(empty($v['enable'])) continue;
		  foreach($v as $k2=>$v2){
			if(!strstr(',pid,title,deep,cfgs,',",$k2,")){
			  unset($v[$k2]); 
			}
		  }
		  $arr[$k] = $v;  
		  $find = $db->table($tabid)->where("model='$mod' AND pid='$k'")->find();
		  if($find) $arr += self::upd_imenu($mod,$cfg,$k);
		}}
		return $arr;
	}
	
	// upd relat
	static function upd_relat(){ 
		$db = glbDBObj::dbObj();
		$list = $db->table('bext_relat')->order('top,kid')->select(); 
		$re = array();
		foreach($list as $r){
			$kid = $r['kid'];
			$re[$kid] = array();
			foreach($r as $k=>$v){
				if(in_array($k,array('mod1','mod2','title','note'))){
					$re[$kid][$k] = $v;
				}
			}
			glbConfig::tmpItems($kid,basElm::text2arr($r['cfgs']));
		}
		glbConfig::tmpItems('relat',$re);
		return $re;
	}
	
	static function upd_paras($pid, $re='save'){ 
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$str = ''; $arr = array();
		foreach($_groups as $k=>$v){ 
			if($v['pid']==$pid){ 
				$cfg = glbConfig::read($k);
				if(empty($cfg['f'])) continue;
				foreach($cfg['f'] as $k2=>$v2){
					$k3 = strstr($v2['key'],'[') ? str_replace(array('[',']'),array("['","']"),$v2['key']) : "['".$v2['key']."']";
					$res = $db->table('base_paras')->where("kid='$k2'")->find();
					$val = str_replace(array('"',"\\"),array("\\\"","\\\\"),$res['val']);
					$str .= "\n\$_cbase$k3 = \"$val\";";
					$arr[$k2] = $res['val'];
				}
				$str .= "\n";
			}	
		} 
		if($re=='save'){
			glbConfig::save($str,$pid,'dset');
		}else{
			return $arr;	
		}
	}
	static function upd_menus($mod,$cfg=array()){ 
		$cfg = glbConfig::read($mod);
		if($mod=='muadm'){ 
			$s0 = ''; $s1 = ''; $js1 = ''; $js2 = '';
			$mperm = array();
			foreach($cfg['i'] as $k1=>$v1){ 
				if(!empty($v1['cfgs']) && strstr($v1['cfgs'],'?file')){
					$mperm[$k1] = self::upd_imperm($v1['cfgs']);
				}
				if($v1['deep']=='1'){
					$s1 .= "<a onclick=\"admSetTab('$k1')\">$v1[title]</a>";
					$js1 .= ",$k1";
					$js2 .= ",$v1[title]";
					$s0 .= "<div id='left_$k1'>";
					if(method_exists('exaFunc',$func="admenu_$k1")){ exaFunc::$func($s0); }
					elseif($k1=='m1adv'){ self::upd_madvs($s0); }
					else{ self::upd_mitms($s0,$cfg,$k1); }
					$s0 .= "</div>";
				}
			}
			$data = "\nvar admNavTab = '$js1';";
			$data .= "\nvar admNavName = '$js2';";
			$data .= "\nvar admHtmTop = '".basJscss::jsShow($s1,0)."';";
			$data .= "\nvar admHtmLeft = '".basJscss::jsShow($s0,0)."';";
			$data .= "\ndocument.write(admHtmTop);";
			glbConfig::save($data,"{$mod}",'dset','.js');
			glbConfig::save($mperm,"{$mod}_perm",'dset'); 
			return $s0;
		}
		
	}
	
	static function upd_madvs(&$s0){ //按栏目显示菜单项
		$_groups = glbConfig::read('groups');
		foreach($_groups as $k2=>$v2){ 
		if($v2['pid']=='advs'){
			$cfg = glbConfig::read($k2);
			$s0 .= "<ul class='adf_mnu2' id='left_$k2'>";
			$s0 .= "<li class='adf_dir'><a href='?file=dops/a&amp;mod=$k2' target='adf_main'>$v2[title]</a></li>";
			foreach($cfg['i'] as $k3=>$v3){ 
			if(empty($v3['pid'])){ //顶级
				$s0 .= "<li id='left_$k3'>";
				$s0 .= "<a href='?file=dops/a&amp;mod=$k2&stype=$k3' target='adf_main'>{$v3['title']}</a> - ";
				$s0 .= "<a onclick=\"admJsClick('$k2')\">".lang('core.msg_add')."</a></li>";
			}}
			$s0 .= "</ul>";
		}}
	}
	static function upd_mitms(&$s0,$cfg,$k1){ //后台配置的菜单项
		foreach($cfg['i'] as $k2=>$v2){ 
		if($v2['pid']==$k1){
			$s0 .= "<ul class='adf_mnu2' id='left_$k2'>";
			$s0 .= "<li class='adf_dir'>$v2[title]</li>";
			foreach($cfg['i'] as $k3=>$v3){ 
			if($v3['pid']==$k2){
				$s0 .= "<li id='left_$k3'>";
				$t = self::upd_mlink($v3);
				$s0 .= "$t</li>";
			}}
			$s0 .= "</ul>";
		}}
	}
	static function upd_mlink($v3){ //处理一项链接
		$t = str_replace(array('{root}','{$root}',),array(PATH_PROJ,PATH_PROJ,),$v3['cfgs']);
		if(strstr($t,'</a>')){
			if(!strstr($t,'target=')){
				$t = str_replace("<a","<a target='adf_main'",$t);
			}
		}elseif(strstr($t,'(!)')){ //站点介绍(!)?file=dops/a&mod=about(!)frame|blank|jsadd
			$ta = basElm::line2arr($t); $t = '';
			foreach($ta as $row){
				$tb = explode("(!)","$row(!)(!)");
				if(strstr($tb[2],'frame')){
					$t .= (empty($t) ? '' : ' - ')."<a href='$tb[1]&frame=1' target='_blank'>$tb[0]</a>";
				}elseif(strstr($tb[2],'blank')){
					$t .= (empty($t) ? '' : ' - ')."<a href='$tb[1]' target='_blank'>$tb[0]</a>";
				}elseif(strstr($tb[2],'jsadd')){
					$t .= (empty($t) ? '' : ' - ')."<a onClick=\"admJsClick('{$tb[1]}')\">$tb[0]</a>";
				}else{
					$t .= (empty($t) ? '' : ' - ')."<a href='$tb[1]' target='adf_main'>$tb[0]</a>";	
				}
			} 
		}else{
			$t = "<a href='$t' target='adf_main'>$v3[title]</a>";
		}
		return $t;
	}
	static function upd_imperm($cfgs){
		preg_match_all("/\?file=([\w|\/]{5,36})/i",$cfgs,$ma);
		if(!empty($ma[1])){
			$rea = array_unique($ma[1]);
			$re = implode(',',$rea);
		}
		return $re;
	}
	static function upd_ipfile(&$icfg){
		static $_mpm;
		if(empty($_mpm)){
			$_mpm = glbConfig::read('muadm_perm','dset'); 
		}
		$pmadm =  $icfg['pmadm']; 
		$pfile = ",{$icfg['pfile']}";
		$a = explode(',',$pmadm); //echo "$pfile,$pmadm";
		if(!empty($a)){
			foreach($a as $k){
				if(!empty($_mpm[$k]) && !strstr($pfile,$_mpm[$k])) $pfile .= ",$_mpm[$k]";
			}
		}
		$icfg['pfile'] = str_replace(array(',,,',',,'),',',"$pfile,");
	}
	
}



/*******************************************************************************
 File : \code\core\glib\glbDBCache.php 
*******************************************************************************/
<?php
//数据库-缓存类
class glbDBCache extends glbDBObj{

	public $cache = NULL; // 缓存对象

	function __construct($config=array()){
		parent::__construct($paras); 
	}

	//执行原生sql语句，如果sql是查询语句，返回二维数组
	function query($sql,$func=''){ 
		if(empty($sql)) return false;
		$this->sql=$sql;
		//判断当前的sql是否是查询语句
		if($func){
			return parent::($sql,$func)
		}elseif(strpos(trim(strtolower($sql)),'select')===0){ 
			$data=array();
			//读取缓存
			$data=$this->_dcGet('query');
			if(!empty($data)){ return $data; }
			//没有缓存，则查询数据库
			$this->connect();
			$data = $this->db->arr($this->sql);
			$this->runTimer('qSelect');
			$this->_dcPut($data,'query');//写入缓存
			return $data;
		}else{ //不是查询条件，执行之后，直接返回
			return parent::($sql,$func);
		}
	}

	//统计行数
	function count(){ // SELECT $func($field) AS $field FROM $tab WHERE kid='$job'
		$table=$this->options['table'];//当前表
		$field='count(*)';//查询的字段
		$where=$this->_parseCond();//条件
		$this->sql="SELECT $field FROM $table $where";
		$data="";
		//读取缓存
		$data=$this->_dcGet('count');
		if(!empty($data)){ return $data; }
		$this->connect();			
		$data['count(*)'] = $this->db->val($this->sql);
		$this->runTimer('count');
		$this->_dcPut($data['count(*)'],'count');//写入缓存
		return $data['count(*)'];
	}

	//只查询一条信息，返回一维数组	
	function find(){
		$table=$this->options['table'];//当前表
		$field=$this->options['field'];//查询的字段
		$this->options['limit']=1;//限制只查询一条数据
		$where=$this->_parseCond();//条件
		$this->options['field']='*';//设置下一次查询时，字段的默认值
		$this->sql="SELECT $field FROM $table $where";
		$data="";
		//读取缓存
		$data=$this->_dcGet('find');
		if(!empty($data)){ return $data; }
		$this->connect();
		$data = $this->db->row($this->sql);
		$this->runTimer('find');
		$this->_dcPut($data,'find');//写入缓存
		return $data;
	 }

	//查询多条信息，返回数组
	function select(){
		$table=$this->options['table'];//当前表
		$field=$this->options['field'];//查询的字段
		$where=$this->_parseCond();//条件
		$this->options['field']='*';//设置下一次查询时，字段的默认值
		$this->sql="SELECT $field FROM $table $where";
		$data=array();
		//读取缓存
		$data=$this->_dcGet('select');
		if(!empty($data)){ return $data; }
		//没有缓存，则查询数据库
		$this->connect();
		$data = $this->db->arr($this->sql);
		$this->runTimer('select');
		$this->_dcPut($data,'select');//写入缓存
		return $data;
	 }
	
	//初始化缓存类，如果开启缓存，则加载缓存类并实例化
	function _dcInit(){		
		if(is_object($this->cache)){
			return true;
		}elseif($this->config['dc_type']){
			require_once(DIR_CODE.'/adpt/cache/extCache.php');
			$config['DATA_CACHE_PATH']=DIR_DTMP.$this->config['dc_path'].'/';
			$config['DATA_CACHE_TIME']=$this->config['dc_tmout'];
			$config['DATA_CACHE_CHECK']=$this->config['dc_check'];		
			$config['DATA_CACHE_FILE']=$this->config['dc_file'];
			$config['DATA_CACHE_SIZE']=$this->config['dc_size'];
			$config['DATA_CACHE_FLOCK']=$this->config['dc_flock'];
			$this->cache=new extCache($config);
			return true;
		}else{
			return false;
		}
	}
	//读取缓存
	function _dcGet($cpre){
		$expire=isset($this->options['cache'])?$this->options['cache']:$this->config['dc_tmout'];
		//缓存时间为0，不读取缓存
		if($expire==0) return false;
		$data = "";	
		if($this->_dcInit()){
			 $data=$this->cache->get(md5($cpre.$this->sql));
		}
		if(!empty($data)){
			unset($this->options['cache']);
			return $data;
		}else{
			return "";
		}

	}
	//写入缓存
	private function _dcPut($data,$cpre){	
		$expire=isset($this->options['cache'])?$this->options['cache']:$this->config['dc_tmout'];
		unset($this->options['cache']);
		//缓存时间为0，不读取缓存
		if($expire==0) return false;
		if($this->_dcInit()){	
			return $this->cache->set(md5($cpre.$this->sql),$data,$expire);	
		}
		return false;	
	}

}



/*******************************************************************************
 File : \code\core\glib\glbDBExt.php 
*******************************************************************************/
<?php

// DBExt
class glbDBExt{	
	
	// 字段 - 添加/删除/修改 
	static function setOneField($mod,$cid,$act='del',$cfg=array()){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$tabf = 'base_fields';
		$r = $db->table($tabf)->where("model='$mod' AND kid='$cid'")->find();
		if($r['dbtype']=='nodb') return; 
		$tabid = self::getTable($mod,$r['etab']);
		$cols = $db->fields($tabid); //echo "$mod,$cid,$act";
		if($act=='del'){
			if(isset($cols[$cid])) $db->query("ALTER TABLE $db->pre{$tabid}$db->ext DROP `$cid` ");
			$db->table($tabf)->where("model='$mod' AND kid='$cid'")->delete(); 	
		}else{
			$sql = "ALTER TABLE $db->pre{$tabid}$db->ext";
			if(isset($cols[$cid])) $sql.= " CHANGE `$cid` ";
			else				   $sql.= " ADD ";	 
			if(empty($r) && !empty($cfg)) $r = $cfg;
			$sql.= " `$cid` $r[dbtype]".($r['dbtype']=='varchar' ? "($r[dblen])" : ''); 
			$sql.= (strpos("($r[vreg]",'nul:') ? " NULL " : ' NOT NULL '); 
			$sql.= (empty($r['dbdef']) ? "" : " DEFAULT '$r[dbdef]' "); 
			$after = self::findAfterField($cols,$cid);
			if(!isset($cols[$cid])) $after && $sql.= " AFTER `$after` ";
			$db->query($sql);
		}
	}
	
	// tab下-添加字段，在什么字段后面
	static function findAfterField($tab,$col){
		$_groups = glbConfig::read('groups');
		$a = is_array($tab) ? $tab : $db->fields($tab);
		if(isset($_groups[$col]) && $_groups[$col]['pid']=='types' && isset($a['catid'])){
			$def = 'catid';
		}else{
			$def = ''; $bak = ''; //print_r($a);
			foreach($a as $k=>$v){
				if($k=='aip'){ 
					$def = empty($bak) ? 'aip' : $bak;
					break;
				}
				if(substr("$k)))",0,3)==substr("$col)))",0,3)){
					$def = $k;
				}
				$bak = $k;
			}
		}
		return $def;
	}
	
	static function setfieldDemo($mod,$obj,$org='(drop)'){
		$db = glbDBObj::dbObj();
		if($org=='(drop)'){
			$db->query("DROP TABLE IF EXISTS $db->pre{$obj}$db->ext ");
			$db->table('base_fields')->where("model='$mod'")->delete(); 
		}else{ 
			$_ta = explode('_',$org);
			$obj && $db->query("CREATE TABLE IF NOT EXISTS $db->pre{$obj}$db->ext LIKE $db->pre{$org}$db->ext");
			if(in_array($_ta[0],array('coms','docs','users'))){ //增加默认字段配置'dext',
				$pid = $_ta[1]; 
				$_cfg = glbConfig::read($pid);
				$farr = @$_cfg['f']; 
				$top = 120; 
				if($farr){ foreach($farr as $k=>$v){
					$tabid = 'base_fields';
					if(!$db->table($tabid)->where("kid='$k' AND model='$mod'")->find()){
						$fm = array('kid'=>$k,'model'=>$mod,'top'=>$top,)+$v; 
						$db->table($tabid)->data($fm)->insert();
					}
					$top += 4; 
				} }
			}
		}
	}
	
	/* *****************************************************************************
	  *** 数据库相关函数 
	- db前缀
	- by Peace(XieYS) 2012-07-23
	落伍 - 今日: 20,375 |昨日: 60,851 |帖子: 44,262,754 |会员: 892,782
	4(0001~9999)   + (A001~YYYY)   + (00000~YYYYY)   =  10K + 700K + 32-1)M
	5(00001~99999) + (A0001~YYYYY) + (000000~YYYYYY) = 100K +  22M + 1000)M
	***************************************************************************** */
	// db, tab, n; $tmp(4,6,3.4,5.6)
	// y,m,d: 2013-md01 / 2013m-dh001 / 2013-md-h001
	static function dbAutID($tab='utest_keyid',$fix='yyyy-md-',$tmp='6',$key='',$n=0){
		$db = glbDBObj::dbObj();
		$kno = 0;
		$tfix = substr($tab,0,5); 
		if(in_array($tfix,array('docs_','coms_','advs_','users'))){
			$tkey = substr($tfix,0,1).'id';
			$tno = substr($tfix,0,1).'no';
		}else{
			$tkey = 'kid'; 
			$tno = 'kno';
		}
		$cid = $tno; 
		$tmpbak = $tmp;
		if(strpos('(,6,7,3.4,4.5,5.6,)',",$tmp,")){ 
			$kid = basKeyid::kidTemp($tmp);
		}elseif($key){ //echo "c.$key:";
			$len = $n>10 ? strlen($n)-1+2 : 2;
			$kno = substr($key,8,3).basKeyid::kidRand('',$len);  
			$kid = substr($key,0,8).$kno; 
		}else{ //4,5,22,23,32,12,13,14,
			if(strpos('(,22,23,31,32,)',",$tmp,")){
				$ktmp = in_array($tmp,array('31','32')) ? basKeyid::kidTemp('hms') : basKeyid::kidTemp('hm');
				$tmp = substr($tmp,1,1);
			}elseif(strpos('(,13,14,)',",$tmp,")){
				$ktmp = basKeyid::kidTemp('h');
				$tmp = substr($tmp,1,1);
			}else{ // 2013-md
				$ktmp = basKeyid::kidTemp('0').'-';
			}
			$tabf = $db->pre.$tab.$db->ext;
			$mdb = $db->query("SELECT max($tno) as $tno FROM $tabf WHERE $tkey like '$ktmp%'"); 
			$min = str_repeat('0',$tmp-1).'1'; 
			if(empty($mdb[0][$tno])){ 
				$max = $min; 
			}else{
				$max = $mdb[0][$tno]; 
				$max = basKeyid::kidNext('',$max,$min,1,8);
			}
			$kid = $ktmp.$max; 
			$kno = $max; 
		}
		$rec = $db->table($tab)->where("$tkey LIKE '$kid%'")->find(); 
		if($rec) return self::dbAutID($tab,$fix,$tmpbak,$kid,$n+1);	
		else return array($kid,$kno);
	}

	static function dbNxtID($tab,$mod,$pid=0){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$fix = substr($mod,0,1);
		if($pid){
			$cfg = glbConfig::read($mod); 
			$fix .= ($cfg['i'][$pid]['deep']+1);
		}else{ $fix .= "1"; }
		$sqlm = $tab=='bext_relat' ? '' : ($tab=='base_model' ? 'pid' : 'model')."='$mod' AND ";
		$re = $db->table($tab)->where("$sqlm kid REGEXP ('^{$fix}[0-9]{3}$')")->order('kid DESC')->find();
		if($re){
			$nid = substr($re['kid'],2);
			$nid = basKeyid::kidNext('',$nid,'012',2,3);
		}else{
			$nid = '012';
		}
		return $fix.$nid;
	}
	
	static function getTable($mod,$ext=0){ 
		$_groups = glbConfig::read('groups');
		if(!isset($_groups[$mod])) return '';
		if($_groups[$mod]['pid']=='docs'){
			$tabid = $ext ? 'dext_'.$mod : 'docs_'.$mod;
		}elseif($_groups[$mod]['pid']=='users'){
			$tabid = 'users_'.$mod;
		}elseif($_groups[$mod]['pid']=='advs'){
			$tabid = 'advs_'.$mod;
		}elseif($_groups[$mod]['pid']=='coms'){	
			$tabid = 'coms_'.$mod;
		}elseif($_groups[$mod]['pid']=='types'){	
			$tabid = empty($_groups[$mod]['etab']) ? 'types_common' : 'types_'.$mod;
		}else{
			$tabid = '';	
		}
		return $tabid;
	}
	
	static function getKeyid($mod){ 
		$_groups = glbConfig::read('groups');
		if($_groups[$mod]['pid']=='docs'){
			$keyid = 'did';
		}elseif($_groups[$mod]['pid']=='users'){
			$keyid = 'uid';
		}elseif($_groups[$mod]['pid']=='advs'){
			$keyid = 'aid';
		}elseif($_groups[$mod]['pid']=='coms'){	
			$keyid = 'cid';
		}elseif($_groups[$mod]['pid']=='types'){	
			$keyid = 'kid';
		}
		return $keyid;
	}
	
	static function getKids($mod,$kid='',$whr='',$ret='sub'){
		$db = glbDBObj::dbObj(); 
		$tabid = self::getTable($mod); 
		$kid = $kid ? basStr::filKey($kid,'_-.') : self::getKeyid($mod); 
		$list = $db->table($tabid)->field($kid)->where($whr)->select();
		$re = array();
		if($list){
		foreach($list as $r){
			$re[] = $r[$kid];
		} }
		if(empty($re)){
			$re[] = '(null)';	
		}
		if($ret=='sub'){
			$re = "'".implode("','",$re)."'";
		}
		return $re;
	}
	
	static function dbComment($tabid='~return~'){ 
		static $dbdict,$fmod,$fdemo;
		$db = glbDBObj::dbObj();
		$fsystem = basLang::ucfg('fsystem');
		if(empty($dbdict)){
			$dict = $db->table('bext_dbdict')->field("kid,tabid,title")->select();
			foreach($dict as $v){
				$dbdict[$v['tabid']][$v['kid']] = $v['title'];
			}
		}
		if(empty($fmod)){
			$dict = $db->table('base_fields')->field("kid,model,title")->select();
			foreach($dict as $v){
				$fmod[$v['model']][$v['kid']] = $v['title'];
			}
		}	
		if(empty($fdemo)){
			$fdemo = array();
			$demo = glbConfig::read('fdemo','sy');
			foreach(array('init_users','init_coms','init_dext','init_docs',) as $part){
				$fpart = $demo[$part];
				foreach($fpart as $f=>$v){
					$fdemo[$f] = $v['title'];
			} }
		}
		if($tabid=='~return~') return array('fsystem'=>$fsystem,'fdemo'=>$fdemo,);
		$fields = $db->fields($tabid);
		$moda = explode('_',$tabid); 
		$modid = $moda[1];
		foreach($fields as $f=>$v){
			$flag = 'def'; $rem = '';
			if(isset($fmod[$modid][$f])){ //模型设置
				$flag = 'mod';
				$rem = $fmod[$modid][$f];
			}elseif(empty($dbdict[$tabid][$f])){ //dbdict为空
				if(isset($fdemo[$f])){
					$flag = 'demo';
					$rem = $fdemo[$f];
				}
				if(isset($fsystem[$f])){
					$flag = 'sys';
					$rem = $fsystem[$f];
				}
			}else{ //dbdict设置
				$rem = $dbdict[$tabid][$f];	
				if(isset($fsystem[$f]) || in_array($moda[0],array('active','advs','base','bext','logs'))){
					$flag = 'sys';
				}
			}
			$fields[$f]['_flag'] = $flag;
			$fields[$f]['_rem'] = basStr::filSafe4($rem);
		}
		$_groups = glbConfig::read('groups');
		if(isset($_groups[$modid]) && $_groups[$modid]['pid']==$moda[0]){
			$fields[0]['_flag'] = 'sys'; 
			$cfg = basLang::ucfg('cfglibs.dbext');
			$fields[0]['_rem'] = $_groups[$modid]['title'].('['.$cfg[$moda[0]].']').lang('dbdict_tab');
		}
		if(isset($_groups[$modid]) && $moda[0]=='dext'){
			$fields[0]['_flag'] = 'sys';
			$fields[0]['_rem'] = $_groups[$modid]['title'].lang('dbdict_extab');
		}
		if(isset($fsystem['_stabs'][$tabid])){
			$fields[0]['_flag'] = 'sys';
			$fields[0]['_rem'] = $fsystem['_stabs'][$tabid];
		}
		if(empty($fields[0]['_rem'])&& !empty($dbdict[$tabid][0])){
			$fields[0]['_flag'] = '';
			$fields[0]['_rem'] = $dbdict[$tabid][0];
		}
		return $fields;
	}
	
	static function getExtp($type){ 
		$db = glbDBObj::dbObj();
		$data = array();
		$whr = strpos($type,'%') ? " LIKE '$type'" : "='$type'";
		$list = $db->table('bext_paras')->where("pid$whr AND enable=1")->order('top')->limit(99)->select();
		if($list){ foreach($list as $i=>$r){ 
			$r['i'] = $i+1;
			foreach(array('aip','atime','auser','eip','etime','euser','cfgs','note','enable') as $k2){
				unset($r[$k2]);
			}
			$data[$r['kid']] = $r;
		} } 
		return $data;
	}

}



/*******************************************************************************
 File : \code\core\glib\glbDBObj.php 
*******************************************************************************/
<?php

//数据库操作类，加载了外部的数据库驱动类

class glbDBObj{

	public $db = NULL; // 当前数据库操作对象
	public $config = array();
	public $class = '';
	public $sql = '';//sql语句，主要用于输出构造成的sql语句
	public $pre = '';//表前缀，主要用于在其他地方获取表前缀
	public $ext = '';//表后缀，主要用于在其他地方获取表后缀
	private $data = array();// 数据信息  
	private $nolog = array(
		'active_admin', 'active_online', 'active_session',
		'logs_dbsql', 'logs_detmp', 'logs_jifen', 'logs_syact',
		'wex_qrcode', 'wex_msgget', 'ex_locate',
	);
	private $options = array(); // 查询表达式参数
	static $uobj = array(); //实例化的前数据对象

	function __construct($config=array()){
		$this->config = empty($config) ? glbConfig::read('db','cfg') : $config;
		$this->options['field'] = '*';//默认查询字段
		$this->class = $this->config['db_class']; //PHP5.5不支持mysql扩展,use mysqli or PDO instead
		if($this->class=='mysql' && strnatcmp(PHP_VERSION, '5.5.0')>=0) $this->class = 'mysqli'; 
		$this->pre = $this->config['db_prefix'];//数据表前缀
		$this->ext = $this->config['db_suffix'];//数据表后缀
	}

	//连接数据库
	function connect(){ 
		global $_cbase;
		$_cbase['run']['qstart'] = microtime(1); //分析Start
		if(!is_object($this->db)){ //$this->db不是对象，则连接数据库
			  $class = 'db_'.$this->class;
			  require_once(DIR_CODE."/adpt/dbdrv/{$class}.php");
			  $this->db = new $class();//连接数据库
			  $this->db->connect($this->config) ;
		}
	}

	//执行时间分析
	function runTimer($mode='-'){
		global $_cbase;
		$run_end = microtime(1); //分析Start
		$run_one = $run_end-$_cbase['run']['qstart'];
		$_cbase['run']['qtime'] += $run_one;
		$_cbase['run']['query']++;
		$tpl = $_cbase['run']['tplname'];
		$noid = $this->runChkbug($_cbase,$mode); 
		if(empty($noid)) return;
		if($_cbase['debug']['db_sql']=='db'){
			$info = basDebug::bugInfo();
			$sql = basReq::in($this->sql); $used = 1000*$run_one; $run = $_cbase['run']; 
			$kid = basKeyid::kidTemp().$noid;//.basKeyid::kidRand('24',4);
			$vals = "'$kid','$sql','$used','{$info['vp']}','$tpl','','{$run['stamp']}'"; 
			$this->db->run("INSERT INTO ".$this->table('logs_dbsql',2)."(kid,`sql`,used,page,tpl,tag,atime)VALUES($vals)"); 
		}elseif(!empty($_cbase['debug']['db_sql'])){
			$fmt = $_cbase['debug']['db_sql'];
			$file = date($fmt).".dbsql";
			basDebug::bugLogs('dbobj',$this->sql,$file,'file');
		}
	}

	function runChkbug($_cbase,$mode){
		if(!strpos($_cbase['debug']['db_acts'],$mode)) return 0;
		$indefine = 0;
		foreach($_cbase['debug']['db_area'] as $key){
			if(defined($key)){
				$indefine = 1;
				break;
			}
		}
		if(!$indefine) return 0;
		static $__noid;
		if(empty($__noid)){
			$__noid = 101;
		}else{
			$__noid++;	
		}
		return ($__noid>=960) ? 0 : $__noid;
	}
	
	//设置表，$nofix为true的时候，不加上默认的表前缀
	function table($table,$nofix=false){
		$full = '`'.$this->pre.$table.$this->ext.'`';
		if($nofix===2){ 
			return $full;
		}elseif($nofix){
			$this->options['table'] = '`'.$table.'`';
		}else{
			$this->options['bare_tab'] = $table;
			$this->options['table'] = $full;
		}
		return $this;
	}

	//回调方法，连贯操作的实现
	function __call($method,$args) {
		$method=strtolower($method);
		if(in_array($method,array('field','data','where','groups','having','order','limit','cache'))){
			$this->options[$method] =$args[0];//接收数据
			return $this;//返回对象，连贯查询
		}else{
			glbError::show($method.':No Found.');
		}
	}

	//执行原生sql语句，如果sql是查询语句，返回二维数组
	function query($sql,$func=''){ 
		if(empty($sql)) return false;
		$this->sql=$sql;
		//判断当前的sql是否是查询语句
		if($func){
			$this->connect();
			$query = $this->$func($this->sql,'qOther');
			return $query;
		}elseif(strpos(trim(strtolower($sql)),'select')===0){ 
			$data=array();
			$this->connect();
			$data = $this->db->arr($this->sql);
			$this->runTimer('qSelect');
			return $data;
		}else{ //不是查询条件，执行之后，直接返回
			$this->connect();
			$query = $this->run($this->sql,'qOther');
			return $query;
		}
	}

	//执行sql语句
	function run($sql,$act=''){ 
		$isDemo = cfg('run.isDemo');
		if(!empty($isDemo)){ 
			$tab1 = '`'.$this->pre.'active_online'.$this->ext.'`';
			$tab2 = '`'.$this->pre.'active_admin'.$this->ext.'`';
			if(in_array($this->options['table'],array($tab1,$tab2))){ 
				//echo 'session';
			}elseif(defined('RUN_JSHOW')){
				//echo 'RUN_JSHOW';
			}elseif(!empty($isDemo)){
				//echo 'skipDemo';
			}else{ //echo $this->options['table']; `users_adminer_ys`
				die(glbHtml::page('h1','Can NOT run in DEMO Site!'));
			}
		}
		$re = $this->db->run($this->sql);
		$this->runTimer($act);
		return $re;
	}

	//统计行数
	function count(){ // SELECT $func($field) AS $field FROM $tab WHERE kid='$job'
		$table=$this->options['table'];//当前表
		$field='count(*)';//查询的字段
		$where=$this->_parseCond();//条件
		$this->sql="SELECT $field FROM $table $where";
		$data="";
		$this->connect();			
		$data['count(*)'] = $this->db->val($this->sql);
		$this->runTimer('count');
		return $data['count(*)'];
	}

	//只查询一条信息，返回一维数组	
	function find(){
		$table=$this->options['table'];//当前表
		$field=$this->options['field'];//查询的字段
		$this->options['limit']=1;//限制只查询一条数据
		$where=$this->_parseCond();//条件
		$this->options['field']='*';//设置下一次查询时，字段的默认值
		$this->sql="SELECT $field FROM $table $where";
		$data="";
		$this->connect();
		$data = $this->db->row($this->sql);
		$this->runTimer('find');
		return $data;
	}

	//查询多条信息，返回数组
	function select(){
		$table=$this->options['table'];//当前表
		$field=$this->options['field'];//查询的字段
		$where=$this->_parseCond();//条件
		$this->options['field']='*';//设置下一次查询时，字段的默认值
		$this->sql="SELECT $field FROM $table $where";
		$data=array();
		//没有缓存，则查询数据库
		$this->connect();
		$data = $this->db->arr($this->sql);
		$this->runTimer('select');
		return $data;
	}

	//插入数据
	function insert($log='a') {
		$table=$this->options['table'];//当前表
		$data=$this->_parseData('add',$log);//要插入的数据
		$this->sql="INSERT INTO $table $data" ;
		$this->connect();
		$this->run($this->sql,'insert');
		if($this->db->affRows){
			$id = $this->db->lastID;
			return empty($id)?$this->db->affRows:$id;
		}
		return false;
	}

	//替换数据
	function replace($log='a') {
		$table=$this->options['table'];//当前表
		$data=$this->_parseData('add',$log);//要插入的数据
		$this->sql="REPLACE INTO $table $data" ;
		$this->connect();
		$this->run($this->sql,'replace');
		if($this->db->affRows){
			return  $this->db->lastID;
		}
		return false;
	}

	//修改更新
	function update($log='e'){ 
		$table=$this->options['table'];//当前表
		$data=$this->_parseData('save',$log);//要更新的数据
		$where=$this->_parseCond();//更新条件
		if(empty($where)) return false;	//修改条件为空时，则返回false，避免不小心将整个表数据修改了
		$this->sql="UPDATE $table SET $data $where" ;
		$this->connect();
		$this->run($this->sql,'update');
		return $this->db->affRows;
	}

	//删除
	function delete(){
		$table=$this->options['table'];//当前表
		$where=$this->_parseCond();//条件
		if(empty($where)) return false;	//删除条件为空时，则返回false，避免数据不小心被全部删除
		$this->sql="DELETE FROM $table $where";
		$this->connect();
		$this->run($this->sql,'delete');
		return $this->db->affRows;
	}

	// 取得数据表的字段信息
	function fields($tab){
		$this->connect();
		$a = $this->db->fields("$this->pre$tab$this->ext");
		$this->runTimer('fields');
		return $a;
	}

	// 取得数据库的表信息
	function tables($info=0){
		$this->connect();
		$a = $info ? $this->db->tabinfo() : $this->db->tables();
		$this->runTimer('tables'); //dump($a);
		$tab = array();
		foreach($a as $v){ 
			if($info){
				$v['Name'] = str_replace(array("($this->pre","$this->ext)"),'',"({$v['Name']})");
				if(($this->pre && strstr($v['Name'],'(')) || ($this->ext && strpos($v['Name'],')'))) continue;
				$tab[] = $v;
			}else{
				$table = str_replace(array("($this->pre","$this->ext)"),'',"($v)");
				if(($this->pre && strstr($table,'(')) || ($this->ext && strpos($table,')'))) continue;
				$tab[] = $table;
			}
		}
		return $tab;
	}

	// 取得创建表sql
	function create($tab){
		$this->connect();
		$a = $this->db->create("{$this->pre}$tab{$this->ext}");
		$this->runTimer('fields');
		return $a;
	}
	//返回sql语句
	function getSql(){
		return $this->sql;
	}
	//返回quoteSql语句
	function quoteSql($sql){
		return $this->db->quoteSql($sql);
	}
	//删除数据库缓存
	function clear(){
		if($this->config['dc_on'])
			return $this->cache->clear();
		return false;
	}

	//解析数据,添加数据时$type=add,更新数据时$type=save
    private function _parseData($type,$log='') {
		if((!isset($this->options['data']))||(empty($this->options['data']))){
			unset($this->options['data']);	//清空$this->options['data']数据
			return false;
		}
		//如果数据是字符串，直接返回
		if(is_string($this->options['data'])){
			$data=$this->options['data'];
			unset($this->options['data']);	//清空$this->options['data']数据
			return $data;
		}
		if($log && !in_array($this->options['bare_tab'],$this->nolog)){
			$dlog = basSql::logData($log);
			$this->options['data'] = array_merge($dlog,$this->options['data']);
		}
		switch($type){
			case 'add':
				$data=array();
				$data['key']="";
				$data['value']="";
				foreach($this->options['data'] as $key=>$value){
					$data['key'].="`$key`,";
					$data['value'].="'$value',";
				}
				$data['key']=substr($data['key'], 0,-1);//去除后面的逗号
				$data['value']=substr($data['value'], 0,-1);//去除后面的逗号
				unset($this->options['data']);	//清空$this->options['data']数据
				return " (".$data['key'].") VALUES (".$data['value'].") ";
				break;
			case 'save':
				$data="";
				foreach($this->options['data'] as $key=>$value){
					$data.="`$key`='$value',";
				}
				$data=substr($data, 0,-1);	//去除后面的逗号
				unset($this->options['data']);	//清空$this->options['data']数据
				return $data;
				break;
			default:
				unset($this->options['data']);	//清空$this->options['data']数据
				return false;
		}		
	}

	//解析sql查询条件
    private function _parseCond() {
		$condition="";
		//解析where()方法
		if(!empty($this->options['where'])){
			$condition=" WHERE ";
			if(is_string($this->options['where'])){
				$condition.=$this->options['where'];
			}else if(is_array($this->options['where'])){
					foreach($this->options['where'] as $key=>$value){
						 $condition.=" `$key`='$value' AND ";
					}

					$condition=substr($condition, 0,-4);	
			}else{
				$condition="";
			}
			unset($this->options['where']);//清空$this->options['where']数据
		}
		if(!empty($this->options['groups'])&&is_string($this->options['groups'])){
			$condition.=" GROUP BY ".$this->options['groups'];
			unset($this->options['groups']);
		}
		if(!empty($this->options['having'])&&is_string($this->options['having'])){
			$condition.=" HAVING ".$this->options['having'];
			unset($this->options['having']);
		}
		if(!empty($this->options['order'])&&is_string($this->options['order'])){
			$condition.=" ORDER BY ".$this->options['order'];
			unset($this->options['order']);
		}
		if(!empty($this->options['limit'])&&(is_string($this->options['limit'])||is_numeric($this->options['limit']))){
			$condition.=" LIMIT ".$this->options['limit'];
			unset($this->options['limit']);
		}
		if(empty($condition))
			return "";
		return $condition;
	}
	
	// 
	static function dbObj($config=array()){ 
		if(empty($config)){
			$key = 'dbobj_default';
		}else{
			$key = 'dbobj_'.$config['db_host'].'_'.$config['db_name'];
		}
		if(empty(self::$uobj[$key])){ 
			self::$uobj[$key] = new self($config); 
			self::$uobj[$key]->connect($config); 
		}
		return self::$uobj[$key];
	}
	
	static function getCfg($key=''){
		$dbcfg = glbConfig::read('db','cfg');
		return $key ? $dbcfg[$key] : $dbcfg;
	}

}



/*******************************************************************************
 File : \code\core\glib\glbError.php 
*******************************************************************************/
<?php
//cp错误异常类
class glbError extends Exception {

	private $erMsg='';
	private $erFile = '';
	private $erLine = 0;
	private $erCode = 0;
	private $erLevel = 0;
 	private $trace = array();
 	private $trMsgs = '';

	//抛出错误信息，用于外部调用
	static function show($msg="",$code=0) {
		 new self($code,$msg); 
	}

	function __construct($erCode=0,$erMsg='',$erFile='',$erLine=0) { 
		parent::__construct(); //$erMsg,$erCode
		$this->detail($erCode,$erMsg,$erFile,$erLine);
		$this->erOutput(); 
	}

	//detail
	protected function detail($erCode=0,$erMsg='',$erFile='',$erLine=0) {
		$msgmy = $msgphp = ''; 
		if(is_object($erCode)){ 
			$this->erMsg = $erCode->getMessage();
			$this->erFile = basDebug::hidInfo($erCode->getFile());
			$this->erLine = $erCode->getLine();
			$this->trace = $erCode;
			$this->erCode = -24;
		}elseif(!empty($erFile)){
			$this->erMsg = $erMsg;
			$this->erCode = $erCode;
			$this->erFile = basDebug::hidInfo($erFile);
			$this->erLine = $erLine;
		}elseif(!empty($erMsg)){
			$this->erMsg = $erMsg;
			$this->erCode = $erCode;
		}else{ 
			$errs = error_get_last(); 
			if(!empty($errs)){
				$this->erMsg = $erMsg ? $erMsg : "<i>Message</i>: ".$errs['message']."<br>";
				$this->erFile = basDebug::hidInfo($errs['file']);
				$this->erLine = $errs['line'];
				$this->erCode = $errs['type'];
			}
		}
 		$this->dtrace();
	}
	
	//获取trace信息
	protected function dtrace() { 
		$trace = empty($this->trace) ? $this->getTrace() : $this->trace;
		$tInfo = '';
		foreach($trace as $t) {
			$class = isset($t['class']) ? $t['class'] : '';
			$type = isset($t['type']) ? $t['type'] : '';
			$function = isset($t['function']) ? $t['function'] : '';
			$tInfo .= @$t['file'] . ' (' . @$t['line'] . ') ';
			$tInfo .= $class . $type . $function . "() @ <br />\r\n";
		}
		$this->trMsgs = $tInfo ;
	}
	
	//错误等级
	protected function getLevel() {
	   $arr = array(	
			1=> '(E_ERROR)',
			2 => '(E_WARNING)',
			4 => '(E_PARSE)',  
			8 => '(E_NOTICE)',  
			16 => 'E_CORE_ERROR',  
			32 => 'E_CORE_WARNING',  
			64 => '(E_COMPILE_ERROR)', 
			128 => '(E_COMPILE_WARNING)',  
			256 => '(E_USER_ERROR)',  
			512 => '(E_USER_WARNING)', 
			1024 => '(E_USER_NOTICE)',  
			2047 => 'E_ALL', 
			2048 => 'E_STRICT',
			'-24' => 'EXCEPT_HANDLER',
		);
		return isset($arr[$this->erCode]) ? $arr[$this->erCode] : $this->erCode;
	}
	
	//输出错误信息
	 protected function erOutput($message=''){
		//if(defined('DEBUG') && false == DEBUG){ exit; } 
		$message = empty($message) ? $this->erMsg : $message;
		@header("HTTP/1.1 404 Not Found");
		$sCode = empty($this->erCode) ? '[RUN]' : $this->erCode;
		$sLevel = $this->getLevel();
		$sLevel = empty($sLevel) ? '[RUN]' : $this->getLevel();
		basMsg::init("Error : $sCode",1);
		$html = '';
		if($this->erFile){
			$html .= "\n<strong> ------ File</strong>: ".$this->erFile.' (Line:'.$this->erLine.')<br>';
		} 
		$html .= "\n<strong> ------ Info</strong>: (Level:$sLevel)<br>".basDebug::hidInfo($message).'<br>';
		$html .= "\n<strong> ------ Trace</strong>: (Time:".date("Y-m-d H:i:s").")<br>".basDebug::hidInfo($this->trMsgs).'<br>';
		$html .= "\n<strong> ------ Debug Info</strong>: ".basDebug::runInfo().'<br>';
		$html .= "\n<strong> ------ Now you can</strong>: <a href='{$_SERVER['PHP_SELF']}'>Retry</a> , <a href='javascript:history.back()'>Return</a> OR <a href='".PATH_ROOT."'>Go Homepage</a><br>";
		if(defined('RUN_AJAX')){ $html = strip_tags($html); } 
		die(glbHtml::page('end',$html));
	}
}


/*******************************************************************************
 File : \code\core\glib\glbHtml.php 
*******************************************************************************/
<?php
// Html类
class glbHtml{	

	// 页面结构
	static function page($mod='',$ext=''){
		global $_cbase; 
		$sdir = vopTpls::def(); //可能没有定义
		if($mod=='body'){
			echo "</head><body$ext>\n";
		}elseif($mod=='end'){
			if(empty($_cbase['run']['headed'])){
				self::page('');
			}
			if(strlen($ext)>12) echo "$ext\n";
			echo "</body></html>\n";
		}elseif(in_array($mod,array('robots','viewport','keywords','description'))){
			if($mod=='robots' && empty($ext)) $ext = 'noindex, nofollow';
			if($mod=='viewport' && empty($ext)) $ext = 'width=device-width, initial-scale=1';
			echo "<meta name='$mod' content='$ext'>\n"; 
		}elseif($mod=='h1'){
			echo "<h1>$ext</h1>\n";
		}elseif($mod=='imp'){
			self::impub();
			self::imvop($sdir);	
		}elseif($mod=='imadm'){  
			self::impub("&lang={$_cbase['sys']['lang']}"); 
			echo basJscss::imp('/plus/ajax/comjs.php?act=jsPlus');
			echo basJscss::imp('/skin/a_jscss/jstyle.css'); 
			self::imvop($sdir);		
		}elseif($mod=='imvop'){
			self::impub("$ext",1);
			self::imvop($sdir);	
		}elseif($mod=='imin'){
			echo basJscss::imp('/plus/ajax/comjs.php?');
			echo basJscss::imp("/skin/a_jscss/stpub.css");
		}else{ //head
			$_cbase['run']['headed'] = 1;
			$mod || $mod = $_cbase['sys_name'];
			$mod = str_replace('(sys_name)',$_cbase['sys_name'],$mod);
			echo "<!DOCTYPE html><html><head>\n";
			echo "<meta charset='".cfg('sys.cset')."'>\n";
			echo "<title>$mod</title>\n";
			if($ext) echo "<meta name='robots' content='noindex, nofollow'>\n";
			if(defined('RUN_MOB')){ 
				echo "<meta name='viewport' content='width=device-width, initial-scale=1'>\n";
			}
		}
	}

	// _impub
	static function impub($jsrun='',$nolayer='',$nohick=''){
		echo basJscss::imp("/plus/ajax/comjs.php?$jsrun"); 
		echo basJscss::imp('/plus/ajax/comjs.php?act=autoJQ'); 
		echo basJscss::imp("/skin/a_jscss/stpub.css");
		echo basJscss::imp("/common/stuipub.css",'vui');
		if(!$nolayer) echo basJscss::imp('/layer/layer.js','vui');
		echo "<link rel='shortcut icon' href='".PATH_ROOT."/skin/a_img/favicon.ico' />\n";
		//echo "<!--[if lt IE 9]><script src='".PATH_VENDUI."/jquery/html5shiv.min.js'></script]\n";
		//echo "<script src='".PATH_VENDUI."/jquery/respond.min.js'></script]<![endif]-->";
	}
	// _impub
	static function imvop($sdir=''){
		$lang = cfg('sys.lang');
		echo basJscss::imp("/skin/$sdir/b_jscss/comm.css");
		echo basJscss::imp("/skin/$sdir/b_jscss/comm.js");
		$flang = "/skin/$sdir/b_jscss/comm-{$lang}.js";
		if(is_file(DIR_ROOT.$flang)) echo basJscss::imp($flang);
	}

	// header
	static function head($type='js',$cset=''){
		$cset = $cset ? $cset : cfg('sys.cset');
		$a = array(
			'js'=>'text/javascript',
			'html'=>'text/html',
			'json'=>'application/json',
			'down'=>'application/octet-stream',
		);
		header("Content-Type:$a[$type]; charset=$cset");
	}
	
	// domain_allow跨域允许
	static function dallow($domain=''){
		$allow = glbConfig::read('dmacc','ex');
		if(empty($domain)){
			@$aurl = parse_url($_SERVER["HTTP_REFERER"]);
			@$domain = $aurl['host'];
		}
		if(in_array($domain, $allow)){ 
			header("Access-Control-Allow-Origin:http://$domain"); // 指定允许其他域名访问  
			header('Access-Control-Allow-Methods:POST'); // 响应类型  
			header('Access-Control-Allow-Headers:x-requested-with,content-type'); // 响应头设置
			/*
			cls_HttpStatus::trace(array('X-Frame-Options' => 'ALLOWALL'));	//ALLOWALL，ALLOW-FROM
			*/
		} 
	}
	
	// table:(bar): 头
	static function tab_bar($title,$cont,$w1=25,$css2='tc'){	
		echo "<table border='0' class='tbbar1'><tr>\n";
		echo "<th class='tc h150' width='$w1%k'>$title</th>\n";
		echo "<td class='$css2'>$cont</td>\n"; 
		echo "</tr></table>\n";
		
	}
	// form+table:头
	static function fmt_head($fmid,$fmact,$tbcss='',$win='',$tbbrd=1){
		echo "<form id='$fmid' name='$fmid' method='post' action='$fmact' target='$win'>\n";
		$recbk = basReq::val('recbk','');
		$recbk = $recbk==='ref' ? @$_SERVER["HTTP_REFERER"] : $recbk;
		echo "<input name='recbk' type='hidden' value='$recbk' />\n"; 
		echo "<table border='$tbbrd' class='$tbcss'>\n"; // echo "\n";
	}	
	// form+table:(end):结束
	static function fmt_end($data='',$tabend='</table>'){
		if(!$data){ echo "\n$tabend</form>"; return; }
		if(is_array($data)){
			$arr = $data;
		}else{
			$arr[] = $data;	
		}
		$str = '';
		foreach($arr as $v){
			$itm = explode('|',"$v|");
			//if($itm[1]) $itm[1] = $itm[0];
			$str .= "\n<input name='$itm[0]' type='hidden' value='$itm[1]' />";
		}
		echo "$str$tabend</form>";
	}
	
	// form:(增加/修改):一行
	static function fmae_row($title,$msg,$hid=0){
		echo "<tr ".($hid?"style='display:none'":'')."><td class='tc'>$title</td>\n";
		echo "<td class='tl'>$msg</td></tr>\n";
	}
	// form:(增加/修改):头
	static function fmae_top($title,$msg,$width=25){
		echo "<tr><th width='$width%'>$title</th>\n";
		echo "<th class='tr'>$msg</th></tr>\n";
	}
	// form:(增加/修改):提交
	static function fmae_send($fmid,$title,$width=0,$bcls='tc'){
		echo "<tr><td class='tc' ".(!empty($width) ? "width='$width%'" : "").">$title</td>\n";
		echo "<td class='$bcls'><input name='$fmid' type='submit' class='btn' value='$title' />".($bcls=='tr' ? " &nbsp; 　 " : "")."</td></tr>\n";
	}
	
	static function null_cell($str,$char='Y'){
		return empty($str) ? "<span class='cCCC'>---</span>" : ($char=='Y' ? 'Y' : $str);
	}
	
	static function ieLow_js(){
		$s = '<!--[if lt IE 9]><script>';
		$s .= '(function(){';
		$s .= 'if(! /*@cc_on!@*/ 0) return;';
		$s .= 'var e = "abbr,article,aside,audio,canvas,datalist,details,dialog,eventsource,figure,footer,header,hgroup,mark,menu,meter,nav,output,progress,section,time,video".split(",");';
		$s .= 'for(var i=0;i<e.length;i++){document.createElement(e[i]);} ';
		$s .= '})()</script><![endif]-->';
		echo "\n$s\n";
	}
	static function ieLow_html($mie=8,$nie=9,$css='LowIE',$msg=''){
		$msg || $msg = basLang::show('core.ie_low',$nie); 
		$s = "<!--[if lt IE $mie]>\n"; //<!--[if lt IE 8]>
		$s .= "<div class='$css'>$msg</div>\n";
		$s .= "<![endif]-->";
		echo "\n$s\n";
	}
	// 清空缓存 
	static function clearCache(){
		header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // 让它在过去就“失效”
		header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT"); // 永远是改动过的
		header("Cache-Control: no-store, no-cache , must-revalidate"); // HTTP/1.1
		header("Cache-Control: post-check=0, pre-check=0", false);
		header("Pragma: no-cache"); // HTTP/1.0
		header("Cache-control: max-age=0"); // IE6
	}
	
	// PageEnd()
	static function end($msg='',$end=''){
		$headed = cfg('run.headed');
		if(empty($headed)){
			self::page('');
		}
		if($end) echo "$end\n";
		if($msg) echo "<h1>$msg</h1>\n";
		echo "</body></html>\n";
		die();
	}
	
	// 发送HTTP状态
	static function httpStatus($code) {
		static $_status = array(
			200 => 'OK', // Success 2xx
			301 => 'Moved Permanently', // Redirection 3xx
			302 => 'Moved Temporarily ',
			400 => 'Bad Request', // Client Error 4xx
			403 => 'Forbidden',
			404 => 'Not Found',
			500 => 'Internal Server Error', // Server Error 5xx
			503 => 'Service Unavailable',
		);
		if(isset($_status[$code])) {
			header('HTTP/1.1 '.$code.' '.$_status[$code]);
			header('Status:'.$code.' '.$_status[$code]); // 确保FastCGI模式下正常
		}
	}

}


/*******************************************************************************
 File : \code\core\glib\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\glib\safBase.php 
*******************************************************************************/
<?php
/**
safBase : 基础-安全过滤(Safil=Safety Filter)
  Stop,ipStop,robotStop,
  RndA,
*/
class safBase{
	
	// ---- 用户信息 基础过滤项 --------------------------------------- 
	
	// IPStop
	static function ipStop($ip='',$tab=''){
		$ip || $ip = self::userIP();
		//$tab || $tab = xxx(); 
		$tab = glbConfig::read('ipstop','ex');
		if(empty($ip) || empty($tab)) return;
		if($tab){
			if(preg_match("/^($tab)$/",$ip)) self::Stop('ipStop');
		}
	}
	
	// RobotStop
	static function robotStop(){
		if(basEnv::isRobot()) self::Stop('robotStop');
	}
	
	// ---- 公共杂项方法 ---------------------------------------
	
	// Stop - 停止运行并记录操作
	static function Stop($key,$exmsg=''){
		//basDebug::bugLogs('file',$key,"/".date('Y-md').".sflog");
		if($key=='robotStop') glbHtml::httpStatus(403); 
		$cfg = array(
			'robotStop'=>'HTTP 403 Forbidden',
			'ipStop'=>'Stop by IP Fobidden!',
			'urlFrom'=>'Stop by HTTP_REFERER!',
			'urlScan'=>'Stop by Safety Scan!',
		);
		$msg = isset($cfg[$key]) ? $cfg[$key] : $key;
		$exmsg && $msg .= " [$exmsg]";
		//basMsg::show($msg,'die'); 
		glbError::show($msg);
	}
	
	// RndA - 由时间戳, 生成随机特殊字符数组对
	/* Return : Array(
		[0^1>2+] => '',
		[3-] => '85d6',
		[4&] => '9637',
		[5~] => '973f',);*/
	static function RndA($timer,$encode){  
		$safe = cfg('safe');
		$stim = str_replace('.','',$timer);
		$stim = strrev($stim); $a = array(); 
		$rnum = $safe['rnum'];
		$rspe = $safe['rspe'];  
		$spla = strlen($rspe);
		for($i=0;$i<strlen($stim);$i++){
			$t = substr($stim,$i,1)+substr($rnum,$i,1);
			$a[] = $t; 
			if($i<$spla){
				$t2 = $t % $spla;
				$c = substr($rspe,$t2,1);
				$rspe = (($t2 % 2)==1 ? $c : '').str_replace($c,'',$rspe).(($t2 % 2)==0 ? $c : '');
			}
		}
		$r = array(); $k = '';
		$m = 1+($a[2] % 4);
		$len = count($a) - ($a[3] % 9);
		for($i=0;$i<$len;$i++){
			if($i<$m){
				$k .= $i.substr($rspe,$i,1);
			}elseif($i==$m){
				$r[$k.$i.substr($rspe,$i,1)] = '';
			}else{
				$r[$i.substr($rspe,$i,1)] = $a[$i].substr($encode,$i*2,3); 
			}
		}
		return $r;
	}

	// --- End ----------------------------------------
	
}



/*******************************************************************************
 File : \code\core\glib\safComm.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/**
safBase : 常规-安全过滤(Safil=Safety Filter)
  formAuto,formRev,formCheck,
  urlFrom,urlScan,urlStamp
*/
class safComm{ // extends safBase
	
	// 综合认证：
	static function formCAll($mod,$path='',$timeout=3600){
		$re = '';
		//fromUrl 认证
		self::urlFrom($path);
		$rest = self::formCInit('x', $timeout);
		$code = basReq::val("{$mod}_{$rest[1]}");
		$revc = self::formCVimg($mod, $code, 'check', $timeout, 1);
		if(!empty($rest[0])){ 
			$re = lang('safcomm_vcoderr')."[$rest[0]]";
		}elseif(!empty($revc)){ //认证码 认证
			$re = lang('safcomm_vcoderr')."[$revc]";
		}
		return array($re,$code); //认证结果
	}
	
	// ---- 表单过滤项 ---------------------------------------
	
	// 检查表单项 --- formCVimg()
	static function formCVimg($mod, $vcode, $act, $timeout=3600, $clear=0){ 
		global $_cbase;
		$sform = $_cbase['safe']['safil'];
		if($act=='save'){
			$stamp = $_cbase['run']['stamp']; 
			$encode = $stamp.','.comConvert::sysEncode($sform.strtoupper($vcode),$stamp);
			comCookie::mset('vcodes',0,$mod,$encode); //echo $encode;
			return;
		}else{ //check
			$cookie = comCookie::mget('vcodes',$mod); 
			$stamp = substr($cookie,0,strpos($cookie,',')); 
			$encode = $stamp.','.comConvert::sysEncode($sform.strtoupper($vcode),$stamp);
			if(strlen($cookie)<24 || $cookie!=$encode){
				$re = "VCode-Error[1]！"; 
			}elseif(($_cbase['run']['stamp']-$stamp)>$timeout){
				$re = "VCode-Timeout[2]！";
			}else{
				$re = '';
			}
			$clear && comCookie::mset('vcodes',0,$mod,'null');
			return $re;
		}
	}
	
	// 检查表单项 --- 表单时间戳
	static function formCInit($act='init', $time=3600){  
		global $_cbase;
		$stamp = $_cbase['run']['stamp']; 
		$sform = $_cbase['safe']['safil'];
		$safix = $_cbase['safe']['safix'];
		$rdnum = $_cbase['safe']['rnum']; 
		$re = ''; $len1 = 34; $len2 = 16; //偶数
		$st = date('H',$stamp)>22 ? ($stamp + 5400) : $stamp; //23:xx -> 3600+1800
		$sdate = explode('_',date('m_d',$st));
		$dval  =	 (substr($rdnum,1,4)+substr($rdnum,4,4)*$sdate[0]); 
		$dval .= '_'.(substr($rdnum,6,4)+substr($rdnum,9,4)*$sdate[1]);
		if($act=='init'){
			$encode = comConvert::sysEncode($sform,$stamp,$len1);
			$restr = "<input type='hidden' name='{$safix}[dt]' value='$dval' />";
			$restr .= "<input type='hidden' name='{$safix}[tm]' value='$stamp' />";
			$restr .= "<input type='hidden' name='{$safix}[enc]' value='$encode' />";
			$fmid = basReq::val('fmid','');
			$css1 = basReq::val('css1','txt w60');
			$css2 = basReq::val('css2','fs_vimg');
			$tabi = basReq::val('tabi',19790);
			$senc = comConvert::sysEncode($sform,$stamp,$len2); 
			$vgap = '\\"'; 
			$vstr = "maxlength='5' reg='vimg:3-5' tip='".lang('core.safcomm_vcode')."' url='".PATH_ROOT."/plus/ajax/cajax.php?act=chkVImg&mod={$fmid}&key={$senc}'";
			$restr .= "<input id='{$fmid}_{$senc}' name='{$fmid}_{$senc}' tabindex='$tabi' type='text' class='$css1' onFocus={$vgap}fsCode('{$fmid}'){$vgap} $vstr />";
			$restr .= "<samp id='{$fmid}_vBox' class='$css2' style='display:none'></samp>"; //samp,span, style='width:50px;'
			return $restr;
		}else{
			$re_date = basReq::ark($safix,'dt');
			$re_stamp = basReq::ark($safix,'tm'); 
			$re_encode = basReq::ark($safix,'enc'); 
			$enc = comConvert::sysEncode($sform,$re_stamp,$len2); 
			if(empty($re_stamp) || empty($re_encode)){
				$re = 'Error-Null';
			}elseif($stamp-$re_stamp>$time){ 
				$re = 'Timeout';
			}elseif(!($re_encode==comConvert::sysEncode($sform,$re_stamp,$len1))){ 
				$re = 'Error-E';
			}elseif(!($re_date==$dval)){ 
				$re = 'Error-D';
			}
			return array($re,$enc);
		}
	}

	// QUERY-7参数检测
	static function urlQstr7($re=0){ 
		$q = isset($_SERVER['QUERY_STRING']) ? $_SERVER['QUERY_STRING'] : '';
		$q = urldecode($q);
		if($q!=str_replace(array('<','>','"',"'","\\","\r","\n"),'',$q)){
			if($re) return false;
			$msg = "[QUERY]Error!";
			basMsg::show($msg,'die'); 
		}
		return true;
	}
	
	//检测是否外部提交过来的Url
	//expath : 路径匹配部分,可为空
	//die : 默认直接die, 如为空则返回用于判断
	//return : 默认直接die; false:不是外部提交来的地址; true(string):相关信息,表示是外部提交或直接输入网址过来
	//demo: if(xxx::urlFrom('',0)) die("不是来自{PATH_ROOT}的请求！");
	//demo: if(xxx::urlFrom('/dgpeace/_php_test.php'));
	static function urlFrom($expath='',$die=1){
		$re = '';
		$ref = empty($_SERVER["HTTP_REFERER"]) ? '' : $_SERVER["HTTP_REFERER"];
		if(empty($ref)){ //为空:(输入地址等)
			$re = 'Null'; 
		}else{
			$from = self::urlParse($ref); 
			$hnow = self::urlParse($_SERVER['HTTP_HOST']); 
			if(@$from['host']!==@$hnow['host']){ // 匹配:主机/域名+端口 
				$re = $from['host']; 
			}else{ // 匹配:路径
				$npath = PATH_PROJ; //cls_env::mconfig('cmsurl'); // 如:/house/
				if($expath) $npath = str_replace(array('///','//'),'/',"$npath/$expath"); 
				if(strlen($npath)>0 && !preg_match('/^'.preg_quote($npath,"/").'/i',$from['p'])){ 
					$re = $npath;	
				} 
			}
		}
		if($re && $die){ 
			safBase::Stop('urlFrom',$re); 
		}
		return $re; 
	}
	
	/*	获取: host(主域名+端口) 和 path(路径)
	--- Demo --- 
	$url1 = "http://m.txmao.com:808/shopinfo.d?m=fbyzm&mobile=13537432146&city=bj#aa=33";
	$url2 = "http://www.txmao.com:808/example/index.php/dir/test.php?aaa=bbb";
	$url3 = "http://192.168.1.11:888/house/dgpeace/_php_test.php?aaaa=bbb";
	$url4 = "http://[2001:410:0:1:250:fcee:e450:33ab]:8443/file.php/rrf?aa=bb"; 
	echo 'aab:<pre>'.var_dump(xxx::urlParse($url4)).'</pre><br>';
	*/
	static function urlParse($url){	
		$aurl = parse_url($url); //var_dump($aurl);
		$top = basEnv::TopDomain(@$aurl['host']);
		if(!empty($top)){ //IP(含ipv6)
			$aurl['host'] = $top;
		}
		$host = @$aurl['host'].(isset($aurl['port']) ? ':'.$aurl['port'] : '');
		$path = empty($aurl['path']) ? '' : $aurl['path'];
		return array('h'=>$host,'p'=>$path);
	}

	// 注入项扫描关键字
	static function urlScan(){  
		$filters  = "(and|or)\\b.+?(>|<|=|in|like)|<\\s*script\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)";
		$paras = isset($_SERVER['QUERY_STRING']) ? $_SERVER['QUERY_STRING'] : '';
		if(empty($paras)) return;
		if(preg_match("/".$filters."/is",$paras)){   
			safBase::Stop('urlScan');
		}	
	} // \\bEXEC\\b| , \\/\\*.+?\\*\\/| , '|
	
	// --- act=init,stop,flag
	static function urlStamp($act='init',$time=3600){  
		global $_cbase;
		$stamp = $_cbase['run']['stamp']; 
		$sform = $_cbase['safe']['safil'];
		$safix = $_cbase['safe']['safix'];
		if($act=='init'){
			$encode = comConvert::sysEncode($sform,$stamp);
			return "{$safix}[tm]=$stamp&{$safix}[enc]=$encode";
		}else{
			$flag = 0;
			$re_stamp = basReq::ark($safix,'tm');
			$re_encode = basReq::ark($safix,'enc'); 
			if(empty($re_stamp) || empty($re_encode)) $flag = 'empty';
			if($stamp-$re_stamp>$time) $flag = 'timeout';
			if(!($re_encode==comConvert::sysEncode($sform,$re_stamp))) $flag = 'encode';
			if($flag){
				return ($act=='flag') ? $flag : safBase::Stop('urlStamp');
			}
		}
	}
	
	// --- signVeryfy
	// 签名: data=array, keys='k1,k2'
	// 认证: data=timeout, keys='k1,k2'
	static function signVeryfy($data=60,$keys=''){ 
		global $_cbase;
		$stamp = $_cbase['run']['stamp']; 
		$snid = $_cbase['safe']['rnum'];
		$skey = $_cbase['safe']['api'];
		$safix = $_cbase['safe']['safix'];
		$udata = is_array($data) ? $data : $_GET;
		$keys || implode(',',array_keys($data));
		$akey = explode(',',$keys);
		$schk = ''; $sret = '';
		foreach($udata as $key=>$val){
			if(is_array($val)) continue;
			$sret .= "&$key=$val";
			if(in_array($key,$akey)){ 
				$schk .= "&$key=$val";
			}
		}
		if(is_array($data)){
			$encode = comConvert::sysEncode($schk,"$snid.$skey.$stamp");
			return "{$safix}[tm]=$stamp&{$safix}[enc]=$encode{$sret}";
		}else{
			$ustamp = basReq::ark($safix,'tm');
			if($stamp-$ustamp>intval($data)) return 'timeout';
			$usign = basReq::ark($safix,'enc'); 
			$encode = comConvert::sysEncode($schk,"$snid.$skey.$ustamp");
			return $encode==$usign ? '' : 'error';
		}
	}
	/*
	$act = basReq::val('act','sign');
	if($act=='sign'){
		$arr = array('act'=>'check','aa'=>'aa1','bb'=>'bb1',);
		$str = safComm::signVeryfy($arr,'act,aa');
		echo ":<a href='?$str' target='_blank'>$str</a>:";
	}elseif($act=='check'){
		$timeout = basReq::val('timeout','5');
		$res = safComm::signVeryfy($timeout,'act,aa');
		echo $res;
	}*/
	
	
	
		
	// --- End ----------------------------------------
	
}



/*******************************************************************************
 File : \code\core\glib\safData.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/**
	// re=stop,mark

data,tab,rule,plan
plan:subject,content
rule:单词至少N个,无中文字，有特殊字符N个,常用词少于N个，含非法字1，含非法字2，含非法字3
	 words,	  nochr,	spen,		 topn,		  keyn
tab:特殊字符1，特殊字符2，特殊字符3，
	常用词表en,常用词表cn,常用词表u1,
	常用词表en,常用词表cn,常用词表u1,
	广告,色情,暴力,反动,
	自定义1,自定义2,自定义3,
type:关键字类别
标记,N个处理

tab:特殊字符1，特殊字符2，特殊字符3，
	常用词表en,常用词表cn,常用词表u1,
	广告,色情,暴力,反动,
	自定义1,自定义2,自定义3,

----------------------------------------------------------------------------
safBase : 数据-安全过滤(Safil=Safety Filter)
  formAuto,formRev,formCheck,
  urlFrom,urlScan,urlStamp
/**

$content = safData::Check($content,'cont01',$mark=0);

ruleCheck()
rule*() ---- Stop,Mark
tab*()

*/
class safData{ // extends safBase
  
  // 常用单词,常用短语
  public static $top_en0 = 'about;after;all;also;an;and;another;any;are;as;at;be;because;been;before;being;between;both;but;by;came;can;come;could;did;do;each;for;from;get;got;had;has;have;he;her;here;him;himself;his;how;if;in;into;is;it;like;make;many;me;might;more;most;much;must;my;never;now;of;on;only;or;other;our;out;over;said;same;see;should;since;some;still;such;take;than;that;the;their;them;then;there;these;they;this;those;through;to;too;under;up;very;was;way;we;well;were;what;where;which;while;who;with;would;you;your';
  public static $top_cn0 = '怎么;任何;连同;开外;再有;哪些;甚至于;又及;当然;就是;遵照;以来;赖以;否则;此间;后者;按照;才是;自身;再则;就算;即便;有些;例如;它们;虽然;为此;以免;别处;我们;依据;趁着;就要;各位;别的;前者;不外乎;虽说;除此;个别;的话;甚而;那般;譬如;作为;谁人;进而;那边;首先;因此;怎么样;果然;除非;以上;为何;要么;随时;如果说;诸如;还是;一旦;基于;本人;因而;继而;不单;此时;等等;截至;不但;故而;全体;从此;对于;朝着;怎样;以为;那儿;或是;本身;况且;处在;不至于;那个;诸位;从而;各自;针对;此外;何处;为了;这般;仍旧;既然;反而;关于;较之;不管;彼时;这边;不光;宁可;要是;其他;其它;由于;还要;经过;不过;来说;除了;既是;的确;说来;据此;只限于;什么的;还有;只怕;不尽;多会;正巧;为什么;以至;以致;某个;与否;凭借;不仅;两者;另外;一来;正如;那里;不尽然;毋宁;这儿;嘿嘿;就是说;正是;既往;随着;于是;那么;而后;似的;不料;其余;或者;介于;别人;这个;受到;只是;即使;不论;本着;及至;加以;多么;其中;别说;这会;依照;人们;如此;个人;出来;另一方面;唯有;接着;何况;加之;至今;凡是;他们;一切;那时;只限;不然;许多;在于;某某;除外;来自;便于;同时;只消;只需;不如;只要;并不;不仅仅;这里;总之;因为;固然;不是;或者说;然而;假如;如何;这么;可见;如果;简言之;多少;光是;非但;呵呵;只有;只因;连带;正值;沿着;哪儿;他人;若非;怎么办;她们;而且;与其;如同下;有的;那些;甚至;为止;无论;鉴于;嘻嘻;哪个;然后;直到;并非;对比;为着;一些;何时;而是;自从;比如;之所以;你们;那样;所以;得了;当地;有关;所有;因之;用来;所在;对待;而外;分别;某些;对方;不只;但是;全部;尽管;大家;以便;自己;可是;反之;这些;什么;由此;万一;而已;何以;咱们;值此;向着;哪怕;倘若;出于;如上;如若;替代;什么样;如是;照着;此处;这样;每当;此次;至于;此地;要不然;逐步;格里斯;本地;要不;其次;尽管如此;遵循;乃至;若是;并且;如下;可以;才能;以及;彼此;根据;随后;有时';
  //const CHARSET = "中国";
  // $key = "top_en0"; //die($key2);
  // echo self::$$key; //$key='top_en0'
  
  
  // === plans ==================================================================================
  
  // plan: xxx -------------------------- 
  static function planMain($str,$plan='',$nmax=0){ 
	  $_safil = glbConfig::read('sfdata','ex');
	  if(empty($str) || empty($_safil['plan'][$plan])) return;
	  $plan = $_safil['plan'][$plan];
	  $n = 0; //Words,4,mark
	  foreach($plan as $rule){
		  $t = explode(',',"$rule,,,,");
		  $func = "rule$t[0]";
		  $n += self::$func($t[1],$t[2],$t[3],$t[4]); 
	  }
	  if($nmax && $n>$nmax){
		  safBase::Stop('dataPlan');	
	  }
	  return $n;
  }
	
	// === rules ==================================================================================

	// rules: 单词>=N个 -------------------------- 
	static function ruleWords($str,$n=1,$re='mark'){ 
		$str = strip_tags($str); //$str = htmlspecialchars($str);
		$str = trim($str); //去掉开始和结束的空白 
		if(empty($str)) return $re=='stop' ? safBase::Stop('dataWords') : 0;
		$str = preg_replace('/\s(?=\s)/', '', $str); //去掉根随别的挤在一块的空白 
		$str = preg_replace('/[\n\r\t]/', ' ', $str); //最后，去掉非space 的空白，用一个空格代替 
		if(empty($str)) return $re=='stop' ? safBase::Stop('dataWords') : 0;
		$cnt = count(explode(' ',$str));
		if($cnt<$n && $re=='stop'){
			 safBase::Stop('dataWords');
		}else{
			return $cnt<$n ? 0 : 1;
		}
	}
	
	// rules: 中文字>=N个 -------------------------- 
	static function ruleCNChr($str,$n=1,$re='mark'){ 
		$cset = $_cbase['sys']['cset'];
		$str = strip_tags($str);
		$str = trim($str);
		//preg_match_all("/[\x{4e00}-\x{9fa5}]/u",$str,$m); 
		//$cnt = count($m[0]);
		$n0 = strlen($str);
		$str = preg_replace('/[\x{4e00}-\x{9fa5}]/u',"",$str);
		$cnt = ($n0 - strlen($str))/($cset=='utf-8' ? 3 : 2); 
		if($cnt<$n && $re=='stop'){
			 safBase::Stop('dataCNChr');
		}else{
			return $cnt<$n ? 0 : 1;
		} //preg_replace 比 preg_match_all 快
	}
	
	// rules: 常用词>N个 -------------------------- 
	static function ruleNCom($str,$n=1,$re='mark',$tab='cn'){ 
		$_safil = glbConfig::read('sfdata','ex');
		$str = strip_tags($str);
		$str = trim($str);
		if($tab=='cn'){
			$tab = self::$top_cn0;
		}else{
			$tab = self::$top_en0;
			$flag = '[^a-zA-Z]{1,2}';
			$tab = str_replace(';',"$flag;$flag",$tab); 
			$tab = "$flag$tab$flag";
		}
		$tab = $tab.";".$_safil['tab_sys'];
		$tab = str_replace(';','|',$tab);
		preg_match_all("/$tab/i",$str,$m); echo '<br>'; print_r($m);
		$cnt = count($m[0]);
		if($cnt<$n && $re=='stop'){
			 safBase::Stop('dataNCom');
		}else{
			return $cnt<$n ? 0 : 1;
		} 
	}
	
	// rules: 含有特殊字符 -------------------------- 
	static function ruleNSpe($str,$re='mark',$tab='(all)'){ 
		$str = strip_tags($str); 
		$str = trim($str); 
		$rk = self::_ruleTab('spe',$tab); 
		if(empty($rk)) return 0;
		$rk = str_replace(';','|',$rk);
		preg_match("/$rk/i",$str,$m); echo '<br>'; 
		if($m && $re=='stop'){
			 safBase::Stop('dataNSpe');
		}else{
			return $m ? 1 : 0;
		} 
	}
	
	// rules: 含有非法字 -------------------------- 
	static function ruleNKey($str,$re='stop',$tab='(all)'){ 
		$str = trim($str); 
		$rk = self::_ruleTab('key',$tab); 
		if(empty($rk)) return 0;
		$rk = str_replace(';;',';',$rk); 
		$rk = str_replace(array("?"),array("[^\1]{0,3}"),$rk); 
		$rk = str_replace(';','|',$rk);
		preg_match("/$rk/i",$str,$m); echo '<br>'; 
		if($m && $re=='stop'){
			 safBase::Stop('dataNKey');
		}else{
			return $m ? 1 : 0;
		} 
	}
	
	// rules: 含有广告连接 -------------------------- 
	static function ruleNAdv($str,$re='stop',$tab='(all)'){ 
		$str = trim($str); 
		$rk = self::_ruleTab('adv',$tab); 
		if(empty($rk)) return 0;
		$rk = str_replace(';;',';',$rk); // ?,+ <a*</a>;[url]*[/url];[link]*[script];
		$rk = str_replace(array("[","]","<",">","/"),array("\\[","\\]","\\<","\\>","\\/"),$rk); 
		$rk = str_replace(array("*"),array("[^\1]{8,255}"),$rk); 
		$rk = str_replace(';','|',$rk);
		preg_match("/$rk/i",$str,$m); echo '<br>'; 
		if($m && $re=='stop'){
			 safBase::Stop('dataNAdv');
		}else{
			return $m ? 1 : 0;
		} 
	}
	
	// rules-tab: 得到关键字表 -------------------------- 
	static function _ruleTab($key='key',$tab='(all)'){ 
		$_safil = glbConfig::read('sfdata','ex');
		$rk = '';
		if($tab=='(all)'){
			$t = $_safil["tab_$key"];
			foreach($t as $k=>$v) $rk .= ";$v[1]";
		}else{
			$rk = $_safil["tab_$key"][$tab][1];	
		}
		return empty($rk) ? '' : substr($rk,1);	
	}
	
	// === ... ======================================================================================
	
	

	// XXX
	static function XXXXXX($act='init'){  
		$safix = cfg('safe.safix');
		if($act=='init'){

		}else{
			;//
		}
		//echo self::$top_cn0;
	}
		
	// === End ====================================================================================
	
}




/*******************************************************************************
 File : \code\core\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\sdev\devApp.php 
*******************************************************************************/
<?php

// ...类

class devApp{	
	
	// 创建应用 
	static function create($dir, $front, $mod){ 
		if(strlen(basStr::filKey($dir,''))<3 || strlen(basStr::filKey($front,''))<3){
			return lang('devapp_dferr');
		} 
		if(is_numeric($dir) || is_numeric($front)){
			return lang('devapp_dfnum');
		}
		$exa = array('demodir','front','home','info');
		if(in_array($dir,$exa) || in_array($front,$exa)){
			return lang('devapp_dfues');	
		}
		$vopfmt = glbConfig::read('vopfmt','ex'); 
		$groups = glbConfig::read('groups'); 
		if(isset($vopfmt['tpl'][$dir]) || is_dir(DIR_CODE."/tpls/$dir")){
			return lang('devapp_dfext');
		}
		if(empty($groups[$mod]['pid']) || $groups[$mod]['pid']!='docs'){
			return lang('devapp_dataerr');
		}
		self::cdir(DIR_CODE."/tpls/demodir", DIR_CODE."/tpls/$dir", $mod);
		self::cdir(DIR_ROOT."/skin/demodir", DIR_ROOT."/skin/$dir", $mod);
		self::cfiles($dir, $front, $mod);
		return 'OK'; //"<input type='text' value='dir=$dir,front=$front,mod=$mod' class='disc'>";
	}
	
	// 复制目录
	static function cdir($src, $dst, $mod) {  // 原目录，复制到的目录
		$dir = opendir($src);
		@mkdir($dst); //(news)}">news<
		$aorg = array("news_",   "_news",   "news-",   "(news)", ">news<", ",news]");
		$aobj = array("{$mod}_", "_{$mod}", "{$mod}-", "($mod)", ">$mod<", ",$mod]");
		while(false !== ( $file = readdir($dir)) ) {
			if (( $file != '.' ) && ( $file != '..' )) {
				if ( is_dir($src.'/'.$file) ) {
					self::cdir($src.'/'.$file, $dst.'/'.$file, $mod);
				}else{
					$fobj = str_replace($aorg,$aobj,$file);
					$data = comFiles::get($src.'/'.$file);
					$data = str_replace($aorg,$aobj,$data);
					comFiles::put($dst.'/'.$fobj, $data);
				}
			}
		}
		closedir($dir);
	}

	// 修改文件
	static function cfiles($dir, $front, $mod){ 
		$title = basReq::val('title',"{$dir}App");
		// front
		$data = comFiles::get(DIR_ROOT.'/run/front.php');
		$data = str_replace(array("'demodir'","'./_paths.php'"),array("'$dir'","dirname(__FILE__).'/root/run/_paths.php'"),$data);
		comFiles::put(DIR_PROJ."/$front.php", $data);
		// vopfmt
		$data = comFiles::get(DIR_CODE.'/cfgs/excfg/ex_vopfmt.php');
		$flag = "\$_ex_vopfmt['tpl'] = array(".PHP_EOL;
		$icfg = "    '$dir' => array('$title','/$front.php'),".PHP_EOL.'    ';
		$data = preg_replace("/[$]_ex_vopfmt\[\'tpl\'\]\s{0,4}\=\s{0,4}array\(\s{0,4}/is", $flag.$icfg, $data);
		$data = str_replace(array("      '", ),array("    '", ),$data);
		comFiles::put(DIR_CODE.'/cfgs/excfg/ex_vopfmt.php', $data);
	}

	// modOpt
	static function modOpt($mod){ 
		$_groups = glbConfig::read('groups'); 
		$ops = '';
		foreach($_groups as $km=>$kv){
			if($kv['pid']=='docs'){
				$selected = $km==$mod ? 'selected' : '';
				$ops .= "\n<option value='$km' $selected>[$km]{$kv['title']}</option>";
			}
		}
		return $ops;
	}

}




/*******************************************************************************
 File : \code\core\sdev\devBase.php 
*******************************************************************************/
<?php

// ...类
class devBase{	

	// 显示一个文件里的一个func
	static function docFunc1($file,$fmeth){ 
		if(empty($file) || empty($fmeth)) return '';
		$res = self::docFuncs($file,1); 
		$arr = $res[0]; $str = $res[1];
		$f1 = $f2 = '';
		if($arr){
		foreach($arr as $no=>$func){ 
			if(strpos($func," $fmeth(")){
				$f1 = $func;
				$f2 = isset($arr[$no+1]) ? $arr[$no+1] : '';
				break;
			}
		}}
		if(empty($f1) || empty($str)) return '';
		$p1 = strpos($str,$f1); 
		$re = $f2 ? substr($str,$p1,strpos($str,$f2)-$p1) : substr($str,$p1);
		return $re;	
	}

	// 显示一个文件里的function
	static function docFuncs($file,$rea=0){ 
		$str = comFiles::get($file); $org = $str; 
		$str = preg_replace('/\/\*(.*?)\*\//is','',$str);
		preg_match_all("/((public|protected|private|static)\s+)*function\s+[0-9a-zA-Z_\$]{1,32}[^{]{0,96}/",$str,$m);
		if($rea) return array($m[0],$str);
		$re = ''; 
		if($m[0]){
		foreach($m[0] as $f){ 
			//$f = str_replace(array("\t"),array(" "),$f);
			$re .= "\n<li>$f</li>";
		}}
		return $re;	
	}
	
	//一个根目录下，所有子目录$subs里的类库文件
	static function docClass($root,$subs){
		$da = $subs; $nav = ""; $class = ',';
		$farr = array('.php','.js','.fun','.class'); 
		foreach($da as $dir){ 
			$nav .= "\n<ul class='ul'><b class='li'>$dir</b>";
			$handle = opendir("$root/$dir/");
			while($file = readdir($handle)) {
				if($file=='.'||$file=='..') continue;
				if(basArray::inStr(array('conf.','inc.',),$file)) continue;
				//if(in_array($file,array('conf.','inc.',))) continue;
				$fp = "$root/$dir/$file"; $forg = $file;
				$fext = strtolower(strrchr($file,'.'));
				$file = str_replace($farr,'',$file);
				if(in_array($file,array('index'))) continue;
				if(file_exists($fp) && in_array($fext,$farr)){
					echo "\n<a name='$file'></a>";
					echo "\n<ul><h3>$dir/$forg</h3>";
					echo self::docFuncs($fp);
					echo "</ul>";
					if(strstr($class,",$file,")){ 
						$sfile = "<span class='red' title='".lang('devbase_clsrepeat')."'>$file</span>";
					}else{
						$sfile = "$file";
						$class .= "$file,";
					}
					$nav .= "\n<li class='li'><a href='#$file'>$sfile</a></li>";
				}
			}
			closedir($handle);
			$nav .= "</ul>";
		}
		return $nav;
	}
	
	// 自动加命名空间
	static function nspList(){
		$root = DIR_CODE.'/core';
		$dirs = comFiles::listDir($root); 
		$subs = array_keys($dirs['dir']);
		$maps = array();
		foreach($subs as $dir){ 
			$handle = opendir("$root/$dir/");
			while($file = readdir($handle)) {
				if(!strstr($file,'.php')) continue;
				$fp = "$root/$dir/$file"; 
				if(file_exists($fp)){
					$class = str_replace('.php','',$file);
					if(in_array($class,array('index'))) continue;
					$maps[$class] = "core\\$dir"; 
				}
			}
			closedir($handle);
		} //print_r($maps);
		$ckeys = array_keys($maps); 
		$re = $tip = '';
		foreach($maps as $class=>$nsp){
			$file = '/'.str_replace("\\","/",$nsp)."/$class.php";
			$str = comFiles::get(DIR_CODE.$file); 
			$str = preg_replace(array("/#.*$/m","/\/\/.*$/m","/\/\*.*\*\//sU"),array('','',''),$str); //删除注释干扰
			$str = str_replace(array("class $class","$class.php","'$class'","\"$class\""),'',$str);
			$re .= "<ul>\n<b>$file : </b>";
			$re .= "\n<li>namespace $nsp;</li>";
			foreach($ckeys as $class2){
				if(strstr($str,$class2)){
					$ire = "\n<li>use $maps[$class]\\$class2;</li>"; 
					if($class==$class2){ 
						$tip .= "$ire --- ??? ";
					}else{
						$re .= "$ire"; 	
					}
				}
			}
			$re .= "\n</ul>";
		}
		$tip && $re = "$tip<hr>$re";
		return $re;
	}

	static function scanDblang(){
		$re = array();
		$path = DIR_DTMP."/dbexp";
		$lists = comFiles::listScan($path,'');
		foreach($lists as $file=>$fv){
			$tbfix = substr($file,5,4);
			$tbname = str_replace('.dbsql','',substr($file,5)); 
			if(!in_array(substr($file,5,4),array('base','bext'))) continue;
			$old = include(DIR_CODE."/lang/dbins/$tbname-cn.php");
			$data = comFiles::get("$path/$file");
			$arr = basStr::getMatch($data,'dbstr','c196');
			$arb = basArray::lenOrder($arr);
			echo "<br>\n<b>$file:</b><br>\n";
			for($i=15; $i>=1; $i--) { 
				if(empty($arb[$i])) continue;
				echo "&nbsp; &nbsp; // $i: <br>\n";
				foreach($arb[$i] as $val){
					if(in_array($val,$old)) continue;
					echo "&nbsp; &nbsp; '$val',<br>\n";
				}
			}
		}
	}
	static function scanCnchr($dir,$sdir=array(),$skip=array()){
		$re = array();
		$lists = comFiles::listScan($dir,'',$sdir);
		foreach($lists as $file=>$fv){
			if(!( strpos($file,'.php')||strpos($file,'.js')||strpos($file,'.htm') )) continue;
			if(in_array(str_replace('.php','',basename($file)),$skip)) continue;
			if(strpos($file,'-cn.')) continue;
			$data = comFiles::get("$dir/$file");
			$data = preg_replace('/\/\*(.*?)\*\//is','',$data);
			$data = preg_replace('/\/\/[^\r\n]+/is','',$data);
			$data = preg_replace("/<\!--.*?-->/is","",$data);
			$res = basStr::getMatch($data,'dbstr','c196');
			if(!empty($res)){
				echo "<b>$file</b><br>\n";
				dump($res);
			}
		}
	}
	static function scanInit($dir,$burl='',$sub=''){
		$re = array();
		$lists = comFiles::listScan($dir,'',array('tpls','a3rd','skin'));
		foreach($lists as $file=>$fv){
			if(!strpos($file,'.php')) continue;
			$url = "$burl/$file"; //echo "\n<br>$url,";
			self::scanCheck($url,$file,$re);
		}
		return $re;
	}
	static function scanMkvs($dir=''){
		$mkvs = vopTpls::entry($dir,'ehlist','all'); 
		$burl = vopTpls::etr1(1,$dir).'?'; 
		$re = array();
		foreach($mkvs as $mod=>$keys){ foreach($keys as $key=>$val){
			if($key=='m'){
				$mkv = $mod;
			}elseif($key=='first'){
				$mkv = ''; //?
			}else{
				$mkv = "$mod-$key";
			}
			if(empty($mkv)) continue;
			$url = "$burl$mkv"; //echo "\n<br>$url";
			self::scanCheck($url,$mkv,$re);
		}} //die();
		return $re;
	}
	static function scanCheck($url,$key,&$re){
		$data = comHttp::doGet($url,3); 
		$taga = array('Fatal error','Warning','Notice');
		foreach($taga as $tag){
			$tag = "<b>$tag</b>:";
			if(strstr($data,$tag)){
				$detail = basElm::getPos($data,array($tag,'<br />'));
				$detail = basDebug::hidInfo($detail);
				$re[$key] = "<a href='$url'>$tag</a>$detail";	
			}
		}		
	}

	static function dbDict($tabinfo=array()){
		$db = glbDBObj::dbObj();
		if(empty($tabinfo)) $tabinfo = $db->tables(1); 
		$tdoc = comFiles::get(DIR_CODE.'/cfgs/stinc/is_dbdoc.htm'); 
		$ttab = comFiles::get(DIR_CODE.'/cfgs/stinc/is_dbtab.htm');
		$slist = $tlist = ''; 
		$clist = '<tr><td>'.lang('core.dbdict_table').'</td><td>'.lang('core.dbdict_field').'</td></tr>'; 
		foreach($tabinfo as $tab=>$r){ 
			$ra=''; $tabid = $r['Name']; $rows = $r['Rows'];
			$tblfields = glbDBExt::dbComment($tabid);
			$tabrem = empty($tblfields[0]['_rem']) ? "<span class='dfCCC'>$tabid</span>" : $tblfields[0]['_rem'];
			unset($tblfields[0]); $i=0;
			foreach($tblfields as $fk=>$fv){
				$frem = empty($fv['_rem']) ? "<span class='dfCCC'>(null)</span>" : $fv['_rem'];
				$ra .= "<tr><td>{$fv['name']}</td><td>$frem</td><td>{$fv['type']}</td><td>{$fv['notnull']}</td><td>{$fv['autoinc']}</td><td>{$fv['default']}</td></tr>\n";
			} 
			$slist .= str_replace(array('{fields}','{tabid}','{tabname}','{rows}'),array($ra,$tabid,$tabrem,$rows),$ttab);
			$tlist .= "<a href='#$tabid'>".($tabrem ? $tabrem : $tabid)."</a>\n"; 
		}
		$org = array('{tablists}','{tabmap}','{tabcnt}','{sysname}','{dict-title}');
		$obj = array($slist,$tlist,count($tabinfo),cfg('sys_name'),lang('core.dbdict_title'));
		$data = str_replace($org,$obj,$tdoc); 
		//$lang = $_cbase['sys']['lang']; 
		$data = devData::dataImpLang($data,'base_model,base_fields,bext_dbdict');
		return $data;	
	}

	static function _tabHead($tab,$fix=array('{pre}','{ext}'),$type='INSERT'){
		$head = "\n-- {$tab}@".date('Y-m-d H:i:s')." -- \n";
		$head .= "$type INTO `$fix[0]{$tab}$fix[1]` VALUES \n";
		return $head;
	}
	static function _loadOpt($type=1){
		return "FIELDS TERMINATED BY ','OPTIONALLY ENCLOSED BY '''' LINES TERMINATED BY '\n' ";
	}
	static function _dinsRow($row){
		$sql = "(";
		$values = array();
		foreach ($row as $value) {
			$values[] = basNodef::quoteSql($value);
		}
		$sql .= implode(',',$values).")";
		return $sql;
	}
	static function _drndData($str){
		for($i=0;$i<2;$i++){
			$str = basKeyid::kidRTable('0','rnd',$str);
			$str = basKeyid::kidRTable('A','rnd',$str);
			$str = basKeyid::kidRTable('a','rnd',$str);
		}
		return $str;
	}
	
	// $cfgs : 'userfiles,weituos,aalbums'
	// $cfgs : array('userfiles,weituos,aalbums','archives_','base_')
	static function _tabIncfg($tab,$cfgs=''){ 
		if(empty($cfgs)) return 1; 
		$cfgs = is_string($cfgs) ? array($cfgs) : $cfgs; 
		if(isset($cfg['__ufuncs'])){
			$func = $cfg['__ufuncs'];
			return $func($tab,$cfgs);
		} 
		foreach($cfgs as $val){ 
			if(strstr($val,',')){ 
				if(strpos("(,$val,)",",$tab,"))	return 1;
			}elseif(strpos($val,'_')){
				if(substr($tab,0,strlen($val))==$val) return 1;
			}else{
				if($val==$tab) return 1;
			}
		}
		return 0; 
	}
	
	static function _tabGroup($tabinfo=''){
		if(!$tabinfo){
			$db = glbDBObj::dbObj();
			$tabinfo = $db->tables(); 
		}
		$re = array(); $fixa = array('-1'); 
		foreach($tabinfo as $row){
			$itab = empty($row['Name']) ? $row : $row['Name'];
			$fix = substr($itab,0,strpos($itab,'_'));
			if(!in_array($fix,$fixa)){ 
				$re[] = $fixa[] = $fix;
			}
		}
		return $re;
	}

	static function typChkall(){
		$groups = glbConfig::read('groups');
		$res = array();
		foreach($groups as $key=>$val){
			if($val['pid']=='types'){
				$irep = self::typCheck($key);
				$irep && $res[$key] = $irep;
			}
		}
		return $res;
	}
	static function typCheck($key){
		$mcfg = glbConfig::read($key); 
		$done = array('-1'); $re = '';
		foreach($mcfg['i'] as $k1=>$v1){
			$rs = '';
			foreach($mcfg['i'] as $k2=>$v2){
				if($k1==$k2) continue;
				if(strstr($k2,$k1) || strstr($k1,$k2)){ 
					if(!(in_array($k1,$done) && in_array($k2,$done))){
						$rs .= ",$k2-$v2[title]";
						$done[] = $k1;
						$done[] = $k2;
					}
				}
			}
			if($rs) $re .= "$k1-$v1[title]$rs ; ";
		} //print_r($citys);
		return $re;
	}

	static function xx(){
		$sy_sids = glbConfig::read('sysids','sy');
		return $re;
	}
	

}




/*******************************************************************************
 File : \code\core\sdev\devData.php 
*******************************************************************************/
<?php

// ...类
class devData{	

	static $spsql = "---<split>---";

	// runSql
	static function run1Sql($sql,$rep=''){
		if(empty($sql)) return true;
		$db = glbDBObj::dbObj(); 
		//if($rep=='Update'){
			$sql = str_replace("INSERT INTO `{pre}","REPLACE INTO `{pre}",$sql); 
		//}
		$sp = self::$spsql;
		$sql = str_replace(array("`{pre}","{ext}`"),array("`$db->pre","$db->ext`"),$sql);
		$arr = strpos($sql,$sp)>0 ? explode($sp,$sql) : array($sql);
		try {
			$n = 0;
			foreach ($arr as $key => $sql) {
				$db->query($sql,'run'); 
				$n++;
			}
			return $n;
		}catch (Exception $e){ 
			return $e->getMessage();
		}
	}

	// 导出一个模型数据
	static function exp1Mod($mod,$expdt=1){
		if(empty($mod)) return array();
		$data['model_'.$mod] = self::exp1Tab('base_model',"kid='$mod'"); 
		$data['fields_'.$mod] = self::exp1Tab('base_fields',"model='$mod'"); 
		$data['catalog_'.$mod] = self::exp1Tab('base_catalog',"model='$mod'"); 
		$data['grade_'.$mod] = self::exp1Tab('base_grade',"model='$mod'"); 
		$data['fldext_'.$mod] = self::exp1Tab('bext_fields',"model='$mod'"); 
		$tabm = glbDBExt::getTable($mod,0);
		$tabe = glbDBExt::getTable($mod,1);
		$tabs = $tabm==$tabe ? $tabm : "$tabm,$tabe";
		$tarr = explode(',',$tabs);
		foreach ($tarr as $k=>$tab) {
			$data['stru_'.$tab] = self::exp1Tab($tab,'_stru_');
			$expdt && $data['data_'.$tab] = self::exp1Tab($tab);
		}
		return $data;
	}

	// 导出一个表数据:部分数据+表结构
	static function exp1Tab($tab,$whr=''){
		if(empty($tab)) return '';
		$db = glbDBObj::dbObj();
		if($whr=='_stru_'){
			$flag2 = "CREATE TABLE `";
			$ctmp = self::stru1Exp($tab);
			$ctmp = str_replace("$flag2","\n\n".self::$spsql."\n\n$flag2",$ctmp); 
			return $ctmp;
		}
		$shead = $sins = "";
		$list = $db->table($tab)->where($whr)->select(); 
		if($list){ //分块未考虑... 
			$shead = devBase::_tabHead($tab); $i = 0; 
			foreach($list as $row){
				$i++; $end = $i==count($list) ? ';' : ',';
				$sins .= devBase::_dinsRow($row)."$end\n";
			}
		}
		return $shead.$sins;
	}
	
	// struExp('/dbexp/');导出结构到文件或返回string
	static function struExp($path,$dbcfg=array()){ 
		$db = glbDBObj::dbObj($dbcfg);
		$dbTabs = $db->tables();
		$re = "";
		foreach($dbTabs as $tab){ 
			$re .= "\n".self::stru1Exp($tab,$dbcfg).";\n";
		}
		if($path){
			$path = DIR_DTMP.$path.'_stru_tables.dbsql';
			comFiles::put($path,$re);
		}else{
			return $re;
		}
	}
	
	// stru1Exp('tablename'); 导出单个表结构
	static function stru1Exp($tab,$dbcfg=array()){ 
		$db = glbDBObj::dbObj($dbcfg);
		$tabfull = $db->pre.$tab.$db->ext; 
		$stru = "DROP TABLE IF EXISTS `{pre}$tab{ext}`;";
		$stru .= "\n".$db->create($tab); 
		$stru = str_replace("`$tabfull`","`{pre}$tab{ext}`",$stru);
		return $stru;
	}
	
	// struImp('/dbexp/'); 从文件导入结构
	static function struImp($path){
		$db = glbDBObj::dbObj(); 
		$file = DIR_DTMP.$path.'_stru_tables.dbsql';
		$data = comFiles::get($file);
		$fix1 = 'DROP TABLE IF EXISTS `'; 
		$fix2 = 'CREATE TABLE `';
		$pre = '{pre}'; $suf = '{ext}';
		$arr = explode($fix1.$pre,$data);
		$errs = array(); $oks = 0;
		foreach($arr as $sql){
		if(strstr($sql,$fix2.$pre)){
			$sql = $fix1.$pre.$sql;
			$arr2 = explode($fix2.$pre,$sql);
			$sqla = $arr2[0];			 $sqla = str_replace(array($pre,$suf),array($db->pre,$db->ext),$sqla);
			$sqlb = "$fix2$pre".$arr2[1]; $sqlb = str_replace(array($pre,$suf),array($db->pre,$db->ext),$sqlb);
			#echo " \n \n <br>$sqla \n <br>$sqlb";
			try {
				$db->query($sqla,'run');
				$db->query($sqlb,'run');
				$oks++;
			}catch (Exception $e){
				$errs[] = $e->getMessage();
			}
		} }
		return array($oks,$errs);
	}
	
	// 
	static function dataExpGroup($path,$dbcfg=array(),$pfull=0){
		$db = glbDBObj::dbObj($dbcfg);
		$dbTabs = $db->tables(); 
		$fix = array($db->pre,$db->ext); //array('{pre}','{ext}')
		$groups = devBase::_tabGroup($dbTabs); 
		foreach($groups as $group){ 
			$cfgs = array("{$group}_"); $data = '';
			foreach($dbTabs as $tab){ 
				$flag = devBase::_tabIncfg($tab,$cfgs); 
				if(empty($cfgs) || $flag){ 
					$tabfull = $db->pre.$tab.$db->ext; 
					$list = $db->table($tab)->select(); 
					if($list){ 
						$thead = devBase::_tabHead($tab,$fix,'REPLACE'); 
						$tdata = ''; $i = 0;  
						foreach($list as $row){
							$i++; $end = $i==count($list) ? ';' : ',';
							$tdata .= devBase::_dinsRow($row)."$end\n";
						}
						if($tdata) $data .= "$thead$tdata";
			}	}	}
			if(!empty($data)){
				$pathi = $pfull ? $path : DIR_DTMP.$path;
				$fp = fopen(str_replace("\\","/",$pathi."$group.dbsql"), 'w');
				fwrite($fp, $data);
				fclose($fp);
			}
		} //groups
	}
	
	// dataExp('/dbexp/'); 导出指定表(所有表)数据
	static function dataExp($path,$cfgs='',$mode='in',$dbcfg=array(),$pfull=0){
		$db = glbDBObj::dbObj($dbcfg);
		$dbTabs = $db->tables();
		$groups = devBase::_tabGroup($dbTabs); 
		if(empty($cfgs)){
			$cfgs = '';
		}elseif(is_string($cfgs)){
			$cfgs = in_array($cfgs,$groups) ? "{$cfgs}_" : $cfgs;
		}// is_array
		foreach($dbTabs as $tab){ 
			$flag = devBase::_tabIncfg($tab,$cfgs); 
			if(empty($cfgs) || ($flag && $mode=='in') || (!$flag && $mode=='notin')){
				self::data1ExpInsert($path,$tab,$dbcfg,$pfull); 
			}
		}
	}	
	
	// data1Exp("/dborg/data~",'base_fields'); 导出单个表数据到文件
	static function data1ExpInsert($path,$tab,$dbcfg=array(),$pfull=0){
		$db = glbDBObj::dbObj($dbcfg);
		$tabfull = $db->pre.$tab.$db->ext; 
		$path = $pfull ? $path : DIR_DTMP.$path;
		$list = $db->table($tab)->select(); 
		if($list){ //分块未考虑... 
			$shead = devBase::_tabHead($tab); $i = 0; 
			$fp = fopen(str_replace("\\","/",$path."$tab.dbsql"), 'w');
			fwrite($fp, $shead);
			foreach($list as $row){
				$i++; $end = $i==count($list) ? ';' : ',';
				$rstr = devBase::_dinsRow($row)."$end\n";
				fwrite($fp, $rstr);
			}
			fclose($fp);
		}
	}
	
	// data1ExpFile("/dborg/data~",'base_fields'); 导出单个表数据到文件
	static function data1ExpFile($path,$tab,$dbcfg=array()){
		$db = glbDBObj::dbObj($dbcfg);
		$tabfull = $db->pre.$tab.$db->ext; 
		$path = DIR_DTMP.$path;
		try{
			$file = str_replace("\\","/",$path."$tab.dbsql"); 
			$sql="SELECT * FROM {$tabfull} INTO OUTFILE '$file' ".devBase::_loadOpt();
			if(file_exists($file)){
				unlink($file);
			}
			$db->query($sql,'run');
			$data = comFiles::get($file);
			if(empty($data)){
				unlink($file);
			}
			return true;
		}catch(Exception $e){
			#print_r($e->getMessage());;
			return false;
		}
	}
	
	// dataImpFile("/dborg/data~",'base_fields'); 从文件导入数据
	static function dataImpFile($path,$tab,$dtmp=0){
		$db = glbDBObj::dbObj(); 
		$tabfull = $db->pre.$tab.$db->ext;
		$path = ($dtmp ? $dtmp : DIR_DTMP).$path;
		$file = str_replace("\\","/",$path."$tab.dbsql"); 
		$sqlClean = "DELETE FROM $tabfull";
		$sqlLoad = "LOAD DATA INFILE '$file' INTO TABLE $tabfull ".devBase::_loadOpt();
		$sqlLoad = self::dataImpLang($sqlLoad,$tab);
		try {
			$db->query($sqlClean,'run');
			$db->query($sqlLoad,'run');
			return true;
		}catch (Exception $e){
			return false;
		}	  
	}
	
	// dataImpInsert("/dborg/data~",'base_fields'); 从文件导入数据
	static function dataImpInsert($path,$tab,$dtmp=0){
		$db = glbDBObj::dbObj(); 
		$tabfull = $db->pre.$tab.$db->ext;
		$path = ($dtmp ? $dtmp : DIR_DTMP).$path;
		$file = str_replace("\\","/",$path."$tab.dbsql"); 
		$fsql = comFiles::get($file);
		if(empty($fsql)){
			return false;
		}
		$sqlClean = "DELETE FROM $tabfull";
		$sqlLoad = str_replace(array("`{pre}{$tab}{ext}`"),array("`$tabfull`"),$fsql);
		$sqlLoad = self::dataImpLang($sqlLoad,$tab);
		try {
			$db->query($sqlClean,'run');
			$db->query($sqlLoad,'run');
			return true;
		}catch (Exception $e){
			return false;
		}	  
	}

	static function dataImpLang($sql,$tabs){
		$lang = cfg('sys.lang');
		if($lang!=='cn'){ 
			$taba = explode(',',$tabs);
			$rcn = $ren = array();
			foreach ($taba as $tab) {
				$cnlang = DIR_CODE."/lang/dbins/$tab-cn.php"; 
				$oblang = DIR_CODE."/lang/dbins/$tab-$lang.php"; 
				if(file_exists($oblang)){
					$rcn[$tab] = include($cnlang); 
					$ren[$tab] = include($oblang); 
				}else{
					return $sql;
				}
			}
			for($i=15; $i>=1; $i--) { 
				foreach ($taba as $tab) {
					$tmp = basArray::lenParts($rcn[$tab],$ren[$tab],$i);
					if(!empty($tmp[0])){
						$sql = str_replace($tmp[0],$tmp[1],$sql); 
						//dump($tmp);
					} 
				}
			}
		}
		return $sql;
	}

}




/*******************************************************************************
 File : \code\core\sdev\devRun.php 
*******************************************************************************/
<?php

define('FLAGYES', '<span style="color: #008000; font-weight : bold;">&#10004;<!--isYes--></span>');
define('FLAGNO', '<span style="color: #ff0000; font-weight : bold;">&#10008;<!--isNo--></span>');
define('MINPHPVER', '5.2');

// ...类
class devRun{	
	
	static $sfixpath = '/store/_setfix_path.txt'; 
	static $sfixidpw = '/store/_setrnd_idpw.txt'; 

	// prootGet
	static function prootGet(){
		$path = substr(__FILE__,strlen($_SERVER['DOCUMENT_ROOT'])); 
		//DOCUMENT_ROOT = E:\webs 或 /home/bae/app/
		$file = 'code/core/sdev/devRun.php'; 
		$path = str_replace(array("\\","/$file","$file"),array("/",'',''),$path);
		return $path;
	} 
	// prootFix
	static function prootFix($proot){
			$fpath = DIR_DTMP.self::$sfixpath;
			if(file_exists($fpath)) return false; //只修正一次
			$data = comFiles::get(DIR_ROOT."/run/_paths.php");
			$fix = "define('PATH_PROJ'"; 
			$data = str_replace("$fix,","$fix, '$proot'); #Old: ",$data);
			$fres = comFiles::put(DIR_ROOT."/run/_paths.php",$data);
			if($fres && !empty($data)){
				$re = 1;
				comFiles::put($fpath,date('Y-m-d H:i:s')); 
			}else{
				$re = 0;
			}
			return $re;
	} 
	// prootMsg
	static function prootMsg($proot, $fixres){
		$re = array();
		$exmsg = empty($proot) ? lang('devrun_tipr1') : lang('devrun_tipr2');
		$exupd = "<a href='?' style='color:blue;float:right' target='_top'>".lang('devrun_upd')."</a>";
		$exok = lang('devrun_fixpararm')."(/root/run/_paths.php): <br>define('PATH_PROJ', '$proot');";
		$exng = lang('devrun_file')."(/root/run/_paths.php), ".lang('devrun_setpath')."<br>define('PATH_PROJ', '$proot');";
		if($fixres=='FixPrOkey'){
			$re['msg'] = "$exok $exupd <br>$exmsg : ".lang('devrun_upding');
			$re['tip'] = FLAGYES;
		}else{ // FixPrError
			$re['msg'] = "$exng $exupd <br>$exmsg";
			$re['tip'] = FLAGNO;
		}
		return $re;
	} 

	static function startCheck(){ 
		$umsg = array(); 
		// php版本
		$pver = MINPHPVER;
		if(version_compare(PHP_VERSION,$pver,'<')){
			$umsg['vphp']['msg'] = lang('devrun_needenv')." PHP V{$pver}+";
			$umsg['vphp']['tip'] = FLAGNO;
		}

		// db配置
		$_cfgs = glbConfig::read('db','cfg'); 
		$dbcls = $_cfgs['db_class'];
		if($dbcls=='pdox'){
			$dbflag = class_exists('PDO');
		}else{
			$dbflag = function_exists("{$dbcls}_connect");
		}
		// mysql扩展
		$exlib = array('mysqli'=>'mysqli','mysql'=>'mysql','pdox'=>'pdo_mysql');
		if(!$dbflag){
			$umsg['mysql']['msg'] = lang('devrun_my3a',$exlib[$_cfgs['db_class']]).lang('devrun_my3b')."(/code/cfgs/boot/cfg_db.php)，<br>".lang('devrun_my3c')."\$_cfgs['db_class'] = 'mysqli,mysql,pdox'; //".lang('devrun_my3d');
			$umsg['mysql']['tip'] = FLAGNO; 
		}
		// gd2扩展
		if(!function_exists('gd_info')){
			$umsg['gd2']['msg'] = lang('devrun_gd2')."<br>extension=php_gd2.dll";
			$umsg['gd2']['tip'] = FLAGNO;
		}
		// 重置辅助调试工具账号密码
		if(!file_exists($fpath=DIR_DTMP.self::$sfixidpw)){
			$cfgs = glbConfig::read('pubcfg','sy');
			$key = 'cfgs/boot/cfg_adbug.php';
			$rep = $cfgs['cdemo']["code/$key"];
			$data = comFiles::get(DIR_CODE."/$key-cdemo");
			$data = str_replace($rep[0],$rep[1],$data);
			comFiles::put(DIR_CODE."/$key",$data);
			comFiles::put($fpath,date('Y-m-d H:i:s')); 
		}
		return $umsg;
	}

	static function startDbadd($dbname){ 
		$_cfgs = glbConfig::read('db','cfg'); 
		foreach($_cfgs as $k=>$v){
			if(!empty($_POST[$k])) $_cfgs[] = $_POST[$k];
		}
		$type = $_cfgs['db_class'];
		$sql = "CREATE DATABASE `$dbname` COLLATE 'utf8_general_ci';";
		if($type=='pdox'){
			$dsn = 'mysql:host='.$_cfgs['db_host'].';dbname='.$_cfgs['db_name'].'';
			$idb = new PDO( $dsn, $_cfgs['db_user'], $_cfgs['db_pass']); 
			$re = $idb->query($sql);
		}elseif($type=='mysqli'){
			$link = mysqli_connect($_cfgs['db_host'], $_cfgs['db_user'], $_cfgs['db_pass']);
			$re = mysqli_query($link,$sql);
		}elseif($type=='mysql'){ 
			$link = mysql_connect($_cfgs['db_host'], $_cfgs['db_user'], $_cfgs['db_pass']);
			$re = mysql_query($sql,$link);
		}else{
			$re = false;
		}	
		return $re;	
	}
	
	// runPHPVer测试, 
	static function verPHP(){ 
		$info = PHP_VERSION.' (SAPI:'.PHP_SAPI.')';
		$res = version_compare(PHP_VERSION,MINPHPVER,">") ? FLAGYES : FLAGNO;
		$tip = 'V5.2+, '.lang('devrun_phpvbest').' V5.3+';
		$status = array('title'=>lang('devrun_phpver'),'info'=>$info,'res'=>$res,'tip'=>$tip);
		return $status;
	}
	
	// verGdlib
	static function verGdlib() { 
		if(!function_exists('gd_info')) return array('title'=>'GD library','info'=>'-','res'=>FLAGNO,'tip'=>'V2.0+');
		$info = gd_info(); //print_r($info);
		$ver = preg_replace("/[^\d\.]/",'',$info['GD Version']); 
		$res = version_compare($ver,"2.0",">") ? FLAGYES : FLAGNO;
		$status = array('title'=>'GD library','info'=>$info['GD Version'],'res'=>$res,'tip'=>'V2.0+','demo'=>'?act=image');
		return $status;
	}
	
	// runRemote
	static function runRemote() { 
		$a = array('curl_init','fsockopen','file_get_contents');
		$f1 = $f2 = '';
		foreach($a as $k){ 
			$f1 .= function_exists($k) ? ($f1 ? ', ' : '')."$k" : "";
			$f2 .= function_exists($k) ? "" : ($f2 ? ', ' : '')."$k";
		}
		$res = $f1 ? FLAGYES : FLAGNO;
		$status = array('title'=>'Remote(3)','info'=>$f1?$f1:'-','res'=>$res,'tip'=>$f2?$f2:'','demo'=>'?act=remote');
		return $status;
	}
	
	// runPath测试, 
	static function runPath($key){ 
		$cfgs = glbConfig::read('pubcfg','sy');
		$dhid = dirname(DIR_PROJ);
		$re = array();
		foreach($cfgs['dirs'] as $key=>$dir){
			if(in_array($key,array('code','root'))) continue;
			$ukey = strtoupper($key);
			$file = "/@setup_flag.txt"; 
			$dconst = get_defined_constants(1);
			$dir = $dconst['user']["DIR_$ukey"];
			$path = $dconst['user']["PATH_$ukey"];  //is_dir
			@$datad = comFiles::get($dir.$file);
			@$datap = file_get_contents('http://'.$_SERVER['HTTP_HOST'].$path.$file);
			if($datad && $datap && $datad==$datap){
				$stat = FLAGYES;
			}else{
				$stat = FLAGNO;	
			} 
			if(in_array($key,array('dtmp','ures','html'))){
				$fwrite = comFiles::canWrite($dir);
				if(!$fwrite){
					$stat = str_replace('<!--isNo-->',lang('devrun_notwrite'),FLAGNO);		
				} 
			}
			$re[] = array('ukey'=>$ukey,'dir'=>str_replace($dhid,"{...}",$dir),'path'=>$path,'res'=>$stat);
		} 
		return $re;
		
	}
	
	// Mysql测试, 
	static function runMydb3($dbcfgs=array()){ 
		$a = array('mysqli'=>array(),'mysql'=>array(),'pdo'=>array());
		if(empty($dbcfgs)){
			$_cfgs = glbConfig::read('db','cfg'); 
		}else{
			$_cfgs = $dbcfgs; 
		}
		foreach($_cfgs as $k=>$v){
			if(!empty($_POST[$k])) $_cfgs[] = $_POST[$k];
		}
		$type = 'pdo'; 
		if(!class_exists($type)){
			$a[$type] = array('res'=>FLAGNO,'info'=>lang('devrun_extendset',$type));
		}else{
			$a[$type] = array('res'=>FLAGYES,'info'=>''); //支持pdo扩展
			try{
				$dsn = 'mysql:host='.$_cfgs['db_host'].';dbname='.$_cfgs['db_name'].'';
				@$pdo = new PDO( $dsn, $_cfgs['db_user'], $_cfgs['db_pass']); //print_r($pdo);
				// PDO::ATTR_DRIVER_NAME, PDO::ATTR_SERVER_VERSION, PDO::ATTR_SERVER_VERSION
				$info = " OK : ".$pdo->getAttribute(PDO::ATTR_SERVER_VERSION)."; OK : {$_cfgs['db_name']}";
			}catch(PDOException $e){
				$info = ' - '.$e->getMessage().' - ';
			}
			if(!strstr($info,'; OK :')){
				$a[$type]['res'] = $stat = FLAGNO;	
			}
			$a[$type]['info'] = $info;
		}
		//return $a;
		$myext = array('mysqli'); 
		if(strnatcmp(PHP_VERSION, '5.5.0')<0){ $myext[] = 'mysql'; }
		else { unset($a['mysql']); } 
		foreach($myext as $type){
			$fconn = "{$type}_connect";
			$finfo = "{$type}_get_server_info";
			$ferrno = "{$type}_errno"; 
			$ferror = "{$type}_error";
			if(!function_exists($fconn)){
				$a[$type] = array('res'=>FLAGNO,'info'=>lang('devrun_extendset',$type));
			}else{
				$a[$type] = array('res'=>FLAGYES,'info'=>""); //支持type
				$link = @$fconn($_cfgs['db_host'], $_cfgs['db_user'], $_cfgs['db_pass']);
				@$info = $link ? " OK : ".$finfo($link) : " [".$ferrno($link)."] ".$ferror(); 
				@$_erno = $ferrno($link);
				if($link && empty($_erno)){
					$dbflag = $type=='mysql' ? @mysql_select_db($_cfgs['db_name'],$link) : @mysqli_select_db($link,$_cfgs['db_name']);
					if($dbflag){
						$info .= "; OK : {$_cfgs['db_name']}";
					}else{
						$info = " - [".$ferrno($link)."] ".$ferror($link).' - '; 
					}
				}else{
					$info = lang('devrun_linkmysqlerr'); 
				}
				if(!strstr($info,'; OK :')){
					$a[$type]['res'] = $stat = FLAGNO;	
				}
			}
			$a[$type]['info'] = @$info;
		}
		return $a;
	}
	
	// GD2测试, self::runGdlib()
	static function runGdlib(){ 
		$w = 240; $h = 180; $im = imagecreate($w,$h);
		imagefill($im,0,0,imagecolorallocate($im,245,245,245)); //背景
		for($i=0;$i<5;$i++){
			$ctab = strtoupper(KEY_TAB24); 
			$char = $ctab{mt_rand(0,strlen($ctab)-1)}; 
			$color = imagecolorallocate($im,rand(100,255),rand(0,100),rand(100,255));
			$xPos=rand(5,21);
			$yPos=rand(30,90);
			imagestring($im,5,10+$i*40+$xPos,$yPos,$char,$color);
		}
		for($i=0;$i<180;$i++){ //加入干扰象素
			$color = imagecolorallocate($im,rand(0,255),rand(0,255),rand(0,255));
			imagesetpixel($im,rand(10,$w-10),rand(10,$h-10),$color);
		} 
		imagerectangle($im,0,0,$w-1,$h-1,imagecolorallocate($im,rand(30,240),rand(30,240),rand(30,240)));
		header("Content-type: image/png");
		imagepng($im); imagedestroy($im);
	}
	
	// 内存测试, self::runMemory($inpval)
	static function runMemory($max){ 
		$timer = microtime(1);
		$t = 'Test string : memory_get_usage! ';
		$sUnit = ''; // *32=1M
		for($i=0;$i<1024*16;$i++) $sUnit .= $t;
		$mbit = ($max-1)*1024*1024; $t = '';
		while($max){
			$t .= $sUnit; $m = memory_get_usage(); 
			if($m>$mbit){
				$timer = round(microtime(1)-$timer,3);
				$len = round(strlen($t)/1000/1000,3);
				return "\nMemory test(".round($m/1024/1024,3)."/{$max}M) is OK! len:{$len}M/$timer(s).";
			}
		}
	}
	
	static function bomScan($bomroot,$rsub='',$flag=0) {  
		if(empty($rsub)) return;
		static $frstr,$bonum; 
		if(empty($frstr)){ 
			$frstr = "\n<ul>\n<li><b> ====== [root]: ====== </b></li>\n";
			$bonum = 0;
		}
		$full = "$bomroot/$rsub";
		$handle = opendir($full);
		while($file=readdir($handle)){ //echo "<br>aa:$file";
			if(in_array($file,array('.','..','.svn',))) continue;
			$bonum++; if($bonum>1000) die("<p>".lang('devrun_tmfiles')."</p>");
			if(is_dir("$full/$file")){
				$real = basDebug::hidInfo(realpath("$full/$file"));
				echo "\n<ul>\n";
				echo "<li><b>$real:</b></li>\n";
				self::bomScan($full,$file,$flag+1);
				echo "</ul>\n";
			}else{
				$fext = strtolower(strrchr($file,'.'));
				$fskip = array('.gif','.jpg','.jpeg','.png','.swf','.flv','.avi','.mpg','.doc','.docx','.zip','.rar','.gz');
				$size = round(filesize("$full/$file")/1024*100)/100 .' KB';
				$sutf = in_array($fext,$fskip) ? '' : self::bomCheck($full,$file);
				$ifile = "<li>$file <i class='size'>($size)</i>$sutf</li>\n";
				if(!$flag) $frstr .= $ifile;
				else echo $ifile;
			}
		}
		if(!$flag) echo "$frstr</ul>\n";
		closedir($handle);
	}
	static function bomDetect($data) {  
		$charset[1] = substr($data, 0, 1);  
		$charset[2] = substr($data, 1, 1);  
		$charset[3] = substr($data, 2, 1);  
		if (ord($charset[1]) == 239 && ord($charset[2]) == 187 && ord($charset[3]) == 191) return true;
		return false;
	}  
	static function bomCheck($now,$file) {   
		$bomroot = @$_GET['bomroot'];
		$bompath = @$_GET['bompath'];
		if(!file_exists("$now/$file")) return;
		$fp = fopen("$now/$file","r"); $data = fread($fp,8192); fclose($fp); 
		$fbom = self::bomDetect($data);
		$cset = mb_detect_encoding($data,array('ASCII','GB2312','BIG5','GBK','UTF-8'));
		$reutf8 = $cset=='UTF-8' ? "<i class='utf8'>[UTF-8]</i>" : '';
		$reubom = $fbom ? "<i class='red'>[BOM]</i>" : '';
		if($reubom && filesize("$now/$file")<=10*1024*1024 && !strstr($file,'.(bak)')){
			$bomfile = str_replace($bomroot,'',"$now/$file");
			$reubom = "<a href='?act=bomcheck&bomroot=$bomroot&bompath=$bompath&bomfile=$bomfile'>$reubom</a>";	
		}
		return "$reutf8$reubom";
	} 
	static function bomRemove($file) {  
		$filename = str_replace('//','/',"$file");
		$data = comFiles::get($filename); 
		$fbom = self::bomDetect($data);  
		if($fbom){ 
			$orgext = strrchr($file,'.'); 
			$objext = str_replace('.','.(bak)',$orgext); 
			$objname = str_replace($orgext,$objext,$filename); 
			copy($filename,$objname); //有BOM才备份
			$data = substr($data,3);  
			$filenum = fopen($filename,"w");  
			flock($filenum, LOCK_EX);  
			fwrite($filenum, $data);  
			fclose($filenum); 
			return true; 
		}
		return false;
	} 

}




/*******************************************************************************
 File : \code\core\sdev\devScan.php 
*******************************************************************************/
<?php

// ...类
class devScan{	

	// cdbStrus(); // 无主索引数据表, varchar(>255)字段, 组合索引数据表 检测
	static function cdbStrus($part){
		$db = glbDBObj::dbObj();
		$tabs = $db->tables();
		$re = ''; $ns = ''; $np = 0;
		foreach($tabs as $tab){ 
			$fa = $db->fields($tab);
			foreach($fa as $k=>$v){ //print_r($v);
				$len = str_replace(array('varchar(',')'),'',$v['type']); 
				if(strstr($v['type'],'varchar(') && intval($len)>255) $ns .= ",$k($len) "; 
				if(!empty($v['primary'])) $np++; 
			}
			if($part=='cdbV255' && $ns) $re .= "\n<br>$tab : ".substr($ns,1);
			if($part=='cdbPKey' && !$np) $re .= "\n<br>$tab : $np(PRIMARY)";
			if($part=='cdbMKey' && $np>1) $re .= "\n<br>$tab : $np(PRIMARY)";
			$ns = ''; $np = 0;
		}
		return $re;
	}	
	
	// clrTmps();
	static function clrTmps(){
		$arr = array('@test','@udoc','dbexp','debug','cache','update','weixin'); // 
		foreach($arr as $dir){
			comFiles::delDir(DIR_DTMP."/$dir",0);
		}
		comFiles::put(DIR_DTMP.updBase::$prereset,"done=locked");
		//comFiles::delDir(DIR_URES,0); //,"@setup_flag.txt"
		//comFiles::delDir(DIR_HTML,0);
	}	
	
	// clrLogs();
	static function clrLogs(){
		$db = glbDBObj::dbObj();
		$stnow = time();
		// 432000=5day, 86400=1天 active_online
		$db->table('active_admin')->where("stime<'".($stnow-86400)."'")->delete(); 
		$db->table('active_online')->where("stime<'".($stnow-86400)."'")->delete(); 	
		$db->table('active_session')->where("exp<'".($stnow-3600)."'")->delete();
		$logtabs = array(
			'logs_dbsql','logs_syact','logs_detmp','logs_jifen',
			'plus_smsend','plus_emsend','plus_paylog',
			'exd_crlog','exd_oilog','exd_pslog','xtest_keyid',
		);
		foreach($logtabs as $tab){
			$db->table($tab)->where("atime<'".$stnow."'")->delete();
		}
		$tabinfo = $db->tables(); //print_r($tabinfo);
		$db->table('bext_dbdict')->where("tabid NOT IN('".implode("','",$tabinfo)."')")->delete();
		foreach(array('wex_locate','wex_msgget','wex_msgsend','wex_qrcode') as $tabid){
			$db->table($tabid)->where("atime<'".($stnow-3600)."'")->delete();
		}
	}

	// clrCTpl(); //advs, tagc, 
	static function clrCTpl($part=''){
		if(empty($part)){
			$vcfgs = vopTpls::etr1('tpl'); 
		}else{
			$vcfgs = array("_$part"=>'');	
		}
		foreach($vcfgs as $dir=>$suit){ 
			comFiles::delDir(DIR_DTMP."/tpls/$dir",0);
		}
		comFiles::delDir(DIR_DTMP."/tpls/_vinc",0);
		comFiles::delDir(DIR_DTMP."/tpls/_tagc",0);
		comFiles::delDir(DIR_DTMP."/tpls/demodir",0);
	}
	
	// rstTabcode()
	static function rstTabcode(){
		$dcfg = array(
			'code'=>DIR_CODE,
			'tpls'=>DIR_CODE."/tpls",
			'root'=>DIR_ROOT,
			'skin'=>DIR_ROOT."/skin",
		);
		$ptab = DIR_DTMP."/store"; 
		foreach($dcfg as $key=>$path){
			$arr = updBase::listDir($path); 
			updBase::cacSave($arr,"tab_$key.php-cdemo","$ptab");
		}
		$arr = array();
		$cfgs = glbConfig::read('pubcfg','sy');
		foreach($cfgs['copy'] as $file){
			$arr[$file] = md5(comFiles::get(DIR_PROJ."/$file"));
		}
		updBase::cacSave($arr,"tab_proj.php-cdemo",$ptab);
	}
	// rstTabmini()
	static function rstTabmini(){
		$dir = DIR_DTMP."/dbexp";
		$files = comFiles::listDir($dir,'file');
		if(empty($files)) return;
		foreach ($files as $file => $value) {
			if(strpos($file,'~coms_')) unlink("$dir/$file");
		}
	}
	// rstRndata();
	static function rstRndata($path='/dbexp/data~'){
		$db = glbDBObj::dbObj();
		$cfgs = glbConfig::read('pubcfg','sy');
		foreach($cfgs['rndata'] as $tab=>$cfg){
			if(strpos($tab,':')) $tab = substr($tab,0,strpos($tab,':'));
			$file = str_replace("\\","/",DIR_DTMP.$path."$tab.dbsql");
			$list = $db->table($tab)->field($cfg[1])->where($cfg[0])->select();
			if($list){	
				$data = $dbak = comFiles::get($file);
				foreach($list as $row){
					$fa = explode(',',$cfg[1]);
					foreach($fa as $fk){
						$old = $row[$fk];
						$new = empty($cfg[2][$fk]) ? devBase::_drndData($old) : $cfg[2][$fk]; 
						$data = str_replace("'$old'","'$new'",$data);
					}
				}
				if($data!=$dbak) comFiles::put($file,$data); 
			}
		}
	}
	
	// rstCache();
	static function rstCache(){
		glbCUpd::upd_paras('score'); 
	}
	
	// rstIDPW();
	static function rstIDPW($uname='',$upass=''){
		$db = glbDBObj::dbObj();
		$enc = comConvert::sysPass($uname,$upass,'adminer');
		$db->table('users_uacc')->data(array('uname'=>$uname,'upass'=>$enc))->where("aip='(reset)'")->update();
		$db->table('users_adminer')->data(array('uname'=>$uname))->where("aip='(reset)'")->update();
	}	
	
	// 替换配置文件中的变量值
	static function rstVals($file,$pars=array(),$merge=1){
		if(!file_exists($file)) return; 
		$defs = array(
			'user'=>'user_id', 'pass'=>'u_pass', 'host'=>'127.0.0.1',
			'uid'=>'user_id', 'upw'=>'u_pass', 'pwd'=>'u_pass',
			'ak'=>'user_id', 'sk'=>'u_pass',
		);
		$vals = array();
		foreach($pars as $k=>$v){
			if(is_numeric($k)){
				$vals[$v] = isset($defs[$v]) ? $defs[$v] : "uset_$v";
			}else{
				$vals[$k] = $v;	
			}
		}
		if($merge){
		foreach($defs as $k=>$v){
			if(!isset($vals[$k])) $vals[$k] = $v;	
		} }
		$data = comFiles::get($file);
		foreach($vals as $k=>$v){ 
			$key = preg_quote($k); //echo "$k=$key, ";
			$data = preg_replace("/[$]$key\s*\=\s*.*?;/is", "\${$key} = '$v';", $data);
			$data = preg_replace("/(\[(['|\"]?)$key(['|\"]?)\])\s*\=\s*.*?;/is", "\\1 = '$v';", $data);
		}
		comFiles::put($file,$data);
		return "<pre>".str_replace('<','&lt;',$data)."</pre>";
	}
	
	static function rstDemo($pdir){
		$cfgs = glbConfig::read('pubcfg','sy');
		foreach($cfgs['cdemo'] as $v=>$rep){
			$fp = file_exists("$pdir/$v-cdemo") ? "$pdir/$v-cdemo" : "$pdir/$v";
			$data = comFiles::get($fp);
			if(!empty($rep)){
				$data = str_replace($rep[0],$rep[1],$data);
			}
			comFiles::put("$pdir/$v",$data);
		}
	}
	
	// 重新发布目录
	static function rstPub(){
		$cfgs = glbConfig::read('pubcfg','sy');
		$part = basReq::val('part','main'); //part=main/vars/vimp
		$parts = $cfgs['parts'];
		$pdir = dirname(DIR_PROJ).'/'.date('Y-md-H').$part.'-'.date('is'); 
		mkdir($pdir,0777);
		$arr = $cfgs['dirs']; 
		foreach($arr as $key=>$path){ 
			if(in_array($key,$parts[$part])){
				$sdir = basename($path); //echo "<br>$sdir;"; 
				if(in_array($key,array('ures','html'))){
					mkdir("$pdir/$sdir",0777);
				}else{
					$skip = isset($cfgs['skip'][$key]) ? $cfgs['skip'][$key] : array();
					comFiles::copyDir($path,"$pdir/$sdir",$skip,$cfgs['skfiles']);
				}
				if($part=='vary'){ 
					copy(DIR_CODE.'/index.php',"$pdir/$sdir/index.php");
					copy(DIR_STATIC.'/@setup_flag.txt',"$pdir/$sdir/@setup_flag.txt");
				}
			}
		}
		if($part=='main'){ 
			foreach($cfgs['copy'] as $file){
				copy(DIR_PROJ."/$file","$pdir/$file");
			}
			comFiles::copyDir(DIR_PROJ.'/@read',"$pdir/@read",array());
		}
		/*foreach($cfgs['del'] as $v){ 
			//if($v[0]==$key){
				comFiles::delDir("$pdir/".$v[0]."$v[1]",1);
			//}
		}*/
		if($part=='main'){ // ='main' !='vimp'
			foreach($cfgs['ids'] as $v){
				self::rstVals("$pdir/".$v[0]."$v[1]",$v[2]);
			}
			self::rstDemo($pdir);
		}
	}
	
}




/*******************************************************************************
 File : \code\core\sdev\devSetup.php 
*******************************************************************************/
<?php

// ...类
class devSetup{	

	static $fsetuped = '/store/_setup_lock.txt'; 
	static $flagfile = '/store/_setup_step.txt'; 
	static $flagdata = "###Start###\nstep1=Null\nstep2=Null\nstep3=Null\nstep4=Null\nstep5=Null\n###End###"; 
	static $demo_tabs = array(
		'dext_demo','docs_demo', 'dext_news','docs_news', 'dext_cargo','docs_cargo', 
		'dext_keres','docs_keres', 'dext_faqs','dext_faqs', 
	); 

	// 导入一个模型数据
	static function ins1Mod($mod,$data=array(),$type=''){
		if(empty($mod)) return array();
		// config
		$cfgs = array('model','fields','catalog','grade','fldext');
		foreach ($cfgs as $key) { //$data['model_'.$mod] = ...; 
			$idata = $data["{$key}_$mod"]; 
			$flag = devData::run1Sql($idata,$type);
		}
		if($type=='Update') return 'OK!';
		// stru_
		$tabm = glbDBExt::getTable($mod,0);
		$tabe = glbDBExt::getTable($mod,1);
		$tabs = $tabm==$tabe ? $tabm : "$tabm,$tabe";
		$tarr = explode(',',$tabs);
		foreach ($tarr as $tab) { // $data['stru_'.$tab] = ...
			$idata = $data["stru_$tab"]; 
			$flag = devData::run1Sql($idata);
		}
		return 'OK!';
	}

	// 导入一个菜单数据
	static function ins1Menu($menu,$data=array(),$type='',$pid=0){
		if(empty($menu)) return array();
		$idata = $data["menu_$menu"]; //print_r($idata);
		$mpid = basReq::val($menu); if(empty($mpid)) $mpid = $pid;
		$idata = str_replace(",'(pid-$menu)',",",'$mpid',",$idata);
		$flag = devData::run1Sql($idata);
		//echo "\n\n::(pid-$menu):".basReq::val($menu);
		return 'OK!';
	}

	static function insDeel($fnow=''){
		$_groups = glbConfig::read('groups'); 
		$_muadm = glbConfig::read('muadm'); $_muadm = $_muadm['i'];
		$re = array('abtn'=>array(),'slist'=>'',);
		$icfg = include(DIR_DTMP.'/update/'.$fnow); 
		$idata = include(DIR_DTMP.'/update/'.str_replace('.php','.dbsql',$fnow)); 
		if(!empty($icfg['mods'])){
		foreach ($icfg['mods'] as $mod => $mcfg) {
			$pid = $mcfg['pid'];
			$type = isset($_groups[$mod]) ? 'Update' : 'Install';
			$res = self::ins1Mod($mod,$idata,$type);
			$re['abtn'][$mod] = "$type - $res";
			$re['slist'] .= "<br>\n --- 模型: [$mod]{$mcfg['title']}, 执行结果如右...";
		}}
		if(!empty($icfg['menus'])){
    	$arm = comTypes::getSubs($_muadm,'0','1');
		foreach ($icfg['menus'] as $menu => $mcfg) {
			$pid = $mcfg['pid'];
			$type = isset($_muadm[$menu]) ? 'Update' : 'Install';
			$res = self::ins1Menu($menu,$idata,$type,$pid);
			$re['abtn'][$menu] = "$type - $res";
			@$re['slist'] .= "<br>\n --- 菜单: [$menu]{$mcfg['title']}, 执行结果如右...";
		}}
		return $re;
	} 

	static function insList($fnow='',$mop=0){
		$_groups = glbConfig::read('groups'); 
		$_muadm = glbConfig::read('muadm'); $_muadm = $_muadm['i'];
		$re = array('abtn'=>array(),'slist'=>'',);
		$icfg = include(DIR_DTMP.'/update/'.$fnow); 
		if(!empty($icfg['mods'])){
		foreach ($icfg['mods'] as $mod => $mcfg) {
			$pid = $mcfg['pid'];
			$re['abtn'][$mod] = isset($_groups[$mod]) ? 'Update' : 'Install';
			$re['slist'] .= "<br>\n --- 模型: [$mod]{$mcfg['title']}, 父级: [$pid]{$_groups[$pid]['title']}";
		}}
		if(!empty($icfg['menus'])){
    	$arm = comTypes::getSubs($_muadm,'0','1');
		foreach ($icfg['menus'] as $menu => $mcfg) {
			$pid = $mcfg['pid'];
			$opbar = $mop ? "<select name='$menu'>".basElm::setOption($arm,$pid)."</select>" : '';
			$re['abtn'][$menu] = isset($_muadm[$menu]) ? 'Update' : 'Install';
			@$re['slist'] .= "<br>\n --- 菜单: [$menu]{$mcfg['title']}, 父级: [$pid]{$_muadm[$pid]['title']} @$opbar ";
		}}
		return $re;
	}

	// 导出安装模组 模型/菜单
	static function expGroup($mods,$menus='',$xxx=''){
		if(strlen("$mods$menus")==0) return '';
		$data = $mids = $ares = array(); 
		$_groups = glbConfig::read('groups'); 
		$_muadm = glbConfig::read('muadm'); $_muadm = $_muadm['i'];
		// menu
		$marr = explode(',',$menus);
		foreach ($marr as $menu) {
			if(empty($menu) || empty($_muadm[$menu])) continue;
			$mpid = $_muadm[$menu]['pid']; 
			$mdata = devData::exp1Tab('base_menu',"kid='$menu' OR pid='$menu'"); 
			$mpid && $data['menu_'.$menu] = str_replace(",'$mpid',",",'(pid-$menu)',",$mdata);
			$ares['menus'][$menu] = $_muadm[$menu];
		}
		// model
		$marr = explode(',',$mods);
		foreach ($marr as $mod) {
			if(empty($mod) || empty($_groups[$mod])) continue;
			$imod = devData::exp1Mod($mod,0);
			$data = array_merge($data,$imod);
			$ares['mods'][$mod] = $_groups[$mod];
		}
		// save
		$fp = "/dbexp/ins~$mods-$menus";
		$ares = "<?php\nreturn ".var_export($ares,1).";\n?>"; 
		$dres = "<?php\nreturn ".var_export($data,1).";\n?>"; 
		comFiles::put(DIR_DTMP."$fp.php",$ares);
		comFiles::put(DIR_DTMP."$fp.dbsql",$dres);
		return $fp;
	}

	// supCfgs
	static function supCfgs(){ 
		$setflag = DIR_DTMP.self::$flagfile;
		file_exists($setflag) || comFiles::put($setflag,self::$flagdata);
		$text = comFiles::get($setflag);
		$data = basElm::text2arr($text); 
		$jstr = "var ";	$okcnt = 0; $nstep = '-1';
		foreach($data as $k=>$v){ 
			if(strstr($k,'###')) continue;
			if($v=='OK'){ 
				$okcnt++;
				$nstep = str_replace('step','',$k);
			}
			$jstr .= "$k='$v', ";
		}
		if($nstep==5 || self::isSetuped()){
			basMsg::show(lang('devsetup_deltip')."<br>[".basDebug::hidInfo(DIR_DTMP)."/store/]".lang('devsetup_dt1')."<br>_setup_step.txt ".lang('devsetup_dt2')." _setup_lock.txt".lang('devsetup_dt3')."",'die');
		}
		$pvInfo = devRun::verPHP(); //定义了FLAGYES/FLAGNO常量
		$jstr .= "\nfYES='".FLAGYES."',\nfNO='".FLAGNO."',";
		$jstr .= "\nfRes='".(($okcnt && $okcnt==$nstep) ? lang('devsetup_donen') : lang('devsetup_nosetup'))."',";
		
		$files = comFiles::listDir(DIR_DTMP.'/dborg'); 
		$all_tabs = array_keys($files['file']); 
		$demo_tabs = self::$demo_tabs;
		$base_tabs = array();
		foreach($all_tabs as $tab1){
			if(substr($tab1,0,5)=='data~'){
				$tab1 = str_replace('.dbsql','',substr($tab1,5));
				if(!in_array($tab1,$demo_tabs)) $base_tabs[] = $tab1;
			}
		}
		$jstr .= "\ndemo_tabs='".implode(',',$demo_tabs)."',\nbase_tabs='".implode(',',$base_tabs)."';\n";
		#print_r($all_tabs); print_r($demo_tabs); print_r($base_tabs); 
		return array($data,'okcnt'=>$okcnt,'jstr'=>$jstr);	
	}
	
	// supMark
	static function supMark($step,$val='OK'){ 
		$setflag = DIR_DTMP.self::$flagfile;
		$text = comFiles::get($setflag);
		$text = preg_replace("/step{$step}\=\S+/is", "step{$step}=$val", $text);
		comFiles::put($setflag,$text);
		if($step==4){ glbCUpd::upd_groups(); }
		if($step==5){ comFiles::put(DIR_DTMP.self::$fsetuped,date('Y-m-d H:i:s')); }
	}
	
	// supCheck
	static function supCheck(){ 
		$a = array('verPHP','verGdlib'); 
		foreach($a as $k){ 
			$re = devRun::$k(); 
			$re = $re['res']; 
			if($re!=FLAGYES){ 
				$re = array('res'=>'','msg'=>lang('devsetup_chkenv'));
				self::ajaxStop($re);
			}
		}
		$cfg = devRun::runPath($k); //print_r($cfg);
		foreach($cfg as $re){ 
			$re = $re['res'];
			if($re!=FLAGYES){ 
				$re = array('res'=>'','msg'=>lang('devsetup_chkdir'));
				self::ajaxStop($re);
			}
		}
		$a3 = devRun::runMydb3(); $n3 = 0;
		foreach($a3 as $k=>$re1){ 
			$re = $re1['res']; 
			if($re==FLAGYES) $n3++;
		}
		$re = $n3 ? 'OK' : ''; //print_r($re); 
		$msg = $n3 ? '' : lang('devsetup_chkmysql');
		$re = array('res'=>$re,'msg'=>$msg);
		self::ajaxStop($re);
	}
	
	// supStru 
	static function supStru(){ 
		if(self::isSetuped()){ die('isRunning...'); }
		$re = devData::struImp('/dborg/');
		if(!empty($re[1])){
			$msg = implode('<br>',$re[1]);
			$re = array('res'=>'','msg'=>$msg);
		}elseif(empty($re[0])){
			$re = array('res'=>'','msg'=>lang('devsetup_noframe'));	
		}else{
			$re = array('res'=>'OK','msg'=>'');
		}
		self::ajaxStop($re);
	}
	
	// supImps
	static function supImps($tab){ 
		if(self::isSetuped()){ die('isRunning...'); }
		$re = devData::dataImpInsert("/dborg/data~",$tab);
		$re = array('res'=>'OK','msg'=>'');
		self::ajaxStop($re);
	}
	
	// supIdpw 
	static function supIdpw(){ 
		if(self::isSetuped()){ die('isRunning...'); }
		// Rnd_Keys
		$db = glbDBObj::dbObj(); 
		$rcfg['sys_name']   = basReq::val('name');
		$rcfg['safe_site']  = 'name';  for($i=0;$i<5;$i++) $rcfg['safe_site']  .= '-'.basKeyid::kidRand('f',5);
		$rcfg['safe_pass']  = 'pass';  for($i=0;$i<5;$i++) $rcfg['safe_pass']  .= '-'.basKeyid::kidRand('fs3',5);
		$rcfg['safe_api']   = 'api';   for($i=0;$i<5;$i++) $rcfg['safe_api']   .= '-'.basKeyid::kidRand('f',5);
		$rcfg['safe_js']	= 'js';	for($i=0;$i<5;$i++) $rcfg['safe_js']	.= '-'.basKeyid::kidRand('f',5);
		$rcfg['safe_other'] = 'other'; for($i=0;$i<5;$i++) $rcfg['safe_other'] .= '-'.basKeyid::kidRand('f',5);
		$rcfg['safe_safil'] = 'safil'; for($i=0;$i<5;$i++) $rcfg['safe_safil'] .= '-'.basKeyid::kidRand('f',5);
		$rcfg['safe_rnum']  = basKeyid::kidRand('0',24);
		$rcfg['safe_adminer'] = 'adm'; for($i=0;$i<5;$i++) $rcfg['safe_adminer'] .= '-'.basKeyid::kidRand('fs3',5);
		$rcfg['safe_safix']  = '_'.basKeyid::kidRand('0',3);
		$rcfg['safe_rndtab']  = basKeyid::kidRTable('f');
		$rcfg['tout_admin']  = 1;
		$rcfg['tout_member']  = 4;
		foreach($rcfg as $k=>$v){
			$db->table('base_paras')->data(array('val'=>$v))->where("kid='$k'")->update();
		}
		global $_cbase;
		$_cbase['safe']['site']  = $rcfg['safe_site'];
		$_cbase['safe']['pass']  = $rcfg['safe_pass'];
		$_cbase['safe']['safil'] = $rcfg['safe_safil'];
		$_cbase['safe']['adminer'] = $rcfg['safe_adminer'];
		$_cbase['safe']['safix'] = $rcfg['safe_safix'];
		$_cbase['safe']['rndtab'] = $rcfg['safe_rndtab'];
		$_cbase['tout_admin'] = $rcfg['tout_admin'];  
		$_cbase['tout_member'] = $rcfg['tout_member'];	
		devData::rstIDPW(basReq::val('uid'),basReq::val('upw'));
		self::updCache();
		$re = array('res'=>'OK','msg'=>'');
		self::ajaxStop($re);
	}
	
	static function setDbname(){
		$tm = time(); $h = date('H');
		if($h<6) $tm = $tm+8*3600; if($h>18) $tm = $tm-8*3600;
		$md = substr(basKeyid::kidTemp('0'),0,7);
		$dbname = "catv".cfg('sys.ver')."_".$md;
		$dbname = str_replace(array('.','-'),array('',''),$dbname);
		return $dbname;
	}

	// ajaxStop 
	static function ajaxStop($re){ 
		$act = basReq::val('act');
		$step = basReq::val('step'); 
		$re['with'] = "act=$act;step=$step";
		$re = comParse::jsonEncode($re);
		//glbHtml::head('json');
		die($re);
	}

	static function isSetuped(){ 
		return file_exists(DIR_DTMP.self::$fsetuped);
	}

	// updCache 
	static function updCache(){ 
		$db = glbDBObj::dbObj(); 
		$g0 = $db->table('base_model')->where("enable='1'")->order('kid')->select();
		$skip = array('groups','plus','docs','coms','users','advs',);
		foreach($g0 as $k=>$v){
			$key = $v['kid'];
			if(in_array($key,array('score','sadm','smem','suser',))){ 
				glbCUpd::upd_paras($key);
			}elseif(in_array($v['pid'],$skip) || in_array($key,$skip)){
				continue;
			}else{ // pid in 'docs','coms','users','advs','types'
				glbCUpd::upd_model($key);
				//echo "$key, ";
			}
		}
		glbCUpd::upd_relat();
		glbCUpd::upd_menus('muadm');//menua
		admAFunc::umcVInit();
		glbCUpd::upd_grade();
	}

}



/*******************************************************************************
 File : \code\core\sdev\exdBase.php 
*******************************************************************************/
<?php

// ...类exdBase
class exdBase{	
	
	public $mod = '';
	public $mcfg = '';
	public $mpid = '';
	public $mkid = '';
	public $mkno = '';
	
	public $db = NULL;
	public $tbid = '';
	public $tbext = '';
	
	public $fmv = array(); // fields中：表单数据(基本表)
	public $fmu = array(); // fields中：表单数据(扩展表)
	public $fme = array(); // fields外数据：(ip,time,user,catid,grade...)
	
	//function __destory(){  }
	function __construct($mod){ 
		$this->db = glbDBObj::dbObj();	
		$this->minit($mod);
	}
	
	function minit($mod=''){
		$this->mod = $mod;
		$this->mcfg = glbConfig::read($this->mod); 
		$this->mpid = @$this->mcfg['pid']; 
		$_tmp = array(
			'docs' =>array('dopDocs','did'),
			'users'=>array('dopUser','uid'),
			'coms' =>array('dopComs','cid'),
			'advs' =>array('dopAdvs','aid'),
		); 
		if(!isset($_tmp[$this->mpid])) glbHtml::end(lang('flow.dops_parerr').':mod@dop.php');
		$this->mkid = $_tmp[$this->mpid][1]; 
		$this->mkno = substr($this->mkid,0,1).'no'; 
		$_cls = $_tmp[$this->mpid][0]; 
		$this->tbid = "{$this->mpid}_$this->mod";
		$this->tbext = $this->mpid =='users' ? 'users_uacc' : "dext_$this->mod";
	}

	// OutputData // mod,stype,limit(1-500),order(did:ASC),offset
	function odata($cfg=array(),$exJoin=1,$whrsub=''){
		$stype = (!empty($cfg['stype'])) ? $cfg['stype'] : basReq::val('stype'); $whrstr = '';
		if($stype && in_array($this->mpid,array('docs','advs'))){ 
			$whrstr .= basSql::whrTree($this->mcfg['i'],'catid',$stype);
		}elseif($stype && in_array($this->mpid,array('users'))){
			$whrstr .= " AND grade='$stype'";
		}
		$limit = (!empty($cfg['limit'])) ? $cfg['limit'] : basReq::val('limit',10,'N');
		if($limit<1) $limit = 10;
		$order = (!empty($cfg['order'])) ? $cfg['order'] : explode(':',basReq::val('order').":");
		$okey = ($order[0]==$this->mkid || isset($this->mcfg['f'][$order[0]])) ? $order[0] : $this->mkid;
		$omod = in_array(strtoupper($order[1]),array('ASC','DESC','EQ')) ? strtoupper($order[1]) : 'DESC';
		$offset = (!empty($cfg['offset'])) ? $cfg['offset'] : basReq::val('offset');
		if($offset){
			if(strstr($omod,'DESC')){
				$op = '<';
			}elseif(strstr($omod,'ASC')){
				$op = '>';
			}else{ // EQ
				$op = '=';
			}
			$whrstr .= " AND {$this->mkid}$op'$offset'";
		}
		$whrstr = $whrstr ? substr($whrstr,5) : '1=1'; 
		$data = $this->db->table($this->tbid)->where($whrstr.$whrsub)->order("$okey $omod")->limit($limit)->select(); 
		if($this->mpid=='docs' && $exJoin) dopFunc::joinDext($data,$this->mod); //$this->odataExt($data);
		return $data;
	}
	
	function svMerge(&$data){
		$fskip = basElm::line2arr($this->jcfg['fskip']); //排除字段
		if(!empty($fskip)){
			foreach($fskip as $fk){
				unset($data[$fk]);
			}
		}
		$def = basElm::text2arr($this->jcfg['fdefs']); //默认值
		if(!empty($def)) $data = array_merge($data,$def);
	}
	
	function svFields($data){ 
		$this->svMerge($data); 
		$f = $this->mcfg['f'];
		foreach($f as $k=>$v){ 
			if(!isset($data[$k])){
				if(strstr($v['dbtype'],'char')) $data[$k] = '';
				if(strstr($v['dbtype'],'int')) $data[$k] = 0;
				if(in_array($v['dbtype'],array('float','double','decimal'))) $data[$k] = 0; 
			}
		}
		foreach($data as $k=>$v){ 
			if(isset($f[$k])){ 
				if($f[$k]['dbtype']=='nodb') continue;
				$val = dopFunc::svFmtval($f,$this->mod,$k,$v);
				if($this->mcfg['pid']=='docs' && !empty($f[$k]['etab'])){ 
					$this->fmu[$k] = $val; // (扩展表)
				}else{ 
					$this->fmv[$k] = $val; // (基本表)
				}
			}else{
				if(in_array($k,array($this->mkid,$this->mkno,'aip','atime','auser','eip','etime','euser'))){
					$v = $k==$this->mkno ? 0 : $v;
					$this->fmv[$k] = $v;
				}elseif(in_array($k,array('grade')) && $this->mcfg['pid']=='users'){
					$this->fmv[$k] = $v;
				}elseif(in_array($k,array('catid')) && $this->mcfg['pid']=='docs'){
					$this->fmv[$k] = $v; 
				}else{ // (xid,xno,aip,atime,auser,catid,grade...)
					$this->fme[$k] = $v; // fields外数据：
				}
			}  
		} //print_r($this->fmv); print_r($this->fmu); //print_r($this->fme);
	}
	function svAccount(){ 
		$fma['uid'] = $this->fmv['uid']; $uname = str_replace('-','',$this->fmv['uid']);
		$fma['uno'] = $this->fmv['uno']; 
		$fma['uname'] = isset($this->fmv['uname']) ? $this->fmv['uname'] : addUname($uname,$this->mod); 
		$fma['umods'] = $this->mod; 
		$fma['upass'] = comConvert::sysPass($fma['uname'],basKeyid::kidRand('24',12),$this->mod);
		$fma['aip'] = '('.basReq::val('act').':'.basReq::val('job').')';
		$this->db->table($this->tbext)->data(basReq::in($fma))->insert();
	}
	function svDocsext(){ 
		$this->fmu['did'] = $this->fmv['did']; 
		$this->db->table($this->tbext)->data(basReq::in($this->fmu))->insert();
	}
	// save
	function save($data){
		$this->svFields($data,$this->jcfg);
		if($this->mcfg['pid']=='docs'){
			$this->svDocsext();
		}elseif($this->mcfg['pid']=='users'){
			$this->svAccount();	
		}
		$this->db->table($this->tbid)->data(basReq::in($this->fmv))->insert();
		return 1;
	}
	// supd
	function supd($data){
		$this->svFields($data,$this->jcfg);
		$kname = $this->mkid;
		$kval = $this->fmv[$this->mkid];
		if($this->mcfg['pid']=='docs'){
			$this->db->table($this->tbext)->data(basReq::in($this->fmu))->where("did='$kval'")->update();
		}
		unset($this->fmv[$this->mkid]);
		$this->db->table($this->tbid)->data(basReq::in($this->fmv))->where("$kname='$kval'")->update(); 
		return 1;
	}
	
	// getKid
	function getJKid($kid=''){
		$tabid = $this->mpid=='users' ? $this->tbext : $this->tbid;
		$kar = glbDBExt::dbAutID($tabid,'yyyy-md-','32',$kid);
		return $kar;
	}
	
	// getJFm2(max|min($field))
	function getJFm2($tab,$job,$field,$func){ 
		$tab = $this->db->table($tab,2);
		$sql = "SELECT $func($field) AS $field FROM $tab WHERE kid='$job'"; 
		$rec = $this->db->query($sql);
		$res = empty($rec[0][$field]) ? '' : $rec[0][$field];
		return $res;
	}

	// 获取配置字段
	function getJFlds($job){
		if(empty($this->cfields)){ 
			$cfields = $this->db->table('exd_sfield')->where("model='$job'")->select();
			$farr = array();
			foreach($cfields as $k=>$v){ 
				foreach($v as $k2=>$v2){ 
					if(in_array($k2,array('model','aip','atime','auser','eip','etime','euser'))) unset($v[$k2]);
				}
				$farr[$v['kid']] = $v;	
			} //print_r($farr);
			$this->cfields = $farr; 
		} 
		return $this->cfields;
	}
		
	// getSign
	// $key : 单独设置(暂未使用...)
	static function getJSign($key=''){
		$ocfgs = glbConfig::read('outdb','ex');
		$safix = cfg('safe.safix'); 
		$sign = $ocfgs['sign']; // (empty($key)||empty($ocfgs["sign_$key"])) ? $ocfgs['sign'] : $ocfgs["sign_$key"];
		$usign = "{$safix}[sapp]={$sign['sapp']}&{$safix}[skey]={$sign['skey']}";
		return $usign;
	}
	
	// getCfg
	static function getJCfgs($act,$job){
		$db = glbDBObj::dbObj();
		$jcfg = $db->table("exd_$act")->where("kid='$job'")->find(); 
		return $jcfg;
	}

	// fldForm
	static function fldForm($fm,$n=5){
		$stxmao = cfg('server.txmao');
		$marr = basLang::ucfg('cfglibs.exdbase_mode');
		$mext = basLang::ucfg('cfglibs.exdbase_ext');
		for($i=1;$i<=$n;$i++){ $k = "orgtg$i"; 
			$a = explode('(:)',$fm[$k].'(:)(:)');
			$mopt = "<br><select name='fm[$k][mode]' class='w150'>".basElm::setOption($marr,$a[0],lang('exdb_mode'))."</select>";
			$mopt .= " &nbsp; <select name='fm[$k][ext]' class='w150'>".basElm::setOption($mext,$a[2],lang('exdb_exop'))."</select>";
			$mopt .= " &nbsp; <a href='{$stxmao}/dev.php?advset-exdata#s_fields' target='_blank'>".lang('exdb_rnote')."</a>";
			glbHtml::fmae_row(lang('exdb_orgtag')."$i","<textarea name='fm[$k][tag]' rows='2' cols='50' wrap='wrap'>{$a[1]}</textarea>$mopt");
		}
	}
	// fldSave
	static function fldSave(&$fm,$n=5){
		for($i=1;$i<=$n;$i++){ $k = "orgtg$i"; 
			$mode = $fm[$k]['mode'];
			$tag = $fm[$k]['tag'];
			$ext = $fm[$k]['ext'];
			$fm[$k] = $fm[$k]['mode'].'(:)'.$fm[$k]['tag'].'(:)'.$fm[$k]['ext'];
		}
	}
	
	// showRes
	static function showRes($res){
		$msg = lang('exdb_nres');
		$msg .= $res['msg'] ? $res['msg']."<br>" : lang('exdb_okn',"{$res['ok']}/{$res['cnt']}")."<br>\n";
		$msg .= "[".date('Y-m-d H:i:s')."]<br>\n";
		if($res['next']){
			$msg .= "<br>\n".lang('exdb_next',3)."<br>\n";
			$js = "setTimeout('window.location.reload();',3000);"; 
			$js = basJscss::jscode($js);
		}else{
			$msg .= "<br>\n".lang('exdb_rok')."<br>\n";
			$js = '';	
		}
		glbHtml::page(lang('exdb_bugres'));
		glbHtml::page('body');
		echo "\n<p>$msg</p>\n$js";
		basDebug::varShow($res);
		glbHtml::page('end');
	}
	// showBug
	static function showBug($res,$exd,$debug){
		glbHtml::page(lang('exdb_bugres'));
		@$cfield = $exd->cfields[basReq::val('field')]; 
		if(strstr($cfield['dealfmts'],'strtotime')){
			$res .= " \n(".lang('exdb_orgdata').":".@$_cbase['crawl']['strtotime'].")";
		}elseif(strstr($cfield['dealfmts'],'strtotime')){
			$res .= " \n(".lang('exdb_orgdata').":".@$_cbase['crawl']['dealfunc'].")";	
		}
		echo "\n<base target='_blank' />";
		glbHtml::page('body');
		if($debug=='links'){
			foreach($res as $url){
				echo "\n<li><a href='$url'>$url</a></li>";	
			}
		}else{
			$str = is_array($res) ? 'Array' : $res;
			echo "\n<textarea rows='15' wrap='wrap' style='width:100%;height:50%'>".basStr::filForm($str)."</textarea>";	
		}
		echo "\n<hr>\n"; 
		basDebug::varShow($res);
		glbHtml::page('end');
	}
	
	// xxxrepVal
	static function xxxrepVal($val){
		//$val = '';
		return $val;
	}

}






/*******************************************************************************
 File : \code\core\sdev\exdCopy.php 
*******************************************************************************/
<?php

// ...类exdCopy
class exdCopy{	

	private $tab = '';
	private $tabOld = '';
	private $mod = '';
	private $pid = '';
	private $db = null;

	private $exd_tabs = array(
		'exd_crawl',
		'exd_oimp',
		'exd_psyn',
	);

	//function __destory(){  }
	function __construct($mtab='', $type='mdata'){ 
		$_groups = glbConfig::read('groups'); 
		if($type=='tabid' && in_array($mtab,$this->exd_tabs)){
			$this->setTable($mtab);
		}elseif(isset($_groups[$mtab])){
			$this->mod = $mtab;
			$this->pid = $_groups[$this->mod]['pid'];
			$tabid = glbDBExt::getTable($this->mod,0);
			$this->setTable($tabid);
		}else{
			die(__CLASS__.'::'.__FUNCTION__);
		}
		$this->db = glbDBObj::dbObj();
	}
	function setTable($tab=''){ 
		if(empty($tab)){
			$this->tab = $this->tabOld;
		}else{
			$this->tab = $this->tabOld = $tab;
		}
	}
	
	// 复制一条数据(文档/资讯|会员/交互)
	// ('2015-9c-p2k1', '2016-9c-p2k1', 'New Title~');
	function cdata($id, $nid='', $ntilte=''){
		$kid = glbDBExt::getKeyid($this->mod);
		$this->crow("$kid='$id'", array($kid=>$nid,'title'=>$ntilte));
		if(in_array($this->pid,array('docs'))){
			$tbext = glbDBExt::getTable($this->mod,1);
			$this->setTable($tbext);
			$this->crow("$kid='$id'", array($kid=>$nid));
			$this->setTable(''); //还原			
		}
	}

	// 复制一个方案
	// ('demo_dede', 'copy_dede2', 'Copy织梦导入');
	function cplan($id='', $nkey='', $ntilte=''){
		$this->crow("kid='$id'", array('kid'=>$nkey,'title'=>$ntilte));
		$this->setTable('exd_sfield');
		$this->cbat("model='$id'", array('model'=>$nkey));
		$this->setTable('');
	}

	// 复制一组数据
	// (array("model='demo_data'"), array('model'=>'copy_dede5'));
	function cbat($old, $new){
		$whr = $this->_getWhr($old);
		$list = $this->db->table($this->tab)->where($whr)->select();
		if(empty($list)) return false; 
		foreach ($list as $row) {
			$this->crow(0, $new, $row); 
		}
	}
	
	// 复制一行数据
	// $new : array("kid"=>"newid") / array("model"=>"newmod")
	function crow($old, $new, $row=array()){
		if(empty($row)){
			$whr = $this->_getWhr($old); 
			$row = $this->db->table($this->tab)->where($whr)->find(); 
			if(empty($row)) return false;
		}
		$rn = array(); $arr = array('atime','etime');
		foreach ($row as $key => $value) {
			if(in_array($key,$arr)){
				$rn[$key] = time();
			}else{
				$rn[$key] = isset($new[$key]) ? $new[$key] : $value;
			}
		}
		return $this->db->table($this->tab)->data(basReq::in($rn))->insert();
	}

	// _getWhr
	// 格式："kid='detail'" 
	// array("kid='detail'","model='demo'")  
	// array("kid"=>"detail","model"=>"copyid")
	function _getWhr($arr){
		$whr = '';
		if(is_array($arr)){
			foreach ($arr as $value) {
				if(is_array($value)){
					$first = reset($value);
					$key = key($value);
					$value = "`$key`='$first'";
				}
				$whr .= (empty($whr)?'':' AND ')."$value";
			}
		}else{
			$whr = $arr;
		}
		return $whr;
	}

	// xxxrepVal
	static function xxxrepVal($val){
		//$val = '';
		return $val;
	}

}

/*

*/




/*******************************************************************************
 File : \code\core\sdev\exdCrawl.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// ...类exdCrawl
class exdCrawl{	
	
	// ugetPages
	static function ugetPages($jcfg=array()){
		$oplog = $jcfg['oplog'];
		$opnos = explode('-',$jcfg['opno']);
		$opmin = intval($opnos[0]); if($opmin<1) $opmin=1;
		$opmax = intval($opnos[1]); if($opmax<1) $opmax=1;
		if($opmax<$opmin) $opmax = $opmin;
		$opnow = ''; $opnext = '';
		for($i=$opmax;$i>=$opmin;$i--){
			if(strlen($opnow)==0 && !strstr(",$oplog,",",$i,")){ 
				$opnow = $i;
				continue;
			}
			if(strlen($opnow)>0 && !strstr(",$oplog,",",$i,")){ 
				$opnext = $i;
				break;
			}
		}
		return array($opnow,$opnext);
	}
	
	// ugetLinks
	static function ugetLinks($jcfg=array(),$pno=1){
		$ourl = str_replace('(*)',$pno,$jcfg['ourl']);
		$data = comHttp::doGet($ourl,5); 
		$data = comConvert::autoCSet($data,$jcfg['ocset'],'utf-8'); // echo $data;
		$data = self::orgAll($data,$jcfg);
		// modeAttr(:)href(^)url 规则可要可不要
		if(is_string($data)){ $data = basElm::getAttr($data,'href','url',-1); }
		if(!empty($jcfg['ohas']) && !empty($data)){
			foreach($data as $k=>$url){
				if(!strstr($url,$jcfg['ohas'])) unset($data[$k]);
			}
		}
		//basArray::inStr(array('org','com','net'),'xys@163.com');
		$jcfg['oskip'] = basElm::line2arr($jcfg['oskip']);
		if(!empty($jcfg['oskip']) && !empty($data)){
			foreach($data as $k=>$url){
				if(basArray::inStr($jcfg['oskip'],$url)) unset($data[$k]);
			}
		}
		if(!empty($jcfg['orep']) && !empty($data)){
			$jcfg['orep'] = basElm::text2arr($jcfg['orep']);
			foreach($data as $k=>$url){foreach($jcfg['orep'] as $v1=>$v2){
				$data[$k] = str_replace($v1,$v2,$data[$k]);
			}}
		}
		if(!empty($jcfg['oroot']) && !empty($data)){
			foreach($data as $k=>$url){
				$data[$k] = $jcfg['oroot'].$data[$k];
			}
		} //print_r($data);
		return $data;
	}
	
	// ugetDRow
	static function ugetRow($jcfg,$cfields=array(),$udata=''){
		$farr = array(); 
		if(is_array($udata)){ //oimp
			foreach($cfields as $k=>$v){ //echo "\n$k::::"; print_r($v);
				if(empty($v['orgtg1']) || !isset($udata[$v['orgtg1']])) continue;
				$farr[$k] = self::orgAll($udata[$v['orgtg1']],$v,0);	
			} 
		}else{
			$data = comHttp::doGet($udata,5); 
			$data = comConvert::autoCSet($data,$jcfg['ocset'],'utf-8'); // echo $data;
			foreach($cfields as $k=>$v){ 
				$farr[$k] = self::orgAll($data,$v);	
			} 
		} 
		return $farr;
	}
	
	static function orgAll($data,$cfg=array(),$recomp=1){ 
		$dold = $data;
		foreach($cfg as $key=>$val){ 
			if(substr($key,0,5)=='orgtg'){
				if(strlen($val)<18) continue; //echo "\n\n($key=$val)\n";
				$data = self::orgPos($data,$val);
			} 
			if(substr($key,0,4)=='deal'){ //echo "\n\n($key=$val)\n";
				if(in_array($key,array('dealfunp'))) continue;
				$extp = $key=='dealfunc' ? $cfg['dealfunp'] : '';
				if(!empty($val)){
					$method = "deal".ucfirst(substr($key,4)); 
					$data = self::$method($data,$val,$extp);
				}
			}
			if($key=='dealval'){ //可以是0
				$data = self::dealDefv($data,$val,$cfg['defover']);
			} //echo "<br>$key=$val=$data";
		}
		return $recomp ? ($data==$dold ? '' : $data) : $dold;
	}
	
	static function orgPos($data,$pcfg){ // (:)  (^)  (*)
		if(empty($pcfg)) return $data; //echo "\n\n:="; print_r($pcfg);
		$pcfg = explode('(:)',"$pcfg(:)(:)");
		$pmode = $pcfg[0]; $paras = @explode('(^)',$pcfg[1]."(^)(^)(^)"); $pext = $pcfg[2]; 
		if($pmode=='modeVal'){ // ($data,'<div class="content">(*)</div>') 或 ($data,'class="content"(*)</div>','>')
			if(!empty($paras[0]) && strpos($paras[0],'(*)')){ 
				$data = basElm::getVal($data,$paras[0],$paras[1]);
			}
		}elseif($pmode=='modePos'){ // ($data,'<div class="content">(*)id="link"')
			if(!empty($paras[0]) && strpos($paras[0],'(*)')){
				$data = basElm::getPos($data,$paras[0]);
			} 
		}elseif($pmode=='modeArr'){ // ($data,'<li class="cls22">(*)</li>') 或 ($data,'<li class(*)</li>')
			if(!empty($paras[0]) && strpos($paras[0],'(*)')){
				$paras[1] = is_numeric($paras[1]) ? $paras[1] : -1; 
				$data = basElm::getArr($data,$paras[0],$paras[1]);
			}
		}elseif($pmode=='modePreg'){ // getArr($data,"<td class="tc1">(*)</td>","[^rn]{1,1200}")
			if(!empty($paras[0]) && strpos($paras[0],'(*)') && !empty($paras[1])){
				$paras[1] = str_replace(array("rn"),array("\n|\r"),$paras[1]);
				$paras[2] = is_numeric($paras[2]) ? $paras[2] : -1; 
				$data = basElm::getPreg($data,$paras[0],$paras[1],$paras[2]);
			}			
		}elseif($pmode=='modeAttr'){ // getAttr($data,'witdh','val',1);
			if(!empty($paras[0]) && !empty($paras[1])){
				$paras[2] = isset($paras[2]) ? $paras[2] : -1; 
				$data = basElm::getAttr($data,$paras[0],$paras[1],$paras[2]);
			}
		}else{
			//$data = '';
		}
		if($pext=='url:fatch'){
			self::orgUrl($data);
		}elseif($pext=='save:image'){
			self::orgImg($data);	
		}
		return $data;
	}
	
	static function orgUrl($url){
		if(strpos($url,'>') || strpos($url,'<')){
			$url = basElm::getAttr($url,'href','url',0);	
		}
		$data = comHttp::doGet($url,3);
		return $data;
	}
	
	static function orgImg($url){ 
		$config = array( //上传配置
			"maxSize" => 500, //单位KB
			"allowFiles" => array(".gif", ".png",'.jpg')
		);
		$up = new comUpload($url, $config, 'remote');
		$info = $up->getFileInfo(); 
		if($info['state']=='SUCCESS'){
			$mod = basReq::val('mod'); $mod || $mod='crawl';
			$ure = comFiles::moveTmpDir($info['url'],$mod,basKeyid::kidTemp('hms'),0);
		}else{
			$ure = '';	
		} //print_r($ure);
		return $ure;
	}
	
	// dealfmts	varchar(255) []	 note,html,blank,strtotime,
	static function dealFmts($data,$fmts){
		global $_cbase;
		if(strstr($fmts,'note')) $data = basStr::filNotes($data);
		if(strstr($fmts,'html')) $data = basStr::filHText($data);
		if(strstr($fmts,'blank')){ 
			$data = preg_replace("/\s(?=\s)/","\\1",$data); 
		}
		$data = trim($data);
		$_cbase['crawl']['strtotime'] = $data; 
		if(strstr($fmts,'strtotime')) $data = strtotime($data);
		//$str = preg_replace("/<sty.*?\\/style>|<scr.*?\\/script>|<!--.*?-->/is", '', $str);
		return $data;
	}
	// dealtabs	varchar(255)	 替换来源内容=空
	static function dealTabs($data,$fmts){ 
		$a = basElm::line2arr($fmts); $re = array();
		foreach($a as $val){
			if(strlen($val)==0) continue;
			$re[] = $val;
		} 
		if(!empty($re)){ 
			$data = str_replace($re,'',$data); 
		}
		return $data;
	}
	// dealconv	varchar(24) []	 a=b
	static function dealConv($data,$fmts){
		$fmts = basElm::text2arr($fmts);
		$rek = $rev = array();
		foreach($fmts as $key=>$val){
			$rek[] = $key;
			$rev[] = $val=='(null)' ? '' : $val;
		} //print_r($rek);
		if(!empty($rek)) $data = str_replace($rek,$rev,$data);
		return $data;
	}
	// dealfunc	varchar(48) []	 结果处理函数 
	static function dealFunc($data,$func,$funp=''){
		global $_cbase;
		$_cbase['crawl']['dealfunc'] = $data; 
		if(method_exists('exaCrawl',$func)){ 
			$paras = explode(',',$funp.",,");
			return exaCrawl::$func($data,$paras[0],$paras[1],$paras[2]); 
		}elseif(function_exists($func)){
			$paras = explode(',',$funp.",,");
			return $func($data,$paras[0],$paras[1],$paras[2]);	
		}
	}
	// defval,defover
	static function dealDefv($data,$defval='',$over=''){
		$val = $defval=='(null)' ? '' : $defval;
		$data = strlen($data)==0 ? $val : $data;
		return $data;
	}

}

/*
 
*/



/*******************************************************************************
 File : \code\core\sdev\exdFunc.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// ...类exdFunc
class exdFunc extends exdBase{	
	
	public $odb = NULL;
	public $jcfg = array();
	public $cfields = array();
	
	function __construct($mod){ 
		parent::__construct($mod);
	}
	
	// 拉取
	function exdPull(){
		$data = $this->odata();
		//$ret = basReq::val('ret','json');
		$data = comParse::jsonEncode($data);
		return $data;
	}
	
	// 分享
	function exdShow(){ //tpl,cut,clen,ret(html/js),
		$data = $this->odata(); 
		$tpl = basReq::val('tpl','','');
		$burl = vopTpls::etr1('chn',0).'?'; 
		$tpl = $tpl ? comParse::urlBase64($tpl,1) : "<li><a href='{rhome}$burl?$this->mod.{kid}'>{title}</a></li>";
		$tpl = str_replace('{rhome}',cfg('run.rsite'),$tpl);
		$cut = ','.basReq::val('cut',"title,company").',';
		$clen = basReq::val('clen',"255",'N');
		$ret = basReq::val('ret','js'); 
		$str = ''; 
		foreach($data as $nv){ 
			$istr = $tpl;
			foreach($nv as $ik=>$iv){ 
				if(strpos($cut,$ik)) $iv = basStr::cutWidth($iv, $clen);
				$istr = str_replace('{'.$ik.'}',$iv,$istr);	
			}
			$istr = str_replace("{kid}",$nv[$this->mkid],$istr);
			$str .= "$istr\n";
		}
		if($ret=='js'){
			$str = basJscss::jsShow($str, 0);
		}
		return $str;
	}

	// 同步
	function exdPsyn($jcfg=array()){ 
		$this->jcfg = $jcfg;
		$re = array('msg'=>'','cnt'=>0,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$data = $this->exdPsyn_Data($jcfg);
		if(!empty($data)){
			foreach($data as $row){ 
				$oid = $row[$this->mkid];
				if(empty($re['min']) || $oid<$re['min']) $re['min'] = $oid;
				if(empty($re['max']) || $oid>$re['max']) $re['max'] = $oid;
				$kar = $this->getJKid($oid); 
				$kid = $kar[0]; $kno = $kar[1];
				$row[$this->mkid] = $kid;
				$row[$this->mkno] = $kno;
				$ire = $this->save($row);
				$ire && $re['ok']++; 
				$dlog = array('kid'=>$jcfg['kid'],'kno'=>intval($ire),'sysid'=>$kid,'outid'=>$oid,);
				$this->db->table('exd_pslog')->data($dlog)->insert(); 
				$re['cnt']++;
			}
			$data = $this->exdPsyn_Data($jcfg,$re['max'],1);
			$re['next'] = empty($data) ? 0 : 1; 
		}else{
			$re['msg'] = lang('core.nul_orgdata');
			$re['next'] = 0;	
		} 
		return $re; 
	}
	function exdPsyn_Data($jcfg=array(),$offset='',$limit=0,$omode='ASC'){ // mod,stype,limit(1-500),order(did:ASC),offset,ret(json)
		if(empty($offset)) $offset = $this->getJFm2('exd_pslog',$jcfg['kid'],'outid','MAX'); 
		$limit = $limit ? $limit : $jcfg['limit'];
		$para = "act=pull&mod=$jcfg[mod]&stype=$jcfg[stype]&limit=$limit&order={$this->mkid}:$omode&offset=$offset";
		$url = $jcfg['api']."/plus/ajax/exdb.php?$para&".exdBase::getJSign();
		$json = comHttp::doGet($url); //var_dump($json);
		$data = comParse::jsonDecode($json); //print_r($data);
		return $data;
	}
	// Update
	function exdPsyn_Update($jcfg=array(),$sysid){ 
		$re = array('msg'=>'','cnt'=>1,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$jrow = $db->table("exd_pslog")->where("kid='$jcfg[kid]' AND sysid='$sysid'")->find();
		$data = $this->exdPsyn_Data($jcfg,$jrow['outid'],1,'EQ');
		$ire = $this->supd($data[0]);
		$ire && $re['ok']++; 
	}
	
	// 导入
	function exdOimp($jcfg=array()){
		$this->jcfg = $jcfg;
		$cfields = $this->getJFlds($jcfg['kid']);
		$re = array('msg'=>'','cnt'=>0,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$data = $this->exdOimp_Data($jcfg);
		if(!empty($data)){
			foreach($data as $row){ 
				$drow = exdCrawl::ugetRow($jcfg,$cfields,$row);
				$oid = $row[$jcfg['kname']];
				if(empty($re['min']) || $oid<$re['min']) $re['min'] = $oid;
				if(empty($re['max']) || $oid>$re['max']) $re['max'] = $oid;
				$defid = basKeyid::kidTemp('hms',empty($jcfg['ktime']) ? '' : $row[$jcfg['ktime']]);
				$kar = $this->getJKid($defid); 
				$kid = $kar[0]; $kno = $kar[1];
				$drow[$this->mkid] = $kid;
				$drow[$this->mkno] = $kno;
				$ire = $this->save($drow);
				$ire && $re['ok']++;
				$oukey = $jcfg['ktype']=='int' ? 'ouint' : 'outid';
				$dlog = array('kid'=>$jcfg['kid'],'kno'=>intval($ire),'sysid'=>$kid,$oukey=>$oid,);
				$this->db->table('exd_oilog')->data($dlog)->insert(); 
				$re['cnt']++;
			}
			$data = $this->exdOimp_Data($jcfg,$re['max'],1);
			$re['next'] = empty($data) ? 0 : 1; 
		}else{
			$re['msg'] = lang('core.nul_orgdata');
			$re['next'] = 0;	
		} 
		return $re; 
	}
	function exdOimp_Data($jcfg=array(),$offset='',$limit=0,$omode='>'){ 
		// id=9ac2e7b1f1d22e9e57260f6553822520,order:oid, outid|ouint
		$oukey = $jcfg['ktype']=='int' ? 'ouint' : 'outid';
		if(empty($offset)) $offset = $this->getJFm2('exd_oilog',$jcfg['kid'],$oukey,'MAX'); 
		if(empty($this->odb)){
			$ocfgs = glbConfig::read('outdb','ex');
			require_once(DIR_CODE."/adpt/dbdrv/db_pdox.php");
			$this->odb = new db_pdox(); 
			$this->odb->connect($ocfgs[$jcfg['odb']]); 
		}
		$sql = $jcfg['osql'];
		if($offset){
			$sql = str_replace(array('1=1'),array("m.$jcfg[kname]{$omode}'$offset'"),$sql);	
		} 
		$data = $this->odb->query($sql,'all'); //print_r($data);
		return $data;
	}
	// Update
	function exdOimp_Update($jcfg=array(),$sysid){ 
		$this->jcfg = $jcfg;
		$this->fmv[$this->mkid] = $sysid;
		$re = array('msg'=>'','cnt'=>1,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$jrow = $this->db->table("exd_oilog")->where("kid='$jcfg[kid]' AND sysid='$sysid'")->find();
		$oukey = $jcfg['ktype']=='int' ? 'ouint' : 'outid';
		$data = $this->exdOimp_Data($jcfg,$jrow[$oukey],1,'=');
		$cfields = $this->getJFlds($jcfg['kid']);
		$drow = exdCrawl::ugetRow($jcfg,$cfields,$data[0]);
		$ire = $this->supd($drow);
		$re['ok']++; 
		return $re;
	}
	
	// 采集
	function exdCrawl($jcfg=array()){
		$this->jcfg = $jcfg;
		$cfields = $this->getJFlds($jcfg['kid']);
		$re = array('msg'=>'','cnt'=>0,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$pm2 = exdCrawl::ugetPages($jcfg);
		$re['next'] = $pm2[1]; //print_r($pm2);
		if(strlen($pm2[0])){
			$urls = exdCrawl::ugetLinks($jcfg,$pm2[0]);
			foreach($urls as $url){
				$omd5 = md5($url);
				if(!$this->db->table("exd_crlog")->where("kid='{$jcfg['kid']}' AND omd5='$omd5'")->find()){
					$re['ok']++;
					$drow = exdCrawl::ugetRow($jcfg,$cfields,$url);
					$defid = basKeyid::kidTemp('hms',empty($drow['atime']) ? '' : $drow['atime']);
					$kar = $this->getJKid($defid); 
					$kid = $kar[0]; $kno = $kar[1]; 
					$drow[$this->mkid] = $kid;
					$drow[$this->mkno] = $kno;
					$ire = $this->save($drow);
					$dlog = array('kid'=>$jcfg['kid'],'kno'=>intval($ire),'sysid'=>$kid,'outurl'=>$url,'omd5'=>$omd5,);
					$this->db->table('exd_crlog')->data($dlog)->insert();
				}
				$re['cnt']++; 
			}
			$oplog = str_replace(",$pm2[0],",',',$jcfg['oplog']);
			$oplog = str_replace(array(",,"),array(","),"$oplog,$pm2[0],");
			$this->db->table('exd_crawl')->data(array('oplog'=>$oplog))->where("kid='{$jcfg['kid']}'")->update();
		}else{
			$re['msg'] = lang('core.nul_orgdata');
			$re['next'] = 0;
		}
		return $re; 
	}
	// Debug
	function exdCrawl_Debug($jcfg=array(),$debug='links'){ 
		$cfields = $this->getJFlds($jcfg['kid']); 
		if($debug=='links'){ 
			return exdCrawl::ugetLinks($jcfg);
		}elseif($debug=='field'){
			$url = basReq::val('url');
			$url || $url = $jcfg['odmp'];
			$data = comHttp::doGet($url,5); 
			$data = comConvert::autoCSet($data,$jcfg['ocset'],'utf-8'); // echo $data;
			$field = basReq::val('field');
			return exdCrawl::orgAll($data,$cfields[$field]);
		}
	}
	// Update
	function exdCrawl_Update($jcfg=array(),$sysid){ 
		$this->jcfg = $jcfg;
		$this->fmv[$this->mkid] = $sysid;
		$re = array('msg'=>'','cnt'=>1,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$jrow = $this->db->table("exd_crlog")->where("kid='$jcfg[kid]' AND sysid='$sysid'")->find();
		$cfields = $this->getJFlds($jcfg['kid']);
		$drow = exdCrawl::ugetRow($jcfg,$cfields,$jrow['outurl']);
		$ire = $this->supd($drow);
		$re['ok']++; 
		return $re;
	}
	
}




/*******************************************************************************
 File : \code\core\sdev\updAdmin.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// ...类
class updAdmin extends updBase{	
	
	// doVerset,delete .... 
	static function doVerset($cfg){ 
		define('indo_Verset',1); 
		// update ver
		$vnew = $upc['vnew'];
		$key = "[$]_cbase\[\'sys\'\]\[\'ver\'\]\s*\=\s*[\"'].*?[\"'];";
		$val = "\$_cbase['sys']['ver']	 = '$vnew';";
		$path = DIR_CODE."/cfgs/boot/const.cfg.php";
		$data = comFiles::get($path);
		$data = preg_replace("/$key/is", $val, $data);
		$data = comFiles::put($path, $data);
		// delete files
		$upcfgs = glbConfig::read('updvnow','sy');
		$dellist = $upcfgs['dellist'];
		foreach($dellist as $file){
			if(strpos($file,':')){
				$tmp = explode(':',$file);
				$arf = explode(',',$tmp[1]);
				foreach($arf as $file){
					@unlink($tmp.$file);
				}
			}else{
				comFiles::delDir(DIR_PROJ."/$file",1);
			}
		}
		// copy root files
		$new = self::cacGet("tab_proj.php-cdemo",$cfg['path']."/vary/dtmp/store");
		foreach($new as $k=>$v){
			$f = @copy($cfg['path']."/$k",DIR_PROJ."/$k");
		}
	}
	
	// 初始化
	static function doFileInit($cfg,$step){
		$part = substr($step,0,4);
		$dcfg = array('code'=>DIR_CODE,'root'=>DIR_ROOT);
		$pnew = $cfg['path']."/$part"; 
		$pold = $dcfg[$part]; 
		$new = self::cacGet("tab_$part.php-cdemo",$cfg['path']."/vary/dtmp/store");
		if(empty($new)) $new = self::listDir($pnew); 
		$old = self::cacGet("tab_$part.php-cdemo",DIR_DTMP."/dset");
		foreach($new as $k=>$v){
			if(file_exists($pold."/$k")){
				$old[$k] = md5(comFiles::get($pold."/$k"));
			}
		}
		self::cacSave($new,"file_$part.new");
		self::cacSave($old,"file_$part.old");
	}
	// 补全文件/覆盖文件
	static function doFileAE($cfg,$step,$method){
		$part = substr($step,0,4);
		$dcfg = array('code'=>DIR_CODE,'root'=>DIR_ROOT);
		$pnew = $cfg['path']."/$part"; 
		$pold = $dcfg[$part];
		$new = self::cacGet("file_$part.new");
		$old = self::cacGet("file_$part.old");
		$res = self::$method($new,$old,$pnew,$pold);
		$str = "";
		foreach($res as $file=>$val){
			$str .= "$file -&gt; ".($val ? 'OK' : 'Fail')."<br>";
		}
		return $str;
	}
	// 比较文件
	static function doFileComp($cfg,$step){
		$part = substr($step,0,4);
		$dcfg = array('code'=>DIR_CODE,'root'=>DIR_ROOT);
		$pnew = $cfg['path']."/$part"; 
		$pold = $dcfg[$part];
		$new = self::cacGet("file_$part.new");
		$old = self::cacGet("file_$part.old");
		$res = self::fileComp($new,$old,$pnew,$pold);
		$str = ""; 
		foreach($res as $file=>$val){
			$str .= "$file -&gt; $val -&gt; <a href='?act=cmpfile&file=$file&part=$part' target='x'>[".lang('core.upd_comp')."]</a><br>";
		}
		return $str;
	}
	
	// 补全dtmp目录
	static function doDirDtmp($cfg){
		$pnew = $cfg['path']."/vary/dtmp/"; 
		$res = self::dirFix($pnew,DIR_DTMP);
		$str = ""; 
		foreach($res as $dir=>$val){
			$str .= DIR_DTMP." : $dir -&gt; ".($val ? 'OK' : 'Fail')."<br>";
		}
		return $str;
	}
	
	// 添加数据表
	static function doDbInit($cfg){
		devData::struExp('/dbexp/');
		$pnew = $cfg['path']."/vary/dtmp/dborg/_stru_tables.dbsql"; 
		$pold = DIR_DTMP.'/dbexp/_stru_tables.dbsql';
		$new = self::listTab($pnew); 
		$old = self::listTab($pold);
		self::cacSave($new,"dbcfg_new");
		self::cacSave($old,"dbcfg_old");
	}
	// 添加数据表
	static function doDbTable($cfg){
		$new = self::cacGet("dbcfg_new");
		$old = self::cacGet("dbcfg_old");
		$res = self::dbTable($new,$old,$cfg);
		$str = ""; 
		foreach($res as $tab=>$vals){
			$str .= "<li> ● [$tab] :: ".($vals['f1'] ? 'OK' : 'Fail')." :: ".($vals['f2'] ? 'OK' : 'Fail')." ●<br> {$vals['sql']};</li>";
		}
		return $str;
	}
	// [添加]表字段
	static function doDbFAdd($cfg){
		$db = glbDBObj::dbObj();
		$dbcfgs = self::cacGet("dbedit_cols");
		$str = "";  
		foreach($dbcfgs as $tab=>$vals){
			if(!empty($vals['add'])){
				//try{ $f1 = $db->query($vals['del']); }catch(Exception $e){}
				if(!strpos($cfg['steps'],'`db_fadd`')){
					$f1 = $db->query($vals['add']); 
				}
				$str .= "<li> ● {$tab} ●<pre>{$vals['add']}</pre></li>";	
			}
		}
		return $str;
	}
	// [补全]表字段
	static function doDbFComp($cfg){
		$db = glbDBObj::dbObj();
		$dbcfgs = self::cacGet("dbedit_cols");
		$str = ""; //edit idx sql
		foreach($dbcfgs as $tab=>$vals){
			$istr = '';
			if(!empty($vals['edit'])){
				$istr .= "{$vals['edit']}\n";
			}
			if(!empty($vals['idx'])){
				$istr .= "{$vals['idx']}\n";
			}
			if(!empty($vals['sql'])){
				$istr .= "{$vals['sql']}\n";
			}
			$istr && $str .= "<li> ● {$tab} <a href='?act=cmptable&tab=$tab' target='x'>[".lang('core.upd_comp')."]</a>●<pre>{$istr}</pre></li>";	
		}
		return $str;
	}
	
	// 数据表 处理
	static function ddData($cfg){
		$new = self::cacGet("dbcfg_new");
		$old = self::cacGet("dbcfg_old");
		$res = array(); $tnav = ''; $tnum = 0; $fdir = 0;
		foreach($new as $tab=>$val){
			if(!isset($old[$tab])) continue;
			$f1 = in_array(substr($tab,0,5),array('base_','bext_'));
			if($f1){
				if(!file_exists(DIR_DTMP."/dbexp/data~$tab.dbsql")) devData::data1ExpInsert("/dbexp/data~",$tab); 
				$len = 2; //in_array($tab,array('bext_cron')) ? 1 : 2; 
				if($fdir){ header("Location:?act=cmpdata&ntab=$tab"); die(); }
				$dnew = self::listData($cfg['path']."/vary/dtmp/dborg/data~$tab.dbsql",$len);
				$dold = self::listData(DIR_DTMP."/dbexp/data~$tab.dbsql",$len);
				foreach($dnew as $k=>$v){
					if($tab=='base_paras' && strpos($k,':prsafe')) continue;
					if(!isset($dold[$k])){
						$res[$tab]['add'][$k] = $v;
					}elseif($dold[$k]!==$v){
						$res[$tab]['edit'][$k] = array('old'=>$dold[$k],'new'=>$v,);
					}
				}
				$ntab = basReq::val('ntab');
				$nact = basReq::val('nact'); //rep,[add]
				if($ntab==$tab){
					if(!empty($res[$tab]['add']) && !empty($nact)){ self::ddDone($res[$tab],$tab,'add',1); }
					if(!empty($res[$tab]['edit']) && $nact=='rep'){ self::ddDone($res[$tab],$tab,'edit',1); }
					if(!empty($nact)){
						self::setStep($cfg,array('key'=>'dbdata','val'=>$ntab));
						$fdir = 1; 
					}else{
						$res['addsql'] = @self::ddDone($res[$tab],$tab,'add');
						$res['repsql'] = @self::ddDone($res[$tab],$tab,'edit');
					}
				}
				if(strpos($cfg['dbdata'],$tab)){
					$tnav .= "<i>$tab</i>\n";
				}else{
					$tnav .= "<i><a href='?act=cmpdata&ntab=$tab'>$tab</a></i>\n";
					$tnum++;
				}
			}
		}
		if($fdir){ header("Location:?act=cmpdata"); die(); } //最后一个$nact,要跳到这里来执行
		$res['tnav'] = $tnav;
		$res['tnum'] = $tnum;
		return $res;
	}
	// 数据表 比较
	static function ddComp($dorg,$tab){
		$data = empty($dorg[$tab]['edit']) ? array() : $dorg[$tab]['edit'];  
		$res = array(); $n = 0; $str = '';
		foreach($data as $key=>$val){
			$res['new'][$key] = $val['new'];
			$res['old'][$key] = $val['old'];
			$n++;
		}
		@$res = basArray::cmpArr($res['new'],$res['old'],'item');
		$res['ne'] = $n;
		$data = empty($dorg[$tab]['add']) ? array() : $dorg[$tab]['add']; 
		foreach($data as $key=>$val){
			$str .= "$key => $val\n";
		}
		$res['add'] = $str;
		$res['na'] = count($data);
		return $res;
	}
	// 数据表 更新
	static function ddDone($data, $tab, $act='', $run=0){
		$db = glbDBObj::dbObj();
		$sql = ($act=='add' ? 'INSERT' : 'REPLACE')." INTO `{$db->pre}$tab{$db->ext}` VALUES";
		if(empty($data[$act])) return '';
		$data = $data[$act]; $i=0;
		foreach($data as $key=>$val){
			$i++;
			$val = $act=='add' ? $val : $val['new'];
			$ta = explode(':',$key);
			$row = "\n('";
			foreach($ta as $v1){
				$row .= "$v1','";
			}
			$row .= "$val".($i==count($data) ? ';' : ',');
			$sql .= $row;
		} //echo $sql;
		if($run){
			return $db->query($sql); 
		}else{
			return $sql; //str_replace(array("\n"),array("\n<br>"),$sql); 
		}
	}
	
	// 比较Table
	static function compTable($cfg){
		$tab = basReq::val('tab');
		$new = self::cacGet("dbcfg_new");
		$old = self::cacGet("dbcfg_old");
		$new = self::dbFields(self::dbCreate($tab,$new[$tab]));
		$old = self::dbFields(devData::stru1Exp($tab)); 
		return basArray::cmpArr($new,$old,'item');
	}
	
	// 比较文件
	static function compFile($cfg){
		$part = basReq::val('part');
		$file = basReq::val('file','','Html');
		$dcfg = array('code'=>DIR_CODE,'root'=>DIR_ROOT);
		$pnew = $cfg['path']."/$part/$file"; 
		$pold = $dcfg[$part]."/$file";
		$new = file($pnew); $old = file($pold); 
		return basArray::cmpArr($new,$old,'code');
	}
	
	//static $updreset = ''; 
	static function setStep($cfg,$step,$dir=0){
		if(is_array($step) && $step['key']=='dbdata'){
			$steps = $cfg['steps']; $step = $step['val'];
			$dbdata = str_replace("$step`$step`","$step`",$cfg['dbdata']."$step`");
		}else{
			$steps = str_replace("$step`$step`","$step`",$cfg['steps']."$step`");
			$dbdata = $cfg['dbdata'];
		}
		$br = "\r\n";
		$data = "path={$cfg['path']}{$br}steps=$steps{$br}dbdata=$dbdata{$br}vnew={$cfg['vnew']}{$br}vold={$cfg['vold']}{$br}done={$cfg['done']}";
		$f = comFiles::put(DIR_DTMP.self::$prereset,$data);
		$dir && header('Location:?');
	}
	
}



/*******************************************************************************
 File : \code\core\sdev\updBase.php 
*******************************************************************************/
<?php

// ...类
class updBase{	
	
	static $copys = array(
		'cfgs/sycfg/sy_updvnow.php' => 'code',
	);
	static $comps = array(
		'cfgs/boot/cfg_load.php' => 'code',
		'cfgs/boot/const.cfg.php' => 'code',
		'run/_paths.php' => 'root',
	);
	static $skipdirs = array('tpls','skin');
	static $prereset = '/store/_upd_reset.txt'; 
	
	// 检测锁定
	static function preCheck(){
		$data = comFiles::get(DIR_DTMP.self::$prereset);
		$dcfg = basElm::text2arr($data);
		if(@$dcfg['done']=='locked'){ 
			$msg = lang('updbase_lock1')."<br>";
			$msg .= "[".basDebug::hidInfo(DIR_DTMP)."/store/]:[_upd_reset.txt]<br>";
			$msg .= lang('updbase_tip1')."<br>";
			$msg .= lang('updbase_tip2');
			basMsg::show($msg,'die');
		}
		if(empty($dcfg['path']) || empty($dcfg['steps'])) return '';
		if(!is_dir($dcfg['path'])) return '';
		return $dcfg;
	}	
	// 检测路径
	static function preReset($path){
		$path = str_replace("\\","/",$path);
		$link = " &gt; <a href='?'>".lang('updbase_back')."</a>";
		if(!$path || !is_dir($path)){ 
			basMsg::show(lang('updbase_setdirerr',$path)."$link ",'die');
		}
		if(!is_dir(DIR_DTMP.'/update/')) mkdir(DIR_DTMP.'/update/');
		if(strstr($path,DIR_ROOT) || strstr($path,DIR_CODE)) die("Error Dir [$path]!");
		include($path."/code/cfgs/boot/const.cfg.php"); 
		$vnew = $_cbase['sys']['ver'];
		include(DIR_CODE."/cfgs/boot/const.cfg.php"); 
		$vold = $_cbase['sys']['ver'];
		if(version_compare($vold,$vnew)>=0){ 
			basMsg::show(lang('updbase_verbig'),'die');
		}
		$br = "\r\n";
		$data = "path=$path{$br}steps=`{$br}dbdata=`{$br}vnew=$vnew{$br}vold=$vold{$br}done=update";
		$f = comFiles::put(DIR_DTMP.self::$prereset,$data);
		if(!$f){ 
			basMsg::show(lang('updbase_notwrite',DIR_DTMP."/update/")."$link ",'die');
		}
		self::prePsyn($path,0);
	}
	// 同步比较文件
	static function prePsyn($path,$iscmp=1){
		$re = array(); 
		$dcfg = array('code'=>DIR_CODE,'root'=>DIR_ROOT);
		if(empty($iscmp)){// copy
			self::$copys = array(
				'cfgs/sycfg/sy_updvnow.php' => 'code',
			);
			foreach(self::$copys as $k=>$part){
				$pnew = $path."/$part/$k"; 
				$pold = $dcfg[$part]."/$k";
				$re['copy'] = @copy($pnew,$pold);
			}
		}else{// comp
			$re['comp'] = '<br>'.lang('updbase_compare');  
			self::$comps = array(
				'cfgs/boot/cfg_load.php' => 'code',
				'cfgs/boot/const.cfg.php' => 'code',
				'run/_paths.php' => 'root',
			);
			foreach(self::$comps as $k=>$part){
				$re['comp'] .= " : <a href='?act=cmpfile&file=$k&part=$part' target=x>".basename($k)."</a>";
			}
		}
		return $re;
	}
	
	static function fileAdd($new,$old,$pnew,$pold){
		$re = array();
		foreach($new as $k=>$v){
			if(!isset($old[$k])){
				if($dpos=strpos($k,'/')){ 
					$a = explode('/',$k); 
					$path = $pold; $tmp = '';
					foreach($a as $i=>$d){ 
						if(!is_dir($path."$tmp/$d")){ 
							mkdir($path."$tmp/$d", 0777, true);	
							foreach(array('htm','html') as $var) @touch($path."$tmp/$d".'/index.'.$var);	
						}
						$tmp .= "/$d"; 
						if($i>=count($a)-2) break;
					}
				}
				$f = @copy("$pnew/$k","$pold/$k");
				$re[$k] = $f;
			}
		}
		return $re;
	}
	static function fileEdit($new,$old,$pnew,$pold){
		$re = array();
		$upcfgs = glbConfig::read('updvnow','sy');
		$compcfgs = $upcfgs['compcfgs'] + $upcfgs['dellist']; 
		foreach($new as $k=>$v){
			if(in_array($k,$compcfgs)) continue;
			if(!empty($old[$k]) && $old[$k]!=$new[$k]){
				$f = @copy("$pnew/$k","$pold/$k");
				$re[$k] = $f;
			}
		}
		return $re;
	}
	static function fileComp($new,$old,$pnew,$pold){
		$re = array();
		$upcfgs = glbConfig::read('updvnow','sy');
		$compcfgs = $upcfgs['compcfgs'];
		foreach($compcfgs as $k){
			if(!empty($old[$k]) && $old[$k]!=$new[$k]){
				similar_text(comFiles::get("$pnew/$k"),comFiles::get("$pold/$k"),$pre);
				$re[$k] = $pre;
			}
		}
		return $re;
	}
	//comFiles::copyDir($src,$dst)
	static function dirFix($pnew,$pold){
		$re = array();	
		$fl = comFiles::listDir($pnew);
		foreach($fl['dir'] as $dir=>$time){
			if(!is_dir("$pold/$dir")){
				$re[$dir] = mkdir("$pold/$dir");	
			}
		}
		return $re;
	}
	
	static function dbFields($row,$rem=1){
		$arr = basElm::line2arr($row);
		$re = array();
		foreach($arr as $r){
			if(empty($r) || strpos($r,'EXISTS `') || strpos($r,'ENGINE=MyISAM') || strpos($r,'TABLE `')) continue;
			$r = trim(str_replace(array("\r","\n"),'',$r));
			if(substr($r,0,3)=='-- ') continue; 
			if(substr($r,-1,1)==','){
				$r = substr($r,0,strlen($r)-1);	
			}
			if(empty($rem) && strpos($r,"COMMENT '")){
				$r = substr($r,	0, strpos($r," COMMENT '"))." COMMENT ''";
			} 
			$p = strpos($r,'` ');
			if(substr($r,0,1)=='`' && $p){
				$k1 = substr($r,1,$p-1);
				$t1 = substr($r,$p+2);
				$re[$k1] = $t1;
			}else{
				$re[] = $r;	
			}
		}
		return $re;
	}
	
	static function dbCreate($tab,$v){
		$db = glbDBObj::dbObj();
		$i = 0;
		$sql = "CREATE TABLE `{$db->pre}$tab{$db->ext}` (\n"; 
		foreach($v as $k2=>$v2){
			$i++;
			$sql .= (is_numeric($k2) ? ' ' : " `$k2`")." $v2".($i==count($v) ? '' : ',')."\n";
		}
		$sql .= ") ENGINE=MyISAM DEFAULT CHARSET=utf8;\n"; 
		return $sql;
	}
	static function dbTable($new,$old,$cfg){
		$db = glbDBObj::dbObj();
		$add = array();
		foreach($new as $tab=>$v){
			if(!isset($old[$tab])){
				$db->query("DROP TABLE IF EXISTS `{$db->pre}$tab{$db->ext}`;");
				$sql = self::dbCreate($tab,$v);
				$f1 = $db->query($sql); 
				$f2 = devData::dataImpInsert("/dborg/data~",$tab,$cfg['path'].'/vary/dtmp');
				$add[$tab] = array('f1'=>!$f1,'f2'=>$f2,'sql'=>$sql);
			} 
		}
		self::cacSave($add,"dbadd_tab");
		$re = array();
		foreach($new as $tab=>$v){
			if(isset($add[$tab])) continue;
			$sqlhead = "ALTER TABLE `{$db->pre}$tab{$db->ext}` \n";
			$acols = array();
			foreach($v as $k2=>$v2){
				if(!is_numeric($k2) && empty($old[$tab][$k2])){
					$acols[$k2] = "ADD `$k2` $v2";	
				}
			}
			if(!empty($acols)){
				$i = 0;
				$sqla = $sqld = $sqlhead; 
				foreach($acols as $k2=>$v2){
					$i++;
					$sqla .= " $v2".($i==count($acols) ? ';' : ',')."\n";
					//$sqld .= " DROP COLUMN `$k2`".($i==count($acols) ? ';' : ',')."\n"; 
				} 
				$re[$tab]['add'] = $sqla;
				//$re[$tab]['del'] = $sqld;
			} 
			foreach($v as $k2=>$v2){
				if(isset($acols[$k2])) continue;
				if($v2!=@$old[$tab][$k2]){ 
					$oldval = empty($old[$tab][$k2]) ? '[null]' : $old[$tab][$k2];
					$re[$tab]['edit'] = (empty($re[$tab]['edit']) ? '' : $re[$tab]['edit'])."\n$oldval -=> $v2";
					if(!is_numeric($k2)){
						$re[$tab]['sql'] = (empty($re[$tab]['sql']) ? '' : $re[$tab]['sql'])."\n CHANGE `$k2` `$k2` $v2;";
					}else{
						$re[$tab]['idx'] = (empty($re[$tab]['idx']) ? '' : $re[$tab]['idx'])."\n$v2;";
					}
				}
			}
		}
		self::cacSave($re,"dbedit_cols");
		return $add;	
	}
	
	static function cacSave($arr,$file,$path=''){
		$arr = is_array($arr) ? $arr : self::listDir($arr); 
		$data = var_export($arr,1);
		$data = "<?php\nreturn $data; \n"; 
		$path = empty($path) ? DIR_DTMP."/update" : $path; 
		$file = strpos($file,'.') ? $file : "$file.php";
		comFiles::put("$path/$file",$data);
	}
	static function cacGet($file,$path=''){ 
		$path = empty($path) ? DIR_DTMP."/update" : $path;
		$file = strpos($file,'.') ? $file : "$file.php";
		return file_exists("$path/$file") ? include("$path/$file") : array();
	}
	
	static function listDir($dir,$sub=''){
		$re = array();
		$handle = opendir($dir);
		while ($file = readdir($handle)) {
			if($file=='.'||$file=='..') continue;
			$key = "{$sub}$file";
			$fp = "$dir/$file";
			if(is_dir($fp)){
				if(empty($sub) && in_array($file,self::$skipdirs)) continue;
				$re = array_merge($re,self::listDir($fp,"$sub$file/")); 
			}else{
				$re[$key] = md5(comFiles::get($fp));
			}
		}
		closedir($handle);
		return $re;
	}
	
	// file:完整路径,或字符串
	static function listTab($file,$cfg=array(),$rem=1){
		$data = file_exists($file) ? comFiles::get($file) : $file;
		$pre = isset($cfg['pre']) ? $cfg['pre'] : '{pre}'; 
		$ext = isset($cfg['ext']) ? $cfg['ext'] : '{ext}'; 
		$a = explode("CREATE TABLE `$pre",$data); 
		$re = array(); 
		foreach($a as $t){ 
			if(!strpos($t,"$ext` (")) continue;
			$b = explode("$ext` (",$t); 
			$re[$b[0]] = self::dbFields($b[1],$rem); 
		}
		return $re;
	}

	static function listData($file,$km=1){
		if(!file_exists($file)) return array();
		$arr = file($file);
		$re = array(); $n = 0;
		foreach($arr as $row){
			if(strlen($row)<10) continue;
			$row = str_replace(array("\r","\n"),'',$row);
			$row = substr($row,0,strlen($row)-1);	
			if(strstr($row,'INSERT INTO `{pre}')){
				 $n++; continue;
			}
			if($n){
				$rb = explode("','",$row);
				$key = ''; $m = 0;
				foreach($rb as $rv){
					if($m<$km) $key .= (empty($key) ? '' : "','").$rv;
					$m++;
					if($m>=$km){ 
						$len = strlen($key);
						$key = str_replace(array("('","','"),array("",":"),$key);
						$re[$key] = substr($row,$len+3);
						break;
					}
				}
			}
		}
		return $re;
	}

	// stamp:忽略时间戳, null:忽略01空数据, first:附加第一个(一般为id)
	static function listDataEx1($file,$km=0,$opt=array()){
		if(empty($opt)){
			$opt = array('stamp'=>1, 'null'=>0, 'first'=>1);
		}
		if(!file_exists($file)) return array();
		$data = comFiles::get($file);
		if(!empty($opt['stamp'])) $data = preg_replace("/\,\'\d{8,12}\'/i",",'0'",$data);
		$arr = explode("\n",$data); //file($file);
		$re = array(); $n = 0;
		foreach($arr as $row){
			if(strlen($row)<10) continue;
			$row = str_replace(array("\r","\n"),'',$row);
			$row = substr($row,0,strlen($row)-1);	
			if(strstr($row,'INSERT INTO `{pre}')){
				 $n++; continue;
			}
			if($n){
				$rb = explode("','",$row);
				$len = 0;
				foreach($rb as $m=>$rv){ 
					$len += strlen($rv)+3; 
					if($m==$km){ 
						$val = substr($row,$len-1);
						if(!empty($opt['null'])) $val = str_replace(array(",''",",'0'",",'1'"),"",$val);
						if(!empty($opt['first'])) $val = "$rb[0]'):$val";
						$re["$rv"] = $val; 
					}
				}
			}
		}
		return $re;
	}

}



/*******************************************************************************
 File : \code\core\sdev\updDbcmp.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

// ...类updDbcmp
class updDbcmp{	
	
	static $cpcfgs = array();
	
	static function uimpCheck(){
		bootPerm_ys('pstools','','<p><a href="../adbug/binfo.php?login">login</a></p>');
		if(empty(self::$cpcfgs)){
			$db = glbDBObj::dbObj();
			$ocfgs = glbConfig::read('outdb','ex');
			$ocfgs = $ocfgs['psyn']['odbcfgs'];
			$ocfgs = array_merge($db->config,$ocfgs); 
			$res = devRun::runMydb3($ocfgs); 
			$res = @$res[$ocfgs['db_class']];
			self::$cpcfgs = array('new'=>$db->config, 'old'=>$ocfgs, 'res'=>$res,);  
		}
		return self::$cpcfgs;   
	}
	
	static function uimpInit(){
		$dbcfgs = self::uimpCheck();
		// new
		$cnew = devData::struExp(0); 
		$cnew = updBase::listTab($cnew,array(),0); 
		updBase::cacSave($cnew,'uimp_new');
		// old
		$cold = devData::struExp(0,$dbcfgs['old']); 
		$cold = updBase::listTab($cold,array(),0);
		updBase::cacSave($cold,'uimp_old');
	}
	
	// $cfgs : array('__ufuncs'=>'mufunc')
	static function uimpTabs($new,$old,$cfgs=''){
		$res = array(); 
		foreach($new as $tab=>$v){
			if(!isset($old[$tab])) continue;
			$flag = devBase::_tabIncfg($tab,$cfgs);
			if(!($flag)) continue;
			$fields = array();
			foreach($v as $k2=>$v2){
				if(is_numeric($k2)) continue; 
				if(isset($old[$tab][$k2])){
					$fields[] = $k2;
				}
			}
			$fstr = implode('`,`',$fields);
			$res[] = "INSERT INTO dbnew.{pre}$tab{ext} (`$fstr`) \n SELECT `$fstr` FROM dbold.{pre}$tab{ext};\n";
		}
		return $res;
	}
	
	static function cmpIndex($new,$old,$seq=0){
		$res = array('add'=>array(),'old'=>array(),'eq'=>array(),); 
		$arr = array('new'=>'add','old'=>'old');
		foreach($arr as $key=>$ak){
			foreach($$key as $tab=>$v){
				$tmp = $key=='new' ? $old : $new;
				if(!isset($tmp[$tab])) continue;
				foreach($v as $k2=>$v2){
					if(!is_numeric($k2)) continue; 
					if(!in_array($v2,$tmp[$tab])){
						$res[$ak][$tab][] = $v2;
					}elseif($key=='new'){
						$res['eq'][$tab][] = $v2;
					}
				}
			}	
		}
		if(!$seq){ //显示相等的
			unset($res['eq']);
		}
		return $res;	
	}
	
	static function cmpFSkip($new,$old){
		$rep = array("DEFAULT ''","COMMENT ''");
		$arr = array('new','old');
		foreach($arr as $key){
			$$key = preg_replace("/COMMENT \'[^>]{0,48}\'/","COMMENT ''",$$key);
			$$key = str_replace($rep,'',$$key);		
		}
		return trim($new)==trim($old);
	}
	
	static function cmpField($new,$old,$seq=0){
		$res = array('edit'=>array(),'add'=>array(),'old'=>array(),'skip'=>array(),'eq'=>array(),); 
		foreach($new as $tab=>$v){
			if(!isset($old[$tab])) continue; //echo "\n<br>::a:[$tab]";
			foreach($v as $k2=>$v2){
				if(is_numeric($k2)) continue; 
				if(!isset($old[$tab][$k2])){
					$res['add'][$tab][$k2] = $v2;
				}elseif($old[$tab][$k2]==$v2){
					$res['eq'][$tab][] = $v2;
					unset($old[$tab][$k2]);
				}elseif($old[$tab][$k2]!=$v2){ //echo "\n<br>::[$tab][$k2]";
					$k3 = self::cmpFSkip($v2,$old[$tab][$k2]) ? 'skip' : 'edit';
					$res[$k3][$tab][$k2] = array('old'=>$old[$tab][$k2],'new'=>$v2,);
					unset($old[$tab][$k2]);
				}
	
			} //echo "<br>$tab,";
			if(!empty($old[$tab])){ 
				foreach($old[$tab] as $k3=>$v3){
					if(is_numeric($k3)) continue; 
					$res['old'][$tab][$k3] = $v3;	
				}
			}
		}
		if(!$seq){ //显示相等的
			unset($res['eq']);
		}
		return $res;
	}
	
	static function cmpTable($new,$old){
		$res = array();
		$arr = array('new'=>'add','old'=>'old');
		foreach($arr as $key=>$ak){
			if(!empty($$key)){
			foreach($$key as $k=>$v){
				$tmp = $key=='new' ? $old : $new;
				if(!isset($tmp[$k])){
					$res[$ak][] = $k;
				}
			}}
		}
		return $res;
	}

}




/*******************************************************************************
 File : \code\core\sdev\updInfo.php 
*******************************************************************************/
<?php

// ...类
class updInfo{	
	
	static $server_file = '/dset/_upd_server.htm';
	static $client_file = '/dset/_upd_client.htm';
	static $modstat_file = '/dset/_upd_modstat.php'; 
	static $space_file = '/dset/_upd_spaceinfo.php';
	
	static $updtcfg = array(
		'sync'  => '10d', //10d
		'stat'  => '3h', //3h
		'space' => '24h', //24h
	);
	
	//3.0.2015.1225
	static function verComp($new,$old){
		$f = version_compare($old,$new);
		return $f;
	}
	
	// ServerInfo
	static function getServerInfo(){
		$nf = self::getLangFile(self::$server_file);
		$data = self::getCacheData($nf,'sync');
		if(empty($data)){
			// ● [资讯]2015-0501：微信接口基本完成 [2015-05-05] 
			$db = glbDBObj::dbObj();
			$list = $db->table('docs_news')->where("catid='nsystem'")->limit(3)->order('did DESC')->select();
			if($list){foreach($list as $r){
				$url = cfg('run.rsite').vopUrl::fout("chn:news.$r[did]");
				$a = "<a href='$url' target='_blank'>$r[title]</a>";
				$data .= "<br>● $a [".date('Y-m-d',$r['atime'])."]\n";
			}}
			comFiles::put(DIR_DTMP.$nf,$data);
		}
		return $data;
	}	
	
	// ClientInfo
	static function getClientInfo(){
		global $_cbase;
		$nf = self::getLangFile(self::$client_file);
		$data = self::getCacheData($nf,'sync','data');
		if(empty($data)){
			// ● 当前版本：3.0.2015.1225（官方版本：3.0.2015.1225）
			$surl = $_cbase['server']['txmao']."/root/plus/api/update.php";
			$nver = $_cbase['sys']['ver']; //echo ".$surl.";
			$sver = comHttp::doGet("$surl?act=version",8); 
			$sdata = comHttp::doGet("$surl?act=server",8);
			$linkb = "● ".lang('updinfo_nowver')."V{$nver}"; 
			$slang = substr($_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2);
			$surl = $slang=='zh' ? 'dev' : 'doc';
			$linkr = "<a href='".$_cbase['server']['txmao']."/$surl.php?start' target='_blank' title='".lang('updinfo_viewdown')."'>V$sver</a>";
			if(strstr($sdata,'<br>● <a') && strlen($sver)>=3 && strlen($sver)<=18){ 
				$data = "{$linkb}".lang('updinfo_remver',$linkr)."\n$sdata";
			}else{
				$data = "{$linkb}".lang('updinfo_remerr')."\n";
			}
			comFiles::put(DIR_DTMP.$nf,$data);
		}
		return $data;
	}	

	// SysInfo sys
	static function getModStat(){
		$nf = self::getLangFile(self::$modstat_file);
		$data = self::getCacheData($nf,'stat','array');
		if(empty($data)){
			$db = glbDBObj::dbObj();
			$mcfgs = self::getModConfigs(); // ● [订单] 当天:11，3天:44，总计:99
			$tcfgs = self::getTimeConfigs();
			$data = array();
			foreach($mcfgs as $pmod=>$mods){foreach($mods as $mod){foreach($tcfgs as $tk=>$tv){
				$key = "{$mod}_$tk";
				$whr = "atime>='$tv'";
				$data[$key] = $db->table("{$pmod}_$mod")->where($whr)->count();
			}}}
			$dstr = var_export($data,1);
			$dstr = "<?php\n\$data = $dstr\n?>";
			comFiles::put(DIR_DTMP.$nf,$dstr);
		}
		return $data;
	}

	// SpaceInfo
	static function getSpaceInfo(){
		$nf = self::getLangFile(self::$space_file);
		$data = self::getCacheData($nf,'space','array');
		if(empty($data)){
			$db = glbDBObj::dbObj();
			$sum = 0;
			$data = array('db'=>array('data'=>0,'index'=>0,'free'=>0));
			$tabinfo = $db->tables(1); 
			foreach($tabinfo as $r){ 
				$data['db']['data'] += $r['Data_length'];
				$data['db']['index'] += $r['Index_length'];
				$data['db']['free'] += $r['Data_free'];
			}
			$sum = $data['db']['data'];
			$cfgs = glbConfig::read('pubcfg','sy');
			$data['dir']['main'] = 0;
			foreach($cfgs['dirs'] as $key=>$dir){
				$idir = comFiles::statDir($dir);
				$data['dir'][$key] = $idir['nsize'];
				$sum += $idir['nsize'];
			}
			$data['dir']['main'] = $data['dir']['root'] + $data['dir']['code'];
			unset($data['dir']['root'],$data['dir']['code']);
			foreach(array('db','dir') as $key){foreach($data[$key] as $k=>$v){
				//$space = 
				$data[$key][$k] = basStr::showNumber($v,'Byte');
			}}
			$data['total'] = cfg('ucfg.space');
			$data['sum'] = basStr::showNumber($sum,'Byte');
			$dstr = var_export($data,1);
			$dstr = "<?php\n\$data = $dstr\n?>";
			comFiles::put(DIR_DTMP.$nf,$dstr);	
		}
		return $data;
	}

	// showSpaceInfo
	static function showSpaceInfo(){
		$data = self::getSpaceInfo();
		$s1 = $s2 = ''; 
		$str = "\n<tr><td>".lang('updinfo_allspace')."</td><td colspan=6 class='tc'>{$data['total']}M ".lang('updinfo_uesspace',$data['sum'])."</td>";
		$str .= "<td><a href='?mkv=uhome&act=uspace'>".lang('updinfo_upd')."</a></td></tr>\n";
		foreach($data['dir'] as $key=>$val){
			$s1 .= "<td>$key</td>";
			$s2 .= "<td>$val</td>";
		}
		$str .= "<tr><td rowspan=2>".lang('updinfo_dir')."</td>$s1</tr>\n<tr>$s2</tr>\n";
		$str .= "<tr><td>".lang('updinfo_dbinfo')."</td><td></td>";
		foreach($data['db'] as $key=>$val){
			$str .= "<td colspan=2>$key=$val</td>";
		}
		$str .= "</tr>";
		echo $str;
	}

	// showSysInfo
	static function showModStat($key){
		$_groups = glbConfig::read('groups');
		$data = self::getModStat(); 
		$mcfgs = self::getModConfigs();
		$tcfgs = self::getTimeConfigs();
		foreach($mcfgs[$key] as $mod){ 
			$link = "<a href='?file=dops/a&mod=$mod'>{$_groups[$mod]['title']}</a>";
			$v = array();
			foreach($tcfgs as $tk=>$tv){
				$v[$tk] = empty($data[$mod."_$tk"]) ? 0 : $data[$mod."_$tk"];
			}
			echo "● [$link] ".lang('updinfo_st1day').":$v[d1], ".lang('updinfo_st3day').":$v[d3], ".lang('updinfo_st7day').":$v[d7], ".lang('updinfo_stall').":$v[all]\n<br>"; 
		}
	}

	// getTimeConfigs
	static function getTimeConfigs(){
		$hour0 = strtotime(date('Y-m-d')); 
		$tcfgs = array('d1'=>$hour0,'d3'=>$hour0-2*86400,'d7'=>$hour0-6*86400,'all'=>0);
		return $tcfgs;
	}

	// getModConfigs
	static function getModConfigs(){
		$mcfgs = glbConfig::read('modstat','sy');
		return $mcfgs;
	}
	// getCacheData
	static function getCacheData($file,$updkey,$type='data'){
		$file = DIR_DTMP.$file;
		$updtime = self::$updtcfg[$updkey];
		$upath = tagCache::chkUpd($file,$updtime,0);
		if($upath && $type=='data'){
			$data = comFiles::get($file);	
		}elseif($upath){
			include($file);
		}else{
			$data = array();	
		}
		$res = empty($data) ? ($type=='data' ? '' : array()) : $data;
		return $res;
	}
	// getLangFile
	static function getLangFile($file){
		$lang = cfg('sys.lang');
		$file = str_replace(array(".htm",".php"),array("-$lang.htm","-$lang.php"),$file);
		return $file;
	}
	

}




/*******************************************************************************
 File : \code\core\uext\ex1Test.php 
*******************************************************************************/
<?php

//cfg_load.php中，请自定义前缀ex1

// ex1Test
class ex1Test{	
	


}



/*******************************************************************************
 File : \code\core\uext\exaCrawl.php 
*******************************************************************************/
<?php

// Crawl函数; 单独函数可先用new exaCrawl();自动加载
class exaCrawl{

	static function public_uname($data,$res,$p1='',$p2='',$p3=''){
		return $res; 
	}
	
	static function model_uname($data,$res,$p1='',$p2='',$p3=''){
		return $res; 
	}
	
}

// 单独定义函数
function model_job_uname($data,$res,$p1='',$p2='',$p3=''){
	return $res; 
}



/*******************************************************************************
 File : \code\core\uext\exaCSeal.php 
*******************************************************************************/
<?php
/*
 * 中文圆形印章类
 * @author lkk/lianq.net
 * @create on 10:03 2012-5-29
 * @example:
 *  $seal = new exaCSeal('某某单位通用章',75,18,16,40);
 *  $seal->doImg();
 */ 

class exaCSeal {
	
	static $fpath = '/media/fonts/simkai.ttf'; //指定的字体
	
	private $sealString;    //印章字符  
    private $sealRadius;    //印章半径
    private $startRadius;   //五角星半径
	private $fontSize;      //指定字体大小
    private $inRadius;      //内圆半径
    
    private $backGround;    //印章颜色
    private $centerDot;     //圆心坐标
    private $img;           //图形资源句柄
    
    private $width;         //图片宽度
    private $height;        //图片高度
    
	private $strMaxLeng = 12 ;    //最大字符长度
	private $rimWidth = 6;      //边框厚度
	private $startAngle = 0;    //五角星倾斜角度
	private $charAngle = 0;     //字符串倾斜角度
	private $spacing = 0;       //字符间隔角度
 
    //构造方法
    public function __construct($str ='', $rad = 75, $strad = 24, $fsize = 16, $inrad =0){
        $this->sealString    = empty($str) ? lang('core.seal_defstr') : $str;
        $this->sealRadius    = $rad;
        $this->startRadius   = $strad;
        $this->fontSize      = $fsize;
        $this->inRadius      = $inrad;   //默认0,没有
		$this->centerDot     = array('x'=>$rad, 'y'=>$rad);
    }
 
    //创建图片资源
    private function createImg(){
        $this->width      = 2 * $this->sealRadius;
        $this->height     = 2 * $this->sealRadius;
        $this->img        = imagecreate($this->width, $this->height);
        imagecolorresolvealpha($this->img,255,255,255,127);
        $this->backGround = imagecolorallocate($this->img,255,0,0);
    }
 
	//画印章边框
	private function drawRim(){
		for($i=0;$i<$this->rimWidth;$i++){
			imagearc($this->img,$this->centerDot['x'],$this->centerDot['y'],$this->width - $i,$this->height - $i,0,360,$this->backGround);
		}
	}
 
	//画内圆
	private function drawInnerCircle(){
		imagearc($this->img,$this->centerDot['x'],$this->centerDot['y'],2*$this->inRadius,2*$this->inRadius,0,   45,$this->backGround);
		imagearc($this->img,$this->centerDot['x'],$this->centerDot['y'],2*$this->inRadius,2*$this->inRadius,135,360,$this->backGround);
	}
 
	//画字符串
	private function drawString(){
		//编码处理
		$charset = mb_detect_encoding($this->sealString);
		if($charset != 'UTF-8'){
			$this->sealString = mb_convert_encoding($this->sealString, 'UTF-8', 'GBK');
		}
		//相关计量
		$charRadius = $this->sealRadius - $this->rimWidth - $this->fontSize - 4;  //字符串半径
		$leng   = mb_strlen($this->sealString,'utf8');   //字符串长度
		if($leng > $this->strMaxLeng) $leng = $this->strMaxLeng;
		$avgAngle   = 360 / ($this->strMaxLeng); //平均字符倾斜度
		//拆分并写入字符串
		$words  = array();  //字符数组
		$font = DIR_STATIC.self::$fpath; 
		for($i=0;$i<$leng;$i++){
			$words[] = mb_substr($this->sealString,$i,1,'utf8');
			$r = 630 + $this->charAngle + $avgAngle*($i - $leng/2) + $this->spacing*($i-1);	   //坐标角度
			$R = 720 - $this->charAngle + $avgAngle*($leng-2*$i-1)/2 + $this->spacing*(1-$i); //字符角度
			$x = $this->centerDot['x'] + $charRadius * cos(deg2rad($r));	//字符的x坐标
			$y = $this->centerDot['y'] + $charRadius * sin(deg2rad($r));	//字符的y坐标
			imagettftext($this->img, $this->fontSize, $R, $x, $y, $this->backGround, $font, $words[$i]);
		}
	}   
 
	//画五角星
	private function drawStart(){
		$ang_out = 18 + $this->startAngle;
		$ang_in  = 56 + $this->startAngle;
		$rad_out = $this->startRadius;
		$rad_in  = $rad_out * 0.382;
		for($i=0;$i<5;$i++){
			//五个顶点坐标
			$points[] = $rad_out * cos(2*M_PI/5*$i - deg2rad($ang_out)) + $this->centerDot['x'];
			$points[] = $rad_out * sin(2*M_PI/5*$i - deg2rad($ang_out)) + $this->centerDot['y'];
			//内凹的点坐标
			$points[] = $rad_in * cos(2*M_PI/5*($i+1) - deg2rad($ang_in)) + $this->centerDot['x'];
			$points[] = $rad_in * sin(2*M_PI/5*($i+1) - deg2rad($ang_in)) + $this->centerDot['y'];
		}
		imagefilledpolygon($this->img, $points, 10, $this->backGround);
	}
 
	//输出
	private function outPut(){
		basEnv::obClean();
		header('Content-type:image/png');
		imagepng($this->img);
		imagedestroy($this->img);
		die();
	}
 
	//对外生成
	function doImg(){
		$this->createImg();
		$this->drawRim();
		$this->drawInnerCircle();
		$this->drawString();
		$this->drawStart();
		$this->outPut();
	}
	
	static function show($indep,$name='',$pos='',$tpl='',$eid='sceal_out'){ 
		 $tpl = empty($tpl) ? "<p class='cseal_out' title='".lang('core.seal_move')."'><i onclick='sealMove(this)' class='cseal_in {pos}' style='background-image:url({dept})'><b class='cseal_text'>{name}</b></i></p>" : $tpl;
		 $name = empty($name) ? lang('core.seal_mark') : $name;
		 if(file_exists(DIR_STATIC."/icons/indep/seal-$indep.png")){
			 $file = "seal-$indep.png";
		 }else{
			 $file = "seal-_comm.png";
		 }
		 $path = PATH_STATIC."/icons/indep/$file";
		 $tpl = str_replace(array('{dept}','{name}','{pos}'),array($path,$name,$pos),$tpl);
		 return $tpl;
	}
	
}




/*******************************************************************************
 File : \code\core\uext\exaFunc.php 
*******************************************************************************/
<?php

// 后台函数; 单独函数可先用new exaFunc();自动加载
class exaFunc{

	static function admenu_m1012(&$s0){
		$s0 .= '
		<ul class="adf_mnu2" id="left_m2test">
		  <li class="adf_dir">'.lang('admin.ef_demot').'</li>
		  
		  <li id="left_m3demo"><a href="?file=dops/a&amp;mod=demo" target="adf_main">'.lang('admin.ef_demodoc').'</a> - <a onClick="admJsClick(\'demo\')">'.lang('admin.ef_add').'</a></li>
		  <li id="left_m3drem"><a href="?file=dops/a&amp;mod=drem" target="adf_main">'.lang('admin.ef_demorem').'</a> - <a href="?file=admin/catalog&amp;mod=demo&amp;frame=1" target="_blank">'.lang('admin.ef_catalog').'</a></li>
		  
		  <li class="adf_dir">'.lang('admin.ef_typedetail').'</li>
		  <li id="left_m3b3"><a href="?file=admin/types&mod=indep" target="adf_main">'.lang('admin.ef_dept').'</a></li>
		  <li id="left_m3b1"><a href="?file=admin/types&mod=brand" target="adf_main">'.lang('admin.ef_brand').'</a></li>
		  <li id="left_m3b2"><a href="?file=admin/types&mod=china" target="adf_main">'.lang('admin.ef_china').'</a></li>
		 	  	
		  <li class="adf_dir">'.lang('admin.ef_umenu').'</li>
		  <li id="left_m3a1"><a href="?uhome" target="adf_main">'.lang('admin.ef_demoset').'</a>
		  <br><a href="?uhome" target="adf_main">\code\core\uext\</a>
		  <br><a href="?uhome" target="adf_main">exaFunc.php</a></li>
		  
		</ul>
		'; 
	}
	
}



/*******************************************************************************
 File : \code\core\uext\exaSearch.php 
*******************************************************************************/
<?php

function fsget_dirs($path) { 
	$now = BASE.$path; $s = '';
	$handle = opendir($now); 
	while($file=readdir($handle)){
	  if(is_dir("$now/$file")&&($file!="."&&$file!="..")){
		if(!strstr(SKIP,";$file;")) 
		  $s .= "\n<a href='?path=$path/$file' class='item'>/$file</a>";
	} }
	closedir($handle);
	return $s;
}

function fsget_file($path,$deep=0) { 
	global $dir,$skip,$ex1,$ex2,$key,$act,$file_arr; $now = BASE."/$path"; 
	$skip = str_replace(',',';',$skip);
	$skip = SKIP.";$skip;";
	$skip = str_replace(';;',';',$skip);
	$handle = opendir($now); 
	while($file=readdir($handle)){
	  //$file = strtolower($file);
	  if(is_file("$now/$file")){
		$f1 = 0; $f2 = 0;
		for($k=0;$k<count($ex1);$k++){
		  if(strstr($file,"$ex1[$k]")){ 
			$f1++; break;
		} }
		if(!$f1){
			  //echo "<br>ex1:$path/$file";
			  continue;
		}
		if($ex2){
		  for($k=0;$k<count($ex2);$k++){
			if(strstr($file,"$ex2[$k]")){ 
			  $f2++; break;
		} } }
		if($f2){
			  //echo "<br>ex2:$path/$file";
			  continue;
		}
		$size = filesize("$now/$file")/1024;
		if($size>FMAX){
			  //echo "<br>size:$path/$file";
			  continue;
		}
		
		if($key){
		  if($act=='File'){
			$data = $file; 
			$cset = 'x';
		  }else{
			$data = file_get_contents("$now/$file"); // null,lower 
			$data = strtolower($data); 
			$cset = mb_detect_encoding($data,array('ASCII','GB2312','BIG5','GBK','UTF-8'));
			$cset = str_replace('BIG-5','BIG5',$cset);
			if(!$cset){
			  if(strstr($data,'charset=gb2312')) $cset = 'gb2312';
			  if(strstr($data,'charset=gbk')) $cset = 'gbk';
			  if(strstr($data,'charset=big5')) $cset = 'big5';
			  if(strstr($data,'charset=utf-8')) $cset = 'utf-8';
			}
			if(!$cset) $cset = CSET;
			//if(strstr($data,'charset=big5')&&$cset='CP936') $cset = 'big5';
			//$cset = ($cset)?'utf-8':'y'; //is_utf8($data);
		  }
		  if(strstr($data,$key)){ 
			$size = round($size*100)/100; //round(xx/1024*100)/100 .' KB';
			$time = date("Y-m-d H:i",filemtime("$now/$file"));
			$link = "<a href='$path/$file'>$file</a>";
			$file_arr[] = array('file'=>"$path/$file",'size'=>$size,'time'=>$time,'cset'=>$cset);
		  }
		}else{
			//
		}
	  }
	  if(is_dir("$now/$file")&&($file!="."&&$file!="..")){
		if(!strstr($skip,";$file;")){ 
		  if($deep==0){
			$f3 = 0; 
			for($k=0;$k<count($dir);$k++){
			  if(strstr("$path/$file","$dir[$k]")){ 	
				$f3++; break;
			  }
			}
			if($f3) fsget_file("$path/$file",$deep+1);  
		  }else{
			fsget_file("$path/$file",$deep+1);  
		  }
	  } } 
	} 
	closedir($handle);
	//return $file_arr;
}

function fsdir_cbox($path) { //  checked="checked"
	global $redir,$dir;
	$now = BASE.$path; $s = '';
	$handle = opendir($now); 
	while($file=readdir($handle)){
	  if(is_dir("$now/$file")&&($file!="."&&$file!="..")){
		if(!strstr(SKIP,";$file;")){
		  if(!strstr($redir,"$file")) $ckstr = '';
		  else $ckstr = 'checked="checked"';
		  if(in_array($file,$dir)) $ckstr = 'checked="checked"';
		  $s .= "<span class='item'><input type='checkbox' name='dir[]' id='dir[]' value='$file' $ckstr />$file </span>";
	} } } 
	closedir($handle);
	return $s;
}
function fsext_list($n) { 
	global $reex1,$reex2,$ex1,$ex2;
	if($n==1) $reext = $reex1;
	if($n==2) $reext = $reex2;
	$a = explode(';',FEXT); $s = '';
	for($i=0;$i<count($a);$i++){
		if(!strstr($reext,$a[$i])) $ckstr = '';
		else $ckstr = 'checked="checked"';
		if($n==1&&in_array(".$a[$i]",$ex1)) $ckstr = 'checked="checked"';
		if($n==2&&in_array(".$a[$i]",$ex2)) $ckstr = 'checked="checked"';
		$s .= "<span class='iext'><input type='checkbox' name='ex{$n}[]' id='ex{$n}[]' value='.$a[$i]' $ckstr />.$a[$i] </span>";
	}
	return $s;
}




/*******************************************************************************
 File : \code\core\uext\exmCrawl.php 
*******************************************************************************/
<?php

// 
class exmCrawl{

	//static $blnka = 'href = "';

	public $flags = array(
		'p1' => 'id="content_left"',
		'p2' => 'id="page"',
		'p3' => 'id="content_bottom"',
	);

    //构造方法
    function __construct($site,$kw='',$pn=73){
    	$kw = $kw ? urlencode($kw)."%20" : '';
    	$url = "https://www.baidu.com/s?wd={$kw}site%3A$site&pn={$pn}0";
    	$this->initPage($url);
    }

    function initPage($url){
        $html = comHttp::doGet($url); //dump($html);
        $flags = $this->flags;
        $links = basElm::getPos($html,$flags['p1'].'(*)'.$flags['p2']);
        $pages = basElm::getPos($html,$flags['p2'].'(*)'.$flags['p3']);
        $tmp = explode('href = "',$links);
        $links = array();
        foreach ($tmp as $val) {
        	$val = substr($val,0,strpos($val,'"'));
        	if(!strpos($val,'link?url=')) continue;
        	$links[] = $val; //dump($val);
        }
        $pages = basElm::getArr($pages,'<span class="pc">(*)</span>');
        $this->data = array('links'=>$links,'pages'=>$pages,'url'=>$url);
        return;
    }



}



/*******************************************************************************
 File : \code\core\uext\exmFunc.php 
*******************************************************************************/
<?php

// 会员中心函数; 单独函数可先用new exmFunc();自动加载
class exmFunc{
	
	//
	
}



/*******************************************************************************
 File : \code\core\uext\exvCron.php 
*******************************************************************************/
<?php

// exvCron计划任务
class exvCron{

	static function getCfgs(){ 
		//return $cfg;	
	}

	static function plistAll(){ 
		$db = glbDBObj::dbObj();
		$list = "\n";
		$larr = $db->table('bext_cron')->where("1=1")->select(); 
		foreach($larr as $val){
			$list .= "\tnew Array('{$val['kid']}','{$val['exsecs']}'), // {$val['title']}\n";
		}
		return $list;
		/*
            [excycle] => 5
            [excunit] => d
            [exlast] => 1466984842
            [exnext] => 1467418687
		*/
	}

	static function plistTest(){ 
		$hm1 = date('H:i');
		$hm2 = $hm1."@".date('w');
		$hm3 = $hm1."@".((date('w')+3)%7);
		$hm4 = date('H:i', time()+60);
		$list = "\n";
		for($i=1;$i<=4;$i++){
			$k = "hm$i";
			$list .= "\tnew Array('script_$i','{$$k}'),\n";
		}
		return $list;
	}
	
/*
 
*/

}



/*******************************************************************************
 File : \code\core\uext\exvFunc.php 
*******************************************************************************/
<?php

// 显示相关函数; 单独函数可先用new exvFunc();自动加载
class exvFunc{

	// comjs.php使用
	static function actMods($act,$key){
		if(strstr($act,';')){ 
			$a = explode(';',$act);
			foreach($a as $v){ 
				if(strstr($v,$key)){ 
					return str_replace("$key:","",$v);
				}
			}
			return '';
		}else{
			return basReq::val('mod','');	
		}
	}

}



/*******************************************************************************
 File : \code\core\uext\exvJump.php 
*******************************************************************************/
<?php

// 显示相关函数; 单独函数可先用new exvJump();自动加载
class exvJump{

	static $jcfg = array();

	// 获得多语言-跳转地址
	static function getLang(){
	    $jcfg = self::getCfgs();
	    $nkey = $jcfg['deflang']; //未找到地区时的默认网站
		$lang = substr($_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2);
		//$_cbase['sys']['lang'] = $lang=='zh' ? 'cn' : 'en';
	    foreach($jcfg['langs'] as $key=>$kname){
	        if($lang==$key){
	            $nkey = $kname;
	            break;        
	        }
	    }
	    $nurl = vopUrl::fout("$kname:0"); 
	    return $nurl;
	}

	// 获得分站-跳转地址
	static function getDir($uaddr){
	    $jcfg = self::getCfgs();
	    $nkey = $jcfg['defsite']; //未找到地区时的默认网站
	    foreach($jcfg['sites'] as $key=>$kname){
	        if(strstr($uaddr,$kname)){
	            $nkey = $key;
	            break;        
	        }
	    }
	    $nurl = "http://$nkey.{$jcfg['domain']}/"; // 组装完整url
	    return $nurl;
	}

	// 获得分站数据，供各分站调用
	static function getSites(){
	    $data = array();
	    foreach($sub_sites as $key=>$kname){
	        $data[$key] = array('name'=>$kname, 'url'=>"http://$key.{$jcfg['domain']}/");
	    }
	    $data = comParse::jsonEncode($data);
	    return $data;
	}

	// 获得ujump配置
	static function getCfgs($key=''){
		if(empty(self::$jcfg)){
			self::$jcfg = glbConfig::read('ujump','ex');
		}
		return $key && isset(self::$jcfg[$key]) ? self::$jcfg[$key] : self::$jcfg;
	}


}



/*******************************************************************************
 File : \code\core\uext\exvOcar.php 
*******************************************************************************/
<?php

// Ocar相关函数
// 各模版公用
class exvOcar{
	
	static function shipfee($from,$to,$weight){ 
		$weight || $weight = 0.1;
		$from = self::shipfix($from); 
		$to = self::shipfix($to); 
		$url = "http://www.chakd.com/index.php?action=search&start=$from&end=$to&weight=$weight&Submit=1";
		$data = comHttp::doGet($url, 3); //echo $data;
		$data = comConvert::autoCSet($data,'gb2312','utf-8'); //echo $data;
		$arr = explode('</tr>',$data);
		$data = array();
		foreach($arr as $row){
			if(strpos($row,'天</div></td>') && strpos($row,'元</div></td>')){
				$row = strip_tags($row,'<td>'); //echo "::\n$row";
				$ar2 = explode('</td>',$row); //echo "::\n$row";
				foreach($ar2 as $k=>$v){
					$v = preg_replace("/\s(?=\s)/","\\1",strip_tags($v)); 
					$v = trim($v);
					$ar2[$k] = $v;
				}
				$data[] = $ar2;
			}
		} //print_r($data);
		$devs = glbDBExt::getExtp('logmode_cn'); //print_r($devs);
		foreach($devs as $key=>$row){ 
			foreach($data as $fee){
				if(strstr($fee[0],$row['title'])){
					$devs[$key]['ufee'] = $fee[1];
					$devs[$key]['uday'] = $fee[2];
				}
			}
		}
		return $devs;
	}
	
	static function shipfix($area){
		if($area=='中山'){ $area = '中山市'; } //单个修正
		elseif(in_array($area,array('三沙','钓鱼岛'))){ $area = '暂无.服务'; } //单个修正
		elseif(in_array($area,array('宜兰','桃园','苗栗','彰化','南投','云林','屏东','台东','花莲','澎湖','金门','马祖','新竹','台中','嘉义','台南'))){ $area = '台湾'; } //台湾 台北基隆新竹台中嘉义台南'高雄',
		elseif(in_array($area,array('定安县','五指山市','屯昌县','琼海市','澄迈县','儋州市','临高县','文昌市','白沙县','万宁市','昌江县','东方市','乐东县','陵水县','保亭县','琼中县'))){ $area = '海口'; } //海南， '海口','三亚', 
		elseif(in_array($area,array('北京','天津','上海','重庆','香港','澳门'))){ ; } //原型, 
		elseif(strlen($area)>6){ ; } //原型, 乌鲁木齐
		else{ ; } //通用 $area = $area.'市';
		$area = urlencode(comConvert::autoCSet($area,'utf-8','gbk'));
		return $area;
	}
	
	static function whruser(){ 
		$stamp = time();
		$user = usrBase::userObj('Member'); //print_r($user);
		$uadm = usrBase::userObj('Admin'); //print_r($uadm);
		$enc = basReq::val('enc');
		if($uadm->userFlag=='Login'){
			$re['flag'] = 'Admin';
			$re['sql'] = '1=1';
			$re['uname'] = @$uadm->uinfo['unamexx'];
			//uinfo
		}elseif($uadm->userFlag=='Login'){
			$re['flag'] = 'Member';
			$re['sql'] = "auser='{$uadm->uinfo['uname']}' AND ordstat='new' AND atime>'".($stamp-30*60)."'";
			$re['uname'] = @$uadm->uinfo['uname'];
		}else{
			$re['flag'] = 'Guest';
			$re['sql'] = "eip='$enc' AND ordstat='new' AND atime>'".($stamp-30*60)."'";
			$re['uname'] = @$uadm->uinfo['uname'];	
		}
		return $re;
	}
	
	static function ostat($ouser,$order){
		$cfg1 = array('feeship','feedis','feetotle','trakeno','tradeurl',);
		$cfg2 = array('ordstat','ordpay','ordship',);
		$cfg3 = array('btndel','btnedit','btnpay',);
		$res = array();
		$flag = $ouser['flag'];
		$ordstat = $order['ordstat'];
		$stamp = time()-$order['atime']; //<($flag=='Admin' ? 5*86400 : 30*60);
		//$flag = 'xxMember'; 
		//$stamp = 6666666;
		if($flag=='Admin'){
			foreach($cfg1 as $key){
				$res[$key] = "";	
			}
			foreach($cfg2 as $key){
				$res[$key] = "";	
			}
			$res['uinfos'] = "";
			$res['uexp'] = "";
		}elseif($flag=='Member'){ 
			foreach($cfg1 as $key){
				$res[$key] = $stamp<30*36 ? '' : " disabled style='background:#EEE;'";	
			}
			foreach($cfg2 as $key){
				$res[$key] = $stamp<30*36 ? '' : " disabled style='background:#EEE;'";
			}
			$res['uinfos'] = $stamp<30*36 ? '' : " disabled style='background:#EEE;'";	
			$res['uexp'] = $order['auser']==$ouser['uname'] ? '' : "exp";	
		}else{ 
			foreach($cfg1 as $key){
				$res[$key] = " disabled style='background:#EEE;'";	
			}
			foreach($cfg2 as $key){
				$res[$key] = " disabled style='background:#EEE;'";	
			}
			$res['uinfos'] = " disabled style='background:#EEE;'";	
			$res['uexp'] = $stamp<30*36 ? '' : "exp";	
		}
		if($res['uexp']){
			$res['trakeno'] = '';
			$res['tradeurl'] = '';
		}
		$res['btndel'] = ($flag=='Admin' || $stamp<30*36) ? '' : " disabled style='color:#999'";
		$res['btnedit'] = ($flag=='Admin' || $stamp<30*36) ? '' : " disabled style='color:#999'";	
		$res['btnpay'] = (in_array($ordstat,array('new','doing'))) ? '' : " disabled style='color:#999'";
		return $res;
	}
	
	static function oadd($unqid,$user){ 
		$db = glbDBObj::dbObj();
		$fm = basReq::arr('fm');
		$kar = glbDBExt::dbAutID('coms_corder','yyyy-md-','32');
		$fm['cid'] = $fm['title'] = $kar[0]; 
		$fm['cno'] = $kar[1];
		$fm['ordstat'] = 'new';
		$fm['auser'] = @$user->uinfo['uname'];
		$fm['eip'] = comConvert::sysEncode($fm['atime'].$unqid);
		// 加数据
		$db->table('coms_corder')->data(basReq::in($fm))->insert();
		// 转数据
		$db->table('coms_cocar')->data(array('ordid'=>$fm['cid'],'eip'=>$fm['eip']))->where("ordid='$unqid'")->update();
		$db->query("INSERT INTO {$db->pre}coms_coitem{$db->ext} SELECT * FROM {$db->pre}coms_cocar{$db->ext} WHERE ordid='{$fm['cid']}'");
		$db->table('coms_cocar')->where("ordid='{$fm['cid']}'")->delete();
		// 重置状态
		comCookie::oset('ocar_items',0);
		return array('ordid'=>$fm['cid'],'enc'=>$fm['eip']);
	}
	
	static function odel($ordid){ 
		$db = glbDBObj::dbObj();
		$ouser = self::whruser();
		$where = $ouser['sql'];
		$erow = $db->table('coms_corder')->where("cid='$ordid' AND $where")->delete();
		$erow && $db->table('coms_coitem')->where("ordid='$ordid'")->delete();
		return $erow;
	}
	static function oedit($ordid){ 
		$db = glbDBObj::dbObj();
		$ouser = self::whruser();
		$where = $ouser['sql'];
		$fm = basReq::arr('fm');
		$erow = $db->table('coms_corder')->data(basReq::in($fm))->where("cid='$ordid' AND $where")->update();
		return $erow;
	}
	
	static function iadd($unqid,$user){ 
		$db = glbDBObj::dbObj();
		$fm['cid'] = basReq::val('cid');
		$fm['pid'] = basReq::val('pid');
		$fm['ordid'] = $unqid;
		$fm['ordcnt'] = basReq::val('ordcnt','0','N');
		$fm['ordprice'] = basReq::val('ordprice','0','N');
		$fm['title'] = basReq::val('title','');
		$fm['ordweight'] = basReq::val('ordweight','0','N');
		$kar = glbDBExt::dbAutID('coms_cocar','yyyy-md-','32');
		$fm['cid'] = $kar[0]; 
		$fm['cno'] = $kar[1];
		$fm['auser'] = @$user->uinfo['uname'];
		if($db->table('coms_cocar')->where("ordid='$unqid' AND pid='$fm[pid]'")->find()){
			$msg = "该商品已经在购物车！";
		}else{
			$db->table('coms_cocar')->data(basReq::in($fm))->insert();
			$msg = $fm['title'].' : 添加成功！'; 
		}
		return $msg;
	}
	
	static function ilist($tabid,$where,$limit=99){ 
		$db = glbDBObj::dbObj();
		$list = $db->table($tabid)->where($where)->limit($limit)->select();
		$data = array(); $afee = 0.00; $aweight = 0.00; $acnt = 0;
		if($list){ foreach($list as $i=>$r){ 
			$r['i'] = $i+1;
			$r['ifee'] = $r['ordcnt']*$r['ordprice'];
			$afee += $r['ifee'];
			$aweight += $r['ordweight'];
			$acnt += $r['ordcnt'];
			$r['ifee'] = basReq::fmtNum($r['ifee']);
			$r['ordprice'] = basReq::fmtNum($r['ordprice']);
			$r['ordweight'] = basReq::fmtNum($r['ordweight']);
			$data[] = $r;
		} } 
		return array('data'=>$data,'sum'=>array('afee'=>basReq::fmtNum($afee),'acnt'=>$acnt,'aweight'=>$aweight));
	}
	
	
}



/*******************************************************************************
 File : \code\core\uext\exvOpay.php 
*******************************************************************************/
<?php

// exvOpay相关函数
// 各模版公用
class exvOpay{

	static function getCfgs(){ 
		$cfg = array(
			'paydemo' => array(
				'dir' => 'paydemo_dir',
				'method' =>'Demopay',
			),
			'alidirect' => array(
				'dir' => 'alipay_direct',
				'method' =>'AliDirect',
			),
			'aliwscow' => array(
				'dir' => 'alipay_wscow',
				'method' =>'AliWscow',
			),
			'aliwapdir' => array(
				'dir' => 'alipay_wapdir',
				'method' =>'AliWapdir',
			),
			'tenpay' => array(
				'dir' => 'tenpay_sdk',
				'method' =>'Tenpay',
			),
			'paypalec' => array(
				'dir' => 'paypal_ec',
				'method' =>'Paypal',
			),
			'weixinpay' => array(
				'dir' => 'weixin_pay',
				'method' =>'Weixin',
			),
		);
		return $cfg;	
	}
	
	static function getParas($order){ 
		$cfg = self::getCfgs();
		if(!isset($cfg[$order['ordpay']]['method'])) return array();
		$method = 'fmarr'.$cfg[$order['ordpay']]['method'];
		if(!method_exists('exvOpay',$method)) return array();
		$arr = self::$method($order,$cfg[$order['ordpay']]);
		return $arr;
	}

	static function fmarrDemopay($order,$cfg){ 
		$arr = array();
		$arr['out_trade_no'] = $order['cid'];
		$arr['subject'] = "Web(".cfg('tpl.tpl_dir').")".lang('core.opay_order');
		$arr['total_fee'] = $order['feetotle'];
		$arr['ordbody'] = '-';
		$arr['showurl'] = '-';
		$arr['a']['apidir'] = $cfg['dir'];
		return $arr;
	}
	
	static function fmarrAliDirect($order,$cfg){ 
		$arr = array();
		$arr['ordid'] = $order['cid'];
		$arr['title'] = "Web(".cfg('tpl.tpl_dir').")".lang('core.opay_order');
		$arr['feetotle'] = $order['feetotle'];
		$arr['ordbody'] = '-';
		$arr['showurl'] = '-';
		$arr['a']['apidir'] = $cfg['dir'];
		return $arr;
	}
	static function fmarrAliWscow($order,$cfg){ 
		return self::fmarrAliDirect($order,$cfg);
	}
	static function fmarrAliWapdir($order,$cfg){ 
		$data = self::fmarrAliDirect($order,$cfg);
		$dcfg = array('receive_name'=>'mname','receive_address'=>'maddr','receive_zip'=>'123456','receive_phone'=>'mtel','receive_mobile'=>'mtel');
		foreach($dcfg as $key=>$val){
			$data[$k] = empty($order[$val]) ? $val : $order[$val];
		}
		return $data;
		/*
		//收货人姓名如：张三
		$receive_name = $_POST['receive_name'];
		//收货人地址如：XX省XXX市XXX区XXX路XXX小区XXX栋XXX单元XXX号
		$receive_address = $_POST['receive_address'];
		//收货人邮编如：123456
		$receive_zip = $_POST['receive_zip'];
		//收货人电话号码如：0571-88158090
		$receive_phone = $_POST['receive_phone'];
		//收货人手机号码如：13312341234
		$receive_mobile = $_POST['receive_mobile'];
		*/
	}
	static function fmarrTenpay($order,$cfg){ 
		$arr = array();
		$arr['out_trade_no'] = $order['cid'];
		$arr['subject'] = "Web(".cfg('tpl.tpl_dir').")".lang('core.opay_order');
		$arr['total_fee'] = $order['feetotle'];
		$arr['ordbody'] = '-';
		$arr['showurl'] = '-';
		$arr['a']['apidir'] = $cfg['dir'];
		return $arr;
	}
	
	static function notifyDemopay($flag,$expar=''){ 
		$data = array();
		$data['ordid'] = basReq::val('out_trade_no');
		$data['apino'] = basReq::val('trade_no');
		$data['ufrom'] = '-';
		$data['uto'] = '-';
		$data['amount'] = basReq::val('total_fee','0');
		$data['api'] = 'demopay';
		$data['stat'] = $flag;
		$data['auser'] = basReq::val('buyer_email');
		self::saveLoger($data,$expar);
	}
	
	static function notifyAliDirect($flag,$expar='',$api='alidirect'){ 
		$data = array();
		$data['ordid'] = basReq::val('out_trade_no');
		$data['apino'] = basReq::val('trade_no');
		$data['ufrom'] = '-';
		$data['uto'] = '-';
		$data['amount'] = basReq::val('total_fee','0');
		$data['api'] = $api;
		$data['stat'] = $flag;
		$data['auser'] = basReq::val('buyer_email');
		self::saveLoger($data,$expar);
	}
	static function notifyAliWscow($flag,$expar=''){ 
		self::notifyAliDirect($flag,$expar,'aliwscow');
	}
	static function notifyAliWapdir($flag,$expar=''){ 
		self::notifyAliDirect($flag,$expar,'aliwapdir');
	}
	static function notifyTenpay($flag,$expar=''){ 
		$data = array();
		$data['ordid'] = basReq::val('out_trade_no');
		$data['apino'] = basReq::val('trade_no');
		$data['ufrom'] = '-';
		$data['uto'] = '-';
		$data['amount'] = basReq::val('total_fee','0');
		$data['api'] = 'tenpay';
		$data['stat'] = $flag;
		$data['auser'] = basReq::val('buyer_email');
		self::saveLoger($data,$expar);
	}
	
	static function saveLoger($data,$expar=''){ 
		$plog = cfg('debug.pay_log');
		if(empty($plog) && $data['stat']=='fail') return; //失败记录只在调试模式下记录
		$db = glbDBObj::dbObj();
		//check 1.ordid在corder表? 2.from接口
		$data['kid'] = basKeyid::kidTemp('(def)');
		$expar && $data['expar'] = $expar;
		$db->table('plus_paylog')->data(basReq::in($data))->insert();
		basDebug::bugLogs('opay',$data,'detmp','db');
	}

/*
 
*/

}



/*******************************************************************************
 File : \code\core\vops\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\core\vops\tagBase.php 
*******************************************************************************/
<?php
/*
*/
// 标签解析 基类
class tagBase{
	
	public $modid = '';
	public $paras = array();
	public $mcfg = array();

	public $sqlArr = array();
	public $sqlAll = '';
	public $whrArr = array();
	public $whrStr = '';
	public $jonArr = array();
	
	public $re = array();
	public $exFld1 = array('aip','eip','atime','etime','show',);
	public $exFld2 = array(); //did,cid,uid,aid,kid ... 
	public $db = NULL;
	
	function __construct($paras=array()) {
		$this->paras = $paras;
		$this->db = glbDBObj::dbObj(); 
		$this->setModid();
		$this->setFrom();
		$this->pJoin();
		$this->mcfg = glbConfig::read($this->modid);
	}
	
	// 所有公用: [idfix,top] -=> array('idfix','top')
	function p1Cfg($key='modid'){
		foreach($this->paras as $k=>$p1){
			if($p1[0]==$key){ 
				return $p1;
			}
		}
		return array();
	}
	// 所有公用: 
	function setModid(){
		$para = $this->p1Cfg('modid');
		if(empty($para)){
			$modid = $this->mod; //ucfg['mod']; //vopUrl::imkv(vopUrl::iget());
		}else{
			$modid = $para[1];
			if(isset($para[2])){
				$ext = $para[2];
				if(strstr($ext,'get')){
					$mod2 = basReq::val($modid,'','Key');
					global $_cbase;
					if($mod2 && isset($_cbase[$mod2])) $modid = $mod2; 
				}
			}
		}
		$this->modid = $modid;
	}
	// List, Page, One: 
	function setFrom(){ 
		$db = glbDBObj::dbObj(); 
		$_groups = glbConfig::read('groups');
		$mod = $this->modid;
		if($_groups[$mod]['pid']=='docs'){
			$tabid = 'docs_'.$mod;
			$ordef = 'did';
			$exFld2[] = 'did';
		}elseif($_groups[$mod]['pid']=='users'){
			$tabid = 'users_'.$mod;
			$ordef = 'atime';
			$exFld2[] = 'uid';
		}elseif($_groups[$mod]['pid']=='advs'){
			$tabid = 'advs_'.$mod;
			$ordef = 'atime';
			$exFld2[] = 'aid';
		}elseif($_groups[$mod]['pid']=='coms'){	
			$tabid = 'coms_'.$mod;
			$ordef = 'cid';
			$exFld2[] = 'cid';
		}elseif($_groups[$mod]['pid']=='types'){	
			$tabid = empty($_groups[$mod]['etab']) ? 'types_common' : 'types_'.$mod;
			$ordef = 'kid'; //不使用
			$exFld2[] = 'kid';
		}
		$this->sqlArr['tabid'] = $tabid;
		$this->sqlArr['prefix'] = $this->db->pre; 
		$this->sqlArr['suffix'] = $this->db->ext; 
		$this->sqlArr['ordef'] = $ordef;
		$this->exFld2 = $exFld2;
	}
	
	// Join (目前仅支持一个join), 最后加参数 id1+id2+id3
	// [join,INNER JOIN docs_news p ON p.did=m.pid]  -=>  原型
	// [join,mod,field,val]  -=>  INNER JOIN users_person u ON u.uname=d.auser  (有pid关系)
	// [join,detail]	  -=>  INNER JOIN dext_news	d ON d.did=m.did 
	function pJoin(){ 
		//$_groups = glbConfig::read('groups');
		//$mod = $this->modid;
		//$pid = $_groups[$mod]['pid'];
		$cfg = $this->p1Cfg('join');
		$this->jonArr = $cfg; //print_r($cfg);
		/*
		$join = ''; 
		if(empty($cfg[1])){ 
			$join = '';
			$cid = 0;
		}elseif($cfg[1]=='detail' && in_array($pid,array('docs','users'))){
			$char = substr($pid,0,1);
			$join = 'INNER JOIN '.glbDBExt::getTable($mod,1)." d ON d.{$char}id=m.{$char}id";
			$cid = 2; 
		}elseif(isset($_groups[$cfg[1]])){ //pid
			$join = 'INNER JOIN '.glbDBExt::getTable($cfg[1]).' p ON p.'.$cfg[2].'=m.pid';
			$cid = 3;
		}elseif(!empty($cfg[1])){
			$join = $cfg[1];
			$cid = 2;
		}
		$cols = empty($cfg[$cid]) ? '*' : str_replace('+',',',$cfg[$cid]);
		//分析
		if($join){ 
			$a = explode(' ',$join);
			$a['fields'] = $cols;
			$a['full'] = str_replace($a[2],$this->sqlArr['prefix'].$a[2].$this->sqlArr['suffix'],$join);
			$this->jonArr = $a; 
		}*/

	}
	
	// [order,0,kid1+f02+f03]
	// order, odesc
	function pOrder(){ 
		$cfg = $this->p1Cfg('order');
		if(empty($cfg)){
			$order = '';
		}elseif(!empty($cfg[1])){
			$order = $cfg[1]; //认证?
		}elseif(empty($cfg[1]) && !empty($cfg[2])){
			$order = basReq::val('order','','Key',24); 
			$a = explode('+',$cfg[2]);
			if($order && !in_array($order,$a)){ //认证?
				$order = '';	
			}
		}else{
			$order = '';	
		}
		$order || $order = $this->sqlArr['ordef'];
		$odesc = basReq::val('odesc','1','N');
		$this->sqlArr['order'] = $order;
		$this->sqlArr['odesc'] = $odesc;
		$this->sqlArr['ofull'] = 'm.'.$order.($odesc ? ' DESC' : '');
	}
	
	// 
	function pStype(){ 
		$cfg = $this->p1Cfg('stype'); 
		if(empty($cfg)) return;
		//优先取标签属性,再去url的stype
		$stype = empty($cfg[1]) ? vopUrl::umkv('key','stype') : $cfg[1]; 
		if(empty($stype)) return;
		$_groups = glbConfig::read('groups'); 
		$pid = $_groups[$this->modid]['pid'];
		if($stype && in_array($pid,array('docs','advs'))){
			$sql = basSql::whrTree($this->mcfg['i'],'m.catid',$stype); 
			$this->whrArr[] = $sql ? substr($sql,5) : '';
		}elseif($stype && in_array($pid,array('users'))){
			$this->whrArr[] = "m.grade='$stype'";
		}else{ //交互等,无stype
			
		} 
		/*
		$ccfg = glbConfig::read($this->modid,'_c');
		if($fix && !empty($ccfg)){ 
			if(!empty($ccfg[$fix])){
				$exFlds = array_keys($ccfg[$fix]);
				if(!empty($exFlds)){
					$this->exFld2 = array_merge($this->exFld2,$exFlds); 
				}
			}
		}*/
	}
	
	// `-=>', [where,did=`2004-33-2ycx`]
	function pWhere(){ 
		$whr = ''; 
		foreach($this->whrArr as $w){
			$whr .= ' AND '.$w;
		}
		$cfg = $this->p1Cfg('where'); 
		if(!empty($cfg[1])){ 
			$whr .= (substr($cfg[1],0,5)!=' AND ' ? ' AND ':'').$cfg[1];  
		}
		if(substr($whr,0,5)==' AND ') $whr = substr($whr,5);
		$this->whrStr = $whr; 
	}
	
	function getJoin($re){ 
		if(empty($re)) return $re;
		$minfo = glbConfig::read($this->modid); 
		if(!empty($this->jonArr[1]) && $this->jonArr[1]=='detail'){
			if($minfo['pid']=='types'){
				$this->getJoinTypes($re);
			}
			if($minfo['pid']=='docs'){
				dopFunc::joinDext($re,$this->modid);
			}
		}
		return $re;
	}
	
	// glbDBExt::getTable($mod,$ext=0)
	function getJoinTypes(&$re){ 
		$ids = '';
		foreach($re as $k=>$v){
			$ids .= (empty($ids) ? '' : ',')."'".$v['kid']."'";
		} //echo "$ids"; print_r($re);
		if(empty($ids)) return;
		$re1 = $this->db->table(glbDBExt::getTable($this->modid,1))->where("kid IN($ids)")->select(); 
		$minfo = glbConfig::read($this->modid); 
		$re2 = array();
		foreach($re1 as $k1=>$v1){ 
			foreach($v1 as $k2=>$v2){
				if(isset($minfo['f'][$k2])){
					$re2[$v1['kid']][$k2] = $v2;
				}
			}
		}
		foreach($re as $k=>$v){
			if(isset($re2[$v['kid']])){
				$re[$k] += $re2[$v['kid']];
			}
		} //print_r($re);
	}
	
	function getData(){ 
		$type = $this->modid;
		$re[0] = array('kid'=>'docs','did'=>'yyyy-12-7890','title'=>'4-title'.$type);
		$re[1] = array('kid'=>'advs','aid'=>'yyyy-34-1234','title'=>'5-title'.$type);
		$re[2] = array('kid'=>'coms','cid'=>'yyyy-56-5678','title'=>'6-title'.$type);
		return $re;
	}

	function debug($key=''){ 
		if($key){
			echo "<pre>debug\n";
			print_r($this->$key);	
			echo "</pre>";
		}else{
			print_r($this->sqlArr);
			print_r($this->sqlAll);
			print_r($this->whrArr);
			print_r($this->whrStr);	
			if(isset($this->pgbar)) print_r($this->pgbar);	
		}
	}
	
}



/*******************************************************************************
 File : \code\core\vops\tagCache.php 
*******************************************************************************/
<?php
/*

*/
// 标签缓存类
class tagCache{
	
	static function showAdv($mkey){ 
		$mk = explode(':',$mkey);
		$file = tagCache::caPath($mk[0],$mk[1],1);
		$data = file_exists($file) ? comFiles::get($file) : "$mkey";
		$re = basJscss::jsShow($data, 0);
		return $re;
	}
	
	static function jsTag($k,$mkv,$para){ 
		preg_match("/\[cache\,([a-z0-9]+)\]/", $para, $m);  
		if(!empty($m[0]) && !empty($m[1])){ // && intval($m[1])>0
			$pkey = str_replace(array("[List]","[Page]","[One]"),'',$para);
			$path = self::ctPath($pkey,basReq::val('tpldir')); 
			$fpath = self::chkUpd($path,$m[1]); 
			$data = $path ? comFiles::get($fpath) : ''; 
			$para = str_replace($m[0],'',$para); 	
		}else{
			$path = $data = ''; //无缓存,无数据		
		}
		if(empty($data)){
			$data = self::jsData($k,$para); 
			if($path) self::setCache($path,$data);	 
		}
		$re = basJscss::jsShow($data, 0);
		return $re;
	}
	
	static function jsData($k,$data){ 
		ob_start();
		$vop = new vopShow(0);
		$vop->rjs($data);
		$re = ob_get_contents();
		ob_end_clean(); 
		return $re;
	}
	
	static function comTag($type,$mkv,&$paras){ 
		$cac = 0; $cex = $path = $fmkv = ''; 
		foreach($paras as $k=>$v){ 
			if($v[0]=='cache' && !empty($v[1])){
				$cac = $v[1];
				unset($paras[$k]);
			}
			if($v[0]=='stype' && !isset($v[1])){
				$fmkv = "-$mkv";
			}
			$cex .= '['.implode(',',$v).']';	
		} 
		if($cac){ 
			global $_cbase;
			$nowtpl = $_cbase['run']['tplnow']; 
			$tpl_dir = $_cbase['tpl']['tpl_dir']; 
			$path = self::ctPath("[{$nowtpl}][$type]{$cex}",$tpl_dir);
			$cfile = self::chkUpd($path,$cac); 
			$data = $cfile ? unserialize(comFiles::get($cfile)) : ''; 
		}else{
			$data = ''; //无数据
		} 
		return array($path,$data);
	}
	
	static function ctPath($para,$tpldir){ 
		$fext = str_replace(array('/','+','*','|','?',':'),array('~','-','.','!','$',';'),$para); 
		$fext = str_replace(array('[modid,','[limit,','[cache,','[show,'),array('[m','[n','[c','[s'),$fext); 
		$fext = basStr::filTitle($fext); //del:&,#
		if(strlen($fext)>150) $fext = substr($fext,0,20).'~'.md5($fext);
		$path = "/tpls/_tagc/$tpldir$fext.cac_htm"; //".(substr($fmd5,0,1))."/
		return $path;
	}
	static function caPath($mod,$type,$full=0){ 
		$path = "tpls/_advs/$mod/$type.cfg_htm"; 
		$full && $path = DIR_DTMP."/$path";
		return $path;
	}
	
	static function setCache($file,$data,$isa=0){
		if($isa){
			$data['page_bar'] = cfg('page.bar');
			$data = serialize($data); //var_export
		}
		comFiles::chkDirs($file,'tmp');
		comFiles::put(DIR_DTMP.$file,$data);
	}
	
	// $ctime : //30s,60m,3h,6h,12h,24h,7d; 默认单位m
	static function chkUpd($file,$ctime=30,$bdir='tmp'){ 
		if(is_numeric($ctime) || strpos($ctime,'m')){
			$ctime = intval($ctime)*60; 
		}elseif(strpos($ctime,'h')){
			$ctime = intval($ctime)*3600;
		}elseif(strpos($ctime,'d')){
			$ctime = intval($ctime)*86400;
		}else{ 
			$ctime = intval($ctime);
		}
		$ctime<=0 && $ctime = 1800; 
		$stamp = time();
		$cfg = array(
			'tmp'=>DIR_DTMP,
			'res'=>DIR_URES,
			'htm'=>DIR_HTML,
		);
		$bdir = empty($bdir) ? '' : (isset($cfg[$bdir]) ? $cfg[$bdir] : $bdir); 
		if(file_exists($bdir.$file)){ 
			$last = filemtime($bdir.$file);
			if($last + $ctime > $stamp){ 
				return $bdir.$file;
			}
		}
		return '';
	}

}



/*******************************************************************************
 File : \code\core\vops\tagList.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/*

*/
// 标签解析 (数据列表)类
class tagList extends tagBase{
	
	//public $whrArr = array();
	
	function __construct($paras=array()) {
		parent::__construct($paras); 
		$this->pOrder();
		$this->pLimit();
		$this->pStype();
		$this->pKeywd();
		$this->pField();
		$this->pPid();
		$this->inIds();
		$this->pWhere();
	}
	
	function pPid(){ 
		$cfg = $this->p1Cfg('pid'); 
		if(empty($cfg[1])) return;
		$_groups = glbConfig::read('groups'); 
		$pmod = @$_groups[$this->modid]['pmod'];
		if(!$pmod) return;
		$cfg[1] = basStr::filKey($cfg[1],'-.@');
		$this->whrArr[] = "m.pid='{$cfg[1]}'";
	}
	function inIds(){ 
		$cfg = $this->p1Cfg('inids'); 
		if(empty($cfg[1])) return;
		$a = array_filter(explode(',',$cfg[1]));
		$s = implode("','",$a);
		if($s){
			$this->whrArr[] = "m.{$this->sqlArr['ordef']} IN('$s')";
		} //print_r($this->whrArr);
	}
	
	function pLimit(){
		$cfg = $this->p1Cfg('limit'); 
		$limit = empty($cfg[1]) ? 0 : intval($cfg[1]);
		if($limit<1) $limit = intval(cfg('show.fpsize'));
		if($limit<1) $limit = 10;
		$this->sqlArr['limit'] = $limit;
	}

	function pKeywd(){ 
		$cfg = $this->p1Cfg('keywd');
		$sql = ''; 
		if(!empty($cfg)){
			$fix = empty($cfg[1]) ? basReq::val('keywd') : $cfg[1]; 
			$fields = @$cfg[2];
			$_groups = glbConfig::read('groups'); 
			if($fix && $fields){
				$flist = $this->mcfg['f'];
				$fa = explode('+',$fields);
				$sql = '';
				foreach($fa as $f){ 
					if(isset($flist[$f]) && empty($flist[$f]['etab'])){ 
						$sql .= " OR m.$f ".basSql::fmtKeyWD($fix)."";	
					}
				}
				$sql && $sql = "(".substr($sql,4).")";
			}elseif($fix){
				$pid = $_groups[$this->modid]['pid'];	
				if(in_array($pid,array('docs'))){
					$def = 'title';
				}elseif(in_array($pid,array('users'))){
					$def = 'mname';
				}else{ //交互等,无keywd
					$def = '';
				}
				$def && $sql = "m.$def ".basSql::fmtKeyWD($fix)."";
			}
			$sql && $this->whrArr[] = $sql;

		}
	}
	
	//  //val=id1+id2+  -=>  IN ('libk', 'zyfon', 'daodao');
	function pField(){ 
		$flist = $this->mcfg['f'];
		$exFields = array_merge($this->exFld1,$this->exFld2); 
		foreach($this->paras as $para){ 
			$sql = '';
			if(isset($flist[$para[0]]) || in_array($para[0],$exFields)){
				$f = $para[0]; 
				$v = empty($para[1]) ? basReq::val($f) : $para[1]; 
				$op = @$para[2]; 
				if($v){
					if(in_array($op,array('>','>=','<','<='))){ 
						$sql = "(m.$f $op '$v')";
					}elseif($op=='in'){
						$v = str_replace("'","",$v);
						$v = str_replace('+',"','","'$v'");
						$sql = "m.$f IN($v)";	
					//}elseif($op=='fset'){ // fset FIND_IN_SET(goods_id, '{$ids}')"
					}elseif($op=='like'){
						$sql = "m.$f ".basSql::fmtKeyWD($v)."";	
					}else{
						$sql = "(m.$f='$v')";	
					}
				}
			}
			$sql && $this->whrArr[] = $sql;
			
		}
	}
	
	function getData(){ 
		$sfrom = "m.* FROM `".$this->sqlArr['prefix'].$this->sqlArr['tabid'].$this->sqlArr['suffix']."` m ";
		$where = empty($this->whrStr) ? '' : "WHERE ".$this->whrStr;
		$this->sqlAll = "SELECT $sfrom $where ORDER BY ".$this->sqlArr['ofull']." LIMIT ".$this->sqlArr['limit']; 
		$re = $this->re = $this->db->query($this->sqlAll); //echo $this->sqlAll;
		return $this->getJoin($re);
			
	}

}



/*******************************************************************************
 File : \code\core\vops\tagOne.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/*

*/
// 标签解析 (单条数据)类
class tagOne extends tagBase{
	
	//public $whrArr = array();
	
	function __construct($paras=array()) {
		parent::__construct($paras); 
		$this->pOrder();
		$this->pStype();
		$this->pWhere();
	}
	
	function getData(){ 
		$sfrom = "m.* FROM `".$this->sqlArr['prefix'].$this->sqlArr['tabid'].$this->sqlArr['suffix']."` m ";
		$where = empty($this->whrStr) ? '' : "WHERE ".$this->whrStr;
		$this->sqlAll = "SELECT $sfrom $where ORDER BY ".$this->sqlArr['ofull']." LIMIT 1"; 
		$this->re = $this->db->query($this->sqlAll); //echo $this->sqlAll;
		if(!empty($res[0])){
			$re = $res[0];
		}else{
			$re = array();	
		}
		$this->re = $re;
		return $this->getJoin($re);
			
	}

}



/*******************************************************************************
 File : \code\core\vops\tagPage.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/*
	funcs: pPgbar,getData
	attrs: 
*/
// 标签解析 (数据列表)类
class tagPage extends tagList{
	
	public $pg = null;
	public $pgbar = '';
	
	function __construct($paras=array()) {
		parent::__construct($paras); 
		$this->pPgbar();
	}
	
	function pPgbar(){ 
		global $_cbase; 
		$db = glbDBObj::dbObj();
		$sfrom = "m.* FROM `".$this->sqlArr['prefix'].$this->sqlArr['tabid'].$this->sqlArr['suffix']."` m ";
		$where = $this->whrStr; 
		$pg = new comPager($sfrom,$where,$this->sqlArr['limit'],"m.".$this->sqlArr['order']); 
		$pg->set('odesc',$this->sqlArr['odesc']); 
		$pg->set('opkey',$this->sqlArr['ordef']==$this->sqlArr['order'] ? 1 : 0); 
		$this->re = $pg->exe(); 
		$this->sqlAll = $pg->sql; 
		$idfirst = ''; $idend = '';
		if($this->re){
			$i = current($this->re); 
			$idfirst = current($i); 
			$i = end($this->re); 
			$idend = current($i); 
		}
		$scname = $_SERVER["SCRIPT_NAME"]; //REQUEST_URI
		$mkv = vopUrl::umkv('mkv');
		/*$mkv = basReq::val('mkv','','Key',24);
		if(empty($mkv) && !empty($_cbase['mkv']['mkv'])){
			$mkv = $_cbase['mkv']['mkv']; 
		}*/
		if(strpos($scname,'plus/ajax/cron.php') || strpos($scname,'plus/ajax/jshow.php')){
			$burl = vopUrl::fout(0)."?mkv=$mkv";	
		}else{
			$burl = basReq::getUri(-1,'','page|prec|ptype|pkey');
			$burl = strstr($burl,'mkv=') ? $burl : str_replace('.php?','.php?mkv=',$burl); 	
		}
		$_cbase['page']['bar'] = "<div class='pg_bar'>".$pg->show($idfirst,$idend,'',$burl)."</div>";
		$_cbase['page']['prec'] = $pg->prec; 
	}
	
	function getData(){ 
		//$this->debug('pgbar');
		$re = $this->re;
		return $this->getJoin($re);
	}

}



/*******************************************************************************
 File : \code\core\vops\tagType.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

/*
{tag:flag4=[listType,re1][modid,china][idfix,top]}
idfix: top,all, sun:idx, sall:idx, id+id+id
	   [idfix,sun:p1012][idfix,sall:p1012]
keywd: [keywd,er]  
*/
// 标签解析 (类别列表)类
class tagType extends tagBase{
	
	//protected $re = array();
	
	function __construct($paras=array()) {
		parent::__construct($paras); 
		$this->re = $this->mcfg['i'];
		$this->pIdfix();
		$this->pKeywd();
	}
	
	function pIdfix(){ 
		$cfg = $this->p1Cfg('idfix');
		if(!empty($cfg)){
			$fix = $cfg[1];
			if($fix=='top'){
				$this->re = comTypes::getSubs($this->re,'0','1');
			}elseif(strstr($fix,'+')){
				$fix2 = explode('+',$fix);
				foreach($this->re as $k=>$v){
					if(!in_array($k,$fix2)){
						unset($this->re[$k]);
					}
				}
			}elseif(strstr($fix,'sun:')){
				$fix2 = str_replace('sun:','',$fix);
				$deep = @$this->re[$fix2]['deep']+1;
				$this->re = comTypes::getSubs($this->re,$fix2,$deep);
			}elseif(strstr($fix,'sall:')){
				$fix2 = str_replace('sall:','',$fix);
				$this->re = comTypes::getSubs($this->re,$fix2);	
			}	
		}
	}
	
	function pKeywd(){ 
		$cfg = $this->p1Cfg('keywd');
		if(!empty($cfg)){
			$fix = $cfg[1]; 
			foreach($this->re as $k=>$v){
				if(strstr($k,$fix) || strstr($v['title'],$fix)){
					//;	
				}else{
					unset($this->re[$k]);	
				}
			}
		}
	}
	
	function getData(){ 
		$re = array();
		foreach($this->re as $k=>$v){
			$v['kid'] = $k;
			$re[] = $v;
		}
		return $this->getJoin($re);
	}

}



/*******************************************************************************
 File : \code\core\vops\vopCell.php 
*******************************************************************************/
<?php
/*

*/
// Cell 类
class vopCell{	

	//public static $hcfg = array();
	
	// Array ( [exp_s01] => Array ( [title] => 手机类型 [val] => 3G [org] => net3g ) ...
	static function exFields($mod,$catid,$vars=''){ //
		$re = array();
		$ccfg = glbConfig::read($mod,'_c'); 
		if(empty($ccfg[$catid])) return array();
		$mfields = $ccfg[$catid]; 
		if(empty($vars)) return $mfields;
		foreach($mfields as $k=>$v){ 
			$vre = self::optArray($v,$vars[$k]);
			$vre = empty($vre) ? $vars[$k] : $vre;
			$re[$k] = array(
				'title' => $v['title'],
				'val' => $vre,
				'org' => $vars[$k],
			);
		} 	
		return $re;
	}
	
	static function optItems($vals,$tpl=''){
		$re = ''; $tpl || $tpl="<span class='itm-(k)'>(v)</span>";
		foreach($vals as $k=>$v){ 
			$re .= str_replace(array('(k)','(v)'),array($k,$v),$tpl);
		}
		return $re;
	}
	
	// fc : modid=brand,china / 字段配置 / mod.field 
	// hn,gd -=> array('hn'=>'湖南','gd'=>'广东');
	static function optArray($fc,$val='',$color=1){
		$sc = '333,'.cfg('ucfg.ctab').',999'; $ac = explode(',',$sc); 
		if(empty($val)) return array(); 
		$arr = basElm::text2arr($fc); //print_r($arr);
		$va = explode(',',str_replace('+',',',$val)); 
		foreach($va as $k1){
			if(empty($k1)) continue;
			$vre[$k1] = empty($arr[$k1]) ? $k1 : $arr[$k1];
		} //echo "\n\naab:"; print_r($vre);
		if($color && count($arr)<count($ac)){
			$no = 0; $na = array();
			foreach($arr as $k2=>$v2){
				$na[$k2] = $ac[$no];
				$no++;
			}
			foreach($vre as $k3=>$v3){
				$vre[$k3] = "<span style='color:#".@$na[$k3]."'>".$v3."</span>";
			}
		}
		return $vre;
	}
	
	// <a {php vOpen('nrem',$did); }>发布评论</a>
	static function vOpen($mod,$pid='',$title='',$w=0,$h=0){
		if(!$title){
			$mcfg = glbConfig::read($mod);
			$title = lang('core.pub_title').'-'.$mcfg['title'];
		}
		$w || $w = 500; $h || $h = 400;
		$scfile = file_exists(DIR_ROOT."/plus/coms/$mod.php") ? $mod : 'add_coms';
		$url = PATH_ROOT."/plus/coms/$scfile.php?mod=$mod&pid=$pid";
		$str = "onclick=\"return winOpen('$url','$title',$w,$h);\"";
		echo $str;
	}
	
	// $len: 24
	// $paras['color'] :
	static function cTitle($val='',$len=24,$paras=array()){
		$len = is_numeric($len) ? $len : 24;
		$len = empty($len) ? 24 : $len;
		$val = basStr::filTitle($val);
		$val = basStr::cutWidth($val, $len);
		if(!empty($paras['color'])){
			$color = "#{$paras['color']}";
			$val = "<span style='color:$color'>$val</span>";
		}
		return $val;
	}
	
	//还原cPic路径
	static function cPic($val,$def=''){ 
		if(empty($val) && $def){
			$val = strstr($def,'/') ? $def : "{stcroot}/icons/basic/$def";
		}
		$re = vopUrl::root($val);
		return $re;
	}
	
	//媒体
	static function cMedia($val=''){
		if(strpos($val,'/media}')){
			$val = vopMedia::repShow($val);
		}
		return $val;
	}
	//Page
	static function cPage($val=''){
		return $val;
	}
	//Html (??Link,Cut)
	static function cHtml($val,$paras=''){
		$paras || $paras = ',root-media-page,';
		if(strpos($paras,'root')) $val = vopUrl::root($val);
		if(strpos($paras,'media')) $val = self::cMedia($val);
		if(strpos($paras,'page')) $val = self::cPage($val);
		return $val;
	}
	
	//Text (val,len,nobr,??Link,Cut)
	static function cText($val,$len=0,$nobr=0){
		if(is_array($val)){
			foreach($val as $v){
				if(!empty($v)){
					$val = $v;
					break;
				}
			}
		} 
		$len = empty($len) ? 0 : intval($len);
		if($nobr){
			$val = basStr::filHText($val,$len);
		}else{
			$val = strip_tags($val); 
		}
		$val = nl2br($val);
		return $val;
	}
	
	// full: min,full,dm,,
	// null: -
	static function cTime($val='',$fmt='full',$null=array()){
		$fmt = empty($fmt) ? 'Y-m-d' : $fmt;
		$fmt=='min' && $fmt = 'Y-m-d H:i';
		$fmt=='full' && $fmt = 'Y-m-d H:i:s';
		$fmt=='dm' && $fmt = 'm-d H:i';
		$null = empty($null) ? '-' : $null;
		$re = empty($val) ? $null : date($fmt,$val); 
		return $re;
	}
	
	// split: [0]: 默认自动彩色显示 
	//        [,]/[1]: 单个>0数字,多个用,好分开,或自定义个分割符变量(如$split)也可
	//        [tpl]: 默认模版显示,可自行写css.class着色
	//        [<span class='itm-(k)'>(v)</span>]: 自定模版显示,可自行写css.class着色
	static function cOpt($val='',$mod='',$split=0,$null=''){ 
		$color = empty($split);
		$arr = self::optArray($mod,$val,$color); //echo "\n\naaa:"; print_r($arr);
		$rea = '';
		if(!empty($arr)){
			if(empty($split)){
				$rea = implode("\n",$arr);
			}elseif(strlen($split)<3){ //  , ||  
				$split = is_numeric($split) ? ',' : $split;
				$rea = implode($split,$arr);
			}else{ //  tpl  
				$split = strpos($split,'</') ? $split : '';
				$rea = self::optItems($arr,$split); 
			}
		}
		$re = empty($rea) ? $null : $rea;
		return $re;
	}
	
	// show
	static function cShow($val,$vop=NULL){
		global $_cbase;
		$re = empty($vop->$val) ? '' : $vop->$val; //NULL; $this->vars
		$re || $re = basArray::get($_cbase, $val);
		$re || $re = "{\$$val}";
		return $re;
	}
	
	// js动态显示字段
	static function jsFields($a){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$stamp = time();
		//[demo:2013-cm-a201:click] => 535,add1,uclick1
		//[demo:2013-cm-a201:etime] => 1387418573
		//[demo:2013-cm-abcd:etime] => 1387418573
		$b = array();
		foreach($a as $k=>$v){
			$t = explode(':',$k);
			if(!isset($_groups[$t[0]]) || empty($t[2])) continue;
			$j = $t[0].':'.$t[1];	
			$b[$j][$t[2]] = $v;
		}
		//[demo:2013-cm-a201] => Array
				//[click] => 535,add1,uclick1
				//[etime] => 1387418573
		//[demo:2013-cm-abcd] => Array
				//[etime] => 1387418573
		$re = ''; $ext = '';
		foreach($b as $k2=>$v2){
			$t = explode(':',$k2);
			$tab = glbDBExt::getTable($t[0]);
			$kid = glbDBExt::getKeyid($t[0]);
			$key = basStr::filKey($t[1],'-_.');
			$cols = ''; $cola = array(); $gap = ''; 
			foreach($v2 as $k3=>$v3){
				$k3 = basStr::filKey($k3);
				$cols .= "$gap$k3";
				$cola[] = $k3;
				$gap = ',';
			} 
			$r = $db->field($cols)->table($tab)->where("$kid='$key'")->find(); //print_r($r);
			//[click] => 232
			//[etime] => 1387358621
			foreach($cola as $field){
				$ps = $a[$t[0].':'.$key.':'.$field];
				$pa = explode(',',$ps);
				if(empty($r[$field]) && is_numeric($pa[0])){
					$r[$field] = $pa[0];	
				}
				//$r[$field] || $r[$field] = 0;
				if(empty($r[$field])) $r[$field] = 0; 
				if(strstr($ps,'add1')){ 
					$ck = comCookie::mget('clicks',"$t[0]_$key"); // cookie;
					if(empty($ck) || ($stamp-$ck)>60){
						comCookie::mset('clicks',0,"$t[0]_$key",$stamp);
						$r[$field] = $r[$field] + 1; 
						$db->table($tab)->data(array($field=>$r[$field]))->where("$kid='$key'")->update(); 	
					}
				}
				$re .= "jsElm.jeID('jsid_field_{$t[0]}:{$key}:$field').innerHTML='{$r[$field]}';\n";
				foreach($pa as $k4){
					if(is_numeric($k4)) continue;
					if(in_array($k4,array('add1'))){
						continue;
					}elseif($k4){
						$re .= "try{jsElm.jeID('$k4').innerHTML='{$r[$field]}';}catch(ex){};\n";
					}
				}
			}
		}
		return $re;
	}
	
	// js动态统计数量
	static function jsCounts($a){
		$_groups = glbConfig::read('groups');
		$db = glbDBObj::dbObj();
		$re = ''; $ext = ''; 
		//[drem:2013-cm-a201] => ucount1
		foreach($a as $k1=>$v1){
			$t = explode(':',$k1);
			if(!isset($_groups[$t[0]])) continue; // || empty($t[1])
			$tab = glbDBExt::getTable($t[0]); 
			$key = basStr::filKey($t[1],'-_.'); 
			$r = $db->table($tab)->where(empty($t[1]) ? "1=1" : "pid='$key'")->count(); 
			$r || $r = 0;
			$pa = explode(',',$v1);
			if(empty($r) && is_numeric($pa[0])){
				$r = $pa[0];	
			}
			$re .= "jsElm.jeID('jsid_count_{$t[0]}:{$key}').innerHTML='{$r}';\n";
			foreach($pa as $v3){
				$v3 = basStr::filKey($v3);
				if(is_numeric($v3)) continue;
					if(in_array($v3,array('xxx_1'))){
						continue;
					}elseif($v3){
						$re .= "try{jsElm.jeID('$v3').innerHTML='{$r}';}catch(ex){};\n";
					}
			} 
		}
		return $re;
	}

	//function __destory(){  }
	/*function __construct($cfg=array()){ 
		basDebug::varShow(basDebug::runInfo());
	}*/

}



/*******************************************************************************
 File : \code\core\vops\vopComp.php 
*******************************************************************************/
<?php
// 模板编译 类
class vopComp{
	
	static $tplCfg = array(); //配置
	
	static function main($tplname) {
		$vob = new self(); 
		$vob->build($tplname); 
		unset($vob); 
	}
	
	function __construct($tpl='') {
		self::$tplCfg = cfg('tpl'); 
		if($tpl) return $this->build($tpl);
	}
	
	//模板编译 ---------- 
	function build($tpl){ 
		global $_cbase; 
		$re = self::checkTpls($tpl);
		$_cbase['run']['comp'] = $tpl; //当前编译模板,js标签中使用
		$content = comFiles::get($re[0]);
		$content = $this->bcore($content); //获取经编译后的内容
		$shead = "(!defined('RUN_MODE')) && die('No Init'); \n\$this->tagRun('tplnow','$tpl','s');";
		$shead .= "\nif(file_exists(\$tebp=vopTpls::pinc('tex_base'))){ include_once(\$tebp); }";
		$shead .= "\nif(method_exists('tex_base','init')){ \$user = tex_base::init(\$this); }";
		#if(file_exists($path=vopTpls::pinc(basename($this->ucfg['tplname'])))){
			#include_once($path);
		#}
		$spend = "if(method_exists('tex_base','pend')){ tex_base::pend(); }";
		comFiles::put($re[1], "<?php \n$shead \n?>\n".$content.($spend ? "<?php \n$spend \n?>" : '')); //写入缓存
		return $re[1];
	}

	//模板编译核心
	function bcore($template=''){
		$template = self::impBlock($template); // 解析模板继承
		$template = self::incTpls($template); // 解析{inc},
		$template = self::phpBasic($template); //基本php语法解析
		$template = self::phpFlow($template); //流程控制语句
		$template = self::incCodes($template); // 解析{code}
		$template = vopCTag::tagMain($template); //系统标签解析
		return $template;
	}

	// 解析{inc},
	function incTpls($template=''){ 
		preg_match_all("/{inc:\"(.*)\"}/ie", $template, $match); 
		if(count($match[1])>0){ //解析模板包含
			$arr = $match[1]; 
			foreach($arr as $tpl){
				$pfile = vopTpls::pinc($tpl,self::$tplCfg['tpl_ext']); 
				$ptpl = $this->incTpls(comFiles::get($pfile)); 
				if(empty($ptpl)) { $ptpl = "<!-- {inc:`$tpl`} -->"; }
				$template = str_replace("{inc:\"$tpl\"}", $ptpl, $template);
				$template = $this->incTpls($template);
			}
		}
		return $template;
	}

	// 解析{code}
	function incCodes($template=''){
		preg_match_all("/{code:\"(.*)\"}/ie", $template, $match); 
		if(count($match[1])>0){ //解析模板包含 
			$arr = $match[1]; 
			foreach($arr as $tpl){
				$pfile = "vopTpls::pinc('$tpl','.php')"; 
				$template = str_replace("{code:\"$tpl\"}", "<?php include($pfile); ?>", $template);
			}
		}
		return $template;
	}

	// 模板继承extend,block,layout,parent,inherit
	// {imp:"c_layout/news"] // {block:title]Welcome!{/block:title] // {block:title] {:parent} {:clear} News - Project Name{/block:title]
	function impBlock($template=''){
		preg_match("/\{imp:\"(.*)\"\}/ie", $template, $match);
		if(empty($match[0]) || empty($match[1])) return $template; //没有imp,原样返回
		//print_r($match);
		$re = self::checkTpls($match[1]);
		$layout = comFiles::get($re[0]);
		$template = substr($template,strlen($match[0]));
		preg_match_all("/\{block:([a-z][a-z0-9_]{1,17})\}/i", $layout, $match);
		//print_r($match); 
		if(empty($match[1])){ return $layout; }//没有block
		foreach($match[1] as $key){ 
			$k1 = "{block:$key}"; $k2 = "{/block:$key}";
			$blk1 = basElm::getPos($template,array($k1,$k2));
			$blkp = basElm::getPos($layout,array($k1,$k2));
			if($blk1=='{:clear}'){ 
				$layout = str_replace("$k1{$blkp}$k2", "", $layout);
			}elseif(!empty($blk1)){ 
				if(strlen($blkp)>6 && strstr($blk1,'{:parent}')) $blk1 = str_replace("{:parent}", $blkp, $blk1);
				$layout = str_replace("$k1{$blkp}$k2", "{$blk1}", $layout);	
			}
			$layout = str_replace(array($k1,$k2), "", $layout);
		}
		return $layout;
	}
	
	// 基本php语法解析, 常量,变量,函数,php代码
	static function phpBasic($template=''){
		//常量解析
		$template = preg_replace ( "/\{([A-Z_][A-Z0-9_]*)\}/s", "<?php echo \\1;?>", $template );	
		/*将变量{$name}替换成<?php  echo $name; ?>,可以是数组 $name, $re1['title'], $this->mod, $this->ucfg['q'] */
		$template = preg_replace("/{(\\$[a-zA-Z_][\w\.\"\'\[\]\$\-\>\:]{0,64})}/i", "<?php echo @$1; ?>", $template);//替换变量
		/*
		$html = preg_replace_callback(
			'(<h([1-6])>(.*?)</h\1>)',
			function ($m) {
				return "<h$m[1]>" . strtoupper($m[2]) . "</h$m[1]>";
			},
			$html
		);*/

		// ----------------------------
		/* php标签
			{= date('Y-m-d'); }	 =>  <?php echo date('Y-m-d'); ?>
			{php echo phpinfo();}	=>	<?php echo phpinfo(); ?>
		 */
		$template = preg_replace ( "/\{=\s+([^}]+)\}/", "<?php echo \\1?>", $template );
		$template = preg_replace ( "/\{php\s+([^}]+)\}/", "<?php \\1?>", $template );
		// ----------------------------
		/* 函数 标签
			{date('Y-m-d H:i:s')}	=>	<?php echo date('Y-m-d H:i:s');?> 
			{$date('Y-m-d H:i:s')}	=>	<?php echo $date('Y-m-d H:i:s');?> 
		$template = preg_replace ( "/\{([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff:]*\(([^{}]*)\))\}/", "<?php echo \\1;?>", $template );
		$template = preg_replace ( "/\{(\\$[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff:]*\(([^{}]*)\))\}/", "<?php echo \\1;?>", $template );
		*/
		// ----------------------------
		return $template;
	}
	
	//模板解析 流程控制语句(Flow control statements)
	static function phpFlow($template){
		/* if 标签
			{if $name==1}		=>	<?php if ($name==1){ ?>
			{elseif $name==2}	=>	<?php } elseif ($name==2){ ?>
			{else}				=>	<?php } else { ?>
			{/if}				=>	<?php } ?>
		*/
		$template = preg_replace ( "/\{if\s+(.+?)\}/", "<?php if(\\1) { ?>", $template );
		$template = preg_replace ( "/\{else\}/", "<?php } else { ?>", $template );
		$template = preg_replace ( "/\{elseif\s+(.+?)\}/", "<?php } elseif (\\1) { ?>", $template );
		$template = preg_replace ( "/\{\/if\}/", "<?php } ?>", $template );
		// ----------------------------
		/* for 标签
			{for $i=0;$i<10;$i++}	=>	<?php for($i=0;$i<10;$i++) { ?>
			{/for}					=>	<?php } ?>
		*/
		$template = preg_replace("/\{for\s+(.+?)\}/","<?php for(\\1) { ?>",$template);
		$template = preg_replace("/\{\/for\}/","<?php } ?>",$template);
		// ----------------------------
		/* loop 标签
			{loop $arr $vo}			=>	<?php $n=1; if (is_array($arr) foreach($arr as $vo){ ?>
			{loop $arr $key $vo}	=>	<?php $n=1; if (is_array($array) foreach($arr as $key => $vo){ ?>
			{/loop}					=>	<?php $n++;}unset($n) ?>
		*/
		$template = preg_replace ( "/\{loop\s+(\S+)\s+(\S+)\}/", "<?php if(is_array(\\1)) foreach(\\1 as \\2) { ?>", $template );
		$template = preg_replace ( "/\{loop\s+(\S+)\s+(\S+)\s+(\S+)\}/", "<?php \$n=1; if(is_array(\\1)) foreach(\\1 as \\2 => \\3) { ?>", $template );
		$template = preg_replace ( "/\{\/loop\}/", "<?php } ?>", $template );
		// ----------------------------
		// {php}{/php}, if, for, loop 标签 --- 可在前后添加 <!--, --> 以便在html中显示调试
		$_aorg = array('{php}','{/php}','<!--<?php','?>-->');
		$_aobj = array('<?php','?>','<?php','?>');
		$template = str_replace ( $_aorg, $_aobj, $template );
		// ----------------------------
		return $template;
	}
	
	// retpl : 直接返回模版文件路径
	static function checkTpls($tpl,$retpl=0){ 
		$tplFile = vopTpls::path('tpl').'/'.$tpl.self::$tplCfg['tpl_ext'];
		if($retpl) return $tplFile;
		$cacheFile = vopTpls::path('tpc').'/'.$tpl.self::$tplCfg['tpc_ext']; //echo "$cacheFile,<br>$tplFile,<br>";
		if(!file_exists($tplFile)) glbError::show("$tplFile NOT Exists!"); 
		comFiles::chkDirs('tpls/'.cfg('tpl.tpl_dir').'/'.$tpl,'tmp'); 
		return array($tplFile, $cacheFile);
	}
	
}


/*******************************************************************************
 File : \code\core\vops\vopCTag.php 
*******************************************************************************/
<?php
// 标签编译 类

class vopCTag{

	static $tag_fix = "tag:[a-z][a-z0-9_]{1,17}";
	static $tag_func = array(
		'surl' => 'vopUrl::fout',
		'lang' => 'basLang::show',
		'spic' => 'vopCell::cPic',
		'title' => 'vopCell::cTitle',
		'html' => 'vopCell::cHtml',
		'text' => 'vopCell::cText',
		'stime' => 'vopCell::cTime',
		'sopt' => 'vopCell::cOpt',
		'show' => 'vopCell::cShow',
	);
	
	// vop:cecho标签
	// {stime($re4['atime']);}				 =>  [?php echo vopCell::cTime($re4['atime']);;?]
	// {stime(1234657890,Y-m-d H:i,a=va\nb=vb)}
	// {surl(0)}  {surl("demo.$re4[did]",.)}  {surl("about-$re1[kid]",-)}  {surl(chn:info-nav)}
	// {sopt(c0769+c0735,china)}
	static function cecho($tpl='',$func='show'){
		preg_match_all("/\{{$func}[\(]([^}]{1,240})[\)];?\}/",$tpl,$_m); 
		if(!empty($_m[1])){
			foreach($_m[1] as $k=>$tiem){  
				$sorg = $_m[0][$k];
				$a = explode(',',$tiem);
				$s = '';
				foreach($a as $v){ 
					$v2 = self::_1Para($v);
					$s .= ",$v2";	
				}
				if($s){
					$s = substr($s,1); 
					// like as : cbase配置:run.stamp
					if($func=='show' || !isset(self::$tag_func[$func])){
						$funu = "echo vopCell::cShow($s,\$this);"; 
					}else{
						$clsm = self::$tag_func[$func];
						$funu = "echo $clsm($s);"; 	
					}
					$tpl = str_replace($sorg,"<?php $funu;?>",$tpl);
				}
			}
		}
		return $tpl;
	}
	
	// tags - 可嵌套
	static function tagMain($tpl=''){
		foreach(self::$tag_func as $ftag=>$tofunc){
			$tpl = self::cecho($tpl,$ftag);	
		}
		preg_match_all("/\{".self::$tag_fix."/i", $tpl, $_m);
		$tags = array();
		if(!empty($_m[0])){
			for($i=count($_m[0])-1;$i>=0;$i--){ //echo "\n:::".$_m[0][$i];
				$tpl = self::tagOne($tpl, $_m[0][$i]);
			}
		}
		return $tpl;
	}
	
	// 解析一个标签
	// $tag1 like {tag:flag3
	static function tagOne($tpl, $tag1){ 
		$tag2 = str_replace('{tag:','{/tag:',$tag1).'}'; // 结束符 {tag:flag3
		$p1 = strpos($tpl, $tag1);
		$p2 = strpos($tpl, $tag2);
		$data = substr($tpl, $p1, $p2-$p1+strlen($tag2)); 
		$tag0 = substr($tag1,5);
		$varid = '$t_'.$tag0;
		preg_match("/\{tag:$tag0\=([^\n]{12,1200}\])\}/i", $data, $_m);
		// $_m[0] : {tag:flag2=[...]}
		// $_m[1] : [Type,re2][modid,demo][idfix,top]
		if($p2>$p1 & $_m){ 
			$pt = self::tagParas($_m[1]);
			$type = $pt[0]; $re = $pt[1]; $ps = $pt[2]; $dstr = $data;  
			$unv = in_array($type,array('One','jsOne')) ? '$'.$re : $varid;
			$dstr = self::tagRows($dstr, $_m, $tag2, $varid, $re, $type);
			if(substr($type,0,2)=='js'){ //js标签
				//$dstr = str_replace('$this->show(', '$vop->show(', $dstr);
				$tplnow = cfg('run.comp'); 
				$jsfile = vopTpls::path('tpc')."/$tplnow.$tag0.comjs.php";
				$dstr = str_replace($_m[0], '<!-- start('.$unv.'); -->', $dstr);
				$conhead = "(!defined('RUN_MODE')) && die('No Init'); "; 
				comFiles::put($jsfile, "<?php $conhead ?>".$dstr); //写入缓存
				$ps = self::_1Pjs($_m[1]);
				$dstr = "<div id='jsid_tags_".str_replace('/','_',$tplnow)."_$tag0'><!--".str_replace('[js','['.$tplnow.','.$tag0.'][',$ps)."--></div>";
			}else{
				$dstr = str_replace($_m[0], '<?php '.$unv.' = $this->tagParse("'.$tag0.'","'.$type.'",'.$ps.'); ?>', $dstr);
			}
			$tpl = str_replace($data, $dstr, $tpl);
		}
		return $tpl;
	}
	
	// 分析一个标签的参数
	// $str = '[listtype,re1][modid,$mod][ids,top][china,area,in.get]';
	// re = ('listtype','re1',array(array('modid',$mod),array('ids','top'),array('china','area','in.get')));
	static function tagParas($str,$ret='str'){ 
		preg_match_all("/\[\s*(.+?)\s*\]/is",$str, $m0); 
		$m1 = $m0[1]; $a1 = $m1[0]; unset($m1[0]);
		$a2 = explode(',',"$a1,");
		$type = $a2[0]; $re = $a2[1]; 
		$paras = "array("; $pare1 = array();
		$re || $re = 'v';
		$js = (substr($type,0,2)=='js') ? 1 : 0; 
		foreach($m1 as $k=>$v){
			$a2 = explode(',',"$v");	
			$paras .= "array("; $pare2 = array();
			foreach($a2 as $k2=>$v2){
				$pare2[] = $v2;
				$v2 = self::_1Para($v2,$js);
				// [modid,$ucfg('mod')] -=> $ucfg['mod']
				$v2 = str_replace(array("('","')"),array("['","']"),$v2); 
				$paras .= "$v2,";
			}
			$paras .= "),";
			$pare1[] = $pare2;
		}
		$paras .= ")";
		$a1 = array(',),',);
		$a2 = array('),',);
		$patmp = $ret=='str' ? $paras : $pare1; 
		$paras = str_replace($a1,$a2,$patmp);
		return array($type,$re,$paras);		
	}
	
	// 分析一个标签的{:row} 
	// extract, if()
	static function tagRows($dstr, $_m, $tag2, $varid, $re, $type=''){
		$unv = in_array($type,array('One','jsOne')) ? '$'.$re : $varid;
		if(in_array($type,array('One','jsOne'))){ 
			$for = '<?php if(!empty('.$unv.')){ extract($'.$re.',EXTR_PREFIX_ALL,\'t\'); ?>';
			$dstr = str_replace($_m[0], $_m[0].$for, $dstr);
			$dstr = str_replace($tag2, $tag2.'<?php } ?>', $dstr);	
		}else{ //'Type','List','Page','jsType','jsList','jsPage'
			if(!strstr($dstr,'{:row}')){
				$dstr = str_replace($_m[0], $_m[0].'{:row}', $dstr);
				$dstr = str_replace($tag2, $tag2.'{/row}', $dstr);
			}
			$for = '<?php if(!empty('.$varid.')){ foreach('.$varid.' as $i_'.$re.' => $'.$re.'){ extract($'.$re.',EXTR_PREFIX_ALL,\'t\'); ?>';
			$dstr = str_replace('{:row}', $for, $dstr);
			$dstr = str_replace('{/row}', '<?php } } ?>', $dstr);
		}
		$dstr = str_replace($tag2, '<?php unset('.$unv.'); ?>', $dstr);
		return $dstr;
	}
	
	// 分析一个参数
	// class::func(@$re1['h'])
	static function _1Para($v,$js=0){
		if(empty($v)) return $v;
		// array('w'=>250\n'h'=>@$re1['h'])
		if(substr($v,0,6)=='array('){ 
			$v = str_replace("\\n",",",$v);
			return $v;
		// class::func(@$re1['h'])
		}elseif(strpos($v,'::')){ 
			return $v;
		// $re1['kid'], "about-$re1[kid]"
		}elseif(strstr($v,'$')){ // || strstr($v,'"')
			//$v = $js ? '[?php echo '.$v.'; ?]' : $v;
			return $v;
		// did='2004-33-2ycx'
		}elseif(strstr($v,"'")){
			return '"'.$v.'"';
		}else{
			return "'$v'";
		}
	}
	
	// [c_page/test_tjs,flag1][Type,re1][modid,$_modx1][idfix,top]
	static function _1Pjs($s){
		$t = str_replace(array('([','][','])',),array('',',','',),"($s)");
		$a = explode(',',$t);
		foreach($a as $k=>$v){
			if(strstr($v,'$')){
				$s = str_replace($v,'<?php echo '.$v.'; ?>',$s);	
			}
		}
		return $s;
	}
		
}


/*******************************************************************************
 File : \code\core\vops\vopMedia.php 
*******************************************************************************/
<?php
/*
*/
// Media类
class vopMedia{

	// {media:[type=map][val=3.44%2C44.24][w=33][h=44][ext=地点1]/media}
	static function repShow($cstr){ 
		preg_match_all("/\{media\:([^\n]{12,1200}\])\/media\}/i", $cstr, $m);
		$cfgs = self::cfgTypes();
		if(!empty($m[0])){
			foreach($m[0] as $k=>$itm){ 
				$porg = $m[1][$k]; 
				$mtype = self::onePara($porg,'type'); 
				if(!isset($cfgs[$mtype])) continue;
				$sres = self::_repItem($porg,$mtype);
				$cstr = str_replace($itm,$sres,$cstr); //echo "\n b--- $cstr";
			}
		}
		$cstr = comFiles::revSaveDir($cstr);
		return $cstr;
	}	

	static function _repItem($porg,$mtype){
		$mapi = cfg('sys_map');
		$pw = self::onePara($porg,'w'); $pw = $pw>80 ? $pw : '480'; //100%;
		$ph = self::onePara($porg,'h'); $ph = $ph>60 ? $ph : '360';
		$val = self::_itmUri($porg);
		if(in_array($mtype,array('iframe','map'))){
			if($mtype=='map'){
				$title = self::onePara($porg,'ext'); $point = $val; 
				$val = PATH_ROOT."/plus/map/index.php?type=$mapi&point=$point&title=$title";
			}
			$sres = "<iframe src='$val' width='$pw' height='$ph'></iframe>";
		}else{ //if(in_array($mtype,array('swf','audio','ckvdo'))){ //'flv',
			if($mtype=='audio') $ph = intval(self::onePara($porg,'h')); $ph = $ph>10 ? $ph : '30'; //重新取一次
			$tpl = self::_itmTpl($mtype);
			$sres = self::_itmRep($tpl,$val,$pw,$ph); 
			$exMethed = '_ex'.ucfirst($mtype);
			if(method_exists(__CLASS__,$exMethed)){
				$sres = self::$exMethed($sres,$val,$mtype,$porg);
			}
		}
		return $sres;
	}
	
	static function _exCkvdo($sres,$val,$mtype,$porg){
		global $_cbase;
		$playid = $mtype.'_'.substr(basStr::filKey($val),-12,12).'_'.basKeyid::kidRand('f',8);
		$sres = str_replace(array('{$id}'),$playid,$sres); 
		$ckjs = '/ckplayer/ckplayer/ckplayer.js';
		if($mtype=='ckvdo' && !strstr($_cbase['run']['jsimp'],$ckjs)){
			$_cbase['run']['jsimp'] .= "$ckjs,"; 
			$sres = basJscss::jscode('',PATH_VENDUI.$ckjs).$sres; 
		}
		return $sres;
	}
		
	static function _itmTpl($file){
		return comFiles::get(DIR_CODE."/cfgs/player/$file.htm"); 
	}
	
	static function _itmRep($org,$val,$pw,$ph){
		$re = str_replace(array('{$url}','{$w}','{$h}'),array($val,$pw,$ph),$org);
		$re = str_replace(array('{uiroot}','{$uiroot}'),array(PATH_VENDUI),$re);
		return $re; 
	}
	
	static function _itmUri($org){
		$val = self::onePara($org,'val'); 
		$val = urldecode($val); 
		return $val;
	}	
	
	static function onePara($str,$key){
		preg_match("/\[$key\=([^\]]{1,255})\]/i", $str, $m);
		return empty($m[1]) ? '' : $m[1];
	}
	
	static function cfgTypes(){
		return basLang::ucfg('cfglibs.dopmedia'); //;
	}	
}



/*******************************************************************************
 File : \code\core\vops\vopShow.php 
*******************************************************************************/
<?php
/*

*/
// 标签解析,显示 总控类
class vopShow{
	
	protected $vars = array(); //存放变量信息
	
	public $tplCfg = array(); //模板配置
	public $ucfg = array(); //url-Configs
	public $err = ''; 
	
	public $pgflag = array();
	public $pgbar = array(); //分页信息
	public $mod,$key,$view,$type; 
	
	function __construct($start=1){
		$this->tplCfg = cfg('tpl');
		$start && $this->run();
	}
	
	// 包含html区块（通过模板解析）
	// vopShow::inc('/tools/rhome/home.htm',DIR_ROOT,1);
	// include(vopShow::inc('/tools/rhome/home.htm',DIR_ROOT));
	static function inc($file,$part='',$inc=0){
		global $_cbase;
		$cac = '/tpls/_vinc/'.substr($file,strpos($file,'/')+1);
		if(!file_exists(DIR_DTMP.$cac) || !$_cbase['tpl']['tpc_on']){
			$template = comFiles::get($part.$file);
			$btpl = new vopComp();
			$template = $btpl->bcore($template);
			comFiles::chkDirs($cac,'tmp'); 
			comFiles::put(DIR_DTMP.$cac, $template); //写入缓存
		}
		if($inc){
			include(DIR_DTMP.$cac);
		}else{
			return DIR_DTMP.$cac;
		}
	}
	//init-js
	function rjs($data=''){
		global $_cbase;
		$data || $data = basReq::val($data,'','');
		$temp = vopCTag::tagParas($data,'arr'); 
		$tagfile = @$temp[0]; 
		$tagname = @$temp[1]; $varid = 't_'.$tagname;
		$tagpath = "/$tagfile.$tagname.comjs.php";
		if(!file_exists(vopTpls::path('tpc').$tagpath)){
			vopComp::main($tagfile);
		} //var_dump($temp[2]); 
		$temp = @$temp[2];
		$tagtype = @$temp[0][0];
		$tagre = @$temp[0][1]; $tagre || $tagre = 'v';
		unset($temp[0]);
		$tagparas = $temp;
		$unv = in_array($tagtype,array('One')) ? $tagre : $varid;
		$$unv = $this->tagParse($tagname,$tagtype,$temp);
		//显示模板 
		//$user = usrBase::userObj(); 
		$_groups = glbConfig::read('groups'); 
		require(vopTpls::path('tpc').$tagpath);
	}
	//run
	function run($q=''){ 
		global $_cbase; 
		//初始化
		$this->vars = array(); //重新清空,连续生成静态需要
		$this->ucfg = $_cbase['mkv'] = vopUrl::init($q); 
		if(empty($this->ucfg)) { return; }
		foreach(array('mkv','mod','key','view','type','tplname',) as $k){
			$this->$k = $this->ucfg[$k];
		}
		//读取数据,赋值 $this->set('name', 'test_Name');
		$vars = $this->getVars();
		if(is_string($vars)){ //考虑生成静态,不要die,返回给生产静态的处理
			$this->ucfg = array();
			$this->err = $vars;
			return;
		}else{
			extract($vars, EXTR_OVERWRITE); 
		}
		//模板:判断+编译+显示
		$this->getTpl($vars); 
		$_groups = glbConfig::read('groups'); //显示
		include(vopTpls::path('tpc')."/$this->tplname".$this->tplCfg['tpc_ext']);//加载编译后的模板缓存
	}
	
	//getTpl
	function getTpl($vars=array()) { 
		global $_cbase; 
		$tplname = &$this->tplname; 
		// check-tpldir
		vopTpls::check($_cbase['tpl']['tpl_dir']);
		// 处理:detail 设置的模板 
		if(!empty($vars['tplname'.$this->view])){ 
			$tplname = $vars['tplname'.$this->view];
		}elseif($this->type=='detail'){ 
			$cfgs = '';
			if(isset($vars['grade'])){
				$mcfgs = glbConfig::read('grade','dset');
				$cfgs = $mcfgs[$vars['grade']];
			}elseif(isset($vars['catid'])){
				$mcfgs = glbConfig::read($this->mod);
				$cfgs = $mcfgs['i'][$vars['catid']];
			}
			$cfgs = empty($cfgs['cfgs']) ? array() : basElm::text2arr($cfgs['cfgs']); 
			if(!empty($cfgs['tplname'.$this->view])){
				$tplname = $cfgs['tplname'.$this->view];
			} //dump($tplname); dump($this->type); dump($this->view);
		} // dump($vars);
		// 编译
		// $tplname = 'c_page/_home'; // for Test
		if(!empty($_cbase['tpl']['tpc_on']) || !file_exists(vopTpls::path('tpc')."/$tplname")){
			vopComp::main($tplname);
		}
		// save
		$_cbase['run']['tplname'] = $tplname;
	}

	//GetVars
	function getVars() { 
		$_groups = glbConfig::read('groups');
		if(!($this->type=='detail')) return array();
		$pid = @$_groups[$this->mod]['pid'];
		$key = in_array($pid,array('types')) ? "kid" : substr($pid,0,1).'id';
		$data = $dext = array();
		if(in_array($pid,array('docs','users','coms','advs','types'))){
			$db = glbDBObj::dbObj();
			$tabid = glbDBExt::getTable($this->mod);
			$data = $db->table($tabid)->where(substr($pid,0,1)."id='{$this->key}'")->find();
			if(empty($data)){ return $this->msg("[{$this->key}]".lang('core.vshow_uncheck')); }
			if(in_array($pid,array('docs'))){
				$tabid = glbDBExt::getTable($this->mod,1);
				$dext = $db->table($tabid)->where(substr($pid,0,1)."id='{$this->key}'")->find();
				$dext && $data += $dext; 
			}
		}
		return $this->vars = $data;
	}
	
	//分页标签
	function chkPage($tagname) {
		$nowtpl = cfg('run.tplnow'); 
		if(empty($this->pgflag)){
			$this->pgflag = array('tpl'=>$nowtpl,'tag'=>$tagname,);
		}else{
			$msg0 = "<b>".lang('core.vshow_1pagetag')."</b>";
			$msg1 = '<br>tpl:'.$this->pgflag['tpl'].', tag:'.$this->pgflag['tag'];
			$msg2 = '<br>tpl:'.$nowtpl.', tag:'.$tagname;
			$this->msg("$msg0$msg1$msg2");
		}
	}

	// 解析
	function tagParse($tagname,$type,$paras=array()){ 
		global $_cbase; 
		$res = tagCache::comTag($type,@$this->mkv,$paras);
		if(!empty($res[1])){ //缓存
			$data = $res[1]; 
			$_cbase['page']['bar'] = @$data['page_bar'];
			unset($data['page_bar']);
		}else{
			if($type=='Page') $this->chkPage($tagname);
			$this->tagRun('tagnow',$tagname);
			$class = "tag$type";
			$_1tag = new $class($paras);
			$data = $_1tag->getData();
			if($res[0]){
				tagCache::setCache($res[0],$data,1);
			}	
		}
		return $data;
	}
	// setRun
	function tagRun($key,$val='',$ext=''){
		global $_cbase;
		$_cbase['run'][$key] = $val; 
		if($ext) $_cbase['run'][substr($key,0,3).$ext][] = $val;
		$tpldir = $this->tplCfg['tpl_dir']; 
	}
	// unset
	function tagEnd($tname=''){
		
	}

	//模板赋值
	function set($name, $value = '') {
		if( is_array($name) ){
			foreach($name as $k => $v){
				$this->vars[$k] = $v;
			}
		} else {
			$this->vars[$name] = $value;
		}
	}
	// msg分析
	static function msg($msg=''){
		if(!defined('RUN_STATIC')){
			glbError::show($msg,0);	
		}else{
			return $msg;	
		}
	}
	
	// page-meta
	function pmeta($title='',$keywd='',$desc=''){
		global $_cbase; 
		$mcfg = glbConfig::cread($this->mod);
		if($this->type=='detail'){
			if(empty($title) && !empty($this->vars['title'])) $title = $this->vars['title'];
			if(empty($keywd) && !empty($this->vars['seo_key'])) $keywd = $this->vars['seo_key'];
			if(empty($desc) && !empty($this->vars['seo_des'])) $desc = $this->vars['seo_des'];
		}elseif(in_array($this->type,array('mhome','mext'))){
			if(empty($title)) $title = @$mcfg['title'];
			if(isset($mcfg['i']) && empty($keywd)){ 
				$a = comTypes::getSubs($mcfg['i'],'0','1'); $gap = ''; 
				foreach($a as $k=>$v){
					$keywd .= "$gap$v[title]"; $gap = ',';
				} //公司新闻,客户新闻,行业新闻
			}
		}elseif($this->type=='mtype'){ 
			if(empty($title) && !empty($mcfg['i'])){ 
				$title = $mcfg['i'][$this->key]['title']; 
				if(!empty($mcfg['i'][$this->key]['pid'])){
					$title .= '-'.$mcfg['i'][$mcfg['i'][$this->key]['pid']]['title'];
				} //子类3-栏目四
			}
		}
		if($title){
			$title = str_replace('(sys_name)',$_cbase['sys_name'],$title);
			if(!strstr($title,$_cbase['sys_name'])) $title .= " - ".$_cbase['sys_name'];
		}
		$ua = $this->ucfg['ua']; $up = empty($ua['page']) ? 1 : $ua['page']; //??? 
		echo "<meta charset='{$_cbase['sys']['cset']}'>\n";
		if($title) echo "<title>".basStr::filTitle($title)."</title>\n";
		if(count($ua)>5 | $up>5){
			echo "<meta name='robots' content='noindex, nofollow'>\n";
		}else{
			if($keywd) echo "<meta name='keywords' content='".basStr::filTitle($keywd)."' />\n";
			if($desc) echo "<meta name='description' content='".basStr::filTitle($desc)."' />\n";
		}
	}
	
	// page-import
	function pimp($imp='',$base='tpl',$mod=''){
		global $_cbase;
		$sdir = vopTpls::def(); //可能没有定义
		if(empty($imp)){
			$ext = "user=1&mkv={$this->mkv}&tpldir=$sdir&lang={$_cbase['sys']['lang']}";
			glbHtml::page('imvop',$ext);
		}else{ 
			if($base=='tpl'){ 
				$base = '';
				$imp = "/skin/".$_cbase['tpl']['tpl_dir']."$imp";
			}
			echo basJscss::imp($imp,$base,$mod);
		}
	}

}


/*******************************************************************************
 File : \code\core\vops\vopStatic.php 
*******************************************************************************/
<?php

// Static相关
class vopStatic{

	//生成一个广告类别的缓存
	static function advType($mod,$type=''){
		$db = glbDBObj::dbObj();
		$cfg = glbConfig::read($mod);
		$dtpl = array(
			'1'=> "<a href='{url}' target='_blank'>{title}</a>",
			'2'=> "<a href='{url}' target='_blank'><img src='{mpic}' name='{title}' alt='{title}' /></a>",
			'3'=> "{detail}",
		);
		$tpl = empty($cfg['i'][$type]['cfgs']) ? $dtpl[$cfg['etab']] : $cfg['i'][$type]['cfgs']; 
		$data = ''; $rep = array('title','url','mpic','detail');
		$list = $db->table("advs_$mod")->where("catid='$type' AND `show`='1'")->select();
		if($list){
			foreach($list as $r){
				$istr = $tpl;
				if(in_array($cfg['etab'],array(1,2))){ 
					$r['url'] = PATH_ROOT."/plus/ajax/redir.php?advs:".comConvert::sysBase64("$mod,$r[aid],$r[url]");
				}
				foreach($rep as $key){
					$istr = str_replace('{'.$key.'}',$r[$key],$istr);
				}
				$istr = str_replace(array('{root}','{$root}'),PATH_ROOT,$istr);
				if($cfg['etab']==3 && !empty($r['url'])){
					$_arep = explode('[=]',$r['url']); 
					$istr = str_replace($_arep[0],$_arep[1],$istr);
				}
				$data .= "$istr\r\n";
			}
		}
		$data = comFiles::revSaveDir($data);
		$file = tagCache::caPath($mod,$type,0);
		comFiles::chkDirs($file,'tmp'); 
		comFiles::put(DIR_DTMP."/$file",$data);
		return $data;
	}

	//广告Static(按类别)
	static function advMod($mod,$aids=array()){
		$db = glbDBObj::dbObj();
		$cfg = glbConfig::read($mod);
		if($cfg['etab']==4) return;
		$ids = '';
		if(is_array($aids)){
			foreach($aids as $id=>$v){ 
				if(empty($id)) continue;
				$ids .= (empty($ids) ? '' : ',')."'$id'";			
			}
		}else{
			$ids = "'$aids'";	
		}
		if(!$ids) return;
		$whr = $ids=="'(all)'" ? '1=1' : "aid IN($ids)";
		$types = array(); $data = '';
		$list = $db->field('DISTINCT catid')->table("advs_$mod")->where($whr)->select(); //frame=0 AND 
		if($list){
			foreach($list as $r){
				$caid = $r['catid'];
				$ditm = self::advType($mod,$caid);
				$data .= "[$caid]-{$cfg['i'][$caid]['title']}:::<br>$ditm <hr class='ma10 cF0F'> ";
			}
		}
		return $data;
	}

	// showRes
	static function showRes($res){
		$msg = lang('core.vops_batres')."<br><br>\n";
		$msg .= $res['msg'] ? $res['msg']."<br>" : lang('core.vops_dores',"[{$res['ok']}/{$res['cnt']}]")."<br>\n";
		$msg .= "[".date('Y-m-d H:i:s')."]<br>\n";
		if($res['next']){ 
			$msg .= "<br>\n".lang('core.vops_3secnext')."<br>\n";
			$js = "setTimeout(\"location.href='{$res['url']}';\",3000);"; 
			$js = basJscss::jscode($js);
		}else{
			$msg .= "<br>\n".lang('core.vops_end')."<br>\n";
			$js = '';	
		}
		glbHtml::page(lang('core.vops_res'));
		glbHtml::page('body');
		echo "\n<p>$msg</p>\n<hr>\n$js";
		unset($res['msg']); basDebug::varShow($res);
		glbHtml::page('end');
	}
	
	static function batList($mod,$tpl){ 
		$re = array('msg'=>'','cnt'=>0,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$lists = vopTpls::entry($tpl,'ehlist','static');
		$listn = $lists[$mod]; $msg = '';
		foreach($listn as $key=>$v){ 
			if(!strpos($v,'/')) continue; //first,close
			$key = $key=='m' ? "" : "-$key";
			$msg .= vopStatic::toFile("$mod$key")."<br>\n"; 	
		}
		$re['msg'] = $msg;
		return $re;
	}
	static function batDetail($mod,$tpl){ 
		$re = array('msg'=>'','cnt'=>0,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$data = self::batKids($mod); $msg = ''; 
		$vcfg = glbConfig::vcfg($mod);
		if(!empty($data)){
			foreach($data as $key=>$row){ 
				$oid = $key;
				if(empty($re['min']) || $oid<$re['min']) $re['min'] = $oid;
				if(empty($re['max']) || $oid>$re['max']) $re['max'] = $oid;
				if(empty($vcfg['c']['stypes']) || in_array($row['type'],$vcfg['c']['stypes'])){ 
					$msg .= vopStatic::toFile("$mod.$key")."<br>\n";
					$re['cnt']++;
				}else{
					$msg .= "[$mod.$key][{$row['type']}] Skip...<br>\n";
				}
			}
			$re['next'] = 1; 
		}else{
			$re['msg'] = 'No Data';
			$re['next'] = 0;	
		} 
		$re['msg'] = $msg;
		if($re['next']){
			$offset = basReq::val('order')=='ASC' ? $re['max'] : $re['min'];
			$re['url'] = basReq::getURep(0,'offset',$offset);
		}
		return $re; 
	}
	// mod,limit(1-500),order(did:ASC),stype,offset
	static function batKids($mod){
		$db = glbDBObj::dbObj();
		$mcfg = glbConfig::read($mod); $whrstr = '';
		$stype = basReq::val('stype'); $offset = basReq::val('offset');
		$limit = basReq::val('limit',10,'N'); if($limit<1) $limit = 10;
		$order = basReq::val('order','DESC');
		if(in_array($mcfg['pid'],array('docs','advs'))){ 
			$stype && $whrstr .= basSql::whrTree($mcfg['i'],'catid',$stype);
			$ftype = ',catid';	
			$tabid = "docs_$mod";
		}elseif(in_array($mcfg['pid'],array('users'))){
			$stype && $whrstr .= " AND grade='$stype'";
			$ftype = ',grade';	
			$tabid = "users_$mod";
		}else{
			$ftype = '';	
		}
		$kname = substr($mcfg['pid'],0,1).'id';
		$omod = in_array(strtoupper($order),array('ASC','DESC','EQ')) ? strtoupper($order) : 'DESC';
		$offset = basReq::val('offset');
		if($offset){
			if(strstr($omod,'DESC')){
				$op = '<';
			}elseif(strstr($omod,'ASC')){
				$op = '>';
			}else{ // EQ
				$op = '=';
			}
			$whrstr .= " AND $kname$op'$offset'";
		} 
		$whrstr = $whrstr ? substr($whrstr,5) : '1=1'; 
		$data = $db->field("$kname$ftype,`show`")->table($tabid)->where($whrstr)->order("$kname $omod")->limit($limit)->select(); 
		$re = array();
		if(!empty($data)){
			foreach($data as $row){ 
				$type = $ftype ? $row[substr($ftype,1)] : $ftype;
				$re[$row[$kname]] = array('show'=>$row['show'],'type'=>$type);
			}
		}
		return $re;
	}
	
	static function delList($mod,$tpl){ 
		$re = array('msg'=>'','cnt'=>0,'ok'=>0,'next'=>'','min'=>'','max'=>'',);
		$lists = vopTpls::entry($tpl,'ehlist','static');
		$listn = $lists[$mod]; $msg = '';
		foreach($listn as $key=>$v){
			$key = $key=='m' ? "" : $key;
			$file = self::getPath($mod,$key,0);
			$res = @unlink(DIR_HTML.'/'.$file); $res = var_export($res,1);
			$msg .= "{$res}:".$file."<br>\n";
		}
		$re['msg'] = $msg;
		return $re;
	}
	static function delDetail($mod,$sub=''){ 
		static $fext, $msg;
		if(empty($fext)){
			$mcfg = glbConfig::vcfg($mod); 
			$fext = $mcfg['c']['stext'];
			$msg = '';
		} //echo "($fext)";
		$dfix = basReq::val('offset');
		$elen = strlen($fext);
		$ndir = DIR_HTML."/$mod$sub";
		if(!is_dir("$ndir")){ return false; };
		$handle = opendir("$ndir");
		while(($file = readdir($handle)) !== false){
			if($file != "." && $file != ".."){
				if(in_array($file,array('index.htm','index.html'))) continue;
				if(is_dir("$ndir/$file")){
					if(empty($sub) && $file=='home'){ continue; }
					if(empty($sub) && $dfix && strstr($file,$dfix)){ continue; }
					self::delDetail($mod,"$sub/$file");
				}else{
					if(substr($file,-$elen,$elen)==$fext){
						$res = @unlink("$ndir/$file"); $res = var_export($res,1);
						$msg .= "{$res}:$sub/$file<br>\n";
					}
				}
			}
		}
		$re = array('cnt'=>substr_count($msg,'<br>'),'ok'=>substr_count($msg,'true:'),'next'=>'',);
		$re['msg'] = $msg;
		return $re;
	}
	//生成Static文件(当前模板)
	static function toFile($q=''){ 
		basEnv::runCbase(); //重置参数
		defined('RUN_STATIC') || define('RUN_STATIC',1);
		static $vop; if(empty($vop)) $vop = new vopShow(0);
		ob_start(); 
		$err = $vop->run($q); 
		if(empty($vop->ucfg)){ 
			return $vop->err ? $vop->err : "($q)Error! Has NO set tpl!"; 
		}
		$re = ob_get_contents();
		$kid = $vop->mod=='home' ? 'home' : $vop->key;
		$vext = empty($vop->view) ? '' : ".$vop->view";
		$file = self::getPath($vop->mod,$kid.$vext,0); dump($file);
		$msg = $file.' : '.basStr::showNumber(strlen($re),'Byte').'';
		comFiles::chkDirs($file,'htm');
		comFiles::put(DIR_HTML.'/'.$file,"$re\n<!--$msg-->");
		ob_end_clean(); 
		return $msg;
	}
	
	//获得Static文件路径(当前模板):
	static function getPath($mod,$kid,$isfull=1){
		$kid || $kid = 'home'; 
		$dir = comFiles::getResDir($mod,$kid,$isfull);
		if($isfull){
			$dir = DIR_HTML.substr($dir,strlen(DIR_URES)); 	
		}
		$mcfg = glbConfig::vcfg($mod); 
		return $dir.$mcfg['c']['stext'];
	}
	
	//updKid:更新(add,del,edit)一个Kid的静态
	static function updKid($mod,$kid,$act='upd'){
		global $_cbase;
		$tplbak = $_cbase['tpl']['tpl_dir'];
		$vcfg = vopTpls::etr1('tpl'); 
		$re = array();
		foreach($vcfg as $tpl=>$suit){
			if(strpos($_cbase['tpl']['no_static'],$tpl)) continue;
			$file = DIR_CODE."/tpls/$tpl/_config/vc_$mod.php";
			if(file_exists($file)){
				include($file); 
				$kc = "_vc_$mod"; $cfg = $$kc;
				if($cfg['c']['vmode']=='static'){
					if($act=='del'){
						vopTpls::set($tpl);
						$re[$tpl] = self::getPath($mod,$kid,1);
					}else{
						$re[$tpl] = "$mod.$kid";
					}
				}
			}
		}
		$_cbase['tpl']['tpl_dir'] = $tplbak;
		return $re; 
	}
	
	//是否需要生成静态
	static function chkNeed($mkv=''){ 
		$moda = vopUrl::imkv(array('mkv'=>$mkv),'a');
		$kid = $moda[0]=='home' ? 'home' : $moda[1]; 
		$vcfg = glbConfig::vcfg($moda[0]); 
		if(@$vcfg['c']['vmode']!='static') return 0;
		$vext = empty($moda[2]) ? '' : ".$moda[2]";
		$file = self::getPath($moda[0],$kid.$vext,0);
		$flag = !tagCache::chkUpd("/$file",$vcfg['c']['stexp'],'htm');
		return $flag;	
	}
	
	//
	static function clrFile($mod,$kid){
		$dir = comFiles::getResDir($mod,$kid);
		comFiles::delDir($dir,1);
		$files = array(); 
		foreach($files as $files){
			@unlink($files);
		}
	}
	
}


/*******************************************************************************
 File : \code\core\vops\vopTpls.php 
*******************************************************************************/
<?php
/*

*/
// 模版相关
class vopTpls{
	
	//获得模版或缓存路径:type=tpl,tpc;
	static function path($type='',$root=1){
		$tpldir = cfg('tpl.tpl_dir');
		$path = $type=='tpc' ? '/tpls/'.$tpldir : '/tpls/'.$tpldir; 
		return ($root ? ($type=='tpc' ? DIR_DTMP : DIR_CODE) : '').$path;  
	}
	
	// include_once:扩展函数：{php vopTpls::pinc('chn:tex_keres');} -=> chn/b_func/tex_keres.php
	// 得到_config路径：      {php include(vopTpls::pinc('_config/va_home')); } -=> _config/va_home.php
	// 得到include需要的路径：{php include(vopTpls::pinc('d_tools/a_cfgs')); } -=> d_tools/a_cfgs.php
	static function pinc($finc,$ext='',$refull=1){
		$fpos = strpos($finc,'/');
		if(strpos($finc,':')){
			$a = explode(':',$finc);
			$tpl = $a[0];
			$finc = $a[1];
		}else{
			$tpl = cfg('tpl.tpl_dir');
		}
		$path = "/tpls/$tpl";
		$ext = empty($ext) ? '.php' : $ext;
		if($fpos){ 
			return ($refull ? DIR_CODE : '')."$path/$finc$ext";
		}else{ 
			include_once(DIR_CODE."$path/b_func/$finc$ext");
		}
	}
	
	//兼容方法
	static function pcfg($mod='',$root=1){ return self::pinc("_config/{$mod}",'',$root); }
	
	//设置当前tpl:set tpl path
	static function set($dir=''){
		global $_cbase; 
		//$dir = $dir ? $dir : basReq::val('tpldir');
		if($dir){
			$_cbase['tpl']['tpl_dir'] = $dir;	
		}
		return empty($_cbase['tpl']['tpl_dir']) ? '' : $_cbase['tpl']['tpl_dir'];
	}
	
	//获得默认模板
	static function def($type='adm'){
		$tpldir = cfg('tpl.tpl_dir');
		if(!empty($tpldir)){
			return $tpldir;
		}else{
			$vcfg = vopTpls::etr1('show'); 
			return $vcfg['_deadmin_'];	
		}
	}
	
	//type=res,show,tpl;title;0,1,
	static function etr1($type=0,$dir=''){
		$vcfg = glbConfig::read('vopfmt','ex'); 
		if(strlen($type)<3){ // 0,1,''
			$etr = PATH_PROJ.$vcfg['tpl'][$dir][1];
			if($type){ //$full
				$etr = cfg('run.rsite').$etr;
			}
			return $etr;
		}elseif(in_array($type,array('res','show','tpl'))){
			return $vcfg[$type];
		}elseif($type=='title'){
			return $vcfg['tpl'][$dir][0];
		}else{ //all
			return $vcfg;
		}
	}
	
	// entry 
	// $cb=emumem/ehlist
	static function entry($dir='',$cb='emumem',$mode=''){
		$dir = $dir ? $dir : cfg('tpl.tpl_dir');	
		$dir = DIR_CODE."/tpls/$dir/_config";
		$list = comFiles::listDir($dir);
		$re = array();
		foreach($list['file'] as $file=>$v){ 
			if(strpos($file,'.maobak')) continue;
			$key = str_replace('.php','',$file);
			$kc = "_$key"; $km = substr($key,3);
			include("$dir/$file"); $cfg[$km] = $$kc;
			if(!in_array($key,array('va_docs'))){ //,'va_home'
				$re = $re + self::$cb($cfg[$km],$km,$mode); 
		}	} 
		if(!empty($cfg['home']['close'])){
			foreach($cfg['home']['close'] as $km){
				unset($re[$km]);
			}
		}
		if(!empty($cfg['home']['imcfg'])){
			foreach($cfg['home']['imcfg'] as $km=>$from){
				$re = $re + self::$cb($cfg[$from],$km,$mode); 
			}
		}
		return $re;
	}
	// emumem
	static function emumem($cfg,$km,$mode){
		$re = array();
		foreach(array('c','v') as $k) unset($cfg[$k]); //'d','m','t','first'
		foreach($cfg as $ki=>$kv){ 
			if(empty($kv) || $km=='home') continue;
			$kv = (is_array($kv) && isset($kv[0])) ? $kv[0] : $kv;
			$re["$km-$ki"] = $kv;
		} 
		return $re;
	}
	// $mode=dynamic/static/both/all/
	static function ehlist($cfg,$km,$mode){
		$re = array();
		if(in_array($mode,array('static','dynamic')) && $cfg['c']['vmode']!=$mode) return $re;
		if($mode=='both' && !in_array($cfg['c']['vmode'],array('static','dynamic'))) return $re;
		foreach(array('c','v','d') as $k) unset($cfg[$k]); //,'m','t','first'
		foreach($cfg as $ki=>$kv){ 
			if(empty($kv)) continue;
			if($km=='home' && $ki!='m') continue;
			$kv = (is_array($kv) && isset($kv[0])) ? $kv[0] : $kv;
			if($ki=='t'){ 
				$re[$km] = empty($re[$km]) ? array() : $re[$km];
				$re[$km] = $re[$km] + self::etypes($km,$kv,""); 
			}else{ 
				$re[$km]["$ki"] = $kv;
			}
		}
		return $re;
	}
	// etypes
	static function etypes($km,$kval,$fix=''){
		$re = array();
		$mcfg = glbConfig::read($km); 
		foreach($mcfg['i'] as $ki=>$kv){ 
			$re["$fix$ki"] = $kval; 
		}
		return $re;
	}
	
	static function check($tpl,$die=1){
		static $tplchks;
		if(empty($tplchks[$tpl])){
			$vopfmt = glbConfig::read('vopfmt','ex'); 
			if(empty($vopfmt['tpl'][$tpl])){ //无tpl配置
				$tplchks[$tpl]['cfg'] = 1;
			}
			$fp = DIR_CODE."/tpls/$tpl/_config/va_home.php";
			if(!file_exists($fp)){
				$tplchks[$tpl]['dir'] = 1;
			}
			if(empty($tplchks[$tpl])){
				$tplchks[$tpl]['ok'] = 1;	
			}
		} //print_r($tplchks);
		if($die && empty($tplchks[$tpl]['ok'])){
			vopShow::msg("[excfg/ex_vopfmt.php]/[tpls/$tpl/_config] Config Error!");
		}
		return $tplchks[$tpl];
	}

}


/*******************************************************************************
 File : \code\core\vops\vopUrl.php 
*******************************************************************************/
<?php
/*
mod-type-view
mod.kid.view
mkv --=> tpl
*/
// Url 类
class vopUrl{	
	
	static $params = array('mkv','mod','key','view','type','hcfg','vcfg');
	
	// get/url初始数据
	static function iget($q=''){
		$re = array(); 
		$q = strlen($q)==0 ? $_SERVER['QUERY_STRING'] : $q; //可能为0
		if(empty($q) || $q=='home'){
			$ua = array();
			$mkv = 'home';
		}elseif(strpos($q,'=')){ 
			parse_str($q,$ua); 
			$mkv = empty($ua['mkv']) ? 'home' : $ua['mkv'];
			//about-profile&ext=2015-9d-d4k1 ??? 
			//$mkv = empty($ua['mkv']) ? key($ua) : $mkv = $ua['mkv'];
		}else{ //无=且不为空
			$ua = array('mkv'=>$q);
			$mkv = $q;	
		}
		$re['q'] = $q;
		$re['mkv'] = $mkv; 
		$re['ua'] = $ua;
		return $re;
	}
	
	// mkv/mod初始分析
	static function imkv($re,$remod=0){
		$mkv = $re['mkv']; $type = '';
		if(strpos($mkv,'.')){ //mod.id1-xxx-id2.view
			$a = explode('.',"$mkv.");
			$type = 'detail';
		}elseif(strpos($mkv,'-')){ //mod-type-view, mod--list, about-awhua-2015-9m-f0r1
			$a = explode('-',"$mkv-"); 
			if(!empty($a[3])) $a[2] .= "-$a[3]";
			if(!empty($a[4])) $a[2] .= "-$a[4]"; 
			$type = empty($a[1]) ? 'mext' : 'mtype';
		}else{ //mod
			$a = array($mkv,'','');	
			$type = 'mhome';
		} 
		//$mod分析
		$mod = $a[0]; $key = $a[1]; $view = $a[2];
		if($remod) return $remod=='a' ? $a : $mod;
		$hcfg = glbConfig::vcfg('home'); //print_r($hcfg);
		$vcfg = self::mcheck($hcfg,$mod); //mod-close, home-static, 
		if($type=='mhome' && $vcfg['m']=='first') self::ifirst($mod); //first跳转
		foreach(self::$params as $k) $re[$k] = $$k;
		return $re;
	}
	
	// tpl/key分析
	static function itpl($re){
		foreach(self::$params as $k) $$k = $re[$k]; 
		$tpl = '';
		if($type=='mtype'){ 
			if(isset($vcfg[$key])){
				$cfg = $vcfg[$key];
			}else{ //echo "::cc"; 
				$mcfg = glbConfig::read($mod);
				if(isset($mcfg['i'][$key])){
					$cfg = $vcfg['t'];
				}else{
					vopShow::msg("[$key][type]".lang('core.vop_parerr'));	
				}
			}
		}elseif($type=='detail'){
			$cfg = $vcfg['d'];
		}elseif($type=='mext'){ 
			$cfg = $vcfg['m'];
		}else{ //mhome
			$cfg = $vcfg['m']; 
		} //echo "<br>$mod,$key,$view,$type<br>";
		if($view && isset($cfg[$view])){ 
			$tpl = $cfg[$view]; 
		}else{ //if(!empty($cfg))
			$tpl = is_array($cfg) ? (isset($cfg[0]) ? $cfg[0] : '') : $cfg; // (?home-imcfg)
			//about.2015-9d-d501.list2
			if($type=='detail' && $view && !isset($cfg[$view])){
				vopShow::msg($re['mkv']."[$view]".lang('core.vop_parerr'));
			}
			//indoc-get-my 接收列表
			if($type=='mtype' && $view && (empty($vcfg['v']) || !strstr($vcfg['v'],$view))){ 
				vopShow::msg($re['mkv']."[$view]".lang('core.vop_parerr'));
			}	
		}
		if(empty($tpl)){
			vopShow::msg($re['mkv']."[tpl]".lang('core.vop_parerr'));
		}elseif($tpl=='close'){
			vopShow::msg($re['mkv']."[close]".lang('core.vop_closecat'));
		} // first
		// 处理{mod}, 
		$re['tplname'] = str_replace('{mod}',$mod,$tpl);
		return $re;
	}

	static function ifirst($mod,$re=''){
		$minfo = glbConfig::read($mod);
		$key = empty($minfo['i']) ? '' : key($minfo['i']); 
		if($re=='key'){
			return $key;
		}elseif(defined('RUN_STATIC')){
			return "[$mod]-[$mod-$key]".lang('core.vop_st301dir');
		}else{
			header("Location:?$mod-$key");
		}
	}
	// url分析
	static function init($q='',$ext=array()){
		$re = self::iget($q); 
		$re = self::imkv($re); 
		if($re['mkv']=='home'){
			$re['tplname'] = $re['hcfg']['m'];
		}else{ 
			$re = self::itpl($re); 
			if(empty($re)) return array();
		}
		empty($re['hcfg']['u']) || $re['u'] = $re['hcfg']['u']; //自定义参数
		$re['vcfg'] = isset($re['vcfg']['c']) ? $re['vcfg']['c'] : '';
		$re['hcfg'] = $re['hcfg']['c']; 
		return $re; 
	}
	
	static function mcheck($hcfg,$mod){
		global $_cbase; 
		$tpldir = $_cbase['tpl']['tpl_dir'];
		$_groups = glbConfig::read('groups'); 
		$ukeyh = array_merge($hcfg['extra'],array('home'));
		if(!in_array($mod,$ukeyh) && !isset($_groups[$mod])){
			vopShow::msg("[{$mod}][mod]".lang('core.vop_parerr'));
		}elseif(!empty($_cbase["close_$tpldir"])){ //close
			include(DIR_CODE."/cfgs/stinc/close_info.php");	
		}
		if($mod=='home'){ // home-static
			if(!defined('RUN_STATIC') && $hcfg['c']['vmode']=='static'){
				$file = vopStatic::getPath('home','home',1);
				if($path=tagCache::chkUpd($file,$hcfg['c']['stexp'],0)){ 
					include($path); 
					die("\n<!--".(date('Y-m-d H:i:s'))."-->");
				}
			}
			$vcfg = $hcfg;
		}else{ // mod-close
			$vcfg = glbConfig::vcfg($mod);
			if(!$vcfg){
				vopShow::msg("[{$mod}][vcfg]".lang('core.vop_parerr'));
			}elseif($vcfg['c']['vmode']=='close'){
				vopShow::msg("[{$mod}][close]".lang('core.vop_closemod'));	
			}
		}
		return $vcfg;
	}

	// url格式化输出, 处理静态,伪静态,url优化(只在前台或生成静态,后台用跳转...)
	// paras: array, string 
	static function fout($mkv='',$type='',$host=0){ //,$ext=array()
		if(strpos($mkv,':')) return self::ftpl($mkv,$type,$host);
		$burl = self::burl($host); 
		//mkv分析
		if(strlen($mkv)<3) return self::bind($burl); //首页
		$type || $type = strpos($mkv,'.') ? '.' : '-';
		$a = explode($type,"$mkv$type$type");	
		$mod = $a[0]; $key = $a[1]; $view = $a[2];
		$key = $key=='first' ? self::ifirst($mod,'key') : $key;
		$mcfg = glbConfig::vcfg($mod);
		$vmode = @$mcfg['c']['vmode']; $url = '';
		//close,static
		if($vmode=='close') return '#close#'.$mkv;
		if($vmode=='static'){ // && empty($view)
			$vext = empty($view) ? '' : ".$view";
			$ust = '/'.vopStatic::getPath($mod,$key.$vext,0);
			$url = file_exists(DIR_HTML.$ust) ? PATH_HTML.$ust : '';
			//$url = PATH_HTML.$ust; // is_file,file_exists
		}
		//动态
		if(empty($url)){
			$key = empty($key) ? '' : "$type$key";
			$view = empty($view) ? '' : "$type$view";
			$mkv = "$mod$key$view";
			$url = $burl."?$mkv";
		}
		$url = self::bind($url);
		return $url;
	}
	
	//base-url
	static function burl($host=0){ 
		$dir = cfg('tpl.tpl_dir');
		$burl = vopTpls::etr1($host,$dir);
		return $burl;
	}
	
	//还原root路径
	static function root($val){ 
		$cfg = array('tmp','res','htm', 'stc','vui','vnd', 'web');
		foreach($cfg as $cv){
			$path = comFiles::cfgDirPath($cv,'path');
			$val = str_replace(array('{' .$cv.'root}','{$'.$cv.'root}'),$path,$val);
		}
		return $val;
	}
	//format指定tpl下的url
	static function ftpl($str,$type='',$host=0){
		$tplold = cfg('tpl.tpl_dir'); 
		$a = explode(':',$str);
		$ck = vopTpls::check($a[0],0);
		if(empty($ck['ok'])) return "#close#{$a[1]}";
		$a[0] && vopTpls::set($a[0]);
		$path = self::fout($a[1],$type,$host);
		$a[0] && vopTpls::set($tplold);
		return $path;
	}
	//format指定mod下的第一个类别的url
	static function f1st($mod,$re='(key)'){
		$key = self::ifirst($mod,'key');
		$url = self::fout("$mod-$key");
		if($re) $url = str_replace(array("/$key.","-$key"),array("/$re.","-$re"),$url);
		return $url;
	}

	// 绑定域名
	static function bind($url){
		$binds = cfg('ucfg.dbind'); 
		if(empty($binds)) return $url;
		$na = glbConfig::read('dmbind','ex');
		if(empty($na)) return $url;
		foreach($na as $v){
			$vbak = $v[0];
			$v[0] = str_replace('{html}',PATH_HTML,$v[0]);
			if(empty($v[2])){
				$url = str_replace($v[0],$v[1],$url);
			}else{ 
				if($v[2]==1){
					$v[0] = "/^".preg_quote($v[0],"/")."/i";
					$v[0] = str_replace(array("`d","`w","#`"),array("(\\d","(\\w","+)"),$v[0]);
				}else{ //自由写正则
					$v[0] = str_replace('{html}',preg_quote(PATH_HTML,"/"),"/^$vbak/i");
				}
				$nurl = @preg_replace($v[0],$v[1],$url);
				$url = $nurl ? $nurl : $url;	
			}
		}
		return $url;
	}

	// 路由
	static function route($str=''){
		$org['self'] = $_SERVER['PHP_SELF']; // path/file.php/routdir/routpart
		$org['script'] = $_SERVER['SCRIPT_NAME']; // /path/file.php
		// PATH_INFO = /routdir/routpart, 可能不支持提示(cgi.fix_pathinfo=0)：No input file specified.
		$org['route'] = empty($_SERVER['PATH_INFO']) ? '' : $_SERVER['PATH_INFO']; 
		$org['query'] = $_SERVER['QUERY_STRING']; // act=test&key1=myval2
		parse_str($org['query'],$par); //parse_str() 函数把查询字符串解析到变量中。
		/*if(!safComm::urlQstr7()){
			vopShow::msg("[QUERY]参数错误!");
		}*/
		return array('org'=>$org,'par'=>$par);
	}
	
	// umkv：获取mkv: $_GET > $_cbase > 
	static function umkv($key,$ukey=''){
		$ukey || $ukey = $key;
		$val = basReq::val($ukey,'','Key',24);
		$cmk = cfg("mkv.$key");
		if(empty($val) && !empty($cmk)){
			$val = $cmk; 
		}
		return $val;
	}

}




/*******************************************************************************
 File : \code\flow\admin\catalog.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
usrPerm::run('pfile','admin/catalog.php');

$mod = empty($mod) ? 'demo' : $mod;
$view = empty($view) ? 'glist' : $view;
$pid = empty($pid) ? '0' : $pid;
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod1@catalog.php');

$cfg = glbConfig::read($mod); 
$tabid = "base_catalog";
$gbar = admAFunc::grpNav($cfg['pid'],$mod); 
if(!in_array($cfg['pid'],array('docs','advs'))) glbHtml::end(lang('flow.dops_parerr').':mod2@catalog.php');
//print_r(comTypes::getSubs($cfg['i'],'hn','3'));

if($view=='glist'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$fm[$id]['char'] = strtoupper(comConvert::pinyinMain($fm[$id]['title'],3,1)); 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='del'){ 
					if($db->table($tabid)->where("model='$mod' AND pid='$id'")->find()){
						$msg = lang('admin.cat_dsub',$id); 
					}else{
						$db->table($tabid)->where("model='$mod' AND kid='$id'")->delete(); 	
						$msg = lang('flow.msg_del');
					}
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("model='$mod' AND kid='$id'")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='frame'){ 
					 $db->table($tabid)->data(array('frame'=>'1'))->where("model='$mod' AND kid='$id'")->update();  
				}elseif($fs_do=='nofrm'){ 
					 $db->table($tabid)->data(array('frame'=>'0'))->where("model='$mod' AND kid='$id'")->update(); 
				}
			}
		}
		glbCUpd::upd_model($mod);
	} 
 	
	$lnklay = admAFunc::typLay($cfg,$aurl,$pid); 
	$lnkbak = $_groups[$cfg['pid']]['title'];
	$lnkadd = "<a href='$aurl[1]&view=gform&pid=$pid' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	if($pid && !isset($cfg['i'][$pid])) $lnkadd = "<i title='".lang('admin.cat_close')."'>".lang('flow.fl_addtitle')."&gt;&gt;</i>";
	glbHtml::tab_bar("[$lnkbak]".lang('flow.title_cata')." :: $gname<span class='span ph5'>|</span>$lnkadd<br>$lnklay",$gbar,35);
	
	$_ex_paras = glbConfig::read('paras','ex');
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	echo "<th>".lang('flow.title_char')."</th><th>".lang('flow.title_level')."</th><th>".lang('flow.title_frame')."</th><th>".lang('flow.title_note')."</th>";
	if(in_array($mod,$_ex_paras['catid'])) echo "<th>".lang('flow.title_param')."</th>";
	echo "<th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	
	$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('top,kid')->select();
	if($list){
	foreach($list as $r){
	  $kid = $r['kid'];
	  $u_sub = strstr($aurl[1],'pid=') ? basReq::getURep($aurl[1],'pid',$r['kid']) : "$aurl[1]&pid=$r[kid]";
	  $f_deep = @$cfg['i'][$pid]['deep'] < $cfg['deep']-1;
	  $s_cnt = count(comTypes::getSubs($cfg['i'],$r['kid']));
	  echo "<tr>\n";
	  echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
	  echo "<td class='tc'><a href='$aurl[1]&view=set&kid=$r[kid]' onclick='return winOpen(this,\"".lang('admin.fad_setid',$r['title'])."\",400,300);'>$r[kid]</a></td>\n";
	  echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo "<td class='tc'>$r[char]</td>\n";
	  echo "<td class='tc'>$r[deep]</td>\n"; 
	  echo "<td class='tc'>".glbHtml::null_cell($r['frame'])."</td>\n"; 
	  echo "<td class='tc'>".($f_deep ? "<a href='$u_sub'>$s_cnt</a>" : glbHtml::null_cell($s_cnt))."</td>\n"; 
	  if(in_array($mod,$_ex_paras['catid'])) echo "<td class='tc'>".("<a href='?file=admin/fields&mod=$mod&catid=$r[kid]'>".lang('flow.title_set')."</a>")."</td>\n";  
	  echo "<td class='tc'><a href='$aurl[1]&view=gform&kid=$r[kid]' onclick='return winOpen(this,\"".lang('admin.cat_edit')."-$r[title]\");'>".lang('flow.title_edit')."</a></td>\n";
	  echo "<td class='tl'><input name='fm[$kid][note]' type='text' value='$r[note]' class='txt w120' /></td>\n";
	  echo "</tr>"; 
	}} 
	$cspan = in_array($mod,$_ex_paras['catid']) ? 11 : 10;
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	$opstr = basElm::setOption(lang('flow.op_op4')."\nframe|".lang('admin.cat_frame')."\nnofrm|".lang('admin.cat_xframe')."");
	$opbtn = "<input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' />";
	echo "<td class='tr' colspan='$cspan'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>$opstr</select> $opbtn &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='gform'){

	if(!empty($bsend)){
		$fm['char'] = strtoupper(comConvert::pinyinMain($fm['title'],3,1));
		if($kid=='_isadd_'){
			if($db->table($tabid)->where("model='$mod' AND kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add'); 
				$fm['deep'] = empty($fm['pid']) ? 1 : @$cfg['i'][$pid]['deep']+1;
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd'); 
			unset($fm['kid']);
			$db->table($tabid)->data(basReq::in($fm))->where("model='$mod' AND kid='$kid'")->update();
		} 
		//echo ",$mod,";
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{
		if(empty($kid)){
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,$mod,$pid);
		}else{
			$fm = $db->table($tabid)->where("model='$mod' AND kid='$kid'")->find();
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','frame'=>'0','deep'=>'1','cfgs'=>'',);
		foreach($def as $k=>$v){
			if(!isset($fm[$k])) $fm[$k] = $v;
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=keyExists&mod=$mod&tab=$tabid' tip='".lang('admin.fad_tip41245')."' ";
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		}
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		glbHtml::fmae_row(lang('flow.fl_cfgtab'),"<textarea name='fm[cfgs]' rows='8' cols='50' wrap='off'>$fm[cfgs]</textarea><br>".lang('flow.fl_cfgtip'));
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[model]|$mod","fm[pid]|$pid","kid|".(empty($kid) ? '_isadd_' : $kid)));
	}

}elseif($view=='set'){

	require(dirname(dirname(__FILE__)).'/binc/set_id.php');
	
}

?>



/*******************************************************************************
 File : \code\flow\admin\db_act.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(dirname(__FILE__)).'/apis/_pub_cfgs.php');

$tabinfo = $db->tables(1); 
$tabid = basReq::val("tabid",'base_model'); 

$fixs = lang('admin.dba_sel').':'; $fixa = array('-1'); 
$opts = ""; 
foreach($tabinfo as $r){
	$itab = $r['Name'];
	$fix = substr($itab,0,strpos($itab,'_'));
	$igap = $fix=='exd' ? '<br>' : ' ';
	if(!in_array($fix,$fixa)) $fixs .= "$igap<input type='checkbox' class='rdcb' value='cache' onClick=\"fmSelGroup(this,'$fix');\">$fix"; 
	$fixa[] = $fix;
	$opts .= "$itab|$itab($r[Rows])\n";
}
$sact = "window.location.href='?file=$file&view=$view&tabid='+this.options[selectedIndex].value";
$opts = "<select onchange=\"$sact\">".basElm::setOption($opts,$tabid,lang('admin.dba_stab'))."</select>";
$exp = " &nbsp; <a href='$aurl[1]&view=Export' target='_blank'>".lang('admin.dba_dict')."</a>";
$exp .= " &nbsp; <a href='$aurl[1]&view=Clear' target='_blank'>".lang('admin.dba_clear')."</a>";
$sbar = $view=='list' ? $fixs : "$opts $exp";

// dbdict操作
$syrem = glbDBExt::dbComment(); //print_r($syrem);
if(!empty($bsend)){
	if(empty($fs_do)) $msg = lang('flow.dops_setop');
	if(empty($fs)) $msg = lang('flow.dops_setitem');
	$cnt = 0; $cnu=0; $act = '';
	if(empty($msg)){
	  foreach($fs as $id=>$v){ 
		  if(in_array($fs_do,array('opt','rep'))){ 
			 $tab = $db->table($id,2);
			 $op = $fs_do=='opt' ? 'OPTIMIZE' : 'REPAIR';
			 $db->query("$op TABLE $tab");
			 $cnt++;
		  }elseif($fs_do=='upd'){ 
			 $uptab = basReq::arr('uptab');
			 $uprem = basReq::arr('uprem'); //print_r($uprem);
			 if(!empty($uprem[$id])){
				 if(isset($syrem['fdemo'][$id]) && $uprem[$id]==$syrem['fdemo'][$id]){ 
				 	$db->table('bext_dbdict')->where("kid='$id' AND tabid='$tabid'")->delete(); //array('kid'=>$id,'tabid'=>$tabid)
				 }else{
				 	$uprem[$id] = $irem = trim(basStr::filSafe4($uprem[$id]));
				 	$db->table('bext_dbdict')->data(array('kid'=>$id,'tabid'=>$tabid,'title'=>$irem))->replace();
				 }
				 $cnu++;
			 }
		  }
	  } 
	}
	$cnt && $msg = "$cnt ".lang('admin.dba_tabs').($fs_do=='opt' ? lang('admin.dba_opt') : lang('admin.dba_fix')).lang('admin.dba_ok');
	$cnu && $msg = "$cnu ".lang('admin.dba_dok');
} 

$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
$links = admPFunc::fileNav($view,'dba');
if($view=='runsql'){
	$a1 = "<a href='?file=$file&view=$view&part=data'>data~*</a>";
	$a2 = "<a href='?file=$file&view=$view&part=gbak'>gbak~*</a>";
	$a3 = "<a href='?file=$file&view=$view&part=ins'>ins~*</a>";
	$sbar = "Run-SQL : $a1 # $a2 # $a3";
} 
if(!in_array($view,array('Export','View'))) glbHtml::tab_bar("$links $umsg",$sbar,35,'tc');

if($view=='Clear'){
	
	devScan::clrLogs();

}elseif($view=='runsql'){

	$sqldata = basReq::val("sqldata",'','html'); 
	$list = comFiles::listDir(DIR_DTMP.'/update/','file');
	$list += comFiles::listDir(DIR_DTMP.'/dbexp/','file');
	$part = basReq::val("part"); //dump($part); dump($list); 
	if(!empty($sqldata)){ 
		$res = devData::run1Sql($sqldata);
		$msg = is_numeric($res) ? "($res) Run OK!" : $res;
	}else{
		$msg = 'Use `---&lt;split&gt;---` Split SQL Statement.';
	}
	$istr = "<textarea name='sqldata' cols='' wrap='off' rows='24' style='width:100%'></textarea>";
	if(strpos($part,'.dbsql')>0){
		if(strstr($part,'ins')){
			$arr = include(DIR_DTMP."/update/$part"); 
			$data = implode(devData::$spsql,$arr);
		}else{
			$data = comFiles::get(DIR_DTMP."/dbexp/$part"); 
			$data = str_replace("><",">$data<",$data);
		}
		$istr = str_replace("><",">$data<",$istr);
	}elseif(!empty($part)){ //if($part=='data~'){
		$istr = "<pre>\n";
		foreach ($list as $fp=>$v) {
			if(!strstr($fp,$part)||strpos($fp,'.dbsql')<=0) continue;
			$fp = str_pad($fp,30," ");
			$tm = date('Y-m-d H:i',$v[0]);
			$sz = basStr::showNumber($v[1], 'Byte');
			$sz = str_pad($sz,15," ");
			$istr .= "<a href='?file=$file&view=$view&part=$fp'>$fp</a>-$sz $tm\n";
		}
		$istr .= "</pre>";
	}
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "\n<tr><td class='tc w120'>Run-SQL</td>\n<td>$istr</td></tr>\n";
	$opbar = "<div class='w180 tc right'><input name='btnrun' class='btn' type='submit' value='SQL' /></div>";
	echo "\n<tr><td class='tc'>Run</td>";
	echo "<td colspan='15'>$opbar<div class='pg_bar'>msg: $msg</div></td>\n</tr>";
	glbHtml::fmt_end(array("view|$view","tabid|tabid","fs_do|upd"));

}elseif($view=='list'){
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	$hdex = "<th>Create/Update</th><th>Engine/Collation</th><th>Comment</th></tr>";
	echo "<th>".lang('flow.title_select')."</th><th>Name</th><th>Rows</th><th>Data</th><th>Index</th><th>Free</th><th>AI</th>$hdex\n";
	foreach($tabinfo as $r){ 
		$kid = $r['Name']; $fix = substr($kid,0,strpos($kid,'_'));
		//$data = basStr::showNumber($r['Data_length'],1)."/".basStr::showNumber($r['Index_length'],1)."/".basStr::showNumber($r['Data_free'],1);
		$date = "<span class='block h100'>".$r['Create_time'].'<br>'.$r['Update_time']."<span>";
		echo "<tr>\n".str_replace("'rdcb'","'rdcb cbg_$fix'",$cv->Select($kid)); //cbg_types
		echo "<td class='tc'>$kid</td>\n";
		echo "<td class='tc'>$r[Rows]</td>\n";
		echo "<td class='tc'>".basStr::showNumber($r['Data_length'],'Byte')."</td>\n";
		echo "<td class='tc'>".basStr::showNumber($r['Index_length'],'Byte')."</td>\n";
		echo "<td class='tc'>".basStr::showNumber($r['Data_free'],'Byte')."</td>\n";
		echo "<td class='tc'>$r[Auto_increment]</td>\n";
		echo "<td class='tc'>$date</td>\n";
		echo "<td class='tc'>$r[Engine]/$r[Collation]</td>\n";
		echo "<td class='tc'>$r[Comment]</td>\n";
		echo "</tr>";
	} 
	$op = "".basElm::setOption("opt|".lang('admin.dba_opt')."\nrep|".lang('admin.dba_fix')."",'',lang('flow.op0_bacth'));
	$opbar = "<div class='w180 tc right'><select name='fs_do'>$op</select>";
	$opbar .= "<input name='bsend' class='btn' type='submit' value='".lang('admin.dba_deel')."' /></div>";
	echo "\n<tr><td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>";
	echo "<td colspan='15'>$opbar<div class='pg_bar'>Actions</div></td>\n</tr>";
	glbHtml::fmt_end(array("view|$view"));
	
}elseif($view=='rem'){
	
	$fields = glbDBExt::dbComment($tabid); //print_r($fields);
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Name</th><th>type</th><th>null</th><th>def</th><th>pri/AI</th><th>Comment</th>\n";
		$r = @$fields[0];
		$irem = empty($uprem[0]) ? @$r['_rem'] : $uprem[0];
		$css = @$r['_flag']=='sys' ? 'disc' : '';
		$name = @$r['_flag']=='sys' ? 'disabled' : "name='uprem[0]'";
		echo "<tr>\n".$cv->Select('0');
		echo "<td class='tc bold' colspan='2'>$tabid</td>\n";
		echo "<td class='tc' colspan='3'>(".lang('admin.dba_dbtab').")</td>\n";
		echo "<td class='tc'><input type='text' $name value='$irem' maxlength='24' class='txt w240 $css'/></td>\n";
		echo "</tr>"; unset($fields[0]);
	foreach($fields as $r){ 
		$kid = $r['name'];
		$irem = empty($uprem[$kid]) ? @$r['_rem'] : $uprem[$kid];
		$default = $r['default'];
		$data = $r['primary']."/".$r['autoinc'];
		$css = ($r['_flag']=='sys'||$r['_flag']=='mod') ? 'disc' : ($r['_flag']=='demo' ? 'c00F' : ''); //'d'.$r['_flag']
		$name = ($r['_flag']=='sys'||$r['_flag']=='mod') ? 'disabled' : "name='uprem[$kid]'";
		echo "<tr>\n".$cv->Select($kid);
		echo "<td class='tc'>$kid</td>\n";
		echo "<td class='tc'>$r[type]</td>\n";
		echo "<td class='tc'>".glbHtml::null_cell(!$r['notnull'])."</td>\n";
		echo "<td class='tc'>$default</td>\n";
		echo "<td class='tc'>$data</td>\n";
		echo "<td class='tc'><input type='text' $name value='$irem' maxlength='24' class='txt w240 $css'/></td>\n";
		echo "</tr>";
	} 
	$opbar = "<div class='w180 tc right'><input name='bsend' class='btn' type='submit' value='".lang('admin.dba_upd')."' /></div>";
	echo "\n<tr><td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>";
	echo "<td colspan='15'>$opbar<div class='pg_bar'>".lang('admin.dba_gray')."</div></td>\n</tr>";
	glbHtml::fmt_end(array("view|$view","tabid|$tabid","fs_do|upd"));

}elseif($view=='Export'){ 
	$data = devBase::dbDict($tabinfo);
	//basEnv::obShow($data,0);
	comFiles::put(DIR_DTMP."/store/dbdic-{$_cbase['sys']['lang']}.cac_htm",$data);
	echo "<p class='tc'><br><a href='$aurl[1]&view=View'>".lang('admin.dba_view')."</a><br><br><p>";
}elseif($view=='View'){ 
	basEnv::obClean();
	include(DIR_DTMP."/store/dbdic-{$_cbase['sys']['lang']}.cac_htm");
	die();
}



/*******************************************************************************
 File : \code\flow\admin\ediy.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','(auto)'); 

$_sy_nava['exdiys'] = array(
	'tpls' => '/code/tpls',
	'skin' => '/root/skin',
	'cfgs' => '/code/cfgs',
	'runs' => 'vopfmt',
); 

$part = basReq::val('part','binfo'); 
$dkey = basReq::val('dkey','tpls'); 
$dsub = basReq::val('dsub',''); 

$links = admPFunc::fileNav($part,'envdiy');
if(!in_array($part,array('edit','restore'))) glbHtml::tab_bar(lang('admin.ediy_extool')."[$part]","$links",50); 
$msg = ''; //print_r($msg);

$view = basReq::val('view');
$efile = basReq::val('efile','');

if(in_array($part,array('edit','restore'))){

	$edir = $_sy_nava['exdiys'][$dkey];
	$edir = $edir=='vopfmt' ? '' : (empty($dsub) ? $edir : "$edir/$dsub");
	$nfile = str_replace('//','/',"/$edir/$efile");
	$fp = DIR_PROJ.$nfile;
	
	if($part=='restore'){
		unlink($fp); copy("$fp.maobak",$fp);
		basMsg::show(lang('admin.ediy_rebok'));
	}elseif(!empty($bsend)){
		$ndata = $_POST['ndata']; //basReq::val('ndata','','Html',102400);
		@unlink("$fp.maobak"); copy($fp,"$fp.maobak");
		comFiles::put($fp,$ndata);
		basMsg::show(lang('admin.ediy_editok'));
	}else{
		$ndata = basStr::filForm(comFiles::get($fp)); //str_replace(array('<','>'),array('&lt;','&gt;')
		glbHtml::fmt_head('fmlist',"?file=$file&part=edit&dkey=$dkey&dsub=$dsub&efile=$efile",'tblist');
		echo "\n<tr>\n<th colspan=2>".lang('admin.ediy_doing').": $nfile</th></tr>\n"; 
		echo "\n<tr>\n<td style='width:50%'>".lang('admin.ediy_size').": ".basStr::showNumber(filesize($fp),'Byte')."</td>
		        <td class='tr'>".lang('admin.ediy_etime').": ".date("Y-m-d H:i:s",filemtime($fp))."</td></tr>\n";
		echo "\n<tr>\n<td colspan=2><textarea name='ndata' rows='18' wrap='off' style='width:100%'>$ndata</textarea></td></tr>\n";
		echo "\n<tr>\n<td style='width:50%'>".lang('admin.ediy_sbak').".bak</td><th><input name='bsend' type='submit' value='".lang('admin.ediy_sedit')."' /></th></tr>\n";
		glbHtml::fmt_end(array("nmod|nmod","ntpl|ntpl"));		
	}

}elseif($part!='exdiy'){
	
	glbHtml::fmt_head('fmlist',"?file=$file&part=$part&dkey=$dkey",'tblist');
	echo "\n<tr><td><iframe src='".PATH_ROOT."/tools/adbug/$part.php' width='100%' height='560'></iframe></td></tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}else{
	
	$lnkdk = admPFunc::fileNav($dkey,'exdiys');
	
	if($dkey=='runs'){
		$lnkds = " -- ".lang('admin.ediy_nosdir')." -- ";
		$listu = comFiles::listDir(DIR_PROJ); $listu = $listu['file'];
		$lists = comFiles::listDir(DIR_PROJ."/root/run");  
		$edir = '';
		foreach($lists['file'] as $ifile=>$fv){
			$listu["root/run/$ifile"] = $fv; 
		}
	}elseif($dkey=='cfgs'){
		$lnkds = " -- ".lang('admin.ediy_nosdir')." -- ";
		$edir = $_sy_nava['exdiys'][$dkey];
		$listu = comFiles::listScan(DIR_PROJ.$edir);
	}else{ //tpls,skin
		$edir = $_sy_nava['exdiys'][$dkey];
		$lists = comFiles::listDir(DIR_PROJ.$edir);
		$lnkds = ""; $dsub || $dsub = $_cbase['tpl']['def_static']; 
		foreach($lists['dir'] as $sdir=>$etime){
			if(in_array($sdir,array('a_img','b_img','logo'))) continue;
			$ititle = $sdir==$dsub ? "<span class='cF0F'>$sdir<span>" : $sdir;
			$lnkds .= (empty($lnkds)?'':' # ')."<a href='?file=$file&part=$part&dkey=$dkey&dsub=$sdir'>$ititle</a>";
			$listu = comFiles::listScan(DIR_PROJ.$edir."/$dsub");
		}
		$edir = $edir."/$dsub";
	} 
	glbHtml::tab_bar("$lnkdk",$lnkds,50); 

	//echo $edir; echo "<pre>"; print_r($listu);
	glbHtml::fmt_head('fmlist',"?",'tblist');
	
	echo "<tr><th>".(empty($edir)?'[/]':$edir)."</th><th>".lang('admin.ediy_file')."</th><th>".lang('admin.ediy_size')."</th>"; 
	echo "<th>".lang('admin.ediy_etime')."</th><th>".lang('admin.ediy_atime')."</th><th colspan=2>".lang('admin.ediy_op')."</th></tr>\n"; //<th>创建</th>
	$idir = $odir = '|';
	foreach($listu as $ifile=>$fv){ 
	  $ext = strtolower(strrchr($ifile,".")); 
	  if(!in_array($ext,array('.php','.htm','.html','.css','.js'))) { continue; } //echo "$ifile, "; 
	  $tmp = explode('/',$ifile); $bkfile = $ifile;
	  if(count($tmp)==1){
		  $idir = '[/]';
		  $ifile = $ifile;
	  }elseif(count($tmp)>2){
		  $idir = $tmp[0];
		  $ifile = substr($ifile,strpos($ifile,'/'));
	  }else{
		  $idir = $tmp[0];
		  $ifile = $tmp[1]; 
	  }
	  $ndir = $idir==$odir ? '' : $idir;
	  $odir = $idir;
	  $atime = fileatime(DIR_PROJ.$edir."/$bkfile");
	  $atstr = date("Y-m-d H:i",$atime);
	  $atstr = $atime==$fv[0] ? "<span class='cCCC'>$atstr</span>" : "<span class='cF0F'>$atstr</span>";
	  echo "<td class='tr'>$ndir</td>\n";
	  echo "<td class='tl'>$ifile</td>\n"; 
	  echo "<td class='tr'>".basStr::showNumber($fv[1],'Byte')."</td>\n";
	  echo "<td class='tc'>".date("Y-m-d H:i",$fv[0])."</td>\n"; //$title,$td=1,$url,$twin='',$w=780,$h=560
	  echo "<td class='tc'>$atstr</td>\n";
	  if(file_exists(DIR_PROJ.$edir."/$bkfile.maobak")){
		  echo $cv->Url(lang('admin.ediy_rebak'),'1',"?file=$file&part=restore&dkey=$dkey&dsub=$dsub&efile=$bkfile");
	  }else{
		  echo "<td class='tc cCCC'>".lang('admin.ediy_rebak')."</td>\n";
	  }
	  echo $cv->Url(lang('flow.dops_edit'),'1',"?file=$file&part=edit&dkey=$dkey&dsub=$dsub&efile=$bkfile",lang('admin.ediy_edit').":{$bkfile}");
	  echo "</tr>"; 
	}
	
	glbHtml::fmt_end(array("nmod|nmod","ntpl|ntpl"));
    
} //echo $part;

	/*
    echo "<pre>"; 
    #$res = vopStatic::updKid('news','2015-9g-mvp1','upd'); print_r($res);
    print_r($mods);
	//*/

?>



/*******************************************************************************
 File : \code\flow\admin\fields.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','admin/fields.php'); 

$mod = empty($mod) ? 'docs' : $mod;
$view = empty($view) ? 'list' : $view;
$ispara = basReq::val('ispara','0'); //1,0
$catid = basReq::val('catid','0'); $cawhr = ($catid) ? "AND catid='$catid'" : ""; //echo $cawhr;
$tabid = 'base_fields'; if($ispara) $tabid = 'base_paras'; if($catid) $tabid = 'bext_fields';
$title = lang('flow.title_field'); if($ispara || $catid) $title = lang('admin.fls_paritem');
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod@fields.php'); 

if($view=='ftest'){ 
	
		$lnkbak = "<a href='?file=$file&mod=$mod&view=list&ispara=$ispara&catid=$catid'>&lt;&lt;".lang('flow.fls_backflist')."</a>";
		glbHtml::tab_bar("$lnkbak<span class='span ph5'>|</span>[$gname]".lang('admin.fls_fmres'),'---',40);
	if(empty($bsend)){ 
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		fldView::lists($mod,array('title'=>'(test)'.lang('flow.fls_test').date('H:i:s'),'author'=>',a,b,'),$catid);
		glbHtml::fmae_send('bsend',lang('flow.dops_send'));
		glbHtml::fmt_end();
	}else{
		echo "<pre>";
		print_r($_GET);
		print_r($_POST);
		echo "</pre>";
	}

}elseif($view=='fadd'){
	
	if(empty($bsend)){ 
		echo basJscss::imp('/skin/a_jscss/fields.js');
		$url = $aurl[1]; //basReq::getURep(,'view','form');
		$fmextra_bak = "\n<select id='fmextra_bak' name='fmextra_bak' style='display:none;' >".basElm::setOption(fldCfgs::viewPlugs(),'')."</select>";
		$field_from = "\n<input id='fm[from]' name='fm[from]' type='hidden' value='' />"; 
		$vtip = lang('admin.fad_tip31245'); 
		$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=".($catid ? 'fieldCatid' : 'fieldExists')."&mod=$mod&catid=$catid' tip='$vtip'";
		if($catid) $vstr .= " readonly";
		
		glbHtml::fmt_head('fmlist',$url,'tbdata');
		$picks = $catid ? fldCfgs::addType($mod,$catid) : fldCfgs::addPick($mod);
		echo "<tr><td colspan='2' class='tl h100'>$picks</td></tr>";
		$ftypes = fldCfgs::viewTypes(); if(in_array($_groups[$mod]['pid'],array('coms'))||!empty($catid)){ unset($ftypes['file']); } //互动/评论/参数:不要附件, 
		glbHtml::fmae_row(lang('admin.fls_fieldtype'),"<select id='fm[type]' name='fm[type]' class='w150' reg='str:1-12' tip='".lang('admin.fls_selftype')."' onChange='gf_setfmType(this)'>".basElm::setOption($ftypes,'')."</select>"); 
		glbHtml::fmae_row(lang('admin.fls_fcontrol'),"<select id='fm[fmextra]' name='fm[fmextra]' class='w150'>".basElm::setOption('','')."</select>$fmextra_bak$field_from"); 
		if(in_array($_groups[$mod]['pid'],array('docs'))&&$_groups[$mod]['etab']&&empty($catid)){ //,'types'
			$ops = basElm::setOption("0|".lang('admin.fe_mtab')."\n1|".lang('admin.fe_extab')."",'');
			glbHtml::fmae_row(lang('admin.fls_dbtab'),"<select id='fm[etab]' name='fm[etab]' class='w150' reg='str:1-12' tip='".lang('admin.fls_seldbtab')."'>$ops</select>");
		}else{
			echo "<input name='fm[etab]' type='hidden' value='' />";
		}
		glbHtml::fmae_row(lang('flow.fl_kflag'),"<input id='fm[kid]' name='fm[kid]' type='text' value='' class='txt w150' maxlength='12' reg='key:3-12' $vstr />");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'));
		glbHtml::fmt_end(array("kid|".(empty($kid) ? '_isadd_' : $kid),"mod|$mod")); 
	}else{
		$paras = "";
		foreach(fldCfgs::addParas() as $k){
			$paras .= "&fm[$k]=$fm[$k]";	
		}
		$url = basReq::getURep($aurl[1],'view','form').$paras; 
		die(basMsg::dir($url));
	}

}elseif($view=='form'){
	
	if(!empty($bsend)){ 
		if($kid=='_isadd_'){
			$kid = $fm['kid']; 
			if($db->table($tabid)->where("model='$mod' AND kid='$fm[kid]' $cawhr")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$fm['model'] = $mod; if($catid) $fm['catid'] = $catid;
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$msg = lang('flow.msg_add'); 
			}
		}else{
			$msg = lang('flow.msg_upd');unset($fm['kid']); 
			if(@$fm_null=='nul') $fm['vreg'] = 'nul:'.$fm['vreg']; 
			$db->table($tabid)->data(basReq::in($fm))->where("model='$mod' AND kid='$kid' $cawhr")->update();
		} 
		if(empty($ispara) && empty($catid)){ 
			if(!empty($fm['dbtype']) && $fm['dbtype']!='nodb') glbDBExt::setOneField($mod,$kid,'check');
		} 
		glbCUpd::upd_model($mod);
		echo basJscss::Alert($msg);	
		
	}else{
		
		echo basJscss::imp('/skin/a_jscss/fields.js'); 
		$fm = fldEdit::fmOrgData($tabid,$mod,$kid,$fm,$catid);
		
		$fedit = new fldEdit($mod,$fm);
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		$fedit->fmTypeOpts();
		$fedit->fmPlusPara();
		$fedit->fmParaKeys();
		$fedit->fmKeyName();
		$fedit->fmDbOpts();
		$fedit->fmRegOpts();
		$fedit->fmViewOpts();
		$fedit->fmRemCfgs();
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send')); 
		glbHtml::fmt_end(array("kid|".(empty($kid) ? '_isadd_' : $kid),"mod|$mod"));

	}

}elseif($view=='list'){
	
	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("model='$mod' AND kid='$id' $cawhr")->update(); 
				}elseif($fs_do=='del'){ 
					 if(!empty($ispara)){
						 $db->table($tabid)->where("issys='0' AND model='$mod' AND kid='$id' $cawhr")->delete(); 
					 }elseif(!empty($catid)){
						 $db->table($tabid)->where("model='$mod' AND kid='$id' $cawhr")->delete(); 
					 }else{
						 $tmp = array('title','company');
						 if(isset($tmp[$id])){
							 $msg = lang('admin.fls_sysfield');
						 }else{
							 if(empty($ispara)&&empty($catid)) glbDBExt::setOneField($mod,$id); //if($fm['dbtype']!='nodb') 
							 $msg = lang('flow.msg_del');
						 }
					 }
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("model='$mod' AND kid='$id' $cawhr")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("model='$mod' AND kid='$id' $cawhr")->update(); 
				}
			}
		}
		glbCUpd::upd_model($mod);
	} 	

	$lnkbak = "<a href='?file=admin/groups&mod=".$_groups[$mod]['pid']."'>&lt;&lt;".lang('admin.fls_backmod')."</a>"; //&view=list&ispara=$ispara
	$lnkcat = "<a href='?file=admin/catalog&mod=$mod'>&lt;&lt;".lang('admin.fls_backcat')."</a>";
	$lnkgrd = "<a href='?file=admin/grade&mod=$mod'>&lt;&lt;".lang('admin.fls_backgrade')."</a>";
	$lnkbak = $catid ? ($_groups[$mod]['pid']=='users'? $lnkgrd : $lnkcat) : $lnkbak;
	
	$lnkadd = "<a href='?file=$file&mod=$mod&view=fadd&ispara=$ispara&catid=$catid' onclick='return winOpen(this,\"".lang('admin.fls_addfield')."\")'>".lang('admin.fls_add')." $title&gt;&gt;</a>"; 
	$lnkform = " | <a href='?file=$file&mod=$mod&view=ftest&ispara=$ispara&catid=$catid'>".lang('admin.fls_fmres')."&gt;&gt;</a>";
	glbHtml::tab_bar("$lnkbak<span class='span ph5'>|</span>[$gname]{$title} ".lang('admin.fls_list')."<span class='span ph5'>|</span>$lnkadd",$lnkform,40);
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th>";
	if(empty($ispara)&&empty($catid)) echo "<th>".lang('flow.title_enable')."</th><th>".lang('admin.fls_extab')."</th>";
	echo "<th>".lang('admin.fls_type')."</th><th>".(empty($ispara) ? lang('admin.fls_db') : lang('admin.fls_nowval'))."</th><th title='".lang('admin.fls_maxlen')."'>".lang('admin.fls_lettes')."</th>";	
	echo "<th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";	
	if(!empty($catid)){
		$_dbmfields = $db->fields(glbDBExt::getTable($mod)); //print_r($_dbmfields);
	}
	$list = $db->table($tabid)->where("model='$mod' $cawhr")->order('enable DESC,top')->select();
	if($list){
	foreach($list as $r){
	  $kid = $r['kid'];
	  $note = basReq::out($r['vreg']).' | '.basReq::out($r['vtip']);
	  $note = $note==' | ' ? '' : $note;
	  $types = fldCfgs::viewTypes();
	  $plugs = fldCfgs::viewPlugs(); $plugstr = isset($plugs[$r['fmextra']]) ? ' ('.$plugs[$r['fmextra']].')' : '';
	  if($ispara){
		  $dbstr = "<input type='text' value='".basStr::filForm($r['val'])."' class='txt w80 disc' disabled='disabled' />";
	  }else{ //basStr::cutWidth($r['dbdef'],3,'..')
		  $dbstr = "$r[dbtype] ".(empty($r['dblen'])?'':"($r[dblen])").(strlen($r['dbdef'])?' ['.$r['dbdef'].']':'');
	  }
	  if(!empty($catid)){
	  	  $exstr = (!empty($catid) && isset($_dbmfields[$kid])) ? '' : "<span class='cF00'>".lang('admin.fls_nofield')."</span>"; 
	  }else{
		  $exstr = '';
	  }
	  echo "<tr>\n";
	  echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /> ".(empty($ispara) ? '' : $r['key'])."$exstr</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  if(empty($ispara)&&empty($catid)) echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  if(empty($ispara)&&empty($catid)) echo "<td class='tc'>".($r['dbtype']=='nodb' ? '---' : glbHtml::null_cell($r['etab']))."</td>\n";
	  echo "<td class='tl'>".$types[$r['type']]." $plugstr</td>\n";
	  echo "<td class='tc'>$dbstr</td>\n";
	  echo "<td class='tr'>".glbHtml::null_cell($r['vmax'],'')." | ".glbHtml::null_cell($r['dblen'],'')."</td>\n";
	  echo "<td class='tc'><a href='?file=$file&mod=$mod&view=form&kid=$r[kid]&ispara=$ispara&catid=$catid' onclick='return winOpen(this,\"".lang('flow.title_edit')." $title\")'>".lang('flow.title_edit')."</a></td>\n";
	  echo "<td class='tl'><input type='text' value='$note' class='txt w150 disc' disabled='disabled' /></td>\n";
	  echo "</tr>"; 
	}} 
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}

?>



/*******************************************************************************
 File : \code\flow\admin\grade.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','admin/grade.php');

$mod = empty($mod) ? 'adminer' : $mod;
$view = empty($view) ? 'glist' : $view;
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod@grade.php'); 
$gbar = admAFunc::grpNav('users',$mod); 
$cfg = glbConfig::read($mod); 
$tabid = "base_grade";
//print_r(comTypes::getSubs($cfg['i'],'hn','3'));

if($view=='glist'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update(); 
				}elseif($fs_do=='del'){ 
					//if($db->table($tabid)->where("pid='$id'")->find()){
						//$msg = "{$id}该条目含有子类，请先删除子类！";
					//}else{
						 	
					//}
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		glbCUpd::upd_model($mod);
	} 
 	
	$lnkadd = "<a href='$aurl[1]&view=gform' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	glbHtml::tab_bar(lang('admin.grd_gperm')." :: $gname<span class='span ph5'>|</span>$lnkadd",$gbar,35);
	
	$_ex_paras = glbConfig::read('paras','ex');
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	echo "<th>".lang('flow.title_perm')."</th><th>".lang('flow.title_edit')."</th>";
	if(in_array($mod,$_ex_paras['grade'])) echo "<th>".lang('flow.title_param')."</th>";
	echo "<th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	$list = $db->table($tabid)->where("model='$mod'")->order('top,kid')->select();
	if($list){
	foreach($list as $r){
	  $kid = $r['kid'];
	  echo "<tr>\n";
	  echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";  
	  echo "<td class='tc'>".($kid=='supper' ? lang('admin.grd_set') : "<a href='$aurl[1]&view=set&kid=$r[kid]'>".lang('flow.title_set')."</a>")."</td>\n";
	  echo "<td class='tc'><a href='$aurl[1]&view=gform&kid=$r[kid]' onclick='return winOpen(this,\"".lang('admin.grd_edit')."-$r[title]\");'>".lang('flow.title_edit')."</a></td>\n";
	  if(in_array($mod,$_ex_paras['grade'])) echo "<td class='tc'>".("<a href='?file=admin/fields&mod=$mod&catid=$r[kid]'>".lang('flow.title_set')."</a>")."</td>\n";
	  echo "<td class='tl'><input name='fm[$kid][note]' type='text' value='$r[note]' class='txt w120' /></td>\n";
	  echo "</tr>"; 
	}} 
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='gform'){

	if(!empty($bsend)){
		if($kid=='_isadd_'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{
		if(empty($kid)){
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,$mod,@$pid);
		}else{
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','cfgs'=>'',);
		foreach($def as $k=>$v){
			if(!isset($fm[$k])) $fm[$k] = $v;
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=keyExists&mod=&tab=$tabid' tip='".lang('admin.fad_tip41245')."' ";
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		}
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		glbHtml::fmae_row(lang('flow.fl_cfgtab'),"<textarea name='fm[cfgs]' rows='8' cols='50' wrap='off'>$fm[cfgs]</textarea><br>".lang('flow.fl_cfgtip'));
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[model]|$mod","kid|".(empty($kid) ? '_isadd_' : $kid)));
	}

}elseif($view=='set'){

	$parts = basReq::val('parts','pmod'); 
	if(!empty($bsend)){
		$v = empty($fm['prmcb']) ? '' : implode(',',array_filter($fm['prmcb']));
		$db->table($tabid)->data(basReq::in(array($parts=>$v)))->where("kid='$kid'")->update();
		echo basJscss::Alert(lang('flow.msg_upd'),'Redir',$aurl[1]);
	}else{
		$row = $db->table($tabid)->where("kid='$kid'")->find(); 
		$title = $row['title']; //company,govern,apimail
		$lnkbak = "<a href='?file=$file&mod=$mod'>&lt;&lt;".lang('admin.grd_back')."[$gname]".lang('admin.grd_glist')."</a>";
		$lpart1 = " | "; $lpart2 = " | ";
		$pcfg1 = array('pmod'=>lang('admin.grd_mod'),'padd'=>lang('flow.dops_add'),'pdel'=>lang('flow.dops_del'),'pcheck'=>lang('flow.dops_checked'));
		foreach($pcfg1 as $k=>$v) { $lpart1 .= "<a href='?file=$file&mod=$mod&view=set&kid=$kid&parts=$k' ".(($parts==$k) ? 'class="cur"' : '').">$v</a> | "; }
		$pcfg2 = basLang::ucfg('cfglibs.grset_types');  
		foreach($pcfg2 as $k=>$v) { $lpart2 .= "<a href='?file=$file&mod=$mod&view=set&kid=$kid&parts=$k' ".(($parts==$k) ? 'class="cur"' : '').">$v</a> | "; }
		glbHtml::tab_bar("$lnkbak<span class='span ph5'>|</span>[$title]".lang('admin.grd_pedit')."","$lpart1<br>$lpart2",40); //-
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		$pmstr = $row[$parts];  
		if(in_array($parts,array('pmod','padd','pdel','pcheck'))){
			$a0 = array('docs','coms','users','advs','plus');
			foreach($a0 as $k){
				$a2 = array();
				foreach($_groups as $k2=>$v2){
					if($v2['pid']==$k) $a2[$k2] = $v2['title']."($k2)";
				}
				glbHtml::fmae_row($_groups[$k]['title'],basElm::setCBox("prmcb",$a2,$pmstr,5));
			}
		}elseif(in_array($parts,array('pmadm'))){
			$_muadm = glbConfig::read('muadm'); 
			$a0 = $_muadm['i']; $a2 = array();
			foreach($a0 as $k2=>$v2){
				if($v2['pid']=='0') $a2[$k2] = $v2['title'];
			}
			glbHtml::fmae_row(lang('admin.grd_tmenu'),basElm::setCBox("prmcb",$a2,$pmstr));
			$i = 0;
			foreach($a0 as $k2=>$v2){ 
			if($v2['deep']=='2'){ $i++; 
				$def = strstr(",$pmstr,",",$k2,") ? " checked='checked' " : '';
				$s2 = "\n<label>".$a0[$v2['pid']]['title']." - <input type='checkbox' class='rdcb' name='fm[prmcb][]' id='fm_prmcb_$i' value='$k2' $def>$v2[title]($k2)</label>";
				$s3 = ''; $j = 0;
				foreach($a0 as $k3=>$v3){ 
				if($v3['pid']==$k2){ $i++; $j++;  
					$def = strstr(",$pmstr,",",$k3,") ? " checked='checked' " : '';
					if($j>4) { $s3 .= "<br>"; $j=1; }
					$s3 .= "\n<label><input type='checkbox' class='rdcb' name='fm[prmcb][]' id='fm_prmcb_$i' value='$k3' $def>$v3[title]($k3)</label>";
				}}
				glbHtml::fmae_row($s2,$s3);
			}}
		}elseif(in_array($parts,array('pmusr'))){
			$_mumem = glbConfig::read('mumem'); 
			$a0 = $_mumem['i']; $i = 0;
			foreach($a0 as $k2=>$v2){ 
			if($v2['deep']=='1'){ $i++; 
				$def = strstr(",$pmstr,",",$k2,") ? " checked='checked' " : '';
				$s2 = "\n<label><input type='checkbox' class='rdcb' name='fm[prmcb][]' id='fm_prmcb_$i' value='$k2' $def>$v2[title]($k2)</label>";
				$s3 = ''; $j = 0;
				foreach($a0 as $k3=>$v3){ 
				if($v3['pid']==$k2){ $i++; $j++;  
					$def = strstr(",$pmstr,",",$k3,") ? " checked='checked' " : '';
					if($j>4) { $s3 .= "<br>"; $j=1; }
					$s3 .= "\n<label><input type='checkbox' class='rdcb' name='fm[prmcb][]' id='fm_prmcb_$i' value='$k3' $def>$v3[title]($k3)</label>";
				}}
				glbHtml::fmae_row($s2,$s3);
			}}
		}elseif(in_array($parts,array('pfile','pextra'))){
			$_key = $parts=='pfile' ? '_mupfile' : '_mupext';
			$_kmd = glbConfig::read(str_replace('_','',$_key)); 
			$a0 = $_kmd['i']; $i = 0;
			foreach($a0 as $k2=>$v2){ 
				$s3 = ''; $i++; $j = 0;
				$a3 = basElm::text2arr($v2['cfgs']); 
				foreach($a3 as $k3=>$v3){ $i++; $j++;  
					$def = strstr(",$pmstr,",",$k3,") ? " checked='checked' " : '';
					if($j>3) { $s3 .= "<br>"; $j=1; }
					$s3 .= "\n<label><input type='checkbox' class='rdcb' name='fm[prmcb][]' id='fm_prmcb_$i' value='$k3' $def>$v3($k3)</label>";
				}
				glbHtml::fmae_row("$v2[title]",$s3);
			}
		}
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),in_array($parts,array('pmadm','pmusr')) ? ($parts=='pmusr' ? '20' : 25) : 15);
		glbHtml::fmt_end(array("mod|$mod","fm[model]|$mod","","kid|".(empty($kid) ? '_isadd_' : $kid)));
	}
}

?>



/*******************************************************************************
 File : \code\flow\admin\groups.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','admin/groups.php');

$mod = empty($mod) ? 'groups' : $mod;
$view = empty($view) ? 'glist' : $view;
$tabid = 'base_model';
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod@groups.php'); 
$gbar = admAFunc::grpNav('groups',$mod);
$advetabs = basLang::ucfg('cfglibs.advs_type'); 

if($view=='glist'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update(); 
				}elseif($fs_do=='del'){ 
					 $msg = admAFunc::modCopy($mod, $tabid, 'is_del', $id);
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
				if($mod!='groups' && $fs_do!='del') glbCUpd::upd_model($id);
			}
		}
		glbCUpd::upd_groups(); 
		if($fs_do!='del' && in_array($mod,array('score','sadm','smem','suser',))){ 
			glbCUpd::upd_paras($mod);
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	} 

	$list = $db->table($tabid)->where("pid='$mod'")->order('top')->select(); 
	
	$lnkadd = "<a href='$aurl[1]&view=gform' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	glbHtml::tab_bar("[{$gname}]".lang('admin.fad_adset')."<span class='span ph5'>|</span>$lnkadd",$gbar,30);
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name').(in_array($mod,array('docs','coms','users')) ? '/'.lang('admin.fad_rmod') : '')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	$fhd3 = "<th>".lang('flow.title_fields')."</th><th>".lang('flow.title_set')."</th><th>".lang('flow.title_copy')."</th>";
	if($mod=='docs'){ 
		echo "<th>".lang('flow.title_cata')."</th>";
		echo $fhd3;
	}elseif($mod=='coms'){ 
		echo $fhd3;
	}elseif($mod=='users'){
		echo "<th>".lang('flow.title_grade')."</th>";
		echo $fhd3;
	}elseif($mod=='advs'){
		echo "<th>".lang('flow.title_cata')."</th>";
		echo "<th>".lang('flow.title_mode')."</th>";
		echo "<th>-".lang('flow.title_bei')."-</th>";
	}elseif($mod=='types'){ 
		echo "<th>".lang('flow.title_admin')."</th>";
		echo "<th>-".lang('flow.title_bei')."-</th>";
	}elseif($mod=='menus'){ 
		echo "<th>".lang('flow.title_admin')."</th>";
		echo "<th>-".lang('flow.title_bei')."-</th>";
	}elseif(in_array($mod,array('score','sadm','smem','suser'))){ 
		echo "<th>".lang('flow.title_admin')."</th>";
		echo "<th>".lang('flow.title_parset')."</th>";
	}elseif($mod=='plus'){
		echo "<th>-".lang('flow.title_bei')."-</th>";
	}else{ 
		echo "<th>-".lang('flow.title_bei')."-</th>";
		echo "<th>-".lang('flow.title_bei')."-</th>";
	}
	echo "<th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n"; 
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; $pstr = ''; 
	  if(!empty($_groups[$kid]['pid']) && in_array($mod,array('types'))){
	      $rmcfg = glbConfig::read($kid);
	  }
	  if($r['pmod'] && in_array($mod,array('docs','coms','users'))){
		  $pname = @$_groups[$r['pmod']]['title'];
		  $pstr = "/$pname($r[pmod])\n";
	  }
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' />$pstr</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  $ftd3 = $cv->Url(lang('flow.title_fields'),1,"?file=admin/fields&mod=$r[kid]")."<td class='tc'>".lang('flow.title_set')."</td>\n";
	  $ftd3 .= $cv->Url(lang('flow.title_copy'),1,"$aurl[1]&view=gform&cid=$r[kid]",lang('admin.grp_copyitem')." - $r[title]");
	  if($mod=='docs'){ 
		  echo $cv->Url(lang('flow.title_cata').'&gt;&gt;',1,"?file=admin/catalog&mod=$r[kid]",'frame');
		  echo $ftd3;
	  }elseif($mod=='coms'){ 
		  echo $ftd3;
	  }elseif($mod=='users'){
		  echo $cv->Url(lang('flow.title_grade').'&gt;&gt;',1,"?file=admin/grade&mod=$r[kid]&frame=1",'frame');
		  echo $ftd3;
	  }elseif($mod=='advs'){
		  echo $cv->Url(lang('flow.title_cata').'&gt;&gt;',1,"?file=admin/catalog&mod=$r[kid]",'frame');
		  echo "<td class='tc'>".$advetabs[$r['etab']]."</td>\n";
		  echo "<td class='tc'>-".lang('flow.title_bei')."-</td>\n";  
	  }elseif($mod=='types'){ 
		  if(strstr(@$rmcfg['cfgs'],'exdoc=1') && @$rmcfg['etab']){
			  echo $cv->Url(lang('flow.title_fields'),1,"?file=admin/fields&mod=$r[kid]");  
		  }else{
		      echo "<td class='tc'>".lang('flow.title_fields')."</td>\n"; 
		  }
		  echo $cv->Url(lang('flow.title_admin'),1,"?file=admin/types&mod=$r[kid]",'frame');
	  }elseif($mod=='menus'){ 
		  echo $cv->Url(lang('flow.title_admin'),1,"?file=admin/menus&mod=$r[kid]",'frame');
		  echo "<td class='tc'>-".lang('flow.title_bei')."-</td>\n"; 
	  }elseif(in_array($mod,array('score','sadm','smem','suser'))){ 
		  echo $cv->Url(lang('admin.fls_paritem'),1,"?file=admin/fields&mod=$r[kid]&ispara=1");
		  echo $cv->Url(lang('flow.title_parset'),1,"?file=admin/paras&mod=$r[kid]");
	  }elseif($mod=='plus'){
		  echo "<td class='tc'>-".lang('flow.title_bei')."-</td>\n";  
	  }else{ 
		  echo "<td class='tc'>-".lang('flow.title_bei')."-</td>\n";
		  echo "<td class='tc'>-".lang('flow.title_bei')."-</td>\n";  
	  }
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=gform&kid=$r[kid]&recbk=ref","");
	  echo "<td class='tl'><input name='fm[$kid][note]' type='text' value='$r[note]' class='txt w120' /></td>\n";
	  echo "</tr>"; 
	}} 
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='18'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='gform'){

	if(!empty($bsend)){
		if($kid=='is__add'){
			$msg = admAFunc::modCopy($mod, $tabid, $fm, $cid);
			$kid = $fm['kid'];
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']);
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		glbCUpd::upd_groups();
		if(in_array($mod,array('docs','coms','users'))){
			if(isset($_groups[$kid])){
				admAFunc::pmodSave($kid,@$fm['pmod']);
			}
		}
		if(in_array($mod,array('docs','users','types','coms','advs'))){
			glbCUpd::upd_model($kid); 
		}
		basMsg::show($msg);	//,'Redir'?file=$file&mod=$mod
	}else{

		if(!empty($cid)){ //copy
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,$mod,@$pid);
			$fm = $db->table($tabid)->where("kid='$cid'")->find();
			$fm['title'] .= "_".lang('flow.title_copy');
			$fm['pmod'] = '';
		}elseif(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,$mod,@$pid);
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','etab'=>'1','deep'=>'1','cfgs'=>'','pmod'=>'','crdel'=>'0','cradd'=>'0',);
		if($mod=='types'){ 
			$def['etab'] = 0; 
		} 
		foreach($def as $k=>$v){
			if(!isset($fm[$k])) $fm[$k] = $v;
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=modExists' tip='".lang('admin.fad_tip31245')."'";
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:3-12' $vstr />$ienable");
		}
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		if($mod=='advs'){ //'advs'=>'栏目级数',
			$ietab = " &nbsp; ".lang('admin.grp_dmode')."<select id='fm[etab]' name='fm[etab]' type='text' xxx=''>";
			$ietab .= basElm::setOption($advetabs,$fm['etab'])."</select>"; 
			glbHtml::fmae_row(lang('admin.grp_catlevel'),"<input name='fm[deep]' type='text' value='$fm[deep]' class='txt w80' maxlength='1' reg='n+i' tip='".lang('admin.fad_num')."' />(".lang('admin.grp_max').")$ietab");
			
		}elseif(in_array($mod,array('docs','types','menus'))){
			$_cfg = basLang::ucfg('cfglibs.model_deep'); 
			$ctitle = $_cfg[$mod];
			$ietab = " &nbsp; ".lang('admin.grp_extab');
			if(empty($kid)){
				$ietab .= " <input name='fm[etab]' type='hidden' value='0' /><input name='fm[etab]' type='checkbox' class='rdcb' value='1' ".($fm['etab']=='1' ? 'checked' : '')." />";
			}else{
				$ietab .= " <input name='fm_etab' type='checkbox' disabled='disabled' class='rdcb' value='1' ".($fm['etab']=='1' ? 'checked' : '')." />";
			}
			glbHtml::fmae_row($ctitle,"<input name='fm[deep]' type='text' value='$fm[deep]' class='txt w80' maxlength='1' reg='n+i' tip='".lang('admin.fad_num')."' />(".lang('admin.grp_max').")$ietab");
		}
		glbHtml::fmae_row(lang('flow.fl_cfgtab'),"<textarea name='fm[cfgs]' rows='8' cols='50' wrap='off'>$fm[cfgs]</textarea><br>".lang('flow.fl_cfgtip'));
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		
		if(in_array($mod,array('docs','coms','users'))){
			if($mod=='coms'){
				$arr = admPFunc::modList(array('docs','users','coms',),'relmod'); 
				$pmstr = basElm::setOption($arr,$fm['pmod']);
				$oldPid = "<input name='oldPid' type='hidden' value='{$fm['pmod']}' />";
				glbHtml::fmae_row(lang('admin.fad_rmod'),"<select name='fm[pmod]'>$pmstr</select><br>".lang('admin.grp_rmod')."");
			}
			$jifen = " &nbsp; ".lang('admin.grp_pdel')."<input name='fm[crdel]' type='text' value='$fm[crdel]' class='txt w80' maxlength='3' reg='n+i' tip='".lang('admin.fad_num')."' />";
			glbHtml::fmae_row(lang('admin.grp_pset'),lang('admin.grp_padd')."<input name='fm[cradd]' type='text' value='$fm[cradd]' class='txt w80' maxlength='3' reg='n+i' tip='".lang('admin.fad_num')."' />$jifen");
		}
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[pid]|$mod","kid|".(empty($kid) ? 'is__add' : $kid),"cid|$cid"));
	}
	
}elseif($view=='sets'){
	//	
}

?>



/*******************************************************************************
 File : \code\flow\admin\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\flow\admin\menus.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','admin/menus.php');

$mod = empty($mod) ? 'muadm' : $mod;
$view = empty($view) ? 'glist' : $view;
$pid = empty($pid) ? '0' : $pid;
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod@menus.php'); 
$gbar = admAFunc::grpNav('menus',$mod); 
$cfg = glbConfig::read($mod); 
$tabid = 'base_menu';

if($mod=='mumem' && $view=='glist'){
	
	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("model='$mod' AND kid='$id'")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("model='$mod' AND kid='$id'")->update(); 
				}
			}
		}
		glbCUpd::upd_model($mod);
	} 

	$lnkupd = "<a href='$aurl[1]&view=upd' onclick='return winOpen(this,\"".lang('admin.mu_addone')."-[$gname]\",300,200);'>".lang('admin.mu_upd')."</a>";
	$lnklay = admAFunc::typLay($cfg,$aurl,$pid);
	$lnkadd = "<a href='$aurl[1]&view=umcinit&pid=$pid' onclick='return winOpen(this,\"".lang('admin.mu_init')."-[$gname]\");'>".lang('admin.mu_init')."</a>";
	glbHtml::tab_bar(lang('admin.mu_navmenu')." :: $gname<span class='span ph5'>|</span>$lnkupd - $lnkadd<br>$lnklay",$gbar,35);
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	echo "<th>".lang('flow.title_level')."</th><th>".lang('flow.title_note')."</th>";
	echo "<th>".lang('flow.title_perm')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	$pcfg = array('1'=>lang('admin.mu_setpm'),'.guest'=>lang('admin.mu_guestpm'),); // '0'=>'登录权限',
	$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('top,kid')->select();
	if($list){
	foreach($list as $r){
		$kid = $r['kid'];
		$u_sub = strstr($aurl[1],'pid=') ? basReq::getURep($aurl[1],'pid',$r['kid']) : "$aurl[1]&pid=$r[kid]";
		$f_deep = @$cfg['i'][$pid]['deep'] < $cfg['deep']-1;
		$s_cnt = count(comTypes::getSubs($cfg['i'],$r['kid']));
		echo "<tr>\n";
		echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
		echo "<td class='tc'>$r[kid]</td>\n";
		echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
		echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
		echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
		echo "<td class='tc'>$r[deep]</td>\n"; 
		echo "<td class='tc'>".($f_deep ? "<a href='$u_sub'>$s_cnt</a>" : glbHtml::null_cell($s_cnt))."</td>\n";
		$popt = "<select name='fm[$kid][cfgs]'>".basElm::setOption($pcfg,$r['cfgs'],lang('admin.mu_loginpm'))."</select>";
		echo "<td class='tc'>$popt</td>\n";
		echo "<td class='tl'><input type='text' value='$r[note]' class='txt w120' /></td>\n";
		echo "</tr>"; 
	}} 
	$ops = basElm::setOption("upd|".lang('flow.op_upd')."\nshow|".lang('flow.op_open')."\nstop|".lang('flow.op_close')."");
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>$ops</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='umcinit'){
	
	admAFunc::umcVInit();
	basMsg::show(lang('admin.mu_initend'),'Redir',"?file=$file&mod=$mod&pid=$pid");

}elseif($view=='glist'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){ 
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='del'){ 
					if($db->table($tabid)->where("model='$mod' AND pid='$id'")->find()){
						$msg = lang('admin.mu_delfirst');
					}else{
						$db->table($tabid)->where("model='$mod' AND kid='$id'")->delete(); 
						$msg = lang('flow.msg_del');
					}
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("model='$mod' AND kid='$id'")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("model='$mod' AND kid='$id'")->update(); 
				}
			}
		}
		glbCUpd::upd_model($mod);
	} 

	$lnkupd = "<a href='$aurl[1]&view=upd' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\",300,200);'>".lang('admin.mu_upd')."</a>";
	$lnklay = admAFunc::typLay($cfg,$aurl,$pid);
	$lnkadd = "<a href='$aurl[1]&view=gform&pid=$pid' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('admin.mu_add')."&gt;&gt;</a>";
	glbHtml::tab_bar(lang('admin.mu_navmenu')." :: $gname<span class='span ph5'>|</span>$lnkupd - $lnkadd<br>$lnklay",$gbar,35);
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	echo "<th>".lang('flow.title_level')."</th><th>".lang('flow.title_note')."</th>";
	echo "<th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('top,kid')->select();
	if($list){
	foreach($list as $r){
		$kid = $r['kid'];
		$u_sub = strstr($aurl[1],'pid=') ? basReq::getURep($aurl[1],'pid',$r['kid']) : "$aurl[1]&pid=$r[kid]";
		$f_deep = @$cfg['i'][$pid]['deep'] < $cfg['deep']-1;
		$s_cnt = count(comTypes::getSubs($cfg['i'],$r['kid']));
		echo "<tr>\n";
		echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
		echo "<td class='tc'><a href='$aurl[1]&view=set&kid=$r[kid]' onclick='return winOpen(this,\"".lang('admin.fad_setid',$r['title'])."\");'>$r[kid]</a></td>\n";
		echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
		echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
		echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
		echo "<td class='tc'>$r[deep]</td>\n"; 
		echo "<td class='tc'>".($f_deep ? "<a href='$u_sub'>$s_cnt</a>" : glbHtml::null_cell($s_cnt))."</td>\n";   
		echo "<td class='tc'><a href='$aurl[1]&view=gform&kid=$r[kid]' onclick='return winOpen(this,\"".lang('admin.mu_editone')."-$r[title]\");'>".lang('flow.title_edit')."</a></td>\n";
		echo "<td class='tl'><input name='fm[$kid][note]' type='text' value='$r[note]' class='txt w120' /></td>\n";
		echo "</tr>"; 
	}} 
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='gform'){

	if(!empty($bsend)){
		if($kid=='_isadd_'){
			if($db->table($tabid)->where("model='$mod' AND kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$fm['deep'] = empty($fm['pid']) ? 1 : @$cfg['i'][$pid]['deep']+1;
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']);
			$db->table($tabid)->data(basReq::in($fm))->where("model='$mod' AND kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{
		if(empty($kid)){
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,$mod,$pid);
		}else{
			$fm = $db->table($tabid)->where("model='$mod' AND kid='$kid'")->find();
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','deep'=>'1','cfgs'=>'',);
		foreach($def as $k=>$v){
			if(!isset($fm[$k])) $fm[$k] = $v;
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=keyExists&mod=0&tab=$tabid' tip='".lang('admin.fad_tip21245')."'";
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:2-12' $vstr />$ienable");
		}
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21245')."' />$itop");
		glbHtml::fmae_row(lang('flow.fl_cfgtab'),"<textarea name='fm[cfgs]' rows='8' cols='50' wrap='off'>$fm[cfgs]</textarea>
		<br>".lang('admin.mu_fmta')."
		<br>1. ?file=admin/groups, ".lang('admin.mu_flagroot','{$root}')."
		<br>2. ".lang('admin.mu_tiptitle')."(!)link(!)frame|blank|jsadd, ".lang('admin.mu_tipline')."
		<br>3. &lt;a href=&quot;?file=admin/types&quot;&gt;".lang('admin.mu_typa')."&lt;/a&gt; - &lt;a href=&quot;#&quot; target=&quot;_blank&quot;&gt;".lang('admin.set')."&lt;/a&gt;；");
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[model]|$mod","fm[pid]|$pid","kid|".(empty($kid) ? '_isadd_' : $kid)));
	}

}elseif($view=='upd'){
	
	glbCUpd::upd_menus($mod,$cfg); 
	echo "\n<hr>".lang('admin.mu_end')."<br>";

}elseif($view=='set'){
	
	require(dirname(dirname(__FILE__)).'/binc/set_id.php');

}

?>




/*******************************************************************************
 File : \code\flow\admin\paras.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
usrPerm::run('pfile','admin/paras.php');

$mod = empty($mod) ? 'prcore' : $mod;
//$ispara = 1; //1,0
$tabid = 'base_paras';
$title = lang('admin.pr_item');
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod@paras.php'); 
$gpid = $_groups[$mod]['pid'];

$aval = glbCUpd::upd_paras($gpid, '');
//print_r($aval);

if($view=='upd'){
	
	glbCUpd::upd_paras($gpid);
	echo "\n<hr>".lang('admin.pr_updend')."<hr>".basDebug::runInfo();

}elseif(!empty($bsend)){

	foreach($fm as $k=>$v){
		$db->table($tabid)->data(array('val'=>$v))->where("kid='$k'")->update(); 
		//echo "<br>".$db->sql;
	}
	glbCUpd::upd_paras($gpid);
	echo basJscss::Alert(lang('admin.pr_editend'),'Redir',"$aurl[1]");
	
}else{

	$gbar = admAFunc::grpNav($gpid,$mod); 
	$lnkbak = "<a href='?file=admin/groups&mod=$gpid'>&lt;&lt;[".lang('admin.pr_backmod')."]</a>";
	$lnkadd = "<a href='$aurl[1]&view=upd' onclick='return winOpen(this,\"".lang('admin.pr_updpara')."\",300,200);'>[".lang('admin.pr_updpara')."]&gt;&gt;</a>";
	glbHtml::tab_bar("$lnkbak<span class='span ph5'>|</span>[{$gname}]".lang('admin.pr_set')."<span class='span ph5'>|</span>$lnkadd",$gbar,40);

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	fldView::lists($mod,$aval);
	glbHtml::fmae_send('bsend',lang('flow.dops_send'));
	if($mod=='prsafe'){
		echo "<tr><th>".lang('admin.pr_rnd1')."</th><th class='tr'>---</th></tr>\n";
		echo "<tr><td class='tc'>['safe']['site']</td> <td class='f16 ffvs'>name"; for($i=0;$i<5;$i++) echo '-'.basKeyid::kidRand('f',5); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['pass']</td> <td class='f16 ffvs'>pass"; for($i=0;$i<5;$i++) echo '-'.basKeyid::kidRand('fs3',5); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['api']</td>  <td class='f16 ffvs'>api";  for($i=0;$i<5;$i++) echo '-'.basKeyid::kidRand('f',5); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['js']</td>   <td class='f16 ffvs'>js";   for($i=0;$i<5;$i++) echo '-'.basKeyid::kidRand('f',5); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['other']</td><td class='f16 ffvs'>other";for($i=0;$i<5;$i++) echo '-'.basKeyid::kidRand('f',5); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['safil']</td><td class='f16 ffvs'>safil";for($i=0;$i<5;$i++) echo '-'.basKeyid::kidRand('fs3',5); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['safix']</td><td class='f16 ffvs'>_";    echo basKeyid::kidRand('0',3); echo " &nbsp; &nbsp; (".lang('admin.pr_fix').")</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['rnum']</td> <td class='f16 ffvs'>";     echo basKeyid::kidRand('0',24); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['rspe']</td> <td class='f16 ffvs'>spe";  for($i=0;$i<3;$i++) echo '-'.basKeyid::kidRand('fs1',8); echo "</td></tr>\n";
		echo "<tr><td class='tc'>['safe']['rndtab']</td> <td class='f16 ffvs'>";   echo basKeyid::kidRTable('f');                           echo "</td></tr>\n";
		//62个字符,任意换位置; 但不能重复,否则出错; 可用basKeyid::kidRTable('f')生成
		echo "<tr><th>".lang('admin.pr_rnd1')."</th><th class='tr'>---</th></tr>\n";
		foreach(array('0','a','k','30','24','s','1','2','3','f','fs','fs1','fs2','fs3','~else~') as $k){
			echo "<tr><td class='tc'>basKeyid::kidRand('$k',36)</td> <td class='f16 ffvs'>"; echo basKeyid::kidRand($k,36); echo "</td></tr>\n";
		}
	}
	glbHtml::fmt_end();
}


?>



/*******************************************************************************
 File : \code\flow\admin\parex.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(dirname(__FILE__)).'/apis/_pub_cfgs.php');

$tabid = 'bext_paras'; 
$pid = empty($pid) ? 'parnav' : $pid;
$lnav = $db->table($tabid)->where("pid='parnav'")->order('top')->select(); 

if(empty($dialog)){
	$navs = array();  $gname = '';
	foreach ($lnav as $row) {
		$navs['admin/parex&pid='.$row['kid']] = $row['title'];
		if($row['kid']==$pid) $gname = $row['title'];
	}
	$lnkupd = "<a href='$aurl[1]&view=upd' onclick='return winOpen(this,\"".lang('flow.jf_updcfg')."\");'>&lt;&lt;".lang('flow.jf_upd')."</a>";
	$lnkupd .= "<span class='span ph5'>|</span>"; 
	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.jf_add')."&gt;&gt;</a>";
	$lnkadd = "<span class='span ph5'>|</span>$lnkadd"; //in_array($pid,array('parnav')) ?  : ''; 
	$navs = admPFunc::fileNav($pid,$navs);
	glbHtml::tab_bar("{$lnkupd}[$gname]$lnkadd","$navs",50);
}
if($view=='upd'){
	
	$keys = array('pid','title','detail','numa','numb','cfgs','note','cfgs');
	foreach ($lnav as $row) {
		$pid = $row['kid']; $arr = array();
		$list = $db->table($tabid)->where("pid='$pid' AND enable='1'")->order('top')->select(); 
		foreach($list as $v){ 
			$kid = str_replace('-','_',$v['kid']);
			foreach($keys as $k){
				$arr[$kid][$k] = $v[$k];
			}
		}
		if(!empty($arr)) glbConfig::save($arr,"parex_$pid",'dset');
	}
	$arr = array();
	foreach($lnav as $v){ 
		$kid = str_replace('-','_',$v['kid']);
		foreach($keys as $k){
			$arr[$kid][$k] = $v[$k];
		}
	}
	glbConfig::save($arr,"parex_parnav",'dset');
	
}elseif($pid && $view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&pid=$pid&flag=v1");
	}
	
	$list = $pid=='parnav' ? $lnav : $db->table($tabid)->where("pid='$pid'")->order('top')->select();
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.jf_jfcnt')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	if($list){
		foreach($list as $r){
		  $kid = $r['kid']; 
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$r[kid]</td>\n";
		  echo "<td class='tc'>$r[title]</td>\n";
		  echo "<td class='tc'>$r[numa]</td>\n";
		  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
		  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
		  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
		  echo "<td class='tl'><input type='text' value='$r[note]' class='txt w300' /></td>\n";
		  echo "</tr>"; 
		}
		echo "<tr>\n";
		echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
		echo "<td class='tr' colspan='7'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
		echo "</tr>";
	}else{
		echo "<tr>\n";
		echo "<td class='tc' colspan='8'>NO-Data, Please Add</td>\n";
		echo "</tr>"; 
	}
	glbHtml::fmt_end(array("mod|$mod","pid|$pid"));


}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','detail'=>'','cfgs'=>'','numa'=>'0','numb'=>'0');
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }

		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_uid41258')."'"; 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} 
		glbHtml::fmae_row('Title',"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");

		$numb = "numb:<input name='fm[numb]' type='text' value='$fm[numb]' class='txt w90' maxlength='12' tip='number' />";
		glbHtml::fmae_row('numa',"<input name='fm[numa]' type='text' value='$fm[numa]' class='txt w90' maxlength='9' reg='n+i' tip='number' /> &nbsp; $numb");

		glbHtml::fmae_row('cfgs',"<textarea name='fm[cfgs]' rows='4' cols='50' wrap='wrap'>$fm[cfgs]</textarea>");
		glbHtml::fmae_row('detail',"<textarea name='fm[detail]' rows='6' cols='50' wrap='wrap'>$fm[detail]</textarea>");
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='4' cols='50' wrap='wrap'>$fm[note]</textarea>");
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[pid]|$pid","kid|".(empty($kid) ? 'is__add' : $kid),"cid|$cid"));
	}
}

?>



/*******************************************************************************
 File : \code\flow\admin\relat.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','(auto)');

$view = empty($view) ? 'list' : $view;
$tabid = 'bext_relat';
$list = $db->table($tabid)->order('top,kid')->select(); 
$gbar = ''; $ggap = ''; $cfg = array();
foreach($list as $r){
	$gbar .= "$ggap<a href='?file=$file&view=set&parts=$r[kid]' ".($parts==$r['kid'] ? 'class="cur"' : '').">$r[title]</a>";
	$ggap = ' | ';
	if($parts==$r['kid']){ 
		$cfg = $r;
		$restr = $cfg['cfgs']; $rearr = basElm::text2arr($restr); 
	}
} //print_r($cfg); //echo $aurl[1];

if($view=='upd'){
	$re = glbCUpd::upd_relat();
	print_r($re);	
	die();
}elseif($view=='list'){
	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		foreach($fs as $id=>$v){
			$msg = lang('flow.msg_set');
			if($fs_do=='upd'){ 
				$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update(); 
			}elseif($fs_do=='del'){ 
				$db->table($tabid)->where("kid='$id'")->delete(); 	
			}elseif($fs_do=='show'){ 
				 $db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
			}elseif($fs_do=='stop'){ 
				 $db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
			}elseif($fs_do=='chupd'){ 
				 $char = strtoupper(comConvert::pinyinMain($fm[$id]['title'],3,1));
				 $db->table($tabid)->data(array('char'=>$char))->where("kid='$id'")->update();
			}
		}
		//glbCUpd::upd_model($mod);
		basMsg::show($msg,'Back','');	
	} 
	$lnkupd = "<a href='$aurl[1]&view=upd' onclick='return winOpen(this,\"".lang('admin.rel_upd')."\",320,240);'>".lang('admin.rel_upd')."</a>";
	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('admin.rel_add')."\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	glbHtml::tab_bar("$lnkupd<span class='span ph5'>|</span>".lang('admin.rel_radm')."<span class='span ph5'>|</span>$lnkadd",$gbar,25);
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	echo "<th>".lang('admin.rel_ct')."(1)</th><th>".lang('admin.rel_ct')."(2)</th><th>".lang('flow.title_set')."</th>";
	echo "<th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  $u_sub = strstr($aurl[1],'pid=') ? basReq::getURep($aurl[1],'pid',$r['kid']) : "$aurl[1]&pid=$r[kid]";
	  echo "<tr>\n";
	  echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";   
	  echo "<td class='tc'>".@$_groups[$r['mod1']]['title']."</td>\n";
	  echo "<td class='tc'>".@$_groups[$r['mod2']]['title']."</td>\n";
	  echo "<td class='tc'><a href='?file=$file&view=set&parts=$r[kid]'>".lang('flow.title_set')."</a></td>\n";
	  echo "<td class='tc'><a href='$aurl[1]&view=form&kid=$r[kid]' onclick='return winOpen(this,\"".lang('flow.title_edit')."\");'>".lang('flow.title_edit')."</a></td>\n"; //
	  echo "<td class='tl'><input name='fm[$kid][note]' type='text' value='$r[note]' class='txt w120' /></td>\n";
	  echo "</tr>"; 
	}} 
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end();	
}elseif($view=='form'){
	if(!empty($bsend)){
		if($kid=='_isadd_'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']);
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		//glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{
		if(empty($kid)){
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,'relat',0);
		}else{
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','cfgs'=>'','mod1'=>'','mod2'=>'',);
		foreach($def as $k=>$v){
			if(!isset($fm[$k])) $fm[$k] = $v;
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_tip21245')."'"; //url='".PATH_ROOT."/plus/ajax/cajax.php?act=keyExists&mod=$mod&tab=$tabid' 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:2-12' $vstr />$ienable");
		}
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");	
		$pold = '(x)'; $b = array('docs'=>lang('admin.rel_doc'),'types'=>lang('admin.rel_type'));
		foreach($_groups as $k=>$v){ 
		if(in_array($v['pid'],array('docs','types'))){
			if($pold!=$v['pid']) $a["^group^$v[pid]"] = $b[$v['pid']];
			$a[$k] = ' &nbsp; &nbsp; '.$v['title'];
			$pold = $v['pid'];
		} }
		$s1 = "<select name='fm[mod1]' reg='str:2-12' tip='".lang('admin.rel_sel')."'>".basElm::setOption($a,$fm['mod1'])."</select>";
		$s2 = "<select name='fm[mod2]' reg='str:2-12' tip='".lang('admin.rel_sel')."'>".basElm::setOption($a,$fm['mod2'])."</select>";
		glbHtml::fmae_row(lang('admin.rel_ct').'(1)',$s1);
		glbHtml::fmae_row(lang('admin.rel_ct').'(2)',$s2);
		glbHtml::fmae_row(lang('flow.fl_cfgtab'),"<textarea name='fm[cfgs]' rows='8' cols='50' wrap='off'>$fm[cfgs]</textarea><br>".lang('flow.fl_cfgtip'));
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("kid|".(empty($kid) ? '_isadd_' : $kid)));
	}
}elseif($view=='set'){
	$lnkbak = "<a href='?file=$file&view=list'>&lt;&lt;".lang('admin.rel_relist')."</a>";
	glbHtml::tab_bar("$lnkbak<span class='span ph5'>|</span>[$cfg[title]]".lang('admin.rel_set')."<span class='span ph5'>|</span>",$gbar,25);
	echo "<div class='h02'>&nbsp;</div>";
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	$cfg1 = glbConfig::read($cfg['mod1']); 
	$cfg2 = glbConfig::read($cfg['mod2']); 
	$mod1 = ''; $restr = $cfg['cfgs']; $rearr = basElm::text2arr($restr);
	echo "<th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('admin.rel_ritems')."</th><th>".lang('flow.title_set')."</th></tr>\n";
	foreach($cfg1['i'] as $k=>$v){
		$fix = $v['deep']<'2' ? "" : str_repeat("&nbsp;&nbsp;",$v['deep']);
		$arr = explode(',',@$rearr[$k]); $str = ''; 
		foreach($arr as $v2){
			$str .= (empty($str) ? '' : ',&nbsp; ').@$cfg2['i'][$v2]['title'];	
		}
		echo "<tr>\n";
		echo "<td class='tc w80'>$k</td>";
		echo "<td class='tl w200'><input type='text' value='$fix$v[title]' class='txt w180' /></td>";
		echo "<td class='tl'>$str</td>";
		echo "<td class='tc w40'><a href='?file=$file&view=sone&parts=$parts&kid=$k' onclick='return winOpen(this,\"[".$v['title']."]".lang('admin.rel_relx')."[".@$_groups[$cfg['mod2']]['title']."]\");'>".lang('flow.title_set')."</a></td>\n";
		echo "</tr>";	
	}
	glbHtml::fmt_end(array("parts|$parts"));
}elseif($view=='sone'){
	if(!empty($bsend)){	
		$v = empty($fm['rel']) ? '' : implode(',',array_filter($fm['rel']));
		$rearr[$kid] = $v; $restr = '';
		foreach($rearr as $k=>$v){ $restr .= "$k=,$v,\n"; } 
		$restr = str_replace(array(",,,",",,"),array(",",","),$restr); 
		$db->table($tabid)->data(basReq::in(array('cfgs'=>$restr)))->where("kid='$parts'")->update();
		basMsg::show(lang('flow.msg_upd'));	
	}else{ 
		$cfg2 = glbConfig::read($cfg['mod2']); 
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		$istr = @$rearr[$kid]; $wcell = 15;
		/*if($cfg2['deep']<2 && count($cfg2['i'])<12){
			echo "\n<tr><td colspan='2' class='tl'>";
			foreach($cfg2['i'] as $k2=>$v2){ 
				$def = strstr(",$istr,",",$k2,") ? " checked='checked' " : '';
				echo "\n\n<label><input type='checkbox' class='rdcb' name='fm[rel][]' id='fm_rel_$k2' value='$k2' $def>$v2[title]</label>";
			} 
			echo "</td></tr>";
		}else*/if($cfg2['deep']<2){
			$ctab = array();
			foreach($cfg2['i'] as $k2=>$v2){
				$char = $v2['char']; if($char<'A') $char = '-';
				$ctab[$char][$k2] = $v2;
			}
			foreach($ctab as $char=>$v1){
				$s2 = ''; 
				foreach($v1 as $k2=>$v2){ 
					$def = strstr(",$istr,",",$k2,") ? " checked='checked' " : '';
					$s2 .= "\n\n<label><input type='checkbox' class='rdcb' name='fm[rel][]' id='fm_rel_$k2' value='$k2' $def>$v2[title]</label>";
				} 
				glbHtml::fmae_row(" &nbsp;[$char]&nbsp; ",$s2);
				$wcell = '';
			}
		}else{
			foreach($cfg2['i'] as $k2=>$v2){ 
			if($v2['deep']=='1'){ $s3 = ''; $j = 0; 
				$def = strstr(",$istr,",",$k2,") ? " checked='checked' " : '';
				$def = empty($v2['frame']) ? "<input type='checkbox' class='rdcb' name='fm[rel][]' id='fm_rel_$k2' value='$k2' $def>" : '';
				$s2 = "\n<label>$def$v2[title]</label>";
				foreach($cfg2['i'] as $k3=>$v3){ 
				if($v3['pid']==$k2){
					//$i++; $j++;  
					$def = strstr(",$istr,",",$k3,") ? " checked='checked' " : '';
					//if($j>4) { $s3 .= "<br>"; $j=1; }
					$s3 .= "\n\n<label><input type='checkbox' class='rdcb' name='fm[rel][]' id='fm_rel_$k3' value='$k3' $def>$v3[title]</label>";
				} }
				glbHtml::fmae_row($s2,$s3);
			} }
		}
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),$wcell);
		glbHtml::fmt_end(array("parts|$parts"));
	}
}

?>



/*******************************************************************************
 File : \code\flow\admin\rlogs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(dirname(__FILE__)).'/apis/_pub_cfgs.php');

$part = basReq::val('part','delog'); 
$ord4 = basLang::ucfg('cfgbase.admord4a');

if($part=='dbsql'){
	
	define('RUN_DBSQL',1);
	$cfg = array(
		'sofields'=>array('sql','page','tpl'),
		'soorders'=>$ord4,
		'soarea'=>array('used',lang('admin.rl_rtime')),
	);
	$dop = new dopExtra('logs_dbsql',$cfg); 
	
	// 删除操作
	if(!empty($bsend)){
		require(dirname(dirname(__FILE__)).'/binc/act_ops.php');
	} 
	
	$lnkset = "(<a href='?file=admin/ediy&part=edit&dkey=cfgs&dsub=&efile=boot/const.cfg.php' onclick='return winOpen(this,\"".lang('admin.rl_setpm')."\");'>".lang('flow.title_set')."</a>)";
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	$links = admPFunc::fileNav('dbsql','logs');
	$dop->sobar("$links$lnkset $umsg",40,array());
	
	// 清理操作
	if(!empty($bsend)&&$fs_do=='dnow'){
		$msg = $dop->opDelnow();
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&part=$part&flag=v1");
	}
		
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>sql</th><th>tpl@tag - View - keyid / page</th><th>run(ms)/time</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  $sql = basSql::fmtShow($r['sql'],2);
		  $ext = "$r[tag]@$r[tpl] # <a href='$r[page]' target=_blank>View</a> # $r[kid]";
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tl'><textarea cols=60 rows=3>$sql</textarea></td>\n";
		  echo "<td class='tc'>$ext<br><input type='text' value='$r[page]' class='txt w240'/></td>\n";
		  echo "<td class='tc'>$r[used]<br>".date('m-d H:i:s',$r['atime'])."</td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod","part|$part"));

}else{
	
	if(empty($mod) || !in_array($mod,array('detmp','syact'))) $mod = 'detmp';
	$cfg = array(
		'sofields'=>array('act','note','aip','aua'),
		'soorders'=>$ord4,
		'soarea'=>array('used',lang('admin.rl_rtime')),
	);
	$dop = new dopExtra("logs_$mod",$cfg); 
	
	// 删除操作
	if(!empty($bsend)){
		require(dirname(dirname(__FILE__)).'/binc/act_ops.php');
	}  
	
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	$links = admPFunc::fileNav($mod,'logs');
	$dop->sobar("$links$umsg",40,array());
	
	// 清理操作
	if(!empty($bsend)&&$fs_do=='dnow'){
		$msg = $dop->opDelnow();
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&part=$part&flag=v1");
	}
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>act/run</th><th>page/ref</th><th>note</th><th>User Agent</th><th>time/kid</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  $note = basStr::filForm($r['note']);
		  $aua = basStr::filForm($r['aua']);
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'><a href='$r[page]' target=_blank>$r[act]<br>$r[used]</a></td>\n";
		  echo "<td class='tc'><input type='text' value='$r[page]' class='txt w240'/><br><input type='text' value='$r[pref]' class='txt w240'/></td>\n";
		  echo "<td class='tl'><textarea cols=30 rows=3>$note</textarea></td>\n";
		  echo "<td class='tl'><textarea cols=30 rows=3>$aua</textarea></td>\n";
		  echo "<td class='tc'>".date('m-d H:i:s',$r['atime'])."<br>$r[aip]</td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));

}

?>



/*******************************************************************************
 File : \code\flow\admin\static.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','(auto)'); 

$ntpl = basReq::val('ntpl',$_cbase['tpl']['def_static']);
$_cbase['tpl']['tpl_dir'] = $ntpl;
$cronurl = PATH_ROOT."/plus/ajax/cron.php";

$view = basReq::val('view','list');
$nmod = basReq::val('nmod','home'); 
$vcfgs = vopTpls::etr1('tpl'); 
$stitle = lang('admin.st_admin').":($ntpl)".basLang::pick(0,$vcfgs[$ntpl][0]); 
$msg = ''; //print_r($msg);

$lnks = "# "; $ncfg = array(); 
foreach($vcfgs as $itpl=>$suit){
	if($itpl==$ntpl){ // dynamic/static/both/all/
		$ncfg = vopTpls::entry($itpl,'ehlist','static');  
	}
	$cname = basLang::pick(0,$suit[0]); //is_array($suit[0]) ? $suit[0]['cn'] : $suit[0];
	$ititle = $itpl==$ntpl ? "<span class='cF0F'>$cname<span>" : $cname;
	$lnks .= "<a href='?file=$file&ntpl=$itpl'>{$ititle}</a> # ";
    
}
glbHtml::tab_bar("$stitle $msg",$lnks,40); 

if($view=='list'){

	$mods = array_keys($ncfg);
	glbHtml::fmt_head('fmlist',"?",'tblist');
	echo "\n<tr><th class='tc'></th>\n<th>".lang('admin.st_admin')." --- $ntpl:$nmod --- <a href='?file=$file&ntpl=$ntpl&nmod=all'>".lang('admin.st_allmod')."</a></th></tr>\n";
	echo "\n<tr><td class='tc'>".lang('admin.st_opmode').": </td>\n<td>"; $ti = 0;
	foreach($mods as $imod){
		$iname = $imod=='home' ? lang('admin.st_home') : (isset($_groups[$imod]) ? $_groups[$imod]['title'] : "($imod)");
		$ititle = $imod==$nmod ? "<span class='cF0F'>$iname<span>" : "$iname";
        if($ti==0) echo " ";
        else echo ($ti && $ti%6==0) ? "<br>" : " # ";
		echo "<a href='?file=$file&ntpl=$ntpl&nmod=$imod'>$ititle</a>";	
        $ti++;
	}
	echo "</td></tr>\n";
    if($nmod=='home'){
		$sfile = vopStatic::getPath('home','home',0);
        $exists = file_exists(DIR_HTML."/$sfile") ? date('Y-m-d H:i:s',filemtime(DIR_HTML."/$sfile")) : lang('admin.st_notfound');
        echo "\n<tr><td class='tc'>".lang('admin.st_hmstatic')."</td>\n<td>
			".lang('admin.st_stfile').": {html}".$sfile." (".$exists.")
            <p class='tc f18'>
            <a href='$cronurl?static=home&tpldir=$ntpl&act=add' class='f18 fB' onclick='return winOpen(this);'>".lang('admin.st_crpage')."</a> #
            <a href='$cronurl?static=home&tpldir=$ntpl&act=del' class='f18 fB' onclick='return winOpen(this);'>".lang('admin.st_depage')."</a> # 
            <a href='".vopUrl::ftpl("$ntpl:0")."' target='_blank' class='f18 fB' target='_blank'>".lang('admin.st_vres')."</a>
            </p>
		</td></tr>\n";

	}elseif($nmod!=='all'){  
		$iname = isset($_groups[$nmod]) ? $_groups[$nmod]['title'] : lang('admin.st_udefine');
		$mcfgs = glbConfig::read($nmod); 
        echo "\n<tr><td class='tc'>{$iname}<br>[$ntpl:$nmod]</td>\n<td>";
		echo "\n<p>
            &nbsp; ● ".lang('admin.st_cstatic').": ".lang('admin.st_allrecs',count($ncfg[$nmod]))."
            </p>
            <p class='tc f14'>
            <a href='$cronurl?static=mlist&mod=$nmod&tpldir=$ntpl&act=add' class='fB' onclick='return winOpen(this);'>".lang('admin.st_crpage')."</a> #
            <a href='$cronurl?static=mlist&mod=$nmod&tpldir=$ntpl&act=del' class='fB' onclick='return winOpen(this);'>".lang('admin.st_depage')."</a> 
            </p>";
		if(!empty($mcfgs['pid']) && in_array($mcfgs['pid'],array('docs','users'))){
			$recs = $db->table("{$mcfgs['pid']}_$nmod")->count();
			echo "\n<p class='right ph20'><a href='".vopUrl::ftpl("$ntpl:0")."?$nmod' target='_blank' class='f18 fB'>".lang('admin.st_dmhome')."</a></p>
			<p>
            &nbsp; ● ".lang('admin.st_dstatic').": ".lang('admin.st_allrecs',$recs)."
			<input name='limit' type='text' value='20' class='w40' maxlength='3'>".lang('admin.st_batnum')." &nbsp; 
			offset/dirfix: <input name='offset' type='text' value='' class='w40' maxlength='4'> &nbsp; 
            </p>
            <p class='tc f14'>
            <a href='$cronurl?static=mdetail&mod=$nmod&tpldir=$ntpl&act=add' class='fB' onclick='return stsetLink(this);'>".lang('admin.st_crpage')."</a> #
            <a href='$cronurl?static=mdetail&mod=$nmod&tpldir=$ntpl&act=del' class='fB' onclick='return stsetLink(this);'>".lang('admin.st_depage')."</a> 
            </p>";
		}
		echo "\n</td></tr>\n";
	}
	glbHtml::fmt_end(array("nmod|$nmod","ntpl|$ntpl"));
    
	if($nmod=='all'){
		echo "<table width='100%' border=1>";
		$i = 0;
		foreach($mods as $imod){
			$i++;
			if($imod=='home'){
				$url = "static=home&tpldir=$ntpl&act=add";
			}else{
				$url = "static=mlist&mod=$imod&tpldir=$ntpl&act=add";	
			}
			echo "\n<td><iframe src='$cronurl?$url' width='100%'></iframe></td>";
			if($i%3==0){ echo "</tr><tr>"; }
			$mcfgs = glbConfig::read($imod); 
			if(!empty($mcfgs['pid']) && in_array($mcfgs['pid'],array('docs','users'))){
				$url = "static=mdetail&mod=$imod&tpldir=$ntpl&act=add";
				echo "\n<td><iframe src='$cronurl?$url' width='100%'></iframe></td>";
				$i++;
			}
			if($i%3==0){ echo "</tr><tr>"; } 
		}
		echo "</table>";
	}
	
	/*
    echo "<pre>"; 
    #$res = vopStatic::updKid('news','2015-9g-mvp1','upd'); print_r($res);
    print_r($mods);
	//*/
    
}

/*	

*/

?>



/*******************************************************************************
 File : \code\flow\admin\types.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','admin/types.php');

$mod = empty($mod) ? 'china' : $mod;
$view = empty($view) ? 'glist' : $view;
$pid = empty($pid) ? '0' : $pid;
if(!($gname = @$_groups[$mod]['title'])) glbHtml::end(lang('flow.dops_parerr').':mod@types.php'); 
$gbar = admAFunc::grpNav('types',$mod); 

$cfg = glbConfig::read($mod); //print_r($cfg);
$tabid = empty($cfg['etab']) ? 'types_common' : "types_$mod";

if($view=='glist'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		elseif($fs_do=='chord'){
			$msg = lang('admin.tp_ordok'); 
			$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('`char`,kid')->select();
			if($list){ $bord = 124;
			foreach($list as $r){
				$bord += 4; $kid = $r['kid']; 
				$db->table($tabid)->data(array('top'=>$bord))->where("model='$mod' AND kid='$kid'")->update(); 
			}}
		}else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='upd'){ 
					$fm[$id]['char'] = strtoupper(comConvert::pinyinMain($fm[$id]['title'],3,1));
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='del'){ 
					if($db->table($tabid)->where("model='$mod' AND pid='$id'")->find()){
						$msg = lang('admin.cat_dsub',$id); 
					}else{
						$db->table($tabid)->where("model='$mod' AND kid='$id'")->delete(); 
						vopStatic::clrFile($mod,$id);
						$msg = lang('flow.msg_del');	
					}
				}elseif($fs_do=='show'){ 
					 $db->table($tabid)->data(array('enable'=>'1'))->where("model='$mod' AND kid='$id'")->update();  
				}elseif($fs_do=='stop'){ 
					 $db->table($tabid)->data(array('enable'=>'0'))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='frame'){ 
					 $db->table($tabid)->data(array('frame'=>'1'))->where("model='$mod' AND kid='$id'")->update();  
				}elseif($fs_do=='nofrm'){ 
					 $db->table($tabid)->data(array('frame'=>'0'))->where("model='$mod' AND kid='$id'")->update(); 
				}elseif($fs_do=='chupd'){ 
					 $char = strtoupper(comConvert::pinyinMain($fm[$id]['title'],3,1));
					 $db->table($tabid)->data(array('char'=>$char))->where("model='$mod' AND kid='$id'")->update();
				}
			}
		}
		glbCUpd::upd_model($mod);
	} 

	$lnklay = admAFunc::typLay($cfg,$aurl,$pid);
	$lnkbak = $_groups[$cfg['pid']]['title'];
	$lnkadd = "<a href='$aurl[1]&view=gform&pid=$pid' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	if($pid && !isset($cfg['i'][$pid])) $lnkadd = "<i title='".lang('admin.cat_close')."'>".lang('flow.fl_addtitle')."&gt;&gt;</i>";
    $lnkchk = "<a href='$aurl[1]&view=check' onclick='return winOpen(this);'>".lang('admin.tp_chkinc')."</a>";
    if(empty($pid)) $lnklay = "$lnkchk | $lnklay";
	glbHtml::tab_bar("[$lnkbak] :: $gname<span class='span ph5'>|</span>$lnkadd<br>$lnklay",$gbar,35);
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th>";
	echo "<th>".lang('flow.title_char')."</th><th>".lang('flow.title_level')."</th><th>".lang('flow.title_frame')."</th><th>".lang('flow.title_note')."</th>";
	echo "<th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	$list = $db->table($tabid)->where("model='$mod' AND pid='$pid'")->order('top,kid')->select();
	if($list){
	foreach($list as $r){
	  $kid = $r['kid'];
	  $u_sub = strstr($aurl[1],'pid=') ? basReq::getURep($aurl[1],'pid',$r['kid']) : "$aurl[1]&pid=$r[kid]";
	  $f_deep = @$cfg['i'][$pid]['deep'] < $cfg['deep']-1;
	  $s_cnt = count(comTypes::getSubs($cfg['i'],$r['kid']));
	  echo "<tr>\n";
	  echo "<td class='tc'><input name='fs[$kid]' type='checkbox' class='rdcb' value='1' /></td>\n";
	  echo "<td class='tc'><a href='$aurl[1]&view=set&kid=$r[kid]' onclick='return winOpen(this,\"".lang('admin.fad_setid',$r['title'])."\",400,300);'>$r[kid]</a></td>\n";
	  echo "<td class='tl'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo "<td class='tc'>$r[char]</td>\n";
	  echo "<td class='tc'>$r[deep]</td>\n"; 
	  echo "<td class='tc'>".glbHtml::null_cell($r['frame'])."</td>\n";
	  echo "<td class='tc'>".($f_deep ? "<a href='$u_sub'>$s_cnt</a>" : glbHtml::null_cell($s_cnt))."</td>\n";   
	  echo "<td class='tc'><a href='$aurl[1]&view=gform&kid=$r[kid]&recbk=ref'>".lang('flow.title_edit')."</a></td>\n";
	  echo "<td class='tl'><input name='fm[$kid][note]' type='text' value='$r[note]' class='txt w120' /></td>\n";
	  echo "</tr>"; 
	}} 
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	$opstr = basElm::setOption(lang('flow.op_op4')."\nframe|".lang('admin.cat_frame')."\nnofrm|".lang('admin.cat_xframe')."\nchupd|".lang('admin.tp_updchar')."\nchord|".lang('admin.tp_ordchar')."");
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>$opstr</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='gform'){ 

	if(!empty($bsend)){ 
		if($kid=='_isadd_'){
			$fm['char'] = strtoupper(comConvert::pinyinMain($fm['title'],3,1));
			if($db->table($tabid)->where("model='$mod' AND kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				
				$fm['deep'] = empty($fm['pid']) ? 1 : @$cfg['i'][$pid]['deep']+1;
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']);
			$f = $cfg['f'];
			$mcfg = glbConfig::read($mod); 
			foreach($_POST['fm'] as $k=>$v){
			if(isset($f[$k])){ 
				$fm[$k] = dopFunc::svFmtval($f,$mod,$k,$v);
				if(isset($mcfg['f'][$k]) && in_array($mcfg['f'][$k]['type'],array('file','text'))){
					$ishtml = $mcfg['f'][$k]['type']=='text';
					$fm[$k] = comFiles::moveTmpDir($fm[$k],$mod,'',$ishtml);
				}
			} }
			$db->table($tabid)->data(basReq::in($fm))->where("model='$mod' AND kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{
		if(empty($kid)){
			$kid = ''; $did = glbDBExt::dbNxtID($tabid,$mod,$pid);
		}else{
			$fm = $db->table($tabid)->where("model='$mod' AND kid='$kid'")->find();
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','frame'=>'0','deep'=>'1','cfgs'=>'',);
		foreach($def as $k=>$v){
			if(!isset($fm[$k])) $fm[$k] = $v;
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=keyExists&mod=$mod&tab=$tabid' tip='".lang('admin.fad_tip21245')."'";
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:2-12' $vstr />$ienable");
		}
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21245')."' />$itop");
		glbHtml::fmae_row(lang('flow.fl_cfgtab'),"<textarea name='fm[cfgs]' rows='8' cols='50' wrap='off'>$fm[cfgs]</textarea><br>".lang('flow.fl_cfgtip'));
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		empty($kid) || fldView::lists($mod,$fm);
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[model]|$mod","fm[pid]|$pid","kid|".(empty($kid) ? '_isadd_' : $kid)));
	}

}elseif($view=='set'){
	require(dirname(dirname(__FILE__)).'/binc/set_id.php');
}elseif($view=='check'){
    $irep = devBase::typCheck($mod);
    echo "<pre> "; print_r(str_replace(";","\n",$irep)); echo "</pre>";
}

?>



/*******************************************************************************
 File : \code\flow\admin\uinfo.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','(auto)'); 

$view = basReq::val('view','uinfo'); //echo $view;
$bspw = basReq::val('bspw');
$mod = $user->uinfo['umods']; //$user->uperm['model'];
$tabid = "users_$mod";
$uid = $user->uinfo['uid'];

$title = $view=='uinfo' ? lang('admin.ui_uinfo') : lang('admin.ui_upass');
$msg = '';

if(!empty($bsend)){ 
	$db->table($tabid)->data(basReq::in($fm))->where("uid='$uid'")->update();
	$msg = ' &nbsp; '.lang('admin.ui_editok');	
}elseif(!empty($bspw)){
	$uname = $user->uinfo['uname'];
	$msg = dopUser::editPass($mod,$uname);
}
$fmo = $db->table($tabid)->where("uid='$uid'")->find(); 

// 个人资料 - 密码
$lnks = "<a href='?file=admin/uinfo&view=uinfo'>".lang('admin.ui_uinfo')."</a> | <a href='?file=admin/uinfo&view=passwd'>".lang('admin.ui_upass')."</a>";
glbHtml::tab_bar("$title $msg",$lnks,35);

if($view=='uinfo'){ //basDebug::varShow($user);

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	fldView::lists($mod,$fmo);
	glbHtml::fmae_send('bsend',lang('flow.dops_send'));
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='passwd'){
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	
	$paras = "type='password' value='' autocomplete='off' class='w240' maxlength='24' reg='str:6-24' tip='".lang('admin.ui_let624')."'";
	glbHtml::fmae_row(lang('admin.ui_oldpass'),"<input name='pwold' $paras/> ".lang('admin.ui_let624'));
	glbHtml::fmae_row(lang('admin.ui_newpass'),"<input name='pwnew' $paras/> ".lang('admin.ui_let624'));
	glbHtml::fmae_row(lang('admin.ui_again'),"<input name='pwrep' $paras/> ".lang('admin.ui_agtip'));
	
	glbHtml::fmae_send('bspw',lang('flow.dops_send'),'25');
	glbHtml::fmt_end(array("kid|".(empty($kid) ? 'is__add' : $kid)));

}




/*******************************************************************************
 File : \code\flow\admin\update.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
usrPerm::run('pfile','(auto)');

$parts = empty($parts) ? 'cache' : $parts;
$cfg = basLang::ucfg('cfgbase.admupd'); 

$gbar = ''; $ggap = ''; // class='cur,
foreach($cfg as $k=>$v){ 
	$gbar .= "$ggap<input type='checkbox' class='rdcb' value='cache' onClick=\"clr_group(this,'$k');\"><a href='#' id='navid_$k'>$v</a>";	
	$ggap = ' | ';
}

$g0 = $db->table('base_model')->where("enable='1'")->order('pid,top,kid')->select();
$g1 = array();
foreach($g0 as $k=>$v){
	$g1[$v['kid']] = $v;
}

if(empty($bsend)){
	$str1 = ''; $ti = 0;
	foreach($g1 as $k=>$v){
		if($v['pid']=='types'){
			if($ti && $ti%6==0) $str1 .= "<br>";
            $str1 .= "<label><input type='checkbox' class='rdcb cbg_types' name='clr[]' id='clr_$k' value='type_$k'>$v[title]</label>";
            $ti++;
		}
	}
	$stra = "<label><input type='checkbox' class='rdcb cbg_cache' name='clr[]' id='clr_cache' value='cache'>{$cfg['cache']}</label>";
	$stra .= "<label><input type='checkbox' class='rdcb cbg_cache' name='clr[]' id='clr_relat' value='relat'>".lang('admin.ud_reltype')."</label>";	
	$stra .= "<label><input type='checkbox' class='rdcb cbg_cache' name='clr[]' id='clr_gperm' value='gperm'>".lang('admin.ud_gperm')."</label>";

	$strb = "<label><input type='checkbox' class='rdcb cbg_data' name='clr[]' id='clr_data' value='data'>".lang('admin.ud_exdata')."</label>";
	$strb .= "<label><input type='checkbox' class='rdcb cbg_data' name='clr[]' id='clr_file' value='file'>".lang('admin.ud_exfile')."</label>";
    $strb .= "<label><input type='checkbox' class='rdcb cbg_data' name='clr[]' id='clr_ctpl' value='ctpl'>".lang('admin.ud_tplcache')."</label>";
    $strb .= "<label><input type='checkbox' class='rdcb cbg_data' name='clr[]' id='clr_ctag' value='ctag'>".lang('admin.ud_tagcache')."</label>";
	$strb .= "<label><input type='checkbox' class='rdcb cbg_data' name='clr[]' id='clr_cadv' value='cadv'>".lang('admin.ud_advcache')."</label>";	
    
    $strm = "<label><input type='checkbox' class='rdcb cbg_menux' name='clr[]' id='clr_menua' value='menua'>".lang('admin.ud_amenu')."</label>";
    $strm .= "<label><input type='checkbox' class='rdcb cbg_menux' name='clr[]' id='clr_menum' value='muadm'>".lang('admin.ud_umenu')."</label>";	
	$strm .= "<label><input type='checkbox' class='rdcb cbg_menux' name='clr[]' id='clr_madvs' value='madvs'>".lang('admin.ud_adlink')."</label>";	
	
	glbHtml::tab_bar($cfg['cache']." : ".lang('admin.ud_updclr'),lang('admin.ud_quick')." : $gbar",35);
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	glbHtml::fmae_row(lang('flow.op_upd').':'.$cfg['cache'],$stra);
	glbHtml::fmae_row(lang('flow.op_upd').':'.$cfg['types'],$str1);
	glbHtml::fmae_row(lang('flow.op_upd').':'.$cfg['menux'],$strm);
	glbHtml::fmae_row(lang('flow.dops_clear').':'.$cfg['data'],$strb);
	glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
	glbHtml::fmt_end(array("kid|".(empty($kid) ? '_isadd_' : $kid))); 
	echo basJscss::jscode("\nfunction clr_group(e,part){fmSelGroup(e,part);$('#navid_'+part).toggleClass('cur');}$('input:first').trigger('click');");

}elseif(!empty($bsend)){

	$clr = basReq::arr('clr'); 
	if(empty($clr)) basMsg::show(lang('admin.ud_pick'),'Redir',"?file=admin/update&parts=$parts");
	
	if(in_array('cache',$clr)){
		glbCUpd::upd_groups();
		foreach($g1 as $k=>$v){
			if(in_array($k,array('score','sadm','smem','suser',))){ 
				glbCUpd::upd_paras($k);
			}
			if($v['pid']=='groups') continue;
			if($v['pid']=='types' && !empty($v['etab'])) continue; 
			if(in_array($v['pid'],array('score','sadm','smem','suser',))) continue;
			glbCUpd::upd_model($k); 
		}
	}
	if(in_array('relat',$clr)){
		$re = glbCUpd::upd_relat();
		print_r($re);	
	}
	foreach($clr as $k){
		if(substr($k,0,5)=='type_'){
			$key = substr($k,5);
			if(isset($g1[$key])){ 
				echo "<br>$key : OK! ";
				glbCUpd::upd_model($key); 
			}		
		}
	}
	if(in_array('menua',$clr)){
		foreach(array('muadm') as $mod){
			echo glbCUpd::upd_menus($mod);
		}
	} // upd_grade放在upd_menus后面
    if(in_array('menum',$clr)){
		 admAFunc::umcVInit();
	}
	if(in_array('gperm',$clr)){
		glbCUpd::upd_grade(); 
	}
	if(in_array('data',$clr)){
		devScan::clrLogs();
	}
	if(in_array('file',$clr)){
		devScan::clrTmps();
		$p0 = DIR_DTMP.'/modcm/';
		$a0 = comFiles::listDir($p0);
		$af = $a0['file'];
		foreach($af as $k=>$v){
			if(strstr($k,'.cfg.php')){
				$k2 = substr(str_replace(".cfg.php","",$k),1);
				if($k2=='groups') continue;
				if(!isset($g1[$k2])){
					unlink("{$p0}_{$k2}.cfg.php");	
				}
			}
		}
	}
	
	// 
	$arr = array('ctpl'=>'','ctag'=>'tagc','cadv'=>'advs',);
	foreach($arr as $k=>$v){
		if(in_array($k,$clr)){
			devScan::clrCTpl($v);	
		}
	}

	if(in_array('madvs',$clr)){
		foreach($g1 as $k=>$v){
			if(in_array($v['pid'],array('advs',))){ 
				vopStatic::advMod($k,"(all)");
			}
		}
	}
	
	echo '<br>'.basDebug::runInfo().'<hr>';
	//print_r($clr);
	basMsg::show(lang('admin.ud_end'),'Redir',"?file=admin/update&parts=$parts");

}elseif($view=='set'){



}

?>



/*******************************************************************************
 File : \code\flow\admin\upgrade.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','(auto)');

$mod = basReq::val('mod','upvnow'); 
$nava = basLang::ucfg('nava.upd_vers'); 
$mtitle = $nava["admin/upgrade&mod=$mod"];
$step = basReq::val('step','init'); // init,set,deel
$fact = basReq::val('fact',''); 
$burl = "?file=$file&mod=$mod&fact=";

$links = admPFunc::fileNav($mod,'upd_vers');
glbHtml::tab_bar(lang('admin.upg_upgrade')."<span class='span ph5'>#</span>$mtitle","$links",50);

$tiprows = "
    \n<tr><td class='tc w180'>".lang('admin.upg_bkdb')."</td>\n<td>
		".lang('admin.upg_tipdb')." 
	</td></tr>\n
    \n<tr><td class='tc w180'>".lang('admin.upg_blfile')."</td>\n<td>
		".lang('admin.upg_tipfile')."
	</td></tr>\n";
$tpl = $_cbase['sys']['lang']=='zh' ? 'dev' : 'doc'; 
$link = "<a href='{$_cbase['server']['txmao']}/$tpl.php?uplog' target='_blank'>".lang('admin.upg_off')."</a>";

glbHtml::fmt_head('fmlist',"$burl$fact&step=deel",'tblist');


if($mod=='upvnow'){
	
	echo "\n<tr><th class='tc'></th>\n<th>$mtitle: </th></tr>\n";
	echo "\n<tr><td class='tc w180'>".lang('admin.upg_use')."</td>\n<td>
		".lang('admin.upg_tipup')."
	</td></tr>\n";
    echo $tiprows;
	echo "\n<tr><td class='tc w180'>".lang('admin.upg_upstart')."</td>\n<td class='tc'>
		<a href='".PATH_ROOT."/tools/setup/upvnow.php' target='_blank' class='f18 fB'>".lang('admin.upg_upstart')."</a>
	</td></tr>\n";
	
}elseif($mod=='import'){

	echo "\n<tr><th class='tc'></th>\n<th>$mtitle: </th></tr>\n";
	echo "\n<tr><td class='tc w180'>".lang('admin.upg_use')."</td>\n<td>
		".lang('admin.upg_tipimp')."
	</td></tr>\n";
    echo $tiprows;
	echo "\n<tr><td class='tc w180'>".lang('admin.upg_impstart')."</td>\n<td class='tc'>
		<a href='".PATH_ROOT."/tools/setup/upvimp.php' target='_blank' class='f18 fB'>".lang('admin.upg_impstart')."</a>
	</td></tr>\n";

}elseif($mod=='install'){

	$list = comFiles::listDir(DIR_DTMP.'/update/','file');
	$msg = '(null)';
	echo "\n<tr><th class='tc'>$mtitle: </th>\n<th>Actions</th></tr>\n";
	if($step=='set'){
		$icfg = devSetup::insList($fact,1); $iu2 = implode('<br>',$icfg['abtn']); 
		$iu2 = str_replace('Update',"<i class='cF0F'>Update</i>",$iu2);  
		echo "\n<tr><td><b>$fact</b>$icfg[slist]</td>\n<td class='tc'>Will...<br>$iu2</td></tr>\n";
	    #echo $btnrows;
	    $deel = "<input name='bsend' class='btn' type='submit' value='Install/Update' /></a>";
		echo "\n<tr><td class='tc'>$deel</td>\n<td class='tc'>
			<a href='".PATH_ROOT."/tools/setup/upvimp.php' target='_blank' class='f18 fB'>$link</a>
		</td></tr>\n";
	}elseif($step=='deel'){
		$icfg = devSetup::insDeel($fact,1); $iu2 = implode('<br>',$icfg['abtn']); 
		$iu2 = str_replace('Update',"<i class='cF0F'>Update</i>",$iu2);  
		echo "\n<tr><td><b>$fact</b>$icfg[slist]</td>\n<td class='tc'>Done...<br>$iu2</td></tr>\n";
		# next ... (后续...)
	    #echo $btnrows;
		$bak = "<a href='$burl'>GoBack</a>";
		$del = "<a href='$burl".str_replace('.php','',$fact)."&step=del' class='cF00'>Delete</a>";
		echo "\n<tr><td class='tc'>$bak # $del</td>\n<td class='tc'>
			<a href='".PATH_ROOT."/tools/setup/upvimp.php' target='_blank' class='f18 fB'>$link</a>
		</td></tr>\n";
	}else{ //init
		foreach ($list as $fnow => $v) {
			if($step=='del'&&strstr($fnow,"$fact.")){
				unlink(DIR_DTMP.'/update/'.$fnow);
				$msg = 'Delete OK!';
				continue;
			}
			if(substr($fnow,0,4)!='ins~' || strpos($fnow,'.php')<=0) continue;
			$icfg = devSetup::insList($fnow); $iu2 = implode('<br>',$icfg['abtn']); 
			$iu2 = str_replace('Update',"<i class='cF0F'>Update</i>",$iu2);  
			$upd = "<a href='$burl$fnow&step=set'>Ins/Upd</a>";
			$del = "<a href='$burl".str_replace('.php','',$fnow)."&step=del' class='cF00'>Delete</a>";
			echo "\n<tr><td>[".date('Y-m-d H:i',$v[0])."] <b>$fnow</b>$icfg[slist]</td>\n<td class='tc'>$upd # $del<br>$iu2</td></tr>\n";
		} //dump($v);
	    #echo $tiprows;
		echo "\n<tr><td class='tc'>Message: $msg</td>\n<td class='tc'>
			<a href='".PATH_ROOT."/tools/setup/upvimp.php' target='_blank' class='f18 fB'>$link</a>
		</td></tr>\n";
	}
		
}

if(in_array($mod,array('upvnow','import'))){

	echo "\n<tr><th class='tc'></th>\n<th>".lang('admin.upg_tip1').": </th></tr>\n";
	$text = comFiles::get(DIR_CODE."/tpls/$tpl/d_uplog/upd_readme.txt"); 
	//$text = extMkdown::pdext($text);
	echo "\n<tr><td class='tc w180'>".lang('admin.upg_tip2')."<br>$link</td>\n<td>
		<textarea cols='' rows='18' style='width:100%'>$text</textarea>
	</td></tr>\n";

}

glbHtml::fmt_end(array(""));


?>



/*******************************************************************************
 File : \code\flow\apis\cron_plan.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$tabid = 'bext_cron';
$units = basLang::ucfg('cfgbase.corn_unit');

if($view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}elseif(in_array($fs_do,array('runp','rinc'))){ 
					$upd = $fs_do=='runp' ? 1 : 0;
					$cron = new extCron($id);
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}

	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.cr_addplan')."\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	$links = admPFunc::fileNav($file,'cron_plan');
	glbHtml::tab_bar("".lang('flow.cr_planord')."<span class='span ph5'>|</span>$lnkadd","$links",50);
	
	$list = $db->table($tabid)->order('top')->select(); //->where("pid='$pid'")
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>".lang('flow.cr_kfine')."</th><th>".lang('flow.title_name')."</th><th>".lang('flow.cr_cycle')."</th><th>".lang('flow.cr_runprev')."</th><th>".lang('flow.cr_runnext')."</th><th>".lang('flow.cr_runms')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'>$r[excycle]".@$units[$r['excunit']]."</td>\n";
	  echo $cv->Time($r['exlast'],$td=1);
	  echo $cv->Time($r['exnext'],$td=1);
	  echo "<td class='tc'>$r[exsecs]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	$opstr = basElm::setOption(lang('flow.op_op4')."\nrinc|*".lang('flow.cr_dirun')."\nrunp|*".lang('flow.cr_odrun')."");
	echo "<td class='tr' colspan='9'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>$opstr</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='form'){
	
	if(!empty($bsend)){
		$fm['exnext'] = strtotime($fm['exnext'].":00");
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array(
			'kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','cfgs'=>'',
			'excycle'=>'1','excunit'=>'d','exlast'=>'0','exnext'=>'946526400','extime'=>'0','exskip'=>'','exsecs'=>date('i:s'),
		);
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }

		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('flow.cr_tip1')."'"; //url='".PATH_ROOT."/plus/ajax/cajax.php?act=modExists' 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='tit:4-12' $vstr />$ienable");
		} 
		glbHtml::fmae_row(lang('flow.cr_pname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");

		unset($units['m']);
		$excunit = basElm::setOption($units,$fm['excunit']);
		$excunit = " &nbsp; ".lang('flow.cr_unit')."<select name='fm[excunit]' class='w90'>$excunit</select>";
		glbHtml::fmae_row(lang('flow.cr_cycle'),"<input name='fm[excycle]' type='text' value='$fm[excycle]' class='txt w90' maxlength='3' reg='n+i' tip='".lang('flow.cr_tip2')."' />$excunit");

		echo basJscss::imp('/My97DatePicker/WdatePicker.js','vui'); 
		$slast = empty($fm['exlast']) ? '-' : date('Y-m-d H:i',$fm['exlast']);
		$slast = " &nbsp; ".lang('flow.cr_last').": $slast";
		$iinp = "<input id='fm[exnext]' name='fm[exnext]' type='text' value='".date('Y-m-d H:i',$fm['exnext'])."' class='txt w130' />";
		$item = "$iinp<span class='fldicon fdate' onClick=\"WdatePicker({el:'fm[exnext]',dateFmt:'yyyy-MM-dd HH:mm'})\" /></span>";
		glbHtml::fmae_row(lang('flow.cr_runnext'),"$item $slast");
		
		glbHtml::fmae_row(lang('flow.cr_runms'),"<input name='fm[exsecs]' type='text' value='$fm[exsecs]' class='txt w150' maxlength='5' reg='str:5-5' tip='00:00~59:59, ".lang('flow.cr_tip3')."' />00:00~59:59");

		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","kid|".(empty($kid) ? 'is__add' : $kid)));
	}
}

?>



/*******************************************************************************
 File : \code\flow\apis\exd_crawl.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');
$ocfgs = glbConfig::read('outdb','ex');
$tabid = 'exd_crawl';
$job = basReq::val("job"); 
$jcfg = exdBase::getJCfgs('crawl',$job); //print_r($jcfg);

if($view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
					$db->table('exd_crlog')->where("kid='$id'")->delete();
					$db->table('exd_sfield')->where("model='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}

	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
	$list = $db->table($tabid)->order('top')->select(); 
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_model')."</th><th>".lang('flow.title_field')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th>Url</th><th>Url</th><th>".lang('flow.dops_exeu')."</th><th>".lang('flow.title_copy')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  $mdname = $_groups[$r['mod']]['title'];
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'>$mdname</td>\n";
	  echo $cv->Url(lang('flow.title_cfg'),1,"?file=$file&mod=$r[mod]&view=fields&job=$r[kid]&recbk=ref","");
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo $cv->Url(lang('flow.title_set'),1,"$aurl[1]&view=urlset&job=$r[kid]&recbk=ref",'');
	  echo $cv->Url(lang('flow.oi_logs'),1,"$aurl[1]&view=urlist&job=$r[kid]&recbk=ref",''); 
	  echo $cv->Url(lang('flow.cw_crawl'),1,PATH_ROOT."/plus/ajax/exdb.php?act=crawl&mod=$r[mod]&job=$kid&".exdBase::getJSign(),'blank');
	  echo $cv->Url(lang('flow.title_copy'),1,"?file=binc/exd_copy&mod=exd_oimp&kid=$r[kid]&type=tabid&title=$r[title]",lang('flow.oi_copy'),480,360); 
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='11'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array( //api	mod	stype	limit
			'kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','fskip'=>'','fdefs'=>'','cfgs'=>'',
			'mod'=>'news','stype'=>'','limit'=>'10',
		);
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }
		if($_groups[$fm['mod']]['pid']=='docs'){
			if(empty($fm['fskip']))	$fm['fskip'] = "color\nrel_doc\njump";
			//if(empty($fm['fdefs']))	$fm['fdefs'] = "catid=c1234";
		}elseif($_groups[$mod]['pid']=='users'){
			//if(empty($fm['fdefs']))	$fm['fdefs'] = "grade=g1234";
		} //print_r($_groups);
		
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_chrsab','4-12')."'"; 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} 
		
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		$marr = admPFunc::modList(array('docs','users','coms',),'relmod'); 
		$mopt = basElm::setOption($marr,$fm['mod']);		
		$slimit = " &nbsp; limit<input name='fm[limit]' type='text' value='$fm[limit]' class='txt w60' maxlength='5' reg='n+i' tip='".lang('flow.cw_batch')."' />";
		glbHtml::fmae_row(lang('flow.title_model'),"<select name='fm[mod]' class='w150'>$mopt</select>$slimit");
		
		glbHtml::fmae_row(lang('flow.cw_fskip'),"<textarea name='fm[fskip]' rows='5' cols='50' wrap='wrap'>$fm[fskip]</textarea>");
		glbHtml::fmae_row(lang('flow.title_defval'),"<textarea name='fm[fdefs]' rows='5' cols='50' wrap='wrap'>$fm[fdefs]</textarea>");
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea rows='3' cols='50' wrap='wrap'>".lang('flow.exd_skdef')."fieldname=fieldvalue</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","kid|".(empty($kid) ? 'is__add' : $kid)));
	}

}elseif(in_array($view,array('urlset'))){ 
	
	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php'); 
	
	if(!empty($bsend)){
		$msg = lang('flow.msg_upd');
		unset($fm['kid']); 
		exdBase::fldSave($fm,3);
		$db->table($tabid)->data(basReq::in($fm))->where("kid='$job'")->update();
		basMsg::show($msg,"Redir","?file=$file&view=$view&job=$job&mod=$mod&flag=v1"); 
	}

	echo "<div class='h02'>&nbsp;</div>";
	$fm = $jcfg; $fa = array('orgtg1','orgtg2','orgtg3',);
	foreach($fa as $k){ 
		$fm[$k] = basStr::filForm($fm[$k]); //echo "\n\n<br>$jcfg[$k]\n<br>$fm[$k]";
	}
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	echo "\n<tr><th class='tc w150'>$fm[title]</th>\n<th class='tl'>".lang('flow.cw_urlfrom')."</th></tr>\n";
	glbHtml::fmae_row(lang('flow.dops_itemname'),"$fm[title]");
	
	$url = PATH_ROOT."/plus/ajax/exdb.php?act=crawl&mod=$fm[mod]&job=$job&debug=links&".exdBase::getJSign();
	glbHtml::fmae_row(lang('flow.cw_demodetail'),"<input name='fm[odmp]' type='text' value='$fm[odmp]' class='txt w400' maxlength='240' reg='str:12-240' tip='Urleg: http://txjia.com/tip/?2016-1J-DE2G' />");
	glbHtml::fmae_row(lang('flow.cw_baselist'),"<input name='fm[ourl]' type='text' value='$fm[ourl]' class='txt w400' maxlength='240' reg='str:12-240' tip='Urleg: http://txjia.com/tip/?Page=(*)' />");
	glbHtml::fmae_row(lang('flow.cw_pgsrule'),"<input name='fm[opno]' type='text' value='$fm[opno]' class='txt w400' maxlength='240' reg='str:1-120' tip='eg: 1-23' />");
	glbHtml::fmae_row(lang('flow.cw_listdebug'),"<a href='".str_replace('(*)','1',$jcfg['ourl'])."' target='_blank'>".lang('flow.cw_baselist')."</a> # <a href='$url' target='_blank'>".lang('flow.cw_deetlist')."</a> ");
	glbHtml::fmae_row(lang('flow.cw_donelog'),"<textarea name='fm[oplog]' rows='3' cols='50' wrap='wrap'>$fm[oplog]</textarea>");
	
	echo "\n<tr><th class='tc w150'></th>\n<th class='tl'>".lang('flow.cw_getlistrule')."</th></tr>\n";
	exdBase::fldForm($fm,3);

    glbHtml::fmae_row(lang('flow.cw_urlinc'),"<input name='fm[ohas]' type='text' value='$fm[ohas]' class='txt w400' maxlength='240' />");
	glbHtml::fmae_row(lang('flow.cw_urlnoi'),"<textarea name='fm[oskip]' rows='3' cols='50' wrap='wrap'>$fm[oskip]</textarea>");
	glbHtml::fmae_row(lang('flow.cw_urlrep'),"<textarea name='fm[orep]' rows='3' cols='50' wrap='wrap'>$fm[orep]</textarea>");
	glbHtml::fmae_row(lang('flow.cw_urlroot'),"<input name='fm[oroot]' type='text' value='$fm[oroot]' class='txt w400' maxlength='240' />");

	echo "\n<tr><th class='tc w150'></th>\n<th class='tl'>".lang('flow.exd_reurl')."</th></tr>\n";
	$detail = lang('flow.exd_rutip')."{$_cbase['server']['txmao']}/dev.php?"; // xxxx 
	glbHtml::fmae_row(lang('flow.title_note'),"<textarea rows='3' cols='50' wrap='wrap'>$detail</textarea>");
	glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
	glbHtml::fmt_end(array("mod|$mod","job|$job"));
	
}elseif(in_array($view,array('urlist'))){ 
	
	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
	$cfg = array(
		'sofields'=>array('sysid','outurl'),
		'soorders'=>basLang::ucfg('cfgbase.ord_com2'),
		//'soarea'=>array('jifen','数量'),
		'kid'=>'sysid',
	);
	$dop = new dopExtra('exd_crlog',$cfg); //print_r($dop); 
	
	// 删除操作
	if(!empty($bsend)){
		$vbak = $view;
		$view = 'del_b3';
		require(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
		$view = $vbak;
	} 
	
	$umsg = $msg ? "<span class='cF00'>$msg</span>" : '';
	$dop->so->whrstr .= " AND `kid` ='$job'";
	$dop->sobar(lang('flow.cw_crlogs')." $msg",50,'-1',array('job'=>$job));

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>SysID</th><th>OutUrl</th><th>Done</th><th>atime</th><th>etime</th><th>".lang('flow.op_upd')."</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['sysid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$r[sysid]</td>\n";
		  echo $cv->Url('Link',1,"$r[outurl]",'blank');
		  echo "<td class='tc'>$r[done]</td>\n";
		  echo $cv->Time($r['atime'],$td=1);
		  echo $cv->Time($r['etime'],$td=1);
		  echo $cv->Url(lang('flow.op_upd'),1,PATH_ROOT."/plus/ajax/exdb.php?act=crawl&mod=$jcfg[mod]&job=$r[kid]&sysid=$r[sysid]&".exdBase::getJSign(),'blank');
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod","job|$job","view|$view"));
	
}elseif(in_array($view,array('fields','fset'))){ 
	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
}

?>



/*******************************************************************************
 File : \code\flow\apis\exd_oimp.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');
$ocfgs = glbConfig::read('outdb','ex');
$tabid = 'exd_oimp'; 
$job = basReq::val("job"); 
$jcfg = exdBase::getJCfgs('oimp',$job); //print_r($jcfg);

if($view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
					$db->table('exd_oilog')->where("kid='$id'")->delete();
					$db->table('exd_sfield')->where("model='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}

	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
	$list = $db->table($tabid)->order('top')->select(); 
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.oi_from')."</th><th>".lang('flow.title_model')."</th><th>".lang('flow.title_field')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th>".lang('flow.dops_exeu')."</th><th>".lang('flow.oi_logs')."</th><th>".lang('flow.title_copy')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  $mdname = $_groups[$r['mod']]['title'];
	  $frname = @$ocfgs['list'][$r['odb']];
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'>$frname</td>\n";
	  echo "<td class='tc'>$mdname</td>\n";
	  echo $cv->Url(lang('flow.title_cfg'),1,"?file=$file&mod=$r[mod]&view=fields&job=$r[kid]&recbk=ref","");
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref",""); 
	  echo $cv->Url(lang('flow.oi_imp'),1,PATH_ROOT."/plus/ajax/exdb.php?act=oimp&mod=$r[mod]&job=$kid&".exdBase::getJSign(),'blank');
	  echo $cv->Url(lang('flow.oi_logs'),1,"$aurl[1]&view=loglist&job=$r[kid]&recbk=ref",'');
	  echo $cv->Url(lang('flow.title_copy'),1,"?file=binc/exd_copy&mod=exd_oimp&kid=$r[kid]&type=tabid&title=$r[title]",lang('flow.oi_copy'),480,360);  
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='11'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array( //api	mod	stype	limit
			'kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','fskip'=>'','fdefs'=>'','cfgs'=>'',
			'odb'=>'','osql'=>'','kname'=>'','ktype'=>'int','ktime'=>'int','mod'=>'news','stype'=>'','limit'=>'10',
		);
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }
		if($_groups[$fm['mod']]['pid']=='docs'){
			if(empty($fm['fskip']))	$fm['fskip'] = "color\nrel_doc\njump";
			//if(empty($fm['fdefs']))	$fm['fdefs'] = "catid=c1234";
		}elseif($_groups[$mod]['pid']=='users'){
			//if(empty($fm['fdefs']))	$fm['fdefs'] = "grade=g1234";
		} //print_r($_groups);
		
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_chrsab','4-12')."'"; 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} 
		
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		$odbopt = basElm::setOption($ocfgs['list'],$fm['odb']);
		glbHtml::fmae_row(lang('flow.oi_fdb'),"<select name='fm[odb]' class='w150'>$odbopt</select>"); 
		glbHtml::fmae_row(lang('flow.oi_fsql'),"<textarea name='fm[osql]' rows='5' cols='50' wrap='wrap'>$fm[osql]</textarea>");
		$ops = array('int'=>lang('flow.oi_int'),'val'=>lang('flow.oi_chr'),);
		$iktype = " &nbsp; ".lang('flow.title_type')."<select name='fm[ktype]' class='w60'>".basElm::setOption($ops,$fm['ktype'])."</select>"; 	
		glbHtml::fmae_row(lang('flow.oi_kfield'),"<input name='fm[kname]' type='text' value='$fm[kname]' class='txt w150' maxlength='24' reg='tit:2-24' tip='".lang('admin.fad_chrsab','2-24')."' />$iktype");
		glbHtml::fmae_row(lang('flow.oi_tfield'),"<input name='fm[ktime]' type='text' value='$fm[ktime]' class='txt w150' maxlength='24' reg='tit:2-24' tip='".lang('admin.fad_chrsab','2-24')."' />");
		
		$marr = admPFunc::modList(array('docs','users','coms',),'relmod'); 
		$mopt = basElm::setOption($marr,$fm['mod']);		
		$slimit = " &nbsp; limit<input name='fm[limit]' type='text' value='$fm[limit]' class='txt w60' maxlength='5' reg='n+i' tip='".lang('admin.oi_limit')."' />";
		glbHtml::fmae_row(lang('flow.title_model'),"<select name='fm[mod]' class='w150'>$mopt</select>$slimit");

		glbHtml::fmae_row(lang('flow.oi_skip'),"<textarea name='fm[fskip]' rows='5' cols='50' wrap='wrap'>$fm[fskip]</textarea>");
		glbHtml::fmae_row(lang('flow.title_defval'),"<textarea name='fm[fdefs]' rows='5' cols='50' wrap='wrap'>$fm[fdefs]</textarea>");
		$msg = lang('flow.exd_imtip');
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea rows='3' cols='50' wrap='wrap'>$msg</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","kid|".(empty($kid) ? 'is__add' : $kid)));
	}

}elseif(in_array($view,array('loglist'))){ 
	
	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
	$cfg = array(
		'sofields'=>array('sysid','outid'),
		'soorders'=>basLang::ucfg('cfgbase.ord_com2'),
		//'soarea'=>array('jifen','数量'),
		'kid'=>'sysid',
	);
	$dop = new dopExtra('exd_oilog',$cfg); //print_r($dop); 
	
	// 删除操作
	if(!empty($bsend)){
		$vbak = $view;
		$view = 'del_b3';
		require(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
		$view = $vbak;
	} 
	
	$umsg = $msg ? "<span class='cF00'>$msg</span>" : '';
	$dop->so->whrstr .= " AND `kid` ='$job'";
	$dop->sobar("[".lang('flow.oi_tlog')."] $msg",50,'-1',array('job'=>$job));

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	$oukey = $jcfg['ktype']=='int' ? 'OutInt' : 'OutID';
	echo "<th>".lang('flow.title_select')."</th><th>SysID</th><th>$oukey</th><th>Done</th><th>atime</th><th>etime</th><th>".lang('flow.op_upd')."</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['sysid'];
		  $ouid = $jcfg['ktype']=='int' ? $r['ouint'] : $r['outid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$r[sysid]</td>\n";
		  echo "<td class='tc'>$ouid</td>\n"; 
		  echo "<td class='tc'>$r[done]</td>\n";
		  echo $cv->Time($r['atime'],$td=1);
		  echo $cv->Time($r['etime'],$td=1);
		  echo $cv->Url(lang('flow.op_upd'),1,PATH_ROOT."/plus/ajax/exdb.php?act=oimp&mod=$jcfg[mod]&job=$r[kid]&sysid=$r[sysid]&".exdBase::getJSign(),'blank');
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod","job|$job","view|$view"));
	
}elseif(in_array($view,array('fields','fset'))){ 
	include(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
}

?>



/*******************************************************************************
 File : \code\flow\apis\exd_psyn.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');
$ocfgs = glbConfig::read('outdb','ex');
$tabid = 'exd_psyn'; 
$job = basReq::val("job"); 
$jcfg = exdBase::getJCfgs('psyn',$job); //print_r($jcfg); 

if($view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
					$db->table('exd_pslog')->where("kid='$id'")->delete();
					$db->table('exd_sfield')->where("model='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}

	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.sy_add')."\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	$links = admPFunc::fileNav($file,'exd_psyn');
	glbHtml::tab_bar(lang('flow.sy_plan')."<span class='span ph5'>|</span>$lnkadd","$links",50);	
	$list = $db->table($tabid)->order('top')->select(); //->where("pid='$pid'")
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_model')."</th><th>api</th><th>limit</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th>".lang('flow.dops_exeu')."</th><th>".lang('flow.oi_logs')."</th><th>".lang('flow.title_copy')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  $mdname = $_groups[$r['mod']]['title'];
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'>$mdname</td>\n";
	  echo $cv->Url('ApiUrl',1,"$r[api]",'blank');
	  echo "<td class='tc'>$r[limit]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo $cv->Url(lang('flow.dops_exeu'),1,PATH_ROOT."/plus/ajax/exdb.php?act=psyn&mod=$r[mod]&job=$kid&".exdBase::getJSign(),'blank');
	  echo $cv->Url(lang('flow.oi_logs'),1,"$aurl[1]&view=loglist&job=$r[kid]&recbk=ref",''); 
	  echo $cv->Url(lang('flow.title_copy'),1,"?file=binc/exd_copy&mod=exd_oimp&kid=$r[kid]&type=tabid&title=$r[title]",lang('flow.oi_copy'),480,360); 
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='10'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array( //api	mod	stype	limit
			'kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','fskip'=>'','fdefs'=>'','cfgs'=>'',
			'api'=>$ocfgs['psyn']['server'],'mod'=>'news','stype'=>'','limit'=>'100',
		);
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }
		
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_chrsab','4-12')."'"; 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} 
		
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		glbHtml::fmae_row(lang('flow.sy_apiurl'),"<input name='fm[api]' type='text' value='$fm[api]' class='txt w400' maxlength='240' reg='str:12-240' tip='".lang('flow.sy_tipapi')."' />");
		$marr = admPFunc::modList(array('docs','users','coms',),'relmod'); 
		$mopt = basElm::setOption($marr,$fm['mod']);		
		$slimit = " &nbsp; limit<input name='fm[limit]' type='text' value='$fm[limit]' class='txt w60' maxlength='5' reg='n+i' tip='".lang('flow.sy_limit')."' />";
		glbHtml::fmae_row(lang('flow.title_model'),"<select name='fm[mod]' class='w150'>$mopt</select>$slimit");
		if(!empty($kid)){ 
			$mcfg = glbConfig::read($fm['mod']); 
			$topt = comTypes::getOpt($mcfg['i'],$fm['stype'],'',0); 
			glbHtml::fmae_row(lang('flow.sy_type'),"<select name='fm[stype]' class='w150'>$topt</select> ".lang('flow.sy_tipnul'));
		}
		glbHtml::fmae_row(lang('flow.oi_skip'),"<textarea name='fm[fskip]' rows='5' cols='50' wrap='wrap'>$fm[fskip]</textarea>");
		glbHtml::fmae_row(lang('flow.title_defval'),"<textarea name='fm[fdefs]' rows='5' cols='50' wrap='wrap'></textarea>");
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea rows='3' cols='50' wrap='wrap'>".lang('flow.exd_skdef')."fieldname=fieldvalue</textarea>");
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","kid|".(empty($kid) ? 'is__add' : $kid)));
	}

}elseif(in_array($view,array('loglist'))){ 
	
	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.sy_add')."\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	$links = admPFunc::fileNav($file,'exd_psyn');
	glbHtml::tab_bar(lang('flow.sy_plan')."<span class='span ph5'>|</span>$lnkadd","$links",50);	
	$cfg = array(
		'sofields'=>array('sysid','outid'),
		'soorders'=>basLang::ucfg('cfgbase.ord_com2'),
		//'soarea'=>array('jifen','数量'),
		'kid'=>'sysid',
	);
	$dop = new dopExtra('exd_pslog',$cfg); //print_r($dop); 
	
	// 删除操作
	if(!empty($bsend)){
		$vbak = $view;
		$view = 'del_b3';
		require(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
		$view = $vbak;
	} 
	
	$umsg = $msg ? "<span class='cF00'>$msg</span>" : '';
	$dop->so->whrstr .= " AND `kid` ='$job'";
	$dop->sobar("[".lang('flow.sy_tlog')."] $msg",50,'-1',array('job'=>$job));

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>SysID</th><th>OutID</th><th>Done</th><th>atime</th><th>etime</th><th>".lang('flow.op_upd')."</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['sysid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$r[sysid]</td>\n";
		  echo "<td class='tc'>$r[outid]</td>\n"; 
		  echo "<td class='tc'>$r[done]</td>\n";
		  echo $cv->Time($r['atime'],$td=1);
		  echo $cv->Time($r['etime'],$td=1);
		  echo $cv->Url(lang('flow.op_upd'),1,PATH_ROOT."/plus/ajax/exdb.php?act=psyn&mod=$mod&job=$r[kid]&sysid=$r[sysid]&".exdBase::getJSign(),'blank');
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod","job|$job","view|$view"));

}

?>



/*******************************************************************************
 File : \code\flow\apis\exd_share.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');
$ocfgs = glbConfig::read('outdb','ex');

if(in_array($view,array('list','set'))){
	$lnkadd = admPFunc::fileNav($view,'exd_share');
	$links = admPFunc::fileNav($file,'exd_psyn');
	glbHtml::tab_bar("[".lang('flow.sh_title')."]<span class='span ph5'>#</span>$lnkadd","$links",50);
}
//echo $mod;

if($view=='set'){
	
	$vbak = $view;
	$view = 'set_a2';
	require(dirname(dirname(__FILE__)).'/binc/exd_inc1.php');
	$view = $vbak;

}elseif($view=='list'){

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.sh_json')."</th><th>".lang('flow.sh_tpl')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	$gma = array('docs','users','coms'); $gmold = '';
	foreach($gma as $gm){ 
	foreach($_groups as $mod=>$gv){
	  $kid = "$mod"; if($gv['pid']!==$gm) continue;
	  $mcfg = glbConfig::read($mod); 
	  if($gmold!=$gv['pid']){
	  	echo "<tr><td class='tc fB' colspan='3'>{$_groups[$gv['pid']]['title']}</td></tr>";
	  }
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$kid</td>\n";
	  echo "<td class='tc'>$gv[title]</td>\n";
	  echo $cv->Url(lang('flow.sh_json'),1,"?file=$file&view=json&mod=$mod","blank");
	  echo $cv->Url(lang('flow.sh_tpl'),1,"?file=$file&view=tpl&mod=$mod","blank");
	  echo "<td class='tl'><input type='text' value='".str_replace(array("\n","\r",";;"),array(";",";",";"),@$mcfg['cfgs'])."' class='txt w300' /></td>\n";
	  echo "</tr>";
	  $gmold = $gv['pid']; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='6'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": (null) &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif(in_array($view,array('json','tpl'))){
	
	$msg1 = $view=='json' ? lang('flow.sh_tip1') : lang('flow.sh_tip2');
	if(in_array($_groups[$mod]['pid'],array('docs','users'))){
		$dop = new dopBase(glbConfig::read($mod)); 
		$ops = $dop->fmType('stype',150); $ops = str_replace(array("fm[stype]","reg='"),array("stype","'"),$ops); //
		$s_type = ($_groups[$mod]['pid']=='docs' ? lang('flow.title_cata') : lang('flow.title_grade')).": $ops";
	}else{
		$s_type = lang('flow.sh_cg').": ---";
	}
	$stype = basReq::val('stype');
	$limit = basReq::val('limit',10);
	$order = basReq::val('order',substr($_groups[$mod]['pid'],0,1)."id:".($view=='json' ? 'ASC' : 'DESC'));
	$offset = basReq::val('offset');
	$cut = basReq::val('cut','title,compony');
	$clen = basReq::val('clen',48);
	$ret = basReq::val('ret','html');
	$tpl = basReq::val('tpl','','');
	$tpldef = $tpl ? $tpl : "<li><a href='{rhome}/run/chn.php?$mod.{kid}'>{title}</a></li>";
	$dis = $view=='json' ? 'disabled' : '';

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist'); //
		echo "\n<tr><th class='wp40'>".lang('flow.sh_whr')."</th>\n<th class='wp60'>".lang('flow.sh_show')."</th></tr>\n";
		echo "\n<tr><td>".lang('flow.sh_mod').": $mod {$_groups[$mod]['title']}</td>\n
		            <td>".lang('flow.sh_mode').": {$view} $msg1</td></tr>\n";
		echo "\n<tr><td>$s_type</td>\n
		            <td>cut: <input name='cut' type='text' value='$cut' class='txt w120' $dis/> &nbsp; clen: <input name='clen' type='text' value='$clen' class='txt w40' $dis/></td></tr>\n";
		echo "\n<tr><td>limit: <input name='limit' type='text' value='$limit' class='txt w150' /></td>\n
		            <td>ret: <input name='ret' type='text' value='$ret' class='txt w120'  $dis/>eg: html,js</td></tr>\n";
		echo "\n<tr><td>order: <input name='order' type='text' value='$order' class='txt w150' /></td>\n
		            <td>tpl: <input name='tpl' type='text' value=\"$tpldef\" class='txt w320' $dis/></td></tr>\n";
		echo "\n<tr><td>offset: <input name='offset' type='text' value='$offset' class='txt w150' tip='eg: 2016-2e-1234' /></td>\n
		            <td class='tc'><input name='bsend' class='btn' type='submit' value=".lang('flow.dops_send')." /></td></tr>\n";
	if(!empty($bsend)){	
		// mod,stype,limit(1-100),order(did:DESC),offset,tpl,cut,clen,ret(html/js),
		$entpl = comParse::urlBase64($tpl); 
		$usign = exdBase::getJSign();
		$ptpl = $view=='json' ? '' : "&cut=$cut&clen=$clen&ret=$ret&tpl=".($tpl ? $entpl : '');
		$apiurl = $_cbase['run']['roots']."/plus/ajax/exdb.php?mod=$mod&act=".($view=='json' ? 'pull' : 'show')."";
		$apiurl .= "&stype=$stype&limit=$limit&order=$order&offset=$offset".$ptpl."&".$usign;
		echo "\n<tr><td colspan=2 style='border-top:5px solid #99F;'>".lang('flow.sh_url').": <input type='text' value=\"$apiurl\" class='txt w700' /></td></tr>\n";	
		if($view=='tpl') echo "\n<tr><td colspan=2>".lang('flow.sh_ctpl').": <input type='text' value=\"comParse::urlBase64(&quot;$tpl&quot;) = [$entpl]\" class='txt w700' /></td></tr>\n";	
		echo "\n<tr><td colspan=2>".lang('flow.sh_surl').": <input type='text' value=\"$usign\" class='txt w700' /></td></tr>\n";	
		echo "\n<tr><td colspan=2 style='border-top:5px solid #99F;'>".lang('flow.sh_res').": <iframe src='$apiurl' style='width:100%; height:640px; overflow-y:scroll; overflow-x:hidden;' frameBorder=0></iframe></td></tr>\n";	
	}

	glbHtml::fmt_end(); //array("xxx|xxx")
	
}else{
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	
	glbHtml::fmt_end(array("mod|$mod"));
		
}

?>



/*******************************************************************************
 File : \code\flow\apis\exp_indoc.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$tabid = 'bext_paras';
$pid = empty($pid) ? 'indoc_tpl' : $pid;

if($view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}

	$linka = admPFunc::fileNav($pid,'indoc'); $gname = admPFunc::fileNavTitle($pid,'indoc');

	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	glbHtml::tab_bar("[{$gname}]".lang('flow.exp_set')."<span class='span ph5'>|</span>$lnkadd","$linka",30);
	
	$list = $db->table($tabid)->where("pid='$pid'")->order('top')->select();
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo "<td class='tl'><input type='text' value='$r[detail]' class='txt w360' /></td>\n";
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='6'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','detail'=>'','cfgs'=>'','numa'=>'0');
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }

		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_uid41258')."'"; //url='".PATH_ROOT."/plus/ajax/cajax.php?act=modExists' 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} // paymode_, numa,  附加金额
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");

		//$cfgs = strstr($pid,'paymode_') ? "图标地址<input name='fm[cfgs]' type='text' value='$fm[cfgs]' class='txt w150' maxlength='12' tip='图标文件名或css' />" : '';
		//glbHtml::fmae_row('附加金额',"<input name='fm[numa]' type='text' value='$fm[numa]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  /> &nbsp; $cfgs");

		glbHtml::fmae_row(lang('flow.exp_detail'),"<textarea name='fm[detail]' rows='8' cols='50' wrap='off'>$fm[detail]</textarea>");
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[pid]|$pid","kid|".(empty($kid) ? 'is__add' : $kid),"cid|$cid"));
	}
}

?>



/*******************************************************************************
 File : \code\flow\apis\exp_order.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$tabid = 'bext_paras';
$pid = empty($pid) ? 'paymode_cn' : $pid;

if($view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){ 
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}

	$linka = admPFunc::fileNav($pid,'ordcn'); $gname = admPFunc::fileNavTitle($pid,'ordcn');
	$linkb = admPFunc::fileNav($pid,'orden'); $gnamf = admPFunc::fileNavTitle($pid,'orden');

	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	glbHtml::tab_bar("[{$gname}{$gnamf}]".lang('flow.exp_set')."<span class='span ph5'>|</span>$lnkadd","$linka<br>$linkb",30);
	
	$list = $db->table($tabid)->where("pid='$pid'")->order('top')->select();
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo "<td class='tl'><input type='text' value='$r[detail]' class='txt w360' /></td>\n";
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='6'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','detail'=>'','cfgs'=>'','numa'=>'0');
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }

		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_uid41258')."'"; //url='".PATH_ROOT."/plus/ajax/cajax.php?act=modExists' 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} // paymode_, numa,  附加金额
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");

		$cfgs = strstr($pid,'paymode_') ? "".lang('admin.ord_icon')."<input name='fm[cfgs]' type='text' value='$fm[cfgs]' class='txt w150' maxlength='12' tip='".lang('admin.ord_icocss')."' />" : '';
		glbHtml::fmae_row(lang('flow.ord_extfee'),"<input name='fm[numa]' type='text' value='$fm[numa]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  /> &nbsp; $cfgs");

		glbHtml::fmae_row(lang('flow.exp_detail'),"<textarea name='fm[detail]' rows='8' cols='50' wrap='off'>$fm[detail]</textarea>");
		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[pid]|$pid","kid|".(empty($kid) ? 'is__add' : $kid),"cid|$cid"));
	}
}

?>



/*******************************************************************************
 File : \code\flow\apis\exp_qaset.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');
require(DIR_CODE.'/tpls/umc/b_func/tex_faqs.php');

$tabid = 'bext_paras';
$view = empty($view) ? 'uset' : $view;

$linka = admPFunc::fileNav($view,'faqs'); $gname = admPFunc::fileNavTitle($view,'faqs');
glbHtml::tab_bar("{$gname}","$linka",30);

if($act){
	if($act=='_allt'){
		tex_faqs::statTypes('upd');	
	}else{
		tex_faqs::statTags('upd');
	}
	
}

glbHtml::fmt_head('fmlist',"?",'tblist');
$mcfg = glbConfig::read('faqs'); 
$ucfg = array('_allt'=>lang('flow.qa_alltype'),'_tags'=>lang('flow.qa_alltag'),);
$cfgs = tex_faqs::statTypes();
foreach($cfgs as $key=>$v){
	$title = isset($ucfg[$key]) ? $ucfg[$key] : $mcfg['i'][$key]['title'];
	$link = isset($ucfg[$key]) ? " &nbsp; -=> <a href='?file=$file&view=$view&act=$key'>".lang('flow.qa_reset')."</a>" : '';
	echo "\n<tr><td class='tc w150'>{$title}: </td>\n<td>$cfgs[$key] [$key] $link </td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));

if($view=='uset'){
	
}elseif($view=='list'){
	
}elseif($view=='form'){
	
}

?>


/*******************************************************************************
 File : \code\flow\apis\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\flow\apis\jifen_plan.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$tabid = 'bext_paras'; //$tabid = 'bext_jifen'; die('coming soon!');
$pid = empty($pid) ? 'jifen_grade' : $pid;

if(empty($dialog)){
	$gnarr = basLang::ucfg('cfgbase.jifen_ops'); 
	$gname = @$gnarr[$pid];
	$lnkupd = "<a href='$aurl[1]&view=upd' onclick='return winOpen(this,\"".lang('flow.jf_updcfg')."\");'>&lt;&lt;".lang('flow.jf_upd')."</a>";
	$lnkupd = in_array($pid,array('jifen_grade')) ? "$lnkupd<span class='span ph5'>|</span>" : ''; 
	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.jf_add')."&gt;&gt;</a>";
	$lnkadd = in_array($pid,array('jifen_grade')) ? "<span class='span ph5'>|</span>$lnkadd" : ''; 
	$linkp = admPFunc::fileNav($pid,'cron_jifen');
	$links = admPFunc::fileNav($file,'cron_plan');
	glbHtml::tab_bar("$linkp".(in_array($pid,array('jifen_logs')) ? '' : "<br>{$lnkupd}[$gname]$lnkadd"),"$links",50);	
}
if($view=='upd'){
	
	extJifen::update(); 
	echo "\n<hr>End! ".basDebug::runInfo();
	
}elseif($pid=='jifen_grade' && $view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}
	
	$list = $db->table($tabid)->where("pid='$pid'")->order('top')->select();
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.jf_jfcnt')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'>$r[numa]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo "<td class='tl'><input type='text' value='$r[note]' class='txt w300' /></td>\n";
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='7'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($pid=='jifen_model' && $view=='list'){
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th>+".lang('flow.jf_jifen')."</th><th>-".lang('flow.jf_jifen')."</th><th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.title_note')."</th>\n";
	$gma = array('docs','coms','users'); $gmold = '';
	foreach($gma as $gm){ 
	foreach($_groups as $mod=>$gv){
	  $kid = "$mod"; if($gv['pid']!==$gm) continue;
	  $mcfg = glbConfig::read($mod); 
	  $numa = empty($mcfg['cradd']) ? 0 : $mcfg['cradd'];
	  $numb = empty($mcfg['crdel']) ? 0 : $mcfg['crdel'];
	  if($gmold!=$gv['pid']){
	  	echo "<tr><td class='tc fB' colspan='3'>{$_groups[$gv['pid']]['title']}</td></tr>";
	  }
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$kid</td>\n";
	  echo "<td class='tc'>$gv[title]</td>\n";
	  echo "<td class='tc'>$numa</td>\n";
	  echo "<td class='tc'>$numb</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"?file=admin/groups&mod=$gm&view=gform&kid=$mod&recbk=ref","");
	  echo "<td class='tl'><input type='text' value='".str_replace(array("\n","\r",";;"),array(";",";",";"),@$mcfg['cfgs'])."' class='txt w300' /></td>\n";
	  echo "</tr>";
	  $gmold = $gv['pid']; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='6'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": (null) &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($pid=='jifen_logs' && $view=='list'){
	
	$cfg = array(
		'sofields'=>array('act','uto','jfmod'),
		'soorders'=>basLang::ucfg('cfgbase.ord_jifen'),
		//'soarea'=>array('jifen','数量'),
	);
	$dop = new dopExtra('logs_jifen',$cfg); 
	
	// 删除操作
	if(!empty($bsend)){
		require(dirname(dirname(__FILE__)).'/binc/act_ops.php');
	} 
	
	$umsg = $msg ? "<span class='cF00'>$msg</span>" : '';
	$dop->sobar("[".lang('flow.jf_logs')."] $msg",50); //$dop->sobar("xxx",50,'-1',array('job'=>$job));

	// 清理操作
	if(!empty($bsend)&&$fs_do=='dnow'){
		$msg = $dop->opDelnow();
		basMsg::show($msg,'Redir',"?file=$file&pid=$pid&mod=$mod&flag=v1");
	}
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>act</th><th>uto</th><th>jifen</th><th>time</th><th>model</th><th>note</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  $act = $r['act']=='del' ? "<span class='cF00'>$r[act]</span>" : ($r['act']=='add' ? "<span class='c00F'>$r[act]</span>" : $r['act']);
		  if(empty($idfirst)) $idfirst = $kid;
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$act</td>\n";
		  echo "<td class='tc'>$r[uto]</td>\n";
		  echo "<td class='tc'>$r[jifen]</td>\n";
		  echo $cv->Time($r['atime'],$td=1);
		  echo "<td class='tc'>$r[jfmod]</td>\n";
		  echo "<td class='tl'><input type='text' value='".@$r['note']."' class='txt w240' /></td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		glbCUpd::upd_model($mod);
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','note'=>'','detail'=>'','cfgs'=>'','numa'=>'0','numb'=>'0');
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }

		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='".lang('admin.fad_uid41258')."'"; //url='".PATH_ROOT."/plus/ajax/cajax.php?act=modExists' 
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$did' class='txt w150' maxlength='12' reg='key:4-12' $vstr />$ienable");
		} 
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");

		$cfgs = "".lang('flow.ord_icon')."<input name='fm[cfgs]' type='text' value='$fm[cfgs]' class='txt w90' maxlength='12' tip='".lang('flow.ord_icocss')."' />";
		glbHtml::fmae_row(lang('flow.jf_jfcnt2'),"<input name='fm[numa]' type='text' value='$fm[numa]' class='txt w90' maxlength='9' reg='n+i' tip='".lang('flow.jf_l19n')."' /> &nbsp; $cfgs");

		glbHtml::fmae_row(lang('flow.title_note'),"<textarea name='fm[note]' rows='6' cols='50' wrap='wrap'>$fm[note]</textarea>");
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[pid]|$pid","kid|".(empty($kid) ? 'is__add' : $kid),"cid|$cid"));
	}
}

?>



/*******************************************************************************
 File : \code\flow\apis\mail_logs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$cfg = array(
	'sofields'=>array('title','ufrom','uto','detail','stat'),
	'soorders'=>basLang::ucfg('cfgbase.ord_com2'),
	//'soarea'=>array('amount','金额'),
);
$dop = new dopExtra('plus_emsend',$cfg); 

// 删除操作
if(!empty($bsend)){
	require(dirname(dirname(__FILE__)).'/binc/act_ops.php');
} 

$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
$links = admPFunc::fileNav($view=='vcfgs' ? 'vcfgs' : 'vlist','mail');
$dop->sobar("$links$umsg",40,array());

if($view=='vcfgs'){
	
	$cfgs = glbConfig::read('mail','ex');
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	if(empty($cfgs)){
		echo "\n<tr><td class='tc w180'>".lang('flow.cfg_tips').": </td>\n<td>
			".lang('flow.cfg_nocfg').": <br>".lang('flow.cfg_copy').": {code}/cfgs/excfg/ex_mail.php-demo ".lang('flow.cfg_to')." ex_mail.php; <br>".lang('flow.cfg_editip')."
		</td></tr>\n";
	}else{ 
		echo "\n<tr><td class='tc w150'>".lang('flow.cfg_nowcfg').":</td>\n<td>".lang('flow.cfg_nowfile').": {code}/cfgs/excfg/ex_mail.php，
		<a href='?file=admin/ediy&part=edit&dkey=cfgs&dsub=&efile=excfg/ex_mail.php' onclick=\"return winOpen(this,'".lang('flow.cfg_edit')."',780,560);\">".lang('flow.title_edit')."</a></td></tr>\n";
		foreach($cfgs as $key=>$v){
			echo "\n<tr><td class='tc'>{$key}: </td>\n<td>$v</td></tr>\n";
		}
	}
	glbHtml::fmt_end(array("mod|$mod"));
}else{
	// 清理操作
	if(!empty($bsend)&&$fs_do=='dnow'){
		$msg = $dop->opDelnow();
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}  
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>title</th><th>ufrom</th><th>uto</th><th>api</th><th>stat</th><th>aip</th><th>".lang('flow.cfg_optime')."</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$r[title]</td>\n";
		  echo "<td class='tc'>$r[ufrom]</td>\n";
		  echo "<td class='tc'>$r[uto]</td>\n";
		  echo "<td class='tc'>$r[api]</td>\n";
		  echo "<td class='tc'>$r[stat]</td>\n";
		  echo "<td class='tc'>$r[aip]</td>\n";
		  echo "<td class='tc'>".date('Y-m-d H:i',$r['atime'])."</td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));	
}

?>



/*******************************************************************************
 File : \code\flow\apis\pay_logs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$cfg = array(
	'sofields'=>array('ordid','apino','api','expar'),
	'soorders'=>basLang::ucfg('cfgbase.ord_pay'),
	'soarea'=>array('amount',lang('flow.pay_amount')),
);
$dop = new dopExtra('plus_paylog',$cfg); 

// 删除操作
if(!empty($bsend)){
	require(dirname(dirname(__FILE__)).'/binc/act_ops.php');
} 

$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
$links = admPFunc::fileNav($view=='vcfgs' ? 'vcfgs' : 'vlist','pay');
$dop->sobar("$links$umsg",40,array());

if($view=='vcfgs'){

	$cfgs = exvOpay::getCfgs();
	//print_r($cfgs);
	$para = glbDBExt::getExtp('paymode_%');
	//print_r($para);
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.pay_api')."</th><th>".lang('flow.pay_method')."</th><th>".lang('flow.pay_dir')."</th><th>".lang('flow.pay_note')."</th><th>".lang('flow.pay_cfg')."</th></tr>\n";
	foreach($cfgs as $key=>$r){ 
	  $title = isset($para[$key]['title']) ? $para[$key]['title'] : '---';
	  $detail = isset($para[$key]['detail']) ? $para[$key]['detail'] : '---';
	  echo "<td class='tc'>$key</td>\n";
	  echo "<td class='tc'>$r[method]</td>\n";
	  echo "<td class='tc'>{root}/a3rd/$r[dir]</td>\n";
	  echo "<td class='tc'>$title</td>\n";
	  echo "<td class='tc'>$detail</td>\n";
	  echo "</tr>";
	}
	echo "\n<tr><td colspan='5'>
	1. <a href='?file=apis/exp_order&pid=paymode_cn&frame=1' target='_blank'>".lang('flow.pay_pcfg')."</a> <br>
	2. ".lang('flow.pay_2ndoc')."
	
	</td></tr>\n";
	glbHtml::fmt_end(array("mod|$mod"));
	
}else{
	// 清理操作
	if(!empty($bsend)&&$fs_do=='dnow'){
		$msg = $dop->opDelnow();
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>ordid</th><th>apino</th><th>amount</th><th>api</th><th>stat</th><th>".lang('flow.cfg_optime')."</th></tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$r[ordid]</td>\n";
		  echo "<td class='tc'>$r[apino]</td>\n";
		  echo "<td class='tc'>$r[amount]</td>\n";
		  echo "<td class='tc'>$r[api]</td>\n";
		  echo "<td class='tc'>$r[stat]</td>\n";
		  echo "<td class='tc'>".date('Y-m-d H:i',$r['atime'])."</td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));	
}

?>



/*******************************************************************************
 File : \code\flow\apis\seo_push.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$tabid = 'bext_paras'; 
$pid = empty($pid) ? 'seo_sitemap' : $pid;
$seo = new extSeo();

if(empty($dialog)){
	$gnarr = basLang::ucfg('cfgbase.seo_type'); 
	$gname = @$gnarr[$pid];
	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.fl_addin')."[$gname]\");'>".lang('flow.dops_add')."&gt;&gt;</a>";
	$lnkadd = in_array($pid,array('seo_sitemap')) ? "<span class='span ph5'>|</span>$lnkadd" : ''; 
	$linkp = admPFunc::fileNav($pid,'seo_push');
	$linkp = str_replace("&frame=1'","&frame=1' target='_blank'",$linkp);
	glbHtml::tab_bar("[$gname] $lnkadd","$linkp",50);	
}

if($pid=='create'){
	
	$job = basReq::val('job');
	$res = $seo->createSmap($job);
	$file = PATH_HTML."/map/$job";
	$str = $res ? "<a href='$file' target='_'>".lang('flow.pu_cfok')."</a>" : lang('flow.pu_cfng');
	echo "<p class='tc'><br>$str</p>";

}elseif($pid=='push'){
	
	$pfile = basReq::val('pfile');
	$plink = basReq::val('plink');
	if($pfile){ //echo "$pfile";
		$res = $seo->bpushRun($pfile);
	}elseif($plink){ //echo "$plink";
		$res = $seo->bpushRun(0,$plink);
	}
	$go = "<a href='?file=$file&pid=seo_pset'>".lang('flow.dops_back')."</a>";
	echo "<p class='tc'><br>".@$res['msg']."<br>$go</p>";

}elseif($pid=='seo_sitemap' && $view=='list'){

	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&mod=$mod&flag=v1");
	}
	
	$list = $db->table($tabid)->where("pid='seo_sitemap'")->order('top')->select();
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>".lang('flow.pu_mapfile')."</th><th>".lang('flow.title_name')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_enable')."</th><th>".lang('flow.title_edit')."</th><th class='wp15'>".lang('flow.pu_cv2')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'>$r[title]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref",""); 
	  $url1 = $cv->Url(lang('flow.pu_create'),0,"?file=$file&pid=create&job=$kid",lang('flow.pu_create'));
	  $url2 = file_exists(DIR_HTML."/map/$kid") ? "<a href='".PATH_HTML."/map/$kid' target='_blank'>".lang('flow.pu_view')."</a>" : lang('flow.pu_view');
	  echo "<td class='tc'>$url1/$url2</td>\n";
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='7'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($pid=='seo_pset' && $view=='list'){
	
	$msg = '';	
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.msg_pkitem');
		else{
			foreach($fs as $id=>$v){
				$msg = lang('flow.msg_set');
				if($fs_do=='del'){ 
					$db->table($tabid)->where("kid='$id'")->delete();
				}elseif($fs_do=='show'){ 
					$db->table($tabid)->data(array('enable'=>'1'))->where("kid='$id'")->update();  
				}elseif($fs_do=='upd'){ 
					$fm['push_time']['detail'] = strtotime($fm['push_time']['detail']);
					$db->table($tabid)->data(basReq::in($fm[$id]))->where("kid='$id'")->update();
				}elseif($fs_do=='stop'){ 
					$db->table($tabid)->data(array('enable'=>'0'))->where("kid='$id'")->update(); 
				}
			}
		}
		basMsg::show($msg,'Redir',"?file=$file&pid=$pid");
	}
	
	$list = $seo->bpushCfg();
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>Key</th><th>".lang('flow.title_name')."</th><th class='wp15'>".lang('flow.pu_setv')."</th><th>".lang('flow.title_top')."</th><th>".lang('flow.title_edit')."</th>\n";
	if($list){
	foreach($list as $r){
	  $kid = $r['kid']; 
	  if($kid=='push_time'){
	  	$r['detail'] = empty($r['detail'])? '2005-12-31' : date('Y-m-d H:i:s',$r['detail']);
	  }
	  echo "<tr>\n".$cv->Select($kid);
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tc'><input name='fm[$kid][title]' type='text' value='$r[title]' class='txt w150' /></td>\n";
	  echo "<td class='tl'><input name='fm[$kid][detail]' type='text' value='$r[detail]' class='txt w240' /></td>\n";
	  echo "<td class='tc'><input name='fm[$kid][top]' type='text' value='$r[top]' class='txt w40' /></td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$r[kid]&recbk=ref","");
	  echo "</tr>"; 
	}}
	echo "<tr>\n";
	echo "<td class='tc'><input name='fs_act' type='checkbox' class='rdcb' onClick='fmSelAll(this)' /></td>\n";
	echo "<td class='tr' colspan='6'><span class='cF00 left'>$msg</span>".lang('flow.fl_opbatch').": <select name='fs_do'>".basElm::setOption(lang('flow.op_op4'))."</select> <input name='bsend' class='btn' type='submit' value='".lang('flow.fl_deeltitle')."' /> &nbsp; </td>\n";
	echo "</tr>";
	glbHtml::fmt_end(array("mod|$mod"));

	echo "<div class='h02'>&nbsp;</div>";
	
	glbHtml::fmt_head('fmpush',"$aurl[1]",'tbdata');
	glbHtml::fmae_row(lang('flow.pu_ipush'),lang('flow.pu_slink')." : http://zhanzhang.baidu.com/linksubmit/index");
	glbHtml::fmae_row('API',"http://data.zz.baidu.com/urls?site=your_domain.com&token=your_token");
	
	$mcfg = array('baidu_push.txt'=>'baidu_push.txt'); //
	$topt = basElm::setOption($mcfg,'baidu_push.txt'); 
	glbHtml::fmae_row(lang('flow.pu_pfile'),"<select name='pfile' class='w150'>$topt</select>".lang('flow.pu_tip1')."");
	glbHtml::fmae_row(lang('flow.pu_plink'),"<textarea name='plink' rows='12' cols='50' style='white-space:nowrap; overflow:scroll;' ></textarea><br>".lang('flow.exd_iline').", eg:http://your_domain.com/html/123.htm；");
	glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
	glbHtml::fmae_row(lang('flow.pu_ldemo'),"<a href='http://www.onexin.net/sitemap-xml-to-the-major-method-of-search-engine-submission/' target='_blank'>".lang('flow.pu_tip2')."</a>");
	glbHtml::fmt_end(array("pid|push","dialog|1"));	

}elseif($pid=='seo_plog' && $view=='list'){
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th>\n";
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='form'){
	
	if(!empty($bsend)){
		if($kid=='is__add'){
			if($db->table($tabid)->where("kid='$fm[kid]'")->find()){
				$msg = lang('flow.msg_exists',$fm['kid']);
			}else{
				$msg = lang('flow.msg_add');  
				$db->table($tabid)->data(basReq::in($fm))->insert();
				$id = $fm['kid'];	
			}
		}else{
			$msg = lang('flow.msg_upd');
			unset($fm['kid']); 
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
		} 
		basMsg::show($msg);	
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$kid = '';
		}
		$def = array('kid'=>'','title'=>'','top'=>'888','enable'=>'1','detail'=>'','note'=>'','cfgs'=>"");
		foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }

		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "tip='eg:baidu_map.html, google_map.xml, baidu_push.txt'"; 
			glbHtml::fmae_row(lang('flow.pu_mfname'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150' maxlength='18' reg='key:7-18' $vstr />$ienable");
		} 
		glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='$fm[title]' class='txt w150' maxlength='12' reg='tit:2-12' tip='".lang('admin.fad_tip21246')."'  />$itop");
		glbHtml::fmae_row(lang('flow.pu_modset'),"<textarea name='fm[note]' rows='5' cols='50' wrap='wrap'>$fm[note]</textarea><br>".lang('flow.exd_iline').", eg:news,limit,chn,monthly,0.5；");
		
		glbHtml::fmae_row(lang('flow.pu_itpl'),"<textarea name='fm[cfgs]' rows='5' cols='50' wrap='wrap'>$fm[cfgs]</textarea>");
		glbHtml::fmae_row(lang('flow.pu_ftpl'),"<textarea name='fm[detail]' rows='5' cols='50' wrap='wrap'>$fm[detail]</textarea>");
		
		$dcfgs = " *** ".lang('flow.pu_idemo')." *** <url>\n<loc>(url)</loc>\n<lastmod>(time)</lastmod>\n<changefreq>(freq)</changefreq>\n<priority>(priority)</priority>\n</url>\n";
		$dcfgs .= "\n*** ".lang('flow.pu_hdemo')." *** \n<!DOCTYPE html><html><head>\n<meta charset=\"utf-8\">\n<title>Baidu Sitemap</title>\n</head><body>\n(*)\n</body></html>";
		$dcfgs .= "\n *** ".lang('flow.pu_xdemo')." *** \n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<urlset>\n(*)\n</urlset>";
		glbHtml::fmae_row(lang('flow.pu_fdemo'),"<textarea rows='5' cols='50' wrap='wrap'>$dcfgs</textarea>");
		
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("mod|$mod","fm[pid]|$pid","kid|".(empty($kid) ? 'is__add' : $kid),"cid|$cid"));
	}
}

?>


/*******************************************************************************
 File : \code\flow\apis\sms_logs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$part = basReq::val('part','slogs'); //logs,charge

$cfg = array(
	'sofields'=>($part=='charge' ? array('uto','amount','note') : array('msg','tel','res','api')),
	'soorders'=>basLang::ucfg('cfgbase.ord_smslog'),
	'soarea'=>array('amount',lang('flow.sms_count')),
);
$dop = new dopExtra(($part=='charge' ? 'plus_smcharge' : 'plus_smsend'),$cfg); 

// 删除操作
if(!empty($bsend)){
	require(dirname(dirname(__FILE__)).'/binc/act_ops.php');
} 

$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
$links = admPFunc::fileNav($part,'sms');
$dop->sobar("$links$umsg",40,array());

// 清理操作
if(!empty($bsend)&&$fs_do=='dnow'){
	$msg = $dop->opDelnow();
	basMsg::show($msg,'Redir',"?file=$file&mod=$mod&part=$part&flag=v1");
}
	
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');

echo "<th>".lang('flow.title_select')."</th>";
if($part=='charge'){
	echo "<th>uto</th><th>amount</th><th>note</th><th>time</th><th>ip</th><th>op</th>";
}else{
	echo "<th>msg</th><th>api - keyid / tel</th><th>res@amount/time</th>";
}
echo "</tr>\n";
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $kid = $idend = $r['kid'];
	  if(empty($idfirst)) $idfirst = $kid;
	  echo "<tr>\n".$cv->Select($kid);
	  if($part=='charge'){
		  echo "<td class='tl'>$r[uto]</td>\n";
		  echo "<td class='tc'>$r[amount]</td>\n";
		  echo "<td class='tc'><input type='text' value='$r[note]' class='txt w240'/></td>\n";
		  echo "<td class='tc'>".date('m-d H:i:s',$r['atime'])."</td>\n";
		  echo "<td class='tc'><input type='text' value='$r[aip]' class='txt w120'/></td>\n";
		  echo "<td class='tc'>$r[auser]</td>\n";
	  }else{
		  $msg = basSql::fmtShow($r['msg']);
		  $ext = "$r[api] # $r[kid]";
		  echo "<td class='tl'><textarea cols=60 rows=3>$msg</textarea></td>\n";
		  echo "<td class='tc'>$ext<br><textarea cols=40 rows=2>$r[tel]</textarea></td>\n";
		  echo "<td class='tc'>$r[res] @ $r[amount]<br>".date('m-d H:i:s',$r['atime'])."</td>\n";  
	  }
	  echo "</tr>";
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}	

glbHtml::fmt_end(array("mod|$mod","part|$part"));

?>



/*******************************************************************************
 File : \code\flow\apis\sms_send.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_pub_cfgs.php');

$sms = new extSms(); $sc = $sms->isClosed(); 

$stel = basReq::val('stel','','Safe4');
$smsg = basReq::val('smsg','','Safe4'); 
$act = basReq::val('act',''); 

// 发送操作
if($act=='chargeUp'){ //act=chargeUp&charge=
	$charge = basReq::val('charge'); 
	echo $charge;
}elseif(!empty($bsend)){
	$re = $sms->sendSMS($stel,$smsg,5);
	$msg = $re[1];
} 
$sb = $sc ? array(-3,0) : $sms->getBalance(); //print_r($sms->cnow);

$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
$links = admPFunc::fileNav('send','sms');
glbHtml::tab_bar(lang('flow.ss_title')." $umsg",$links,40);
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');

$links = " &nbsp; ---=&gt; <a ".(empty($sms->cnow['home']) ? '' : "href='{$sms->cnow['home']}'")." target='_blank'>".lang('flow.ss_web')."</a>"; 
if(!empty($sms->cnow['admin'])) $links .= " # <a href='{$sms->cnow['admin']}' target='_blank'>".lang('flow.title_admin')."</a>";
echo "<tr><th></th><th class='tr'>".lang('flow.ss_title')."</th></tr>\n"; 
glbHtml::fmae_row(lang('flow.ss_apib'),$sc ? '<a class=cur>'.lang('flow.ss_close').'!</a>' : "$sb[1]({$sms->cnow['unit']}) [{$sms->cnow['name']}] $links");
glbHtml::fmae_row(lang('flow.ss_tel'),"<textarea name='stel' id='stel' cols='60' rows=4></textarea>");
glbHtml::fmae_row(lang('flow.ss_msg'),"<textarea name='smsg' id='smsg' cols='60' rows=4></textarea>"); 

$send = ($sc||$sb[1]==0) ? lang('flow.ss_tip0') : "<input name='bsend' type='submit' class='btn' value='".lang('flow.ss_send')."' />";
echo "\n<tr><td class='tc' width='25%'>".lang('flow.ss_send')."</td>\n<td class='tl'> &nbsp; ".lang('flow.ss_cnta')."[<span id='jscnt'>0</span>]".lang('flow.ss_cntb')." &nbsp; 
<input name='bsend' type='button' class='btn' value='".lang('flow.ss_set')."' onClick='sms_set()' /> &nbsp; &nbsp; $send </td></tr>";

$note = empty($sms->cnow['note']) ? '' : "<br>".str_replace('{file}',$file,$sms->cnow['note']); 
glbHtml::fmae_row(lang('flow.ss_tips'),lang('flow.ss_tipc')."{$note}");
glbHtml::fmt_end();

echo "<script>
var otel = jsElm.jeID('stel'); 
var omsg = jsElm.jeID('smsg'); 
function sms_set() {
	otel.value = '135-3743-2147';
	omsg.value = '【{$_cbase['sys_name']}】".lang('flow.ss_balance')." $sb[1]({$sms->cnow['unit']}), [{$sms->cnow['name']}]';
	omsg.onblur();
}
omsg.onblur = function(){ jsElm.jeID('jscnt').innerHTML = omsg.value.length; }
</script>";

?>



/*******************************************************************************
 File : \code\flow\apis\_pub_cfgs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pfile','(auto)'); 

$view = empty($view) ? 'list' : $view;
$fs_do = basReq::val('fs_do');
$fs = basReq::arr('fs'); 
#$fm = basReq::arr('fm');

$msg = ''; $cnt = 0; 



/*******************************************************************************
 File : \code\flow\awex\wex_apps.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_wex_cfgs.php');
$_cbase['run']['sobarnav'] = '';

$types = basLang::ucfg('cfgbase.wx_type');
$cnav = basLang::ucfg('cfgbase.wx_nav');

$cfg = array(
	'sofields'=>array('kid','type','appid','api'),
	'soorders'=>array('kid' => 'kid(D)','kid-a' => 'kid(A)'),
	//'soarea'=>array('amount','数量'),
);
$tabid = 'wex_apps';

if($view=='list'){ 

	$dop = new dopExtra($tabid,$cfg); 
	$dop->order = $dop->so->order = basReq::val('order','kid-a'); 
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop'); 
		if(empty($fs) && in_array($fs_do,array('delete','clearact'))) $msg = lang('flow.dops_setitem');
		$cnt = 0; 
		if(empty($msg)){
		  if($fs_do=='delete'){ 
			  foreach($fs as $id=>$v){ 
			  	wysBasic::clearCache($id);
			  	$cnt += $dop->opDelete($id);
			  } 
		  }elseif($fs_do=='clearact'){ 
			  foreach($fs as $id=>$v){
			  	wysBasic::clearCache($id);
			  } 
		  }elseif($fs_do=='clrqrtik'){ //atime<'".($_cbase['run']['stamp']-86400)."'
			  $db->table("wex_qrcode")->where("1=1")->delete(); //atime<'".($_cbase['run']['stamp']-5*60*144)."'
			  $cnt--;
		  }elseif(in_array($fs_do,array('locate','msgget','msgsend'))){ //432000=5day
			  $db->table("wex_$fs_do")->where("atime<'".($_cbase['run']['stamp']-432000)."'")->delete(); 
			  $cnt--;
		  } 
		  
		}
		$cnt && $msg = ($cnt>0) ? "$cnt ".lang('flow.dops_delok') : lang('flow.dops_opok');
	}
	
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	$links = $cv->Url(' | '.lang('awex.add').'&gt;&gt;',0,"$aurl[1]&view=form",lang('awex.addcfg'),480,360); //$links = admPFunc::fileNav('logs','sms');
	$dop->sobar(lang('awex.pids')." $links {$umsg}",50,array());

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>ID</th><th>".lang('flow.title_type')."</th><th>".lang('awex.state')."</th><th>appid:".lang('awex.cfgs')."</th>"; //<th>活动时间</th>
	echo "<th>$cnav[menu]</th><th>$cnav[user]</th><th>$cnav[msg]</th><th>$cnav[kw]</th><th>$cnav[debug]</tr>\n"; //
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  $typeu = $types[$r['type']]; 
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$kid</td>\n";
		  echo "<td class='tc' title='{$r['type']}'>$typeu</td>\n";
		  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
		  #echo "<td class='tc'>".date('Y-m-d H:i',$r['acexp'])."</td>\n";
		  //echo ;配置
		  echo $cv->Url($r['appid'],1,"$aurl[1]&view=form&kid=$kid",lang('awex.ecfg'),480,360);
		  echo "<td class='tc'><a href='?file=awex/wex_menu&wekid=$r[kid]' target='_blank'>$cnav[menu]</a></td>\n";
		  echo "<td class='tc'><a href='?file=awex/wex_user&wekid=$r[kid]' target='_blank'>$cnav[user]</a></td>\n";
		  echo "<td class='tc'><a href='?file=awex/wex_msg3&wekid=$r[kid]' target='_blank'>$cnav[msg]</a></td>\n";
		  echo "<td class='tc'><a href='?file=awex/wex_rkey&wekid=$r[kid]' target='_blank'>$cnav[kw]</a></td>\n";
		  echo "<td class='tc'><a href='".PATH_ROOT."/a3rd/weixin_pay/wedebug.php?kid=$kid' target='_blank'>$cnav[debug]</a></td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend,lang('awex.ops_appid'));
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));
		
}elseif($view=='form'){

	if(!empty($bsend)){
		$appid = $fm['appid'];
		
		if($kid=='is__add'){
			$kid = $fm['kid'];
			if($db->table($tabid)->where("appid='$appid' OR kid='$kid'")->find()){
				$msg = lang('awex.uesed',"$appid/$fmkid");
			}else{
				$msg = lang('flow.msg_add'); //$fm['type'] = 'test';
				$db->table($tabid)->data(basReq::in($fm))->insert();
			}
		}else{
			unset($fm['kid']);
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
			$msg = lang('flow.msg_upd');
		} 
		basMsg::show($msg);	//,'Redir'?file=$file&mod=$mod
	}else{

		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$def = array('kid'=>'','type'=>'test','enable'=>'1','token'=>'','appid'=>'','appsecret'=>'','qrcode'=>'',);
			foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }		
		}
		$ienable = " &nbsp; <input name='fm[enable]' type='hidden' value='0' /><input name='fm_enable' type='hidden' value='$fm[enable]' />";
		$ienable .= lang('flow.title_enable')."<input name='fm[enable]' type='checkbox' class='rdcb' value='1' ".($fm['enable']=='1' ? 'checked' : '')." />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$ienable");
		}else{
			$vstr = "url='".PATH_ROOT."/plus/api/wechat.php?actys=kidExists' tip='".lang('flow.fad_tip31245')."'";
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150' maxlength='12' reg='key:3-12' $vstr />$ienable");
		}
		
		glbHtml::fmae_row(lang('flow.title_type'),"<select id='fm[type]' name='fm[type]' type='text'>".basElm::setOption($types,$fm['type'])."</select>");
		glbHtml::fmae_row('token',"<input name='fm[token]' type='text' value='$fm[token]' class='txt w320' maxlength='96' reg='str:3-96' tip='".lang('awex.seewepf')."' />");
		$vstr = "url='".PATH_ROOT."/plus/api/wechat.php?actys=appidExists&oldval=".@$fm['appid']."' tip='eg:wx???,".lang('awex.seewepf')."'";
		glbHtml::fmae_row('appid',"<input name='fm[appid]' type='text' value='$fm[appid]' class='txt w320' maxlength='96' reg='str:3-96' $vstr/>");
		glbHtml::fmae_row('appsecret',"<input name='fm[appsecret]' type='text' value='$fm[appsecret]' class='txt w320' maxlength='96' reg='str:3-96' tip='".lang('awex.seewepf')."' />");
		glbHtml::fmae_row(lang('awex.qrcode'),"<input name='fm[qrcode]' type='text' value='$fm[qrcode]' class='txt w320' maxlength='96' />");

		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("kid|".(empty($kid) ? 'is__add' : $kid)));
	}
	
}
?>



/*******************************************************************************
 File : \code\flow\awex\wex_menu.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_wex_cfgs.php');

//$types = array('test'=>'测试号','chking'=>'未认证','dingyue'=>'订阅号','fuwu'=>'服务号');
$tabid = 'wex_menu'; //$weapp
$mucfg = wysMenu::getMenuData($weapp); 
$cmop = basLang::ucfg('cfgbase.wx_mop');

if($view=='list'){ 
	
	$flgmusave = basReq::val('musave');
	$flgcreate = basReq::val('create');
	$flggetmnu = basReq::val('getmnu');
	$flgdelete = basReq::val('delete');
	//echo "<pre>"; print_r($fm);
	if(!empty($flgmusave)){
		$whr = "`appid`='$weapp'"; //array('appid'=>$wecfg['appid']);
		foreach($fm as $k=>$v){
			if(empty($v['name'])){
				$db->table($tabid)->where("$whr AND `key`='$k'")->delete();
			}if(isset($mucfg[$k])){ 
				$db->table($tabid)->data(array('name'=>$v['name'],'val'=>$v['val']))->where("$whr AND `key`='$k'")->update();  
			}elseif(!empty($v['name'])){
				$v['kid'] = basKeyid::kidTemp(4).$k;
				$v['key'] = $k;
				$v['appid'] = $wecfg['appid'];
				$db->table($tabid)->data(basReq::in($v))->insert();
			}
		}
		$msg = "$cmop[save] : ".lang('flow.dops_ok');
		$mucfg = wysMenu::getMenuData($weapp); 
	}elseif(!empty($flgcreate)){
		$weixin = new wysMenu($wecfg); 
		$data = $weixin->create($mucfg); 
		$msg = $data['errcode'] ? lang('awex.fail')."<br>([$data[errcode]]$data[errmsg])" : lang('awex.success');
		die("<p class='tc'>$cmop[create] : $msg<br>".lang('awex.close')."<p>");
	}elseif(!empty($flggetmnu)){
		$weixin = new wysMenu($wecfg); 
		$data = $weixin->get(); 
		$menu = '';
		if(empty($data['errcode'])){
			foreach($data as $k=>$v){
				$title = "[$k]".$v['name']; //.''.$v['type'];
				$tiele = empty($v['val']) ? "<b>### $title</b>" : "$title (".$v['type'].")<br>".$v['val']."";
				$menu .= "\n $tiele";
			}
		}
		$msg = empty($data['errcode']) ? lang('awex.success')."<pre>$menu</pre>" : lang('awex.fail')."<br>([$data[errcode]]$data[errmsg])<br>";
		die("<p class='tc'>$cmop[get] : $msg ".lang('awex.close')."<p>");
	}elseif(!empty($flgdelete)){
		$weixin = new wysMenu($wecfg); 
		$data = $weixin->del(); 
		$msg = $data['errcode'] ? lang('awex.fail')."<br>([$data[errcode]]$data[errmsg])" : lang('awex.success');
		die("<p class='tc'>$cmop[del] : $msg<br>".lang('awex.close')."<p>");
	}
	
	echo basJscss::imp('/skin/a_jscss/weixin.js?v=1');
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	glbHtml::tab_bar(lang('awex.pids')."[$wekid] : ".lang('awex.mcfg')." $umsg",$_cbase['run']['sobarnav'],40,'tl');
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>No.</th><th>".lang('awex.title')."</th><th>Key/Url</th>"; 
	echo "<th>".lang('awex.op')."</tr>\n";

	for($i=1;$i<=3;$i++){ for($j=0;$j<=5;$j++){
		$itemstr = ''; $mlen = 7; $imuid = "$i{$j}"; ///*[　][＋][－][｜][├][└]  */
		if($j==0 && $i<=2){
			$icon = "＋&nbsp;";
			$mlen = 4;
		}elseif($j==0 && $i==3){
			$icon = "＋&nbsp;";
			$mlen = 4;
		}elseif($i<=2){
			$icon = "｜ &nbsp; ";
			$icon .= "├-&nbsp;";
		}else{ //$i==3
			$icon = "　 &nbsp; ";
			$icon .= "├-&nbsp;";
		}
		$name = empty($mucfg[$imuid]['name']) ? '' : $mucfg[$imuid]['name'];
		$val = empty($mucfg[$imuid]['val']) ? '' : $mucfg[$imuid]['val'];
		$itemstr .= "<tr>";
		$itemstr .= "<td class='tc'>$imuid</td>\n";
		$itemstr .= "<td class='tl'>$icon<input name='fm[$imuid][name]' id='fm[$imuid][name]' value='$name' size='25' maxlength='".($j==0 ? 4 : 7)."' type='text'></td>\n";
		$itemstr .= "<td class='tl'><input name='fm[$imuid][val]' id='fm[$imuid][val]' value='$val' maxlength='240' type='text' class='w320'></td>";
		$itemstr .= "<td class='tc'><a id='cupick_$imuid' href='javascript:;' onClick=\"wxMenuClear($imuid)\">&lt;&lt;".lang('awex.clear')."</a></td>\n"; 
		$itemstr .= "</tr>";
		echo $itemstr;
	} }
	echo "
		<tr>
		<td>&nbsp;</td>
		<td colspan='2' class='tc' nowrap>
		<input name='musave' class='btn' type='submit' value='$cmop[save]' />
		&nbsp;
		<input name='create' class='btn' type='button' value='$cmop[create]' onclick=\"winOpen('$aurl[1]&create=1','$cmop[create]',360,240);\" />
		&nbsp;
		<input name='getmnu' class='btn' type='button' value='$cmop[get]' onclick=\"winOpen('$aurl[1]&getmnu=1','$cmop[get]',480,360);\" />
		&nbsp;
		<input name='delete' class='btn' type='button' value='$cmop[del]' onclick=\"winOpen('$aurl[1]&delete=1','$cmop[del]',360,240);\" />
		</td>
		<td>&nbsp;</td>
		</tr>";

	glbHtml::fmt_end(array("mod|$mod"));
		
}elseif($view=='form'){
	
}
?>



/*******************************************************************************
 File : \code\flow\awex\wex_msg3.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_wex_cfgs.php');

//$mtab = basReq::val('mtab','get'); //get,send,form
$mtab = $view=='list' ? 'get' : $view; 
$tabid = "wex_msg$mtab"; //$weapp

$cmsg = basLang::ucfg('cfgbase.wx_nmsg');
$tmsg = basLang::ucfg('cfgbase.wx_tmsg');

$mlink = "<p class='tc pv5'>
   <a href='?file=awex/wex_msg3&wekid=$wekid&view=list'>$cmsg[get]</a>
 # <a href='?file=awex/wex_msg3&wekid=$wekid&view=send'>$cmsg[send]</a>
 # <a href='?file=awex/wex_msg3&wekid=$wekid&view=form' onclick=\"return winOpen(this,'$cmsg[ms]',780,560);\">$cmsg[ms]</a>
 
</p>";

if($view=='list'){ 

	$cfg = array(
		'sofields'=>array('openid','detail'), //'appid',
		'soorders'=>array('kid' => 'kid(D)','kid-a' => 'kid(A)'),
		//'soarea'=>array('amount','数量'),
	);
	$dop = new dopExtra($tabid,$cfg); 
	$dop->so->whrstr .= " AND `appid`='$weapp'";
	$dop->order = $dop->so->order = basReq::val('order','kid'); //echo $dop->so->whrstr;
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop'); 
		if(empty($fs) && in_array($fs_do,array('delete','clearact'))) $msg = lang('flow.dops_setitem');
		$cnt = 0; 
		if(empty($msg)){
		  if($fs_do=='delete'){ 
			  foreach($fs as $id=>$v){ 
			  	$cnt += $dop->opDelete($id);
			  } 
		  }
		}
		$cnt && $msg = ($cnt>0) ? "$cnt ".lang('flow.dops_delok') : lang('flow.dops_opok');
	} 
	
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	$dop->sobar("$mlink ".lang('awex.appid')."[$wekid] : ".lang('awex.m3_getlogs')." {$umsg}",40,array(),array('wekid'=>$wekid));

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>".lang('flow.title_type')."</th><th>$cmsg[ct]</th>"; 
	echo "<th>openID</th><th>".lang('awex.m3_time')."</th><th>$cmsg[st]</th><th>$cmsg[nrep]</th></tr>\n"; 
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  $time = date('Y-m-d H:i',$r['atime']);
		  if($r['type']=='text'){ $type = $tmsg['text']; }
		  elseif($r['type']=='image'){ $type = $tmsg['image']; }
		  elseif($r['type']=='news'){ $type = $tmsg['news']; }
		  else{ $type = '---'; }
		  if($r['restate']=='Auto'){ $res = $tmsg['Auto']; }
		  elseif($r['restate']=='Kefu'){ $res = $tmsg['Kefu']; }
		  else{ $res = '---'; }
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$type</td>\n";
		  echo "<td class='tc'>".basStr::filText(basStr::cutWidth($r['detail'],40))."</td>\n"; 
		  echo "<td class='tc'>$r[openid]</td>\n";
		  echo "<td class='tc'>$time</td>\n";
		  echo "<td class='tc'>$res</td>\n"; 
		  echo $cv->Url($cmsg['nrep'],1,"?file=awex/wex_msg3&kid=$kid&view=form&wekid=$wekid",$cmsg['rep']);
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend,"delete|*".lang('awex.m3_delmsg'));
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='send'){ 

	$cfg = array(
		'sofields'=>array('openid','detail'), //'appid',
		'soorders'=>array('kid' => 'kid(D)','kid-a' => 'kid(A)'),
		//'soarea'=>array('amount','数量'),
	);
	$dop = new dopExtra($tabid,$cfg); 
	$dop->so->whrstr .= " AND `appid`='$weapp'";
	$dop->order = $dop->so->order = basReq::val('order','kid'); //echo $dop->so->whrstr;
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop'); 
		if(empty($fs) && in_array($fs_do,array('delete','clearact'))) $msg = lang('flow.dops_setitem');
		$cnt = 0; 
		if(empty($msg)){
		  if($fs_do=='delete'){ 
			  foreach($fs as $id=>$v){ 
			  	$cnt += $dop->opDelete($id);
			  } 
		  }
		}
		$cnt && $msg = ($cnt>0) ? "$cnt ".lang('flow.dops_delok') : lang('flow.dops_opok');
	}
	
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	$dop->sobar("$mlink ".lang('awex.appid')."[$wekid] : ".lang('awex.m3_mslogs')." {$umsg}",40,array(),array('wekid'=>$wekid));
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>".lang('flow.title_type')."</th><th>$cmsg[ct]</th>"; 
	echo "<th>openID</th><th>".lang('awex.m3_time')."</th><th>Url</th><th>media</th></tr>\n"; //media_id	picurl
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  $time = date('Y-m-d H:i',$r['atime']);
		  if($r['type']=='text'){ $type = $tmsg['text']; }
		  elseif($r['type']=='news'){ $type = $tmsg['news']; }
		  else{ $type = '---'; }
		  if(!empty($r['media_id'])){
			  $detail = lang('awex.m3_mdid').': '.$r['media_id'];
		  }elseif(!empty($r['subject'])){ 
			  $detail = lang('awex.m3_title').': '.$r['detail'];
		  }else{
		  	  $detail = $r['detail'];
		  }
		  $url = $r['url'] ? "<a href='$r[url]'>url</a>" : '---';
		  $media = $r['media_id'].$r['picurl']; 
		  $media  || $media = '---';
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$type</td>\n";
		  echo "<td class='tc'>".basStr::filText(basStr::cutWidth($r['detail'],40))."</td>\n"; 
		  echo "<td class='tc'>$r[openid]</td>\n";
		  echo "<td class='tc'>$time</td>\n";
		  echo "<td class='tc'>$url</td>\n";
		   echo "<td class='tc'>$media</td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend,"delete|*".lang('awex.m3_delmsg'));
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));
		
}elseif($view=='form'){

	$kid = basReq::val('kid',''); 
	$openid = basReq::val('openid','');
	$msgtype = basReq::val('msgtype',''); //print_r($fm);
	$groupid = basReq::val('groupid','');
	$doend = basReq::val('doend','');
	//echo "$kid,$openid";
	if(!empty($bsend)){	
		$detail = $fm['detail']; 
		$fm['atime'] = $_cbase['run']['stamp'];
		$fm['appid'] = $wecfg['appid'];
		$fm['kid'] = basKeyid::kidTemp();
		$fm['type'] = $msgtype;
		if($openid && $detail){
			$weixin = new wmpMsgsend($wecfg);
			$data = $weixin->sendText($openid,stripslashes($detail));
			$msg = lang('awex.m3_srep').($data['errcode'] ? lang('awex.fail')."<br>([$data[errcode]]$data[errmsg])" : lang('awex.success'));
			//记录... 
			if(empty($data['errcode'])){
				$kid && $db->table('wex_msgget')->data(array('restate'=>'Kefu'))->where("kid='$kid'")->update();
				$fm['openid'] = $openid;
				$db->table('wex_msgsend')->data(basReq::in($fm))->insert();
			}
		}elseif(!empty($groupid) && $detail){ 
			$weixin = new wmpMsgmass($wecfg);
			$g2id = $groupid==-1 ? 0 : $groupid; 
			$data = $weixin->sendText(stripslashes($detail),$g2id);
			$msg = lang('awex.m3_msend').($data['errcode'] ? lang('awex.fail')."<br>([$data[errcode]]$data[errmsg])" : lang('awex.success'));
			//记录... 
			if(empty($data['errcode'])){
				$fm['openid'] = $groupid;
				$db->table('wex_msgsend')->data(basReq::in($fm))->insert();
			}
		}else{
			$msg = lang('awex.m3_mparam');	
		}
		if($doend){
			basMsg::show("<p class='tc'>$msg<br>".lang('awex.close')."<p>",'die');
		}else{
			basMsg::show($msg);
		}

	}else{

		if($kid){
			$rmsg = $db->table('wex_msgget')->where("kid='$kid'")->find();	
			$openid = $rmsg['openid'];
		}
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		
		if(!empty($openid)){
			define('WERR_RETURN',1);
			$weixin = new wmpUser($wecfg);
			$udata = $weixin->getUserInfo($openid); //print_r($udata);
			if(!empty($udata['errcode'])){
				$utitle = lang('awex.m3_guing').$udata['errcode']." <br>(".$udata['message'];
			}else{
				$utitle = "[".@$udata['city']."]".@$udata['nickname']."";
			}
			glbHtml::fmae_row($cmsg['srep'],"$utitle");
		}else{
			$weixin = new wmpUser($wecfg); //print_r($wecfg);
			$data = $weixin->groupList(); $garr = array();
			foreach($data['groups'] as $k=>$v){
				$k2 = $v['id'] ? $v['id'] : '-1';
				$gname = $k ? lang('awex.m3_togroup',"$k2-{$v['name']}[{$v['count']}]") : lang('awex.m3_toall',$v['count']);
				$garr[$k2] = $gname;
			} // [id] => 0 [name] => 未分组[count] => 1
			$item = "<select id='groupid' name='groupid' type='text' reg='str:1-12' tip='".lang('awex.m3_select')."'>";
			$item .= basElm::setOption($garr,0)."</select>"; 
			glbHtml::fmae_row(lang('awex.m3_msto'),"$item");
		}
		glbHtml::fmae_row($cmsg['ct'],"<textarea name='fm[detail]' rows='6' cols='50' wrap='wrap'></textarea>");
		if(!empty($kid)){
			glbHtml::fmae_row(lang('awex.m3_orgmsg'),"<textarea name='fm_org[detail]' rows='6' cols='50' wrap='wrap' readonly disabled>$rmsg[detail]</textarea>");
		}
		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("kid|$kid","openid|$openid","msgtype|text","doend|$doend"));
		//echo basJscss::jscode('wxKwdsetSence(1,1);');
	}
}
?>	



/*******************************************************************************
 File : \code\flow\awex\wex_rkey.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_wex_cfgs.php');

$types = basLang::ucfg('cfgbase.wx_type');
$cfg = array(
	'sofields'=>array('keyword','detail','picurl'), //'appid',
	'soorders'=>array('keyword' => 'keyword(D)','keyword-a' => 'keyword(A)','top' => 'top(D)','top-a' => 'top(A)'),
	//'soarea'=>array('amount','数量'),
);
$tabid = 'wex_keyword'; //$weapp

if($view=='list'){ 

	$dop = new dopExtra($tabid,$cfg); 
	$dop->so->whrstr .= " AND `appid`='$weapp'";
	$dop->order = $dop->so->order = basReq::val('order','top-a'); 
	if(!empty($bsend)){
		if(empty($fs_do)) $msg = lang('flow.dops_setop'); 
		if(empty($fs) && in_array($fs_do,array('delete','clearact'))) $msg = lang('flow.dops_setitem');
		$cnt = 0; 
		if(empty($msg)){
		  if($fs_do=='delete'){ 
			  foreach($fs as $id=>$v){ 
			  	$cnt += $dop->opDelete($id);
			  } 
		  }
		}
		$cnt && $msg = ($cnt>0) ? "$cnt ".lang('flow.dops_delok') : lang('flow.dops_opok');
	}
	
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	$links = $cv->Url(lang('awex.add').'&gt;&gt;',0,"$aurl[1]&view=form",lang('awex.addcfg')); //$links = admPFunc::fileNav('logs','sms');
	$dop->sobar(lang('awex.appid')."[$wekid] : ".lang('awex.kwset')." | $links {$umsg}",40,array(),array('wekid'=>$wekid));
	
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>".lang('flow.title_select')."</th><th>keyword</th><th>detail</th>"; 
	echo "<th>url</th><th>picurl</th><th>top</th><th>".lang('flow.title_edit')."</tr>\n";
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $kid = $idend = $r['kid'];
		  if(empty($idfirst)) $idfirst = $kid;
		  $keyword = $r['keyword']; if($keyword=='follow_autoreply_info') $keyword = '('.lang('awex.subscribe').')';
		  echo "<tr>\n".$cv->Select($kid);
		  echo "<td class='tc'>$keyword</td>\n";
		  echo "<td class='tc'><input name='fm_[detail]' type='text' value='$r[detail]' class='txt w300' /></td>\n";
		  echo "<td class='tc'><input name='fm_[url]' type='text' value='$r[url]' class='txt w120' /></td>\n";
		  echo "<td class='tc'><input name='fm_[picurl]' type='text' value='$r[picurl]' class='txt w120' /></td>\n";
		  echo "<td class='tc'>$r[top]</td>\n";
		  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&kid=$kid",lang('awex.ecfg'));
		  //echo "<td class='tc'><a href='?file=awex/wex_rkey&kid=$r[kid]' target='_blank'>关键字</a></td>\n";
		  echo "</tr>";
		}
		$dop->pgbar($idfirst,$idend,"delete|*".lang('awex.delkw')."");
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));
		
}elseif($view=='form'){
	
	$fm['appid'] = $weapp;
	if(!empty($bsend)){	
		if($kid=='is__add'){
			$kid = $fm['kid'];
			if($db->table($tabid)->where("kid='$kid'")->find()){
				$msg = lang('awex.uesed',$kid);
			}else{
				$msg = lang('flow.msg_add'); //$fm['type'] = 'test';
				$db->table($tabid)->data(basReq::in($fm))->insert();
			}
		}else{
			unset($fm['kid']);
			$db->table($tabid)->data(basReq::in($fm))->where("kid='$kid'")->update();
			$msg = lang('flow.msg_upd');
		} 
		basMsg::show($msg);	//,'Redir'?file=$file&mod=$mod
	}else{

		echo basJscss::imp('/skin/a_jscss/weixin.js');
		if(!empty($kid)){
			$fm = $db->table($tabid)->where("kid='$kid'")->find();
		}else{
			$def = array('kid'=>'','keyword'=>'','detail'=>'','url'=>'','top'=>'88',);
			foreach($def as $k=>$v){ if(!isset($fm[$k])) $fm[$k] = $v; }		
		}
		$setType = "<label><input type=\"radio\" class=\"radio\" id=\"sence_1\" name='sence_k' onclick='wxKwdsetSence(1)' ".($fm['keyword']==='follow_autoreply_info' ? '' : 'checked').">".lang('awex.kwrep')."</label> &nbsp; &nbsp; \n"
				."<label><input type=\"radio\" class=\"radio\" id=\"sence_0\" name='sence_k' onclick='wxKwdsetSence(0)' ".($fm['keyword']==='follow_autoreply_info' ? 'checked' : '').">".lang('awex.screp')."</label> \n";
		$itop = " &nbsp; ".lang('flow.title_top')."<input name='fm[top]' type='text' value='$fm[top]' class='txt w40' maxlength='5' reg='n+i' tip='".lang('admin.fad_tip25num')."'  />";
		echo "<div class='h02'>&nbsp;</div>";
		glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
		if(!empty($kid)){
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />$itop");
		}else{
			glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='".basKeyid::kidTemp()."' class='txt w150' maxlength='24' reg='str:3-24' />$itop");
		}
		glbHtml::fmae_row(lang('awex.rescan'),"$setType");
		$tip = lang('awex.tip_rkey');
		glbHtml::fmae_row(lang('awex.kwd'),"<input name='fm[keyword]' id='fm[keyword]' type='text' value='$fm[keyword]' ".($fm['keyword']==='follow_autoreply_info' ? 'disabled' : '')." class='txt w320' maxlength='96' reg='str:2-96' tip='$tip' />");		
		glbHtml::fmae_row(lang('awex.cont'),"<textarea name='fm[detail]' rows='6' cols='50' wrap='wrap'>$fm[detail]</textarea>");
		glbHtml::fmae_row('Url',"<input name='fm[url]' type='text' value='$fm[url]' class='txt w320' maxlength='96' />");

		glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
		glbHtml::fmt_end(array("kid|".(empty($kid) ? 'is__add' : $kid)));
		//echo basJscss::jscode('wxKwdsetSence(1,1);');
	}
	
}
?>


/*******************************************************************************
 File : \code\flow\awex\wex_user.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
require(dirname(__FILE__).'/_wex_cfgs.php');

$tabid = 'wex_menu'; //$weapp
$mucfg = wysMenu::getMenuData($weapp); 

if($view=='list'){ 

	echo basJscss::imp('/skin/a_jscss/weixin.js?v=1');
	$umsg = $msg ? "<br><span class='cF00'>$msg</span>" : '';
	glbHtml::tab_bar(lang('awex.appid')."[$wekid] : ".lang('awex.follows')."$umsg",$_cbase['run']['sobarnav'],40,'tl');
	
	echo "<style type='text/css'>li.cF0F a { color: #F0F; }</style>";
	echo "<div id='tip_errors' class='pa5 ma5 h150 f14' style='display:none'></div>";
	glbHtml::fmt_head('fmlist',"?",'tblist');
	basLang::inc('uless', 'wex_user');
	for($i=1;$i<=50;$i++){
		echo "\n<tr id='wu_row$i' style='display:none'><td class='tc'></td><td class='tc'></td><td class='tc'></td><td class='tc'></td><td class='tc'></td><td class='tc'></td><td class='tc'></td><td class='tc'></td></tr>";	
	}
	$tips = "<div class='pa5 ma5 h150 f14'>".lang('awex.tip_uload')."</div>";
	echo "\n<tr><td colspan='8'><div class='pg_bar tc'>$tips</div></td></tr>";
	glbHtml::fmt_end();
	
	$weixin = new wmpUser($wecfg); 
	$data = $weixin->getUserInfoList();
	$jscode = "var wu_total=$data[total], wu_count=$data[count], wu_kid='{$wecfg['kid']}', wu_next='$data[next_openid]', wu_page=1, 
		wu_msgurl='?file=awex/wex_msg3&wekid=$wekid&view=form&doend=1&openid=', wu_urlbase='".PATH_ROOT."/plus/api/wechat.php?', 
		wu_list='".(implode(',',$data['data']['openid']))."'; 
		\nwxGetUserPage(); wxGetPageBar(wu_page);";
	echo basJscss::jscode($jscode);
		
}elseif($view=='form'){
	
}
?>



/*******************************************************************************
 File : \code\flow\awex\_wex_cfgs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
usrPerm::run('pmod','apiweixin');

$view = empty($view) ? 'list' : $view;
$fs_do = basReq::val('fs_do');
$fs = basReq::arr('fs'); 

$msg = ''; $cnt = 0; 

$wekid = basReq::val('wekid'); 
$wecfg = wysBasic::getConfig($wekid); 
$weapp = @$wecfg['appid']; 

$cnav = basLang::ucfg('cfgbase.wx_nav');

$_cbase['run']['sobarnav'] = "<p class='tc pv5'>

 <a href='?file=awex/wex_menu&wekid=$wekid'>$cnav[menu]</a>
 # <a href='?file=awex/wex_user&wekid=$wekid'>$cnav[user]</a>
 # <a href='?file=awex/wex_msg3&wekid=$wekid'>$cnav[msg]</a>
 # <a href='?file=awex/wex_rkey&wekid=$wekid'>$cnav[kw]</a>
 
 # <a href='#?file=awex/wex_vmat&wekid=$wekid' class='c999'>$cnav[wres]</a>
 # <a href='#?file=awex/wex_vweb&wekid=$wekid' class='c999'>$cnav[wweb]</a>
 # <a href='#?file=awex/wex_vshop&wekid=$wekid' class='c999'>$cnav[wshop]</a>
 # <a href='#?file=awex/wex_vact&wekid=$wekid' class='c999'>$cnav[wact]</a>
 
</p>";

//echo $wekid;



/*******************************************************************************
 File : \code\flow\binc\act_ops.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

if(empty($fs_do)) $msg = lang('flow.dops_setop');
if(empty($fs)) $msg = lang('flow.dops_setitem');
$cnt = 0; 
if(empty($msg)){
  foreach($fs as $id=>$v){ 
	  if($fs_do=='dele'){ 
		  $cnt += $dop->opDelete($id);
	  }elseif($fs_do=='dnow'){ 
		  //$cnt += $dop->opDelnow();
	  }
  } 
}

$cnt && $msg = "$cnt ".lang('flow.dops_delok');



/*******************************************************************************
 File : \code\flow\binc\exd_copy.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

#$_groups = glbConfig::read('groups');
#$view = empty($view) ? 'list' : $view;

$mod = empty($mod) ? 'demo' : $mod;
$type = basReq::val('type','mdata'); // mod, tabid
$kid = empty($kid) ? '' : $kid;
$title = basReq::val('title','');

$_cfg = glbConfig::read($mod); 
$cp = new exdCopy($mod, $type);

if(!empty($bsend)){
	
	$method = $type=='tabid' ? 'cplan' : 'cdata'; 
	$res = $cp->$method($kid, $fm['kid'], $fm['title']);
	basMsg::show(" [{$fm['kid']}] - ".lang('flow.dops_cpok'));	
	
}else{ 

	echo "<div class='h02'>&nbsp;</div>";
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');

	$tabid = glbDBExt::getTable($mod);
	if($type=='mdata'){
		$kids = glbDBExt::dbAutID($tabid,'yyyy-md-','31');
		$kidnew = $kids[0];
	}else{
		$kidnew = "{$kid}_".basKeyid::kidRand('0',5);
	}
	$okrow = "<input type='text' value='$kid' class='txt w240 disc' disabled='disabled' />";
	$nkrow = "<input name='fm[kid]' type='text' value='$kidnew' class='txt w240' />";
	glbHtml::fmae_row('Key'.lang('flow.dops_kid'),"$okrow");
	glbHtml::fmae_row(lang('flow.dops_copy').'-=>',"$nkrow");

	$titlenew = "{$title}_copy";
	$okrow = "<input type='text' value='$title' class='txt w240 disc' disabled='disabled' />";
	$nkrow = "<input name='fm[title]' type='text' value='$titlenew' class='txt w240' />";
	glbHtml::fmae_row(lang('flow.dops_itemname'),"$okrow");
	glbHtml::fmae_row(lang('flow.dops_copy').'-=>',"$nkrow");

	glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
	glbHtml::fmt_end(array("mod|$mod","type|$type","kid|$kid","title|$title"));
}




/*******************************************************************************
 File : \code\flow\binc\exd_inc1.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

if(in_array($view,array('list','fields','urlset','urlist','loglist'))){ //'fdefs',
	$jname = $tabid=='exd_crawl' ? lang('flow.ei_cwraldata') : lang('flow.ei_impdata');
	$lnkadd = "<a href='$aurl[1]&view=form' onclick='return winOpen(this,\"".lang('flow.dops_add')."[$jname]\");'>".lang('flow.fl_addtitle')."&gt;&gt;</a>";
	$lnkre = "<a href='$aurl[1]&view=list'>&lt;&lt;".lang('flow.ei_back')."</a>";
	$links = admPFunc::fileNav($file,'exd_oimp');
	glbHtml::tab_bar("[$jname]".lang('flow.ei_paln')."<span class='span ph5'>|</span>".($view=='list' ? $lnkadd : $lnkre),"$links",50);
}

if($view=='set_a2'){
	
	glbHtml::fmt_head('fmlist',"?",'tblist');
	echo "\n<tr><th class='tc w150'></th>\n<th>".lang('flow.ei_sharecfg').": </th></tr>\n";
	if(empty($ocfgs)){
		echo "\n<tr><td class='tc w180'>".lang('flow.cfg_tips').": </td>\n<td>
			".lang('flow.cfg_nocfg')."<br>".lang('flow.cfg_copy').": {code}/cfgs/excfg/ex_outdb.php
		</td></tr>\n";
	}else{
		echo "\n<tr><td class='tc w150'>".lang('flow.ei_cfgfile').": </td>\n<td>{code}/cfgs/excfg/ex_outdb.php，
		<a href='?file=admin/ediy&part=edit&dkey=cfgs&dsub=&efile=excfg/ex_outdb.php' onclick=\"return winOpen(this,'".lang('flow.ei_editcfg')."',780,560);\">".lang('flow.title_edit')."</a></td></tr>\n";
		echo "\n<tr><td class='tc'>['psyn']['server']</td>\n<td>{$ocfgs['psyn']['server']}/plus/ajax/exdb.php</td></tr>\n";
		echo "\n<tr><td class='tc'>['sign']['sapp']</td>\n<td>{$ocfgs['sign']['sapp']}</td></tr>\n";
		echo "\n<tr><td class='tc'>['sign']['skey']</td>\n<td>{$ocfgs['sign']['skey']}</td></tr>\n";
		echo "\n<tr><td class='tc'>".lang('flow.ei_doc').": </td>\n<td><a href='{$_cbase['server']['txmao']}/dev.php?dev2nd-exdata'>".lang('flow.ei_tip2nd')."</a></td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));

}if($view=='del_b3'){
	
	if(empty($fs_do)) $msg = lang('flow.dops_setop');
	if(empty($fs)) $msg = lang('flow.dops_setitem');
	$cnt = 0; 
	if(empty($msg)){
	  foreach($fs as $id=>$v){ 
		  if($fs_do=='dele'){ 
			  $db->table($dop->tbid)->where("kid='$job' AND sysid='$id'")->delete(); 
			  $cnt++;
		  }elseif($fs_do=='xxx'){ 
			  ;///
		  }
	  } 
	}
	$cnt && $msg = "$cnt ".lang('flow.dops_delok');
	
	/*/ 清理操作
	if(!empty($bsend)&&$fs_do=='dnow'){
		$msg = $dop->opDelnow();
		basMsg::show($msg,'Redir',"?file=$file&view=$view&job=$job&mod=$mod&flag=v1");
	}*/
	
}if($view=='fset'){

	if(!empty($bsend)){
		$msg = lang('flow.msg_upd');
		$fm['kid'] = $kid; 
		$fm['model'] = $job; //->where("kid='$job'")
		$fm['dealfmts'] = implode(',',$fm['dealfmts']); 
		if($tabid=='exd_crawl') exdBase::fldSave($fm,5);
		$db->table('exd_sfield')->data(basReq::in($fm))->replace();
		//basMsg::show("$msg","Redir","$aurl[1]");
		echo basJscss::Alert("$msg","Redir","$aurl[1]",1);	 
	}

	echo "<div class='h02'>&nbsp;</div>";
	$fm = $db->table('exd_sfield')->where("model='$job' AND kid='$kid'")->find(); 
	$fa = array(
		"orgtg1","orgtg2","orgtg3","orgtg4","orgtg5",
		"dealtabs","dealfmts","dealconv","dealfunc","dealfunp","defval","defover",
	);
	foreach($fa as $k){ 
		$fm[$k] = @basStr::filForm($fm[$k]); //echo "\n\n<br>$jcfg[$k]\n<br>$fm[$k]";
	}
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	echo "\n<tr><th class='tc w150'>$jcfg[title]</th>\n<th class='tl'>".lang('flow.ei_fldxcfg',$kid)."</th></tr>\n";
	glbHtml::fmae_row(lang('flow.ei_name'),"$jcfg[title] --- ".lang('flow.ei_fldxcfg',$kid));
	if($tabid=='exd_crawl'){
		$url = PATH_ROOT."/plus/ajax/exdb.php?act=crawl&mod=$jcfg[mod]&job=$job&debug=field&field=$kid&url=".urlencode($jcfg['odmp'])."&".exdBase::getJSign();
		glbHtml::fmae_row(lang('flow.ei_demodetail'),"<input name='fm_odmp' type='text' value='$jcfg[odmp]' class='txt w400' maxlength='240' readonly />");
		glbHtml::fmae_row(lang('flow.ei_debugrule'),"<a href='$jcfg[odmp]' target='_blank'>".lang('flow.ei_opendemo')."</a> # <a href='$url' target='_blank'>".lang('flow.ei_debfld',$kid)."</a> ");
		echo "\n<tr><th class='tc w150'></th>\n<th class='tl'>".lang('flow.ei_getrule').": </th></tr>\n";
		exdBase::fldForm($fm,5);
	}else{
		$odbname = $ocfgs['list'][$jcfg['odb']]; 
		glbHtml::fmae_row(lang('flow.ei_fromdb'),"$jcfg[odb] --- $odbname");
		glbHtml::fmae_row(lang('flow.ei_fromfield'),"<input name='fm[orgtg1]' type='text' value='$fm[orgtg1]' class='txt w400' maxlength='48' reg='key:1-24' />");
	}
	
	echo "\n<tr><th class='tc w150'></th>\n<th class='tl'>".lang('flow.ei_resdea').": </th></tr>\n";
	glbHtml::fmae_row(lang('flow.ei_reorg'),"<textarea name='fm[dealtabs]' rows='3' cols='50' wrap='wrap'>$fm[dealtabs]</textarea>");
	$cbarr = basLang::ucfg('cfgbase.crawl_fset'); 
	$cbstr = basElm::setCBox('dealfmts',$cbarr,$fm['dealfmts'],6);
	glbHtml::fmae_row(lang('flow.ei_cdeal'),"$cbstr");
	glbHtml::fmae_row(lang('flow.ei_retab'),"<textarea name='fm[dealconv]' rows='3' cols='50' wrap='wrap'>$fm[dealconv]</textarea>");
	$iparas = " &nbsp; ".lang('flow.ei_param')."<input name='fm[dealfunp]' type='text' value='$fm[dealfunp]' class='txt w150' maxlength='24' />";
	glbHtml::fmae_row(lang('flow.ei_resfunc'),"<input name='fm[dealfunc]' type='text' value='$fm[dealfunc]' class='txt w180' maxlength='24' />$iparas");
	glbHtml::fmae_row(lang('flow.ei_nuldef'),"<input name='fm[defval]' type='text' value='$fm[defval]' class='txt w400' maxlength='255' />"); 

	echo "\n<tr><th class='tc w150'></th>\n<th class='tl'>".lang('flow.exd_reurl')."</th></tr>\n";
	$detail = lang('flow.exd_rutip')."{$_cbase['server']['txmao']}/dev.php?advset-exdata#s_fields";
	glbHtml::fmae_row(lang('flow.title_note'),"<textarea rows='3' cols='50' wrap='wrap'>$detail</textarea>");
	glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
	glbHtml::fmt_end(array("mod|$mod","job|$job"));

}if($view=='fields'){

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	echo "<th>Key</th><th>".lang('flow.title_name')."</th><th>".lang('flow.ei_extab')."</th>";
	echo "<th>".lang('flow.title_enable')."</th><th>".lang('flow.title_note')."</th>";
	echo "<th>".lang('flow.title_type')."</th><th>".lang('flow.title_cfg')."</th><th>".(empty($ispara) ? lang('flow.ei_db') : lang('flow.ei_nowval'))."</th><th title='".lang('flow.ei_maxlen')."'>".lang('flow.ei_nchr')."</th>";	
	echo "<th class='wp15'>".lang('flow.title_note')."</th>\n";
	echo "</tr>\n";
	$list = $db->table('base_fields')->where("model='$mod'")->order('enable DESC,top')->select();
	$fskip = basElm::line2arr($jcfg['fskip']); 
	if($list){
	foreach($list as $r){
	  $kid = $r['kid'];
	  $note = basReq::out($r['vreg']).' | '.basReq::out($r['vtip']);
	  $note = $note==' | ' ? '' : $note;
	  $types = fldCfgs::viewTypes();
	  $plugs = fldCfgs::viewPlugs(); $plugstr = isset($plugs[$r['fmextra']]) ? ' ('.$plugs[$r['fmextra']].')' : '';
	  $dbstr = "$r[dbtype] ".(empty($r['dblen'])?'':"($r[dblen])").(strlen($r['dbdef'])?' ['.$r['dbdef'].']':'');
	  echo "<tr>\n";
	  echo "<td class='tc'>$r[kid]</td>\n";
	  echo "<td class='tl'>$r[title]</td>\n";
	  if($r['dbtype']=='nodb' || in_array($kid,$fskip)){
		  echo "<td class='tc c999' colspan=5>-- ".lang('flow.ei_skipfld')." --</td>\n";
	  }else{
	 	  echo "<td class='tc'>$r[top]</td>\n";
	 	  echo "<td class='tc'>".glbHtml::null_cell($r['enable'])."</td>\n";
	  	  echo "<td class='tc'>".($r['dbtype']=='nodb' ? '---' : glbHtml::null_cell($r['etab']))."</td>\n";
	  	  echo "<td class='tl'>".$types[$r['type']]." $plugstr</td>\n";
		  echo "<td class='tc'><a href='?file=$file&mod=$mod&view=fset&job=$job&kid=$r[kid]' onclick='return winOpen(this,\"".lang('flow.ei_fldcfg')."\")'>".lang('flow.title_cfg')."</a></td>\n";
	  }
	  echo "<td class='tc'>$dbstr</td>\n";
	  echo "<td class='tr'>".glbHtml::null_cell($r['vmax'],'')." | ".glbHtml::null_cell($r['dblen'],'')."</td>\n";
	  echo "<td class='tl'><input type='text' value='$note' class='txt w150 disc' disabled='disabled' /></td>\n";
	  echo "</tr>"; 
	}}  

	if($_groups[$mod]['pid']=='docs'){
		$dop->fext['catid'] = array('title'=>lang('flow.title_cata'),'dbtype'=>"varchar (12)");
	}elseif($_groups[$mod]['pid']=='users'){
		$dop->fext['grade'] = array('title'=>lang('flow.title_grade'),'dbtype'=>"varchar (12)");
	} //print_r($_groups);
	echo "<tr style='border:1px solid #00CCFF'><td class='tc' colspan=10></td></tr>";
	foreach($dop->fext as $fk=>$fv){
	  if(!in_array($fk,array('atime','catid','grade'))) continue;
	  echo "<tr>\n";
	  echo "<td class='tc'>$fk</td>\n";
	  echo "<td class='tl'>$fv[title]</td>\n";
	  echo "<td class='tc c999'>---</td>\n";
	  echo "<td class='tc'>Y</td>\n";
	  echo "<td class='tc c666' colspan=2>-- ".lang('flow.ei_addfld')." --</td>\n";
	  echo "<td class='tc'><a href='?file=$file&mod=$mod&view=fset&job=$job&kid=$fk' onclick='return winOpen(this,\"".lang('flow.title_cfg')."\")'>".lang('flow.title_cfg')."</a></td>\n";
	  echo "<td class='tc'>$fv[dbtype]</td>\n";
	  echo "<td class='tr'>--</td>\n";
	  echo "<td class='tl'><input type='text' value='$note' class='txt w150 disc' disabled='disabled' /></td>\n";
	  echo "</tr>"; 
	}
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='fdefs'){
	echo 'fdefs - no use.';
}


/*******************************************************************************
 File : \code\flow\binc\set_id.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if(!empty($bsend)){
	
	if(empty($fm['op'])){ 
		basMsg::show(lang('flow.dops_setop'));
		glbHtml::end();
	}
	if($fm['op']=='reid' && $fm['kre']!=$kid){
		$db->table($tabid)->data(array('pid'=>$fm['kre']))->where("model='$mod' AND pid='$kid'")->update();
		$db->table($tabid)->data(array('kid'=>$fm['kre']))->where("model='$mod' AND kid='$kid'")->update();
		$msg = lang('admin.sid_eid')."[{$fm['kre']}]".lang('admin.sid_ok'); 
	}elseif($fm['op']=='move'){  
		$deep = empty($fm['pid']) ? '1' : $cfg['i'][$fm['pid']]['deep']+1; 
		$dorg = $cfg['i'][$kid]['deep'];
        $pid = empty($fm['pid']) ? '0' : $fm['pid'];
		$db->table($tabid)->data(array('pid'=>$pid,'deep'=>$deep))->where("model='$mod' AND kid='$kid'")->update();
		if(!(intval($deep)==intval($dorg))){
			$dmov = $dorg - $deep;
			$a = comTypes::getSubs($cfg['i'],$kid);
			$kids = '';
			foreach($a as $k=>$v){
				$kids .= (empty($kids) ? '' : ',')."'$k'";
			}
			$res2 = (intval($dmov)>0 ? '-' : '+').abs($dmov);
			$kids && $db->query("UPDATE {$db->pre}$tabid{$db->ext} SET deep=deep$res2 WHERE model='$mod' AND kid IN($kids)"); 
		}
		$msg = lang('flow.msg_move'); 
	} 
	glbCUpd::upd_model($mod);
	basMsg::show($msg);	
	
}else{ 

	echo "<div class='h02'>&nbsp;</div>";
	glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
	glbHtml::fmae_row(lang('flow.fl_kflag'),"<input name='fm[kid]' type='text' value='$kid' class='txt w150 disc' disabled='disabled' />");
	glbHtml::fmae_row(lang('flow.dops_itemname'),"<input name='fm[title]' type='text' value='".$cfg['i'][$kid]['title']."' class='txt w150 disc' disabled='disabled' />");
	glbHtml::fmae_row(lang('flow.title_op'),basElm::setRadio('op',"reid=".lang('admin.sid_eid')."\nmove=".lang('admin.sid_move')));

	$vstr = "url='".PATH_ROOT."/plus/ajax/cajax.php?act=keyExists&mod=$mod&tab=$tabid&old_val=$kid' tip='".lang('admin.fad_tip21245')."'";
	glbHtml::fmae_row(lang('flow.title_newid'),"<input name='fm[kre]' type='text' value='$kid' class='txt w150' maxlength='12' reg='key:2-12' $vstr />");
	
	$ops = comTypes::getOpt(comTypes::getPars($cfg['i'],$cfg['deep']));
	$ops = str_replace(lang('admin.sid_sel'),lang('admin.sid_top'),$ops); 
	glbHtml::fmae_row(lang('flow.title_pid'),"<select name='fm[pid]'>$ops</select> (".lang('admin.sid_uinmv').")");
	glbHtml::fmae_send('bsend',lang('flow.dops_send'),'25');
	glbHtml::fmt_end(array("mod|$mod","pid|$pid","kid|$kid"));
}



/*******************************************************************************
 File : \code\flow\dops\a.php 
*******************************************************************************/
<?php // dops
(!defined('RUN_MODE')) && die('No Init');
$mod = empty($mod) ? 'demo' : $mod;
$view = empty($view) ? 'list' : $view;
$_cfg = glbConfig::read($mod); 

$_pid = @$_cfg['pid']; 
$_tmp = array(
	'docs' =>array('dopDocs','did'),
	'users'=>array('dopUser','uid'),
	'coms' =>array('dopComs','cid'),
	'advs' =>array('dopAdvs','aid'),
); 
if(!isset($_tmp[$_pid])) glbHtml::end(lang('flow.dops_parerr').':mod@dop.php');
$gname = $_groups[$mod]['title']; //print_r($cv);
usrPerm::run('pmod',$mod);

$_cls = $_tmp[$_pid][0]; 
$dop = new $_cls($_cfg); 
$so = $dop->so; 
$cv = $dop->cv;
unset($_cfg,$_pid,$_tmp,$_cls);

$_scdir = dirname(dirname(__FILE__)); // 脚本: 
if($_fex=dopFunc::modFile($_scdir,$mod,$dop->type)){
	require($_fex); 
}else{
	$msg = ''; $tabext = '';
	if($view=='list'){
		if(!empty($bsend)){
			require(dopFunc::modAct($_scdir,'list_do',$mod,$dop->type));
		} //$dop->whrstr = " AND "; $_mpid,
		require(dopFunc::modAct($_scdir,'list_show',$mod,$dop->type));
	}elseif($view=='form'){
		if(!empty($bsend)){
			require(dopFunc::modAct($_scdir,'form_do',$mod,$dop->type));
		}else{
			require(dopFunc::modAct($_scdir,'form_show',$mod,$dop->type));
		}
	}
}

//print_r(basDebug::runInfo());
//print_r(basDebug::bugStop()); 



/*******************************************************************************
 File : \code\flow\dops\advs_form_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$dop->svPrep(); 
if(!empty($isadd)){ 
	$dop->svAKey();
	$dop->svPKey('add');
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	$actm = lang('flow.dops_add');
	$aid = $dop->fmv['aid'];
}else{ 
	$aid = $dop->svEKey();
	$dop->svPKey('edit');
	$db->table($dop->tbid)->data($dop->fmv)->where("aid='$aid'")->update();
	$actm = lang('flow.dops_edit');
}
vopStatic::advMod($mod,$aid);
basMsg::show("$actm".lang('flow.dops_ok'));	



/*******************************************************************************
 File : \code\flow\dops\advs_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if(!empty($aid)){
	$fmo = $db->table($dop->tbid)->where("aid='$aid'")->find(); 
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
$dop->fmo = $fmo; 
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
$dop->fmPKey();
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));


/*******************************************************************************
 File : \code\flow\dops\advs_list_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$fs_do = basReq::val('fs_do');
$fs = basReq::arr('fs'); 
if(empty($fs_do)) $msg = lang('flow.dops_setop');
if(empty($fs)) $msg = lang('flow.dops_setitem');
$cnt = 0; $msgop = '';
foreach($fs as $id=>$v){ 
	if(in_array($fs_do,array('show','hidden'))){ 
		$cnt += $dop->opShow($id,$fs_do);
		$msgop = $fs_do=='show' ? lang('flow.dops_checked') : lang('flow.dops_hide');
	}elseif($fs_do=='del'){ 
		$cnt += $dop->opDelete($id);
		$msgop = lang('flow.dops_del');
	}elseif($fs_do=='(xxx)'){ 
		;//
	}
}
vopStatic::advMod($mod,$fs);
$msg = "$cnt ".lang('flow.dops_okn',$msgop);



/*******************************************************************************
 File : \code\flow\dops\advs_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if(basReq::val('umod')=='upd'){
	echo vopStatic::advMod($mod,"(all)");
    echo "<p class='tc'><a href='?file=$file&mod=$mod&view=list'>".lang('flow.dops_back')."</a></p>";
}

//$dop->dskey  = $dop->so->dskey  = 'mtel'; //改变默认搜索字段
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'advs_list', $dop->cfg);
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $aid = $idend = $r['aid'];
	  if(empty($idfirst)) $idfirst = $aid;
      $kcu = $dop->cfg['etab']==4 ? 'auser' : 'click';
	  echo $cv->Select($aid);
	  echo $cv->Title($r,1,'title',$dop->avLink($r),64);
	  echo $cv->Types($r['catid']);
	  echo $cv->Show($r['show']);
	  echo $cv->Url('Url',1,"$r[url]","blank");
	  echo $cv->Field($r[$kcu]);
	  echo $cv->Time($r['atime']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&aid=$r[aid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\dops\coms_form_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$dop->svPrep(); 
if(!empty($isadd)){ 
	$dop->svAKey();
	$dop->svPKey('add');
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	$actm = lang('flow.dops_add');
}else{ 
	$cid = $dop->svEKey();
	$dop->svPKey('edit');
	$db->table($dop->tbid)->data($dop->fmv)->where("cid='$cid'")->update();
	$actm = lang('flow.dops_edit');
}
basMsg::show("$actm".lang('flow.dops_ok'));	



/*******************************************************************************
 File : \code\flow\dops\coms_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if(!empty($cid)){
	$fmo = $db->table($dop->tbid)->where("cid='$cid'")->find(); 
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
$dop->fmo = $fmo;
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
$dop->fmPKey();
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));


/*******************************************************************************
 File : \code\flow\dops\coms_list_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$fs_do = basReq::val('fs_do');
$fs = basReq::arr('fs'); 
if(empty($fs_do)) $msg = lang('flow.dops_setop');
if(empty($fs)) $msg = lang('flow.dops_setitem');
$cnt = 0; $msgop = '';
foreach($fs as $id=>$v){ 
	if(in_array($fs_do,array('show','hidden'))){ 
		$cnt += $dop->opShow($id,$fs_do);
		$msgop = $fs_do=='show' ? lang('flow.dops_checked') : lang('flow.dops_hide');
	}elseif($fs_do=='del'){ 
		$cnt += $dop->opDelete($id);
		$msgop = lang('flow.dops_del');
	}elseif($fs_do=='(xxx)'){ 
		;//
	}
}
$msg = "$cnt ".lang('flow.dops_okn',$msgop);



/*******************************************************************************
 File : \code\flow\dops\coms_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

//$dop->dskey  = $dop->so->dskey  = 'mtel'; //改变默认搜索字段
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'coms_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $cid = $idend = $r['cid'];
	  if(empty($idfirst)) $idfirst = $cid;
	  echo $cv->Select($cid);
	  echo $cv->Field($r['title'],1,64); //echo $cv->Types($r['title']);
	  echo $cv->Show($r['show']);
	  echo $cv->Field($r['mname']);
	  echo $cv->Field($r['mtel']);
	  echo $cv->Field($r['memail']);
	  echo $cv->Field($r['miuid']);
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['aip']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\dops\docs_form_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$dop->svPrep();
if(!empty($isadd)){ // basReq::in()
	$dop->svAKey(); $did = $dop->fmu['did'] = $dop->fmv['did'];
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	$db->table($dop->tbext)->data($dop->fmu)->insert(); 
	$actm = lang('flow.dops_add');
}else{ 
	$did = $dop->svEKey();
	$db->table($dop->tbid)->data($dop->fmv)->where("did='$did'")->update();
	$dop->fmu['did'] = $did;
	$db->table($dop->tbext)->data($dop->fmu)->replace(0);
	$actm = lang('flow.dops_edit');
}
$dop->svEnd($did); //静态情况等
basMsg::show("$actm".lang('flow.dops_ok'),'Redir');



/*******************************************************************************
 File : \code\flow\dops\docs_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
 
if(!empty($did)){
	$fmo = $db->table($dop->tbid)->where("did='$did'")->find();
	$fme = $db->table($dop->tbext)->where("did='$did'")->find();
	$fme && $fmo = $fmo + $fme;
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
$dop->fmo = $fmo;
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
glbHtml::fmae_row(lang('flow.dops_icat'),$dop->fmType('catid').' &nbsp; '.lang('flow.dops_ishow').$dop->fmShow());
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));
if($mod=='cargo'){
	fldView::relat("relpb,fm[catid],fm[brand]","fm[xinghao],$mod,$did"); 
}
if($mod=='keres'){
	fldView::relat("relyc,fm[ygrade],fm[course]");
}
if(in_array($mod,array('about','demo'))){
	fldView::relat("fm[catid]","fm[catid],$mod,$did");
}


/*******************************************************************************
 File : \code\flow\dops\docs_list_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$fs_do = basReq::val('fs_do');
$fs = basReq::arr('fs');
if(empty($fs_do)) $msg = lang('flow.dops_setop');
if(empty($fs)) $msg = lang('flow.dops_setitem');
$cnt = 0; $msgop = '';
foreach($fs as $id=>$v){ 
	if(in_array($fs_do,array('show','hidden'))){ 
		$cnt += $dop->opShow($id,$fs_do);
		$msgop = $fs_do=='show' ? lang('flow.dops_checked') : lang('flow.dops_hide');
	}elseif($fs_do=='del'){ 
		$cnt += $dop->opDelete($id);
		$msgop = lang('flow.dops_del');
	}elseif($fs_do=='(xxx)'){ 
		$msgop = '';
	}
}
$msg = "$cnt ".lang('flow.dops_okn',$msgop);
//glbCUpd::upd_model($mod);



/*******************************************************************************
 File : \code\flow\dops\docs_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$dop->sobar($dop->msgBar($msg)); 
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'docs_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $did = $idend = $r['did'];
	  if(empty($idfirst)) $idfirst = $did;
	  echo "<tr>\n";
	  echo $cv->Select($did);
	  echo $cv->Title($r,1,'title',"");
	  echo $cv->Types($r['catid']);
	  echo $cv->Show($r['show']);
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['auser']);
	  echo $cv->Time($r['etime'],'y');
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&did=$r[did]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\dops\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\flow\dops\users_form_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$dop->svPrep();
if(!empty($isadd)){ 
	$dop->svAKey();
	$dop->svAccount('add'); //basDebug::varShow($dop->fmv);
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	$actm = lang('flow.dops_add');
}else{ 
	$uid = $dop->svEKey();
	$dop->svAccount('edit');
	$db->table($dop->tbid)->data($dop->fmv)->where("uid='$uid'")->update();
	$actm = lang('flow.dops_edit');
}
$dop->svEnd($uid); //静态情况等
basMsg::show("$actm".lang('flow.dops_ok'));	



/*******************************************************************************
 File : \code\flow\dops\users_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if(!empty($uid)){
	$fmo = $db->table($dop->tbid)->where("uid='$uid'")->find(); 
	$fme = $db->table($dop->tbuacc)->where("uid='$uid'")->find();
	$fme && $fmo = $fmo + $fme;
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
$dop->fmo = $fmo;
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
$dop->fmAccount();
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));
if(in_array($mod,array('company','govern','organize'))){
	fldView::relat("fm[grade]","fm[miuid],$mod,$uid,fm[grade]"); 
}



/*******************************************************************************
 File : \code\flow\dops\users_list_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$fs_do = basReq::val('fs_do');
$fs = basReq::arr('fs');
if(empty($fs_do)) $msg = lang('flow.dops_setop');
if(empty($fs)) $msg = lang('flow.dops_setitem');
$cnt = 0; $msgop = '';
foreach($fs as $id=>$v){ 
	if(in_array($fs_do,array('show','hidden'))){ 
		$cnt += $dop->opShow($id,$fs_do);
		$msgop = $fs_do=='show' ? lang('flow.dops_checked') : lang('flow.dops_hide');
	}elseif($fs_do=='del'){ 
		$cnt += $dop->opDelete($id);
		$msgop = lang('flow.dops_del');
	}elseif($fs_do=='(xxx)'){ 
		;//
	}
}
$msg = "$cnt ".lang('flow.dops_okn',$msgop);



/*******************************************************************************
 File : \code\flow\dops\users_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if($mod=='adminer') $dop->so->whrstr .= " AND `aip` !='disturb'";
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'users_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $uid = $idend = $r['uid'];
	  if(empty($idfirst)) $idfirst = $uid;
	  echo $cv->Select($uid);
	  echo $cv->Url($r['uname'],1,PATH_ROOT."/plus/ajax/cajax.php?act=uLogin&uname={$r['uname']}","blank"); 
	  echo $cv->Types($r['grade']);
	  echo $cv->Field($r['mname']);
	  echo $cv->Field($r['mtel']);
	  echo $cv->Field($r['memail']);
	  echo $cv->Field($r['miuid']);
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['aip']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&uid=$r[uid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\adfavor_view.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$mcfg = glbConfig::read('adfavor');
$mtab = 'advs_adfavor';

$stype = empty($stype) ? basReq::val('stype','afadmin') : $stype;
$actstr = empty($actstr) ? @$mcfg['i'][$stype]['title'] : $actstr;
 
$stsub = array(); $stids = "'0'";
$nav = "\n<table border='1' class='tbdata favor'><tr>";
foreach($mcfg['i'] as $ik=>$iv){
	if($iv['pid']==$stype){ 
		$stsub[$ik] = $iv;
		$nav .= "\n<th width='%'><li class='right c999'>$actstr</li><li class='left'>$iv[title]</li></th>"; 
		$stids .= ",'$ik'";
	}
}
$nav .= "</tr><tr>"; $nw = count($stsub)==0 ? 100 : 100/count($stsub);
$nav = str_replace("width='%'","width='$nw%'",$nav); 

$list = $db->table($mtab)->where("catid IN($stids) $whrself AND `show`='1'")->order('top')->select();
if(!empty($list)){
    echo "<div class='h05'>&nbsp;</div>\n$nav";
    foreach($stsub as $ik=>$iv){
    	echo "\n<td valign='top'>";
    	foreach($list as $v2){ if($v2['catid']==$ik){
    		echo "<li><a href='$v2[url]' target='_blank'>$v2[title]</a></li>"; 
    	}}
    	echo "</td>"; 
    }
}
echo "\n</tr></table>";


/*******************************************************************************
 File : \code\flow\eact\cargo_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$dop->sobar($dop->msgBar($msg)); 
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'cargo_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $did = $idend = $r['did'];
	  if(empty($idfirst)) $idfirst = $did;
	  echo "<tr>\n";
	  echo $cv->Select($did);
	  echo $cv->Title($r,1,'title',"");
	  echo $cv->Types($r['catid']);
	  echo $cv->Show($r['show']);
	  echo $cv->Time($r['atime']);
	  //echo $cv->Field($r['auser']);
	  echo $cv->Time($r['etime'],'y');
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&did=$r[did]&recbk=ref","");
	  echo $cv->Url(lang('flow.dops_copy'),1,"?file=binc/exd_copy&mod=$mod&kid=$r[did]&title=$r[title]",lang('flow.dops_cpro'),480,360);
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\demo_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
 
if(!empty($did)){
	$fmo = $db->table($dop->tbid)->where("did='$did'")->find();
	$fme = $db->table($dop->tbext)->where("did='$did'")->find();
	$fme && $fmo = $fmo + $fme;
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
$dop->fmo = $fmo;
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
glbHtml::fmae_row(lang('flow.dops_icat'),$dop->fmType('catid').' &nbsp; '.lang('flow.dops_ishow').$dop->fmShow());
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));
//$jchg = "relCatid('fm[ftype]','$mod','$uname','fm[grade]');";
//echo basJscss::jscode("\n $jchg \$(jsElm.jeID('fm[grade]')).change(function(){ $jchg; });");
//fldView::relat("relyc,fm[ygrade],fm[course]");
fldView::relat("fm[catid]","fm[catid],$mod,$did");
//fldView::relat("fm[grade]","fm[ftype],$mod,$uname,fm[grade]"); 
//fldView::relat("relpb,fm[catid],fm[brand]","fm[xinghao],$mod,$did"); 	



/*******************************************************************************
 File : \code\flow\eact\demo_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
// 参考: dops/docs_list_show.php

$sbar = "\n".$so->Type(90,lang('flow.op0_cat')); // for:demo
$sbar .= "\n&nbsp; ".$so->Field('mfrom',70);
$sbar .= "\n&nbsp; ".$so->Field('mfron',70);
$sbar .= "\n&nbsp; ".$so->Field('mwork',70);
$sbar .= "\n&nbsp; ".$so->Word(80,80,lang('flow.op0_filt'));
$sbar .= "<br />\n".$so->Show(60);
$sbar .= "\n&nbsp; ".$so->Field('tphot',70);
$sbar .= "\n&nbsp; ".$so->Field('tpfields',70);
$sbar .= "\n&nbsp; ".$so->Area(70,80);
$sbar .= "\n&nbsp; ".$so->Order(array('did' => 'ID(D)','did-a' => 'ID(A)',),70);
$so->Form($sbar,$dop->msgBar($msg),30);
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'demo_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $did = $idend = $r['did'];
	  if(empty($idfirst)) $idfirst = $did;
	  echo "<tr>\n".$cv->Select($did);
	  $r_text  = ' ['.$cv->TKeys($r,0,'mfrom',12,'-').'] ';
	  $r_text .= ' ['.$cv->TKeys($r,0,'mfron',12,'-').'] '; 
	  $r_text .= ' ['.$cv->TKeys($r,0,'mwork',12,'-').'] ';
	  $r_text .= ' ['.$cv->TKeys($r,0,'tpfields',12,'-').'] ';
	  echo "<td class='tl'>".$cv->Title($r,0,'title',"")."<div class='tr'>[".lang('flow.dops_rem')."]$r_text</div>\n</td>\n";
	  echo $cv->Types($r['catid']);
	  echo $cv->Show($r['show']);
	  echo "<td class='tc'>".$cv->Time($r['atime'],0,'y')."<br>".$cv->Field($r['auser'],0)."</td>\n";
	  echo "<td class='tc'>".$cv->Time($r['etime'],0)."<br>".$cv->Field($r['eip'],0,8)."</td>\n";
	  echo "<td class='tc'>".$cv->Field($r['mtel'],0,9)."<br>".$cv->Time($r['dend'],0,'',1)."</td>\n";
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&did=$r[did]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\indoc_form_do.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

vopTpls::pinc('umc:tex_indoc');

$dop->svPrep();
tex_indoc::fixIspub($dop,$isadd); // topub=ispub : 扩展
if(!empty($isadd)){ 
	$dop->svAKey(); $did = $dop->fmu['did'] = $dop->fmv['did'];
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	$db->table($dop->tbext)->data($dop->fmu)->insert(); 
	$actm = lang('flow.dops_add');
}else{ 
	$did = $dop->svEKey();
	$db->table($dop->tbid)->data($dop->fmv)->where("did='$did'")->update();
	$dop->fmu['did'] = $did;
	$db->table($dop->tbext)->data($dop->fmu)->replace();
	$actm = lang('flow.dops_edit');
}
$dop->svEnd($did); //静态情况等
tex_indoc::exNotice($dop,$isadd); // 通知扩展
basMsg::show("$actm".lang('flow.dops_ok'),'Redir');



/*******************************************************************************
 File : \code\flow\eact\indoc_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 
 
if(!empty($did)){
	$fmo = $db->table($dop->tbid)->where("did='$did'")->find();
	$fme = $db->table($dop->tbext)->where("did='$did'")->find();
	$fme && $fmo = $fmo + $fme;
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
if(empty($fmo['author'])){
	$fmo['author'] = $user->uinfo['mname'];
}
if(empty($fmo['indep'])){
	$fmo['indep'] = @$user->uinfo['intech'];	
}
$dop->fmo = $fmo;
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
glbHtml::fmae_row(lang('flow.dops_icat'),$dop->fmType('catid').' &nbsp; '.lang('flow.dops_ishow').$dop->fmShow());
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));


/*******************************************************************************
 File : \code\flow\eact\indoc_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

$dop->sobar($dop->msgBar($msg)); 
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'indoc_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $did = $idend = $r['did'];
	  if(empty($idfirst)) $idfirst = $did;
	  echo "<tr>\n";
	  echo $cv->Select($did);
	  echo $cv->Title($r,1,'title',"");
	  echo $cv->Types($r['catid']);
	  echo $cv->TKeys($r,1,'indep');
	  echo $cv->TKeys($r,1,'rdtip',2,'',1);  
	  echo $cv->Show($r['show']);
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['auser']);
	  echo $cv->Time($r['etime'],'y');
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&did=$r[did]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\inread_form_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

if(!empty($cid)){
	$fmo = $db->table($dop->tbid)->where("cid='$cid'")->find(); 
	$isadd = 0;
}else{
	$fmo = array();
	$isadd = 1;
}
$dop->fmo = $fmo;
glbHtml::fmt_head('fmlist',"$aurl[1]",'tbdata');
$dop->fmPKey(0,0);
fldView::lists($mod,$fmo);
$dop->fmProp();
glbHtml::fmae_send('bsend',lang('flow.dops_send'));
glbHtml::fmt_end(array("mod|$mod","isadd|$isadd"));


/*******************************************************************************
 File : \code\flow\eact\inread_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

//$dop->dskey  = $dop->so->dskey  = 'mtel'; //改变默认搜索字段
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'inread_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $cid = $idend = $r['cid'];
	  if(empty($idfirst)) $idfirst = $cid;
	  echo $cv->Select($cid);
	  echo $cv->PTitle('indoc',$r['pid'],"/plus/ajax/redir.php?indoc.{$r['pid']}");
	  echo $cv->PTitle('users',$r['auser'],'#');
	  echo $cv->Field($r['auser']);
	  echo $cv->Field($r['readcnt']); 
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['aip']);
	  echo $cv->Time($r['etime']);
	  echo $cv->Field($r['eip']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\inrem_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

//$dop->dskey  = $dop->so->dskey  = 'mtel'; //改变默认搜索字段
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'inrem_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $cid = $idend = $r['cid'];
	  if(empty($idfirst)) $idfirst = $cid;
	  echo $cv->Select($cid);
	  echo $cv->PTitle('indoc',$r['pid'],"/plus/ajax/redir.php?indoc.{$r['pid']}");
	  echo $cv->Field($r['title'],1,48); 
	  echo $cv->Field($r['auser']);
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['aip']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\qarep_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

//$dop->dskey  = $dop->so->dskey  = 'mtel'; //改变默认搜索字段
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'qarep_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $cid = $idend = $r['cid'];
	  if(empty($idfirst)) $idfirst = $cid;
	  echo $cv->Select($cid);
	  echo $cv->PTitle('faqs',$r['pid'],"/plus/ajax/redir.php?faqs.{$r['pid']}");
	  echo $cv->Field($r['title'],1,48); 
	  echo $cv->Field($r['mname']);
	  echo $cv->Field($r['miuid']);
	  echo $cv->Field($r['auser']);
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['aip']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\eact\qatag_list_show.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init'); 

//$dop->dskey  = $dop->so->dskey  = 'mtel'; //改变默认搜索字段
$dop->sobar($dop->msgBar($msg));
glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
basLang::inc('aflow', 'qarag_list');
$idfirst = ''; $idend = '';
if($rs=$dop->getRecs()){ 
	foreach($rs as $r){ 
	  $cid = $idend = $r['cid'];
	  if(empty($idfirst)) $idfirst = $cid;
	  echo $cv->Select($cid);
	  echo $cv->Field($r['title']);
	  echo $cv->Field($r['hotcnt']); 
	  echo $cv->Time($r['atime']);
	  echo $cv->Field($r['aip']);
	  echo $cv->Time($r['etime']);
	  echo $cv->Field($r['eip']);
	  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
	  echo "</tr>"; 
	}
	$dop->pgbar($idfirst,$idend);
}else{
	echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));



/*******************************************************************************
 File : \code\flow\emod\adfavor.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$stype = basReq::val('stype');
$duwhr = " AND auser='{$user->usess['uname']}'"; 

$msg = ''; $tabext = ''; 
if($view=='list'){
	
	usrPerm::issup() || usrPerm::run('pcheck',$mod);
	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'list_do',$mod,$dop->type));
	} //$dop->whrstr = " AND "; $_mpid,
    if(!empty($bsend)){
        $dop->whrstr = $whrself; 
    }
	require(dopFunc::modAct($_scdir,'list_show',$mod,$dop->type));
	
}elseif($view=='form'){
	
    usrPerm::issup() || usrPerm::run('pcheck',$mod);
	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'form_do',$mod,$dop->type));
	}else{
		if(!usrPerm::issup()){
        foreach($dop->cfg['i'] as $k=>$v){
            if(!in_array($stype,array($k,$v['pid']))) { unset($dop->cfg['i'][$k]); }
		}} 
        require(dopFunc::modAct($_scdir,'form_show',$mod,$dop->type));
	}
    if(!usrPerm::issup()){
        echo basJscss::jscode("setEdit('click,xmpic');"); // 屏蔽行
    }else{
        echo basJscss::jscode("setEdit('auser,euser','click,xmpic');"); // add,edit=自己的
    }
	
}elseif(in_array($view,array('vself','vsite'))){

	$stype = 'afauser'; $actstr = ''; $whrself = $duwhr; 
	include(dirname(dirname(__FILE__))."/eact/adfavor_view.php");
    $stype = 'afadmin'; $actstr = ''; $whrself = '';
    include(dirname(dirname(__FILE__))."/eact/adfavor_view.php");

}



/*******************************************************************************
 File : \code\flow\emod\cocar.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$msg = ''; $tabext = '';

if($view=='clear'){
	$msg = lang('flow.dops_clearok');
	if($mod=='coitem'){
		$pids = glbDBExt::getKids('corder','title','1=1'); 
		$db->table($dop->tbid)->where("ordid NOT IN($pids)")->delete(); 
	}else{
		$db->table($dop->tbid)->where("atime<'".($_cbase['run']['stamp']-3*86400)."'")->delete(); 
	}
	$view = 'list';
}
 
if($view=='list'){

	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'list_do',$mod,$dop->type));
	} 
	
	$sbar = "\n".$so->Type(90,'-pKey-'); 
	$sbar .= "\n&nbsp; ".$so->Word(80,80,lang('flow.op0_filt'));
	$sbar .= "\n&nbsp; ".$so->Order(array('cid' => 'ID(D)','cid-a' => 'ID(A)',));
	$snav = admPFunc::fileNav($mod,'ordnav'); $msg = $msg ? "<span class='cF00'>$msg</span>" : ' '; 
	$so->Form($sbar,$dop->msgBar($snav,$msg),40);

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	basLang::inc('aflow', 'cocar');
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $cid = $idend = $r['cid'];
		  if(empty($idfirst)) $idfirst = $cid;
		  echo $cv->Select($cid);
		  echo $cv->Field($r['pid']);
		  echo $cv->Field($r['ordid'],1,15);
		  echo $cv->Field($r['ordcnt']);
		  echo $cv->Field($r['ordprice']);
		  echo $cv->Field($r['auser']);
		  echo $cv->Time($r['atime']);
		  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
		  echo "</tr>"; 
		}
		$pg = $dop->pg->show($idfirst,$idend); 
		$op = "".basElm::setOption(lang('flow.dops_del'),'',lang('flow.op0_bacth')); //\nclear|清理
		dopFunc::pageBar($pg." &nbsp; <a href='$aurl[1]&view=clear'>".lang('flow.dops_clear')."</a>",$op);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));

}elseif($view=='form'){
	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'form_do',$mod,$dop->type));
	}else{
		require(dopFunc::modAct($_scdir,'form_show',$mod,$dop->type));
	}
}elseif($view=='xset'){
	;//
}



/*******************************************************************************
 File : \code\flow\emod\corder.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$msg = ''; $tabext = '';

if($view=='clear'){
	$msg = lang('flow.dops_clearok');
	/*if($mod=='coitem'){
		$pids = glbDBExt::getKids('corder','title','1=1'); 
		$db->table($dop->tbid)->where("ordid NOT IN($pids)")->delete(); 
	}else{
		$db->table($dop->tbid)->where("atime<'".($_cbase['run']['stamp']-3*86400)."'")->delete(); 
	}*/
	$view = 'list';
}

if($view=='list'){
	if(!empty($bsend)){
		
		$fs_do = basReq::val('fs_do');
		$fs = basReq::arr('fs'); 
		if(empty($fs_do)) $msg = lang('flow.dops_setop');
		if(empty($fs)) $msg = lang('flow.dops_setitem');
		$cnt = 0; $msgop = '';
		foreach($fs as $id=>$v){ 
			if(in_array($fs_do,array('show','hidden'))){ 
				$cnt += $dop->opShow($id,$fs_do);
				$msgop = $fs_do=='show' ? lang('flow.dops_checked') : lang('flow.dops_hide');
			}elseif($fs_do=='del'){ 
				$cnt += $dop->opDelete($id);
				$db->table('coms_coitem')->where("title='$id'")->delete(); 
				$msgop = lang('flow.dops_del');
			}elseif(strstr($fs_do,'set_')){ 
				$v = basStr::filKey(str_replace('set_','',$fs_do),'_-.');
				$cnt += $db->table($dop->tbid)->data(array('ordstat'=>$v))->where("$dop->_kid='$id'")->update();
			}
		}
		$msg = "$cnt ".lang('flow.dops_okn',$msgop);
	} 
	
	$sbar = "\n".$so->Type(90,'-pKey-'); 
	$sbar .= "\n&nbsp; ".$so->Word(80,80,lang('flow.op0_filt'));
	$sbar .= "\n&nbsp; ".$so->Field('ordstat',60);
	$sbar .= "\n&nbsp; ".$so->Order(array('cid' => 'ID(Desc)','cid-a' => 'ID(Asc)',));
	$snav = admPFunc::fileNav($mod,'ordnav'); $msg = $msg ? "<span class='cF00'>$msg</span>" : ' '; 
	$so->Form($sbar,$dop->msgBar($snav,$msg),40);

	glbHtml::fmt_head('fmlist',"$aurl[1]",'tblist');
	basLang::inc('aflow', 'corder');
	$idfirst = ''; $idend = '';
	if($rs=$dop->getRecs()){ 
		foreach($rs as $r){ 
		  $cid = $idend = $r['cid'];
		  if(empty($idfirst)) $idfirst = $cid;
		  echo $cv->Select($cid);
		  //echo $cv->Field($r['title'],1,64);  
		  echo $cv->Url($r['title'],1,vopUrl::fout("chn:0",'')."?mkv=ocar-invoce&ordid=$cid","blank");
		  echo $cv->TKeys($r,1,'ordstat',12,'-');
		  echo $cv->Field($r['feetotle']);
		  echo $cv->Field($r['ordcnt']);
		  echo $cv->Field($r['feeamount']);
		  echo $cv->Field($r['trakeno'],1,64);
		  echo $cv->Field($r['mname']);
		  echo $cv->Field($r['mtel'],1,16);
		  echo $cv->Time($r['atime']);
		  echo $cv->Url(lang('flow.dops_edit'),1,"$aurl[1]&view=form&cid=$r[cid]&recbk=ref","");
		  echo "</tr>"; 
		}
		$pg = $dop->pg->show($idfirst,$idend); 
		$op = basElm::setOption("del,".lang('flow.dops_del').";".($cv->set_opts('ordstat'))."",'',lang('flow.op0_bacth')); //\ndnow|删除当前
		dopFunc::pageBar($pg." &nbsp; <a href='$aurl[1]&view=clear'>".lang('flow.dops_clear')."</a>",$op);
	}else{
		echo "\n<tr><td class='tc' colspan='15'>".lang('flow.dops_nodata')."</td></tr>\n";
	}
	glbHtml::fmt_end(array("mod|$mod"));
	
}elseif($view=='form'){
	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'form_do',$mod,$dop->type));
	}else{
		require(dopFunc::modAct($_scdir,'form_show',$mod,$dop->type));
	}
}elseif($view=='set'){
	;//
}



/*******************************************************************************
 File : \code\flow\emod\{modid}.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$msg = ''; $tabext = '';
if($view=='list'){
	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'list_do',$mod,$dop->type));
	} //$dop->whrstr = " AND "; $_mpid,
	require(dopFunc::modAct($_scdir,'list_show',$mod,$dop->type));
}elseif($view=='form'){
	if(!empty($bsend)){
		require(dopFunc::modAct($_scdir,'form_do',$mod,$dop->type));
	}else{
		require(dopFunc::modAct($_scdir,'form_show',$mod,$dop->type));
	}
}elseif($view=='set'){
	;//utf-8编码
}



/*******************************************************************************
 File : \code\flow\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\lang\dbins\base_catalog-cn.php 
*******************************************************************************/
<?php
return array(
  // 8: 
  '[顶]620x60',
  '[上]850x80',
  // 7: 
  '环图文字[上]',
  '环图文字[左]',
  '环图文字[下]',
  '环图文字[右]',
  '友情链接[下]',
  '推荐资源[侧]',
  '广告[侧边]A',
  '贴心口袋[侧]',
  '产品推荐[侧]',
  '广告[侧边]B',
  // 6: 
  '测试AB01',
  '测试CD23',
  // 5: 
  '英语美文1',
  '英语美文2',
  '测试子类3',
  '测试子类4',
  'KPI月报',
  '[回收站]',
  'Bug反馈',
  // 4: 
  '英语美文',
  '幽默搞笑',
  '系统文档',
  '编辑说明',
  '测试栏目',
  '手机配件',
  '手机主机',
  '书籍音像',
  '服装饰品',
  '家电家具',
  '手机套卡',
  '首页广告',
  '通用内页',
  '公司简介',
  '联系我们',
  '服务内容',
  '公司新闻',
  '客户新闻',
  '行业新闻',
  '公益专题',
  '促销专题',
  '公司公告',
  '公司制度',
  '高层动向',
  '公司图片',
  '教具仪器',
  '益智玩具',
  '教育教学',
  '家庭教育',
  '社会自然',
  '素材资源',
  '课外活动',
  '节日专题',
  '其它专题',
  '本地新闻',
  '责权申明',
  '企业文化',
  '常见问题',
  '系统新闻',
  '后台公用',
  '会员中心',
  '管理员用',
  '公司站群',
  '行业门户',
  '本地网站',
  '常用工具',
  '临时收藏',
  '网友交流',
  '修复发布',
  '改进建议',
  '问答规范',
  '-临时-',
  // 3: 
  '普通书',
  '电子书',
  '电视机',
  '女内衣',
  '孕妇装',
  '学习类',
  '工作类',
  '生活类',
  '工具类',
  // 2: 
  '外衣',
  '冰箱',
  '月报',
  '外裤',
  '内裤',
  '童装',
  '空调',
  '反馈',
);



/*******************************************************************************
 File : \code\lang\dbins\base_catalog-en.php 
*******************************************************************************/
<?php
return array(
  // 8: 
  '[Top]620x60',
  '[Head]850x80',
  // 7: Loop graph text
  'RingPicText[T]',
  'RingPicText[L]',
  'RingPicText[B]',
  'RingPicText[R]',
  'FriendsLink[B]',
  'HotRes.[S]',
  'Adv.[Side]A',
  'PeaceBag[S]',
  'HotPro[S]',
  'Adv.[Side]B',
  // 6: 
  'Test-AB01',
  'Test-CD23',
  // 5: 
  'English 1',
  'English 2',
  'Test Sub3',
  'Test Sub4',
  'KPI-Report',
  'Recovery',
  'Bug-Feedback',
  // 4: 
  'EnglishCorner',
  'HumorFunny',
  'SysDocs',
  'EditNote',
  'Column',
  'MobileAcc.',
  'MobilePhone',
  'BooksMedia',
  'ClothOrnament',
  'HomeApps',
  'PhoneCard',
  'HomeAdvs',
  'inPage',
  'Profile',
  'Contact',
  'Service',
  'CorpNews',
  'Customer',
  'Industry',
  'Charity',
  'Promotion',
  'Announcements',
  'CorpRules',
  'CorpTrend',
  'CorpPics',
  'AIDSInstrument',
  'PuzzleToys',
  'Education',
  'HomeEdu.',
  'SocialNature',
  'Resources',
  'ExtActivity',
  'HolidaySpecial',
  'OtherSpecial',
  'LocalNews',
  'Duty',
  'Culture',
  'FAQs',
  'Sys.News',
  'Admins',
  'UserCenter',
  'Admins',
  'CorpSites',
  'IndustryPortal',
  'LocalSites',
  'CommonTools',
  'TempFavor',
  'UserTips',
  'FixRelease',
  'Suggestions',
  'FaqsRules',
  '-Temp-',
  // 3: 
  'Book',
  'e-Book',
  'TV-Set',
  'W.Underwear',
  'MaternityDress',
  'LearningClass',
  'WorkingClass',
  'LifeClass',
  'ToolClass',
  // 2: 
  'Coat',
  'Fridge',
  'Monthly',
  'OutPants',
  'Underwear',
  'Child-Clothes',
  'AirCondition',
  'Feedback',
);



/*******************************************************************************
 File : \code\lang\dbins\base_fields-cn.php 
*******************************************************************************/
<?php
return array(
  // 15: 
  '设置[公开]后不用设置接收部门或人员',
  '内容10字符以上,支持makedown语法',
  'gif/jpg/jpeg/png格式.',
  // 11: 
  '聊天号:QQ,MSN等',
  // 9
  'http://开头',
  'zip,rar格式',
  // 8: 
  '内容10字符以上',
  '标题2-60字符',
  // 7: 
  '如:peace',
  '数字,平方公里',
  // 6 
  '2-24字符',
  // 5: 
  '如:888',
  '至少选两个',
  '跟踪Url',
  '数字,单位',
  '[无印章]',
  'bug编号',
  // 4: 
  '跳转地址',
  '显示顺序',
  '标题颜色',
  '点击次数',
  '开始时间',
  '相关信息',
  '相关用户',
  '相关图片',
  '详细地址',
  '会员名称',
  '检查重复',
  '邮件地址',
  '选择省份',
  '结束时间',
  '扩展设置',
  '演示字段',
  '相关参数',
  '公司名称',
  '流浪省份',
  '地区单选',
  '信息推荐',
  '行业类别',
  '世界地区',
  '汽车品牌',
  '公司颜色',
  '浏览次数',
  '机构名称',
  '组织名称',
  '接收部门',
  '重要等级',
  '非常重要',
  '订购次数',
  '支付方式',
  '运输方式',
  '货品金额',
  '联系方式',
  '跟踪号码',
  '接收人员',
  '是否公开',
  '图片设置',
  '相关视频',
  '发货地区',
  '印章位置',
  '通知类型',
  '关闭编辑',
  '关闭回复',
  'md显示',
  '【普通】',
  // 3: 
  '缩略图',
  '格式.',
  '关键字',
  '外观图',
  '聊天号',
  '联系人',
  '工作地',
  '不重要',
  '批量价',
  '订单号',
  '总数量',
  '总重量',
  '处理中',
  '已付款',
  '已发货',
  '侧面图',
  '内部图',
  '附件图',
  '按设置',
  '不通知',
  // 2: 
  '开头',
  '如:',
  '内容',
  '作者',
  '来源',
  '描述',
  '标签',
  '内饰',
  '配件',
  '网址',
  '地址',
  '称呼',
  '字符',
  '标题',
  '推荐',
  '电话',
  '邮件',
  '邮箱',
  '籍贯',
  '行业',
  '点击',
  '品牌',
  '地图',
  '四川',
  '广东',
  '湖南',
  '广西',
  '江西',
  '密码',
  '部门',
  '附件',
  '格式',
  '国别',
  '普通',
  '重要',
  '规格',
  '型号',
  '价格',
  '年级',
  '课程',
  '参数',
  '数量',
  '重量',
  '备注',
  '状态',
  '新建',
  '退货',
  '运费',
  '折扣',
  '总额',
  '人口',
  '面积',
  '坐标',
  '区号',
  '简介',
  '公开',
  '视频',
  '类型',
  '咨询',
  '建议',
  '投诉',
  '致谢',
  '帮助',
  '右下',
  '左下',
  '右上',
  '左上',
  '短信',
  '微信',
  '精华',
  '有用',
  '收藏',
  '昵称',
  '显示',
  '文本',
  '热度',
  '开放',
  '编号',
  '回复',
  // 1
  '元',
  '万',
);



/*******************************************************************************
 File : \code\lang\dbins\base_fields-en.php 
*******************************************************************************/
<?php
return array(
  // 15: 
  'Set[Public],Dont set Receiving department or personnel',
  'Detail more than 10 Letters, support makedown',
  'ormat:gif/jpg/jpeg/png',
  // 11: 
  'imNum.QQ,MSN',
  // 9
  'begin with http://',
  'format:zip,rar',
  // 8: 
  'Detail more than 10 Letters',
  'Title 2-60 Letters',
  // 7: 
  'eg:peace',
  'Num,Square kilometre',
  // 6 
  '2-24 Letters',
  // 5: 
  'eg:888',
  'At least two',
  'Trace Url',
  'Num,Unit',
  '[NoSeal]',
  'bug.No',
  // 4: 
  'JumpUrl',
  'ShowOrder',
  'TitleColor',
  'ClickTimes',
  'StartTime',
  'Rel.Info.',
  'Rel.Uers',
  'Rel.Pics',
  'DetailAddr.',
  'UserName',
  'CheckRepeat',
  'MailAddr.',
  'Province',
  'EndTime',
  'ExtSet.',
  'DemoFields',
  'Rel.Param',
  'Company',
  'Wandering',
  'AreaSingle',
  'InfoRecom',
  'Field',
  'World',
  'Auto',
  'CorpColor',
  'ViewTimes',
  'InsName',
  'OrgName',
  'AcceptDept.',
  'Important-Level',
  'Very-Important',
  'OrderTimes',
  'PayMode',
  'SendMode',
  'Amount',
  'LinkName',
  'TraceNo',
  'Receiver',
  'Public',
  'PicSet.',
  'Rel.Video',
  'SendArea',
  'SealPos.',
  'NoticeType',
  'CloseEdit',
  'CloseReply',
  'mdShow',
  '【Common】',
  // 3: 
  'Thumb',
  'Format.',
  'Keyword',
  'OutPic',
  'imNum.',
  'LinkName',
  'JobAddr',
  'Unimportant',
  'BatchPrice',
  'OrderNo',
  'AllCount',
  'AllWeight',
  'Doing',
  'Paied',
  'Sent',
  'SidePic',
  'InnPic',
  'AccPic',
  'UseSetting',
  'NoNotice',
  // 2: 
  'Begin with',
  'eg:',
  'Detail',
  'Author',
  'From',
  'Desc.',
  'Tag',
  'InnerAcc.',
  'Accessories',
  'Url',
  'Address',
  'Called',
  'Letters',
  'Tile',
  'Recommend',
  'Tel',
  'E-mail',
  'E-mail',
  'Hometown',
  'Field',
  'Click',
  'Brand',
  'Map',
  'Sicuan',
  'Guangdong',
  'Hunan',
  'Guangxi',
  'Jiangxi',
  'Password',
  'Depart',
  'Attach',
  'Format',
  'Country',
  'Ordinary',
  'Important',
  'Speci.',
  'Model',
  'Price',
  'Grade',
  'Course',
  'Param',
  'Count',
  'Weight',
  'Notes',
  'State',
  'New',
  'Returns',
  'Freight',
  'Discount',
  'Total',
  'Population',
  'Area',
  'Coordinate',
  'ZoreNo',
  'Profile',
  'Public',
  'Video',
  'Type',
  'Consulting',
  'Suggest',
  'Complaint',
  'Thank',
  'Help',
  'RB',
  'LB',
  'RT',
  'LT',
  'SMS',
  'Wechat',
  'Essence',
  'Usefull',
  'Favor',
  'Nick',
  'Show',
  'Text',
  'Hot',
  'Open',
  'No',
  'Reply',
  // 1
  'Dollar',
  'Million',
);



/*******************************************************************************
 File : \code\lang\dbins\base_grade-cn.php 
*******************************************************************************/
<?php
return array(
  // 5: 
  '超级管理员',
  '会员管理员',
  '信息管理员',
  '系统架构员',
  '广告管理员',
  '过期管理员',
  '权限测试员',
  'VIP个人',
  'VIP企业',
  'VIP机构',
  'VIP组织',
  // 4: 
  '普通个人',
  '普通企业',
  '一般机构',
  '一般组织',
  '过期个人',
  '过期企业',
  '禁用机构',
  '过期组织',
  '超级会员',
  '普通会员',
  '过期会员',
  // 2: 
  '个人',
  '企业',
  '机构',
  '组织',
);



/*******************************************************************************
 File : \code\lang\dbins\base_grade-en.php 
*******************************************************************************/
<?php
return array(
  // 5: 
  'Supper Manager',
  'User Manager',
  'Info. Manager',
  'Sys. Manager',
  'Adv. Manager',
  'Expired Organization',
  'Permission Tester',
  'VIP Personal',
  'VIP Corporate',
  'VIP Institution',
  'VIP Organization',
  // 4: 
  'Common Personal',
  'Common Corporate',
  'Common Institution',
  'Common Organization',
  'Expired Admin',
  'Expired Personal',
  'Disable Institution',
  'Expired Corporate',
  'Supper Member',
  'Common Member',
  'Expired Member',
  // 2: 
  'Personal',
  'Corporate',
  'Institution',
  'Organization',
);



/*******************************************************************************
 File : \code\lang\dbins\base_menu-cn.php 
*******************************************************************************/
<?php
return array(
  // 10: 
  '栏目管理:文档/广告',
  // 9: 
  '管理员:设置/添加',
  '测试-按设置的权限',
  'Session权限',
  // 8: 
  '广告,连接,推送',
  '架设,插件,接口',
  '类别:管理/关联',
  '工具,菜单,收藏',
  // 7: 
  '演示菜单,扩展',
  '测试-游客权限',
  '测试-登录权限',
  'Flash上传',
  // 6: 
  '菜单导航配置',
  '等级权限设置',
  '网站留言管理',
  // 5: 
  '新闻,资讯',
  '根模块架设',
  '产品,会员',
  '数据库管理',
  '编辑器权限',
  '插件/接口',
  '非盈利组织',
  '论坛,公文',
  '权限提示页',
  'SEO优化',
  'DIY配置',
  // 4: 
  '超管架构',
  '类别管理',
  '参数设置',
  '核心参数',
  '文档栏目',
  '栏目管理',
  '广告栏目',
  '核心架构',
  '字段配置',
  '全局参数',
  '插件接口',
  '收藏帮助',
  '网址收藏',
  '工具应用',
  '信息中心',
  '会员相关',
  '我的收藏',
  '系统工具',
  '超管工具',
  '附件浏览',
  '附件上传',
  '附件管理',
  '会员管理',
  '安全日志',
  '安全参数',
  '新闻介绍',
  '站点介绍',
  '新闻动态',
  '专题新闻',
  '新闻评论',
  '内部公文',
  '阅读记录',
  '支付记录',
  '公文会员',
  '公文管理',
  '短信接口',
  '短信发送',
  '数据工具',
  '采集导入',
  '数据导入',
  '优化推送',
  '分享同步',
  '数据分享',
  '计划任务',
  '缓存静态',
  '系统缓存',
  '产品管理',
  '邮件接口',
  '邮件记录',
  '个人资料',
  '个人会员',
  '企业会员',
  '政府机构',
  '产品订单',
  '订单管理',
  '调试工具',
  '开发工具',
  '上传类型',
  '图片上传',
  '媒体上传',
  '文档上传',
  '课程资源',
  '微信接口',
  '问答系统',
  '分类设置',
  '产品分类',
  '评论设置',
  '资源评论',
  '评论栏目',
  '修改密码',
  '修改资料',
  '用户资料',
  '游客权限',
  '会员首页',
  '订单查询',
  '更新升级',
  '订单详情',
  '公文详情',
  '接收公文',
  '会员登录',
  '会员申请',
  '找回密码',
  '环境检测',
  '基础环境',
  '配置搜索',
  '管理发布',
  '问答管理',
  '评论记录',
  '公文发布',
  '回复标签',
  '问答回复',
  '统计更新',
  '问答统计',
  '其他互动',
  // 3: 
  '管理员',
  '数据库',
  '提示页',
  '未完成',
  '已完成',
  // 2: 
  '资讯',
  '演示',
  '广告',
  '架设',
  '关联',
  '主营',
  '添加',
  '基本',
  '帮助',
  '工具',
  '管理',
  '日志',
  '增加',
  '栏目',
  '接口',
  '等级',
  '发布',
  '记录',
  '采集',
  '优化',
  '推送',
  '同步',
  '积分',
  '静态',
  '密码',
  '评论',
  '权限',
  '上传',
  '互动',
  '设置',
  '导入',
  '检测',
  '配置',
  '搜索',
  '标签',
  '更新',
  '详情',
  '类别',
  '最新',
  '精华',
  '热门',
);



/*******************************************************************************
 File : \code\lang\dbins\base_menu-en.php 
*******************************************************************************/
<?php
return array(
  // 10: 
  'Catalog:Docs/Advs',
  // 9: 
  'Admin:Set/Add',
  'Test-PermBySet',
  'SessionPerm',
  // 8: 
  'Adv,Link,Push',
  'Frame,Plus,API',
  'Type:Admin/Relat',
  'Tools,Menu,Favor',
  // 7: 
  'DemoMenu,Extra',
  'Test-GusetPerm',
  'Test-LoginPerm',
  'FlashUpload',
  // 6: 
  'Menus Config',
  'Grade Config',
  'Guestbook Admin',
  // 5: 
  'News,Info',
  'RootModel',
  'Pro,User',
  'DB-Admin',
  'EditorPermPlus',
  'Plus/Apis',
  'Organiz',
  'BBS,inDocs',
  'PermTips',
  'SEOCfgs',
  'DIYCfgs',
  // 4: 
  'AdminFrame',
  'Types',
  'ParamSet',
  'Params',
  'Catalog',
  'Catalog',
  'Advs.Cata.',
  'CoreFrame',
  'FiledConfig',
  'GlobalParam',
  'Plus-Api',
  'Favor-Help',
  'Url-Favor',
  'Tools-Apps',
  'Info.Center',
  'Rel.User',
  'MyFavor',
  'Sys.Tools',
  'Adm.Tools',
  'FileView',
  'FileUpload',
  'Files',
  'Users',
  'SafeLogs',
  'Safe',
  'News/About',
  'About US',
  'News',
  'Special',
  'Remark',
  'InnerDous',
  'Readlog',
  'Pay.Rec.',
  'inUser',
  'Indoc',
  'SMS-API',
  'SMSSend',
  'Data-Tools',
  'Crwal/Import',
  'Import',
  'PushSEO',
  'Share/Sync.',
  'Share',
  'RunPlan',
  'Cache/Static',
  'SysCache',
  'Products',
  'Email-API',
  'EmailRec.',
  'myInfo',
  'Porsnal',
  'Corporate',
  'Govern',
  'Pro.Order',
  'Order',
  'Debug.Tools',
  'Dev.Tools',
  'UploadType',
  'PicUpload',
  'MediaUpload',
  'FileUpload',
  'CourseRes.',
  'Wechat',
  'Faqs',
  'TypesSet.',
  'Catalogs',
  'RemarkSet.',
  'Remarks',
  'RerarkCatalog',
  'EditPassword',
  'EditInfo',
  'UserInfo.',
  'GuestPerm',
  'UserHome',
  'OrderQuery',
  'Update',
  'OrderDetail',
  'IndocDetail',
  'IndocAccept',
  'UserLogin',
  'UserApply',
  'GetPassword',
  'Env.Check',
  'BasicEnv.',
  'Cfg/Search',
  'AdminPub.',
  'Faqs',
  'Remarks',
  'InnerDocPub',
  'ReplyTag',
  'FaqsReply',
  'State/Update',
  'States',
  'Others',
  // 3: 
  'Adminer',
  'DB',
  'Tips Page',
  'Doing',
  'Completed',
  // 2: 
  'News',
  'Demo',
  'Advs',
  'Frame',
  'Relat',
  'Main',
  'Add',
  'Basic',
  'Help',
  'Tools',
  'Manage',
  'Logger',
  'Add',
  'Catalog',
  'API',
  'Grade',
  'Publish',
  'Rec.',
  'Collection',
  'Optimizing',
  'Push',
  'Sync',
  'Piont',
  'Static',
  'Password',
  'Remark',
  'Perm',
  'Upload',
  'Interact',
  'Setting',
  'Import',
  'Check',
  'Config',
  'Search',
  'Tag',
  'Refresh',
  'Detail',
  'Type',
  'Latest',
  'Essence',
  'Hot',
);



/*******************************************************************************
 File : \code\lang\dbins\base_model-cn.php 
*******************************************************************************/
<?php
return array(
  // 11: 
  '要使用第三方资源的功能',
  // 9: 
  '根群组,模块,架设',
  // 8: 
  '新闻,专题,文章',
  '广告,连接,推送',
  '分类,系列,分组',
  '留言,评论,投票',
  // 6: 
  '会员,管理员',
  'test备注',
  // 5: 
  '群组/模块',
  '文档/资讯',
  '广告/连接',
  '插件/接口',
  '用户/会员',
  '分类/组系',
  '设置/后台',
  '设置/核心',
  '设置/用户',
  '设置/会员',
  '菜单/导航',
  '菜单,导航',
  '互动/评论',
  '非盈利组织',
  // 4: 
  '后台设置',
  '核心设置',
  '用户设置',
  '会员设置',
  '企业会员',
  '网站留言',
  '样例文档',
  '个人会员',
  '政府机构',
  '后台菜单',
  '会员菜单',
  '基本开关',

  '安全参数',
  '短信接口',
  '支付接口',
  '邮件接口',
  '网站介绍',
  '新闻动态',
  '商品展销',
  '权限脚本',
  '阅读记录',
  '新闻评论',
  '附加权限',
  '公文会员',

  '内部公文',
  '专题新闻',
  '图片连接',
  '文字连接',
  '显示参数',
  '演示评论',
  '微信接口',
  '专题评论',
  '课程资源',
  '订单明细',
  '产品评论',
  '资源评论',
  
  '网址收藏',
  '公文评论',
  '问答系统',
  '问答回复',
  '问答标签',
  // 3: 
  '管理员',
  '文本块',
  '购物车',
  // 2: 
  '备注',
  '省市',
  '国家',
  '车型',
  '推荐',
  '行业',
  '学历',
  '民族',
  '镇区',
  '部门',
  '年级',
  '课程',
  '品牌',
  '订单',
  // Ext
  '[广告]表',
  '[互动]表',
  '[扩展]表',
  '[分类]表',
  '[会员]表',
  '[主]表',
);



/*******************************************************************************
 File : \code\lang\dbins\base_model-en.php 
*******************************************************************************/
<?php
return array(
  // 11: 
  'Need the 3rd party resources',
  // 9: 
  'Groups,Model,Frames',
  // 8: 
  'News, Project, Article',
  'Advs, Links, Push',
  'Type,Series,Grouping',
  'Guestbook,Comment,Vote',
  // 6: 
  'Member,Admin',
  'test Remark',
  // 5: 
  'Group/Module',
  'Docs/News',
  'Advs/Links',
  'Plug/APIs',
  'User/Member',
  'Types/Series',
  'Setting/Admin',
  'Setting/Core',
  'Setting/User',
  'Setting/Member',
  'Menu/Nav.',
  'Menu,Nav.',
  'Interaction/Review',
  'Organization',
  // 4: 
  'AdminSet.',
  'CoreSet.',
  'UserSet.',
  'MemberSet.',
  'Corporate',
  'Guestbook',
  'DemoDocu.',
  'Personal',
  'Government',
  'AdminMenu',
  'UserMenu',
  'BaseSwitch',

  'SafeParam',
  'SmsAPI',
  'PayAPI',
  'MailAPI',
  'Introduce',
  'News',
  'Product',
  'PermScript',
  'ReadRecs',
  'NewsReview',
  'ExtraPerm',
  'InnerUser',

  'Inner Docs',
  'Topic',
  'PicLink',
  'TextLink',
  'ShowParam',
  'DemoReview',
  'WeChatAPI',
  'Spec.Review',
  'Course-Res.',
  'Order-Detail',
  'Pro.Reviews',
  'Res.Review',
  
  'Favor Urls',
  'Indoc.Review',
  'QA-System',
  'QA-Reply',
  'QA-Label',
  // 3: 
  'Admin',
  'TextBlock',
  'ShopCart',
  // 2: 
  'Remark',
  'Prov-City',
  'Country',
  'Cars',
  'Recom',
  'Industry',
  'Edu.',
  'Nation',
  'Town',
  'Depart',
  'Grade',
  'Course',
  'Brand',
  'Order',
  // Ext
  '[Advs]Tab.',
  '[Coms]Tab.',
  '[Extra]Tab.',
  '[Type]Tab.',
  '[User]Tab.',
  '[Main]Tab.',
);



/*******************************************************************************
 File : \code\lang\dbins\base_paras-cn.php 
*******************************************************************************/
<?php
return array(
  // 12
  'm混淆码-adminer',
  // 11: 
  '会员中心列表每页资料数',
  '后台资料列表每页资料数',
  '资料选取列表每页资料数',
  '前台资料列表每页资料数',
  'Other-其他随机码',
  // 9: 
  '关闭mob显示模板',
  '关闭dev显示模板',
  '安全过滤-数组前缀',
  '管理后台_超时时间',
  '随机62位不重复码',
  '关闭chn显示模板',
  // 8: 
  '显示dev需登录',
  '密码加密-混淆码',
  '安全过滤-随机码',
  '特殊字符-随机码',
  'open开窗方式',
  // 7: 
  '全站唯一随机码',
  '会员_超时时间',
  'API-随即码',
  'pop开窗方式',
  // 6: 
  '系统管理模式',
  '提示停留时间',
  '数字-随机码',
  'JS-随即码',
  '18-48位',
  // 5: 
  '系统编辑器',
  '地图API',
  '其他随机码',
  '随机6位码',
  // 4: 
  '仅管理员',
  '会员登录',
  '不需登录',
  '调试模式',
  '站点名称',
  '开窗方式',
  ',建议1',
  // 3: 
  '贴心猫',
  '随即码',
  '4之间',
  '48位',
  // 2: 
  '开启',
  '关闭',
  '调试',
  '百度',
  '推荐',
  '毫秒',
  '单位',
  '之间',
  '4位',
  // 1
  '时',
);



/*******************************************************************************
 File : \code\lang\dbins\base_paras-en.php 
*******************************************************************************/
<?php
return array(
  // 12
  'm.ConfusionCode-adminer',
  // 11: 
  'Member List Pagesize',
  'Admin List Pagesize',
  'Pick List Pagesize',
  'Fron List Pagesize',
  'Other-RandomCode',
  // 9: 
  'Close mob',
  'Close dev',
  'SafeFilter/ArrayPrefix',
  'AdminTimeout',
  '62 bit RandomCode(Unique)',
  'Close chn',
  // 8: 
  'dev-Need Login',
  'Password-ConfusionCode',
  'Safe-RandomCode',
  'SpeChar-RandomCode',
  'open-WindowMode',
  // 7: 
  'Unique RandomCode',
  'MemberTimeout',
  'API-RandomCode',
  'pop-WindowMode',
  // 6: 
  'OperationMode',
  'TipsDelayTime',
  'Num-RandomCode',
  'JS-RandomCode',
  '18-48 bit',
  // 5: 
  'SysHtmlEditor',
  'Map-API',
  'Else-RandomCode',
  '6 bit RandomCode',
  // 4: 
  'OnlyAdmin',
  'UserLogin',
  'OpenFree',
  'DebugMode',
  'SiteName',
  'WindowMode',
  ',Suggestions1',
  // 3: 
  'IntimateCat',
  'RandomCode',
  'Beteen 4 and',
  '48 bit',
  // 2: 
  'Open',
  'Close',
  'Debug',
  'Baidu',
  'Recommend',
  'MilliSec',
  'Unit',
  'Beteen',
  '4 bit',
  // 1
  'Hour',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_cron-cn.php 
*******************************************************************************/
<?php
return array(
  // 6 
  '示例计划任务',
  '清理操作记录',
  '清理调试记录',
  '清理微信缓存',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_cron-en.php 
*******************************************************************************/
<?php
return array(
  // 6 
  'Example planning tasks',
  'Clean operating records',
  'Clean debugging record',
  'WeChat cache cleanup',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_dbdict-cn.php 
*******************************************************************************/
<?php
return array(
  // 8: 
  '是否系统内置参数',
  '是否系统内置模型',
  // 7: 
  '附加cam参数',
  '外部数据源ID',
  '外部数据SQL',
  // 6: 
  '删除资料减分',
  '添加资料加分',
  '支付接口ID',
  '批次运行条数',
  '最后导入键值',
  '对应时间字段',
  '综合处理标记',
  '替换原始内容',
  '结果处理函数',
  '处理函数参数',
  '为空时默认值',
  'API用户名',
  // 5: 
  '菜单Key',
  '参数key',
  '接口定单号',
  '样例详情页',
  '基础列表页',
  '已采页记录',
  '网址根目录',
  '字段默认值',
  '外部URL',
  '导入的模型',
  '内容替换表',
  'sql语句',
  'API模块',
  // 4: 
  '模块权限',
  '超时时间',
  '发送结果',
  '信息内容',
  '用户密码',
  '用户模型',
  '订单ID',
  '扩展数字',
  '电话号码',
  '菜单名称',
  '回复状态',
  '用户积分',
  '附加参数',
  '积分数量',
  '积分操作',
  '积分模块',
  '执行周期',
  '周期单位',
  '最后执行',
  '下次执行',
  '执行耗时',
  '忽略时段',
  '错峰时刻',
  '字符编码',
  '翻页规则',
  '网址含有',
  '网址不含',
  '网址替换',
  '忽略字段',
  '系统ID',
  '外部ID',
  '处理标记',
  '主键类型',
  '同步模型',
  '同步栏目',
  '覆盖标记',
  '采集采集',
  // 3: 
  '二维码',
  '来源页',
  '关键字',
  '模块2',
  '模块1',
  '参数值',
  '管理员',
  '字段名',
  '用户名',
  '菜单值',
  '随机码',
  '数字a',
  '数字b',
  '主键名',
  // 2: 
  '密码',
  '精度',
  '耗时',
  '标签',
  '模版',
  '语句',
  '纬度',
  '附加',
  '审核',
  '删除',
  '添加',
  '脚本',
  '会员',
  '插件',
  '经度',
  '数据',
  '备注',
  '表名',
  '模块',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_dbdict-en.php 
*******************************************************************************/
<?php
return array(
  // 8: 
  'isSysParam',
  'isSysModel',
  // 7: 
  'Extra-cam-Param',
  'Outter Data-Soursce',
  'Outter Data-SQL',
  // 6: 
  'Sub-Points(Del)',
  'Add-Points(Add)',
  'PayAPI-ID',
  'BacthRun-Rows',
  'LastImpKey',
  'TimeField',
  'DeelMark',
  'Replace',
  'DeelFunction',
  'Func-Param',
  'DefValue While Null',
  'API-UserID',
  // 5: 
  'Menu-Key',
  'Param-key',
  'API-OrderNo',
  'DemoDetailPage',
  'BaseListPage',
  'CollectedPage',
  'Url Root',
  'DefaultValue',
  'Outter-URL',
  'Import Model',
  'Replace-Tab',
  'sql-Statement',
  'API-Model',
  // 4: 
  'ModelPerm',
  'Timeout',
  'SendResult',
  'InfoDetail',
  'User Pass',
  'User Model',
  'Order.ID',
  'ExtNumber',
  'TelNumber',
  'MenuName',
  'Rep.State',
  'UserPiont',
  'ExtraParam',
  'Piont Count',
  'Piont Opera',
  'Piont Model',
  'Run Cycle',
  'Cycle Unit',
  'Last Run',
  'Next Run',
  'Run Time',
  'Ignore Time',
  'Busy Time',
  'Encoding',
  'Page Rule',
  'Url Include',
  'Url NotInc.',
  'Url Replace',
  'Ignore Field',
  'Sys.ID',
  'Outter.ID',
  'DeelMark',
  'PrimaryType',
  'SynModel',
  'SynCatalog',
  'OverFlag',
  'CollectCollect',
  // 3: 
  'QRCode',
  'FromPage',
  'Keyword',
  'Model-2',
  'Model-1',
  'ParValue',
  'Admin',
  'FieldName',
  'UserName',
  'MenuValue',
  'RandomCode',
  'Num-a',
  'Num-b',
  'Primary',
  // 2: 
  'Password',
  'Precision',
  'TimeUsed',
  'Tag',
  'Template',
  'Statement',
  'Latitude',
  'Additional',
  'Check',
  'Del',
  'Add',
  'Script',
  'Member',
  'Plug',
  'Longitude',
  'Data',
  'Remark',
  'Table',
  'Model',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_fields-cn.php 
*******************************************************************************/
<?php
return array(
  // 6 
  '2-24字符',
  // 5: 
  '上薄下厚杯',
  '蕾丝超薄杯',
  '可摘卸肩带',
  '丁字/T裤',
  '400电话',
  '800电话',
  'XXXL码',
  // 4: 
  '手机类型',
  '主屏尺寸',
  '操作系统',
  '适用机型',
  '上架类目',
  '学生读物',
  '作者编辑',
  '无纺布杯',
  '外观颜色',
  '开始使用',
  '模板标签',
  '高级设置',
  '完整开发',
  '基础测试',
  '技巧分享',
  '3/4杯',
  '4/4杯',
  '1/2杯',
  'XXL码',
  // 3: 
  '核心数',
  '双四核',
  '励志类',
  '外文类',
  '文史哲',
  '参考书',
  '营运商',
  '出版社',
  '超薄杯',
  '中厚杯',
  '厚模杯',
  '加厚杯',
  '水袋杯',
  '三角杯',
  '大罩杯',
  '无钢托',
  '前系扣',
  '平角裤',
  '三角裤',
  '超大码',
  '图片集',
  'XL码',
  // 2: 
  '电话',
  '字符',
  '智能',
  '商务',
  '拍照',
  '老人',
  '单核',
  '双核',
  '四核',
  '八核',
  '颜色',
  '白色',
  '黑色',
  '银灰',
  '咖啡',
  '红色',
  '金色',
  '蓝色',
  '材质',
  '移动',
  '联通',
  '电信',
  '网络',
  '薄厚',
  '薄杯',
  '模杯',
  '杯型',
  '抹胸',
  '深V',
  '功能',
  '聚拢',
  '无痕',
  '侧收',
  '托高',
  '舒适',
  '美背',
  '款式',
  '尺码',
  '大码',
  '均码',
  '灰色',
  '地图',
  '标签',
  'S码',
  'M码',
  'L码',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_fields-en.php 
*******************************************************************************/
<?php
return array(
  // 6 
  '2-24 Letters',
  // 5: 
  'Thin-Thick Cup',
  'Lace Slim Cup',
  'Removable shoulder strap',
  'T-shapedPants',
  '400 Tel',
  '800 Tel',
  'Size-XXXL',
  // 4: 
  'Mobile Type',
  'Screen size',
  'OS',
  'ForModel',
  'Shelves category',
  'Student Book',
  'Author editor',
  'Nnon-woven cup',
  'Appearance color',
  'Start to use',
  'Template tag',
  'Advanced set',
  'Full development',
  'Basic test',
  'Skill sharing',
  '3/4 Cup',
  '4/4 Cup',
  '1/2 Cup',
  'Size-XXL',
  // 3: 
  'Core Number',
  'Dual Quad Core',
  'Inspirational',
  'Foreign language',
  'Literature,History,Philosophy',
  'Reference book',
  'Operator',
  'Press',
  'Slim cup',
  'Medium thick cup',
  'Thick cup',
  'Upset cup',
  'The Cup bag',
  'Triangle cup',
  'The big cup',
  'No steel',
  'Front buckle',
  'Trousers',
  'Triangle pants',
  'Super large code',
  'Pictures',
  'Size-XL',
  // 2: 
  'Tel',
  'Letters',
  'Smart',
  'Business',
  'Photo',
  'Old-Mman',
  'Single-Core',
  'Dual-Core',
  '4-Core',
  '8-Core',
  'Color',
  'White',
  'Black',
  'Silver',
  'Coffee',
  'Red',
  'Gold',
  'Blue',
  'Material',
  'MobileCom',
  'Unicom',
  'TelCom',
  'NetWork',
  'Thick',
  'thin-cup',
  'Mode-cup',
  'Cup-type',
  'Bra',
  'Deep-V',
  'Function',
  'Gather',
  'No-Mark',
  'CollectSide',
  'PropUp',
  'Comfortable',
  'Beauty',
  'Style',
  'Size',
  'Big Size',
  'Free Size',
  'Gray',
  'Map',
  'Tag',
  'Size-S',
  'Size-M',
  'Size-L',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_paras-cn.php 
*******************************************************************************/
<?php
return array(
  // 15: 
  '广东省内其它市区每件快递20元',
  '注:写字楼/商用地址客户请选择此项',
  '测试测试测试测试测试测试测试测试测试',
  // 14: 
  '3.0Kg以下,含3.0Kg',
  '国内其它省区内每件快递35元',
  '工作日,双休日与假日均可送货',
  // 12: 
  '东莞市区内每件快递10元',
  '珠三角区内每件快递15元',
  // 10: 
  'Paypal快速付款',
  '百度Siatemap',
  'Google站点地图',
  // 9: 
  '双休日,假日不送货',
  '只双休日,假日送货',
  // 8: 
  '工作日均不可送货',
  // 7: 
  '支付宝手机支付',
  '支付宝即时到账',
  '支付宝担保交易',
  '节假日不可送货',
  '邮政EMS快递',
  '推送token',
  'n请点击查看。',
  // 6: 
  '国内其它省区',
  '只工作日送货',
  '支付流程演示',
  '支付演示帐号',
  '百度主动推送',
  '最后推送时间',
  '手机短信模板',
  'n请点击查看',
  '微信通知模板',
  // 5: 
  '支付宝帐号',
  '珠三角区内',
  '随时可送货',
  '节假日送货',
  'EMS快递',
  '宅急送快递',
  '财付通支付',
  '发来的公文',
  // 4: 
  '东莞市区',
  '广东省内',
  '天天快递',
  '韵达快递',
  '圆通快递',
  '全一快递',
  '申通快递',
  '微信支付',
  '推送站点',
  '您收到了',
  // 3: 
  '宅急送',
  '幼儿园',
  '小学生',
  '初中生',
  '高中生',
  '大学生',
  // 2
  '硕士',
  '博士',
  '天天',
  '韵达',
  '圆通',

);



/*******************************************************************************
 File : \code\lang\dbins\bext_paras-en.php 
*******************************************************************************/
<?php
return array(
  // 15: 
  'Other urban areas in Guangdong Province, 20 yuan per courier',
  'Notes:Office / commercial address customer please select this item',
  'Test,Test,Test,Test,Test,Test,Test',
  // 14: 
  'below 3.0Kg(include 3.0Kg)',
  'Domestic other provinces within each express 35 yuan',
  'working days, weekends and holidays can deliver',
  // 12: 
  '10 yuan in Dongguan',
  '15 yuan within the Pearl River',
  // 10: 
  'Paypal Express',
  'Baidu Siatemap',
  'Google Siatemap',
  // 9: 
  'Weekends, holidays delivery',
  'Only on weekends, holidays delivery',
  // 8: 
  'work can not be delivered daily', 
  // 7: 
  'Alipay Wap Pay',
  'Alipay Derect Pay',
  'Alipay secured',
  'holidays can not be delivered',
  'Post EMS Express',
  'Push token',
  'nClick View.',
  // 6: 
  'Other provinces and autonomous regions',
  'Only work day delivery',
  'Demo Payment Process',
  'Pay demo account',
  'Baidu active push',
  'Last push time',
  'SMS Notice template',
  'nClick View',
  'Wechat Notice Tpl',
  // 5: 
  'Alipay ID',
  'Within the Pearl River',
  'Can be delivered at any time',
  'Holiday delivery',
  'EMS Express',
  '宅急送 Express',
  'TenPay pay',
  'Inner Doc From',
  // 4: 
  'In Dongguan',
  'In Guangdong',
  '天天 Express',
  '韵达 Express',
  '圆通 Express',
  '全一 Express',
  '申通 Express',
  'Wechat Pay',
  'Push Site',
  'Your Got',
  // 3: 
  '宅急送',
  'Nursery',
  'Pupil',
  'Junior',
  'Senior',
  'College',
  // 2
  'Master',
  'Doctor',
  '天天',
  '韵达',
  '圆通',

);



/*******************************************************************************
 File : \code\lang\dbins\bext_relat-cn.php 
*******************************************************************************/
<?php
return array(
  // 6
  '年级下的课程',
  '产品下的品牌',
  // 5
  '年级?课程',
  '产品?品牌',
  // 2: 
  '年级',
  '课程',
  '产品',
  '品牌',
);



/*******************************************************************************
 File : \code\lang\dbins\bext_relat-en.php 
*******************************************************************************/
<?php
return array(
  // 6
  'Course for Grade',
  'Brand for Product',
  // 5
  'Grade禄Course',
  'Product禄Brand',
  // 2: 
  'Grade',
  'Course',
  'Product',
  'Brand',
);



/*******************************************************************************
 File : \code\lang\kvphp\a3rd-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

  //paydemo_dir/index.php
  'demo_title' => '支付流程演示',
  'index_notitle' => '商户订单号：',
  'index_tipno' => '唯一订单号，必填',
  'index_tipmust' => '必填',
  'index_ordtitle' => '订单名称：',
  'index_ordamount' => '付款金额：',
  'index_ordrem' => '订单描述：',
  'index_ordurl' => '商品展示地址：',
  'index_confirm' => '确 认',

  //paydemo_dir/payweb.php
  'payweb_loginok' => '登录OK！',
  'payweb_erragain' => '错误！请复制重新登录',
  'payweb_copyto' => '请复制到左边框模拟登录',
  'payweb_tradeno' => '单号:',
  'payweb_amount' => '金额:',
  'payweb_demoid' => '模拟账号:',
  'payweb_demopw' => '模拟密码:',
  'payweb_idpwtip' => '包含前面的user_,pass_，不含空格。 ',
  'payweb_letters316' => '字母开头,允许3-16字节<br>允许字母数字下划线',
  'payweb_letters615' => '允许6,15字节',
  'payweb_refresh' => '刷新',

  //paydemo_dir/uapi.php
  'uapi_title' => '支付流程演示交易接口',
  'uapi_confirm' => '确认',

  //paydemo_dir/ureturn.php
  'ureturn_ok' => '验证成功',
  'ureturn_ng' => '验证失败',

  //paydemo_dir/xresult.php
  'xresult_title' => '支付结果提示',
  'xresult_ordno' => '单号:',
  'xresult_sysno' => '系统单号:',
  'xresult_amount' => '金额:',
  'xresult_tradeno' => '交易号:',
  'xresult_state' => '状态码:',

  //paydemo_dir/xsend.php
  'xsend_title' => '支付调试页',
  'xsend_send' => '提交',

);




/*******************************************************************************
 File : \code\lang\kvphp\a3rd-en.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

  //paydemo_dir/index.php
  'demo_title' => 'Demo Pay Flow',
  'index_notitle' => 'Order No: ',
  'index_tipno' => 'Unique Order No, *Must',
  'index_tipmust' => ' *Must',
  'index_ordtitle' => 'Order Name: ',
  'index_ordamount' => 'Amount: ',
  'index_ordrem' => 'Desc.: ',
  'index_ordurl' => 'Item Url: ',
  'index_confirm' => 'Confirm',

  //paydemo_dir/payweb.php
  'payweb_loginok' => 'Login OK！',
  'payweb_erragain' => 'Error! Please Login again',
  'payweb_copyto' => 'Please copy to the input box',
  'payweb_tradeno' => 'Order NO:',
  'payweb_amount' => 'Amount:',
  'payweb_demoid' => 'Demo User:',
  'payweb_demopw' => 'Demo Pass:',
  'payweb_idpwtip' => 'Include fix:(user_,pass), no blanks.',
  'payweb_letters316' => 'Letters:3-16',
  'payweb_letters615' => 'Letters:6~15',
  'payweb_refresh' => 'Refresh',

  //paydemo_dir/uapi.php
  'uapi_title' => 'Demo Pay API',
  'uapi_confirm' => 'Confirm',

  //paydemo_dir/ureturn.php
  'ureturn_ok' => 'Check OK',
  'ureturn_ng' => 'Fault',

  //paydemo_dir/xresult.php
  'xresult_title' => 'Pay Result Message',
  'xresult_ordno' => 'Order NO:',
  'xresult_sysno' => 'Sys. NO:',
  'xresult_amount' => 'Amount:',
  'xresult_tradeno' => 'Trade No:',
  'xresult_state' => 'State:',

  //paydemo_dir/xsend.php
  'xsend_title' => 'Pay Dubug',
  'xsend_send' => 'Send',

);




/*******************************************************************************
 File : \code\lang\kvphp\admin-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// admin/rlogs.php
	'rl_rtime' => '耗时',
	'rl_setpm' => '设置参数',

	// admin/grade.php
	'grd_gperm' => '[等级权限]',
	'grd_set' => '设置',
	'grd_edit' => '修改条目',
	'grd_back' => '返回',
	'grd_glist' => '等级列表',
	'grd_mod' => '模块',
	'grd_pedit' => '权限编辑',
	'grd_tmenu' => '顶级菜单',

	// admin/db_act.php
	'dba_sel' => '选择',
	'dba_stab' => '-请选择表-',
	'dba_dict' => '[数据库词典]',
	'dba_clear' => '[清理]',
	'dba_tabs' => '个表',
	'dba_opt' => '优化',
	'dba_fix' => '修复',
	'dba_ok' => '成功!',
	'dba_dok' => '项备注更新成功',
	'dba_deel' => '执行',
	'dba_dbtab' => '数据表',
	'dba_upd' => '更新',
	'dba_gray' => '灰色不能编辑',
	'dba_view' => '已经生成：查看……',

	// admin/relat.php
	'rel_upd' => '更新',
	'rel_add' => '增加条目',
	'rel_radm' => '关联项目管理',
	'rel_ct' => '类别/栏目',
	'rel_edit' => '修改条目',
	'rel_doc' => '文档',
	'rel_type' => '类别',
	'rel_sel' => '请选择',
	'rel_relist' => '返回列表',
	'rel_set' => '设置',
	'rel_ritems' => '关联项目',
	'rel_relx' => '关联的',

	// binc/set_id.php
	'sid_eid' => '改ID',
	'sid_ok' => '成功',
	'sid_move' => '移动',
	'sid_sel' => '-请选择-',
	'sid_top' => '-顶级-',
	'sid_uinmv' => '移动操作生效',

	// admin/types.php
	'tp_ordok' => '排序成功！',
	'tp_chkinc' => '检查ID包含',
	'tp_updchar' => '更新字母',
	'tp_ordchar' => '字母排序',

	// admin/catalog.php
	'cat_dsub' => '[{val}]该条目含有子类，请先删除子类！',
	'cat_close' => '[未启用]条目,不能增加',
	'cat_edit' => '修改条目',
	'cat_frame' => '结构',
	'cat_xframe' => '非结构',

	// admin/ediy.php
	'ediy_extool' => '附加工具',
	'ediy_rebok' => '还原成功！',
	'ediy_editok' => '修改成功！',
	'ediy_doing' => '正在编辑',
	'ediy_size' => '大小',
	'ediy_etime' => '修改时间',
	'ediy_sbak' => '保留备份',
	'ediy_sedit' => '保存修改',
	'ediy_nosdir' => '无下层目录',
	'ediy_file' => '文件',
	'ediy_atime' => '创建时间',
	'ediy_op' => '操作',
	'ediy_rebak' => '还原',
	'ediy_edit' => 'DIY修改:',

	// admin/static.php
	'st_admin' => '静态管理',
	'st_allmod' => '全部模块',
	'st_opmode' => '操作模块',
	'st_home' => '首页',
	'st_notfound' => '不存在',
	'st_hmstatic' => '首页静态',
	'st_stfile' => '静态文件',
	'st_crpage' => '生成静态',
	'st_depage' => '删除静态',
	'st_vres' => '查看效果',
	'st_udefine' => '自定义',
	'st_cstatic' => '栏目列表静态',
	'st_allrecs' => '共约[{val}]条',
	'st_dmhome' => '模块首页（动态）',
	'st_dstatic' => '内容详情静态',
	'st_batnum' => '条/批次',

	// admin/groups.php
	'grp_copyitem' => '复制条目',
	'grp_dmode' => '内容模式',
	'grp_catlevel' => '栏目级数',
	'grp_max' => '最大',
	'grp_extab' => '启用扩展表',
	'grp_rmod' => '此模型在[关联模型]下展示才有意义；如[新闻评论]关联模型为[新闻动态];',
	'grp_pdel' => '删除(-分)',
	'grp_pset' => '积分设置',
	'grp_padd' => '添加(+分)',

	// admin/upgrade.php
	'upg_upgrade' => '[更新升级]',
	'upg_bkdb' => '备份数据库',
	'upg_tipdb' => '[建议/注意]先停止掉服务再备份；可复制数据库目录；',
	'upg_blfile' => '备份程序文件',
	'upg_tipfile' => '主要备份：/code 和 /root目录。<br>重要文件（夹）：/code/cfgs/目录，/root/run/_paths.php文件。',
	'upg_use' => '使用情景',
	'upg_tipup' => '目前是较旧版本，下载最新版本包(不用安装)，在现有较旧版本上，把新版本增加更新的文件，数据库结构更新过来；',
	'upg_upstart' => '开始升级',
	'upg_tipimp' => '目前是安装配置好的最新版本，在新版本上，把旧版本数据导入过来；',
	'upg_impstart' => '开始导入',
	'upg_tip1' => '更新升级提示',
	'upg_off' => '[官方文档]',
	'upg_tip2' => '更新升级说明<br>或查看',

	// admin/menus.php
	'mu_addone' => '增加条目',
	'mu_upd' => '[更新]',
	'mu_init' => '初始化',
	'mu_navmenu' => '[菜单导航]',
	'mu_setpm' => '按设置',
	'mu_guestpm' => '游客权限',
	'mu_loginpm' => '登录权限',
	'mu_initend' => '初始化完毕！',
	'mu_delfirst' => '请先删除子类',
	'mu_add' => '增加',
	'mu_editone' => '修改条目',
	'mu_fmta' => '格式:相对url地址或完整a标记链接：',
	'mu_flagroot' => '可用[{val}]表示根目录',
	'mu_tiptitle' => '站点介绍',
	'mu_tipline' => '一行一个；',
	'mu_typa' => '类别管理',
	'mu_set' => '设置',
	'mu_end' => '完毕！',

	// /flow/admin/*
	'fad_num' => '数字',
	'fad_adset' => '架设',
	'fad_rmod' => '关联模型',
	'fad_tip31245' => '字母开头,允许字母数字下划线<br>允许3-12字符,建议4-5字符',
	'fad_tip21245' => '字母开头,允许字母数字下划线<br>允许2-12字符,建议4-5字符',
	'fad_tip21246' => '字母开头,允许字母数字下划线<br>允许2-12字符,建议4-6字符',
	'fad_tip41245' => '字母开头,允许字母数字下划线<br>允许4-12字符,建议4-5字符',
	'fad_tip25num' => '允许2-5数字',
	'fad_uid31546' => '字母开头,允许字母数字下划线<br>允许3-15字符,建议4-6字符',
	'fad_uid41258' => '字母开头,允许字母数字下划线<br>允许4-12字符,建议5-8字符',
	'fad_up624' => '密码6-24字符',
	'fad_setid' => '设置条目-{val} (改ID/移动)',
	'fad_chrsab' => '允许{val}字符',

	//admin/uinfo.php
	'ui_uinfo' => '个人资料',
	'ui_upass' => '个人密码',
	'ui_editok' => '修改成功！',
	'ui_let624' => '6-24字符',
	'ui_oldpass' => '旧密码:',
	'ui_newpass' => '新密码:',
	'ui_again' => '再一次:',
	'ui_agtip' => '再输一次新密码',

	// glib/admAFunc.php
	'aaf_delok' => '删除成功',
	'aaf_errkeep' => '错误,可能是系统模型被保留',
	'aaf_resetok' => '重设字段成功',
	'aaf_copyok' => '复制成功',
	'aaf_addok' => '增加成功',
	'aaf_error' => '错误',
	'aaf_ttype' => '顶级类别',
	'aaf_top' => '顶级',

	// uext/exaFunc.php
	'ef_demot' => '演示样例',
	'ef_demodoc' => '样例文档',
	'ef_add' => '增加',
	'ef_demorem' => '样例评论',
	'ef_catalog' => '栏目',
	'ef_typedetail' => '类别详情',
	'ef_dept' => '部门介绍',
	'ef_brand' => '品牌介绍',
	'ef_china' => '中国政区',
	'ef_umenu' => '自定义菜单',
	'ef_demoset' => '设置参考',

	// admin/paras.php
	'pr_item' => '参数项',
	'pr_updend' => '更新完毕!',
	'pr_editend' => '修改完毕!',
	'pr_backmod' => '返回模型',
	'pr_updpara' => '更新参数',
	'pr_set' => '设置',
	'pr_rnd1' => '随机码参考1',
	'pr_fix' => '_,数字开头',
	'pr_rnd2' => '随机码参考2',

	// admin/update.php
	'ud_reltype' => '类别关联',
	'ud_gperm' => '等级权限',
	'ud_exdata' => '冗余数据',
	'ud_exfile' => '冗余文件',
	'ud_tplcache' => '模板缓存',
	'ud_tagcache' => '标签缓存',
	'ud_advcache' => '广告缓存',
	'ud_amenu' => '后台菜单',
	'ud_umenu' => '会员菜单',
	'ud_adlink' => '广告连接',
	'ud_updclr' => '更新清理',
	'ud_quick' => '快捷选择',
	'ud_pick' => '请选择操作！',
	'ud_end' => '更新完成',

	//admin/fields.php
	'fls_paritem' => '参数项',
	'fls_backflist' => '返回[字段列表]',
	'fls_fmres' => '表单效果',
	'fls_test' => '测试',
	'fls_fieldtype' => '字段类型',
	'fls_selftype' => '请选择[字段类型]',
	'fls_fcontrol' => '字段控件',
	'fls_dbtab' => '数据表',
	'fls_seldbtab' => '请选择[数据表]',
	'fls_sysfield' => '部分字段为系统字段,不能删除,但您可以禁用它',
	'fls_backmod' => '返回[模型列表]',
	'fls_backcat' => '返回[栏目列表]',
	'fls_backgrade' => '返回[等级列表]',
	'fls_addfield' => '增加字段',
	'fls_add' => '增加',
	'fls_list' => '列表',
	'fls_extab' => '分表',
	'fls_type' => '类型',
	'fls_db' => '数据库',
	'fls_nowval' => '当前值',
	'fls_maxlen' => '输入最大值 | 数据库长度',
	'fls_lettes' => '字符数',
	'fls_nofield' => '缺少字段,请手动添加',

	// glib/fldEdit.php
	'fe_noctrl' => '(无控件)',
	'fe_mtab' => '主表',
	'fe_extab' => '扩展表',
	'fe_ftype' => '字段类型',
	'fe_wdfrom' => '-弹窗数据来源-',
	'fe_tmfmt' => '时间格式,如',
	'fe_edtool' => '编辑器工具栏',
	'fe_colorto' => '颜色目标字段',
	'fe_ctrlp' => '控件参数',
	'fe_prfmt' => '格式:【abc_def】;或:【[abc][def]】',
	'fe_prval' => '参数值',
	'fe_prkey' => '参数键',
	'fe_keyid' => 'Key标识',
	'fe_uesable' => '启用',
	'fe_num25' => '允许2-5数字',
	'fe_fname' => '字段名称',
	'fe_let212' => '可含字母数字下划线<br>允许2-12字符,建议4-6字符',
	'fe_order' => '顺序',
	'fe_ltext' => '长文本',
	'fe_int' => '整型',
	'fe_vchar' => '字符',
	'fe_nodb' => '不存数据库',
	'fe_dbtype' => '-数据类型-',
	'fe_len' => '长度',
	'fe_dbdef' => '数据库<br>默认值',
	'fe_file' => '文件',
	'fe_pic' => '图片',
	'fe_vtype' => '-认证类型-',
	'fe_minlen' => '认证允许最小长度',
	'fe_maxlen' => '认证允许最大长度<br>不填写表示无限',
	'fe_set' => '设置',
	'fe_vrule' => '规则代码',
	'fe_vreg' => '可用正则表达式',
	'fe_vtips' => '认证表单提示<br>元素外提示用(|)分开',
	'fe_must' => '必填',
	'fe_nomust' => '不必填',
	'fe_3title' => '认证类型<br>认证规则<br>认证提示',
	'fe_tipsize' => '输入框,select等显示的宽度,单位:px;<br>text宽和高(行数),<br>如[400x6]表示宽400px,6行高,<br>弹窗选择的宽度和多选个数,<br>[mod.n]表示资料选取的模型和多选个数.',
	'fe_tipline' => '默认一行显示一个项目',
	'fe_tiptitle' => '[同行显示]下有效',
	'fe_shsize' => '显示大小',
	'fe_selarr' => '选择数组<br />格式见[备注]',
	'fe_note' => '备注',

	// glib/fldView.php
	'fv_upload' => '上传',
	'fv_upfiles' => '上传附件',
	'fv_view' => '浏览',
	'fv_vfiles' => '浏览附件',
	'fv_clear' => '清空',
	'fv_pick' => '资料选取',
	'fv_chkrep' => '检查重名',

	'oplogin_vform_err' => '表单认证错误！',
	'oplogin_logout' => '已经退出 管理员！',
	'oplogin_please_login' => '请登录 管理员!',
	'tip_logim' => '提示: 点认证码输入框,显示认证码；',
	'adm_home' => '首页',

	'top_now' => '当前',
	'top_admin' => '后台',
	'top_front' => '前台',
	'top_exit' => '退出',

	'home_index' => '管理首页',
	'home_sn' => '序列号',
	'home_srvnews' => '官方更新及动态',
	'home_now_user' => '当前管理员信息',

	'home_user' => '登陆者',
	'home_ugroup' => '所属会员组',
	'home_logip' => '当前登录Ip',
	'home_systime' => '系统时间',

	'home_exinfo' => '信息',
	'home_exback' => '返回',
	'home_stdocs' => '[文档/资讯]统计',
	'home_stuser' => '[用户/会员]统计',
	'home_stcoms' => '[互动/评论]统计',
	'home_stadvs' => '[广告/连接]统计',

	'home_sysinfo' => '系统环境信息',
	'home_sysspace' => '空间占用状况',
	'home_sysvars' => '变量',
	'home_update' => '更新',
	'home_upsver' => '更新及动态',
	'home_upstat' => '统计数据',
	'home_upspace' => '空间占用状况',
	'home_refresh' => '不更新重载',

	'adm_center' => '管理中心',

	'adm_side' => '管理中心',
	'exit_side' => '安全退出',
	'pro_name' => '贴心猫',
	
); // '' => '',




/*******************************************************************************
 File : \code\lang\kvphp\admin-en.php 
*******************************************************************************/
<?php

// 语言包:en

return array(

	// admin/rlogs.php
	'rl_rtime' => 'Run-Time',
	'rl_setpm' => 'Set-Config',

	// admin/grade.php
	'grd_gperm' => '[Grade-Perm]',
	'grd_set' => 'Set',
	'grd_edit' => 'Edit-Item',
	'grd_back' => 'Back',
	'grd_glist' => 'Grade-List',
	'grd_mod' => 'Model',
	'grd_pedit' => 'Perm-Edit',
	'grd_tmenu' => 'Top-Menu',

	// admin/db_act.php
	'dba_sel' => 'Select',
	'dba_stab' => '-Pick-Tables-',
	'dba_dict' => '[DB-Dict]',
	'dba_clear' => '[Clear]',
	'dba_tabs' => ' Tabs',
	'dba_opt' => 'Optimizing',
	'dba_fix' => 'Fixed',
	'dba_ok' => 'DeelOK!',
	'dba_dok' => 'Remark Updat OK',
	'dba_deel' => 'Deel',
	'dba_dbtab' => 'Tables',
	'dba_upd' => 'Update',
	'dba_gray' => 'Can NOT Edit Gray Items',
	'dba_view' => 'Created: View...',

	// admin/relat.php
	'rel_upd' => 'Update',
	'rel_add' => 'Add-Item',
	'rel_radm' => 'Relat-Master',
	'rel_ct' => 'Type/Catalog',
	'rel_edit' => 'Edit-Item',
	'rel_doc' => 'Docs',
	'rel_type' => 'Types',
	'rel_sel' => 'Select',
	'rel_relist' => 'Back-List',
	'rel_set' => 'Set',
	'rel_ritems' => 'Rel-Items',
	'rel_relx' => ' -=> ',

	// binc/set_id.php
	'sid_eid' => 'EditID',
	'sid_ok' => 'OK',
	'sid_move' => 'Move',
	'sid_sel' => '-Select-',
	'sid_top' => '-Top-',
	'sid_uinmv' => 'Used in Move.',

	// admin/types.php
	'tp_ordok' => 'Order-OK!',
	'tp_chkinc' => 'Check ID inclue',
	'tp_updchar' => 'Update-Char',
	'tp_ordchar' => 'Char-Order',

	// admin/catalog.php
	'cat_dsub' => 'There are subs item in [{val}], Please delete first!',
	'cat_close' => 'Can not add in [unused] items',
	'cat_edit' => 'Edit-Item',
	'cat_frame' => 'Frame',
	'cat_xframe' => 'Data',

	// admin/ediy.php
	'ediy_extool' => 'Extra-Tools',
	'ediy_rebok' => 'Restore OK!',
	'ediy_editok' => 'Edit OK!',
	'ediy_doing' => 'Editing',
	'ediy_size' => 'Size',
	'ediy_etime' => 'Edit-Time',
	'ediy_sbak' => 'Save Backup',
	'ediy_sedit' => 'Save-Edit',
	'ediy_nosdir' => 'No Sub Dirs',
	'ediy_file' => 'File',
	'ediy_atime' => 'Add-Time',
	'ediy_op' => 'Operation',
	'ediy_rebak' => 'Restore',
	'ediy_edit' => 'DIY-Edit:',

	// admin/static.php
	'st_admin' => 'Static-Admin',
	'st_allmod' => 'All-Model',
	'st_opmode' => 'OP-Model',
	'st_home' => 'Home',
	'st_notfound' => 'Not-Exists',
	'st_hmstatic' => 'Home-Static',
	'st_stfile' => 'Static-File',
	'st_crpage' => 'Add-Static',
	'st_depage' => 'Del-Static',
	'st_vres' => 'View-Result',
	'st_udefine' => 'User-Define',
	'st_cstatic' => 'Calalog-Static',
	'st_allrecs' => 'All[{val}]Recs',
	'st_dmhome' => 'Model Home(Dynamic)',
	'st_dstatic' => 'Detail-Static',
	'st_batnum' => 'Recs/Batch',

	// admin/groups.php
	'grp_copyitem' => 'Copy Item',
	'grp_dmode' => 'Content-Mode',
	'grp_catlevel' => 'Catalog-Level',
	'grp_max' => 'Max',
	'grp_extab' => 'Ext.Tab', 
	'grp_rmod' => 'Use in [Rel.Model], eg.[News-Remark]`s Rel.Model is [News];',
	'grp_pdel' => 'Del(-Piont)',
	'grp_pset' => 'PiontSet',
	'grp_padd' => 'Add(+Piont)',

	// admin/upgrade.php
	'upg_upgrade' => '[Upgrade]',
	'upg_bkdb' => 'Backup database',
	'upg_tipdb' => '[advice/attention] First stop service before backup; or copy database directory;',
	'upg_blfile' => 'Backup file',
	'upg_tipfile' => 'Main backup: /code and /root. <br>Important file (folder)/code/cfgs/, /root/run/_paths.php. ',
	'upg_use' => 'Using the scene',
	'upg_tipup' => 'Now is the older version, download the latest version of the package (DONT installed), 
	  <br>Update in the existing older version, the new version of the file will copied to THIS version, 
	  <br>the new version of the database structure will update to THIS version;',
	'upg_upstart' => 'Start upgrade',
	'upg_tipimp' => 'Now is the latest version, in THIS version, import the old version data;',
	'upg_impstart' => 'Start import',
	'upg_tip1' => 'Upgrade tips',
	'upg_off' => '[Official document]',
	'upg_tip2' => 'Upgrade notice<br>or view',

	// admin/menus.php
	'mu_addone' => 'AddItem',
	'mu_upd' => '[Update]',
	'mu_init' => 'Init',
	'mu_navmenu' => '[MenuNav]',
	'mu_setpm' => 'Set-Perm',
	'mu_guestpm' => 'Guest-Perm',
	'mu_loginpm' => 'Login--Perm',
	'mu_initend' => 'Init End!',
	'mu_delfirst' => 'Delete sub item first',
	'mu_add' => 'Add',
	'mu_editone' => 'EditItem', 
	'mu_fmta' => 'fmt:Relative URL or complete url link:',
	'mu_flagroot' => 'root path = [{val}]',
	'mu_tiptitle' => 'AboutUs',
	'mu_tipline' => 'Each item a line;',
	'mu_typa' => 'TypeAdmin',
	'mu_set' => 'Set',
	'mu_end' => 'End!',

	// /flow/admin/*
	'fad_num' => 'Number',
	'fad_adset' => 'Frame-Set',
	'fad_rmod' => 'Rel.Model',
	'fad_tip31245' => 'Begin with letter,can with number undorline<br>3-12 bit(4-5 bit better)',
	'fad_tip21245' => 'Begin with letter,can with number undorline<br>2-12 bit(4-5 bit better)',
	'fad_tip21246' => 'Begin with letter,can with number undorline<br>2-12 bit(4-6 bit better)',
	'fad_tip41245' => 'Begin with letter,can with number undorline<br>4-12 bit(4-5 bit better)',
	'fad_tip25num' => 'Numbers:2-5 bit',
	'fad_uid31546' => 'Begin with letter,can with number undorline<br>3-15 bit(4-6 bit better)',
	'fad_uid41258' => 'Begin with letter,can with number undorline<br>4-12 bit(5-8 bit better)',
	'fad_up624' => 'Password:6-24 bit',
	'fad_setid' => 'SetItem-{val} (EditID/Move)',
	'fad_chrsab' => '{val} bit',

	//admin/uinfo.php
	'ui_uinfo' => 'Porsnal Info.',
	'ui_upass' => 'Password',
	'ui_editok' => 'EditOK!',
	'ui_let624' => 'Lettrrs:6-24',
	'ui_oldpass' => 'Old Password:',
	'ui_newpass' => 'New Password:',
	'ui_again' => 'Agian:',
	'ui_agtip' => 'Input password aian',

	// glib/admAFunc.php
	'aaf_delok' => 'DelOK',
	'aaf_errkeep' => 'Error, May be keeped by System.',
	'aaf_resetok' => 'Reset Field OK',
	'aaf_copyok' => 'CopyOK',
	'aaf_addok' => 'AddOK',
	'aaf_error' => 'Error',
	'aaf_ttype' => 'TopType',
	'aaf_top' => 'Top',

	// uext/exaFunc.php
	'ef_demot' => 'DemoMenu',
	'ef_demodoc' => 'DemoDocs',
	'ef_add' => 'Add',
	'ef_demorem' => 'Remarks',
	'ef_catalog' => 'Catalog',
	'ef_typedetail' => 'TypeDetail',
	'ef_dept' => 'Detpart',
	'ef_brand' => 'Brands',
	'ef_china' => 'ChinaArea',
	'ef_umenu' => 'UserMenu',
	'ef_demoset' => 'DemoSet',

	// admin/paras.php
	'pr_item' => 'Item',
	'pr_updend' => 'UpdOK!',
	'pr_editend' => 'EditOK!',
	'pr_backmod' => 'Back',
	'pr_updpara' => 'Update',
	'pr_set' => 'Set',
	'pr_rnd1' => 'Reference random 1',
	'pr_fix' => 'Begin with _,numbers',
	'pr_rnd2' => 'Reference random 2',

	// admin/update.php
	'ud_reltype' => 'Type-Relat',
	'ud_gperm' => 'Grade/Perm',
	'ud_exdata' => 'Ext.Data',
	'ud_exfile' => 'Ext.Files',
	'ud_tplcache' => 'Tpl.Cache',
	'ud_tagcache' => 'Tag.Cache',
	'ud_advcache' => 'Adv.Cache',
	'ud_amenu' => 'Adm.Menu',
	'ud_umenu' => 'Mem.Menu',
	'ud_adlink' => 'Adv.Links',
	'ud_updclr' => 'Upd.Clear',
	'ud_quick' => 'Quick Set',
	'ud_pick' => 'Please Pick Items!',
	'ud_end' => 'Update OK',

	//admin/fields.php
	'fls_paritem' => 'ParamItem',
	'fls_backflist' => 'Back[FieldList]',
	'fls_fmres' => 'Form Result',
	'fls_test' => 'Test',
	'fls_fieldtype' => 'FieldType',
	'fls_selftype' => 'Select[FieldType]',
	'fls_fcontrol' => 'FieldControl',
	'fls_dbtab' => 'DB-Table',
	'fls_seldbtab' => 'Select[DB-Table]',
	'fls_sysfield' => 'System field, Cant Delete them',
	'fls_backmod' => 'Back[ModelList]',
	'fls_backcat' => 'Back[Cat.List]',
	'fls_backgrade' => 'Back[GradeList]',
	'fls_addfield' => 'Add Filed',
	'fls_add' => 'Add',
	'fls_list' => 'List',
	'fls_extab' => 'exTable',
	'fls_type' => 'Type',
	'fls_db' => 'DB',
	'fls_nowval' => 'NowValue',
	'fls_maxlen' => 'MaxInput | DB-Len',
	'fls_lettes' => 'Letters',
	'fls_nofield' => 'No Field,Please add manual',

	// glib/fldEdit.php
	'fe_noctrl' => '(NoControl)',
	'fe_mtab' => 'Main Table',
	'fe_extab' => 'Ext Table',
	'fe_ftype' => 'Field Type',
	'fe_wdfrom' => '-Pop Data From-',
	'fe_tmfmt' => 'Time Format,eg.',
	'fe_edtool' => 'Editor Tools',
	'fe_colorto' => 'Color For',
	'fe_ctrlp' => 'Control Param',
	'fe_prfmt' => 'Format:【abc_def】; or:【[abc][def]】',
	'fe_prval' => 'Param Val',
	'fe_prkey' => 'Param Key',
	'fe_keyid' => 'KeyID',
	'fe_uesable' => 'Enable',
	'fe_num25' => '2-5 Numbers',
	'fe_fname' => 'Field Name',
	'fe_let212' => 'Letters,Numbers and Underline<br>2-12 bit,Suggested 4-6 bit',
	'fe_order' => 'Top',
	'fe_ltext' => 'Long Text',
	'fe_int' => 'Int',
	'fe_vchar' => 'Varchar',
	'fe_nodb' => 'NOT-Save',
	'fe_dbtype' => '-DB-Type-',
	'fe_len' => 'Length',
	'fe_dbdef' => 'DB<br>Default',
	'fe_file' => 'File',
	'fe_pic' => 'Pic',
	'fe_vtype' => '-Check Type-',
	'fe_minlen' => 'Minimum length',
	'fe_maxlen' => 'Maximum length<br>Does not fill in the infinite',
	'fe_set' => 'Set',
	'fe_vrule' => 'Reg.Code',
	'fe_vreg' => 'Available regular expression',
	'fe_vtips' => 'Tips<br>use Tips (|) Split Notice',
	'fe_must' => 'Must',
	'fe_nomust' => 'NOT Must',
	'fe_3title' => 'Certification type<br>Certification rules<br>Certification tips',
	'fe_tipsize' => 'The width of input,select,Unit:px;<br>The width and height(Lines) of text,<br>eg.[400x6]=400px,6 lines,<br>The width and Max Items of pop window,<br>[mod.n]The model and Max Items of pick.',
	'fe_tipline' => 'Default eath line show ONE item',
	'fe_tiptitle' => 'Effective while [Show In Line]',
	'fe_shsize' => 'Show Size',
	'fe_selarr' => 'Config Array<br>Foamat See<br>[Notes]',
	'fe_note' => 'Notes',

	// glib/fldView.php
	'fv_upload' => 'Upload',
	'fv_upfiles' => 'UploadFiles',
	'fv_view' => 'View',
	'fv_vfiles' => 'ViewFiles',
	'fv_clear' => 'Clear',
	'fv_pick' => 'PickInfo',
	'fv_chkrep' => 'Repeate',

	'oplogin_vform_err' => 'Error Form Check!',
	'oplogin_logout' => 'Logout Admin OK!',
	'oplogin_please_login' => 'Please Login Admin!',
	'tip_logim' => 'Notice: Click input box, then show Verification code.',
	'adm_home' => 'Home',

	'top_now' => 'Now',
	'top_admin' => 'Admin',
	'top_front' => 'Front',
	'top_exit' => 'Exit',

	'home_index' => 'Admin Center',
	'home_sn' => 'Sn',
	'home_srvnews' => 'Official update and dynamic',
	'home_now_user' => 'Now Admin info.',

	'home_user' => 'User',
	'home_ugroup' => 'Group',
	'home_logip' => 'Login ip',
	'home_systime' => 'Sys.Time',

	'home_exinfo' => 'Info.',
	'home_exback' => 'Back.',
	'home_stdocs' => 'Stat.[Docs/News]',
	'home_stuser' => 'Stat.[Users/Members]',
	'home_stcoms' => 'Stat.[Comms/Review]',
	'home_stadvs' => 'Stat.[Adv/Links]',

	'home_sysinfo' => 'Sys Info.',
	'home_sysspace' => 'Space Info.',
	'home_sysvars' => 'Vars',
	'home_update' => 'Update',
	'home_upsver' => 'Srv Info.',
	'home_upstat' => 'Stat Info',
	'home_upspace' => 'Space',
	'home_refresh' => 'Refresh',

	'adm_center' => 'Master Center',

	'adm_side' => 'Admin',
	'exit_side' => 'Exit',
	'pro_name' => 'imCat',
	
); // '' => '',




/*******************************************************************************
 File : \code\lang\kvphp\awex-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// awex/xxx.php
	'appid' => '公众号',
	'follows' => '关注者管理',
	'add' => '添加',
	'addcfg' => '添加配置',
	'pids' => '公众号管理',
	'state' => '状态',
	'cfgs' => '配置',
	'ecfg' => '修改配置',
	'uesed' => '该条目[{val}]已被占用！',
	'seewepf' => '与公众平台一致',
	'qrcode' => '二维码',
	'fail' => '失败!',
	'success' => '成功!',
	'close' => '请关闭窗口',
	'mcfg' => '菜单配置',
	'title' => '标题',
	'op' => '操作',
	'clear' => '清空',
	'kwset' => '关键字设置',
	'subscribe' => '关注',
	'delkw' => '删除关键字',
	'kwrep' => '按信息关键词回复',
	'screp' => '关注时回复',
	'rescan' => '回复场景',
	'kwd' => '关键字',
	'cont' => '内容',
	// awex/wex_msg3.php
	'm3_getlogs' => '接收消息管理',
	'm3_time' => '时间',
	'm3_delmsg' => '删除消息记录',
	'm3_mslogs' => '发送记录管理',
	'm3_mdid' => '媒体ID',
	'm3_title' => '标题',
	'm3_srep' => '发送/回复信息',
	'm3_msend' => '群发信息',
	'm3_mparam' => '缺少参数！', //Missing parameter!
	'm3_guing' => '获取用户信息失败',
	'm3_togroup' => '群发分组:{val}人',
	'm3_toall' => '群发所有用户:(含未分组:[{val}]人)',
	'm3_select' => '请选择',
	'm3_msto' => '群发对象',
	'm3_orgmsg' => '原消息',

	'tip_rkey' => '最多60个字,可用半角逗号[,]分开; <br>关键词不要重复,不要一个关键词包含另一关键词; <br>关注时回复固定为follow_autoreply_info.',
	'tip_uload' => '加载中……<br>如果出现错误，请检查公众号配置或刷新页面；<br>如果翻页中出现错误，请重新点翻页。',
	'ops_appid' => "clearact|清除act凭据\nclrqrtik|清除qrcode缓存\nlocate|清理地理位置\nmsgget|清理接收信息\nmsgsend|清理发送信息\ndelete|*删除appid配置",

	'xx_yyy' => '测试',

);



/*******************************************************************************
 File : \code\lang\kvphp\awex-en.php 
*******************************************************************************/
<?php

// 语言包:en

return array(

	// awex/xxx.php
	'appid' => 'Appid',
	'follows' => 'Follows',
	'add' => 'Add',
	'addcfg' => 'Add-Appid',
	'pids' => 'Appid-Manage',
	'state' => 'Steate',
	'cfgs' => 'Config',
	'ecfg' => 'Edit-Config',
	'uesed' => '[{val}] is Used!',
	'seewepf' => 'See wechat public platform',
	'qrcode' => 'QRCode',
	'fail' => 'Fail!',
	'success' => 'Success!',
	'close' => 'Please Colse Window',
	'mcfg' => 'Menu-Config',
	'title' => 'Title',
	'op' => 'Operation',
	'clear' => 'Clear',
	'kwset' => 'Keyword Set',
	'subscribe' => 'Subscribe',
	'delkw' => 'Del Keyword',
	'kwrep' => 'Keyword-Reply',
	'screp' => 'Subscribe-Reply',
	'rescan' => 'Reply-Scene',
	'kwd' => 'Keyword',
	'cont' => 'Content',
	// awex/wex_msg3.php
	'm3_getlogs' => 'Get Message',
	'm3_time' => 'Time',
	'm3_delmsg' => 'Del Message',
	'm3_mslogs' => 'Send Message',
	'm3_mdid' => 'MediaID',
	'm3_title' => 'Title',
	'm3_srep' => 'Send/Reply',
	'm3_msend' => 'Mass-Send',
	'm3_mparam' => 'Missing parameter!', 
	'm3_guing' => 'Get User Info Fail',
	'm3_togroup' => 'Send Group:{val} peoples',
	'm3_toall' => 'Send All:(inc-ungrouped:[{val}] peoples)',
	'm3_select' => 'Select',
	'm3_msto' => 'Send-To',
	'm3_orgmsg' => 'Org-Message',

	'tip_rkey' => 'Max 60 bits, split with[,]; <br>Keywords do not repeat, do not a keyword contains another keyword; <br>use follow_autoreply_info as the keyword while Subscribe.',
	'tip_uload' => 'Loading......<br>f there is an error, please check the public number config or refresh the page;  <br>if an error occurs while turn-page, please click again.',
	'ops_appid' => "clearact|Clear-AccessToken\nclrqrtik|Clear-Qrcode\nlocate|Clear-Position\nmsgget|Clear-GetMsg\nmsgsend|Clear-SendMsg\ndelete|*Del-AppidConfig",

	'xx_yyy' => 'Tester',

);



/*******************************************************************************
 File : \code\lang\kvphp\core-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// sdev/exdBase.php
	'exdb_mode' => '-提取模式-',
	'exdb_exop' => '-扩展操作-',
	'exdb_rnote' => '规则说明',
	'exdb_orgtag' => '原始内容标记 ',
	'exdb_nres' => '当前批次执行结果：',
	'exdb_okn' => '成功执行[{val}]条',
	'exdb_next' => '{val}秒后执行下一批次…',
	'exdb_rok' => '执行完毕。',
	'exdb_res' => '执行结果：',
	'exdb_bugres' => '调试结果：',
	'exdb_orgdata' => '原始内容',

	// dops/dopUser.php
	'du_gradeo' => '-会员等级-',
	'du_userid' => '登陆名',
	'du_upass' => '密码',
	'du_gradet' => '等级',
	'du_empty' => '为空则不修改密码',
	'du_editng' => '修改失败：两次密码不一致！',
	'du_editok' => '修改成功',
	'du_erold' => '修改失败：旧密码错误',

	// dops/usrBase.php
	'usrb_ertimes' => '账号密码错误，错误次数：{val}次！',
	'usrb_erunknow' => '未知错误',

	// dops/usrMember.php
	'usrm_emsubj' => '邮件找回密码',
	'usrm_emtip' => '请登录邮件，根据提示找回密码。',
	'usrm_emeror' => '发邮件错误！请稍等再试，或联系管理员。',
	'usrm_eremail' => '账号-邮箱:参数错误！',

	// sdev/devApp.php
	'devapp_dferr' => '目录或文件名不规范',
	'devapp_dfnum' => '目录或文件名不能全为数字',
	'devapp_dfues' => '目录或文件名已经使用',
	'devapp_dfext' => '目录或配置已经存在',
	'devapp_dataerr' => '数据模型不规范',

	// sms 
	'sms_fail' => '失败!',
	'sms_errtel' => '号码不正确',
	'sms_errmsg' => '信息内容为空',
	'sms_charge0' => '系统余额为0,请联系管理员',
	'sms_charged' => '系统余额不足,请联系管理员',
	'sms_msenderr' => '群发失败',

	//sdev/updBase.php
	'updbase_lock1' => '已经锁定！重新升级 请找到文件：',
	'updbase_tip1' => '1. 先删除，并重新配置<升级包路径>；',
	'updbase_tip2' => '2. 或：修改[done=update]，重新升级',
	'updbase_back' => '[返回]',
	'updbase_setdirerr' => '设置目录[{val}]错误',
	'updbase_verbig' => '当前版本 高于或等于 升级包版本',
	'updbase_notwrite' => '可能目录[{val}]不可写！',
	'updbase_compare' => '[对比]',

	// sdev/devRun.php
	'devrun_tipr1' => '注意：根目录设置是空字符串,而不是/',
	'devrun_tipr2' => '注意：前面以/开头,后面不要/',
	'devrun_upd' => '刷新',
	'devrun_fixpararm' => '注意：刚才自动修正了参数：文件：',
	'devrun_file' => '文件：',
	'devrun_setpath' => '请设置路径：',
	'devrun_upding' => '点刷新继续操作……',
	'devrun_needenv' => '需要服务器环境',

	'devrun_my3a' => '需要开启[{val}]扩展，',
	'devrun_my3b' => '或修改文件：',
	'devrun_my3c' => '设置：',
	'devrun_my3d' => '选一个,且开启相应扩展',

	'devrun_gd2' => '需要开启GD2扩展，请设置php.ini：',
	'devrun_phpvbest' => '建议',
	'devrun_phpver' => 'PHP版本',
	'devrun_notwrite' => '不可写',
	'devrun_extendset' => ' - 不支持{val}扩展:请检查php.ini - ',
	'devrun_linkmysqlerr' => ' - 未连接服务器 - ',
	'devrun_tmfiles' => '文件太多,请设置目录缩小范围.',

	// sdev/devSetup.php
	'devsetup_deltip' => '已经安装！重新安装请先删除：',
	'devsetup_dt1' => '下',
	'devsetup_dt2' => '和',
	'devsetup_dt3' => '文件',
	'devsetup_donen' => '-已安装完第[{val}]步-',
	'devsetup_nosetup' => '（还未安装）',
	'devsetup_chkenv' => '请检查环境',
	'devsetup_chkdir' => '请检查目录',
	'devsetup_chkmysql' => '请检查Mysql数据库服务器',
	'devsetup_noframe' => '无表结构导入',

	// sdev/updInfo.php
	'updinfo_nowver' => '当前版本：',
	'updinfo_viewdown' => '查看官方下载',
	'updinfo_remver' => '（官方版本：{val}）',
	'updinfo_remerr' => '（官方版本：[获取数据错误]）',
	'updinfo_allspace' => '总空间',
	'updinfo_uesspace' => '[使用:{val}含文件和数据]',
	'updinfo_upd' => '更新',
	'updinfo_dir' => '目录',
	'updinfo_dbinfo' => '数据库',
	'updinfo_st1day' => '当天',
	'updinfo_st3day' => '3天',
	'updinfo_st7day' => '7天',
	'updinfo_stall' => '总计',

	'safcomm_vcode' => '点击输入框后见图片,<br>不分大小写',
	'rule_uname' => '字母开头,允许3-16字节<br>允许字母数字下划线',
	'rule_upass' => '允许6,15字节',
	'ie_low' => 'IE浏览器过低！建议你更换浏览器，如Chrome,Firefox,IE{val}}+！',
	'cfg_close' => '网站升级中，临时关闭!',
	'cfg_dggdcn' => '感谢dg.gd.cn提供主机空间',

	'opt_first' => '-请选择-',
	'nul_orgdata' => '无原始数据',
	'pub_title' => '发布',
	'no_rank' => '-无头衔-',
	'upd_comp' => '对比',
	'safcomm_vcoderr' => '认证码错误！',
	'devbase_clsrepeat' => '重复类名',

	'kid_minlen' => '请输入{val}+个字符！',
	'kid_keeped' => '[{val}]已被系统保留！',
	'kid_preused' => '前缀[{val}]已被系统保留！',
	'kid_ismodel' => '[{val}]为系统模型（已占用）！',

	'bcv_pic' => '[图]',
	'bcv_file' => '[附]',
	'bcv_set' => '设置',

	'msg_goto' => '我要去',
	'msg_jumpto' => '将自动到…',
	'msg_or' => '或',
	'msg_add' => '增加',
	'msg_edit' => '修改',
	'msg_eg' => '如:',

	'cupd_reprule' => '替换规则',
	'opay_order' => '订单',

	'vshow_uncheck' => '信息不存在或未被审核!',
	'vshow_1pagetag' => '每页只允许一个分页标签: 请检查如下模版,标签:',

	'seal_defstr' => '印章测试字符串',
	'seal_move' => '点击移开位置',
	'seal_mark' => '专用章',

	'push_ok' => '成功推送:',
	'push_ng' => '推送失败:',

	'vop_parerr' => '参数错误!',
	'vop_closemod' => '本模块关闭!',
	'vop_closecat' => '本栏目关闭!',
	'vop_st301dir' => '301跳转未生成静态',

	'vops_batres' => '当前批次执行结果：',
	'vops_dores' => '成功执行{val}条',
	'vops_3secnext' => '3秒后执行下一批次…',
	'vops_end' => '执行完毕。',
	'vops_res' => '执行结果：',

	'dbdict_refresh' => '刷新',
	'dbdict_title' => '数据库词典',
	'dbdict_table' => '数据表',
	'dbdict_field' => '字段',
	'dbdict_tab' => '表',
	'dbdict_extab' => '[扩展]表',

	// tester
	'test_name' => '中文名',
	'test_end' => '测试结束',
	'start_title' => '起始页',
	'view_times' => '浏览{val}次',

	'home' => '首页',

	'uname' => '用户名',
	'upass' => '密　码',
	'vcode' => '认证码',
	'submit' => '提交',

	// pager
	'page_First' => '首页',
	'page_Prev' => '上页',
	'page_Next' => '下页',
	'page_Last' => '尾页',
	
);




/*******************************************************************************
 File : \code\lang\kvphp\core-en.php 
*******************************************************************************/
<?php

// 语言包:en

return array(

	// sdev/exdBase.php
	'exdb_mode' => '-Extra-Mode-',
	'exdb_exop' => '-Ext-Notes-',
	'exdb_rnote' => 'Rule-Notes',
	'exdb_orgtag' => 'Org-Tag ',
	'exdb_nres' => 'Current batch results:',
	'exdb_okn' => 'RunOK Recs:[{val}]',
	'exdb_next' => 'RunNext after {val} sec...',
	'exdb_rok' => 'Run-End',
	'exdb_res' => 'Run-Result',
	'exdb_bugres' => 'Debug-Result:',
	'exdb_orgdata' => 'OrgData',

	// dops/dopUser.php
	'du_gradeo' => '-Grade-',
	'du_userid' => 'UserID',
	'du_upass' => 'Password',
	'du_gradet' => 'Grade',
	'du_empty' => 'NOT Edit Password while Empty',
	'du_editng' => 'Edit Fail, Two passwords are not consistent!',
	'du_editok' => 'Edit OK',
	'du_erold' => 'Edit Fail, Old Password Error',

	// dops/usrBase.php
	'usrb_ertimes' => 'IP/PW Error, Times:{val}!',
	'usrb_erunknow' => 'unKnow Error',

	// dops/usrMember.php
	'usrm_emsubj' => 'Get password by Email',
	'usrm_emtip' => 'Please login your E-mail, and get password according to the mail message.',
	'usrm_emeror' => 'Send E-mail Error, Please wait a moment, or contact the administrator.',
	'usrm_eremail' => 'Error:E-mail Error!',

	// sdev/devApp.php
	'devapp_dferr' => 'Non-standard directory or file name',
	'devapp_dfnum' => 'Directory or file name can NOT all numbers',
	'devapp_dfues' => 'Directory or file name is already in use.',
	'devapp_dfext' => 'Drectory or configuration already exists',
	'devapp_dataerr' => 'Error data model',

	// sms 
	'sms_fail' => 'Fail!',
	'sms_errtel' => 'Error Tel',
	'sms_errmsg' => 'Error Message',
	'sms_charge0' => 'System balance is 0, please contact the administrator',
	'sms_charged' => 'System balance is insufficient, please contact the administrator',
	'sms_msenderr' => 'Multi-Send failure',

	//sdev/updBase.php
	'updbase_lock1' => 'Be locked! Re upgrade Please Find File: ',
	'updbase_tip1' => '1. Delete it, and set <Package Path>: ',
	'updbase_tip2' => '2. or Edit [done=update], update again',
	'updbase_back' => '[Back]',
	'updbase_setdirerr' => 'Set dir [{val}] Error',
	'updbase_verbig' => 'Now version is higher than or equal to the package',
	'updbase_notwrite' => 'May be dir [{val}] Can NOT Write!',
	'updbase_compare' => '[Compare]',

	// sdev/devRun.php
	'devrun_tipr1' => 'Notice: Root dir please set empty string, NOT /',
	'devrun_tipr2' => 'Notice: Begin with /, End NOT for/',
	'devrun_upd' => 'Refresh',
	'devrun_fixpararm' => 'Notice: System fixed this parmarm: File: ',
	'devrun_file' => 'File: ',
	'devrun_setpath' => 'Please set Path: ',
	'devrun_upding' => 'Click And Continue...',
	'devrun_needenv' => 'Need Server Env.',

	'devrun_my3a' => 'Need Lib[{val}]Support, ',
	'devrun_my3b' => ' or Edit the file: ',
	'devrun_my3c' => 'Set: ',
	'devrun_my3d' => 'Select ONE, And set Correspond Ext-Lib',

	'devrun_gd2' => 'Need GD2 Lib, Please set php.ini:',
	'devrun_phpvbest' => 'Suggest',
	'devrun_phpver' => 'PHP Ver',
	'devrun_notwrite' => 'Can NOT Write',
	'devrun_extendset' => ' - Can NOT Support Lib[{val}]:Please set php.ini - ',
	'devrun_linkmysqlerr' => ' - Can NOT Contact Server - ',
	'devrun_tmfiles' => 'Too many Files, Please set sub dirs.',

	// sdev/devSetup.php
	'devsetup_deltip' => 'Installed! Reinstall please delete file: ',
	'devsetup_dt1' => ' ',
	'devsetup_dt2' => ' and ',
	'devsetup_dt3' => ' ',
	'devsetup_donen' => '-Finished Step:[{val}]-',
	'devsetup_nosetup' => '(NOT Install)',
	'devsetup_chkenv' => 'Please Check Env.',
	'devsetup_chkdir' => 'Please Check Dirs.',
	'devsetup_chkmysql' => 'Please Check Mysql',
	'devsetup_noframe' => 'No DB-Frame Data for import',

	// sdev/updInfo.php
	'updinfo_nowver' => 'Now Version: ',
	'updinfo_viewdown' => 'View Offiicial Download',
	'updinfo_remver' => ' (Offiicial: {val})',
	'updinfo_remerr' => ' (Offiicial: [Remote Error])',
	'updinfo_allspace' => 'AllSpace',
	'updinfo_uesspace' => '[UesedSpace:{val},inc File&DB]',
	'updinfo_upd' => 'Update',
	'updinfo_dir' => 'Dirs',
	'updinfo_dbinfo' => 'DB',
	'updinfo_st1day' => '1 Day',
	'updinfo_st3day' => '3 Days',
	'updinfo_st7day' => '7 Days',
	'updinfo_stall' => 'All',

	'safcomm_vcode' => 'Click input box then show Verification<br>ignore uppercase/lowercase', 
	'rule_uname' => '3~16 bit,letter first<br>allow letter/number/underline',
	'rule_upass' => '6~15 bit',
	'ie_low' => 'Your IE is too old! Its time for Change you browser, Like:Chrome,Firefox,IE{val}+!',
	'cfg_close' => 'Web site Upgrading, temporary closed!',
	'cfg_dggdcn' => 'Thanks to dg.gd.cn for hosting space',

	'opt_first' => '- Please Select -',
	'nul_orgdata' => 'Empty Org Data',
	'pub_title' => 'Pub',
	'no_rank' => '- No Rank -',
	'upd_comp' => 'Compare',
	'safcomm_vcoderr' => 'vCode Error!',
	'devbase_clsrepeat' => 'Class Repeat',

	'kid_minlen' => 'Please input {val}+ bits!',
	'kid_keeped' => '[{val}]keeped by system!',
	'kid_preused' => 'Prefix[{val}]keeped by system!',
	'kid_ismodel' => '[{val}]is model key!',

	'bcv_pic' => '[Pic]',
	'bcv_file' => '[File]',
	'bcv_set' => 'Set',

	'msg_goto' => 'I will go to',
	'msg_jumpto' => 'Jump to……',
	'msg_or' => 'or',
	'msg_add' => 'Add',
	'msg_edit' => 'Edit',
	'msg_eg' => 'eg.',

	'cupd_reprule' => 'Rep. Rule',
	'opay_order' => 'Order',

	'vshow_uncheck' => 'Info. does not exist or is not checked!',
	'vshow_1pagetag' => 'Only one page-tag allow each page, Please check below tpl/tag:',

	'seal_defstr' => 'Seal Default String',
	'seal_move' => 'Click and move',
	'seal_mark' => 'Seal Dept.',

	'push_ok' => 'Push OK:',
	'push_ng' => 'Push NG:',

	'vop_parerr' => 'Param Error!',
	'vop_closemod' => 'Close Model!',
	'vop_closecat' => 'Close Catalog!',
	'vop_st301dir' => '301 Dir(No Static File)',

	'vops_batres' => 'Now batch done:',
	'vops_dores' => 'done ok recs:{val}',
	'vops_3secnext' => '3 secs, Next batch...',
	'vops_end' => 'Done End.',
	'vops_res' => 'Done Res.',

	'dbdict_refresh' => 'Refresh',
	'dbdict_title' => 'DB-Dictionary',
	'dbdict_table' => 'Tables',
	'dbdict_field' => 'Fields',
	'dbdict_tab' => 'Tab.',
	'dbdict_extab' => '[Ext]Tab.',

	// tester 
	'test_name' => 'English Name',
	'test_end' => 'End Test',
	'start_title' => 'Start Page',
	'view_times' => 'Views:{val}',

	'home' => 'Homepage',

	'uname' => 'Username',
	'upass' => 'Password',
	'vcode' => 'AuthCode',
	'submit' => 'Submit',

	// pager
	'page_First' => 'First',
	'page_Prev' => 'Prev',
	'page_Next' => 'Next',
	'page_Last' => 'Last',
	
);




/*******************************************************************************
 File : \code\lang\kvphp\flow-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// apis/exd_crawl.php
	'cw_crawl' => '采集',
	'cw_batch' => '每批次采集数据条数',
	'cw_fskip' => '排除字段',
	'cw_urlfrom' => '从下列网页中提取网址:',
	'cw_demodetail' => '样例详情页',
	'cw_baselist' => '基础列表页',
	'cw_pgsrule' => '翻页规则',
	'cw_listdebug' => '列表页调试',
	'cw_deetlist' => '调试采集列表网址',
	'cw_donelog' => '已采页记录',
	'cw_getlistrule' => '提取列表网址规则:',
	'cw_urlinc' => '网址含有',
	'cw_urlnoi' => '网址不含',
	'cw_urlrep' => '网址替换',
	'cw_urlroot' => '网址根目录',
	'cw_crlogs' => '[采集网址记录]',

	// apis/cron_plan.php
	'cr_addplan' => '增加[计划任务]',
	'cr_planord' => '[计划任务]排程',
	'cr_kfine' => 'Key/文件名',
	'cr_cycle' => '间隔周期',
	'cr_runprev' => '上次执行',
	'cr_runnext' => '下次执行',
	'cr_runms' => '执行分秒',
	'cr_dirun' => '直接执行',
	'cr_odrun' => '排程运行',
	'cr_tip1' => '计划任务对应的文件名<br>不含.php',
	'cr_pname' => '任务名称',
	'cr_unit' => '单位',
	'cr_tip2' => '数字:1-120之间',
	'cr_last' => '上次',
	'cr_tip3' => '即1小时内的秒数',

	// apis/seo_push.php
	'pu_cfok' => '成功生成！',
	'pu_cfng' => '生成失败。',
	'pu_mapfile' => 'map文件',
	'pu_cv2' => '生成/查看',
	'pu_create' => '生成',
	'pu_view' => '查看',

	'pu_setv' => '设置值',
	'pu_ipush' => '主动推送',
	'pu_slink' => '百度链接提交',
	'pu_pfile' => '推送文档',
	'pu_tip1' => '(或手动在如下框填写地址提交)',
	'pu_plink' => '推送连接',
	'pu_ldemo' => '连接参考',
	'pu_tip2' => '向各大搜索引擎提交SITEMAP.XML的方法',
	
	'pu_mfname' => 'Map文件名',
	'pu_modset' => '模型配置',
	'pu_itpl' => 'item模版',
	'pu_ftpl' => 'file模版',
	'pu_idemo' => 'item参考',
	'pu_hdemo' => 'html参考(file模版)',
	'pu_xdemo' => 'xml参考(file模版)',
	'pu_fdemo' => 'file参考',

	// apis/exd_share.php
	'sh_title' => '数据分享',
	'sh_json' => 'json分享',
	'sh_tpl' => 'tpl调用',
	'sh_tip1' => '(如下参数cut/ret/tpl不用)',
	'sh_tip2' => '(可设置如下cut/ret/tpl显示参数)',
	'sh_cg' => '栏目/等级',
	'sh_whr' => '数据条件',
	'sh_show' => '显示设置',
	'sh_mod' => '资料模块',
	'sh_mode' => '调用方式',
	'sh_url' => '调用地址',
	'sh_ctpl' => 'tpl转码',
	'sh_surl' => 'url签名',
	'sh_res' => '调用结果',

	// binc/exd_inc1.php
	'ei_cwraldata' => '数据采集',
	'ei_impdata' => '数据导入',
	'ei_back' => '返回',
	'ei_paln' => '排程',
	'ei_sharecfg' => '分享配置',
	'ei_cfgfile' => '配置文件',
	'ei_editcfg' => '修改配置',
	'ei_doc' => '文档',
	'ei_tip2nd' => '二次开发:数据扩展(系统工具)',
	'ei_fldxcfg' => '字段[{val}]配置',
	'ei_name' => '项目名称',
	'ei_demodetail' => '样例详情页',
	'ei_debugrule' => '调试规则',
	'ei_opendemo' => '打开样例详情页',
	'ei_debfld' => '调试采集[{val}]字段',
	'ei_getrule' => '提取原始内容规则',
	'ei_fromdb' => '来源数据',
	'ei_fromfield' => '来源字段',
	'ei_resdea' => '内容结果处理',
	'ei_reorg' => '替换原始内容',
	'ei_cdeal' => '综合处理内容',
	'ei_retab' => '内容替换表',
	'ei_param' => '参数',
	'ei_resfunc' => '结果处理函数',
	'ei_nuldef' => '为空时默认值',
	'ei_extab' => '分表',
	'ei_db' => '数据库',
	'ei_nowval' => '当前值',
	'ei_maxlen' => '输入最大值|数据库长度',
	'ei_nchr' => '字符数',
	'ei_skipfld' => '排出字段',
	'ei_fldcfg' => '字段配置',
	'ei_addfld' => '附加字段',

	// apis/exd_psyn.php
	'sy_add' => '增加[数据同步]',
	'sy_plan' => '[数据同步]排程',
	'sy_apiurl' => 'api地址',
	'sy_tipapi' => '不含后面:[/plus/ajax/exdb.php]部分',
	'sy_limit' => '每批次同步数据条数',
	'sy_type' => '类别',
	'sy_tipnul' => '为空即不限',
	'sy_tlog' => '数据同步记录',

	// apis/exd_oimp.php
	'oi_from' => '来源',
	'oi_logs' => '记录',
	'oi_imp' => '导入',
	'oi_copy' => '复制方案',
	'oi_fdb' => '来源数据',
	'oi_fsql' => '来源SQL',
	'oi_int' => '整形',
	'oi_chr' => '字符',
	'oi_kfield' => '主键字段',
	'oi_tfield' => '时间字段',
	'oi_limit' => '每批次导入数据条数',
	'oi_skip' => '排除字段',
	'oi_tlog' => '数据导入记录',

	// apis/exd*
	'exd_reurl' => '备注/设置说明/提取网址：',
	'exd_rutip' => "网址不含,网址替换：一行一个；\n[网址替换]默认值格式：oldval=newval\n详情见文档：", 
	'exd_skdef' => '排除字段/默认值：一行一个；\n默认值格式：',
	'exd_imtip' => "来源SQL：主表固定为m别名；\n排除字段/默认值：一行一个；\n默认值格式：fieldname=fieldvalue\n导入用演示数据：http://pan.baidu.com/share/home?uk=3191979020 -=> odata_demo.rar 文件",
	'exd_iline' => '一行一个',

	// apis/jifen_plan.php
	'jf_updcfg' => '更新配置',
	'jf_upd' => '更新',
	'jf_add' => '增加',
	'jf_jfcnt' => '积分数',
	'jf_jifen' => '积分',
	'jf_logs' => '积分记录',
	'jf_jfcnt2' => '积分数量',
	'jf_l19n' => '允许1-9数字',

	// apis/sms_send.php
	'ss_title' => '短信发送',
	'ss_web' => '官网',
	'ss_apib' => '接口余额',
	'ss_close' => '接口已关闭或无效!',
	'ss_tel' => '电话号码',
	'ss_msg' => '短信内容',
	'ss_tip0' => '(余额为0,不能发送)',
	'ss_send' => '发送',
	'ss_cnta' => '已输入',
	'ss_cntb' => '个字符',
	'ss_set' => '设置',
	'ss_tips' => '提示说明',
	'ss_tipc' => '号码一行一个,或用,好分开; 内容240字以内',
	'ss_balance' => '余额',

	// apis/pay_logs.php
	'pay_amount' => '金额',
	'pay_api' => '接口ID',
	'pay_method' => '方法',
	'pay_dir' => '目录',
	'pay_note' => '说明',
	'pay_cfg' => '配置',
	'pay_pcfg' => '付款配置',
	'pay_2ndoc' => '二次开发文档。',

	// apis/*
	'exp_set' => '设置',
	'exp_detail' => '详细内容',
	'sms_count' => '数量',
	'ord_icon' => '图标',
	'ord_icocss' => '图标文件名或css',
	'ord_extfee' => '附加金额',
	'qa_alltype' => '所有类别',
	'qa_alltag' => '所有标签',
	'qa_reset' => '更新/重置',
	'cfg_tips' => '提示', 	// acfgs
	'cfg_nocfg' => '当前无配置',
	'cfg_copy' => '请复制文件',
	'cfg_to' => ' 为 ',
	'cfg_editip' => '并修改参数完成配置',
	'cfg_nowcfg' => '当前配置',
	'cfg_nowfile' => '当前配置文件',
	'cfg_edit' => '修改配置',
	'cfg_optime' => '操作时间',

	// dops/dopComs.php
	'dc_c1024' => '10-24字符',
	'dc_norel' => '无[关联模块]ID',
	// glib/fldCfgs.php
	'fc_rftype' => '参考类别',
	'fc_rffield' => '参考字段',

	//dops/dopCheck.php
	'ck_grade' => '操作无权限[{val}]！',
	'ck_stop' => '操作无权限[{val}]！',
	'ck_login' => '操作无权限[login]，请先登录！',
	'ck_all' => '超过发布限额，发布总量[{val}]条！',
	'ck_day' => '超过发布限额，ip日发布量[{val}]条！',
	'ck_rep' => '重复发布时间间隔限额，<br>时间间隔需>[{val}]秒！',

	'tip_slogs' => '供优化与个性化设置使用',
	'tip_ssel' => '一定要选择哟',
	'tip_suser' => '供修改操作人设置使用',
	'tip_sip' => '供修改操作人IP设置使用',

	//flow/dops/xxx
	'dops_parerr' => '参数错误',
	'dops_add' => '增加',
	'dops_edit' => '修改',
	'dops_ok' => '成功！',
	'dops_okn' => '条记录{val}成功！',
	'dops_add2' => '增加资料',
	'dops_adm2' => '管理',

	'dops_checked' => '审核',
	'dops_hide' => '隐藏',
	'dops_del' => '删除',

	'dops_setop' => '请选择操作项目！',
	'dops_setitem' => '请勾选操作记录！',
	'dops_send' => '提交',
	'dops_back' => '返回',
	'dops_nodata' => '无资料！',
	'dops_opok' => '操作成功！',

	'dops_clearok' => '清理成功！',
	'dops_clear' => '清理',
	'dops_search' => '搜索',

	'dops_icat' => '所在栏目',
	'dops_ishow' => '显示',
	'dops_copy' => '复制',
	'dops_cpro' => '复制产品',
	'dops_rem' => '评论',

	'dops_delok' => '条记录删除成功！',
	'dops_kid' => '标识',
	'dops_itemname' => '条目名称',
	'dops_cpok' => '复制成功！',
	'dops_detail' => '详情资料',
	'dops_exeu' => '执行',

	'dops_fromdata' => '来源资料',
	'dops_reldata' => '关联信息',
	'dops_orduidd' => '账号(降)',
	'dops_orduida' => '账号(升)',
	'dops_ordkidd' => 'ID(降)',
	'dops_ordkida' => 'ID(升)',
	'dops_ordtimd' => '添加时间(降)',
	'dops_ordtima' => '添加时间(升)',
	'dops_ordasc' => '(升)',
	'dops_orddesc' => '(降)',

	'log_aip' => '添加IP',
	'log_eip' => '修改IP',
	'log_atime' => '添加时间',
	'log_etime' => '修改时间',

	'log_optime' => '操作时间',
	'log_opuser' => '操作者',
	'log_opip' => '操作IP',
	'log_opadd' => '添加:',
	'log_opedit' => '修改:',

	'op0_filt' => '-筛选-',
	'op0_search' => '-搜索-',
	'op0_bacth' => '-批量操作-',
	'op0_order' => '-排序-',	
	'op0_show' => '-显示-',
	'op0_cat' => '-栏目-',
	'op0_type' => '-类别-',
	'op0_field' => '-字段-',
	'op0_area' => '-范围-',

	'op_op4' => "upd|更新\ndel|删除\nshow|启用\nstop|禁用",
	'op_upd' => '更新',
	'op_del' => '删除',
	'op_open' => '启用',
	'op_close' => '禁用',
	'op_op3' => "del|删除\nshow|显示\nhidden|隐藏",
	'op_show' => '显示',
	'op_hide' => '隐藏',
	'op_delsel' => '删除所选',
	'op_delnow' => '删除当前',

	'title_select' => '选择',
	'title_name' => '名称',
	'title_top' => '排序',
	'title_enable' => '启用',
	'title_char' => '字母',
	'title_level' => '级别',
	'title_frame' => '结构',
	'title_subtype' => '子类',
	'title_param' => '参数',
	'title_edit' => '修改',
	'title_note' => '备注',
	'title_model' => '模型',
	'title_type' => '类型',
	'title_defval' => '默认值',
	'title_cfg' => '配置',

	'title_perm' => '权限',
	'title_field' => '字段',
	'title_fields' => '字段',
	'title_set' => '设置',
	'title_copy' => '复制',
	'title_cata' => '栏目',
	'title_bei' => '备用',
	'title_grade' => '等级',
	'title_mode' => '模式',
	'title_admin' => '管理',
	'title_parset' => '参数设置',

	'title_op' => '操作',
	'title_pid' => '父条目',
	'title_newid' => '新ID',
	'title_attrset' => '属性设置',
	'title_attrtitle' => '属性',

	'msg_pkitem' => '请勾选操作项！',
	'msg_set' => '设置成功！',
	'msg_upd' => '更新成功！',
	'msg_add' => '添加成功！',
	'msg_del' => '删除成功！',
	'msg_move' => '移动成功',
	'msg_exists' => '该条目[{val}]已被占用！',
	'msg_delxng' => '删除失败,请设置条件',
	'msg_delxok' => '当前条件：[{val}] 删除成功',

	'fl_addin' => '增加条目-在',
	'fl_addtitle' => '增加条目',
	'fl_opbatch' => '批量操作',
	'fl_kflag' => 'Key标识',
	'fl_cfgtab' => '配置数组',
	'fl_cfgtip' => '格式:键=值,一行一个；',
	'fl_deeltitle' => '执行操作',

);



/*******************************************************************************
 File : \code\lang\kvphp\flow-en.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// apis/exd_crawl.php
	'cw_crawl' => 'Crawl',
	'cw_batch' => 'Batch Limit',
	'cw_fskip' => 'Skip Fields',
	'cw_urlfrom' => 'Get Url From:',
	'cw_demodetail' => 'Demo-Detail',
	'cw_baselist' => 'Base-List',
	'cw_pgsrule' => 'Page-Rule',
	'cw_listdebug' => 'List Debug',
	'cw_deetlist' => 'Debug Get List Urls',
	'cw_donelog' => 'Crawl Logs',
	'cw_getlistrule' => 'Get List Urls Rule:',
	'cw_urlinc' => 'Url-Include',
	'cw_urlnoi' => 'Url-Notinc',
	'cw_urlrep' => 'Url-Replace',
	'cw_urlroot' => 'Url-Root',
	'cw_crlogs' => '[Crawl Logs]',

	// apis/cron_plan.php
	'cr_addplan' => 'Add[Planning tasks]',
	'cr_planord' => '[Planning tasks]Order',
	'cr_kfine' => 'Key/Finename',
	'cr_cycle' => 'Run-Cycle',
	'cr_runprev' => 'Last-Run',
	'cr_runnext' => 'Next-Run',
	'cr_runms' => 'Min-Sec',
	'cr_dirun' => 'Run-Direct',
	'cr_odrun' => 'Run-Order',
	'cr_tip1' => 'Finename, Not <br>include[.php]',
	'cr_pname' => 'Task Name',
	'cr_unit' => 'Unit',
	'cr_tip2' => 'Number:between 1-120',
	'cr_last' => 'Last',
	'cr_tip3' => 'The secends in ONE house',

	// apis/seo_push.php
	'pu_cfok' => 'Create OK!',
	'pu_cfng' => 'Create Fail!',
	'pu_mapfile' => 'map File',
	'pu_cv2' => 'Create/View',
	'pu_create' => 'Create',
	'pu_view' => 'View',

	'pu_setv' => 'Set-Value',
	'pu_ipush' => 'Time Push',
	'pu_slink' => 'Push Links to Baidu',
	'pu_pfile' => 'Push File',
	'pu_tip1' => '(or input links in below)',
	'pu_plink' => 'Push Links',
	'pu_ldemo' => 'Demo Links',
	'pu_tip2' => 'SEO Links for Search Engine',
	
	'pu_mfname' => 'Map FileName',
	'pu_modset' => 'Mod-Set',
	'pu_itpl' => 'item Tpl',
	'pu_ftpl' => 'file Tpl',
	'pu_idemo' => 'Demo item',
	'pu_hdemo' => 'Demo html(file Tpl)',
	'pu_xdemo' => 'Demo xml(file Tpl)',
	'pu_fdemo' => 'Demo files',

	// apis/exd_share.php
	'sh_title' => 'Data-Share',
	'sh_json' => 'json Share',
	'sh_tpl' => 'tpl Show',
	'sh_tip1' => '(Params: cut/ret/tpl NOT in use)',
	'sh_tip2' => '(Set Params: cut/ret/tpl)',
	'sh_cg' => 'Catalog/Grade',
	'sh_whr' => 'Data-Condition',
	'sh_show' => 'Show Set',
	'sh_mod' => 'Data-Model',
	'sh_mode' => 'Mode',
	'sh_url' => 'Call Url',
	'sh_ctpl' => 'tpl Encode',
	'sh_surl' => 'url Sigm',
	'sh_res' => 'Result',

	// binc/exd_inc1.php
	'ei_cwraldata' => 'Cwral-Data',
	'ei_impdata' => 'Import-Data',
	'ei_back' => 'Back',
	'ei_paln' => 'Plan',
	'ei_sharecfg' => 'Share Config',
	'ei_cfgfile' => 'Config File',
	'ei_editcfg' => 'Edit Config',
	'ei_doc' => 'Doc',
	'ei_tip2nd' => '2nd Dev:Data-Extra(System-Tools)',
	'ei_fldxcfg' => 'Config Filed [{val}]',
	'ei_name' => 'Plan Name',
	'ei_demodetail' => 'Demo Detail',
	'ei_debugrule' => 'Debug Rule',
	'ei_opendemo' => 'Open Detail',
	'ei_debfld' => 'Debug Filed [{val}]',
	'ei_getrule' => 'Get-Org-Data Rule',
	'ei_fromdb' => 'From Data',
	'ei_fromfield' => 'From Filed',
	'ei_resdea' => 'Deal Result',
	'ei_reorg' => 'Replace Org Content',
	'ei_cdeal' => 'Composite Deal',
	'ei_retab' => 'Content Replace',
	'ei_param' => 'Param',
	'ei_resfunc' => 'ExtFunc',
	'ei_nuldef' => 'Def-Val while Empty',
	'ei_extab' => 'Extra-Table',
	'ei_db' => 'DB',
	'ei_nowval' => 'Now-Vaule',
	'ei_maxlen' => 'Max-Input|DB-Length',
	'ei_nchr' => 'Char number',
	'ei_skipfld' => 'Skip Field',
	'ei_fldcfg' => 'Field Confgig',
	'ei_addfld' => 'Add Field',

	// apis/exd_psyn.php
	'sy_add' => 'Add[Syn.Data]',
	'sy_plan' => '[Syn.Data]Lists',
	'sy_apiurl' => 'Api-Url',
	'sy_tipapi' => ' Not inclue parts:[/plus/ajax/exdb.php]',
	'sy_limit' => 'Batch limit',
	'sy_type' => 'Type',
	'sy_tipnul' => 'No limit set 0',
	'sy_tlog' => 'Syn.Logs',

	// apis/exd_oimp.php
	'oi_from' => 'From',
	'oi_logs' => 'Logs',
	'oi_imp' => 'Import',
	'oi_copy' => 'Copy',
	'oi_fdb' => 'From-Data',
	'oi_fsql' => 'From-SQL',
	'oi_int' => 'Int',
	'oi_chr' => 'Char',
	'oi_kfield' => 'Key-Filed',
	'oi_tfield' => 'Time-Filed',
	'oi_limit' => 'Batch limit',
	'oi_skip' => 'Skip-Filed',
	'oi_tlog' => 'Import Logs',

	// apis/exd*
	'exd_reurl' => 'Setting-Notice/GetUrls:',
	'exd_rutip' => "Url not contain/Url Replace: Each line an item; \n[Url Replace/Default Value]Formate: oldval=newval\n Detail view: ", 
	'exd_skdef' => "Skip Fields/Default Value: Each line an item; \nDefault Value Formate: ",
	'exd_imtip' => "Source SQL：[m] is the main table`s alias; \nSkip Fields/Default Value: Each line an item; \nDefault Value Formate: fieldname=fieldvalue\n Demo Data :http://pan.baidu.com/share/home?uk=3191979020 -=> File: odata_demo.rar",
	'exd_iline' => 'Each line an item', 

	// apis/jifen_plan.php
	'jf_updcfg' => 'Update-Config',
	'jf_upd' => 'Update',
	'jf_add' => 'Add',
	'jf_jfcnt' => 'Count',
	'jf_jifen' => 'Piont',
	'jf_logs' => 'Piont-Logs',
	'jf_jfcnt2' => 'Count',
	'jf_l19n' => 'Numbers:1-9 bit',

	// apis/sms_send.php
	'ss_title' => 'SMS-Send',
	'ss_web' => 'Web',
	'ss_apib' => 'API-Balance',
	'ss_close' => 'API-Closed!',
	'ss_tel' => 'Tels',
	'ss_msg' => 'Message',
	'ss_tip0' => '(The balance is 0, can not be sent)',
	'ss_send' => 'Send',
	'ss_cnta' => 'Now input ',
	'ss_cntb' => ' Chars',
	'ss_set' => 'Set',
	'ss_tips' => 'Tips',
	'ss_tipc' => 'Each line a Number or split by [,]; Message within 240 words.',
	'ss_balance' => 'Balance',

	// apis/pay_logs.php
	'pay_amount' => 'Amount',
	'pay_api' => 'API-ID',
	'pay_method' => 'Method',
	'pay_dir' => 'Dir',
	'pay_note' => 'Note',
	'pay_cfg' => 'Config',
	'pay_pcfg' => 'Pay-Config',
	'pay_2ndoc' => 'Docs for 2nd Dev.',

	// apis/*
	'exp_set' => 'Set',
	'exp_detail' => 'Detail',
	'sms_count' => 'Count',
	'ord_icon' => 'Icon',
	'ord_icocss' => 'Icon Name or CSS',
	'ord_extfee' => 'Extra-Amount',
	'qa_alltype' => 'All-Types',
	'qa_alltag' => 'All-Tags',
	'qa_reset' => 'Update/Reset',
	'cfg_tips' => 'Tips', 	// acfgs
	'cfg_nocfg' => 'Not found Congifs',
	'cfg_copy' => 'Please Copy file ',
	'cfg_to' => ' to ',
	'cfg_editip' => ' and Edit Params',
	'cfg_nowcfg' => 'Now Config',
	'cfg_nowfile' => 'Now Config File',
	'cfg_edit' => 'Edit-Config',
	'cfg_optime' => 'OP-Time',

	// dops/dopComs.php
	'dc_c1024' => '10-24 Letters',
	'dc_norel' => 'No[Rel.Model]ID',
	// glib/fldCfgs.php
	'fc_rftype' => 'Demo:Types',
	'fc_rffield' => 'Demo:Fields',

	//dops/dopCheck.php
	'ck_grade' => 'OP-No-Perm[{val}]!',
	'ck_stop' => 'OP-No-Perm[{val}]!',
	'ck_login' => 'OP-No-Perm[login], Please Login First!',
	'ck_all' => 'All Maximum Publish limit is [{val}] Items!',
	'ck_day' => 'A Day Maximum Publish limit is [{val}] Items!',
	'ck_rep' => 'Can NOT Repeat Publish In [{val}] Secends!',

	'tip_slogs' => 'For optimization and personalization using',
	'tip_ssel' => 'Must choose',
	'tip_suser' => 'For modify operation use',
	'tip_sip' => 'For modify operation IP',

	//flow/dops/xxx
	'dops_parerr' => 'Param Error',
	'dops_add' => 'Add',
	'dops_edit' => 'Edit',
	'dops_ok' => 'OK!',
	'dops_okn' => 'Items {val} OK!',
	'dops_add2' => 'AddInfo',
	'dops_adm2' => 'Manage',

	'dops_checked' => 'Check',
	'dops_hide' => 'Hide',
	'dops_del' => 'Del',

	'dops_setop' => 'Please set Operation!',
	'dops_setitem' => 'Please set Items!',
	'dops_send' => 'Send',
	'dops_back' => 'Back',
	'dops_nodata' => 'NO-Data',
	'dops_opok' => 'OP-OK!',

	'dops_clearok' => 'ClearOK!',
	'dops_clear' => 'Clear',
	'dops_search' => 'Search',

	'dops_icat' => 'Catalog',
	'dops_ishow' => 'Show',
	'dops_copy' => 'Copy',
	'dops_cpro' => 'Copy Product',
	'dops_rem' => 'Remark',

	'dops_delok' => ' Items Del OK!',
	'dops_kid' => 'Mark',
	'dops_itemname' => 'Item-Name',
	'dops_cpok' => 'Copy OK!',
	'dops_detail' => 'Detail Info.',
	'dops_exeu' => 'Execute',

	'dops_fromdata' => 'FromData',
	'dops_reldata' => 'Rel.Info',
	'dops_orduidd' => 'User(D)',
	'dops_orduida' => 'User(A)',
	'dops_ordkidd' => 'ID(D)',
	'dops_ordkida' => 'ID(A)',
	'dops_ordtimd' => 'Add(D)',
	'dops_ordtima' => 'Add(A)',
	'dops_ordasc' => '(A)',
	'dops_orddesc' => '(D)',

	'log_aip' => 'AddIP',
	'log_eip' => 'EditIP',
	'log_atime' => 'AddTime',
	'log_etime' => 'EditTime',

	'log_optime' => 'OP-Time',
	'log_opuser' => 'OP-User',
	'log_opip' => 'OP-IP',
	'log_opadd' => 'Add:',
	'log_opedit' => 'Edit:',

	'op0_filt' => '-Filt-',
	'op0_search' => '-Search-',
	'op0_bacth' => '-OPs-',
	'op0_order' => '-Order-',	
	'op0_show' => '-Show-',
	'op0_cat' => '-Catalog-',
	'op0_type' => '-Type-',
	'op0_field' => '-Field-',
	'op0_area' => '-Area-',

	'op_op4' => "upd|Update\ndel|Delete\nshow|Open\nstop|Close",
	'op_upd' => 'Update',
	'op_del' => 'Delete',
	'op_open' => 'Open',
	'op_close' => 'Close',
	'op_op3' => "del|Delete\nshow|Show\nhidden|Hidden",
	'op_show' => 'Show',
	'op_hide' => 'Hide',
	'op_delsel' => 'DelSel',
	'op_delnow' => 'DelNow',

	'title_select' => 'Sel.',
	'title_name' => 'Name',
	'title_top' => 'Top',
	'title_enable' => 'Enable',
	'title_char' => 'Char',
	'title_level' => 'Level',
	'title_frame' => 'Frame',
	'title_subtype' => 'Sub.',
	'title_param' => 'Param',
	'title_edit' => 'Edit',
	'title_note' => 'Note',
	'title_model' => 'Model',
	'title_type' => 'Type',
	'title_defval' => 'Def-Val',
	'title_cfg' => 'Config',

	'title_perm' => 'Perm',
	'title_field' => 'Field',
	'title_fields' => 'Fields',
	'title_set' => 'Set',
	'title_copy' => 'Copy',
	'title_cata' => 'Catalog',
	'title_bei' => 'Spare',
	'title_grade' => 'Grade',
	'title_mode' => 'Mode',
	'title_admin' => 'Admin',
	'title_parset' => 'ParamSet',

	'title_op' => 'Operation',
	'title_pid' => 'PID',
	'title_newid' => 'NewID',
	'title_attrset' => 'AttrSet',
	'title_attrtitle' => 'Attribute',

	'msg_pkitem' => 'Please Select Items',
	'msg_set' => 'Set OK!',
	'msg_upd' => 'Update OK!',
	'msg_add' => 'Add OK!',
	'msg_del' => 'Delete OK!',
	'msg_move' => 'Move OK',
	'msg_exists' => 'Item:[{val}]Exists!',
	'msg_delxng' => 'Del Fail, Please set Condition',
	'msg_delxok' => 'Now Condition [{val}] DelOK',

	'fl_addin' => 'Add-IN',
	'fl_addtitle' => 'Add-Item',
	'fl_opbatch' => 'Batch-OP',
	'fl_kflag' => 'KeyID',
	'fl_cfgtab' => 'CfgTable',
	'fl_cfgtip' => 'Fmt:key=value,each item a line; ',
	'fl_deeltitle' => 'Deel-OP',

);



/*******************************************************************************
 File : \code\lang\kvphp\plus-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

  'fop_mdtitle' => '媒体（文件）插入管理',
  'fop_mdtype' => '媒体类型',
  'fop_mdadd' => '媒体地址',
  'fop_piont' => '地图坐标',
  'fop_expar' => '扩展属性',
  'fop_size' => '显示大小',
  'fop_defsize' => '默认显示大小',
  'fop_btnok' => '确定',
  'fop_cancel' => '取消',
  'fop_note' => '说明',
  'fop_error' => '错误',
  'fop_alln' => '共[{val}]个',
  'fop_fupfail' => '文件上传失败: ',
  'fop_fupok' => '文件上传成功: ',
  'fop_upok' => '上传成功',
  'fop_upfail' => '上传失败',
  'fop_batup' => '附件批量上传',
  'fop_add' => '增加',
  'fop_item' => '个',
  'fop_set' => '设置',
  'fop_oview' => '预览',
  'fop_picview' => '图片预览',
  'fop_uponetitle' => '附件（文件）上传（表单）',
  'fop_upbattitle' => '附件（文件）批量上传（表单）',

  // file/fview.php
  'fv_delok' => '删除成功!',
  'fv_delng' => '删除失败!',
  'fv_ftitle' => '媒体（视频，音频，Flash，iFrame，地图）插入',
  'fv_nusub' => '(无子目录)',
  'fv_click' => '点击文件即选择并返回',
  'fv_flist' => '附件选择管理',

  'fv_tfiles' => '文件选择/目录列表',
  'fv_tview' => '预览',
  'fv_tpick' => '选择',
  'fv_tsize' => '大小[B]',
  'fv_tadd' => '创建时间',
  'fv_tdel' => '删除',

  'fv_open' => '打开查看',
  'fv_pfile' => '选择文件',
  'fv_delq' => '确认删除[{val}]? \\n请小心操作哦！',

  'fv_file' => '文件',
  'fv_dir' => '目录',
  'fv_nofiles' => '暂时无 文件/目录列表...请上传!',
  'fv_adddir' => '建立目录',
  'fv_uplocal' => '本地上传',
  'fv_or' => '或',
  'fv_atuoname' => '自动命名',
  'fv_orgname' => '原文件名',
  'fv_upload' => '上传',
  'fv_rempic' => '远程图片',
  'fv_b64pic' => 'Base64图片',

  // editor/
  'edt_tplchar' => '模版/特殊字符',
  'edt_tpl' => '模版',
  'edt_spchar' => '特殊字符',
  'edt_insok' => '已经插入!',

  // coms/add_coms.php
  'coms_errvcode' => '认证码错误，增加失败！',
  'coms_addok' => '增加[{val}]成功！',
  'coms_closerep' => '已关闭回复！请联系管理员.',

  //ajax/cajax.php
  'cajax_userid' => '该登陆名',
  'cajax_field' => '字段',
  'cajax_sysuesed' => '已占用或被系统保留',
  'cajax_syskeep' => '已被系统保留',
  'cajax_exsists' => '已经存在',
  'cajax_mykeys' => '不能为mysql保留字',
  'cajax_beuesed' => '已被占用',
  'cajax_repeat' => '该资料重复',
  'cajax_vcerr' => '认证码错误[1]',
  'cajax_vctout' => '认证码超时[2]',
  'cajax_erparam' => '参数错误',

  //ajax/cron.php
  'cron_res' => '生成结果:',
  'cron_ok' => '删除成功:',
  'cron_err' => '删除失败:',

  //ajax/pick.php
  'pick_uname' => '会员账号',
  'pick_xgrd' => '-等级-',
  'pick_xcat' => '-栏目-',
  'pick_xso' => '-筛选-',
  'pick_xord' => '-排序-',
  'pick_select' => '选择',
  'pick_grade' => '等级',
  'pick_catalog' => '栏目',
  'pick_selected' => '已选',
  'pick_selunit' => '个',
  'pick_close' => '关闭',
  'pick_nodata' => '无资料！',

  //ajax/vimg.php
  'vimp_res' => '验证结果',
  'vimp_ok' => '[OK]认证成功!<br>请放心提交表单！',
  'vimp_err' => '认证错误！',

  //api/color.php
  'color_org' => '原色',
  'color_code' => '代码',
  'color_now' => '选中<br>色彩',
  'color_setok' => '确定',
  'color_cancel' => '取消',

  //api/types.php
  // null 

  /*
  coms/add_coms.php
  [a:6] array (
  0 => '认证码错误',
  1 => '增加失败',
  2 => '增加',
  3 => '成功',
  4 => '认证码',
  5 => '提交',

  coms/faqs.php
  [a:8] array (
  0 => '认证码错误',
  1 => '增加失败',
  2 => '增加',
  3 => '成功',
  4 => '所在栏目',
  5 => '显示',
  6 => '认证码',
  7 => '提交',

  coms/gbook.php
  [a:6] array (
  0 => '认证码错误',
  1 => '增加失败',
  2 => '增加',
  3 => '成功',
  4 => '认证码',
  5 => '提交',

  coms/qarep.php
  [a:8] array (
  0 => '已关闭回复',
  1 => '请联系管理员.',
  2 => '认证码错误',
  3 => '增加失败',
  4 => '增加',
  5 => '成功',
  6 => '认证码',
  7 => '提交',

  coms/_cfgcom.php
  [a:1] array (
  0 => '参数错误:',

  coms/_cfgdoc.php
  [a:1] array (
  0 => '参数错误:',

  editor/tpl_cfg.php
  [a:3] array (
  0 => '模版/特殊字符',
  1 => '特殊字符',
  4 => '模版',

  editor/tpl_doc.php
  [a:1] array (
  0 => ']已经插入',

  editor/_pub.js
  [a:21] array (
  0 => '插入特殊字符',
  2 => '3套方案',
  3 => '字符',
  4 => '插入内容模版',
  6 => '2套方案',
  7 => '模版',
  8 => '附件管理',
  10 => '视频,图片,附件等大文件选取',
  11 => '附件',
  12 => '插入媒体',
  14 => 'iFrame,swf,视频,音频等',
  15 => '媒体',
  16 => '插入分页符',
  17 => '用于长内容分页,与前台配合使用',
  18 => '分页',
  19 => '插入日期',
  20 => '格式:2013-12-31',
  21 => '日期',
  22 => '插入时间',
  23 => '格式:23:12:30',
  24 => '时间',

  file/funcs.js
  [a:19] array (
  0 => '正在提交第[',
  1 => ']个项目',
  2 => '共[',
  3 => ']个项目提交成功',
  6 => '空项目',
  7 => '未提交',
  8 => '至少要有一个文件',
  9 => '最多一次只能上传24个文件',
  10 => '图片预浏:',
  11 => '扩展属性',
  12 => '标点名称',
  13 => '循环播放',
  14 => '自动播放',
  15 => '请选择有效的[媒体类型]',
  16 => '请输入有效的[地图坐标]',
  17 => '请输入有效的[媒体地址]',
  18 => '不支持Safari6.0以下浏览器的图片预览',
  19 => '仅支持',
  20 => '为后缀名的文件',

  file/fview.php
  [a:50] array (
  0 => '删除成功',
  1 => '删除失败',
  2 => '媒体',
  3 => '视频',
  4 => '音频',
  5 => '地图',
  6 => '插入',
  7 => '无子目录',
  8 => '击文件即选择并返回',
  9 => '附件选择管理',
  10 => '文件选择/目录列表',
  11 => '预览',
  12 => '选择',
  13 => '大小[B]',
  14 => '创建时间',
  15 => '删除',
  17 => '打开查看',
  18 => '选择文件',
  21 => '确认删除[',
  22 => 'n请小心操作哦',
  25 => '文件:',
  26 => '目录:',
  27 => '暂时无',
  28 => '文件/目录列表...请上传',
  30 => '建立目录',
  31 => '本地上传:',
  32 => '自动命名',
  33 => '原文件名',
  34 => '上传',
  35 => '远程图片',
  36 => 'Base64图片',
  37 => '注意',
  38 => '大文件请用FTP上传',
  39 => '可参考[管理帮助]',
  40 => '文件目录规划',
  41 => '相关文件',
  42 => '可用[预览',
  43 => '复制链接地址]得到相关附件地址',
  44 => '[临时]',
  45 => '新上传文档,都放在这里,添加后会自动移动到相关文件夹',
  46 => '[当前]',
  47 => '编辑资料时显示此项,此文件夹下的附件关联当前资料',
  48 => '[上传]',
  49 => '可批量上传到文件',
  50 => '[插入]',
  51 => '可插入',
  52 => '内框架',
  54 => 'Flash媒体',
  55 => '音频媒体',
  56 => '视频媒体',

  file/media.php
  [a:12] array (
  0 => '附件',
  1 => '文件',
  2 => '选择管理',
  3 => '媒体类型',
  4 => '媒体地址',
  5 => '地图坐标',
  6 => '扩展属性',
  7 => '显示大小',
  8 => '默认显示大小',
  9 => '确定',
  10 => '取消',
  11 => '说明',

  file/upbat.php
  [a:35] array (
  0 => '附件',
  1 => '文件',
  2 => '批量上传',
  3 => '表单',
  4 => '附件批量上传',
  5 => '文件:',
  6 => '增加:',
  7 => '设置:',
  8 => '自动命名',
  9 => '原文件名',
  10 => '上传',
  11 => '说明',
  12 => '本程序受启发于',
  13 => '请先设置类别',
  14 => '再浏览图片',
  15 => '可用下方的',
  16 => '按纽增加n个图片项目',
  17 => '一次最多可设置96个图片批量上传',
  18 => '本程序为增值程序',
  19 => '免费使用',
  20 => '请不要苛求它的功能',
  21 => '如不能满足您的需要',
  22 => '请用普通方式添加资料',
  23 => '建议把要上传的文件',
  24 => '放在同一文件夹中',
  25 => '用标题作为图片名',
  26 => '默认情况下,本系统把文件名作为信息的标题',
  27 => '其文件名',
  28 => '除后缀外',
  29 => '不能用空格引号点等特殊字符',
  30 => '建议全用英文半角的字母',
  31 => '数字或下划线',
  32 => '除图片名可用中文外',
  33 => '目录建议也不要用中文',
  34 => '删除',

  file/updeel.php
  [a:5] array (
  0 => '错误',
  1 => '文件上传失败',
  2 => '文件上传成功',
  3 => '上传成功:',
  4 => '上传失败:',

  file/upone.php
  [a:8] array (
  0 => '附件',
  1 => '文件',
  2 => '上传',
  3 => '表单',
  4 => '预览',
  5 => '图片预览',
  6 => '自动命名',
  7 => '原文件名',
  */

  //map/index.php
  'map_title' => '地图',
  'map_piont' => '坐标:',
  'map_setok' => '确定',

);




/*******************************************************************************
 File : \code\lang\kvphp\plus-en.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

  'fop_mdtitle' => 'Media (file) Insert',
  'fop_mdtype' => 'Media Type',
  'fop_mdadd' => 'Media Url',
  'fop_piont' => 'Map-Piont',
  'fop_expar' => 'Ext.Param',
  'fop_size' => 'Show Size',
  'fop_defsize' => 'Def. Size',
  'fop_btnok' => 'Confirm',
  'fop_cancel' => 'Cancel',
  'fop_note' => 'Notice',
  'fop_error' => 'Error',
  'fop_alln' => 'All[{val}]Items',
  'fop_fupfail' => 'File Upload Fail',
  'fop_fupok' => 'File Upload OK',
  'fop_upok' => 'Upload OK',
  'fop_upfail' => 'Upload Fail',
  'fop_batup' => 'Batch Upload',
  'fop_add' => 'Add',
  'fop_item' => 'Items',
  'fop_set' => 'Set',
  'fop_oview' => 'Preview',
  'fop_picview' => 'Picview',
  'fop_uponetitle' => 'Attachment (file) Upload (Form)',
  'fop_upbattitle' => 'Attachment (file) Batch Upload (Form)',

  // file/fview.php
  'fv_delok' => 'Delete OK!',
  'fv_delng' => 'Delete Fail!',
  'fv_ftitle' => 'Media(Video,Audio,Flash,iFrame,Map) Insert',
  'fv_nusub' => '(NO Sub Dirs)',
  'fv_click' => 'Click pick file and return',
  'fv_flist' => 'Files Pick Admin',

  'fv_tfiles' => 'Files/Dirs Lists',
  'fv_tview' => 'View',
  'fv_tpick' => 'Pick',
  'fv_tsize' => 'Size[B]',
  'fv_tadd' => 'Add-Time',
  'fv_tdel' => 'Del',

  'fv_open' => 'Open',
  'fv_pfile' => 'Pick File', 
  'fv_delq' => 'Be sure to delete [{val}]? \\nPlease be careful!',

  'fv_file' => 'File',
  'fv_dir' => 'Dir',
  'fv_nofiles' => 'There NO file / dir Temporarily... Please upload!',
  'fv_adddir' => 'Add Dir',
  'fv_uplocal' => 'Local upload',
  'fv_or' => 'or',
  'fv_atuoname' => 'Auto Naming',
  'fv_orgname' => 'Keep Org Name',
  'fv_upload' => 'Upload',
  'fv_rempic' => 'Remote Pic',
  'fv_b64pic' => 'Base64 Pic',

  // editor/
  'edt_tplchar' => 'Template / Special Character',
  'edt_tpl' => 'Tpl',
  'edt_spchar' => 'Char',
  'edt_insok' => 'Insert OK!',

  // coms/add_coms.php
  'coms_errvcode' => 'Auth Code Error, Add Fail!',
  'coms_addok' => 'Add [{val}] OK!',
  'coms_closerep' => 'It is closed, CAN NOT reply!',

  //ajax/cajax.php
  'cajax_userid' => 'User ID',
  'cajax_field' => 'Field',
  'cajax_sysuesed' => ' has used by System',
  'cajax_syskeep' => ' has keeped by System',
  'cajax_exsists' => ' has Exsists',
  'cajax_mykeys' => ' can NOT mysql-keyword',
  'cajax_beuesed' => ' has uesed',
  'cajax_repeat' => 'Repeat',
  'cajax_vcerr' => 'vCode Error[1]',
  'cajax_vctout' => 'vCode Timeout[2]',
  'cajax_erparam' => 'Param Error',

  //ajax/cron.php
  'cron_res' => 'Result:',
  'cron_ok' => 'Del OK:',
  'cron_err' => 'Del Error:',

  //ajax/pick.php
  'pick_uname' => 'UserID',
  'pick_xgrd' => '-Grade-',
  'pick_xcat' => '-Catalog-',
  'pick_xso' => '-Search-',
  'pick_xord' => '-Order-',
  'pick_select' => 'Select',
  'pick_grade' => 'Grade',
  'pick_catalog' => 'Catalog',
  'pick_selected' => 'Selected',
  'pick_selunit' => '',
  'pick_close' => 'Close',
  'pick_nodata' => 'No Data!',

  //ajax/vimg.php
  'vimp_res' => 'Result',
  'vimp_ok' => '[OK]OK!<br>Please Submit Form!',
  'vimp_err' => 'Error!',

  //api/color.php
  'color_org' => 'Org.',
  'color_code' => 'Code',
  'color_now' => '[Now]<br>Color',
  'color_setok' => 'SetOK',
  'color_cancel' => 'Cancel',

  //api/types.php
  // null 

  /*
  coms/add_coms.php
  [a:6] array (
  0 => '认证码错误',
  1 => '增加失败',
  2 => '增加',
  3 => '成功',
  4 => '认证码',
  5 => '提交',

  coms/faqs.php
  [a:8] array (
  0 => '认证码错误',
  1 => '增加失败',
  2 => '增加',
  3 => '成功',
  4 => '所在栏目',
  5 => '显示',
  6 => '认证码',
  7 => '提交',

  coms/gbook.php
  [a:6] array (
  0 => '认证码错误',
  1 => '增加失败',
  2 => '增加',
  3 => '成功',
  4 => '认证码',
  5 => '提交',

  coms/qarep.php
  [a:8] array (
  0 => '已关闭回复',
  1 => '请联系管理员.',
  2 => '认证码错误',
  3 => '增加失败',
  4 => '增加',
  5 => '成功',
  6 => '认证码',
  7 => '提交',

  coms/_cfgcom.php
  [a:1] array (
  0 => '参数错误:',

  coms/_cfgdoc.php
  [a:1] array (
  0 => '参数错误:',

  editor/tpl_cfg.php
  [a:3] array (
  0 => '模版/特殊字符',
  1 => '特殊字符',
  4 => '模版',

  editor/tpl_doc.php
  [a:1] array (
  0 => ']已经插入',

  editor/_pub.js
  [a:21] array (
  0 => '插入特殊字符',
  2 => '3套方案',
  3 => '字符',
  4 => '插入内容模版',
  6 => '2套方案',
  7 => '模版',
  8 => '附件管理',
  10 => '视频,图片,附件等大文件选取',
  11 => '附件',
  12 => '插入媒体',
  14 => 'iFrame,swf,视频,音频等',
  15 => '媒体',
  16 => '插入分页符',
  17 => '用于长内容分页,与前台配合使用',
  18 => '分页',
  19 => '插入日期',
  20 => '格式:2013-12-31',
  21 => '日期',
  22 => '插入时间',
  23 => '格式:23:12:30',
  24 => '时间',

  file/funcs.js
  [a:19] array (
  0 => '正在提交第[',
  1 => ']个项目',
  2 => '共[',
  3 => ']个项目提交成功',
  6 => '空项目',
  7 => '未提交',
  8 => '至少要有一个文件',
  9 => '最多一次只能上传24个文件',
  10 => '图片预浏:',
  11 => '扩展属性',
  12 => '标点名称',
  13 => '循环播放',
  14 => '自动播放',
  15 => '请选择有效的[媒体类型]',
  16 => '请输入有效的[地图坐标]',
  17 => '请输入有效的[媒体地址]',
  18 => '不支持Safari6.0以下浏览器的图片预览',
  19 => '仅支持',
  20 => '为后缀名的文件',

  file/fview.php
  [a:50] array (
  0 => '删除成功',
  1 => '删除失败',
  2 => '媒体',
  3 => '视频',
  4 => '音频',
  5 => '地图',
  6 => '插入',
  7 => '无子目录',
  8 => '击文件即选择并返回',
  9 => '附件选择管理',
  10 => '文件选择/目录列表',
  11 => '预览',
  12 => '选择',
  13 => '大小[B]',
  14 => '创建时间',
  15 => '删除',
  17 => '打开查看',
  18 => '选择文件',
  21 => '确认删除[',
  22 => 'n请小心操作哦',
  25 => '文件:',
  26 => '目录:',
  27 => '暂时无',
  28 => '文件/目录列表...请上传',
  30 => '建立目录',
  31 => '本地上传:',
  32 => '自动命名',
  33 => '原文件名',
  34 => '上传',
  35 => '远程图片',
  36 => 'Base64图片',
  37 => '注意',
  38 => '大文件请用FTP上传',
  39 => '可参考[管理帮助]',
  40 => '文件目录规划',
  41 => '相关文件',
  42 => '可用[预览',
  43 => '复制链接地址]得到相关附件地址',
  44 => '[临时]',
  45 => '新上传文档,都放在这里,添加后会自动移动到相关文件夹',
  46 => '[当前]',
  47 => '编辑资料时显示此项,此文件夹下的附件关联当前资料',
  48 => '[上传]',
  49 => '可批量上传到文件',
  50 => '[插入]',
  51 => '可插入',
  52 => '内框架',
  54 => 'Flash媒体',
  55 => '音频媒体',
  56 => '视频媒体',

  file/media.php
  [a:12] array (
  0 => '附件',
  1 => '文件',
  2 => '选择管理',
  3 => '媒体类型',
  4 => '媒体地址',
  5 => '地图坐标',
  6 => '扩展属性',
  7 => '显示大小',
  8 => '默认显示大小',
  9 => '确定',
  10 => '取消',
  11 => '说明',

  file/upbat.php
  [a:35] array (
  0 => '附件',
  1 => '文件',
  2 => '批量上传',
  3 => '表单',
  4 => '附件批量上传',
  5 => '文件:',
  6 => '增加:',
  7 => '设置:',
  8 => '自动命名',
  9 => '原文件名',
  10 => '上传',
  11 => '说明',
  12 => '本程序受启发于',
  13 => '请先设置类别',
  14 => '再浏览图片',
  15 => '可用下方的',
  16 => '按纽增加n个图片项目',
  17 => '一次最多可设置96个图片批量上传',
  18 => '本程序为增值程序',
  19 => '免费使用',
  20 => '请不要苛求它的功能',
  21 => '如不能满足您的需要',
  22 => '请用普通方式添加资料',
  23 => '建议把要上传的文件',
  24 => '放在同一文件夹中',
  25 => '用标题作为图片名',
  26 => '默认情况下,本系统把文件名作为信息的标题',
  27 => '其文件名',
  28 => '除后缀外',
  29 => '不能用空格引号点等特殊字符',
  30 => '建议全用英文半角的字母',
  31 => '数字或下划线',
  32 => '除图片名可用中文外',
  33 => '目录建议也不要用中文',
  34 => '删除',

  file/updeel.php
  [a:5] array (
  0 => '错误',
  1 => '文件上传失败',
  2 => '文件上传成功',
  3 => '上传成功:',
  4 => '上传失败:',

  file/upone.php
  [a:8] array (
  0 => '附件',
  1 => '文件',
  2 => '上传',
  3 => '表单',
  4 => '预览',
  5 => '图片预览',
  6 => '自动命名',
  7 => '原文件名',
  */

  //map/index.php
  'map_title' => 'Map',
  'map_piont' => 'Piont:',
  'map_setok' => 'SetOK',

);




/*******************************************************************************
 File : \code\lang\kvphp\tools-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// exdiy/mktpl.htm
	'mktpl_crtok' => '创建成功:',
	'mktpl_crtng' => '创建失败:',
	'mktpl_error' => '错误',
	'mktpl_suit' => '模板套件工具', 
	'mktpl_tpldir' => '模板目录',
	'mktpl_dir' => '目录',
	'mktpl_312' => '3~12个数字或英文字符',
	'mktpl_enfile' => '入口文件',
	'mktpl_datamode' => '数据模型',
	'mktpl_nowrite' => '不可用提示',
	'mktpl_fnwrite' => '文件{val}不可写。',
	'mktpl_crtres' => '创建结果',
	'mktpl_view' => '预览',
	'mktpl_back' => '返回',
	'mktpl_crtsuit' => '创建模板套件',
	'mktpl_create' => '创建',
	'mktpl_tplname' => '模板名称',
	'mktpl_def' => '可不填写默认为',
	'mktpl_more' => '更多说明/手动配置 见：',
	'mktpl_nvtpl' => '模板标签 >> 整套模版',

	// exdiy/rplan.htm
	'rplan_ntime' => '当前时间',
	'rplan_nstat' => '当前状态',
	'rplan_title' => '定时执行工具 --- 计划任务本地辅助程序',

	// setup/upcomp.htm
	'upc_tupd_cfgp' => '更新程序 - 处理配置数据',
	'upc_nowdeel' => '当前正在处理的是',
	'upc_editcfg' => '修改过的配置',
	'upc_recs' => '条记录',
	'upc_runsql' => '参考sql（可复制修改部分手动更新）',
	'upc_addcfg' => '添加的配置',

	'upc_endtb' => '所有表已经处理完成',
	'upc_next' => '下一步',
	'upc_noupd' => '当前表 无更新项',
	'upc_nxtab' => '确认进入下一表',
	'upc_tpadd1' => '部分(如果有), 默认会更新到当前系统；',
	'upc_onlyadd' => '只更新添加的配置',
	'upc_tpedit1' => '部分(如果有), 建议根据参考sql, 部分手动更新；',
	'upc_bothae' => '更新添加和修改的配置',
	'upc_updsql' => '(必要先执行sql语句)手动更新确认',
	'upc_updall' => '更新所有配置(请谨慎操作！)',
	'upc_updntab' => '更新当前表',
	'upc_caddcfg' => '确认添加配置',
	'upc_f1t9' => '请逐一点击上方各表；',
	'upc_rbsend' => '选择右下方更新方式确认。',

	'upc_tupd_comp' => '更新程序 - 配置文件比较',
	'upc_lred' => '左边红色',
	'upc_tip21' => '部分,一般是要添加的配置行, 请更新到当前系统；',
	'upc_rred' => '右边红色',
	'upc_tip22' => '部分,是你自己添加的配置行；',
	'upc_blue' => '蓝色',
	'upc_tip23' => '部分, 一般不需要修改, 请自行斟酌；',
	'upc_eupd1' => '请手动修改, 修改后可刷新此页查看效果。',
	'upc_tupd_cdb' => '更新程序 - 数据表结构比较',
	'upc_tip31' => '部分,一般是要添加的索引；',
	'upc_tip32' => '部分,是你自己添加的字段或索引；',
	'upc_tip33' => '部分为改动部分, 是修改过的字段配置；',
	'upc_eupd2' => '请手动自行判断并更新, 修改后可刷新此页查看效果。',

	// setup/upflow.htm
	'upl_setdir' => '请设置目录: ',
	'upl_upinit' => '更新程序-初始化',
	'upl_updir' => '有效升级包路径',
	'upl_refresh' => '刷新',
	'upl_tipin' => '不要设置在当前站点的code,root目录内',
	'upl_init' => '初始化',

	'upl_steps' => '更新步骤',
	'upl_read' => '阅读升级说明',
	'upl_rdlay' => '发布日志-升级说明',
	'upl_view' => '查看',
	'upl_upcode' => '升级code目录',
	'upl_addfile' => '补全文件',
	'upl_editfile' => '覆盖文件',
	'upl_cmpfile' => '比较文件',
	'upl_dltpls' => '处理tpls目录',
	'upl_uproot' => '升级root目录',
	'upl_dlskin' => '处理skin目录',

	'upl_upelse' => '升级其他目录',
	'upl_adddtmp' => '补全dtmp目录',
	'upl_dl3var' => '处理[static/vendor/vendui]3目录',
	'upl_upddb' => '更新数据库',
	'upl_backup' => '备份确认',
	'upl_addtab' => '添加表',
	'upl_addfield' => '添加字段',
	'upl_editfield' => '补全字段',
	'upl_config' => '配置数据',
	'upl_endupd' => '完成更新',
	'upl_updver' => '更新版本号',
	'upl_endlock' => '完成更新并锁定',

	'upl_tipres' => '更新提示/更新结果',
	'upl_mdxdir' => '手动处理{val}目录:',
	'upl_cfmdok' => '确认[手动处理]完毕',
	'upl_tips' => '提示',
	'upl_tptpl' => '模板目录, 一般都修改过, 请自行手动处理',
	'upl_tpskn' => '与处理/code/tpls/目录类似, 但注意需要更新jslib子目录的文件（通用js库）；',
	'upl_tpcfg' => '可直接复制最新包的文件覆盖过来',
	'upl_mdback' => '手动备份数据库:',
	'upl_docfg' => '处理配置数据:',
	'upl_stcfg' => '开始处理[配置数据]',

	// setup/upvnow.php
	'upn_title' => '更新程序 - 升级当前系统',
	'upn_tip1' => '请: 从上到下, 从左到右, 点击按钮, 逐步更新。',
	'upn_afres' => '补全文件: 结果列表...',
	'upn_ofres' => '覆盖文件: 结果列表...',
	'upn_cpres' => '比较文件: 手动处理列表...',
	'upn_cnfm' => '确认[手动处理]完毕',
	'upn_dtmp' => '补全dtmp目录: 结果列表...',
	'upn_addtb' => '添加数据表: 结果列表...',
	'upn_addfld' => '[添加]表字段: ',
	'upn_cmpfld' => '比较字段: 手动处理列表...',

	// setup/upvimp*
	'upi_title' => '更新程序 - 对比数据库结构',
	'upi_recache' => '初始化缓存:完成！',
	'upi_updnav' => '更新程序 - 操作导航',
	'upi_tipcfg' => '请设置配置文件: {code}/cfgs/excfg/ex_outdb.php (下方的$_cfgs相关配置)<br>提示: 可从旧版的{code}/cfgs/boot/cfg_db.php中复制过来',
	'upi_tips' => '提示',
	'upi_dbstrucp' => '数据库结构对比',
	'upi_initcache' => '初始化缓存',
	'upi_adtabs' => '增减的表',
	'upi_efields' => '修改的字段',
	'upi_adindex' => '增减的索引',
	'upi_impsql' => '导入SQL',
	'upi_dblink' => '连接和数据库工具',
	'upi_dbstru' => '数据库结构',
	'upi_dbadm' => '数据库管理',
	'upi_login' => '管理工具登录',
	'upi_impnote' => '导入数据说明',
	'upi_orview' => '查看后台: [更新升级说明] 或 官方', 

	// tester
	'test_name' => '中文名',
	'test_end' => '测试结束',

	'start_title' => '起始页',
	'bug_tools' => '调试/工具',

	'start_setup' => '安装程序',
	'start_map' => '地图',
	'start_login' => '工具登录',
	'start_dbadmin' => '数据库管理',
	'start_cmsentry' => '入口',

	'adcfg_start' => '首页',
	'adcfg_setup' => 'Setup',
	'adcfg_binfo' => '基础环境',
	'adcfg_chkenv' => '环境检测',
	'adcfg_reset' => '系统重置',
	'adcfg_yes' => '支持',

	'binf_lowbrowser' => '你的浏览器版本过低！！！不支持框架集[frameset]。',
	'binf_userenv' => '用户环境',
	'binf_showerror' => '测试是否看到[Warning/Notice]提示和最后的[-End-]标记；',
	'binf_sererror' => '开发环境如不能看到,请设置环境以便于调试！',
	'binf_usenotes' => 'Peace提示：请用于合法用途；使用前前改密码，使用后请删除本文件或移动到网站目录之外！',
	'binf_nosupport' => '不支持',
	'binf_frames' => '框架',
	'binf_html5base' => '基本特性',
	'binf_editp' => '这是一段可编辑的段落,请试着编辑该文本。',
	'binf_details' => '测试是否支持details：标签用于描述文档或文档某个部分的细节。与 summary标签 配合使用可以为 details 定义标题。标题是可见的，用户点击标题时，会显示出 details。',
	'binf_css3r' => '圆角样式',
	'binf_detail' => '详情',
	'binf_nosuplocal' => '不支持本地存储。',
	'binf_suplocal' => '支持本地存储',

	'home_extitle' => '通用PHP建站系统',
	'home_exkwd' => '轻量免费,开源共享,PHP CMS,微信接口,IntimateCat,贴心猫,txmao,imcat',
	'home_exdes' => '是一款轻量、免费、共享的通用PHP网站应用系统；PC版-手机版-微信接口一站搞定！',
	'home_botname' => '贴心猫',

	'chk_envcheck' => '环境检测',
	'chk_envbaisc' => '基本环境',
	'chk_envname' => '名称',
	'chk_envres' => '结果',
	'chk_envstat' => '状态',
	'chk_envrem' => '备注',

	'chk_risk' => '危险', 
	'chk_safe' => '安全',
	'chk_set0' => '正式使用请设置为0',
	'chk_demo' => '示例',
	'chk_usptest' => '超级测试',
	'chk_pick1' => '选一个操作',
	'chk_cmemory' => '内存(填数字,出错表示不支持)',
	'chk_cfunc' => '函数(填字符,Support表示支持)',

	'chk_sysdirs' => '系统目录',
	'chk_dirset' => '请对照文件[/root/run/_paths.php],设置相关路径！',
	'chk_dblink' => '数据库连接',
	'chk_dbstatus' => '(连接)状态/结果',
	'chk_dbextra' => '扩展',
	'chk_dbset' => '请检查[/code/cfgs/boot/cfg_db.php]配置',

	'cf_fupload' => '文件上传',
	'cf_file' => '文件：',
	'cf_path' => '路径：',
	'cf_upbtn' => '上传',
	'cf_remote' => 'Remote抓取',
	'cf_upok' => '上传OK',

	'cf_remext' => '扩展:',
	'cf_show' => '显示:',
	'cf_shmode' => '显示方式',
	'cf_tdef' => '去script,style(默认)',
	'cf_text' => '文本(包含默认)',
	'cf_torg' => '原文(原本html)',
	'cf_gbk' => 'gbk编码',
	'cf_gb2312' => 'gb2312编码',
	'cf_big5' => 'big5编码',
	'cf_send' => '提交',

	'scan_root' => '根目录：',
	'scan_set' => '设置',
	'scan_tip1' => '点[BOM]连接,将移除BOM',
	'scan_tip2' => '点击[子目录], [Ctrl+F]搜索[BOM]',
 	'scan_dirs' => '子目录：',

	'so_title' => '文件搜索器',
	'so_refresh' => '刷新',
	'so_ptext' => 'php文字',
	'so_pfunc' => 'php函数',
	'so_pvar' => 'php变量',
	'so_js' => 'js文字',
	'so_html' => 'html文字',
	'so_tpl' => 'tpl模版',
	'so_send' => '提交',
	'so_tips' => '请选择操作,并提交!',
	'so_res' => '搜索结果',
	'so_back' => '返回',

	'rst_title' => '系统重置',
	'rst_dbops' => 'DB操作',
	'rst_clear' => '清理',
	'rst_clrtmpfiles' => '清理临时文件',
	'rst_clrdblogs' => '清理DB日志',
	'rst_clrtplcache' => '清理模板缓存',
	'rst_dbcheck' => 'DB检测',
	'rst_dbnopk' => '无主索引数据表',
	'rst_dbvar255' => 'varchar(>255)字段',
	'rst_dbcindex' => '组合索引数据表',
	'rst_export' => 'DB导出',
	'rst_expframe' => '导出结构',
	'rst_expall' => '导出所有',
	'rst_exback' => '导出备份',

	'rst_end' => '完成',
	'rst_res' => '处理结果',

	'rst_reset' => '重置',
	'rst_rstdata' => '数据',
	'rst_rstcomp' => '对比',
	'rst_rstmini' => '精简',
	'rst_rstpub' => '重发布',
	'rst_rstcache' => '重置缓存',
	'rst_rstidpw' => '帐号密码',
	'rst_setidpw' => '重置帐号密码',

	'rst_idpw_set' => '当前设置不允许重置密码：请设置',
	'rst_idpw_id' => '帐号:',
	'rst_idpw_pw' => '密码:',
	'rst_idpw_memory' => '请牢记！',
	'rst_idpw_error' => '设置错误！',
	'rst_idpw_tip1' => '提示:未安装状态,不能执行DB相关操作。',
	'rst_idpw_tip2' => '帐号密码不规范：\n字母/数字/下划线组成, 且字母开头\\n帐号:3~15个字符, 密码:6~24个字符\\n且不能是如下简单字串:\\n',

	// setup/
	'setup_title' => '安装程序',
	'setup_steps' => '安装步骤',
	'setup_step' => '步骤',
	'setup_info' => '信息',
	'setup_state' => '状态',
	'setup_0cfgerror' => '[0]配置错误信息',
	'setup_mysqlinfo' => 'Mysql相关信息',
	'setup_nowdb' => '当前数据库',
	'setup_dbedit' => '修改配置或创建数据库',
	'setup_dbrule' => '3-24个字母数字下划线组成的标识',
	'setup_creat' => '创建',
	'setup_dbnoexsists' => '数据库{val}不存在',
	'setup_clickadd' => '请点[创建] 或 ',
	'setup_dbcfg' => '修改[/code/cfgs/boot/cfg_db.php]配置',
	'setup_refresh' => '刷新',
	'setup_cantlink' => '不能连接Mysql数据库；',
	'setup_x1' => '[1](安装前)环境检测',
	'setup_view' => '查看',
	'setup_my31' => '至少支持一个扩展,且可正常连接到Mysql数据库',
	'setup_start' => '-开始-',
	'setup_x2' => '[2]安装数据结构',
	'setup_wnsecs' => '耐心等待…需要好几秒钟! ',
	'setup_wait' => '等待...',
	'setup_x3' => '[3]安装基本数据',
	'setup_x4' => '[4]安装演示数据',
	'setup_demo' => '含:demo,news等演示数据',
	'setup_x5' => '[5]设置帐号',
	'setup_end' => '完成',
	'setup_idname' => '网站名称/管理帐号',
	'setup_setpara' => '参数设置-网站名称/管理帐号',
	'setup_sitename' => '网站名称',
	'setup_4_24' => '4~24个字符',
	'setup_admid' => '管理帐号',
	'setup_val_letter' => '{val}个字符数字下划线组成,且字母开头',
	'setup_admpw' => '管理密码',
	'setup_sendend' => '-提交完成安装-',
	'setup_doing' => '正在处理',
	'setup_dosteps' => '安装进度',
	'setup_dores' => '处理结果…',

	'fix_' => 'end',
	
);




/*******************************************************************************
 File : \code\lang\kvphp\tools-en.php 
*******************************************************************************/
<?php

// 语言包:en

return array(

	// exdiy/mktpl.htm
	'mktpl_crtok' => 'Create Ok:',
	'mktpl_crtng' => 'Create Fail:',
	'mktpl_error' => 'Error',
	'mktpl_suit' => 'Suit Template Tools', 
	'mktpl_tpldir' => 'Tpl-Dir',
	'mktpl_dir' => '-Dir',
	'mktpl_312' => '3~12 letters',
	'mktpl_enfile' => 'Entry File',
	'mktpl_datamode' => 'Data-Model',
	'mktpl_nowrite' => 'Can not write Tips',
	'mktpl_fnwrite' => 'File {val} Can not write.',
	'mktpl_crtres' => 'Create Res.',
	'mktpl_view' => 'View',
	'mktpl_back' => 'Back',
	'mktpl_crtsuit' => 'Create Template Suit',
	'mktpl_create' => 'Create',
	'mktpl_tplname' => 'Tpl-Name',
	'mktpl_def' => 'The default is ',
	'mktpl_more' => 'More Info/Manually config See:',
	'mktpl_nvtpl' => 'Tpl/Tag >> Suit Template',

	// exdiy/rplan.htm
	'rplan_ntime' => 'Now Time',
	'rplan_nstat' => 'Now State',
	'rplan_title' => 'Timing execution tool --- planning task local helper',

	// setup/upcomp.htm
	'upc_tupd_cfgp' => 'Update - Deel Configs Data',
	'upc_nowdeel' => 'Now dealing ',
	'upc_editcfg' => 'Modified Configs',
	'upc_recs' => ' Recs',
	'upc_runsql' => 'Run sql (You can copy and EDIT manual before run)',
	'upc_addcfg' => 'Added Configs',

	'upc_endtb' => 'All Table Deal End',
	'upc_next' => 'Next',
	'upc_noupd' => 'Now Table No Update Data',
	'upc_nxtab' => 'Confirm to the next table',
	'upc_tpadd1' => ' this part(if has), will update to you system;',
	'upc_onlyadd' => 'Only Update Add Configs',
	'upc_tpedit1' => ' this part(if has), suggest you manually update according to the reference SQL;',
	'upc_bothae' => 'Update Add/Eidt Configs',
	'upc_updsql' => '(Run sql first if need)Manual update Confirm',
	'upc_updall' => 'Update All Configs(Please do it caution!)',
	'upc_updntab' => 'Update Now Table',
	'upc_caddcfg' => 'Confirm add Configs',
	'upc_f1t9' => 'Please Click Each Table:',
	'upc_rbsend' => 'Select the right bottom update mode to confirm.',

	'upc_tupd_comp' => 'Update - Compare Configs',
	'upc_lred' => 'Red at Left',
	'upc_tip21' => ' This part, General is added configs, please update to the current system;',
	'upc_rred' => 'Red at Right',
	'upc_tip22' => ' This part, Is your own added configs line;',
	'upc_blue' => 'Blue',
	'upc_tip23' => ' This part, Generally do not need to modify, please consider;',
	'upc_eupd1' => 'Please manually edit, Refresh pages view the effect after modified.',
	'upc_tupd_cdb' => 'Update - DB Structure Compare',
	'upc_tip31' => ' This part, General is to add the index;',
	'upc_tip32' => ' This part, Is your own added index;',
	'upc_tip33' => ' This part is the changes to the part, is a modified field configs;',
	'upc_eupd2' => 'Please manually judge and update, Refresh pages view the effect after modified.',

	// setup/upflow.htm
	'upl_setdir' => 'Please Set Dir: ',
	'upl_upinit' => 'Update - Init',
	'upl_updir' => 'Effective upgrade package path',
	'upl_refresh' => 'Refresh',
	'upl_tipin' => 'Do NOT put in [code,root] dirs',
	'upl_init' => 'Init',

	'upl_steps' => 'Update Steps',
	'upl_read' => 'Read Update Notes',
	'upl_rdlay' => 'Publish-Update Notes',
	'upl_view' => 'View',
	'upl_upcode' => 'Upgrade dir:code',
	'upl_addfile' => 'Add-files',
	'upl_editfile' => 'Edit-files',
	'upl_cmpfile' => 'Compare',
	'upl_dltpls' => 'Deal-dir:tpls',
	'upl_uproot' => 'Upgrade-dir:root',
	'upl_dlskin' => 'Deal-dir:skin',

	'upl_upelse' => 'Upgrade else dirs',
	'upl_adddtmp' => 'Add dtmp dirs',
	'upl_dl3var' => 'Deal dirs:[static/vendor/vendui]',
	'upl_upddb' => 'Update DB',
	'upl_backup' => 'Backup DB',
	'upl_addtab' => 'Add Table',
	'upl_addfield' => 'Add Fields',
	'upl_editfield' => 'Edit Fields',
	'upl_config' => 'Config DB',
	'upl_endupd' => 'Finish Update',
	'upl_updver' => 'Update Version',
	'upl_endlock' => 'Finish and Lock',

	'upl_tipres' => 'Update Tips/Result',
	'upl_mdxdir' => '(Manual) Deal {val} dir:',
	'upl_cfmdok' => 'Confirm [Manual-Deal] OK ',
	'upl_tips' => 'Tips',
	'upl_tptpl' => 'Template directory, are generally modified, please manually processing',
	'upl_tpskn' => 'Like as dir:/code/tpls/, sub dir jslib is js libs, must update;',
	'upl_tpcfg' => 'Can copy then from Latest package',
	'upl_mdback' => '(Manual)Backup DB:',
	'upl_docfg' => 'Deal Configs:',
	'upl_stcfg' => 'Start Deal [Configs]',

	// setup/upvnow.php
	'upn_title' => 'Update - Upgrade NOW System',
	'upn_tip1' => 'Please: from top-bottom, left-right, click the button, and step by step.',
	'upn_afres' => 'Add filse: Res. lists ...',
	'upn_ofres' => 'Edit files: Res. lists ...',
	'upn_cpres' => 'Compare files: Manual-Deal lists ...',
	'upn_cnfm' => 'Confirm [Manual-Deal] OK ',
	'upn_dtmp' => 'Deak dtmp dir: Res. lists ...',
	'upn_addtb' => 'Add tables: Res. lists ...',
	'upn_addfld' => '[Add]fields: ',
	'upn_cmpfld' => 'Compare fields: Manual-Deal lists ...',

	// setup/upvimp*
	'upi_title' => 'Update - Compare database structure',
	'upi_recache' => 'Reset Cache: OK!',
	'upi_updnav' => 'Update - Navigation',
	'upi_tipcfg' => 'Config File: {code}/cfgs/excfg/ex_outdb.php ($_cfgs parts)<br>Tips: Can Copy from Old Version {code}/cfgs/boot/cfg_db.php and Edit.',
	'upi_tips' => 'Tips',
	'upi_dbstrucp' => 'DB-Structure Compare ',
	'upi_initcache' => 'Reset Cache',
	'upi_adtabs' => 'Add/Del Table',
	'upi_efields' => 'Modified Field',
	'upi_adindex' => 'Add/Del Index',
	'upi_impsql' => 'Import SQL',
	'upi_dblink' => 'DB-Tools and Link',
	'upi_dbstru' => 'DB-Structure',
	'upi_dbadm' => 'DB-Admin',
	'upi_login' => 'Admin-Login',
	'upi_impnote' => '(Notice)Import Old-Data',
	'upi_orview' => 'View the Notice in Admin or Online: ', 

	// tester 
	'test_name' => 'English Name',
	'test_end' => 'End Test',

	'start_title' => 'Start Page',
	'bug_tools' => 'Debug/Tools',

	'start_setup' => 'Setup System',
	'start_map' => ' Map',
	'start_login' => 'LoginTools',
	'start_dbadmin' => 'dbAdmin',
	'start_cmsentry' => ' Entry',

	'adcfg_start' => 'Start',
	'adcfg_setup' => 'Setup',
	'adcfg_binfo' => 'Base Info.',
	'adcfg_chkenv' => 'Check Env.',
	'adcfg_reset' => 'Reset Sys.',
	'adcfg_yes' => 'YES',

	'binf_lowbrowser' => 'Your browser is too Lower!!! It CAN NOT Support[frameset].',
	'binf_userenv' => 'User Info.',
	'binf_showerror' => 'Here will find [Warning/Notice]Messages and [-End-]Flag,',
	'binf_sererror' => 'If it cant show theses, Please set the environmental for debug.',
	'binf_usenotes' => 'Tips: Please change the password before use, please delete the file or move to the out of the web directory!',
	'binf_nosupport' => 'NOT Support',
	'binf_frames' => 'Frames',
	'binf_html5base' => 'Basic Characteristic',
	'binf_editp' => 'This is a paragraph that can be edited, please try to edit the text.',
	'binf_details' => 'Can it support summary-details? summary-details HTML tag Tese.',
	'binf_css3r' => 'Fillet edge style',
	'binf_detail' => 'Detail',
	'binf_nosuplocal' => 'Local storage is not supported',
	'binf_suplocal' => 'Support local storage',

	'home_extitle' => 'A general PHP+Msql web site system!',
	'home_exkwd' => 'Lightweight, free, sharing, PHP CMS, IntimateCat, 贴心猫, txmao, imcat',
	'home_exdes' => 'is A general PHP+Msql web site system! Include PC/Mobile Views, pay/map/wechat APIs!',
	'home_botname' => 'IntimateCat',

	'chk_envcheck' => 'Env.Check',
	'chk_envbaisc' => 'Basic',
	'chk_envname' => 'Title',
	'chk_envres' => 'Result',
	'chk_envstat' => 'State',
	'chk_envrem' => 'Remark',

	'chk_risk' => 'Risk', 
	'chk_safe' => 'Safe',
	'chk_set0' => 'Formal Env set 0',
	'chk_demo' => 'Demo',
	'chk_usptest' => 'Supper Test',
	'chk_pick1' => 'Pick one Option',
	'chk_cmemory' => 'Memory(numbers, If get some Error shows NOT Support such big memory)',
	'chk_cfunc' => 'Function(letters, If get [Support] shows CAN use this function)',

	'chk_sysdirs' => 'Sys.Dirs',
	'chk_dirset' => 'Check File:[/root/run/_paths.php]',
	'chk_dblink' => 'DB Link',
	'chk_dbstatus' => 'contact status/result',
	'chk_dbextra' => ' Extend',
	'chk_dbset' => 'Check File:[/code/cfgs/boot/cfg_db.php]',

	'cf_fupload' => 'File Upload',
	'cf_file' => 'File: ',
	'cf_path' => 'Path: ',
	'cf_upbtn' => 'Upload',
	'cf_remote' => 'Remote Fetch',
	'cf_upok' => 'Upload OK',

	'cf_remext' => 'Extra:',
	'cf_show' => 'Show:',
	'cf_shmode' => 'Show Mode',
	'cf_tdef' => 'skip script,style(default)',
	'cf_text' => 'Text(include default)',
	'cf_torg' => 'Org(Org html)',
	'cf_gbk' => 'gbk',
	'cf_gb2312' => 'gb2312',
	'cf_big5' => 'big5',
	'cf_send' => 'Send',

	'scan_root' => 'Root:',
	'scan_set' => 'Setting',
	'scan_tip1' => 'Click and Remove BOM',
	'scan_tip2' => 'Click Sub Dirs, Then use[Ctrl+F]Search[BOM]',
 	'scan_dirs' => 'Sub Dirs:',

	'so_title' => 'Files Search',
	'so_refresh' => 'Refresh',
	'so_ptext' => 'php-text',
	'so_pfunc' => 'php-func',
	'so_pvar' => 'php-var',
	'so_js' => 'js-text',
	'so_html' => 'html-text',
	'so_tpl' => 'tpl-text',
	'so_send' => 'Send',
	'so_tips' => 'set and send!',
	'so_res' => 'Result',
	'so_back' => 'Back',

	'rst_title' => 'Reset System',
	'rst_dbops' => 'DB-Acts',
	'rst_clear' => 'Clear',
	'rst_clrtmpfiles' => 'Clear Temp.Files',
	'rst_clrdblogs' => 'Clear DB Logs',
	'rst_clrtplcache' => 'Clear Tpl Cache',
	'rst_dbcheck' => 'DB Check',
	'rst_dbnopk' => 'NO Primarykeys',
	'rst_dbvar255' => 'Fields:varchar(>255)',
	'rst_dbcindex' => 'Combination Indexs',
	'rst_export' => 'DB Export',
	'rst_expframe' => 'Export Frames',
	'rst_expall' => 'Export All',
	'rst_exback' => 'Export Backup',

	'rst_end' => 'End',
	'rst_res' => 'Dell Result',

	'rst_reset' => 'Reset',
	'rst_rstdata' => 'Data',
	'rst_rstcomp' => 'Compare',
	'rst_rstmini' => 'Mini',
	'rst_rstpub' => 'Publish',
	'rst_rstcache' => 'reset-Cache',
	'rst_rstidpw' => 'ID/PW',
	'rst_setidpw' => 'reset-ID/PW',

	'rst_idpw_set' => 'Now setting cant reset ip/pw, please set:',
	'rst_idpw_id' => 'user id:',
	'rst_idpw_pw' => 'pasword:',
	'rst_idpw_memory' => 'Please remember!',
	'rst_idpw_error' => 'set Error!',
	'rst_idpw_tip1' => 'Tips:use reset before install the system.',
	'rst_idpw_tip2' => 'Error user id/pasword:\nLetters/numbers/underscores, \\nand at the beginning of the letter.\\nuser id:3~15 letters, pasword:6~24 letters\\nand cant use the simple string:\\n',

	// setup/
	'setup_title' => 'Setup',
	'setup_steps' => 'Steps',
	'setup_step' => 'Step',
	'setup_info' => 'Info',
	'setup_state' => 'State',
	'setup_0cfgerror' => '[0]Config Error',
	'setup_mysqlinfo' => 'Mysql Info.',
	'setup_nowdb' => 'Now Database',
	'setup_dbedit' => 'Edit/Create DB',
	'setup_dbrule' => '3-24 letters',
	'setup_creat' => 'Create',
	'setup_dbnoexsists' => 'DB {val} Not Exists',
	'setup_clickadd' => 'Click [Create] or ',
	'setup_dbcfg' => 'Edit[/code/cfgs/boot/cfg_db.php]Config',
	'setup_refresh' => 'Refresh',
	'setup_cantlink' => 'Can NOT contact Mysql DB:',
	'setup_x1' => '[1]Check Env.', //(Before Setup)
	'setup_view' => 'View',
	'setup_my31' => 'At least ONE extend can connected to the Mysql database',
	'setup_start' => '-Start-',
	'setup_x2' => '[2]Setup DB Frames',
	'setup_wnsecs' => 'Wait Wait Wait… About 10 sec(s)! ',
	'setup_wait' => 'Wait...',
	'setup_x3' => '[3]Setup Base Data',
	'setup_x4' => '[4]Setup Demo Data',
	'setup_demo' => 'include:demo,news etc.',
	'setup_x5' => '[5]Set Admin User',
	'setup_end' => 'End',
	'setup_idname' => 'Site Name/Admin User',
	'setup_setpara' => 'Setting-Site Name/Admin User',
	'setup_sitename' => 'Site Name',
	'setup_4_24' => '4~24 letters',
	'setup_admid' => 'Admin User',
	'setup_val_letter' => '{val} letters',
	'setup_admpw' => 'Admin Pass',
	'setup_sendend' => '-Submit and Finish-',
	'setup_doing' => 'Processing...',
	'setup_dosteps' => 'Setup Progress',
	'setup_dores' => 'Setup Result...',

	'fix_' => 'end',

);




/*******************************************************************************
 File : \code\lang\kvphp\user-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// indoc/*
	'idoc_perm' => '没有权限查看',
	'idoc_dep' => '部门',
	'idoc_print' => '打印',
	'idoc_rlog' => '阅读记录',
	'idoc_times' => '次',
	'idoc_noread' => '-暂无阅读记录-',
	'idoc_cnt' => '条',
	'idoc_pub' => '发布',
	'idoc_rem' => '公文评论',
	'idoc_norem' => '-暂无公文评论-',
	'idoc_huser' => '用户首页',
	'idoc_hdoc' => '公文首页',
	'idoc_all' => '所有',
	'idoc_nodata' => '暂无记录!',

	// faqs/* 
	'qa_title' => '问答系统',
	'qa_home' => '首页',
	'qa_pub' => '发布',
	'qa_subj' => '标题',
	'qa_tag' => '标签',
	'qa_so' => '搜索',
	'qa_more' => '更多',
	'qa_detail' => '详情',
	'qa_click' => '点击',
	'qa_times' => '次',
	'qa_rep' => '回复',
	'qa_cnt' => '条',
	'qa_state' => '状态',
	'qa_bugid' => 'bug编号',
	'qa_irep' => '我来回复',
	'qa_relist' => '回复列表',
	'qa_view' => '浏览',
	'qa_type' => '分类',
	'qa_nodata' => '暂无记录',
	'qa_imid' => '聊天号',

	// order/*
	'ord_no3' => '订单号',
	'ord_noend' => '未完成订单',
	'ord_isend' => '已完成订单',
	'ord_no2' => '单号',
	'ord_stat' => '状态',
	'ord_amount' => '金额',
	'ord_pro' => '代表商品',
	'ord_time' => '时间',
	'ord_more' => '等',

	// user/tips.tpl.htm
	'tips_systips' => '系统提示',
	'tips_vpage' => '访问页',
	'tips_nperm' => '需要权限',
	'tips_nowu' => '您当前',
	'tips_can' => '未登录；可以',
	'tips_login' => '点击我登录',
	'tips_or' => '或',
	'tips_reg' => '点击我注册',

	'uop_webind' => '绑定微信',
	'uop_qqbind' => '绑定QQ',
	'uop_scanbind' => '扫描绑定',
	'uop_bindok' => '绑定成功',
	'uop_editok' => '修改完成',
	'uop_goback' => '点击返回',
	'uop_oldpw' => '旧密码',
	'uop_newpw' => '新密码',
	'uop_reppw' => '再一次',
	'uop_rptip' => '再输一次新密码',

	// nav
	'nv4_news' => '新闻动态',
	'nv4_pro' => '商品展销',
	'nv4_spe' => '专题新闻',
	'nv4_res' => '课程资源',
	'nv2_home' => '首页',
	'nv2_news' => '新闻',
	'nv2_pro' => '产品',
	'nv2_spe' => '专题',
	'nv2_res' => '资源',
	'nv2_user' => '会员',
	'nv2_login' => '登陆',
	'nv2_reg' => '注册',

	// public 
	'pub_cindoc' => '公文中心',
	'pub_cuser' => '用户中心',
	'pub_uinfo' => '用户信息',
	'pub_accinfo' => '账户资料',
	'pub_user' => '用户',
	'pub_order' => '订单',
	'pub_idoc' => '公文',
	'pub_faqs' => '问答',
	'pub_einfo' => '修改资料',
	'pub_epass' => '修改密码',
	'pub_guest' => '游客',
	'pub_hi' => '{val}您好！',
	'pub_exit' => '退出',
	// b_lay/c-subs.tpl.htm
	'pub_bind' => '绑定账号',
	'pub_onlord' => '在线订单',
	'pub_hisord' => '历史订单',
	'pub_noend' => '未完成',
	'pub_isend' => '已完成',
	'pub_qorder' => '订单查询',
	'pub_indoc' => '内部公文',
	'pub_mydoc' => '我的公文',
	'pub_depdoc' => '部门公文',
	'pub_alldoc' => '公共公文',
	'pub_admlist' => '管理列表',
	'pub_docpub' => '公文发布',

	// user/user_apply.tpl.htm
	'uap_reapp' => '[返回]重新申请',
	'uap_appok' => '申请成功!',
	'uap_nochk' => '未审核',
	'uap_chkok' => 'Y-已审',
	'uap_hasuid' => '已经有账号？请',
	'uap_login' => '登录会员',
	'uap_check' => '审　核',
	'uap_type' => '类　型',
	'uap_pw2' => '确认密码',
	'uap_corp' => '单位名',
	'uap_tel' => '联系电话',
	'uap_mail' => '邮　箱',
	'uap_pwxeq' => '密码不匹配',
	'uap_name' => '会员名',
	'uap_link' => '联系人',

	// user/uinfo.tpl.htm
	'uif_corder' => '商品订单',
	'uif_caritems' => '购物车商品:{val}个',
	'uif_clickv' => '点击我查看',
	'uif_nolontip' => '未登录用户，只能查看当前会话购物车',
	'uif_unow' => '您当前:',
	'uif_notlogin' => '未登录，可以',
	'uif_clickl' => '点击我登录',
	'uif_or' => '或',
	'uif_clickr' => '点击我注册',
	'uif_sysmsg' => '系统消息',
	'uif_noreadn' => '未读:{val}篇',
	'uif_allmsg' => '所有消息',
	'uif_noendord' => '未完订单:{val}个',
	'uif_allord' => '所有订单',
	'uif_alldoc' => '所有公文',
	'uif_pub' => '发布',
	'uif_runinfo' => '运行信息',
	'uif_sysinfo' => '系统信息',
	'uif_tlinks' => '测试连接:',

	// user/user_login.tpl.htm
	'lon_jump' => '处理跳转',
	'lon_ercnt' => '错误登录次数[{val}]次',
	'lon_lockto' => '锁定时间至',
	'lon_erlock' => '错误登录次数太多！操作锁定中......',
	'lon_change' => '切换用户？请先',
	'lon_logout' => '登出',
	'lon_touto' => '超是时间至',
	'lon_logined' => '已经登录！',
	'lon_reg' => '注册',
	'lon_type' => '我不想打字？',
	'lon_click' => '点一下我',
	'lon_scana' => '用微信扫描登录！',
	'lon_noidpw' => '还没有账号？',
	'lon_followme' => '跟我来',
	'lon_app30' => '30秒就申请一个！',
	'lon_fpass' => '忘记密码',
	'lon_nowechat' => '我不想用微信？',
	'lon_uidpw' => '用账号密码登录！',
	'lon_scanb' => '微信扫描10秒即可注册一个账号！',
	'lon_errsvr' => '服务器返回格式错误。',
	'lon_lonok' => '登录成功！',

	// user/user_getpw.tpl.htm
	'gtp_rtip1' => '您的密码重置为',
	'gtp_rtip2' => '红色字符部分，注意不含空格',
	'gtp_wechat' => '用微信扫描找密码！',
	'gtp_email' => '邮　箱',
	'gtp_back' => '返回登录',
	'gtp_send' => '发送',
	'gtp_idmail' => '用账号邮箱找密码！',
	'gtp_getok' => '找回密码成功！',

	// b_func/tex_base.php
	'tex_base_ulogin' => '会员登录',
	'tex_base_uperm' => '会员权限',
	'tex_base_vlimit' => '访问受限',
	// b_func/xx.php
	'exf_vcode' => '代码查看',
	'exf_alltype' => '所有分类',
	'exf_indocmsg' => '公文提醒通知',
	'exf_null' => '(无)',
	'exf_public' => '公开',
	'exf_readok' => '已读',
	'exf_unread' => '未读',

);




/*******************************************************************************
 File : \code\lang\kvphp\user-en.php 
*******************************************************************************/
<?php

// 语言包:cn

return array(

	// indoc/*
	'idoc_perm' => 'No permission...',
	'idoc_dep' => 'Dept.',
	'idoc_print' => 'Print',
	'idoc_rlog' => 'RedaLog',
	'idoc_times' => '(t)',
	'idoc_noread' => '- No Read Logs -',
	'idoc_cnt' => '(n)',
	'idoc_pub' => 'Publish',
	'idoc_rem' => 'Remark',
	'idoc_norem' => '- No comment Recs -',
	'idoc_huser' => 'UserC',
	'idoc_hdoc' => 'DoucC',
	'idoc_all' => 'All',
	'idoc_nodata' => 'No-Data',

	// faqs/* 
	'qa_title' => 'FAQ System',
	'qa_home' => 'Home',
	'qa_pub' => 'Publish',
	'qa_subj' => 'Title',
	'qa_tag' => 'Tag',
	'qa_so' => 'Search',
	'qa_more' => 'More',
	'qa_detail' => 'Detail',
	'qa_click' => 'Click ',
	'qa_times' => ' Times',
	'qa_rep' => 'Reply ',
	'qa_cnt' => ' Recs',
	'qa_state' => 'State',
	'qa_bugid' => 'BugID',
	'qa_irep' => 'Reply...',
	'qa_relist' => 'Re-Lists',
	'qa_view' => 'View',
	'qa_type' => 'Class',
	'qa_nodata' => 'No-Data',
	'qa_imid' => 'IM-ID',

	// order/*
	'ord_no3' => 'OrderNo',
	'ord_noend' => 'UnFinish',
	'ord_isend' => 'Finished',
	'ord_no2' => 'OrdNo',
	'ord_stat' => 'State',
	'ord_amount' => 'Amount',
	'ord_pro' => 'Product(s)',
	'ord_time' => 'Time',
	'ord_more' => '...',

	// user/tips.tpl.htm
	'tips_systips' => 'System Tips',
	'tips_vpage' => 'View Page',
	'tips_nperm' => 'Need Perm',
	'tips_nowu' => 'Now you',
	'tips_can' => ' Not login, you can ',
	'tips_login' => 'Click Here Login',
	'tips_or' => ' Or ',
	'tips_reg' => 'Register',

	'uop_webind' => 'Bind Wechat',
	'uop_qqbind' => 'Bind QQ',
	'uop_scanbind' => 'Scan Bind',
	'uop_bindok' => 'Bind OK',
	'uop_editok' => 'Edit OK',
	'uop_goback' => 'Click Goback',
	'uop_oldpw' => 'Old Password',
	'uop_newpw' => 'New Password',
	'uop_reppw' => 'Input again',
	'uop_rptip' => 'Input password again',

	// nav
	'nv4_news' => 'News',
	'nv4_pro' => 'Product',
	'nv4_spe' => 'Topic',
	'nv4_res' => 'Resources',
	'nv2_home' => 'Home',
	'nv2_news' => 'News',
	'nv2_pro' => 'Product',
	'nv2_spe' => 'Topic',
	'nv2_res' => 'Resources',
	'nv2_user' => 'User',
	'nv2_login' => 'Login',
	'nv2_reg' => 'Register',

	// public 
	'pub_cindoc' => 'Inner Doucment',
	'pub_cuser' => 'User Center',
	'pub_uinfo' => 'UserInfo',
	'pub_accinfo' => 'Account Info',
	'pub_user' => 'User',
	'pub_order' => 'Order',
	'pub_idoc' => 'InDoc',
	'pub_faqs' => 'FAQs',
	'pub_einfo' => 'Edit UserInfo',
	'pub_epass' => 'Edit Password',
	'pub_guest' => 'Guest',
	'pub_hi' => 'Hi, {val}!',
	'pub_exit' => 'Exit',
	// b_lay/c-subs.tpl.htm
	'pub_bind' => 'Bind User',
	'pub_onlord' => 'Online Order',
	'pub_hisord' => 'His.Order',
	'pub_noend' => 'Unfinished',
	'pub_isend' => 'Completed',
	'pub_qorder' => 'Order Inquiry',
	'pub_indoc' => 'Inner Docu',
	'pub_mydoc' => 'My-Douc',
	'pub_depdoc' => 'Dep-Douc',
	'pub_alldoc' => 'Pub-Douc',
	'pub_admlist' => 'Management',
	'pub_docpub' => 'Publish',

	// user/user_apply.tpl.htm
	'uap_reapp' => '[Back]Re-apply',
	'uap_appok' => 'Apply successful!',
	'uap_nochk' => 'Nnceck',
	'uap_chkok' => 'Y-Checked',
	'uap_hasuid' => 'I have an account? Please ',
	'uap_login' => 'Login',
	'uap_check' => 'Checked',
	'uap_type' => 'Type',
	'uap_pw2' => 'Confirm',
	'uap_corp' => 'Corp/Org',
	'uap_tel' => 'Tel',
	'uap_mail' => 'E-mail',
	'uap_pwxeq' => 'Passwords do not match',
	'uap_name' => 'Name',
	'uap_link' => 'Contacts',

	// user/uinfo.tpl.htm
	'uif_corder' => 'Cargo Order',
	'uif_caritems' => '{val} Items in shop car',
	'uif_clickv' => 'Click View',
	'uif_nolontip' => 'Your are NOT login',
	'uif_unow' => 'Now You',
	'uif_notlogin' => ' NOT login, you can ',
	'uif_clickl' => 'Click Login',
	'uif_or' => ' or ',
	'uif_clickr' => 'Click Reg',
	'uif_sysmsg' => 'Sys-Massage',
	'uif_noreadn' => 'Noread:{val}',
	'uif_allmsg' => 'All-Massage',
	'uif_noendord' => 'Nofinish:{val}',
	'uif_allord' => 'All-Oder',
	'uif_alldoc' => 'All-Docu',
	'uif_pub' => 'Publish',
	'uif_runinfo' => 'Run-Info',
	'uif_sysinfo' => 'Sys-Info',
	'uif_tlinks' => 'Test-Links',

	// user/user_login.tpl.htm
	'lon_jump' => 'Jump to ',
	'lon_ercnt' => 'Error times:[{val}]',
	'lon_lockto' => 'Lock to ',
	'lon_erlock' => 'Locked because too many error time......',
	'lon_change' => ' Change user? Please ',
	'lon_logout' => 'Logout',
	'lon_touto' => 'Timeout is ',
	'lon_logined' => 'Logined!',
	'lon_reg' => 'Register',
	'lon_type' => 'I don`t want to type?',
	'lon_click' => 'Click Here',
	'lon_scana' => 'Use wechat scan and login!',
	'lon_noidpw' => 'I don`t have an account yet?',
	'lon_followme' => 'Folow me',
	'lon_app30' => 'Apply an account in 30 sec! ',
	'lon_fpass' => 'Password',
	'lon_nowechat' => 'I don`t want to use WeChat?',
	'lon_uidpw' => 'Use IP/PW Login!',
	'lon_scanb' => 'Use wechat scan and get a user in 10 sec!',
	'lon_errsvr' => 'Server return error.',
	'lon_lonok' => 'Login OK!',

	// user/user_getpw.tpl.htm
	'gtp_rtip1' => 'Your new password is ',
	'gtp_rtip2' => 'Red character part, NOT include space',
	'gtp_wechat' => 'Use wechat scan get password!',
	'gtp_email' => 'E-mail',
	'gtp_back' => 'Login',
	'gtp_send' => 'Send',
	'gtp_idmail' => 'Use userid/mail get password!',
	'gtp_getok' => 'Get password OK!',

	// b_func/tex_base.php
	'tex_base_ulogin' => 'User Login',
	'tex_base_uperm' => 'User Perm',
	'tex_base_vlimit' => 'Access NOT permissions',
	// b_func/xx.php
	'exf_vcode' => ' View-Code',
	'exf_alltype' => 'All-Class',
	'exf_indocmsg' => 'Inner Doc notification',
	'exf_null' => '(Null)',
	'exf_public' => 'Public',
	'exf_readok' => 'Read',
	'exf_unread' => 'Unread',

);




/*******************************************************************************
 File : \code\lang\ptinc\admin-cn.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?> 

中<?php echo $uarr['hname'] ?>

<?php }elseif($part=='loginread'){ ?> 

<li>推荐浏览器: IE9+, Chrome, Firefox ；</li>
<li>第一次使用，请查看 《<a href='<?php echo vopUrl::fout('help') ?>' target="_blank">管理帮助文件</a>》>>>；</li>
<li>帐号密码区分大小写;帐号>=2位,密码>=5位；</li>
<li>认证码不分大小写,如错误,请刷新登陆；</li>
<li>技术支持: Peace(txmao.txjia.com).</li>

<?php }elseif($part=='xxx'){ ?>  

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\admin-en.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?>

En<?php echo $uarr['hname'] ?>

<?php }elseif($part=='loginread'){ ?>

<li>Recommended browser: IE9+, Chrome, Firefox </li>
<li>First time, please see the [<a href='<?php echo vopUrl::fout('help') ?>' target="_blank">help-page</a>] >>> </li>
<li>Account number >=2 bit, Password >=5 bit </li>
<li>authentication code , such as error, please refresh </li>
<li>Technical support: Peace(txmao.txjia.com).</li>

<?php }elseif($part=='xxx'){ ?>  

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\aflow-cn.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?> 

中-说明<?php echo $uarr['hname'] ?>
多语言实现，用这类文件来存放多语言；
不使用多语言，可把这些代码直接写到脚本内。

<?php }elseif($part=='uc_indoc_list'){ ?> 

<th>选</th><th>标题</th><th>栏目</th><th>显示</th>
<th>添加时间</th><th>添加账号</th><th>修改时间</th>
<th>修改</th></tr>

<?php }elseif($part=='docs_list'){ ?> 

<th>选</th><th>标题</th><th>栏目</th><th>显示</th>
<th>添加时间</th><th>添加账号</th><th>修改时间</th>
<th>修改</th></tr>

<?php }elseif($part=='advs_list'){ ?> 

<th>选</th><th>标题</th><th>栏目</th><th>显示</th>
<th>Url</th><th><?php echo ($uarr==4 ? '用户' : '点击'); ?></th>
<th>添加</th><th>修改</th></tr>

<?php }elseif($part=='coms_list'){ ?> 

<th>选</th><th>标题</th><th>显示</th><th>会员名称</th>
<th>电话</th><th>E-Mail</th><th>聊天号</th>
<th>添加</th><th>添加IP</th>
<th>修改</th></tr>

<?php }elseif($part=='users_list'){ ?> 

<th>选</th><th>账号</th><th>等级</th>
<th>名称</th><th>电话</th><th>E-Mail</th><th>聊天号</th>
<th>注册</th><th>注册IP</th>
<th>修改</th><th>复制</th></tr>

<?php }elseif($part=='cargo_list'){ ?> 

<th>选</th><th>标题</th><th>栏目</th><th>显示</th>
<th>添加时间</th><th>修改时间</th>
<th>修改</th><th>复制</th></tr>

<?php }elseif($part=='demo_list'){ ?> 

<th>选</th><th>标题/[评论][籍贯][流浪][工作][行业]</th><th>栏目</th><th>显示</th>
<th>添加时间/账号</th><th>修改时间/IP</th><th>电话/结束时间</th>
<th>修改</th></tr>

<?php }elseif($part=='indoc_list'){ ?> 

<th>选</th><th>标题</th><th>栏目</th><th>部门</th><th>重要</th><th>显示</th>
<th>添加时间</th><th>添加账号</th><th>修改时间</th>
<th>修改</th></tr>

<?php }elseif($part=='inread_list'){ ?> 

<th>选</th><th>公文标题</th><th>阅读者</th><th>帐号</th><th>浏览次数</th>
<th>首次阅读</th><th>首次IP</th>
<th>末次阅读</th><th>末次IP</th>
<th>修改</th></tr>

<?php }elseif($part=='inrem_list'){ ?> 

<th>选</th><th>公文标题</th><th>评论标题</th><th>帐号</th>
<th>首次阅读</th><th>首次IP</th>
<th>修改</th></tr>

<?php }elseif($part=='qarep_list'){ ?> 

<th>选</th><th>问答标题</th><th>回复标题</th><th>帐号</th>
<th>昵称</th><th>聊天号</th>
<th>添加</th><th>IP</th>
<th>修改</th></tr>

<?php }elseif($part=='qatag_list'){ ?> 

<th>选</th><th>标签</th><th>热度</th>
<th>添加</th><th>IP</th>
<th>更新</th><th>IP</th>
<th>修改</th></tr>

<?php }elseif($part=='cocar'){ ?> 

<th>选</th><th>货品ID</th><th>订单ID</th>
<th>数量</th><th>单价</th>
echo "<th>会员名称</th>
<th>添加时间</th><th>修改</th></tr>

<?php }elseif($part=='corder'){ ?> 

<th>选</th><th>订单号</th><th>状态</th><th>总额</th><th>数量</th><th>货品额</th>
<th>跟踪号</th>
<th>会员名称</th><th>电话</th>
<th>添加</th><th>修改</th></tr>

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\aflow-en.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?>

En-Notice<?php echo $uarr['hname'] ?>
Multi language implementation, using this type of file to store multiple languages;
Without the use of multi language, these codes can be written directly into the script.

<?php }elseif($part=='uc_indoc_list'){ ?> 

<th>Sel.</th><th>Title</th><th>Catalog</th><th>Show</th>
<th>Add-Time</th><th>Add-User</th><th>Edit-Time</th>
<th>Edit</th></tr>

<?php }elseif($part=='docs_list'){ ?>

<th>Sel.</th><th>Title</th><th>Catalog</th><th>Show</th>
<th>Add-Time</th><th>Add-User</th><th>Edit-Time</th>
<th>Edit</th></tr>

<?php }elseif($part=='advs_list'){ ?> 

<th>Sel.</th><th>Title</th><th>Catalog</th><th>Show</th>
<th>Url</th><th><?php echo ($uarr==4 ? 'uName' : 'Click'); ?></th>
<th>Add</th><th>Edit</th></tr>

<?php }elseif($part=='coms_list'){ ?> 

<th>Sel.</th><th>Title</th><th>Show</th><th>uName</th>
<th>Tel</th><th>E-Mail</th><th>imNo</th>
<th>Add</th><th>Add-IP</th>
<th>Edit</th></tr>

<?php }elseif($part=='users_list'){ ?> 

<th>Sel.</th><th>UserID</th><th>Grade</th>
<th>Name</th><th>Tel</th><th>E-Mail</th><th>imNo</th>
<th>Reg</th><th>Reg-IP</th>
<th>Edit</th></tr>

<?php }elseif($part=='cargo_list'){ ?> 

<th>Sel.</th><th>Title</th><th>Catalog</th><th>Show</th>
<th>Add-Time</th><th>Edit-Time</th>
<th>Edit</th><th>Copy</th></tr>

<?php }elseif($part=='demo_list'){ ?> 

<th>Sel.</th><th>Title/[Rem.][From][Wander][Work][Field]</th><th>Catalog</th><th>Show</th>
<th>Add-Time/uName</th><th>Edit-Time/IP</th><th>Tel/End-Time</th>
<th>Edit</th></tr>

<?php }elseif($part=='indoc_list'){ ?> 

<th>Sel.</th><th>Title</th><th>Catalog</th><th>Dept.</th><th>Hot</th><th>Show</th>
<th>Add-Time</th><th>Add-User</th><th>Edit-Time</th>
<th>Edit</th></tr>

<?php }elseif($part=='inread_list'){ ?> 

<th>Sel.</th><th>Doc.Title</th><th>Name</th><th>uName</th><th>ReadCnt</th>
<th>First-Read</th><th>First-IP</th>
<th>Last-Read</th><th>Last-IP</th>
<th>Edit</th></tr>

<?php }elseif($part=='inrem_list'){ ?> 

<th>Sel.</th><th>Doc.Title</th><th>Rem.Title</th><th>uName</th>
<th>First-Read</th><th>First-IP</th>
<th>Edit</th></tr>

<?php }elseif($part=='qarep_list'){ ?> 

<th>Sel.</th><th>QA-Title</th><th>Rep.Title</th><th>uName</th>
<th>Nick</th><th>imNo</th>
<th>Add</th><th>IP</th>
<th>Edit</th></tr>

<?php }elseif($part=='qatag_list'){ ?> 

<th>Sel.</th><th>Tag</th><th>Hot</th>
<th>Add</th><th>IP</th>
<th>Upd</th><th>IP</th>
<th>Edit</th></tr>

<?php }elseif($part=='cocar'){ ?> 

<th>Sel.</th><th>CargoID</th><th>OrderID</th>
<th>Count</th><th>uPrice</th>
echo "<th>UserName</th>
<th>Add-Time</th><th>Edit</th></tr>

<?php }elseif($part=='corder'){ ?> 

<th>Sel.</th><th>OrderNo</th><th>State</th><th>Fee-All</th><th>Count</th><th>Fee-Total</th>
<th>TraceNo</th>
<th>UserName</th><th>Tel</th>
<th>Add</th><th>Edit</th></tr>

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\front-cn.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?> 

中

<?php }elseif($part=='homevn'){ ?>

● 管理中心
 --- 您的网站您做主！<br> 
● 中文版 
 --- 传统经典PC主要展示版本<br> 
● 演示版 
 --- 为您指点迷津;二次开发DIY!<br> 
● Guides 
 --- Guides and Manual, (development)DIY<br> 
● 手机版 
 --- 精简移动端展示模块<br> 
● 会员中心
 --- 用户:订单/公文/问答

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\front-en.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?>

En

<?php }elseif($part=='homevn'){ ?>

● Admin
 --- Your website just for your!<br> 
● 中文版 
 --- 传统经典PC主要展示版本<br> 
● 演示版 
 --- 为您指点迷津;二次开发DIY!<br> 
● Guides 
 --- Guides and Manual, (development)DIY<br> 
● Mobile
 --- View in mobile phone<br> 
● User
 --- User:Order/Docs/Faqs

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\uless-cn.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?> 

中: 少用的大段文本:<?php echo $uarr['hname'] ?>

<?php }elseif($part=='fldedit_note'){ 

$note  = "格式1:选项值=选项标题,一行一个;\n";
$note .= "格式2:模型id(栏目/类别);\n";
$note .= "格式3:pid:\"cnhn\",w:640;\n";
$note .= "格式4:bext_paras.logmode_cn, 取bext_paras资料;\n";
$note .= "[选择数组]配置规范:\n";
$note .= "*. [下拉选择][多选框][单选按钮]格式1或2或3:\n";
$note .= "*. [开窗单选][开窗多选]格式3:";
$reinc[$part] = $note;

}elseif($part=='userm_empw'){ ?>   

$data = "{$uarr['uname']} 您好！<br><br>\n\n";
$data .= "欢迎使用 {$uarr['sys_name']} 邮件找回密码功能！<br>\n";
$data .= "请点击（或复制）访问如下链接：<br>\n";
$data .= "$uarr['url']<br>\n";
$data .= "根据提示，找回密码。<br>\n<br>\n";
$data .= "{$uarr['sys_name']} ".date('Y-m-d H:i:s')."<br>\n";
$reinc[$part] = $note;

<?php }elseif($part=='plus_upbat'){ ?>   

说明：<br>
***1. 本程序受启发于<a href="http://www.babytree.com/">宝宝树</a>照片批量上传而制作，最先为asp版，后面php两次大改版而成；<br>
***2. 请先设置类别，再浏览图片；可用下方的(+n)按纽增加n个图片项目；一次最多可设置96个图片批量上传；<br>
***3. 本程序为增值程序，免费使用；请不要苛求它的功能；如不能满足您的需要，请用普通方式添加资料。<br>
***4. 建议把要上传的文件，放在同一文件夹中，用标题作为图片名(默认情况下,本系统把文件名作为信息的标题)；其文件名（除后缀外），
      不能用空格引号点等特殊字符； 建议全用英文半角的字母，数字或下划线；除图片名可用中文外，目录建议也不要用中文。

<?php }elseif($part=='plus_fview'){ ?>   

注意：<br>
1. 大文件请用FTP上传，可参考[管理帮助] 或 [<a href="#readme.txt" target="_blank">文件目录规划</a>] 相关文件；<br>
2. 可用[预览&gt;&gt;复制链接地址]得到相关附件地址；<br>
3. [临时] 新上传文档,都放在这里,添加后会自动移动到相关文件夹； <br>
4. [当前] 编辑资料时显示此项,此文件夹下的附件关联当前资料；<br>
5. [上传] 可批量上传到文件；<br>
6. [插入] 可插入：iframe(内框架),map(地图),swf(Flash媒体),audio(音频媒体),video(视频媒体)；

<?php }elseif($part=='wex_user'){ ?>  

<tr><th>昵称</th><th>OpenId</th><th>分组ID</th><th>城市</th><th>头像</th><th>性别</th><th>关注时间</th><th>发信息</th></tr>

<?php }elseif($part=='--end--'){ ?>  

-end-

<?php } ?>


/*******************************************************************************
 File : \code\lang\ptinc\uless-en.php 
*******************************************************************************/
<?php if($part=='_test1_'){ ?>

En: Less use of the large section of the text:<?php echo $uarr['hname'] ?>

<?php }elseif($part=='fldedit_note'){ 

$note  = "Fmt1:val=title,each item a line;\n";
$note .= "Fmt2:ModId(Catalog/Types);\n";
$note .= "Fmt3:pid:\"cnhn\",w:640;\n";
$note .= "Fmt4:bext_paras.logmode_cn, get cfgs from bext_paras;\n";
$note .= "[options array]config as below:\n";
$note .= "*. [Select][Checkbox][Radio]Fmt1/2/3:\n";
$note .= "*. [WinPick][WinPick-Multi]Fmt3:";
$reinc[$part] = $note;

}elseif($part=='userm_empw'){ ?>   

$data = "Hi,{$uarr['uname']}! <br><br>\n\n";
$data .= "Welcome use get-password by Email!<br>\n"; //  {$uarr['sys_name']}
$data .= "Please click(or copy) the url, and view the page:<br>\n";
$data .= "$uarr['url']<br>\n";
$data .= "Get passowrd by these tips.<br>\n<br>\n";
$data .= "{$uarr['sys_name']} ".date('Y-m-d H:i:s')."<br>\n";
$reinc[$part] = $note;

<?php }elseif($part=='plus_upbat'){ ?> 
	
Notice: <br>
***1. This idea from <a href="http://www.babytree.com/">Babytree</a>, 
      First is asp version, then the two php versions; <br>
***2. Please set the categories, and then browse pictures; use below (+n) button to increase image project; 
      <br>it can set 96 pictures once a time; <br>
***3. This program is a value-added process, free of free; please do not demand it's function; 
      <br>if you can not meet your needs, please add the information in the ordinary; <br>
***4. Recommended put the file in same folder, use the title of the picture as the file name;
      <br>Can not use spaces, such as quotation marks, and other special characters in the file name;
      <br>The picture name can be used in Chinese, the directory do NOT use chinese.

<?php }elseif($part=='plus_fview'){ ?>   

Notice: <br>
1. BIG files please upload by FTP, Can view [Admin-HELP] or [<a href="#readme.txt" target="_blank">File/Directory Structure</a>]; <br>
2. Use [View &gt;&gt; Copy-Link] get the url; <br>
3. [Temp] The new upload files, are put here, they will be moved to the relevant folders after save; <br>
4. [Now] Show this item while EDIT infos, these files are belong the info; <br>
5. [Upload] Batch/Single upload file(s); <br>
6. [Insert] will insert: iframe, map, swf, audio, video;

<?php }elseif($part=='wex_user'){ ?>  

<tr><th>Nick</th><th>OpenId</th><th>Group-ID</th><th>City</th><th>Pic</th><th>Sex</th><th>Add-Time</th><th>Send-Message</th></tr>

<?php }elseif($part=='--end--'){ ?>  

-end-

<?php } ?>


/*******************************************************************************
 File : \code\lang\ucfgs\cfgbase-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

$cfgs['wx_mop'] = array(
	'save' => '保存菜单配置',
	'create' => '创建微信菜单',
	'get' => '获取微信菜单',
	'del' => '删除微信菜单',
);

$cfgs['wx_nav'] = array(
	'menu'=>'菜单',
	'user'=>'关注者',
	'msg'=>'消息',
	'kw'=>'关键字',
	'debug'=>'调试',
	'wres'=>'微素材',
	'wweb'=>'微网站',
	'wshop'=>'微店铺',
	'wact'=>'微活动',
);

$cfgs['wx_nmsg'] = array(
	'get'=>'接收消息',
	'send'=>'发送记录',
	'ms'=>'群发信息',
	'ct'=>'信息内容',
	'st'=>'回复状态',
	'nrep'=>'现在回复',
	'rep'=>'回复信息',
	'srep'=>'客服回复',
);

$cfgs['wx_tmsg'] = array(
	'text'=>'文本',
	'image'=>'图片',
	'news'=>'图文',
	'Auto'=>'自动',
	'Kefu'=>'客服',
);

$cfgs['wx_type'] = array(
	'test'=>'测试号',
	'chking'=>'未认证',
	'dingyue'=>'订阅号',
	'fuwu'=>'服务号'
);

$cfgs['seo_type'] = array(
	'seo_sitemap'=>'Sitemap',
	'seo_pset'=>'Push设置',
	'seo_plog'=>'Push记录'
);

$cfgs['crawl_fset'] = array(
	'note'=>'清除备注',
	'html'=>'清除Html',
	'blank'=>'清除空白',
	'strtotime'=>'转化为时间戳',
);

$cfgs['corn_unit'] = array(
	'm'=>'月', 
	'w'=>'周', 
	'd'=>'天', 
	'h'=>'时',
);

$cfgs['ord_com2'] = array(
	'atime' => '操作时间(降)',
	'atime-a' => '操作时间(升)',
);

$cfgs['ord_pay'] = array(
	'amount' => '金额(降)',
	'amount-a' => '金额(升)',
	'atime' => '操作时间(降)',
	'atime-a' => '操作时间(升)',
);

$cfgs['jifen_ops'] = array(
	'jifen_grade'=>'积分等级',
	'jifen_model'=>'积分设置',
	'jifen_logs'=>'积分记录',
);

$cfgs['ord_jifen'] = array(
	'jifen' => '积分数量(降)',
	'jifen-a' => '积分数量(升)',
	'atime' => '操作时间(降)',
	'atime-a' => '操作时间(升)',
);

$cfgs['ord_smslog'] = array(
	'amount' => '短信数量(降)',
	'amount-a' => '短信数量(升)',
	'atime' => '操作时间(降)',
	'atime-a' => '操作时间(升)',
);

$cfgs['user_ops'] = array(
	'login'=>'会员登录',
	'apply'=>'会员注册',
	'getpw'=>'获取密码',
);

$cfgs['indoc_types'] = array(
	'my' => '我的公文',
    'dep' => '部门公文',
    'pub' => '公共公文',
);

$cfgs['indoc_notice'] = array(
	'title' => '您好！您收到一条公文消息：',
	'xsub' => '公文主题：',
	'xpub' => '发布时间：',
	'xuser' => '发布人：',
	'xclick' => '请点击查看！',
);

$cfgs['xxx'] = array(
	'temp' => '临时',
);

$cfgs['admupd'] = array(
	'cache'=>'系统缓存',
	'types'=>'类别数据',
	'menux'=>'广告菜单',
	'data'=>'冗余缓存',
);

$cfgs['admord4a'] = array(
	'used' => '执行耗时(降)',
	'used-a' => '执行耗时(升)',
	'atime' => '操作时间(降)',
	'atime-a' => '操作时间(升)'
);

$cfgs['ucfaqn4'] = array(
	'new' => '最新', 
	'tip' => '精华', 
	'hot' => '热门', 
	'tag' => '标签', 
);

return $cfgs;




/*******************************************************************************
 File : \code\lang\ucfgs\cfgbase-en.php 
*******************************************************************************/
<?php

// 语言包:cn

$cfgs['wx_mop'] = array(
	'save' => 'Save-Menu',
	'create' => 'Create-Menu',
	'get' => 'Get-Menu',
	'del' => 'Del-Menu',
);

$cfgs['wx_nav'] = array(
	'menu'=>'Menu',
	'user'=>'User',
	'msg'=>'Message',
	'kw'=>'Keyword',
	'debug'=>'Debug',
	'wres'=>'We-Material',
	'wweb'=>'We-Web',
	'wshop'=>'We-Shop',
	'wact'=>'We-Act',
);

$cfgs['wx_nmsg'] = array(
	'get'=>'Get-Msg',
	'send'=>'Send-Msg',
	'ms'=>'Mass-Send',
	'ct'=>'Content',
	'st'=>'Reply-State',
	'nrep'=>'Now-Reply',
	'rep'=>'Reply-Msg',
	'srep'=>'Ser-Reply',
);

$cfgs['wx_tmsg'] = array(
	'text'=>'Text',
	'image'=>'Image',
	'news'=>'News',
	'Auto'=>'Auto',
	'Kefu'=>'Service',
);

$cfgs['wx_type'] = array(
	'test'=>'Tester',
	'chking'=>'Unchecked',
	'dingyue'=>'Subscription',
	'fuwu'=>'Service'
);

$cfgs['seo_type'] = array(
	'seo_sitemap'=>'Sitemap',
	'seo_pset'=>'Push Set',
	'seo_plog'=>'Push Logs'
);

$cfgs['crawl_fset'] = array(
	'note'=>'Clear Notes',
	'html'=>'Clear Html',
	'blank'=>'Clear blanks',
	'strtotime'=>'Conver timestamp',
);

$cfgs['corn_unit'] = array(
	'm'=>'Month', 
	'w'=>'Week', 
	'd'=>'Day', 
	'h'=>'Hour',
);

$cfgs['ord_com2'] = array(
	'atime' => 'OP-Time(D)',
	'atime-a' => 'OP-Time(A)',
);

$cfgs['ord_pay'] = array(
	'amount' => 'Amount(D)',
	'amount-a' => 'Amount(A)',
	'atime' => 'OP-Time(D)',
	'atime-a' => 'OP-Time(A)',
);

$cfgs['jifen_ops'] = array(
	'jifen_grade'=>'Grade',
	'jifen_model'=>'Setting',
	'jifen_logs'=>'Logs',
);

$cfgs['ord_jifen'] = array(
	'jifen' => 'Piont-Count(D)',
	'jifen-a' => 'Piont-Count(A)',
	'atime' => 'OP-Time(D)',
	'atime-a' => 'OP-Time(A)',
);

$cfgs['ord_smslog'] = array(
	'amount' => 'SMS-Count(D)',
	'amount-a' => 'SMS-Count(A)',
	'atime' => 'OP-Time(D)',
	'atime-a' => 'OP-Time(A)',
);

$cfgs['user_ops'] = array(
	'login'=>'User Login',
	'apply'=>'User Reg.',
	'getpw'=>'Get Password',
);

$cfgs['indoc_types'] = array(
	'my' => 'My-Douc',
    'dep' => 'Dep-Douc',
    'pub' => 'Pub-Douc',
);

$cfgs['indoc_notice'] = array(
	'title' => 'Hi, Your got an Inner Docu Massage: ',
	'xsub' => 'Title: ',
	'xpub' => 'Publish: ',
	'xuser' => 'User: ',
	'xclick' => ' Click Here!',
);

$cfgs['xxx'] = array(
	'temp' => 'Temp.',
);

$cfgs['admupd'] = array(
	'cache'=>'Sys.Cache',
	'types'=>'Type.Data',
	'menux'=>'Advs/Menus',
	'data'=>'Extra.Cache',
);

$cfgs['admord4a'] = array(
	'used' => 'Run-Time(D)',
	'used-a' => 'Run-Time(A)',
	'atime' => 'OP-Time(D)',
	'atime-a' => 'OP-Time(A)'
);

$cfgs['ucfaqn4'] = array(
	'new' => 'Latest', 
	'tip' => 'Essence', 
	'hot' => 'Hots', 
	'tag' => 'Tags', 
);

return $cfgs;




/*******************************************************************************
 File : \code\lang\ucfgs\cfglibs-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

$cfgs['grset_types'] = array(
	'pmadm'=>'菜单',
	'pmusr'=>'会员',
	'pfile'=>'脚本',
	'pextra'=>'附加',
);

// 字段类型
$cfgs['fcfg_type'] = array(
	'^group^data'  => '-数据字段-',
	'input'  => '输入框',
	'select' => '下拉选择',
	'cbox'   => '多选框',
	'radio'  => '单选按钮',
	'text'  => '文本框',
	'file'  => '文件域',
	'passwd' => '密码域',
	'hidden' => '隐藏域',
	'^group^control'  => '-控制字段-',
	'parts'  => '表单分段',
	'repeat' => '重复检查',
);	
// 字段插件
$cfgs['fcfg_plug'] = array(
	'editor' => 'Html编辑器',
	'pics'   => 'Pics文件组', //图集等
	'pick'   => 'Pick资料选取',
	'winpop' => '弹窗选择',
	'datetm' => '日期选择',
	'color'  => '颜色设置',
	'map'	=> '地图标点',
);		
// 数据类型
$cfgs['fcfg_dbtype'] = array(
	'varchar' => 'varchar.字符',
	'int'	 => 'int.整型',
	'float'   => 'float.浮点',
	'text'	=> 'text.64K长文本',
	'mediumtext' => 'mtext.16M长文本',
	'nodb'	=> 'nodb.不保存',	
);		
// 字段认证
$cfgs['fcfg_vreg'] = array(
	'fix:tel'   => '电话号码',
	'fix:email' => '邮件地址',
	'fix:uri'   => 'Url地址',
	'fix:file'  => '文件',
	'fix:image' => '图片',
	'key:'	  => 'Key(变量形式)',
	'fix:xid'   => 'Key(9999-md)',
	'tit:'	  => '标题',
	'n+i'	   => '正整数',
	'n-i'	   => '整数(含负)',
	'n+d'	   => '小数',
	'n-d'	   => '小数(含负)',
	'str:'	  => '普通文本',
	'vimg:'	 => '认证码',		
);

$cfgs['fedit_numtype'] = array(
	'n+i'=>'整数', 
	'n-i'=>'整数(含负)',
	'n+d'=>'小数', 
	'n-d'=>'小数(含负)',
);
$cfgs['fedit_vline'] = array(
	'1'=>'独立行显示',
	'0'=>'同行显示',
);
$cfgs['fedit_vltitle'] = array(
	'0'=>'隐藏提示',
	'1'=>'显示提示',
);

$cfgs['model_deep'] = array(
	'docs'=>'栏目级数',
	'types'=>'类别级数',
	'menus'=>'菜单深度',
);

$cfgs['advs_type'] = array(
	1=>'文字连接',
	2=>'图片连接',
	3=>'信息区块',
	4=>'网址收藏',
);

$cfgs['exdbase_mode'] = array(
	'modeVal'=>'Html标签模式',
	'modePos'=>'Html定点模式',
	'modeArr'=>'tml标签数组模式',
	'modePreg'=>'正则取数组模式',
	'modeAttr'=>'提取Html属性模式',
);
$cfgs['exdbase_ext'] = array(
	'url:fatch'=>'提取远程Url数据',
	'save:image'=>'提取远程图片到本地',
);

$cfgs['usrbase'] = array(
	'Null' => '登录失败，账号密码为空！',
	'Forbid' => '登录失败，锁定状态禁止登录！',
	'noChecked' => '登录失败，账号密码错误或未审核！',
	'isLogin' => '已经登录，不能重复登录！',
	'OK' => '登录成功！',
);

$cfgs['upload'] = array(
	"SUCCESS", //上传成功标记
	"文件大小超出 upload_max_filesize 限制",
	"文件大小超出 MAX_FILE_SIZE 限制",
	"文件未被完整上传",
	"没有文件被上传",
	"上传文件为空",
	"ERROR_TMP_FILE" => "临时文件错误",
	"ERROR_TMP_FILE_NOT_FOUND" => "找不到临时文件",
	"ERROR_SIZE_EXCEED" => "文件大小超出网站限制",
	"ERROR_TYPE_NOT_ALLOWED" => "文件类型不允许",
	"ERROR_CREATE_DIR" => "目录创建失败",
	"ERROR_DIR_NOT_WRITEABLE" => "目录没有写权限",
	"ERROR_FILE_MOVE" => "文件保存时出错",
	"ERROR_FILE_NOT_FOUND" => "找不到上传文件",
	"ERROR_WRITE_CONTENT" => "写入文件内容错误",
	"ERROR_UNKNOWN" => "未知错误",
	"ERROR_DEAD_LINK" => "链接不可用",
	"ERROR_HTTP_LINK" => "链接不是http链接",
	"ERROR_HTTP_CONTENTTYPE" => "链接contentType不正确"
);

$cfgs['dbext'] = array(
	'advs' => '广告',
	'coms' => '互动',
	'docs' => '主',
	'types' => '分类',
	'users' => '会员',
);

$cfgs['dopmedia'] = array(
	'iframe' => 'iframe(内框架)',
	'map' => 'map(地图)',
	'swf' => 'swf(Flash媒体文件)',
	'audio'	=> 'audio(音频媒体文件)',
	'ckvdo'	=> 'video(视频媒体文件)',
);
//'flv'	=> 'flv(Flash媒体文件)', // (合并到ckvdo)
//'bgsnd'  => 'bgsnd(背景音乐)', // 需要的化，专门添加字段

return $cfgs;




/*******************************************************************************
 File : \code\lang\ucfgs\cfglibs-en.php 
*******************************************************************************/
<?php

// 语言包:cn

$cfgs['grset_types'] = array(
	'pmadm'=>'Menu',
	'pmusr'=>'Member',
	'pfile'=>'Script',
	'pextra'=>'Extra',
);

// 字段类型
$cfgs['fcfg_type'] = array(
	'^group^data'  => '-Data Fields-',
	'input'  => 'Input',
	'select' => 'Select',
	'cbox'   => 'Checkbox',
	'radio'  => 'Radio',
	'text'  => 'Text',
	'file'  => 'File',
	'passwd' => 'Password',
	'hidden' => 'Hidden',
	'^group^control'  => '-Contral Fields-',
	'parts'  => 'Cnrl-Parts',
	'repeat' => 'Check Repeat',
);	
// 字段插件
$cfgs['fcfg_plug'] = array(
	'editor' => 'Html-Editor',
	'pics'   => 'Multi-Pics', //图集等
	'pick'   => 'Pick Info',
	'winpop' => 'Win-POP',
	'datetm' => 'Pick Date',
	'color'  => 'Color-Set',
	'map'	=> 'Map-Piont',
);		
// 数据类型
$cfgs['fcfg_dbtype'] = array(
	'varchar' => 'varchar.Characters',
	'int'	 => 'int.Integer',
	'float'   => 'float.Decimal',
	'text'	=> 'text.64K Text',
	'mediumtext' => 'mtext.16M LongText',
	'nodb'	=> 'nodb.NO-Save',	
);		
// 字段认证
$cfgs['fcfg_vreg'] = array(
	'fix:tel'   => 'Tel',
	'fix:email' => 'E-mail',
	'fix:uri'   => 'Url',
	'fix:file'  => 'File',
	'fix:image' => 'Pic',
	'key:'	    => 'Key(var-fmt)',
	'fix:xid'   => 'Key(9999-md)',
	'tit:'	   => 'Title',
	'n+i'	   => 'Integer',
	'n-i'	   => 'Integer(Negative)',
	'n+d'	   => 'Decimal',
	'n-d'	   => 'Decimal(Negative)',
	'str:'	   => 'CommStr',
	'vimg:'	   => 'AuthCode',		
);

$cfgs['fedit_numtype'] = array(
	'n+i'=>'Int', 
	'n-i'=>'Int(Negative)',
	'n+d'=>'Decimal', 
	'n-d'=>'Decimal(Negative)',
);
$cfgs['fedit_vline'] = array(
	'1'=>'Show One Line',
	'0'=>'Show same Line',
);
$cfgs['fedit_vltitle'] = array(
	'0'=>'Hide Title',
	'1'=>'Show Title',
);

$cfgs['model_deep'] = array(
	'docs'=>'Catalog Level',
	'types'=>'Types Level',
	'menus'=>'Menu Level',
);

$cfgs['advs_type'] = array(
	1=>'Text Links',
	2=>'Pics Links',
	3=>'Info.Block',
	4=>'Url Favor',
);

$cfgs['exdbase_mode'] = array(
	'modeVal'=>'Html Tag Mode',
	'modePos'=>'Html Point Mode',
	'modeArr'=>'tml TagArray Mode',
	'modePreg'=>'Regular Mode',
	'modeAttr'=>'Get Html-att Mode',
);
$cfgs['exdbase_ext'] = array(
	'url:fatch'=>'Get Remote Url Data',
	'save:image'=>'Save Remote Pic',
);

$cfgs['usrbase'] = array(
	'Null' => 'Login Fail, Null ID/PW!',
	'Forbid' => 'Login Fail, It is Locked User!',
	'noChecked' => 'Login Fail, ID/PW Error or NOT Checked!',
	'isLogin' => 'Already logged, Can NOT Loinin Repeat!',
	'OK' => 'Login OK!',
);

$cfgs['upload'] = array(
	"SUCCESS", //上传成功标记
	"File Size over upload_max_filesize Limit",
	"File Size over MAX_FILE_SIZE Limit",
	"File not fully Uploaded",
	"NO File Data",
	"Null File",
	"ERROR_TMP_FILE" => "Temp File Error",
	"ERROR_TMP_FILE_NOT_FOUND" => "Temp File NOT Found",
	"ERROR_SIZE_EXCEED" => "File Size over then Site set",
	"ERROR_TYPE_NOT_ALLOWED" => "File Type Disallow",
	"ERROR_CREATE_DIR" => "Creat Dir Error",
	"ERROR_DIR_NOT_WRITEABLE" => "Dir Cant Write",
	"ERROR_FILE_MOVE" => "File Save Error",
	"ERROR_FILE_NOT_FOUND" => "Upload File NOT Found",
	"ERROR_WRITE_CONTENT" => "File Write Error",
	"ERROR_UNKNOWN" => "Unknown Error",
	"ERROR_DEAD_LINK" => "Link is NOT Available",
	"ERROR_HTTP_LINK" => "NOT http Link",
	"ERROR_HTTP_CONTENTTYPE" => "Error contentType"
);

$cfgs['dbext'] = array(
	'advs' => 'Advs',
	'coms' => 'Coms',
	'docs' => 'Main',
	'types' => 'Types',
	'users' => 'Users',
);

$cfgs['dopmedia'] = array(
	'iframe' => 'iframe(InnerFrame)',
	'map' => 'map(MapPiont)',
	'swf' => 'swf(FlashMedia)',
	'audio'	=> 'audio(AudioMedia)',
	'ckvdo'	=> 'video(VideoMedia)',
);
//'flv'	=> 'flv(Flash媒体文件)', // (合并到ckvdo)
//'bgsnd'  => 'bgsnd(背景音乐)', // 需要的化，专门添加字段

return $cfgs;




/*******************************************************************************
 File : \code\lang\ucfgs\fadvs-cn.php 
*******************************************************************************/
<?php
// 语言包:cn
array (
  'title' => '标题',
  'title-vtip' => '标题2-60字符',
  'color' => '颜色',
  'color-vtip' => '如:#FF00FF',
  'ndb_repeat' => '检查重复',
  'detail' => '内容',
  'mpic' => '缩略图',
  'mpic-vtip' => 'gif/jpg/jpeg/png格式.',
  'url' => 'Url地址',
  'url-vtip' => 'http://开头',
  'click' => '点击次数',
  'click-vtip' => '如:888',
);


/*******************************************************************************
 File : \code\lang\ucfgs\fadvs-en.php 
*******************************************************************************/
<?php
// 语言包:en
array (
  'title' => 'Title',
  'title-vtip' => '2-60 Ltters',
  'color' => 'Color',
  'color-vtip' => 'eg:#FF00FF',
  'ndb_repeat' => 'Repeat',
  'detail' => 'Detail',
  'mpic' => 'Thumb',
  'mpic-vtip' => 'Fmts:gif/jpg/jpeg/png.',
  'url' => 'Url',
  'url-vtip' => 'Begain with: http://',
  'click' => 'Clicks',
  'click-vtip' => 'eg:888',
);


/*******************************************************************************
 File : \code\lang\ucfgs\fdemo-cn.php 
*******************************************************************************/
<?php
// 语言包:cn
array (
  'title' => '标题',
  'title-vtip' => '标题2-60字符',
  'mpic' => '缩略图',
  'mpic-vtip' => 'gif/jpg/jpeg/png格式.',
  'jump' => '跳转地址',
  'jump-vtip' => 'http://开头',
  'static' => '静态格式',
  'static-vtip' => 'yyyy-md-(no)',
  'show' => '是否显示',
  'show-vtip' => '一定要选',
  'top' => '显示顺序',
  'top-vtip' => '如:888',
  'color' => '标题颜色',
  'color-vtip' => '如:#FF00FF',
  'click' => '点击次数',
  'click-vtip' => '如:888',
  'detail' => '内容',
  'detail-vtip' => '内容10字符以上',
  'author' => '作者',
  'source' => '来源',
  'seo_key' => '关键字',
  'seo_des' => '描述',
  'seo_tag' => '标签',
  'mname' => '会员名称',
  'mname-vtip' => '2-24字符',
  'mtel' => '电话',
  'mtel-vtip' => '7-24字符',
  'memail' => '邮件地址',
  'memail-vtip' => '如:peace@domain.com',
  'miuid' => '聊天号',
  'miuid-vtip' => '聊天号:QQ,MSN等',
  'mweb' => '网址',
  'mweb-vtip' => 'http://开头',
  'maddr' => '地址',
  'maddr-vtip' => '详细地址',
  'company' => '公司名称',
  'company-vtip' => '2-48字符',
  'mfrom' => '籍贯',
  'ename' => '英文名',
  'ename-vtip' => '标题2-60字符',
  'map' => '地图',
  't400' => '400电话',
  't400-vtip' => '2-24字符',
  't800' => '800电话',
  't800-vtip' => '2-24字符',
  'mtitle' => '联系人',
  'mtitle-vtip' => '2-24字符',
);


/*******************************************************************************
 File : \code\lang\ucfgs\fdemo-en.php 
*******************************************************************************/
<?php
// 语言包:en
array (
  'title' => 'Title',
  'title-vtip' => '2-60 Letters',
  'mpic' => 'Thumb',
  'mpic-vtip' => 'Fmts: gif/jpg/jpeg/png.',
  'jump' => 'JumpUrl',
  'jump-vtip' => 'Begain with: http://',
  'static' => 'StaticFmt',
  'static-vtip' => 'yyyy-md-(no)',
  'show' => 'Show',
  'show-vtip' => 'Is must',
  'top' => 'Order',
  'top-vtip' => 'eg:888',
  'color' => 'Colore',
  'color-vtip' => 'eg:#FF00FF',
  'click' => 'Clicks',
  'click-vtip' => 'eg:888',
  'detail' => 'Detail',
  'detail-vtip' => 'Above  10 Letters',
  'author' => 'Author',
  'source' => 'From',
  'seo_key' => 'Keyword',
  'seo_des' => 'Desc.',
  'seo_tag' => 'Tag',
  'mname' => 'Name',
  'mname-vtip' => '2-24 Letters',
  'mtel' => 'Tel',
  'mtel-vtip' => '7-24 Letters',
  'memail' => 'E-mail',
  'memail-vtip' => 'eg:peace@domain.com',
  'miuid' => 'Chat No.',
  'miuid-vtip' => 'Chat No.: like as QQ,MSN',
  'mweb' => 'Web',
  'mweb-vtip' => 'Begain with: http://',
  'maddr' => 'Addr.',
  'maddr-vtip' => 'Address',
  'company' => 'Company',
  'company-vtip' => '2-48 Letters',
  'mfrom' => 'Hometown',
  'ename' => 'Name(en)',
  'ename-vtip' => '2-60 Letters',
  'map' => 'Map',
  't400' => 'Tel 400',
  't400-vtip' => '2-24 Letters',
  't800' => 'Tel 800',
  't800-vtip' => '2-24 Letters',
  'mtitle' => 'Contacts',
  'mtitle-vtip' => '2-24 Letters',
);


/*******************************************************************************
 File : \code\lang\ucfgs\fsystem-cn.php 
*******************************************************************************/
<?php

return array(

	'kid'=>'标识ID','did'=>'文档ID','uid'=>'会员ID','cid'=>'交互ID','aid'=>'广告ID',
	'pid'=>'父ID','dno'=>'序列ID','uno'=>'序列ID','cno'=>'序列ID', 'ano'=>'序列ID','model'=>'模块ID',
	'kno'=>'序列ID', 'rel_user'=>'相关会员',
	
	'title' =>'标题','catid'=>'栏目','grade' =>'会员等级', 'static'=>'静态目录',
	'enable'=>'状态','show'=>'显示', 
	'appid' =>'appid', 'appsecret' =>'appsecret', 'token' =>'token', 
	'type' =>'类型', 'openid' =>'openid', 'ticket' =>'ticket',
	
	'top' =>'显示顺序', 'enable'=>'状态', 'etab'=>'扩展表', 
	'char'=>'头字母', 'deep'=>'最大级别数', 'frame'=>'结构性', 
	'icon'=>'图标', 'cfgs'=>'配置数组', 'note'=>'备注', 
	
	'aip'  =>'添加IP','atime'=>'添加时间','auser'=>'添加者',
	'eip'  =>'修改IP','etime'=>'修改时间','euser'=>'修改者',
	
	'sid'  =>'会话ID','sip'  =>'会话IP','stime'=>'会话时间',
	'aua'  =>'UserAgent','sua'=>'UserAgent',
	
	'pmod' =>'父模型ID', 'uname'=>'用户名', // 'upass'=>'用户密码', 'umods'=>'用户模型', //''=>'', 
	'errno'=>'Errno', 'url'=>'Url', 'page'=>'Page', 'act'=>'Action', 
	
	'ufrom'=>'From', 'uto'=>'To', 
	'api'=>'API', 'stat'=>'状态', 
	'amount'=>'金额', 'zzz'=>'zzz', 
	
	'dbdef'=>'db默认值', 'dblen'=>'db长度', 'dbtype'=>'db类型', 
	'fmexstr'=>'表单插件参数', 'fmextra'=>'表单元素插件', 
	'fmline'=>'表单元素是否独立行显示', 'fmsize'=>'表单元素大小', 'fmtitle'=>'表单元素是否显示标题(fmline=0有效)', 
	'vmax'=>'认证最大值', 'vreg'=>'认证规则', 'vtip'=>'认证提示', 
	
	'exp_s01'=>'扩展参数-select-1', 'exp_s02'=>'扩展参数-select-2', 'exp_s03'=>'扩展参数-select-3',  'exp_s04'=>'扩展参数-select-4',  'exp_s05'=>'扩展参数-select-5', 
	'exp_i01'=>'扩展参数-input-1', 'exp_i02'=>'扩展参数-input-2', 'exp_i03'=>'扩展参数-input-3', 'exp_i04'=>'扩展参数-input-4', 
	'exp_m01'=>'扩展参数-checkbox-1', 'exp_m02'=>'扩展参数-checkbox-2', 'exp_m03'=>'扩展参数-checkbox-3', 
	'exp_t01'=>'扩展参数-text-1', 'exp_t02'=>'扩展参数-text-2',
	
	'orgtg1'=>'采集标记', 'orgtg2'=>'采集标记', 'orgtg3'=>'采集标记', 'orgtg4'=>'采集标记', 
	'orgtg5'=>'采集标记', 'orgtg6'=>'采集标记', 'orgtg7'=>'采集标记', 
	
	'_stabs' => array(
		'base_catalog'=>'(系统)栏目表', 'base_fields'=>'(系统)字段配置表', 'base_grade'=>'(系统)用户等级表', 
		'base_menu'=>'(系统)菜单表', 'base_model'=>'(系统)[群组/模块]表', 'base_paras'=>'(系统)参数表', 
		'bext_dbdict'=>'(扩展)数据库词典表', 'bext_relat'=>'(扩展)类别关联表', 'bext_fields'=>'(扩展)类别字段表', 
		'bext_paras'=>'(扩展)参数表', 'bext_cron'=>'(扩展)计划任务表', 
		
		'exd_crawl'=>'(数据)采集表', 'exd_crlog'=>'(数据)采集记录', 
		'exd_oilog'=>'(数据)导入表', 'exd_oimp'=>'(数据)导入记录', 
		'exd_pslog'=>'(数据)同步表', 'exd_psyn'=>'(数据)同步记录', 
		'exd_sfield'=>'(数据)字段配置',  
		
		'init_advs'=>'(初始)[广告]表', 'init_coms'=>'(初始)[互动]表', 'init_dext'=>'(初始)[文档]扩展表', 
		'init_docs'=>'(初始)[文档]主表', 'init_types'=>'(初始)[分类]表', 'init_users'=>'(初始)[会员]表', 
		'types_common'=>'(常规)分类表', 'users_uacc'=>'(会员)账户表', 'users_uppt'=>'(会员)通行证表',
		'active_admin'=>'(管理员)会话表', 'active_online'=>'(会员)会话表', 'active_session'=>'(Session)会话表', 
		
		'logs_dbsql'=>'(sql)调试记录表', 'logs_detmp'=>'(用户)调试记录表', 
		'logs_syact'=>'(系统)调试记录表', 'logs_jifen'=>'(积分)操作记录', 
		'plus_emsend'=>'(邮件)发送记录', 'plus_paylog'=>'(支付)历史记录', 
		'plus_smcharge'=>'(短信)充值记录', 'plus_smsend'=>'(短信)发送记录', 
		
		'wex_apps'=>'(微信)配置表', 'wex_menu'=>'(微信)菜单表', 'wex_keyword'=>'(微信)关键字表', 'wex_qrcode'=>'(微信)二维码表', 
		'wex_locate'=>'(微信)地理位置表', 'wex_msgget'=>'(微信)接收信息', 'wex_msgsend'=>'(微信)发送信息',
	),
	
);

//$fs = implode("','",array_keys($_sy_fsystem));
//echo "SELECT * FROM base_fields_ys WHERE kid IN('$fs');";


/*******************************************************************************
 File : \code\lang\ucfgs\fsystem-en.php 
*******************************************************************************/
<?php

return array(
	
	'kid'=>'KeyID','did'=>'DocID','uid'=>'UserID','cid'=>'ComID','aid'=>'AdvID',
	'pid'=>'PID','dno'=>'dNo','uno'=>'uNo','cno'=>'cNo', 'ano'=>'aNo','model'=>'ModID',
	'kno'=>'kNo', 'rel_user'=>'Rel.User',
	
	'title' =>'Title','catid'=>'Column','grade' =>'Grade', 'static'=>'Static',
	'enable'=>'Stat','show'=>'Show', 
	'appid' =>'appid', 'appsecret' =>'appsecret', 'token' =>'token', 
	'type' =>'Type', 'openid' =>'openid', 'ticket' =>'ticket',
	
	'top' =>'Order', 'enable'=>'Stat', 'etab'=>'exTable', 
	'char'=>'FirstChar', 'deep'=>'MaxLevel', 'frame'=>'Frame', 
	'icon'=>'Icon', 'cfgs'=>'Setting', 'note'=>'Notes', 
	
	'aip'  =>'AddIP','atime'=>'AddTime','auser'=>'AddTime',
	'eip'  =>'EditIP','etime'=>'EditTime','euser'=>'EditTime',
	
	'sid'  =>'SessID','sip'  =>'SessIP','stime'=>'SessTime',
	'aua'  =>'UserAgent','sua'=>'UserAgent',
	
	'pmod' =>'pMod', 'uname'=>'UserName', // 'upass'=>'用户密码', 'umods'=>'用户模型', //''=>'', 
	'errno'=>'Errno', 'url'=>'Url', 'page'=>'Page', 'act'=>'Action', 
	
	'ufrom'=>'From', 'uto'=>'To', 
	'api'=>'API', 'stat'=>'Stat', 
	'amount'=>'Amount', 'zzz'=>'zzz', 
	
	'dbdef'=>'dbDefval', 'dblen'=>'dbLen', 'dbtype'=>'dbType', 
	'fmexstr'=>'Form Plus set', 'fmextra'=>'Form Plus', 
	'fmline'=>'Show in line', 'fmsize'=>'Size', 'fmtitle'=>'Show Title(use onle fmline=0)', 
	'vmax'=>'Max Value', 'vreg'=>'Rule', 'vtip'=>'Tips', 
	
	'exp_s01'=>'exPararm-select-1', 'exp_s02'=>'exPararm-select-2', 'exp_s03'=>'exPararm-select-3',  'exp_s04'=>'exPararm-select-4',  'exp_s05'=>'exPararm-select-5', 
	'exp_i01'=>'exPararm-input-1', 'exp_i02'=>'exPararm-input-2', 'exp_i03'=>'exPararm-input-3', 'exp_i04'=>'exPararm-input-4', 
	'exp_m01'=>'exPararm-checkbox-1', 'exp_m02'=>'exPararm-checkbox-2', 'exp_m03'=>'exPararm-checkbox-3', 
	'exp_t01'=>'exPararm-text-1', 'exp_t02'=>'exPararm-text-2',
	
	'orgtg1'=>'crawlFlag', 'orgtg2'=>'crawlFlag', 'orgtg3'=>'crawlFlag', 'orgtg4'=>'crawlFlag', 
	'orgtg5'=>'crawlFlag', 'orgtg6'=>'crawlFlag', 'orgtg7'=>'crawlFlag', 
	
	'_stabs' => array(
		'base_catalog'=>'(sys)Catalog', 'base_fields'=>'(sys)Fields set', 'base_grade'=>'(sys)User Grade', 
		'base_menu'=>'(sys)Menus', 'base_model'=>'(sys)[Groups/Model]', 'base_paras'=>'(sys)Params', 
		'bext_dbdict'=>'(ex)dbDict', 'bext_relat'=>'(ex)Type Relate', 'bext_fields'=>'(ex)Type Fields', 
		'bext_paras'=>'(ex)Params', 'bext_cron'=>'(ex)Task Plan', 
		
		'exd_crawl'=>'(data)Crawl', 'exd_crlog'=>'(data)Crawl Log', 
		'exd_oilog'=>'(data)Import', 'exd_oimp'=>'(data)Import Log', 
		'exd_pslog'=>'(data)SynParent', 'exd_psyn'=>'(data)Syn Log', 
		'exd_sfield'=>'(data)Fields set',  
		
		'init_advs'=>'(init)[Advs]', 'init_coms'=>'(init)[Comms]', 'init_dext'=>'(init)[Docs]Extra', 
		'init_docs'=>'(init)[Docs]Main', 'init_types'=>'(init)[Types]', 'init_users'=>'(init)[Users]', 
		'types_common'=>'(common)Types', 'users_uacc'=>'(user)Account', 'users_uppt'=>'(user)passport',
		'active_admin'=>'(admin)session', 'active_online'=>'(user)session', 'active_session'=>'(Session)session', 
		
		'logs_dbsql'=>'(sql)Debug Log', 'logs_detmp'=>'(user)Debug Log', 
		'logs_syact'=>'(sys)Debug Log', 'logs_jifen'=>'(piont)op Log', 
		'plus_emsend'=>'(mail)Send Log', 'plus_paylog'=>'(pay)Pay Log', 
		'plus_smcharge'=>'(sms)Charge  Log', 'plus_smsend'=>'(sns)Send Log', 
		
		'wex_apps'=>'(Weixin)Appsets', 'wex_menu'=>'(Weixin)Menus', 'wex_keyword'=>'(Weixin)Keywords', 'wex_qrcode'=>'(Weixin)Qrcode', 
		'wex_locate'=>'(Weixin)Locate', 'wex_msgget'=>'(Weixin)ReciveLog', 'wex_msgsend'=>'(Weixin)SendLog',
	),
	
);

//$fs = implode("','",array_keys($_sy_fsystem));
//echo "SELECT * FROM base_fields_ys WHERE kid IN('$fs');";


/*******************************************************************************
 File : \code\lang\ucfgs\nava-cn.php 
*******************************************************************************/
<?php

// {root} 表示项目根目录 

$cfgs['faqs'] = array(
	'apis/exp_qaset&view=list' => '问答统计',
	'apis/exp_qaset&view=uset' => '设置更新',
);

$cfgs['indoc'] = array(
	'apis/exp_indoc&pid=indoc_tpl' => '短信模板',
	'apis/exp_indoc&pid=indoc_ext' => '扩展设置',
);

$cfgs['exdiys'] = array(
	'admin/ediy&part=exdiy&dkey=tpls' => '模板配置',
	'admin/ediy&part=exdiy&dkey=skin' => '模板样式',
	'admin/ediy&part=exdiy&dkey=cfgs' => '系统参数',
	'admin/ediy&part=exdiy&dkey=runs' => '入口配置',
); 

$cfgs['envdiy'] = array(
	'admin/ediy&part=binfo' => '基础环境',
	'admin/ediy&part=check' => '环境检测',
	'admin/ediy&part=exdiy' => 'DIY配置',
	'admin/ediy&part=reset' => '系统重置',
	'admin/ediy&part=search' => '搜索器',
);   

$cfgs['upd_vers'] = array( 
	'admin/upgrade&mod=upvnow' => '升级当前系统',
	'admin/upgrade&mod=import' => '导入旧版数据',
	'admin/upgrade&mod=install' => '安装更新模块',
);

$cfgs['cron_plan'] = array(
	'apis/cron_plan' => '计划任务',
	'apis/jifen_plan' => '积分配置',
);
$cfgs['cron_jifen'] = array(
	'apis/jifen_plan&pid=jifen_grade' => '积分等级',
	'apis/jifen_plan&pid=jifen_model' => '积分设置',
	'apis/jifen_plan&pid=jifen_logs' => '积分记录',
);

$cfgs['exd_psyn'] = array(
	'apis/exd_share' => '数据分享',
	'apis/exd_psyn' => '数据同步',
);
$cfgs['exd_share'] = array(
	'apis/exd_share&view=list' => '分享DIY',
	'apis/exd_share&view=set' => '分享配置',
);

$cfgs['exd_oimp'] = array(
	'apis/exd_oimp' => '数据导入',
	'apis/exd_crawl' => '数据采集',
);

$cfgs['seo_push'] = array( 
	'apis/seo_push&pid=seo_sitemap' => 'Sitemap',
	'apis/seo_push&pid=seo_pset' => 'Push设置',
	'admin/rlogs&sfid=act&sfop=eq&sfkw=bpushRun&frame=1' => 'Push记录',
);

$cfgs['pay'] = array(
	'apis/pay_logs&view=vlist' => '支付记录',
	'apis/pay_logs&view=vcfgs' => '支付配置',
);
$cfgs['mail'] = array(
	'apis/mail_logs&view=vlist' => '邮件记录',
	'apis/mail_logs&view=vcfgs' => '邮件配置',
);

$cfgs['sms'] = array(
	'apis/sms_send' => '短信发送',
	'apis/sms_logs&part=slogs' => '发送记录',
	'apis/sms_logs&part=charge' => '充值记录',
);

$cfgs['logs'] = array(
	'admin/rlogs&mod=syact' => '系统日志',
	'admin/rlogs&mod=detmp' => '调试记录',
	'admin/rlogs&part=dbsql' => 'SQL优化',
);

$cfgs['dba'] = array( 
	'admin/db_act&view=list' => '数据表操作',
	'admin/db_act&view=rem' => '数据表备注',
	'admin/db_act&view=runsql' => '运行SQL',
	'admin/rlogs&part=dbsql' => 'SQL优化',
);

$cfgs['ordcn'] = array(
	'apis/exp_order&pid=paymode_cn' => '付款方式',
	'apis/exp_order&pid=devmode_cn' => '配送地区',
	'apis/exp_order&pid=timmode_cn' => '送货时间',
	'apis/exp_order&pid=logmode_cn' => '物流方式',
);
$cfgs['orden'] = array(
	'apis/exp_order&pid=paymode_en' => 'Pay Mode',
	'apis/exp_order&pid=devmode_en' => 'Ship Area',
	'apis/exp_order&pid=timmode_en' => 'Receive Time',
	'apis/exp_order&pid=logmode_en' => 'Logistics Mode',
);

$cfgs['ordnav'] = array(
	'dops/a&mod=corder' => '订单管理',
	'dops/a&mod=cocar' => '购物车',
	'dops/a&mod=coitem' => '订单项',
);

return $cfgs;



/*******************************************************************************
 File : \code\lang\ucfgs\nava-en.php 
*******************************************************************************/
<?php

// {root} 表示项目根目录 

$cfgs['faqs'] = array(
	'apis/exp_qaset&view=list' => 'Faq Stat.',
	'apis/exp_qaset&view=uset' => 'Set/Upd',
);

$cfgs['indoc'] = array(
	'apis/exp_indoc&pid=indoc_tpl' => 'Sms Tpl.',
	'apis/exp_indoc&pid=indoc_ext' => 'Ext/Set',
);

$cfgs['exdiys'] = array(
	'admin/ediy&part=exdiy&dkey=tpls' => 'Tpl Set',
	'admin/ediy&part=exdiy&dkey=skin' => 'Tpl Style',
	'admin/ediy&part=exdiy&dkey=cfgs' => 'Sys Parms',
	'admin/ediy&part=exdiy&dkey=runs' => 'Entry Set',
); 

$cfgs['envdiy'] = array(
	'admin/ediy&part=binfo' => 'Base Env.',
	'admin/ediy&part=check' => 'Env Debug',
	'admin/ediy&part=exdiy' => 'DIYSet',
	'admin/ediy&part=reset' => 'Sys.Rest',
	'admin/ediy&part=search' => 'Search',
);   

$cfgs['upd_vers'] = array( 
	'admin/upgrade&mod=upvnow' => 'Update Now System',
	'admin/upgrade&mod=import' => 'Import Old Data',
	'admin/upgrade&mod=install' => 'Install/Update Model',
);

$cfgs['cron_plan'] = array(
	'apis/cron_plan' => 'Plan Task',
	'apis/jifen_plan' => 'Points Set',
);
$cfgs['cron_jifen'] = array(
	'apis/jifen_plan&pid=jifen_grade' => 'Points Grade',
	'apis/jifen_plan&pid=jifen_model' => 'Points Set',
	'apis/jifen_plan&pid=jifen_logs' => 'Points Logs',
);

$cfgs['exd_psyn'] = array(
	'apis/exd_share' => 'Data Share',
	'apis/exd_psyn' => 'Data Syn.',
);
$cfgs['exd_share'] = array(
	'apis/exd_share&view=list' => 'ShareDIY',
	'apis/exd_share&view=set' => 'ShareSet',
);

$cfgs['exd_oimp'] = array(
	'apis/exd_oimp' => 'Data Import',
	'apis/exd_crawl' => 'Data Crawl',
);

$cfgs['seo_push'] = array( 
	'apis/seo_push&pid=seo_sitemap' => 'Sitemap',
	'apis/seo_push&pid=seo_pset' => 'PushSet',
	'admin/rlogs&sfid=act&sfop=eq&sfkw=bpushRun&frame=1' => 'PushLogs',
);

$cfgs['pay'] = array(
	'apis/pay_logs&view=vlist' => 'Pay Logs',
	'apis/pay_logs&view=vcfgs' => 'Pay Set',
);
$cfgs['mail'] = array(
	'apis/mail_logs&view=vlist' => 'Email Logs',
	'apis/mail_logs&view=vcfgs' => 'Email Set',
);

$cfgs['sms'] = array(
	'apis/sms_send' => 'Sms Send',
	'apis/sms_logs&part=slogs' => 'Send Logs',
	'apis/sms_logs&part=charge' => 'Charge Logs',
);

$cfgs['logs'] = array(
	'admin/rlogs&mod=syact' => 'Sys Logs',
	'admin/rlogs&mod=detmp' => 'Debug Logs',
	'admin/rlogs&part=dbsql' => 'SQL Optimizing',
);

$cfgs['dba'] = array( 
	'admin/db_act&view=list' => 'Table',
	'admin/db_act&view=rem' => 'Remarks',
	'admin/db_act&view=runsql' => 'Run-SQL',
	'admin/rlogs&part=dbsql' => 'Optimizing',
);

$cfgs['ordcn'] = array(
	'apis/exp_order&pid=paymode_cn' => '付款方式',
	'apis/exp_order&pid=devmode_cn' => '配送地区',
	'apis/exp_order&pid=timmode_cn' => '送货时间',
	'apis/exp_order&pid=logmode_cn' => '物流方式',
);
$cfgs['orden'] = array(
	'apis/exp_order&pid=paymode_en' => 'Pay Mode',
	'apis/exp_order&pid=devmode_en' => 'Ship Area',
	'apis/exp_order&pid=timmode_en' => 'Receive Time',
	'apis/exp_order&pid=logmode_en' => 'Logistics Mode',
);

$cfgs['ordnav'] = array(
	'dops/a&mod=corder' => 'Order',
	'dops/a&mod=cocar' => 'OrdCar',
	'dops/a&mod=coitem' => 'OrdItem',
);

return $cfgs;



/*******************************************************************************
 File : \code\lang\ucfgs\urparts-cn.php 
*******************************************************************************/
<?php

// 语言包:cn

$cfgs = array(
	'icons' => array('图标','icon18'), 
	'files' => array('文档','office'), 
	'comms' => array('logo','logo'), 
	'temp' => '临时',
	'now' => '当前',
	'upbat' => '上传',
	'media' => '插入',
);

return $cfgs;




/*******************************************************************************
 File : \code\lang\ucfgs\urparts-en.php 
*******************************************************************************/
<?php

// 语言包:cn

$cfgs = array(
	'icons' => array('Icons','icon18'), 
	'files' => array('Files','office'), 
	'comms' => array('logo','logo'), 
	'temp' => 'Temp.',
	'now' => 'Now',
	'upbat' => 'Upload',
	'media' => 'Insert',
);

return $cfgs;




/*******************************************************************************
 File : \code\tpls\adm\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();
	
	static function base1($show,$a=''){ 
		echo "<br>base1::";
	}
	
	static function init($obj){
		$user = usrBase::userObj('Admin');
		if(!in_array($obj->mod,array('login','help'))){
			if($user->userFlag=='Guest') header('Location:'."?login");
			$user->setSess();
		}
		return $user;	
	}
	
	static function pend(){

	}

}



/*******************************************************************************
 File : \code\tpls\adm\frame\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\tpls\adm\_config\va_home.php 
*******************************************************************************/
<?php
/*
? 
*/
$_va_home = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,catch,close
		'stexp' => '2h', //30,60,3h,6h,12h,24h,7d
		'stext' => '-a.htm',
	),
	
	//mod.home模块首页模板
	'm' => 'frame/awtop',
	
	//关闭模块
	'close' => array(),
	
	//import导入配置的模块
	'imcfg' => array(
		#'demo' => 'news', // demo按news方式显示
	),
	
	//扩展模块
	'extra' => array('awtop','amain','login','uhome','help'), 
	
);



/*******************************************************************************
 File : \code\tpls\adm\_config\ve_amain.php 
*******************************************************************************/
<?php
/*
 * _ve_amain扩展信息模板配置
/*/
$_ve_amain = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'frame/amain',

);



/*******************************************************************************
 File : \code\tpls\adm\_config\ve_awtop.php 
*******************************************************************************/
<?php
/*
 * _ve_awtop扩展信息模板配置
/*/
$_ve_awtop = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'frame/awtop',

);



/*******************************************************************************
 File : \code\tpls\adm\_config\ve_help.php 
*******************************************************************************/
<?php
/*
 * order扩展信息模板配置
/*/
$_ve_help = array(

	'c' => array(
		'vmode' => 'static', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
		'stext' => '-adm.htm',
	),
	'm' => 'frame/help',
	
);



/*******************************************************************************
 File : \code\tpls\adm\_config\ve_login.php 
*******************************************************************************/
<?php
/*
 * order扩展信息模板配置
/*/
$_ve_login = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'frame/login',
	
);



/*******************************************************************************
 File : \code\tpls\adm\_config\ve_uhome.php 
*******************************************************************************/
<?php
/*
 * _ve_uhome扩展信息模板配置
/*/
$_ve_uhome = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'frame/uhome',

);



/*******************************************************************************
 File : \code\tpls\chn\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();
	
	static function init($obj){
		$ocar_items = comCookie::oget('ocar_items'); 
		if(strlen($ocar_items)==0){
			$db = glbDBObj::dbObj();
			$unqid = usrPerm::getUniqueid();
			$row = $db->table('coms_cocar')->where("ordid='$unqid'")->count(); 
			$row || $row = 0;
			comCookie::oset('ocar_items',$row);
		}
		$user = usrBase::userObj('Member'); 
		return $user;
	}
	
	static function pend(){
		$tpl = cfg('tpl');
		$base = $tpl['tplpend'];
		$ext = $tpl['tplpext'];
		$base || $base = 'jstag,menu,cklogin,fanyi,aheight';
		$js = "var ocar_url = '".vopUrl::fout('ocar')."';\n";
		$js .= "var umc_url = '".vopUrl::fout('umc:0')."';\n";
		$js .= "setTimeout(\"jcronRun()\",3700);\n";
		strstr($base,'jstag') && $js .= "jtagSend();\n";
		strstr($base,'menu') && $js .= "jsactMenu();\n";
		strstr($base,'cklogin') && $js .= "js_cklogin();\n";
		strstr($base,'fanyi') && $js .= "js_i18nbar();\n";
		strstr($base,'aheight') && $js .= "js_aheight();\n";
		$ext && $js .= "$ext;\n";
		echo basJscss::jscode($js)."\n";
	}
	

}



/*******************************************************************************
 File : \code\tpls\chn\b_func\tex_cargo.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_cargo{ //extends tex_base
	
	#protected $prop1 = array();
	
	static function expwhr($flag=0){ 
		$re = '';
		// exp_xxx
		$flist = basLang::ucfg('fsystem'); 
		foreach($flist as $k=>$v){
			if(strstr($k,'exp_')){
				$val = basReq::val($k);
				if(!empty($val)){
					if(strstr($k,'exp_s')){
						$re .= (empty($re) ? '' : ' AND ')."$k='$val'";
					}elseif(strstr($k,'exp_m')){
						$re .= (empty($re) ? '' : ' AND ')."$k LIKE '$val'";
					}
				}
		}   } 
		// price: price=b10, 300~500, u1000
		$area = basReq::val('price');
		if(strstr($area,'~')){ //$area && 
			$arr = explode('~',$area);
			$arr[0] && $re .= (empty($re) ? '' : ' AND ')."price>='$arr[0]'";
			$arr[1] && $re .= (empty($re) ? '' : ' AND ')."price<='$arr[1]'";
		} 
		return $re;
	}

}



/*******************************************************************************
 File : \code\tpls\chn\b_func\tex_home.php 
*******************************************************************************/
<?php
/*
单个模板扩展类
*/ 
class tex_home{ //extends tex_base
	
	protected $xxx = array();
	
	static function home1($flag){ 
		return "exp_s01='$flag'"; //zhineng,net3g
	}

}



/*******************************************************************************
 File : \code\tpls\chn\b_func\tex_keres.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_keres{ //extends tex_base
	
	#protected $prop1 = array();
	
	static function media_show($uvdo){ 
      if(empty($uvdo)) return;
	  $cfg = comFiles::getTIcon($uvdo);
	  $type = $cfg['type']=='audio' ? 'audio' : ($cfg['type']=='flash' ? 'swf' : 'ckvdo');
	  if($type=='audio'){
		  $w = 640; $h = 60;
	  }else{
		  $w = 640; $h = 480; 
	  }
	  $cstr = "{media:[type=$type][val=$uvdo][w=$w][h=$h][ext=true]/media}"; 
	  $vdo = vopMedia::repShow($cstr);
	  if($vdo) echo "<div class='keres-vdo'>$vdo</div>";
      return '';
	}
	
	static function down_show($ufile){
      if(empty($ufile)) return;
	  $ticon = comFiles::getTIcon($ufile);
	  $type = $ticon['type'];
	  $icon = PATH_STATIC."/icons/file18/{$ticon['icon']}.gif";
	  $icon = "<img src='$icon' width='18' height='18' border='0' align='absmiddle'>";
	  $ufpath = comFiles::revSaveDir($ufile);
	  $ufdir = comFiles::revSaveDir($ufile,'dir'); //echo $ufdir;
	  $ufsize = filesize($ufdir);
	  $ufsize = $ufsize ? basStr::showNumber($ufsize,'Byte') : '';
	  $vpath = strstr($ufile,'root}') ? $ufile : substr($ufile,-56,56);
	  $link = "<a href='$ufpath'>$icon [$type] $ufile</a> $ufsize ";
	  if($link) echo "<div class='keres-down'>[附件下载] $link</div>";
      return '';
	}

}



/*******************************************************************************
 File : \code\tpls\chn\b_func\tex_ocar.php 
*******************************************************************************/
<?php
/*

*/ 
class tex_ocar{ //extends tex_base
	
	#protected $prop1 = array();
	
	static function xxx_show($ufile){
		
	}

}



/*******************************************************************************
 File : \code\tpls\chn\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\tpls\chn\_config\va_docs.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_va_docs = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.html', //后缀
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\chn\_config\va_home.php 
*******************************************************************************/
<?php
/*
 * 首页模板和通用配置
/*/
$_va_home = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close(关闭)
		'stext' => '.html', 
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页模板
	'm' => 'c_page/_home',
	
	//关闭模块
	'close' => array('indoc','demo'),
	//文档/资讯:默认按va_docs设置
	//其他未设置模块按关闭处理
	
	//import导入配置的模块
	'imcfg' => array(
        //'gbook' => 'nrem', // gbook按nrem方式显示
		'crem' => 'nrem', 
		'trem' => 'nrem',
		'kerem' => 'nrem',
		'drem' => 'nrem',
		//'company' => 'company', 
		'govern' => 'company', 
		'organize' => 'company', 
	),
	
	//扩展模块
	'extra' => array('home','info','type','ocar'), 
	
);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_about.php 
*******************************************************************************/
<?php
/*
*/
$_vc_about = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.html',
		'stypes' => array('afqas','anews','aserv'), //内容页生产静态的栏目,为空则不限制
	),
	'm' => 'first',
	'd' => 'm_about/about_detail',
	't' => 'm_about/about_page', //about,alink
	
	'anews' => 'm_about/about_list', //公司新闻
	'apics' => 'm_about/about_pics', //公司图片
	'aserv' => 'm_about/about_serv', //服务内容
	'afqas' => 'm_about/about_fqas', //常见问题
	'alink' => 'm_about/about_link', //联系我们
	
	'istest' => 'close',
	
	'v' => 'profile,awhua,alink', //可带view参数
	
	/*'d' => array(
		'0' => 'm_about/about_detail',
		'list1' => 'm_about/about_dlist1',
		'list2' => 'm_about/about_dlist2',
	)*/
	//'iutest' => 'aa/bb',
	
);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_cargo.php 
*******************************************************************************/
<?php
/*
 * cargo模板配置
/*/
$_vc_cargo = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.html',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/cargo_list', //首页(key=0,first; val=list,home
		'list' => 'c_mod/cargo_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/cargo_detail',
	
	//类别页
	't' => 'c_mod/cargo_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_company.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_company = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.html',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/mem_list', 
	), 
	
	//详情页
	//'d' => 'c_mod/mem_detail',
	'd' => array(
		'0' => 'c_mod/mem_detail',
		'news' => 'c_mod/mem_ulst',
		'pro' => 'c_mod/mem_ulst',
	),
	
	//类别页
	't' => 'c_mod/mem_list',

);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_keres.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_keres = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.html',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/keres_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/keres_detail',
	
	//类别页
	't' => 'c_mod/keres_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_news.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_news = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.html',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_list', //首页
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_nrem.php 
*******************************************************************************/
<?php
/*
...
*/
$_vc_nrem = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,cache,close
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => array(
		'0' => 'c_mod/remark_list', //{mod},
		'list' => 'c_mod/remark_list',
	), //'m' => 'c_mod/news_list',
	//'d' => 'c_mod/news_detail',
	//'t' => 'c_mod/news_list',

);



/*******************************************************************************
 File : \code\tpls\chn\_config\vc_topic.php 
*******************************************************************************/
<?php
/*
 * topic模板配置
/*/
$_vc_topic = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.html',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/topic_list', //首页(key=0,first; val=list,home
		'list' => 'c_mod/topic_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/topic_detail',
	
	//类别页
	't' => 'c_mod/topic_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\chn\_config\ve_info.php 
*******************************************************************************/
<?php
/*
 * info扩展信息模板配置
/*/
$_ve_info = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.html',
	),
	'm'     => 'c_page/info_snav', //站点导航
	'indep' => 'c_page/info_indep', //部门
	'umap'  => 'c_page/info_umap', //公司地图
	'gbook'  => 'c_page/info_gbook', //gbook
	
);



/*******************************************************************************
 File : \code\tpls\chn\_config\ve_ocar.php 
*******************************************************************************/
<?php
/*
 * ocar扩展信息模板配置
/*/
$_ve_ocar = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm'        => 'm_ocar/ocar_items', //
	'checkout' => 'm_ocar/ocar_checkout', //
	'invoce'   => 'm_ocar/ocar_invoce', //
	
);



/*******************************************************************************
 File : \code\tpls\chn\_config\ve_user.php 
*******************************************************************************/
<?php
/*
 * user扩展信息模板配置
/*/
$_ve_user = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'm_user/user_login',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	
	'login' => 'm_user/user_login',
	'apply' => 'm_user/user_apply',
	//'appdo' => 'c_page/user_acts',
	'getpw' => 'm_user/user_getpw',
	//'getdo' => 'c_page/user_acts',
	
);



/*******************************************************************************
 File : \code\tpls\demodir\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();
	
	static function base1($show,$a=''){ 
		echo "<br>base1::";
	}
	
	static function init($obj){
		$user = usrBase::userObj();
		return $user;	
	}
	
	static function pend(){
		$tpl = cfg('tpl');
		$base = $tpl['tplpend'];
		$ext = $tpl['tplpext'];
		$base || $base = 'jstag';
		$js = "setTimeout(\"jcronRun()\",3700);\n";
		strstr($base,'jstag') && $js .= "jtagSend();\n";
		$ext && $js .= "$ext;\n";
		echo basJscss::jscode($js)."\n";
	}

}



/*******************************************************************************
 File : \code\tpls\demodir\_config\va_home.php 
*******************************************************************************/
<?php
/*
? 
*/
$_va_home = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,catch,close
		'stexp' => '2h', //30,60,3h,6h,12h,24h,7d
		'stext' => '-t.htm',
	),
	
	//mod.home模块首页模板
	'm' => 'c_page/_home',
	
	//关闭模块
	'close' => array(),
	
	//import导入配置的模块
	'imcfg' => array(
		#'demo' => 'news', // demo按news方式显示
	),
	
	//扩展模块
	'extra' => array('hello',), 
	
);



/*******************************************************************************
 File : \code\tpls\demodir\_config\vc_news.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_news = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '-t.htm',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_list', //首页
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\demodir\_config\ve_hello.php 
*******************************************************************************/
<?php
/*
 * _ve_uhome扩展信息模板配置
/*/
$_ve_hello = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
		'stext' => '-t.htm',
	),
	'm' => 'c_page/info_hello',

);



/*******************************************************************************
 File : \code\tpls\dev\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();

	static function init($obj){
		global $_cbase;
		if(!empty($_cbase['login_dev'])){
			$user = usrBase::userObj(); $msg = '';
			if(empty($user)){
				$msg = '需要'.($_cbase['login_dev']=='adminer' ? 'adminer' : '').'登录查看！';
			}elseif($_cbase['login_dev']=='adminer' && $user->userType!='adminer'){
				$msg = '需要adminer登录！';
			}
			if($msg){
				glbHtml::page('需要登录查看');
				glbHtml::page('body');
				echo "\n<p>$msg</p>\n";
				glbHtml::page('end');
			}
		}else{
			$user = NULL;
		}
		return $user;
	}
	
	static function pend(){
		$tpl = cfg('tpl');
		$base = $tpl['tplpend'];
		$ext = $tpl['tplpext'];
		$base || $base = 'jstag,menu,aheight';
		$js = "setTimeout(\"jcronRun()\",3700);\n";
		strstr($base,'jstag') && $js .= "jtagSend();\n";
		strstr($base,'menu') && $js .= "jsactMenu();\n";
		strstr($base,'aheight') && $js .= "js_aheight();\n";
		$ext && $js .= "$ext;\n";
		echo basJscss::jscode($js)."\n";
	}
	
	static function coder($tpl=''){ 
		$path = vopTpls::path('tpl',1); //echo 'xxx '.basename($obj->tplname);
		$file = "$path/$tpl".(strpos($tpl,'.php') ? '' : cfg('tpl.tpl_ext'));
		if(!file_exists($file)) return '';
		$code = comFiles::get($file);
		$code = highlight_string($code,1);
		return $code;
	}
	
	static function docer($mkey=''){ 
		$path = vopTpls::path('tpl',1);
		$file = "$path/$mkey.txt"; 
		if(!file_exists($file)) return array();
		$re = array(); $key=''; 
		$text = comFiles::get($file); 
		$text = extMkdown::pdext($text);
		$arr = explode('<h1>',$text);
		foreach($arr as $block){ 
			if(empty($block)) continue;
			$b = explode('</h1>',$block); //echo $block;
			$c = explode('#',$b[0]); //echo $c[0].'::'.$c[1].'::'.$b[1];
			if(empty($c[0]) || empty($c[1]) || empty($b[1])) continue;
			$key = $c[0];
			$re[$key]['title'] = $c[1];
			$re[$key]['detail'] = self::filter($b[1]);
		} 
		return $re;
	}
	
	static function lister($key=''){ 
		$path = vopTpls::path('tpl',1)."/d_tester/"; 
		$re = comFiles::listDir($path);
		$re = $re['file']; $re2 = array();
		foreach($re as $k=>$v){
			if(empty($key) && substr($k,0,1)=='u'){
				$re2[] = str_replace(array('.php'),array(''),$k);
			}elseif(strstr($k,"u{$key}_")){
				$re2[] = str_replace(array('.php'),array(''),$k);
			}
		} //print_r($re); echo $key;
		return $re2;
	}
	
	static function filter($str){ 
		$svr = cfg('server');
		$a1 = array(
			"{svrtxmao}","{svrtxcode}","{svrtxjia}",
			'{static}','{pathpro}',
		);
		$a2 = array(
			$svr['txmao'],$svr['txcode'],
			PATH_STATIC,PATH_PROJ,
		);
		$str = str_replace($a1,$a2,$str);
		return $str;
	}
	
	static function texter($key='',$conv=1){ 
		$path = vopTpls::path('tpl',1);
		$file = "$path/$key"; //echo $file;
		if(!file_exists($file)) return '';
		$data = comFiles::get($file);
		$conv && $data = comConvert::autoCSet($data,'gbk');
		return $data;
	}
	
	
}



/*******************************************************************************
 File : \code\tpls\dev\b_func\tex_devs.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_devs{ //extends tex_base
	
	static $dcfg = array('basic','main',); //'base','frame'
	static $data = array();

	#protected $prop1 = array();
	
	static function getKeyTitle($mod,$key){
		if(empty(self::$data[$mod])){
			foreach (self::$dcfg as $mkey) {
				$data = comFiles::get(vopTpls::pinc("c_demo/{$mod}_{$mkey}",'.tpl.htm'));
				if($data){
					self::$data[$mod] = $data;
					break;
				}
			}
		}
		$data = self::$data[$mod]; //dump($data);
		// 	'tplsuit' => '整套模版',
		preg_match_all("/['|\"]{1}{$key}['|\"]{1}\s*\=\>\s*['|\"]{1}([^\']+)['|\"]{1}\,/is", $data, $m);
		$re = empty($m[1][0]) ? "[$key]" : $m[1][0]; //dump($m);
		return $re;
	}

}



/*******************************************************************************
 File : \code\tpls\dev\b_func\tex_tools.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_tools{ //extends tex_base
	
	#protected $prop1 = array();
	
	static function rndIP(){
		$s = rand(3,254);
		for($a=0;$a<3;$a++){
			$s .= ".".rand(10,240);	
		}
		return $s;	
	}

}



/*******************************************************************************
 File : \code\tpls\dev\d_tester\ubasic_keyid.php 
*******************************************************************************/

<?php
(!defined('RUN_MODE')) && die('No Init');

echo '<br>'.date('y-m-d H:i:s');

echo '<br>';
echo '<br>'.comConvert::sysSn();
echo '<br>'.comConvert::sysSn('0735','.xys');
echo '<br>'.comConvert::sysSn('dg08','.cms');

echo '<br>';
echo '<br>'.basKeyid::kidRTable();
echo '<br>'.basKeyid::kidRTable('0');
echo '<br>'.basKeyid::kidRTable('a');
echo '<br>'.basKeyid::kidRTable('k');
echo '<br>'.basKeyid::kidRTable('f');
echo '<br>'.basKeyid::kidRTable('f','org');

echo '<br>';
echo '<br>'.basKeyid::kidRand('',32);
echo '<br>'.basKeyid::kidRand('fs',32);
echo '<br>'.basKeyid::kidRand('fs',32);
echo '<br>'.basKeyid::kidRand('fs',32);
echo '<br>'.basKeyid::kidTemp(4);
echo '<br>'.basKeyid::kidTemp('hm');

echo '<br>';
echo '<br>'.basKeyid::kidTemp('0');
echo '<br>4:'.basKeyid::kidTemp('4');
echo '<br>'.basKeyid::kidTemp('m-dh');

echo '<br>';
echo '<br>h:'.basKeyid::kidTemp('h');
echo '<br>'.basKeyid::kidTemp('hm','2012-01-01 12:30');
echo '<br>'.basKeyid::kidTemp('hm','2012-12-31 00:00');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-09 00:01');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-09 00:02');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-10 00:09');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-11 23:10');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-12 23:13');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-13 23:58');
echo '<br>'.basKeyid::kidTemp('hm','2012-09-14 23:59');
echo '<br>';

echo '<br>'.basKeyid::kidTemp('hms','2012-01-01 12:30');
echo '<br>'.basKeyid::kidTemp('hms','2012-12-31 00:00');
echo '<br>'.basKeyid::kidTemp('hms','2012-09-09 00:01');
echo '<br>'.basKeyid::kidTemp('hms','2012-09-10 00:09');
echo '<br>'.basKeyid::kidTemp('hms','2012-09-11 23:10');
echo '<br>'.basKeyid::kidTemp('hms','2012-09-12 23:13');
echo '<br>'.basKeyid::kidTemp('hms','2012-09-13 23:58:59');
echo '<br>'.basKeyid::kidTemp('hms','2012-09-14 23:59:59');
echo '<br>';

echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(hms): ".basKeyid::kidTemp('hms');	
echo '<br>'.microtime(1);

echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(3.4): ".basKeyid::kidTemp('3.4');	
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(4.5): ".basKeyid::kidTemp('4.5');	
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(5.6): ".basKeyid::kidTemp('5.6');	
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(3): ".basKeyid::kidTemp('3');	
echo '<br>'.microtime(1);
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(4): ".basKeyid::kidTemp('4');	
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(5): ".basKeyid::kidTemp('5');	
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(6): ".basKeyid::kidTemp('6');	
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(7): ".basKeyid::kidTemp('7');	
echo '<br>'.microtime(1);
echo '<br>'.microtime(1);
for($i=0;$i<5;$i++) echo "<br>--- run - basKeyid::kidTemp(-): ".basKeyid::kidTemp('-');	
echo '<br>'.microtime(1);

$ktab32 = str_replace(array('0','E'),'',KEY_TAB32);

echo '<br>'.$ktab32{intval(0/2)};
echo '<br>'.$ktab32{intval(1/2)};
echo '<br>'.$ktab32{intval(2/2)};
echo '<br>'.$ktab32{intval(3/2)};
echo '<br>'.$ktab32{intval(59/2)};
echo '<br>'.$ktab32{intval(58/2)};
echo '<br>'.$ktab32{intval(57/2)};
echo '<br>'.$ktab32{intval(56/2)};

echo '<br>';
echo '<br>'.basKeyid::kidNext('','A006', 'A001',3,4);
echo '<br>'.basKeyid::kidNext('','YYYY', '001',1,4);
echo '<br>'.basKeyid::kidNext('','YYYY8','001',1,4);
echo '<br>'.basKeyid::kidNext('','ZZZ', '001',1,4);
echo '<br>';

echo '<br>'.microtime(1);
for($i=0;$i<3;$i++) echo "<br>--- run - kidTemp: ".basKeyid::kidTemp();	
echo '<br>'.microtime(1);

echo '<br>';
for($i=0;$i<10;$i++) echo '<br>'.substr(microtime(),2,8);

echo '<br>';
echo '<br>123456789-123456789-';
echo '<br>kidAuto:'.basKeyid::kidAuto();
echo '<br>';
echo '<br>'.basKeyid::kidTemp('','2012-07-06 09:27:00');
echo '<br>'.basKeyid::kidTemp('','2012-07-06 09:29:00');
echo '<br>'.basKeyid::kidTemp('','2012-07-06 09:31:00');
echo '<br>'.basKeyid::kidTemp('','2012-07-06 09:33:00');
echo '<br>'.basKeyid::kidTemp('','2012-07-06 09:35:00');
echo '<br>'.basKeyid::kidTemp('','2012-07-06 09:37:00');
echo '<br>';
echo '<br>'.basKeyid::kidTemp('','2012-07-05 00:00:00');
echo '<br>'.basKeyid::kidTemp('','2012-07-05 00:00:01');
echo '<br>'.basKeyid::kidTemp('','2012-07-05 00:00:02');
echo '<br>'.basKeyid::kidTemp('','2012-07-05 00:00:03');
echo '<br>'.basKeyid::kidTemp('','2012-07-04 23:59:57');
echo '<br>'.basKeyid::kidTemp('','2012-07-04 23:59:58');
echo '<br>'.basKeyid::kidTemp('','2012-07-04 23:59:59');

echo '<br>';
echo '<br>'.basKeyid::kidRand('f',32);
echo '<br>'.basKeyid::kidRand('f',32);
echo '<br>'.basKeyid::kidRand('f',32);

echo '<br>';
//for($i=3;$i<12;$i++) echo '<br>'.basKeyid::kidSess($i);

echo '<br>';


?>



/*******************************************************************************
 File : \code\tpls\dev\d_tester\ubasic_string.php 
*******************************************************************************/

<?php
(!defined('RUN_MODE')) && die('No Init');

$s = '内页广告';
$s0 = comConvert::pinyinMain($s,3,0);
$s1 = comConvert::pinyinMain($s,3,1);
$s9 = comConvert::pinyinMain($s,3,9);
echo "<br>$s0<br>$s1<br>$s9";


echo '<br>'; var_export(basStr::isUtf8('string',''));
echo '<br>'; var_export(basStr::isUtf8('测试','')); 
echo '<br>'; var_export(basStr::isUtf8('XOぃ',''));
echo '<br>'; var_export(basStr::isUtf8('$string',''));
echo '<br>'; var_export(basStr::isUtf8('に ぬ',''));
echo '<br>'; var_export(basStr::isUtf8("\xF1",''));
echo '<br>';
echo '<br>'; var_export(basStr::isUtf8('string'));
echo '<br>'; var_export(basStr::isUtf8('测试')); 
echo '<br>'; var_export(basStr::isUtf8('XOぃ'));
echo '<br>'; var_export(basStr::isUtf8('$string'));
echo '<br>'; var_export(basStr::isUtf8('に ぬ'));
echo '<br>'; var_export(basStr::isUtf8("\xF1"));
echo '<br>';


echo "<br><a href='?'>Home</a>";
//echo '<br>'; var_export(Perm::chkUrl(''));
echo '<br>'; var_export(basStr::isMail('xys@163.com'));
echo '<br>'; var_export(basStr::isMail('xys@163.com.cn'));
echo '<br>'; var_export(basStr::isMail('xys@163'));
echo '<br>'; var_export(basStr::isMail('xys@163.3'));

echo '<br>'; var_export(basEnv::isRobot()); 
echo '<br>'; var_export(basEnv::isMobile()); 
echo '<br>';

$str = "尽test可能将定制内容集中存储到同一个目录";
for($i=3;$i<30;$i++){ 
	echo "\n<br> $i-a: "; print_r(basStr::cutCount($str,$i)); 
	echo "\n<br> $i-c: "; print_r(basStr::cutWidth($str,$i,'')); 
	//echo "\n<br> $i-b: ".basStr::cutWidth($str,$i,''); 
}

$sunit = "尽test可能将定制内容集中存储到同一个目录";
$str = "尽test可能 $sunit$sunit$sunit$sunit";
echo "\n<br> "; print_r(basStr::cutCount($str)); 

$sunit = "尽test可能将定制内容集中存储到同一个目录";
$str = "尽test可能 $sunit$sunit$sunit$sunit$sunit$sunit$sunit$sunit";
echo "\n<br> "; print_r(basStr::cutCount($str));

$sunit = "尽test可能将定制内容集中存储到同一个目录";
$str = "尽test可能 $sunit$sunit$sunit$sunit$sunit$sunit$sunit$sunit$sunit$sunit";
echo "\n<br> "; print_r(basStr::cutCount($str));



echo '<br>'.basStr::cutWidth($str);
echo '<br>'.basStr::cutWidth($str,4);
echo '<br>'.basStr::cutWidth($str,8);
echo '<br>'.basStr::cutWidth($str,12);
echo '<br>'.basStr::cutWidth($str,16);
echo '<br>123456789-123456789-123456789-123456789-123456789-';
echo '<br>';

echo '<br>'.basStr::showNumber(123,3);
echo '<br>'.basStr::showNumber(12345,2);
echo '<br>'.basStr::showNumber(1234767,1);
echo '<br>'.basStr::showNumber(12.3476789,5);
echo '<br>'.basStr::showNumber(123.476789,2);
echo '<br>'.basStr::showNumber(123,'Byte');
echo '<br>'.basStr::showNumber(12345,'Byte');
echo '<br>'.basStr::showNumber(1234767,'Byte');
echo '<br>'.basStr::showNumber(123476789,'Byte');
echo '<br>';

echo '<br>'.basStr::showState("Y;N;X;-","已审;未审;未过;未知",'');
echo '<br>'.basStr::showState("Y;N;X;-","已审;未审;未过;未知",'Y');
echo '<br>'.basStr::showState("Y;N;X;-","已审;未审;未过;未知",'N');
echo '<br>'.basStr::showState("Y;N;X;-","已审;未审;未过;未知",'-');
echo '<br>';

echo '<br>'.basStr::showColor($str,'#0FC');
echo '<br>'.basStr::showColor($str,'C0C');
echo '<br>'.basStr::showColor($str,'C0C');
echo '<br>';

$str = "
Test<b>String</b>'Test'Test End
";
echo '<br>:'.basStr::filText($str,0);
echo '<br>:'.basStr::filText($str);
echo '<br>:'.basStr::filHtml($str);
echo '<br>:'.basStr::filHText($str,20);
echo '<br>:'.basStr::filForm($str);
echo '<br>:'.basStr::filKey($str);
echo '<br>:'.basStr::filTitle($str);
echo '<br>';

$xStr = "
Test<b>String</b>'Test'Test End
";
echo '<br>:'.basJscss::Alert($xStr,'Redir','b.cn');
echo '<br>:'.basJscss::jsShow($xStr);
echo '<br>:'.basJscss::jsKey($xStr);
$str1 = basReq::in($xStr);
$str2 = basReq::out($str1);
echo "\n<hr>\n\n<br>:".$str1;
echo "\n<hr>\n\n<br>:".$str2;
echo '<br>';

//...

?>


/*******************************************************************************
 File : \code\tpls\dev\d_tester\ucssview_icons.php 
*******************************************************************************/
<?php (!defined('RUN_MODE')) && die('No Init');?>
<link rel="stylesheet" type="text/css" href="<?php echo PATH_VENDUI; ?>/common/stuipub.css">
<style type="text/css">
p { width:240px; font-size:14px; border:1px solid #CCC; margin:3px; line-height:150%; }
i{ display:inline-block; width:14px; height:14px; margin-right:5px; }
b { width:30px; height:30px; box-sizing:content-box; border:5px solid #9CF; padding:2px; border-radius:5px; }
b.ico-out { width:30px; height:30px; border:5px solid #9CF; padding:2px; border-radius:5px; }
</style>

<p>&nbsp;</p>

<b class="icons ico-carat-2-n-s"></b>
<b class="icons ico-triangle-1-n"></b>
<b class="icons ico-arrow-1-ne"></b>
<b class="icons ico-arrowthick-1-ne"></b>

<p><i class="icons ico-blank"></i>ico-blank测试</p>
<p><i class="icons ico-carat-1-n"></i>ico-carat-1-n测试</p>
<p><i class="icons ico-carat-1-ne"></i>ico-carat-1-ne测试</p>
<p><i class="icons ico-carat-1-e"></i>ico-carat-1-e测试</p>
<p><i class="icons ico-carat-1-se"></i>ico-carat-1-se测试</p>
<p><i class="icons ico-carat-1-s"></i>ico-carat-1-s测试</p>
<p><i class="icons ico-carat-1-sw"></i>ico-carat-1-sw测试</p>
<p><i class="icons ico-carat-1-w"></i>ico-carat-1-w测试</p>
<p><i class="icons ico-carat-1-nw"></i>ico-carat-1-nw测试</p>
<p><i class="icons ico-carat-2-n-s"></i>ico-carat-2-n-s测试</p>
<p><i class="icons ico-carat-2-e-w"></i>ico-carat-2-e-w测试</p>
<p><i class="icons ico-triangle-1-n"></i>ico-triangle-1-n测试</p>
<p><i class="icons ico-triangle-1-ne"></i>ico-triangle-1-ne测试</p>
<p><i class="icons ico-triangle-1-e"></i>ico-triangle-1-e测试</p>
<p><i class="icons ico-triangle-1-se"></i>ico-triangle-1-se测试</p>
<p><i class="icons ico-triangle-1-s"></i>ico-triangle-1-s测试</p>
<p><i class="icons ico-triangle-1-sw"></i>ico-triangle-1-sw测试</p>
<p><i class="icons ico-triangle-1-w"></i>ico-triangle-1-w测试</p>
<p><i class="icons ico-triangle-1-nw"></i>ico-triangle-1-nw测试</p>
<p><i class="icons ico-triangle-2-n-s"></i>ico-triangle-2-n-s测试</p>
<p><i class="icons ico-triangle-2-e-w"></i>ico-triangle-2-e-w测试</p>
<p><i class="icons ico-arrow-1-n"></i>ico-arrow-1-n测试</p>
<p><i class="icons ico-arrow-1-ne"></i>ico-arrow-1-ne测试</p>
<p><i class="icons ico-arrow-1-e"></i>ico-arrow-1-e测试</p>
<p><i class="icons ico-arrow-1-se"></i>ico-arrow-1-se测试</p>
<p><i class="icons ico-arrow-1-s"></i>ico-arrow-1-s测试</p>
<p><i class="icons ico-arrow-1-sw"></i>ico-arrow-1-sw测试</p>
<p><i class="icons ico-arrow-1-w"></i>ico-arrow-1-w测试</p>
<p><i class="icons ico-arrow-1-nw"></i>ico-arrow-1-nw测试</p>
<p><i class="icons ico-arrow-2-n-s"></i>ico-arrow-2-n-s测试</p>
<p><i class="icons ico-arrow-2-ne-sw"></i>ico-arrow-2-ne-sw测试</p>
<p><i class="icons ico-arrow-2-e-w"></i>ico-arrow-2-e-w测试</p>
<p><i class="icons ico-arrow-2-se-nw"></i>ico-arrow-2-se-nw测试</p>
<p><i class="icons ico-arrowstop-1-n"></i>ico-arrowstop-1-n测试</p>
<p><i class="icons ico-arrowstop-1-e"></i>ico-arrowstop-1-e测试</p>
<p><i class="icons ico-arrowstop-1-s"></i>ico-arrowstop-1-s测试</p>
<p><i class="icons ico-arrowstop-1-w"></i>ico-arrowstop-1-w测试</p>
<p><i class="icons ico-arrowthick-1-n"></i>ico-arrowthick-1-n测试</p>
<p><i class="icons ico-arrowthick-1-ne"></i>ico-arrowthick-1-ne测试</p>
<p><i class="icons ico-arrowthick-1-e"></i>ico-arrowthick-1-e测试</p>
<p><i class="icons ico-arrowthick-1-se"></i>ico-arrowthick-1-se测试</p>
<p><i class="icons ico-arrowthick-1-s"></i>ico-arrowthick-1-s测试</p>
<p><i class="icons ico-arrowthick-1-sw"></i>ico-arrowthick-1-sw测试</p>
<p><i class="icons ico-arrowthick-1-w"></i>ico-arrowthick-1-w测试</p>
<p><i class="icons ico-arrowthick-1-nw"></i>ico-arrowthick-1-nw测试</p>
<p><i class="icons ico-arrowthick-2-n-s"></i>ico-arrowthick-2-n-s测试</p>
<p><i class="icons ico-arrowthick-2-ne-sw"></i>ico-arrowthick-2-ne-sw测试</p>
<p><i class="icons ico-arrowthick-2-e-w"></i>ico-arrowthick-2-e-w测试</p>
<p><i class="icons ico-arrowthick-2-se-nw"></i>ico-arrowthick-2-se-nw测试</p>
<p><i class="icons ico-arrowthickstop-1-n"></i>ico-arrowthickstop-1-n测试</p>
<p><i class="icons ico-arrowthickstop-1-e"></i>ico-arrowthickstop-1-e测试</p>
<p><i class="icons ico-arrowthickstop-1-s"></i>ico-arrowthickstop-1-s测试</p>
<p><i class="icons ico-arrowthickstop-1-w"></i>ico-arrowthickstop-1-w测试</p>
<p><i class="icons ico-arrowreturnthick-1-w"></i>ico-arrowreturnthick-1-w测试</p>
<p><i class="icons ico-arrowreturnthick-1-n"></i>ico-arrowreturnthick-1-n测试</p>
<p><i class="icons ico-arrowreturnthick-1-e"></i>ico-arrowreturnthick-1-e测试</p>
<p><i class="icons ico-arrowreturnthick-1-s"></i>ico-arrowreturnthick-1-s测试</p>
<p><i class="icons ico-arrowreturn-1-w"></i>ico-arrowreturn-1-w测试</p>
<p><i class="icons ico-arrowreturn-1-n"></i>ico-arrowreturn-1-n测试</p>
<p><i class="icons ico-arrowreturn-1-e"></i>ico-arrowreturn-1-e测试</p>
<p><i class="icons ico-arrowreturn-1-s"></i>ico-arrowreturn-1-s测试</p>
<p><i class="icons ico-arrowrefresh-1-w"></i>ico-arrowrefresh-1-w测试</p>
<p><i class="icons ico-arrowrefresh-1-n"></i>ico-arrowrefresh-1-n测试</p>
<p><i class="icons ico-arrowrefresh-1-e"></i>ico-arrowrefresh-1-e测试</p>
<p><i class="icons ico-arrowrefresh-1-s"></i>ico-arrowrefresh-1-s测试</p>
<p><i class="icons ico-arrow-4"></i>ico-arrow-4测试</p>
<p><i class="icons ico-arrow-4-diag"></i>ico-arrow-4-diag测试</p>
<p><i class="icons ico-extlink"></i>ico-extlink测试</p>
<p><i class="icons ico-newwin"></i>ico-newwin测试</p>
<p><i class="icons ico-refresh"></i>ico-refresh测试</p>
<p><i class="icons ico-shuffle"></i>ico-shuffle测试</p>
<p><i class="icons ico-transfer-e-w"></i>ico-transfer-e-w测试</p>
<p><i class="icons ico-transferthick-e-w"></i>ico-transferthick-e-w测试</p>
<p><i class="icons ico-folder-collapsed"></i>ico-folder-collapsed测试</p>
<p><i class="icons ico-folder-open"></i>ico-folder-open测试</p>
<p><i class="icons ico-document"></i>ico-document测试</p>
<p><i class="icons ico-document-b"></i>ico-document-b测试</p>
<p><i class="icons ico-note"></i>ico-note测试</p>
<p><i class="icons ico-mail-closed"></i>ico-mail-closed测试</p>
<p><i class="icons ico-mail-open"></i>ico-mail-open测试</p>
<p><i class="icons ico-suitcase"></i>ico-suitcase测试</p>
<p><i class="icons ico-comment"></i>ico-comment测试</p>
<p><i class="icons ico-person"></i>ico-person测试</p>
<p><i class="icons ico-print"></i>ico-print测试</p>
<p><i class="icons ico-trash"></i>ico-trash测试</p>
<p><i class="icons ico-locked"></i>ico-locked测试</p>
<p><i class="icons ico-unlocked"></i>ico-unlocked测试</p>
<p><i class="icons ico-bookmark"></i>ico-bookmark测试</p>
<p><i class="icons ico-tag"></i>ico-tag测试</p>
<p><i class="icons ico-home"></i>ico-home测试</p>
<p><i class="icons ico-flag"></i>ico-flag测试</p>
<p><i class="icons ico-calendar"></i>ico-calendar测试</p>
<p><i class="icons ico-cart"></i>ico-cart测试</p>
<p><i class="icons ico-pencil"></i>ico-pencil测试</p>
<p><i class="icons ico-clock"></i>ico-clock测试</p>
<p><i class="icons ico-disk"></i>ico-disk测试</p>
<p><i class="icons ico-calculator"></i>ico-calculator测试</p>
<p><i class="icons ico-zoomin"></i>ico-zoomin测试</p>
<p><i class="icons ico-zoomout"></i>ico-zoomout测试</p>
<p><i class="icons ico-search"></i>ico-search测试</p>
<p><i class="icons ico-wrench"></i>ico-wrench测试</p>
<p><i class="icons ico-gear"></i>ico-gear测试</p>
<p><i class="icons ico-heart"></i>ico-heart测试</p>
<p><i class="icons ico-star"></i>ico-star测试</p>
<p><i class="icons ico-link"></i>ico-link测试</p>
<p><i class="icons ico-cancel"></i>ico-cancel测试</p>
<p><i class="icons ico-plus"></i>ico-plus测试</p>
<p><i class="icons ico-plusthick"></i>ico-plusthick测试</p>
<p><i class="icons ico-minus"></i>ico-minus测试</p>
<p><i class="icons ico-minusthick"></i>ico-minusthick测试</p>
<p><i class="icons ico-close"></i>ico-close测试</p>
<p><i class="icons ico-closethick"></i>ico-closethick测试</p>
<p><i class="icons ico-key"></i>ico-key测试</p>
<p><i class="icons ico-lightbulb"></i>ico-lightbulb测试</p>
<p><i class="icons ico-scissors"></i>ico-scissors测试</p>
<p><i class="icons ico-clipboard"></i>ico-clipboard测试</p>
<p><i class="icons ico-copy"></i>ico-copy测试</p>
<p><i class="icons ico-contact"></i>ico-contact测试</p>
<p><i class="icons ico-image"></i>ico-image测试</p>
<p><i class="icons ico-video"></i>ico-video测试</p>
<p><i class="icons ico-script"></i>ico-script测试</p>
<p><i class="icons ico-alert"></i>ico-alert测试</p>
<p><i class="icons ico-info"></i>ico-info测试</p>
<p><i class="icons ico-notice"></i>ico-notice测试</p>
<p><i class="icons ico-help"></i>ico-help测试</p>
<p><i class="icons ico-check"></i>ico-check测试</p>
<p><i class="icons ico-bullet"></i>ico-bullet测试</p>
<p><i class="icons ico-radio-on"></i>ico-radio-on测试</p>
<p><i class="icons ico-radio-off"></i>ico-radio-off测试</p>
<p><i class="icons ico-pin-w"></i>ico-pin-w测试</p>
<p><i class="icons ico-pin-s"></i>ico-pin-s测试</p>
<p><i class="icons ico-play"></i>ico-play测试</p>
<p><i class="icons ico-pause"></i>ico-pause测试</p>
<p><i class="icons ico-seek-next"></i>ico-seek-next测试</p>
<p><i class="icons ico-seek-prev"></i>ico-seek-prev测试</p>
<p><i class="icons ico-seek-end"></i>ico-seek-end测试</p>
<p><i class="icons ico-seek-start"></i>ico-seek-start测试</p>
<p><i class="icons ico-seek-first"></i>ico-seek-first测试</p>
<p><i class="icons ico-stop"></i>ico-stop测试</p>
<p><i class="icons ico-eject"></i>ico-eject测试</p>
<p><i class="icons ico-volume-off"></i>ico-volume-off测试</p>
<p><i class="icons ico-volume-on"></i>ico-volume-on测试</p>
<p><i class="icons ico-power"></i>ico-power测试</p>
<p><i class="icons ico-signal-diag"></i>ico-signal-diag测试</p>
<p><i class="icons ico-signal"></i>ico-signal测试</p>
<p><i class="icons ico-battery-0"></i>ico-battery-0测试</p>
<p><i class="icons ico-battery-1"></i>ico-battery-1测试</p>
<p><i class="icons ico-battery-2"></i>ico-battery-2测试</p>
<p><i class="icons ico-battery-3"></i>ico-battery-3测试</p>
<p><i class="icons ico-circle-plus"></i>ico-circle-plus测试</p>
<p><i class="icons ico-circle-minus"></i>ico-circle-minus测试</p>
<p><i class="icons ico-circle-close"></i>ico-circle-close测试</p>
<p><i class="icons ico-circle-triangle-e"></i>ico-circle-triangle-e测试</p>
<p><i class="icons ico-circle-triangle-s"></i>ico-circle-triangle-s测试</p>
<p><i class="icons ico-circle-triangle-w"></i>ico-circle-triangle-w测试</p>
<p><i class="icons ico-circle-triangle-n"></i>ico-circle-triangle-n测试</p>
<p><i class="icons ico-circle-arrow-e"></i>ico-circle-arrow-e测试</p>
<p><i class="icons ico-circle-arrow-s"></i>ico-circle-arrow-s测试</p>
<p><i class="icons ico-circle-arrow-w"></i>ico-circle-arrow-w测试</p>
<p><i class="icons ico-circle-arrow-n"></i>ico-circle-arrow-n测试</p>
<p><i class="icons ico-circle-zoomin"></i>ico-circle-zoomin测试</p>
<p><i class="icons ico-circle-zoomout"></i>ico-circle-zoomout测试</p>
<p><i class="icons ico-circle-check"></i>ico-circle-check测试</p>
<p><i class="icons ico-circlesmall-plus"></i>ico-circlesmall-plus测试</p>
<p><i class="icons ico-circlesmall-minus"></i>ico-circlesmall-minus测试</p>
<p><i class="icons ico-circlesmall-close"></i>ico-circlesmall-close测试</p>
<p><i class="icons ico-squaresmall-plus"></i>ico-squaresmall-plus测试</p>
<p><i class="icons ico-squaresmall-minus"></i>ico-squaresmall-minus测试</p>
<p><i class="icons ico-squaresmall-close"></i>ico-squaresmall-close测试</p>
<p><i class="icons ico-grip-dotted-vertical"></i>ico-grip-dotted-vertical测试</p>
<p><i class="icons ico-grip-dotted-horizontal"></i>ico-grip-dotted-horizontal测试</p>
<p><i class="icons ico-grip-solid-vertical"></i>ico-grip-solid-vertical测试</p>
<p><i class="icons ico-grip-solid-horizontal"></i>ico-grip-solid-horizontal测试</p>
<p><i class="icons ico-gripsmall-diagonal-se"></i>ico-gripsmall-diagonal-se测试</p>
<p><i class="icons ico-grip-diagonal-se"></i>ico-grip-diagonal-se测试</p>



/*******************************************************************************
 File : \code\tpls\dev\d_tester\ucssview_tree.php 
*******************************************************************************/

<?php 
(!defined('RUN_MODE')) && die('No Init');
$this->pimp(); 
?>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?act=jsTypes:cargo,brand,hinfo;jsRelat:relpb;jsFields:cargo&cmod=brand"></script> 
<script src='<?php echo PATH_ROOT; ?>/skin/a_jscss/sordbar.js?_a=1'></script>
<script src='<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?act=jsTypes:cargo,china,natcn;'></script>

<table border="1" align="center" cellpadding="5" cellspacing="5">
    <tr>
        <td colspan="2" align="center" valign="top"><a href="?">[Refresh]</a></td>
    </tr>
    <tr>
        <td width="240" rowspan="2" valign="top" class="layTree1" id="tree01">layTree1</td>
        <td height="80" valign="top">
<div id="typlays"></div>
<div id="typlay2"></div>
<div id="typlay3"></div>
        </td>
    </tr>
    <tr>
        <td width="240" valign="top"><div class="layTree7" id="tree02">layTree1</div></td>
    </tr>
</table>
<script>

var tpl1 = "<p class='tree_(level) p_(pid) k_(key) (css)'>(lay)<a href='?china=(key)'>[(letter)](title)</a></p>"; 
var tpl2 = "<p class='tree_(level) p_(pid) k_(key) (css)'>(lay)<a href='?cargo=(key)'>(title)</a></p>"; 
var trees1 = sotree_init(tpl1,'china',0); $('#tree01').html(trees1); // ,'tree01'
var trees2 = sotree_init(tpl2,'cargo',0); $('#tree02').html(trees2); 

sotree_act('tree01','china',urlPara('china','c0755')); // zx,gd,c0769,tw,cmazu
sotree_open('tree02',urlPara('cargo','p2012'));  

mselInit('typlays','fmxid','china','c0769','省份,地区');
mselInit('typlay2','fmyid','china');
mselInit('typlay3','fmzid','natcn');

</script>




/*******************************************************************************
 File : \code\tpls\dev\d_tester\ucssview_w2003color.php 
*******************************************************************************/

<style>
td { font-size: 12px; }
.win2003_out1 { width: 320px; border-left: 1px solid #D4D0C8; border-top: 1px solid #D4D0C8; border-right: 1px solid #404040; border-bottom: 1px solid #404040; }
.win2003_out2 { width: 318px; border-left: 1px solid #FFF; border-top: 1px solid #FFF; border-right: 1px solid #808080; border-bottom: 1px solid #808080; }
.win2003_out3 { width: 314px; border: 2px solid #D4D0C8; }
.win2003_title { width: 294px; height: 18px; overflow: hidden; font-size: 12px; text-align: left; font-weight: bold; line-height: 18px; color: #FFF; background-color: #0A246A; padding-left: 20px; filter: Alpha(Opacity=30, FinishOpacity=100, Style=1, StartX=100, StartY=100, FinishX=0, FinishY=0); }
.win2003_menu { width: 314px; height: 19px; overflow: hidden; font-size: 12px; text-align: left; line-height: 19px; color: #000; border: 0px solid #D4D0C8; padding: 1px 0px 0px 0px; }
div.win2003_menu span { display: inline-block; padding: 0px 5px; }
.win2003_in1 { width: 312px; border-left: 1px solid #808080; border-top: 1px solid #808080; border-right: 1px solid #FFF; border-bottom: 1px solid #FFF; }
.win2003_in2 { width: 308px; height: 100px; font-size: 16px; text-align: left; line-height: 100%; background-color: #FFF; border-left: 1px solid #404040; border-top: 1px solid #404040; border-right: 1px solid #D4D0C8; border-bottom: 1px solid #D4D0C8; padding: 2px 1px; }
</style>

<table width="620" border="0" align="center" cellpadding="3" cellspacing="1" bgcolor="#CCCCCC">
    <tr>
        <td colspan="4" align="center" bgcolor="#FFFFFF"><strong>Windows 2003 配色</strong></td>
    </tr>
    <tr>
        <td width="20%" bgcolor="#E0E0E0"><font color="#000000">名Q</font></td>
        <td width="15%" bgcolor="#E0E0E0"><font color="#000000">#RRGGBB</font></td>
        <td width="15%" bgcolor="#E0E0E0">　</td>
        <td bgcolor="#E0E0E0">&nbsp;</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">Win2003背景</td>
        <td bgcolor="#FFFFFF">#3A6EA5</td>
        <td bgcolor="#3A6EA5">　</td>
        <td rowspan="8" align="center" bgcolor="#FFFFFF"><div class="win2003_out1">
                <div class="win2003_out2">
                    <div class="win2003_out3">
                        <div style="width:314px; padding:0px; background-color:#D4D0C8">
                            <div class="win2003_title">新建 文本文档.txt - 计事本</div>
                            <div class="win2003_menu"> <span>文件(F)</span> <span>编辑(E)</span> <span>格式(O)</span> <span>查看(V)</span> <span>帮助(H)</span> </div>
                            <div class="win2003_in1">
                                <textarea name="" cols="" rows="" class="win2003_in2">人生犹如"迷宫"，每个人都在其中寻找各自的"奶酪"――稳定的工作、身心的健康、和谐的人际关系、甜蜜美满的爱情，或是令人充满想象的财富……那么，你是否正在享受你的奶酪呢？</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div></td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">Win2003标题栏左</td>
        <td bgcolor="#FFFFFF">#0A246A</td>
        <td bgcolor="#0A246A">　</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">Win2003标题栏右</td>
        <td bgcolor="#FFFFFF">#A6CAF0</td>
        <td bgcolor="#A6CAF0">　</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">Win2003菜单栏</td>
        <td bgcolor="#FFFFFF">#D4D0C8</td>
        <td bgcolor="#D4D0C8">　</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">Win2003边框1</td>
        <td bgcolor="#FFFFFF">#808080</td>
        <td bgcolor="#808080">　</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">Win2003边框2</td>
        <td bgcolor="#FFFFFF">#404040</td>
        <td bgcolor="#404040">　</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">&nbsp;</td>
        <td bgcolor="#FFFFFF">#--</td>
        <td>　</td>
    </tr>
    <tr>
        <td bgcolor="#FFFFFF">&nbsp;</td>
        <td bgcolor="#FFFFFF">#--</td>
        <td>　</td>
    </tr>
</table>




/*******************************************************************************
 File : \code\tpls\dev\d_tester\ueffect_imgChange.php 
*******************************************************************************/

<?php
(!defined('RUN_MODE')) && die('No Init');
$this->pimp();
$this->pimp('/jquery/jq_imgChange.js',PATH_VENDUI);
?>

<style type="text/css">
p { padding:0px; margin:0px; }
div { margin:10px; border:1px solid #CCF; }
</style>


<div id="test21" style="width:150px; height:80px; overflow:hidden">
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2008.jpg' width="120" height="60" />logo-2008.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2009.jpg' width="120" height="60" />logo-2009.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2010.jpg' width="120" height="60" />logo-2010.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2011.jpg' width="120" height="60" />logo-2011.jpg</p>
</div>	

<div id="test22" style="width:150px; height:80px; overflow:hidden">
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2008.jpg' width="120" height="60" alt="08" />logo-2008.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2009.jpg' width="120" height="60" alt="09" />logo-2009.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2010.jpg' width="120" height="60" alt="10" />logo-2010.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2011.jpg' width="120" height="60" alt="11" />logo-2011.jpg</p>
</div>

<div style="width:130px; height:120px; overflow:hidden">
<div id="test23">
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2008.jpg' width="120" height="60" />logo-2008.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2009.jpg' width="120" height="60" />logo-2009.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2010.jpg' width="120" height="60" />logo-2010.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2011.jpg' width="120" height="60" />logo-2011.jpg</p>
</div>
</div>

<div style="width:130px; height:120px; overflow:hidden">
<div id="test24">
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2008.jpg' width="120" height="60" alt="08" />logo-2008.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2009.jpg' width="120" height="60" alt="08" />logo-2009.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2010.jpg' width="120" height="60" alt="10" />logo-2010.jpg</p>
<p><img src='<?php echo PATH_ROOT; ?>/skin/logo/logo-2011.jpg' width="120" height="60" alt="11" />logo-2011.jpg</p>
</div>
</div>

<script>

$('#test21 p').imgChange({});
// fade,turnDown,zoom,flipper,
$('#test22 p').imgChange({effect:'turnDown',changeTime:2000,speed:400,vertical:0,visible:0});
$('#test23 p').imgChange({effect:'wfScroll',steps:2,changeTime:50,vertical:0,wrapSize:180});
$('#test24 p').imgChange({effect:'wfScroll',steps:2,changeTime:50,vertical:1});
//,afterEnd:function(){jsLog('');}
function aftFunc(e){
	jsLog(e);
}
/*
$('#test22 li').imgChange({botPrev:'#prev1',botNext:'#next1',effect:'scroll',vertical:0});
$('#tab-con2 ul').imgChange({thumbObj:'#tab-tit2 li',autoChange:0,speed:0})
$('#tab-con3 ul').imgChange({thumbObj:'#tab-tit3 li',autoChange:0,speed:0})
$('#tab-con4 ul').imgChange({thumbObj:'#tab-tit4 li',autoChange:0,speed:0})
$('#tab-con .tj').imgChange({thumbObj:'#tab-tit li',speed:0,autoChange:0})

 * $('#bigimg li').imgChange({
 * thumbObj: '.tlist li',//缩略图对象;
 * botPrev: '.prev',//上一个对象;
 * botNext: '.next',//下一个对象;
 * effect: 'fade',//切换效果,效果有fade,scroll(滚动),wfScroll(无缝滚动steps:2,changeTime:50)，wb(微博),stream,turnDown,zoom,flyFade,tab,flipper,slide,cutIn,alternately
 * curClass: 'act',//当前缩略图对象的样式名
 * thumbOverEvent: 1,//鼠标悬停是否切换
 * speed: 400,//切换速度
 * autoChange: 1,//是否自动切换
 * changeTime: 5000,//自动切换时间
 * delayTime: 0,//鼠标悬停的延迟时间
 * showTxt: 0,//是否显示标题,标题调用img里的alt值
 * visible:1,//显示对象的个数
 * steps:1, //每次滚动的数量，effect==wfscroll时，每次滚动的距离
 * circular: 0,//是否循环滚动
 * vertical:1,//方向
 * easing: 'swing'//动画效果,需要easing插件支持
 * wrapSize:0,无缝滚动的外层宽度
 * beforeStart:function(){$('.txt').hide},效果执行前的函数
 * afterEnd:null,效果完成后的函数
 *})
	
*/

</script>



/*******************************************************************************
 File : \code\tpls\dev\d_tester\ueffect_zoeDylan.php 
*******************************************************************************/

<?php
(!defined('RUN_MODE')) && die('No Init');
$this->pimp();
$this->pimp('/zoeDylan/zoeDylan-1.0.1.min.js',PATH_VENDUI);
$this->pimp('/zoeDylan/zoeDylan-1.0.1.min.css',PATH_VENDUI);
?>

<center>
  <span style="font-size:15px; font-weight:bold; text-align:center; line-height:25px; color:#000; width:100%">jquery焦点图插件zoeDylan.ImgChange-1.0.1<br />
  <a href="http://www.jq-school.com" target="_blank" style="color:#000">JquerySchool</a>网站出品（<a href="http://www.jq-school.com" style="color:#000" target="_blank">http://www.jq-school.com</a>） <br />
   <a href="http://api.jq-school.com/" target="_blank" style="color:#000">在线API帮助文档</a> <br />
  <a target="_blank" href="http://wp.qq.com/wpa/qunwpa?idkey=6fcb83942dc3630777ae7745bd5093a1a5917f915f4e95cfc498633379ebfbb4">官方网站学习交流QQ群<img border="0" src="http://pub.idqqimg.com/wpa/images/group.png" style="width:90px; height:22px;" alt="Jquery学堂QQ⑤群" width="90" height="22" title="Jquery学堂QQ⑤群"></a></span>
</center>

<div id="img" ></div>
<hr />
<div id="img2"></div>
<hr />
<div id="img3"></div>
    
<script>
var a_imgs = new Array(//插入图片地址
	'http://ww1.sinaimg.cn/mw690/adde8400gw1ebwz3igq33j20fk08pwfu.jpg',
	'http://ww1.sinaimg.cn/mw690/adde8400gw1ebvqqzln0uj20ex09774z.jpg',
	'http://ww2.sinaimg.cn/mw690/adde8400gw1ebn1vuhpzcj20k00agq4v.jpg',
	'http://ww4.sinaimg.cn/mw690/adde8400gw1ebn1vqhh67j20k00aggo0.jpg'
),
a_links = new Array(//点击图片跳转的网址
	'www.jq-school.com',
	'www.jq-school.com',
	'www.jq-school.com',
	'www.jq-school.com'
),
a_tips = new Array(//鼠标停靠的提示
	'百度',
	'腾讯',
	'谷歌',
	'中关村'
);
$(function () {
	$('#img').zoeDylan_ImgChange({
		background: '#f60', //前景色
		color: '#fff', //高
		height: '300px',//宽
		width: '500px',//图片地址数组
		imgLinks:a_imgs,//图片内容
		imgCont:a_tips,//图片提示
		imgTips: a_tips,//图片点击
		imgClick:a_links,//是否等比例缩放
		isConstrain: true,//是否开启自动切换
		isAutoChange: true,//是否显示控制器
		isControl: true,//是否显示图片信息
		isInfo: true,//是否开启图片点击事件
		isClick: true,//是否显示缩略图控件
		isThumbnail: true,//自动切换时间(毫秒)
		timer: 1500,//切换速度(毫秒)
		speed: 300,
		direction: 'l'
	});
	$('#img2').zoeDylan_ImgChange({
		background: 'none', //前景色
		color: '#fff', //高
		height: '300px',//宽
		width: '100%',//图片地址数组
		imgLinks: a_imgs,//图片内容
		imgCont: a_tips,//图片提示
		imgTips: new Array(),//图片点击
		imgClick: new Array(),//是否等比例缩放
		isConstrain: false,//是否开启自动切换
		isAutoChange: true,//是否显示控制器
		isControl: true,//是否显示图片信息
		isInfo: false,//是否开启图片点击事件
		isClick: false,//是否显示缩略图控件
		isThumbnail: false,//自动切换时间(毫秒)
		timer: 1200,//切换速度(毫秒)
		speed: 800,
		direction:''
	});
	$('#img3').zoeDylan_ImgChange({
		background: 'none', //前景色
		color: '#fff', //高
		height: '100px',//宽
		width: '300',//图片地址数组
		imgLinks: a_imgs,//图片内容
		imgCont: a_tips,//图片提示
		imgTips: new Array(),//图片点击
		imgClick: new Array(),//是否等比例缩放
		isConstrain: false,//是否开启自动切换
		isAutoChange: true,//是否显示控制器
		isControl: true,//是否显示图片信息
		isInfo: false,//是否开启图片点击事件
		isClick: false,//是否显示缩略图控件
		isThumbnail: false,//自动切换时间(毫秒)
		timer: 1200,//切换速度(毫秒)
		speed: 800,
		direction: ''
	});
});
</script>


/*******************************************************************************
 File : \code\tpls\dev\d_tester\uexlib_elmhtml.php 
*******************************************************************************/
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title>采集测试(文章标题)</title>
</head><body>
<div class="header">header</div>
<nav id="menu">menu</nav>
<div id="detail" class="abc">
    <div id="paras" class="uef">
        <li class="cls1">品牌：华为</li>
        <li class="cls1">颜色：黑/白/灰</li>
        <li class="cls1">内存：1024M</li>
        <li class="cls1"><i>型号:</i><b class='itm-text'>{$xinghao} </b></li>
        <li class="cls2"><i>规格<li><li></li></li>:</i><b class='itm-text'>{$guige} </b></li>
        <li class="cls3"><i>价格:</i><b class='itm-text'>{$price}(元) 批量价</b></li>
    </div>
    <div class="content">
        <p class="cls1">这里有很多内容……</p>
        detail
        <div class="content">class="content"</div>
        <div id="abcx" class="abcx">id="abcx"</div>
        <div>test1</div>
        <div>test2</div>
        <div>test3</div>
        <p class="cls1">这里有很多内容……</p>
    </div>
</div>
<div id="link" class="efg">
    <li><a href="?mkv=tester-frame" target="_blank">[测试首页Index]</a></li>
    <li><a href="#tester" target='frame_01'>测试代码 : basic基本类库</a></li>
    <li><a href="#tester-exlib" target=aaaa>测试代码 : exlib扩展类库</a></li>
    <li><a href="#tester-vendor">测试代码 : vendor第三方组件</a></li>
    <li><a href="#tester-api3rd">测试代码 : api3rd第三方接口</a></li>
    <li><a href="#tester-jqjs">测试代码 : jQuery &amp; js</a></li>
    <li><a href="#tester-effect">测试代码 : effect 效果</a></li>
    <li><a href="#tester-cssview">测试代码 : css显示样式</a></li>
</div>
<div id="test" class="efg">
    <li><a href='http://txjia.com/kgfood/vgb/about.asp'>广州市科冠食品有限公司</a></li>
    <li><a href='http://txjia.com/kgfood/img/about.jpg'>科冠食品about.jpg</a></li>
    <li><a href='#tester-单引号'>测试代码 : '</a></li>
    <li><a href="#tester-双引号">测试代码 : "</a></li>
    <li><a href=#tester-空格 se>测试代码 : 空格1</a></li>
    <li><a href=#tester-空格>测试代码 : 空格2</a></li>
    
</div>
<div> {tag:nrlist=[Page][modid,$this->mod][pid,$pid][testa=tesetval][keywd,0,title+detail][limit,50]} </div>
<table witdh='240'>
</table>
<div class="footer" class="ijk">
footer
</div>
</body></html>



/*******************************************************************************
 File : \code\tpls\dev\d_tester\uexlib_elmtest.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
$data = comFiles::get(dirname(__FILE__).'/uexlib_elmhtml.php');
//echo $data;

/*
$data = '{block:abody}abody{/block:abody}';
$key = 'abody';
$k1 = "{block:$key}"; $k2 = "{/block:$key}";
$val = basElm::getVal($data,array($k1,$k2)); echo "\n\n<hr>abody:val:\n$val\n";
*/

$val = basElm::getVal($data,'title'); echo "\n\n<hr>title-val:\n$val\n";
$val = basElm::getPos($data,'title'); echo "\n\n<hr>title-pos:\n$val\n";

$val = basElm::getVal($data,'id="link"(*)id="test"','->'); echo "\n\n<hr>val:\n$val>>>\n";
$val = basElm::getPos($data,'id="link"(*)id="test"'); echo "\n\n<hr>pos:\n$val>>>\n";

$val = basElm::getVal($data,'<div class="content">(*)</div>'); echo "\n\n<hr>val2:\n$val>>>\n";
$val = basElm::getPos($data,'<div class="content">(*)id="link"'); echo "\n\n<hr>pos2:\n$val>>>\n";
$val = basElm::getPos($data,'<div class="content">(*)</div>'); echo "\n\n<hr>pos3:\n$val>>>\n";

$val = basElm::getPos($data,'id="xnon15"(*)id="xnon32"'); echo "\n\n<hr>pos4:\n$val>>>\n";

$arr = basElm::getArr($data,'<li class(*)</li>'); echo "\n\n<hr>getArr:\n"; print_r($arr); echo "\n";
$arr = basElm::getPreg($data,'<li class="cls1">(*)</li>'); echo "\n\n<hr>getPreg:\n"; print_r($arr); echo "\n"; 

$arr = basElm::getAttr($data,'target','key'); echo "\n\n<hr>getArr-a:\n"; print_r($arr); echo "\n"; 
$val = basElm::getAttr($data,'target','key',1); echo "\n\n<hr>getAttr-no:\n$val\n";
$arr = basElm::getAttr($data,'noattr','key'); echo "\n\n<hr>getArr-a:\n"; print_r($arr); echo "\n"; 

$val = basElm::getAttr($data,'witdh','key',0); echo "\n\n<hr>getAttr-witdh:\n$val\n";
$arr = basElm::getAttr($data,'href','url'); echo "\n\n<hr>getArr-urls:\n"; print_r($arr); echo "\n"; 

/*

匹配标记：
匹配模式：Html标签(单个内容), 两点定位(单个内容), Html标签数组(或单个), Html标签正则(或单个), 属性数组(或单个)
扩展操作：获取网址内容[url:fatch]，获取远程图片[save:image]


内容来源页面 	
字段内容采集模印

清除Html
替换信息来源内容
替换信息=>结果内容

结果处理函数

exd_psyn : fskip

fskip 从字段配置中剔除的字段
fdefs 内置字段或配置字段

orgtag1	varchar(255) []	 
orgtag2	varchar(255) []	 
orgtag3	varchar(255) []	 

dealfmts	varchar(255) []	 note,blank,html,strtotime,
dealtabs    varchar(255)     替换来源内容=空
dealconv	varchar(24) []	 a=b
dealfunc	varchar(48) []	 结果处理函数 
defval	varchar(255) []	 
defover	tinyint(4) [0]	

http://127.0.0.1/08tools/yssina/1/root/run/dev.php?mkv=tester-frame&code=uexlib_elmtest
view-source:http://127.0.0.1/08tools/yssina/1/root/run/dev.php?mkv=info-coder&tpls=d_tester/ubasic_baselm.php

modeVal(:)<title>(^)</title>  
  //  getVal($xStr,$flag) <title>采集测试(文章标题)</title>

modeArr(:)<td class="tc1">(*)</td>(^)3 
  // getArr($xStr,$flg1,$flg2) 从一组<td class="tc1">内容xxx</td>中，取第3个

modePos(:)id="rollImg01"(^)id="linknav"(^)+5(^)-10
modePos(:)id="rollImg01"(^)id="linknav"(^)+<td(^)-</div>

modeAttr(:)width(^)key  
  // getAttr($str,$flag,$reg='key') <td width="24">

(:)url:fatch
(:)save:image
  
*/

?>

<hr>






/*******************************************************************************
 File : \code\tpls\dev\d_tester\uexlib_pagebar.php 
*******************************************************************************/
pagebar ::: test:
<br />
{tag:demo2=[Page][modid,demo][keywd,e,title+mname][limit,3]}
{:row}
<li><a href="{surl("demo.$t_did")}">{$t_title} --- {stime($t_atime)}</a></li>
{/row}
{php echo $_cbase['page']['bar']; }
{/tag:demo2}


/*******************************************************************************
 File : \code\tpls\dev\d_tester\ujqjs_passStrength.php 
*******************************************************************************/

<?php
(!defined('RUN_MODE')) && die('No Init');

$this->pimp();
$this->pimp('/jquery/jquery.passwordStrength.js',PATH_VENDUI);
$this->pimp('/skin/a_jscss/jstyle.css','');
?>

<h3>
<a href="http://www.helloweba.com/view-blog-50.html">密码强度检测：passwordStrength</a>
</h3>
<p>
  <label>请输入密码：</label>
  <input type="password" id="pass" />
  <span id="passwordStrengthDiv" class="psc_is00"></span> 
  <br />
  <label>确认密码：</label>
  <input type="password" id="repass" />
</p>
<p>
注意：id#passwordStrengthDiv的DIV是用来加载强度图片的，你也可以自定义ID，<br />
但调用时就要给参数赋值：targetDiv : '#ID' //自定义加载图片的ID<br />
</p>
<script>
$(function(){
	$('#pass').passwordStrength();
});
</script>
<div>
  <p>Powered by <a href="http://www.helloweba.com">www.helloweba.com</a></p>
</div>



/*******************************************************************************
 File : \code\tpls\dev\d_tester\uvendor_DatePicker.php 
*******************************************************************************/
<?php (!defined('RUN_MODE')) && die('No Init');?>
<script src="<?php echo PATH_VENDUI; ?>/My97DatePicker/WdatePicker.js"></script>

<p>
  <input class="Wdate" type="text" onclick="WdatePicker()">
  <font color=red>&lt;- 点我弹出日期控件</font></p>
<p>更多demo请访问官方主页<a href="http://www.my97.net">http://www.my97.net</a><br>
  <br>
</p>
<h1>请务必仔细阅读下面的文字</h1>
<pre>
注意:此版本为 4.8 Beta2 build 20111221


*** 更新内容:  ---------------------------------------------------------------------
[新增]preload预载选项
[增强]验证功能可被关闭errDealMode=-1
[修改]调整周算法模式,新增weekMethod属性
[修改]去除My97DatePicker.htm
[修改]position改成相对坐标(原来为绝对坐标)
[修正]跨域错误问题
[修正]onchange不能触发的问题
[修正]兼容Safari5
[修正]&lt;script&gt;空标签时的错误
[修正]平面模式下的几个偶发问题
[修正]双月日历下跨年选择出错的问题
[修正]修正复杂iframe下,弹出位置偏移的问题(很偶发的情况)


*** 使用方法:  ---------------------------------------------------------------------

1. 去官方网站看看,你当前下载的是否是最新的版本,很多bug都是因为使用的不是最新版本造成的
   官方主页:<a href="http://www.my97.net" target="_blank">http://www.my97.net</a>
2. 将My97DatePicker整个目录包,放入您的项目的相应目录下
  My97DatePicker目录下各文件的作用:
  1.1 My97DatePicker目录是一个整体,不可破坏里面的目录结构,也不可对里面的文件改名,可以改目录名
  1.2 各目录及文件的用途:
    WdatePicker.js 配置文件,在调用的地方仅需使用该文件,可多个共存,以xx_WdatePicker.js方式命名
    calendar.js 日期库主文件,无需引入
    目录lang 存放语言文件,你可以根据需要清理或添加语言文件
    目录skin 存放皮肤的相关文件,你可以根据需要清理或添加皮肤文件包
3. 您可以根据您自己的需要,删除不必要的皮肤和语言文件
4. 您可以根据您自己的需要,添加新的皮肤包
   皮肤中心地址:<a href="http://www.my97.net/dp/skin.asp" target="_blank">http://www.my97.net/dp/skin.asp</a>
5. 详细阅读在线演示和使用说明,大部分问题都可以通过这里解决,请细看
   在线演示:<a href="http://www.my97.net/dp/demo/" target="_blank">http://www.my97.net/dp/demo/</a>
6. 如果遇到无法解决的问题
   请先参考:<a href="http://www.my97.net/dp/support.asp" target="_blank">http://www.my97.net/dp/support.asp</a>
7. 如果遇到问题,而技术支持页面无法解决的
   您可以通过技术支持页面中提供的联系方式联系我,注意:问问题时,一定要附上相关的HTML代码和详细的错误信息
8. 您有什么意见或建议,你可以通过技术支持页面中提供的联系方式联系我
9. 如果您对日期控件的许可协议有兴趣,您可以访问:<a href="http://www.my97.net/dp/license.asp">http://www.my97.net/dp/license.asp</a>
10.最后祝大家项目顺利,月月加薪!


*** 官方主页 ---------------------------------------------------------------------
<a href="http://www.my97.net" target="_blank">http://www.my97.net</a>
在线演示和使用说明
<a href="http://www.my97.net/dp/demo/" target="_blank">http://www.my97.net/dp/demo/</a>
皮肤中心:
<a href="http://www.my97.net/dp/skin.asp" target="_blank">http://www.my97.net/dp/skin.asp</a>
许可协议
<a href="http://www.my97.net/dp/license.asp">http://www.my97.net/dp/license.asp</a>  
源代码:
<a href="http://www.my97.net/dp/source.asp" target="_blank">http://www.my97.net/dp/source.asp</a>
技术支持页面
<a href="http://www.my97.net/dp/support.asp" target="_blank">http://www.my97.net/dp/support.asp</a></pre>



/*******************************************************************************
 File : \code\tpls\dev\d_tools\a_cfgs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$cfgs = array(

	'schulte' => array(
		'title' => '舒尔特方格 (Schulte Grid) ',
		'rem' => '在一张方形卡片上画上25 个方格，格子内任意填写上阿拉伯数字 1 ~ 25 等共 25 个数字；测试幼儿注意力水平。',
		'mt' => '舒尔特方格',
	),

	'ipaddr' => array(
		'title' => 'IP转化地址类（IPv4）',
		'rem' => '接口：Local(本地纯真IP数据库)，Sina，Pcoln(太平洋接口)，Taobao(淘宝接口)，Ip138，S1616',
		'mt' => 'IP转地址类',
	),
	
	'cnconv' => array(
		'title' => '简繁转化（js/php）',
		'rem' => '简繁转化接口',
		'mt' => '简繁转化',
	),

	'seal' => array(
		'title' => 'PHP印章制作DIY',
		'rem' => 'PHP印章在线制作，用于在线办公，电子签名等场合',
		'mt' => 'PHP印章制作',
	),
	
	'qrcode' => array(
		'title' => '二维码生成器（QRCODE）',
		'rem' => '二维码生成器，二维码在线制作',
		'mt' => '二维码生成器',
	),
	
	'vimg' => array(
		'title' => '电话/邮箱:敏感信息图片显示',
		'rem' => '电话/邮箱:敏感信息图片显示，认证码显示',
		'mt' => '电话图片显示',
	),
	
	'shapan' => array(
		'title' => '沙盘-图片中显示自定义沙盘点',
		'rem' => '沙盘，在图片(地图)中显示热点(自定义沙盘)坐标点',
		'mt' => '地图中的沙盘',
	), // shapan (temp_480x200.jpg) (\vimp\static\media\cover)
	
	'spword' => array(
		'title' => '中文分词-关键词提取',
		'rem' => '中文分词，关键词提取',
		'mt' => '中文分词',
	),
	
	'wmark' => array(
		'title' => '图片水印，文字描边水印',
		'rem' => '图片水印，文字描边水印',
		'mt' => '水印描边',
	),
	
	'chrcom' => array(
		'title' => '常用字符集',
		'rem' => '按类别，整理收集常用字符集',
		'mt' => '常用字符集',
	),
	
	'chrall' => array(
		'title' => 'FFFF全字符集',
		'rem' => '0000~FFFF，共65536个全字符集',
		'mt' => 'FFFF全字符集',
	),	
	
);

/*
top域名, 常用字符集
FFFF全字符集

安全专题.随机表单.Url签名, 
*/

//用于首页对齐的链接
$cfgs_ext = array(
    'dedecms' => array(
		'mt' => 'DEDE织梦(CMS)',
		'url' => 'http://dedecms.com/',
	),
    'destoon' => array(
		'mt' => 'Destoon(B2B)',
		'url' => 'http://www.destoon.com/product/',
	),
);

/*
    'kindsoft' => array(
		'mt' => 'KindEditor',
		'url' => 'http://www.kindsoft.net/down.php',
	),
    'ueditor' => array(
		'mt' => 'UEditor',
		'url' => 'http://ueditor.baidu.com/',
	),
*/




/*******************************************************************************
 File : \code\tpls\dev\d_tools\a_chun.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
?>
<meta charset="utf-8">

<p>春 朱自清 </p>
<p>盼望着，盼望着，东风来了，春天的脚步近了。 </p>
<p>一切都像刚睡醒的样子，欣欣然张开了眼。山朗润起来了，水涨起来了，太阳的脸红起来了。 </p>
<p>小草偷偷地从土地里钻出来，嫩嫩的，绿绿的。园子里，田野里，瞧去，一大片一大片满是的。坐着，躺着，打两个滚，踢几脚球，赛几趟跑，捉几回迷藏。风轻俏俏的，草软绵绵的。 </p>
<p>桃树，杏树，梨树，你不让我，我不让你，都开满了花赶趟儿。红的像火，粉的像霞，白的像雪。花里带着甜味；闭了眼，树上仿佛已经满是桃儿，杏儿，梨儿。花下成千成百的蜜蜂嗡嗡的闹着，大小的蝴蝶飞来飞去。野花遍地是：杂样儿，有名字的，没名字的，散在草丛里像眼睛像星星，还眨呀眨。 </p>
<p>“吹面不寒杨柳风”，不错的，像母亲的手抚摸着你，风里带着些心翻的泥土的气息，混着青草味儿，还有各种花的香，都在微微润湿的空气里酝酿。鸟儿将巢安在繁花嫩叶当中，高兴起来，呼朋引伴的卖弄清脆的歌喉，唱出婉转的曲子，跟清风流水应和着。牛背上牧童的短笛，这时候也成天嘹亮的响着。 </p>
<p>雨是最寻常的，一下就是三两天。可别恼。看，像牛牦，像花针，像细丝，密密的斜织着，人家屋顶上全笼着一层薄烟。树叶却绿得发亮，小草也青得逼你的眼。傍晚时候，上灯了，一点点黄晕的光，烘托出一片安静而和平的夜。在乡下，小路上，石桥边，有撑着伞慢慢走着的人，地里还有工作的农民，披着所戴着笠。他们的房屋稀稀疏疏的，在雨里静默着。 </p>
<p>天上的风筝渐渐多了，地上的孩子也多了。城里乡下，家家户户，老老小小，也赶趟似的，一个个都出来了。舒活舒活筋骨，抖擞抖擞精神，各做各的一份事儿去。“一年之计在于春”，刚起头儿，有的是功夫，有的是希望 </p>
<p>春天像刚落地的娃娃，从头到脚都是新的，它生长着。 <br>
    春天像小姑娘，花枝招展的笑着走着。 <br>
    春天像健壮的青年，有铁一般的胳膊和腰脚，领着我们向前去。</p>



/*******************************************************************************
 File : \code\tpls\dev\d_uplog\a_cfgs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$cfgs = array(
	'readme' => array('[通用]更新说明','readme'),
	//'8_8' => array('发布预告：2088-V8.8','8.8'),
	'3_4' => array('下版本3.4发布预告','3.4'),
	'3_3' => array('2016.0917','3.3'),
	'3_2' => array('2016.0625','3.2'),
	'3_1' => array('2016.0410','3.1'),
	'3_0' => array('2015.1225','3.0'),
	'2_x' => array('回忆录 / 发布提示','2.x'),
);




/*******************************************************************************
 File : \code\tpls\dev\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\tpls\dev\_config\va_docs.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_va_docs = array(

	//config配置
	'c' => array(
		'vmode' => 'close', //dynamic,static,close
		'stext' => '.shtm', //后缀
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\dev\_config\va_home.php 
*******************************************************************************/
<?php
/*
 * 首页模板和通用配置
/*/
$_va_home = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close(关闭)
		'stext' => '.shtm', //后缀: .html, .htm, .shtm, -a.htm, -m.htm, .shtml, .stm,
		'stexp' => '2h', //静态更新周期：600s,30,2h,24h,7d, 默认单位为分钟
	),
	
	//mod.home模块首页模板
	'm' => 'c_page/_home',
	
	//关闭模块
	'close' => array('indoc','about'),
	//文档/资讯:默认按va_docs设置
	//其他未设置模块按关闭处理
	
	//import导入配置的模块(import不支持静态)
	'imcfg' => array(
        //'gbook' => 'nrem', // gbook按nrem方式显示
		'crem' => 'nrem', 
		'trem' => 'nrem',
		'kerem' => 'nrem',
		'drem' => 'nrem',
		//文档/资讯 => 默认按va_docs.php配置
	),
	
	//扩展模块
	'extra' => array(
		'home','info','tools',
		'start','tester','tpltag','dev2nd','advset','uplog' //'coder',
	), 

);



/*******************************************************************************
 File : \code\tpls\dev\_config\vc_demo.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_demo = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.shtm', //后缀
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\dev\_config\vc_nrem.php 
*******************************************************************************/
<?php
/*
...
*/
$_vc_nrem = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,cache,close
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => array(
		'0' => 'c_mod/remark_list', //{mod},
		'list' => 'c_mod/remark_list',
	), //'m' => 'c_mod/news_list',
	//'d' => 'c_mod/news_detail',
	//'t' => 'c_mod/news_list',

);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_advset.php 
*******************************************************************************/
<?php
/*
 * advset扩展信息模板配置
/*/
$_ve_advset = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/advset_basic',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'expara' => 'c_demo/advset_basic',
	'fields' => 'c_demo/advset_basic',
	'docs' => 'c_demo/advset_basic',
	'user' => 'c_demo/advset_basic',
	'else' => 'c_demo/advset_basic',
	
	'exdata' => 'c_demo/advset_basic',
	'explan' => 'c_demo/advset_basic',
);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_dev2nd.php 
*******************************************************************************/
<?php
/*
 * dev2nd扩展信息模板配置
/*/
$_ve_dev2nd = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/dev2nd_basic',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'ucode' => 'c_demo/dev2nd_basic',
	'ucodb' => 'c_demo/dev2nd_basic',
	'suit' => 'c_demo/dev2nd_basic',
	
	'editor' => 'c_demo/dev2nd_basic',
	'sms' => 'c_demo/dev2nd_basic',
	'i18n' => 'c_demo/dev2nd_basic',

);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_info.php 
*******************************************************************************/
<?php
/*
 * info扩展信息模板配置
/*/
$_ve_info = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm'     => 'c_page/info_snav', //站点导航
	
	'gbook'  => 'c_page/info_gbook', //gbook
	'coder'  => 'c_page/info_coder', //coder
	'help'  => 'c_page/info_help', //help
	
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	
	/*
	'nav' => 'c_page/info_nav', //站点导航
	'nvb' => 'c_page/info_nvb', //Baidu Url
	'nvg' => 'c_page/info_nvg', //GoobleUr
	'map' => 'c_page/info_map', //公司地图
	'ext' => 'c_test/demo_extend', //extend,tpl-inherit:block,layout,parent,
	'tag' => 'c_test/info_tag', //Test-tag，
	'tjs' => 'c_test/info_tjs', //Test-js
	*/
	
);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_start.php 
*******************************************************************************/
<?php
/*
 * start扩展信息模板配置
/*/
$_ve_start = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/start_main',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'files' => 'c_demo/start_files',
	'udirs' => 'c_demo/start_main', 
	'class' => 'c_demo/start_sdict',
	'dbtab' => 'c_demo/start_sdict',
	
);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_tester.php 
*******************************************************************************/
<?php
/*
 * tester扩展信息模板配置
/*/
$_ve_tester = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'c_demo/tester_basic',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'jqjs' => 'c_demo/tester_basic',
	'effect' => 'c_demo/tester_basic',
	'cssview' => 'c_demo/tester_basic',
	'exlib' => 'c_demo/tester_basic',
	'vendor' => 'c_demo/tester_basic',
	'api3rd' => 'c_demo/tester_basic',
	
	'frame' => 'c_demo/tester_frame',

);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_tools.php 
*******************************************************************************/
<?php
/*
 * tools扩展信息模板配置
/*/
$_ve_tools = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'd_tools/b_home',
	'index' => 'd_tools/b_index',

	'ipaddr' => 'd_tools/tools_ipaddr',
	'cnconv' => 'd_tools/tools_cnconv',
	'seal'   => 'd_tools/tools_seal',
	'qrcode' => 'd_tools/tools_qrcode',
	'vimg'   => 'd_tools/tools_vimg',
	'shapan' => 'd_tools/tools_shapan',
	
	'spword' => 'd_tools/tools_spword',
	'wmark' => 'd_tools/tools_wmark',
	
	'chrcom' => 'd_tools/tools_chrcom',
	'chrall' => 'd_tools/tools_chrall',
	
	'schulte' => 'd_tools/tools_schulte',

);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_tpltag.php 
*******************************************************************************/
<?php
/*
 * tpltag扩展信息模板配置
/*/
$_ve_tpltag = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/tpltag_main',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'tagbase' => 'c_demo/tpltag_main',
	'tagjs' => 'c_demo/tpltag_main',
	'tplsuit' => 'c_demo/tpltag_main', //tplsuit
	
	'hello' => 'd_tpltag/demo_hello', 
	'demotag' => 'd_tpltag/demo_tag', 
	'demotjs' => 'd_tpltag/demo_tjs', 
	
	
);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_type.php 
*******************************************************************************/
<?php
/*
 * type扩展信息模板配置
/*/
$_ve_type = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_page/type_indep',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'world' => 'c_page/type_china',
	'auto' => 'c_page/type_china', 
	
);



/*******************************************************************************
 File : \code\tpls\dev\_config\ve_uplog.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
/*
 * uplog扩展信息模板配置
/*/
$_ve_uplog = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/uplog_main',
	'd' => 'c_demo/uplog_main',
	//'t' => 'c_mod/{mod}_one', //about,alink
	
	/*
	...... (这里不用定义,有如下a_cfgs.php文件定义)
	'3_2' => 'c_demo/uplog_main', 
	'3_1' => 'c_demo/uplog_main',
	'3_0' => 'c_demo/uplog_main', 
	'2_x' => 'c_demo/uplog_main', 
	*/
	
);

include(dirname(dirname(__FILE__)).'/d_uplog/a_cfgs.php');
foreach ($cfgs as $key => $v) {
	if(preg_match("/\d{1}_\w{1}/",$key)){
		$_ve_uplog[$key] = 'c_demo/uplog_main';
	}
}



/*******************************************************************************
 File : \code\tpls\doc\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();

	static function init($obj){
		global $_cbase;
		$_cbase['sys_name'] = 'IntimateCat(贴心猫)';
		if(!empty($_cbase['login_dev'])){
			$user = usrBase::userObj(); $msg = '';
			if(empty($user)){
				$msg = 'Need '.($_cbase['login_dev']=='adminer' ? 'adminer' : '').' Login!';
			}elseif($_cbase['login_dev']=='adminer' && $user->userType!='adminer'){
				$msg = 'Need adminer Login!';
			}
			if($msg){
				glbHtml::page('Need Login!');
				glbHtml::page('body');
				echo "\n<p>$msg</p>\n";
				glbHtml::page('end');
			}
		}else{
			$user = NULL;
		}
		return $user;
	}
	
	static function pend(){
		$tpl = cfg('tpl');
		$base = $tpl['tplpend'];
		$ext = $tpl['tplpext'];
		$base || $base = 'jstag,menu,aheight';
		$js = "setTimeout(\"jcronRun()\",3700);\n";
		strstr($base,'jstag') && $js .= "jtagSend();\n";
		strstr($base,'menu') && $js .= "jsactMenu();\n";
		strstr($base,'aheight') && $js .= "js_aheight();\n";
		$ext && $js .= "$ext;\n";
		echo basJscss::jscode($js)."\n";
	}
	
	static function coder($tpl=''){ 
		$path = vopTpls::path('tpl',1); //echo 'xxx '.basename($obj->tplname);
		$file = "$path/$tpl".(strpos($tpl,'.php') ? '' : cfg('tpl.tpl_ext'));
		if(!file_exists($file)) return '';
		$code = comFiles::get($file);
		$code = highlight_string($code,1);
		return $code;
	}
	
	static function docer($mkey=''){ 
		$path = vopTpls::path('tpl',1);
		$file = "$path/$mkey.txt"; 
		if(!file_exists($file)) return array();
		$re = array(); $key=''; 
		$text = comFiles::get($file); 
		$text = extMkdown::pdext($text);
		$arr = explode('<h1>',$text);
		foreach($arr as $block){ 
			if(empty($block)) continue;
			$b = explode('</h1>',$block); //echo $block;
			$c = explode('#',$b[0]); //echo $c[0].'::'.$c[1].'::'.$b[1];
			if(empty($c[0]) || empty($c[1]) || empty($b[1])) continue;
			$key = $c[0];
			$re[$key]['title'] = $c[1];
			$re[$key]['detail'] = self::filter($b[1]);
		} 
		return $re;
	}
	
	static function lister($key=''){ 
		$path = vopTpls::path('tpl',1)."/d_tester/"; 
		$re = comFiles::listDir($path);
		$re = $re['file']; $re2 = array();
		foreach($re as $k=>$v){
			if(empty($key) && substr($k,0,1)=='u'){
				$re2[] = str_replace(array('.php'),array(''),$k);
			}elseif(strstr($k,"u{$key}_")){
				$re2[] = str_replace(array('.php'),array(''),$k);
			}
		} //print_r($re); echo $key;
		return $re2;
	}
	
	static function filter($str){ 
		$svr = cfg('server');
		$a1 = array(
			"{svrtxmao}","{svrtxcode}","{svrtxjia}",
			'{static}','{pathpro}',
		);
		$a2 = array(
			$svr['txmao'],$svr['txcode'],
			PATH_STATIC,PATH_PROJ,
		);
		$str = str_replace($a1,$a2,$str);
		return $str;
	}
	
	static function texter($key='',$conv=1,$ptpl=''){ 
		$path = $ptpl ? DIR_CODE."/tpls/$ptpl" : vopTpls::path('tpl',1);
		$file = "$path/$key"; //echo $file;
		if(!file_exists($file)) return '';
		$data = comFiles::get($file);
		$conv && $data = comConvert::autoCSet($data,'gbk');
		return $data;
	}
	
	
}



/*******************************************************************************
 File : \code\tpls\doc\b_func\tex_devs.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_devs{ //extends tex_base
	
	static $dcfg = array('basic','main',); //'base','frame'
	static $data = array();

	#protected $prop1 = array();
	
	static function getKeyTitle($mod,$key){
		if(empty(self::$data[$mod])){
			foreach (self::$dcfg as $mkey) {
				$data = comFiles::get(vopTpls::pinc("c_demo/{$mod}_{$mkey}",'.tpl.htm'));
				if($data){
					self::$data[$mod] = $data;
					break;
				}
			}
		}
		$data = self::$data[$mod]; //dump($data);
		// 	'tplsuit' => '整套模版',
		preg_match_all("/['|\"]{1}{$key}['|\"]{1}\s*\=\>\s*['|\"]{1}([^\']+)['|\"]{1}\,/is", $data, $m);
		$re = empty($m[1][0]) ? "[$key]" : $m[1][0]; //dump($m);
		return $re;
	}

}



/*******************************************************************************
 File : \code\tpls\doc\d_uplog\a_cfgs.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');

$cfgs = array(
	'readme' => array('[General] Update Notes','readme'),
	//'8_8' => array('发布预告：2088-V8.8','8.8'),
	'3_4' => array('Release Forecast(3.4)','3.4'),
	'3_3' => array('2016.0917','3.3'),
	'3_2' => array('No English Version','3.2'),
);




/*******************************************************************************
 File : \code\tpls\doc\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\tpls\doc\_config\va_docs.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_va_docs = array(

	//config配置
	'c' => array(
		'vmode' => 'close', //dynamic,static,close
		'stext' => '.shtm', //后缀
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\doc\_config\va_home.php 
*******************************************************************************/
<?php
/*
 * 首页模板和通用配置
/*/
$_va_home = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close(关闭)
		'stext' => '.shtm', //后缀: .html, .htm, .shtm, -a.htm, -m.htm, .shtml, .stm,
		'stexp' => '2h', //静态更新周期：600s,30,2h,24h,7d, 默认单位为分钟
	),
	
	//mod.home模块首页模板
	'm' => 'c_page/_home',
	
	//关闭模块
	'close' => array('indoc','about'),
	//文档/资讯:默认按va_docs设置
	//其他未设置模块按关闭处理
	
	//import导入配置的模块(import不支持静态)
	'imcfg' => array(
        //'gbook' => 'nrem', // gbook按nrem方式显示
		'crem' => 'nrem', 
		'trem' => 'nrem',
		'kerem' => 'nrem',
		'drem' => 'nrem',
		//文档/资讯 => 默认按va_docs.php配置
	),
	
	//扩展模块
	'extra' => array(
		'home','info',
		'start','uplog','tpltag','dev2nd','advset' // 'tester',
	), 

);



/*******************************************************************************
 File : \code\tpls\doc\_config\vc_demo.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_demo = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.shtm', //后缀
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\doc\_config\vc_nrem.php 
*******************************************************************************/
<?php
/*
...
*/
$_vc_nrem = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,cache,close
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => array(
		'0' => 'c_mod/remark_list', //{mod},
		'list' => 'c_mod/remark_list',
	), //'m' => 'c_mod/news_list',
	//'d' => 'c_mod/news_detail',
	//'t' => 'c_mod/news_list',

);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_advset.php 
*******************************************************************************/
<?php
/*
 * advset扩展信息模板配置
/*/
$_ve_advset = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/advset_basic',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'expara' => 'c_demo/advset_basic',
	'fields' => 'c_demo/advset_basic',
	'docs' => 'c_demo/advset_basic',
	'user' => 'c_demo/advset_basic',
	'else' => 'c_demo/advset_basic',
	
	'exdata' => 'c_demo/advset_basic',
	'explan' => 'c_demo/advset_basic',
);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_dev2nd.php 
*******************************************************************************/
<?php
/*
 * dev2nd扩展信息模板配置
/*/
$_ve_dev2nd = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/dev2nd_basic',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'ucode' => 'c_demo/dev2nd_basic',
	'ucodb' => 'c_demo/dev2nd_basic',
	'suit' => 'c_demo/dev2nd_basic',
	
	'editor' => 'c_demo/dev2nd_basic',
	'sms' => 'c_demo/dev2nd_basic',
	'i18n' => 'c_demo/dev2nd_basic',

);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_info.php 
*******************************************************************************/
<?php
/*
 * info扩展信息模板配置
/*/
$_ve_info = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm'     => 'c_page/info_snav', //站点导航
	
	'gbook'  => 'c_page/info_gbook', //gbook
	'coder'  => 'c_page/info_coder', //coder
	'help'  => 'c_page/info_help', //help
	
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	
	/*
	'nav' => 'c_page/info_nav', //站点导航
	'nvb' => 'c_page/info_nvb', //Baidu Url
	'nvg' => 'c_page/info_nvg', //GoobleUr
	'map' => 'c_page/info_map', //公司地图
	'ext' => 'c_test/demo_extend', //extend,tpl-inherit:block,layout,parent,
	'tag' => 'c_test/info_tag', //Test-tag，
	'tjs' => 'c_test/info_tjs', //Test-js
	*/
	
);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_start.php 
*******************************************************************************/
<?php
/*
 * start扩展信息模板配置
/*/
$_ve_start = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/start_main',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'files' => 'c_demo/start_files',
	'udirs' => 'c_demo/start_main', 
	'class' => 'c_demo/start_sdict',
	'dbtab' => 'c_demo/start_sdict',
	
);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_tpltag.php 
*******************************************************************************/
<?php
/*
 * tpltag扩展信息模板配置
/*/
$_ve_tpltag = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/tpltag_main',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'tagbase' => 'c_demo/tpltag_main',
	'tagjs' => 'c_demo/tpltag_main',
	'tplsuit' => 'c_demo/tpltag_main', //tplsuit
	
	'hello' => 'd_tpltag/demo_hello', 
	'demotag' => 'd_tpltag/demo_tag', 
	'demotjs' => 'd_tpltag/demo_tjs', 
	
	
);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_type.php 
*******************************************************************************/
<?php
/*
 * type扩展信息模板配置
/*/
$_ve_type = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_page/type_indep',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	'world' => 'c_page/type_china',
	'auto' => 'c_page/type_china', 
	
);



/*******************************************************************************
 File : \code\tpls\doc\_config\ve_uplog.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
/*
 * uplog扩展信息模板配置
/*/
$_ve_uplog = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.shtm',
	),
	'm' => 'c_demo/uplog_main',
	'd' => 'c_demo/uplog_main',
	//'t' => 'c_mod/{mod}_one', //about,alink
	
	/*
	...... (这里不用定义,有如下a_cfgs.php文件定义)
	'3_2' => 'c_demo/uplog_main', 
	'3_1' => 'c_demo/uplog_main',
	'3_0' => 'c_demo/uplog_main', 
	'2_x' => 'c_demo/uplog_main', 
	*/
	
);

include(dirname(dirname(__FILE__)).'/d_uplog/a_cfgs.php');
foreach ($cfgs as $key => $v) {
	if(preg_match("/\d{1}_\w{1}/",$key)){
		$_ve_uplog[$key] = 'c_demo/uplog_main';
	}
}



/*******************************************************************************
 File : \code\tpls\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\tpls\mob\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();
	
	static function init($obj){
		$user = usrBase::userObj('Member'); 
		return $user;
	}
	
	static function pend(){
		$tpl = cfg('tpl');
		$base = $tpl['tplpend'];
		$ext = $tpl['tplpext'];
		$base || $base = 'jstag,menu'; 
		$js = "setTimeout(\"jcronRun()\",3700);\n";
		strstr($base,'jstag') && $js .= "jtagSend();\n";
		strstr($base,'menu') && $js .= "jsactMenu();\n";
		echo basJscss::jscode($js)."\n";	
	}

}



/*******************************************************************************
 File : \code\tpls\mob\b_func\tex_cargo.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_cargo{ //extends tex_base
	
	#protected $prop1 = array();
	
	static function expwhr($flag=0){ 
		$re = '';
		// exp_xxx
		$flist = basLang::ucfg('fsystem'); 
		foreach($flist as $k=>$v){
			if(strstr($k,'exp_')){
				$val = basReq::val($k);
				if(!empty($val)){
					if(strstr($k,'exp_s')){
						$re .= (empty($re) ? '' : ' AND ')."$k='$val'";
					}elseif(strstr($k,'exp_m')){
						$re .= (empty($re) ? '' : ' AND ')."$k LIKE '$val'";
					}
				}
		}   } 
		// price: price=b10, 300~500, u1000
		$area = basReq::val('price');
		if(strstr($area,'~')){ //$area && 
			$arr = explode('~',$area);
			$arr[0] && $re .= (empty($re) ? '' : ' AND ')."price>='$arr[0]'";
			$arr[1] && $re .= (empty($re) ? '' : ' AND ')."price<='$arr[1]'";
		} 
		return $re;
	}

}



/*******************************************************************************
 File : \code\tpls\mob\b_func\tex_keres.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_keres{ //extends tex_base
	
	#protected $prop1 = array();
	
	static function media_show($uvdo){ 
      if(empty($uvdo)) return;
	  $cfg = comFiles::getTIcon($uvdo);
	  $type = $cfg['type']=='audio' ? 'audio' : ($cfg['type']=='flash' ? 'swf' : 'ckvdo');
	  if($type=='audio'){
		  $w = '100%'; $h = 60;
	  }else{
		  $w = '100%'; $h = 480; 
	  }
	  $cstr = "{media:[type=$type][val=$uvdo][w=$w][h=$h][ext=true]/media}"; 
	  $vdo = vopMedia::repShow($cstr);
	  if($vdo) echo "<div class='keres-vdo'>$vdo</div>";
      return '';
	}
	
	static function down_show($ufile){
      if(empty($ufile)) return;
	  $ticon = comFiles::getTIcon($ufile);
	  $type = $ticon['type'];
	  $icon = PATH_STATIC."/icons/file18/{$ticon['icon']}.gif";
	  $icon = "<img src='$icon' width='18' height='18' border='0' align='absmiddle'>";
	  $ufpath = comFiles::revSaveDir($ufile);
	  $ufdir = comFiles::revSaveDir($ufile,'dir'); //echo $ufdir;
	  $ufsize = filesize($ufdir);
	  $ufsize = $ufsize ? basStr::showNumber($ufsize,'Byte') : '';
	  //$vpath = strstr($ufile,'root}') ? $ufile : substr($ufile,-24,24);
	  $vpath = '...'.substr($ufile,-18,18);
	  $link = "<a href='$ufpath'>$icon [$type] $vpath</a> $ufsize ";
	  if($link) echo "<div class='keres-down'>[附件下载] $link</div>";
      return '';
	}

}



/*******************************************************************************
 File : \code\tpls\mob\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \code\tpls\mob\m_user\wxlogin.php 
*******************************************************************************/
<?php
//初始化
(!defined('RUN_MODE')) && die('No Init'); 
$db = glbDBObj::dbObj(); 

// === 获取配置
$kid = basReq::val('kid','admin');
$wecfg = wysBasic::getConfig($kid); 
$scene = basReq::val('scene','');

// === 验证code，codecheck
$code = basReq::val('code',''); 
$state = basReq::val('state',''); 
$openid = basReq::val('openid',''); //'oyDK8vjjcn2cFbxMLaMBhKEsYbCk'; 
$mname = basReq::val('mname',''); 
$codecheck = basReq::val('codecheck','');
$authkey = $_cbase['safe']['api']; 
$sflag = basReq::val('sflag',''); 
//basMsg::show("$kid,$code,$openid",'die');

//---Test*-/ 
// code作为换取access_token的票据，每次用户授权带上的code将不一样，code只能使用一次，5分钟未被使用自动过期。
if($code && empty($codecheck)){
	$oauth = new wmpOauth($wecfg); 
	$actoken = $oauth->getACToken($code); 
	if(!empty($actoken['errmsg'])){
		basMsg::show("[{$actoken['errcode']}]{$actoken['errmsg']}",'die');
	} 
	$openid = $actoken['result']['openid'];
	$codecheck = md5($code.$openid.$authkey); 
// 提交后用$codecheck认证信息
}elseif($code && !empty($codecheck) && !empty($openid)){
	// 防止恶意操作
	$codecfrom = md5($code.$openid.$authkey);
	if($codecfrom!==$codecheck){
		basMsg::show("验证失败，可能是重复提交！",'die');
	}
	// 防止重复操作(恶意)
	$row = $db->table('users_uppt')->where("pptuid='{$openid}' AND pptmod='weixin'")->find();
	if($row){ 
		basMsg::show("此微信号已经绑定会员！请直接登录！",'die');
	}
}else{ //避免后患，停止掉！(调试可屏蔽)
	basMsg::show("Error1: code=$code, state=$state, openid=$openid, codecheck=$codecheck",'die');
}
if($scene && in_array($state,array('binding','dologin','dogetpw','mbindDone','mbindChange','mbindExit'))){
	$timeNmin = $_cbase['run']['stamp']-(5*60*2); //10分钟 //saveState
	if(!$row = $db->table('wex_qrcode')->where("sid='$scene' AND sflag='$sflag' AND atime>'$timeNmin'")->find()){
		basMsg::show("超时了，请重新扫描！",'die');
	}
} 

// === 执行逻辑事务
// 扫描过来 : 带 scene,openid, 注意处理scene
// 扫描过来 : dogetpw
if($state=='dogetpw'){
	$msg = wysUser::resetPwd($openid,$scene,$mname);
	basMsg::show($msg,'die');
// 扫描过来 : dologin
}elseif($state=='dologin'){
	wysUser::setScanLogin($scene,$openid,$mname);
	$msg = "已经自动登录……，请留意屏幕跳转。";
	basMsg::show($msg,'die');

// 登录会员:扫描过来 : 点现在绑定
}elseif($state=='mbindDone'){ 
	$re = usrMember::bindUser($mname, 'weixin', $openid);
	$db->table('wex_qrcode')->data(array('atime'=>'0'))->where("sid='$scene'")->update();
	$msg = "已经绑定完成，请刷新或关闭窗口。";
	basMsg::show($msg,'die');
// 登录会员:扫描过来 : 点更换绑定
}elseif($state=='mbindChange'){ 
	$db->table('users_uppt')->data(array('uname'=>$mname))->where(array('pptuid'=>$openid,'pptmod'=>'weixin'))->update(); 
	$db->table('wex_qrcode')->data(array('atime'=>'0'))->where("sid='$scene'")->update();
	$msg = "已经更换绑定，请刷新或关闭窗口。";
	basMsg::show($msg,'die');
// 登录会员:扫描过来 : 点解除绑定
}elseif($state=='mbindExit'){ 
	$db->table('users_uppt')->where(array('pptuid'=>$openid,'pptmod'=>'weixin'))->delete(); 
	$db->table('wex_qrcode')->data(array('atime'=>'0'))->where("sid='$scene'")->update();
	$msg = "已经解除绑定，请刷新或关闭窗口。";
	basMsg::show($msg,'die');

// 扫描过来 : binding 
}elseif($state=='binding'){ 
	;//这里为空,直接进入模版
// (点菜单,扫码,点链接过来) : 执行绑定
}elseif($state=='dobind'){ 
	
	$actys = basReq::val('actys','');
	$state_old = basReq::val('state_old',''); 
	$username = basReq::val('username',''); 
	$password = basReq::val('password',''); 
	$umod = basReq::val('umod',''); //echo ":$username,$password:";
	//1. 快速新增帐号
	if($actys=='add'){  
		$re = wysUser::addUser($openid,$username,$password,$umod); 
		$msg = $re['msg']; //('mid'=>$mid, 'autocheck'=>$autocheck, 'msg'=>$msg);
		if($re['uid']){
			$msg .= "<br>您的登录帐号为：{$username}。";
			$msg .= "<br>您的登录密码为：{$password}。";
		} 
		$isok = $re['autocheck']==1 ? 1 : 0;
	//2. 绑定已有帐号
	}else{
		$re = wysUser::bindUser($openid,$username,$password);
		$msg = $re['msg']; //return array('res'=>$res, 'msg'=>$msg);
		$isok = $re['res'];
	}
	//3. 失败检查
	if(!$isok){
		basMsg::show("$msg, 请重新操作！",'die');
	}
	$url = wysBasic::fmtUrl(vopUrl::fout('user'));
	//4. 菜单过来,进入会员中心页
	if($state_old=='mlogin'){ 
		usrBase::setLogin('m',$username);
		header("Location:$url");
	//5. 扫码过来,更新数据库+提示信息+进入会员中心链接
	}else{ 
		wysUser::setScanLogin($scene,$openid,$username); // 重置扫码
		$msg .= "<br>电脑版本已经自动登录……，请留意屏幕跳转。";
		$msg .= "<br>点击进入:手机版<a href='$url'>用户中心</a> <br> ";
		basMsg::show($msg,'die');
	}
// 菜单过来 : 登录
}elseif($state=='mlogin'){
	$row = $db->table('users_uppt')->where("pptuid='{$openid}' AND pptmod='weixin'")->find();
	if($row){ //绑定了直接登录
		usrBase::setLogin('m',$row['uname']); 
		$url = wysBasic::fmtUrl(vopUrl::fout('user'));
		header("Location:$url");
	}else{ 
		//未绑定,进入模版
	}
// 积分签到
}elseif($state=='mjifen'){ //
	//wysUser::chkLogin($openid,$state);
	//积分+提示
	usrBase::setLogin('m',$mname);
	$url = wysBasic::fmtUrl(vopUrl::fout('user'));
	header("Location:$url");
}else{ //避免后患，停止掉！(调试可另处理)
	basMsg::show("Error2: code=$code, state=$state, openid=$openid, codecheck=$codecheck",'die');
}
//---Test*/

// === 获取用户信息
/*
 - 因为是管理多个公众号，用主站的公众号(snsapi_base)授权，获取openid
 - 但是(snsapi_base)授权不能获取用户详细信息，所以用各自的公众号获取用户信息
*/
$weuser = new wysUser($wecfg); 
$uinfo = $weuser->getUserInfo($openid); 
$mnamed = wysUser::fmtUserName($uinfo);
$mpassd = substr($mnamed,0,3).'_'.basKeyid::kidRand(24,5); 


// sysvals:
$state_old = $state;
$state = 'dobind'; //print_r($_da);
$umods = array();
foreach($_groups as $k=>$v){ if($v['pid']=='users') $umods[$k]=$v['title']; }
$karr = array('kid','scene','code','openid','codecheck','uinfo','mnamed','mpassd','state_old','state');




/*******************************************************************************
 File : \code\tpls\mob\_config\va_docs.php 
*******************************************************************************/
<?php
/*
*/
$_va_docs = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => array(
		'0' => 'c_mod/news_home', //first,list,home
		'list' => 'c_mod/news_list',
	), //'m' => 'c_mod/news_list',
	'd' => 'c_mod/news_detail',
	't' => 'c_mod/news_list',
	
	'seo' => array(
		'keywd' => 'vc_demo.php set ... keywd',
		'desc' => 'vc_demo.php set ... desc',
	),

);
/*
文档的默认显示配置
c: cfg
m: index_tpl
d: detail_tpl
t: def_type_tpl
type_xxx: type_tpl
不要用f,i
*/



/*******************************************************************************
 File : \code\tpls\mob\_config\va_home.php 
*******************************************************************************/
<?php
/*
? rss,wap
? cn,en
*/
$_va_home = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,catch,close
		'stexp' => '2h', //30,60,3h,6h,12h,24h,7d
		'stext' => '.htm',
	),
	
	//mod.home模块首页模板
	'm' => 'c_page/_home',
	
	//关闭模块
	'close' => array('topic','demo'),
	//文档/资讯:默认按va_docs设置
	//其他未设置模块按关闭处理
	
	//import导入配置的模块
	'imcfg' => array(
		#'demo' => 'news', // demo按news方式显示
        'gbook' => 'nrem', // gbook按nrem方式显示
	),
	
	//扩展模块
	'extra' => array('home','info','type','user'), 
	
);



/*******************************************************************************
 File : \code\tpls\mob\_config\vc_about.php 
*******************************************************************************/
<?php
/*
*/
$_vc_about = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.htm',
	),
	'm' => 'first',
	'd' => 'm_about/about_detail',
	't' => 'm_about/about_page', //about,alink
	
	'anews' => 'm_about/about_list', //公司新闻
	'apics' => 'm_about/about_pics', //公司图片
	'aserv' => 'm_about/about_serv', //服务内容
	'afqas' => 'm_about/about_fqas', //常见问题
	'alink' => 'm_about/about_link', //联系我们
	
	'istest' => 'close',
	
	'v' => 'profile,awhua,alink', //可带view参数
	
	/*'d' => array(
		'0' => 'm_about/about_detail',
		'list1' => 'm_about/about_dlist1',
		'list2' => 'm_about/about_dlist2',
	)*/
	//'iutest' => 'aa/bb',
	
);



/*******************************************************************************
 File : \code\tpls\mob\_config\vc_cargo.php 
*******************************************************************************/
<?php
/*
 * cargo模板配置
/*/
$_vc_cargo = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.htm',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/cargo_list', //首页(key=0,first; val=list,home
		'list' => 'c_mod/cargo_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/cargo_detail',
	
	//类别页
	't' => 'c_mod/cargo_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\mob\_config\vc_indoc.php 
*******************************************************************************/
<?php
/*
 * indoc模板配置
/*/
$_vc_indoc = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	
	'm' => 'indoc/main',
	'd' => 'indoc/detail',
	//'t' => 'indoc/list', //my
	
	/*
	'iget' => 'indoc/list', //my,dep,pub
	'iadm' => 'indoc/uadm', 
	'iedit' => 'indoc/uedit',
	*/

	#'v' => 'my,dep,pub', //可带view参数 

);



/*******************************************************************************
 File : \code\tpls\mob\_config\vc_keres.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_keres = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.htm',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_home', //首页(key=0,first; val=list,home
		'list' => 'c_mod/keres_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/keres_detail',
	
	//类别页
	't' => 'c_mod/keres_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\mob\_config\vc_news.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_vc_news = array(

	//config配置
	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,close
		'stext' => '.htm',
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'c_mod/news_list', //首页
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\mob\_config\vc_nrem.php 
*******************************************************************************/
<?php
/*
...
*/
$_vc_nrem = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,static,cache,close
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => array(
		'0' => 'c_mod/remark_list', //{mod},
		'list' => 'c_mod/remark_list',
	), //'m' => 'c_mod/news_list',
	//'d' => 'c_mod/news_detail',
	//'t' => 'c_mod/news_list',

);



/*******************************************************************************
 File : \code\tpls\mob\_config\ve_info.php 
*******************************************************************************/
<?php
/*
 * info扩展信息模板配置
/*/
$_ve_info = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
        'stext' => '.htm',
	),
	'm'     => 'c_page/info_snav', //站点导航
	'gbook'  => 'c_page/info_gbook', //gbook
	
);



/*******************************************************************************
 File : \code\tpls\mob\_config\ve_user.php 
*******************************************************************************/
<?php
/*
 * user扩展信息模板配置
/*/
$_ve_user = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	
	'm' => 'm_user/uhome',
	//'d' => 'c_mod/{mod}_detail',
	//'t' => 'c_mod/{mod}_one', //about,alink
	
	'wxlogin' => 'm_user/wxlogin',
	'wxlocal' => 'm_user/wxlocal',
	#'apply' => 'm_user/user_apply',
	#'getpw' => 'm_user/user_getpw',
	
);



/*******************************************************************************
 File : \code\tpls\umc\b_func\tex_base.php 
*******************************************************************************/
<?php
/*
公共模板扩展函数
*/ 
class tex_base{
	
	//protected $xxx = array();
	static function tips_init($obj){ 
		$run = cfg('run');
		$_mumem = glbConfig::read('mumem');
		$perm = $permOrg = basReq::val('perm');
		$perm = $perm=='.login' ? lang('user.tex_base_ulogin') : lang('user.tex_base_uperm').'?'.comTypes::getLnks(comTypes::getLays($_mumem['i'],$perm),'([k])[v]');
		$from = basReq::val('from');
		$from = substr($from,0,2)=='q-' ? comParse::urlBase64(substr($from,2),1,1) : $from;
		$ulogin = 'user-login';
		$uapply = 'user-apply';
		$runinfo = '';
		$runinfo .= "".$run['query']."(queries)/".round(memory_get_usage()/1024/1024, 3)."(MB); ";
		$runinfo .= "tpl:".(empty($run['tplname']) ? '(null)' : $run['tplname'])."; "; //tpl 
		$tipmsg =  lang('user.tex_base_vlimit');
		$re = array();
		foreach(array('perm','permOrg','from','ulogin','uapply','runinfo','tipmsg') as $k){
			$re[$k] = $$k;
		}
		return $re;
	}
	
	
	static function init($obj){ 
		global $_cbase;
		$user = usrBase::userObj('Member'); 
		if($obj->mkv=='home') header('Location:'."?user");
		$_mumem = glbConfig::read('mumem'); $_micfg = $_mumem['i']; 
		$pkey = "$obj->mod-"; //obj: type:detail,mext,mtype,mhome
		if($obj->type=='detail'){
			$pkey .= 'd';
		}elseif($obj->type=='mhome'){
			$pkey .= 'm';
		}else{
			$pkey .= $obj->key;	
		} 
		$pnow = empty($_micfg[$pkey]['cfgs']) ? '.login' : $_micfg[$pkey]['cfgs']; //1, (empty), .guest
		if($pnow==1) $pnow = $pkey;
		$pmarr = empty($user->uperm['pmusr']) ? array() : explode(',',$user->uperm['pmusr']);
		//dump($pnow); dump($pmarr); dump($_micfg); // die();
		if($pnow=='.guest' || in_array($obj->tplname,array('user/tips','user/home')) || in_array($obj->mod,$obj->ucfg['u']['umc_frees'])){ 
			//游客可操作 or 提示页本身 or 跳转首页
		}elseif($pnow=='.login' && $user->userFlag=='Login'){
			//需要登录 and 已登录
		}elseif(in_array($pnow,$pmarr)){ //登录用户有权限
			//登录用户有权限
		}else{  
			$from = $obj->ucfg['q']==$obj->mkv ? $obj->mkv : 'q-'.comParse::urlBase64($obj->ucfg['q'],0,1); 
			header('Location:'."?mkv=user-tips&from=$from&perm=$pnow"); #echo "$from"; #
		} 
		$_cbase['tpl']['tplpext'] = "var pmusr='".implode(',',$pmarr)."';";
		return $user;
	}
	
	static function pend(){
		$tpl = cfg('tpl');
		$base = $tpl['tplpend'];
		$ext = $tpl['tplpext'];
		$base || $base = 'menu'; //jstag,menu,
		$js = "setTimeout(\"jcronRun()\",3700);\n";
		$ext && $js .= "$ext;\n";
		strstr($base,'jstag') && $js .= "jtagSend();\n";
		strstr($base,'menu') && $js .= "jsactMenu();\n";
		echo basJscss::jscode($js)."\n";
	}
	

}



/*******************************************************************************
 File : \code\tpls\umc\b_func\tex_faqs.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_faqs{ //extends tex_base
	
	#protected $prop1 = array();

	static function showMdshow($mdshow,$kid,$rep=0){ 
    	if($mdshow=='md'){
    		$mdshow = 'Makedown';
    	}else{
    		$mdshow = 'Text';
    	}
    	$mod = $rep ? 'qarep' : 'faqs';
    	$link = PATH_ROOT."/plus/coms/mdown.php?mod=$mod&kid=$kid";
    	$link = "<a href='$link' onclick='return winOpen(this,\"Makedown".lang('user.exf_vcode')."\",600,480);'>$mdshow</a>";
    	return $link;
	}

	static function showDetail($detail,$mdshow=''){ 
    	if($mdshow=='md'){
    		$detail = extMkdown::pdext($detail,0);
    	}else{
    		$detail = basStr::filText($detail);
    	}
    	return $detail;
	}


	static function expwhr($obj){ 
		$mcfg = glbConfig::read('faqs'); 
		$arr = array('new','tip','hot','tag',);
		$view = basReq::val('view');
		$tag = basReq::val('tag');
		$keywd = basReq::val('keywd');
		$whr = '';
		if(!empty($obj->key) && isset($mcfg['i'][$obj->key])){
			$whr = " AND catid='$obj->key'";
		}
		if($obj->key=='tip' || $view=='tip'){
			$whr = " AND hinfo>'0'";
		}
		if(!empty($tag)){
			$whr = " AND tags LIKE '%$tag%'";
		}
		if(!empty($keywd)){
			$whr = " AND title LIKE '%$keywd%'";
		}
		if($obj->key=='hot' || $view=='hot'){
			$ord = "click";
		}else{
			$ord = 'did';
		}
		return array($whr,$ord);
	}
	
	static function rndColor(){ 
		$tab = cfg('ucfg.ctab');
		$cArr = explode(',',$tab); 
		$max = count($cArr)-1;
		return $cArr[mt_rand(0,$max)];
	}
	
	static function ejsCfgs($obj){ 
		$mcfg = glbConfig::read('faqs'); 
		$arr = array('new','tip','hot','tag',);
		$view = basReq::val('view');
		$tag = basReq::val('tag');
		if(empty($obj->key)){
			$sub = '_allt';
		}elseif(isset($mcfg['i'][$obj->key])){
			$sub = $obj->key;
		}else{
			$sub = '_allt';
		}
		if($tag){
			$top = 'tag';
		}elseif($obj->key && in_array($obj->key,$arr)){
			$top = $obj->key;
		}elseif($view && in_array($view,$arr)){
			$top = $view;
		}else{
			$top = 'new';
		}
		$jstr = "var qas_id='$sub', qat_id='$top';";	
		return $jstr;
	}
	
	static function navTags($obj,$tags=''){ 
		if(empty($tags)) return '';
		$tags = explode(',',$tags); 
		$str = ''; 
		foreach($tags as $tag){ 
			if(empty($tags)) continue;
			$str .= "<a href='".vopUrl::fout(0)."?mkv=faqs--list&tag=$tag' class='c".tex_faqs::rndColor()."'>$tag</a>";
		}
		return $str;
	}
	
	static function navTop($obj,$re='html'){ 
		$mcfg = glbConfig::read('faqs'); 
		$cfg = basLang::ucfg('cfgbase.ucfaqn4');
		$tag = basReq::val('tag');
		$tag && $cfg['tag'] .= ":$tag";
		$str = '';
		foreach($cfg as $key=>$val){
			if($key=='tag'){
				$url = vopUrl::fout("faqs-$key");
			}elseif(empty($obj->key)){
				$url = $key=='new' ? vopUrl::fout('faqs') : vopUrl::fout("faqs-$key");
			}elseif(isset($mcfg['i'][$obj->key])){
				$url = vopUrl::fout(0)."?mkv=faqs-$obj->key&view=$key";
			}else{
				$url = $key=='new' ? vopUrl::fout('faqs') : vopUrl::fout("faqs-$key");
			}
			$str .= "<a href='$url' id='qat_$key'>$val</a>";
		}
		return $str;
	}
	
	static function navSide($obj,$re='html'){ 
		$mcfg = glbConfig::read('faqs'); 
		$stats = self::statTypes($act='get');
		$str = "<a href='".vopUrl::fout('faqs')."' id='qas__allt'><i class='right'>".$stats['_allt']."</i>".lang('user.exf_alltype')."</a>";
		$arr = array('_allt'=>lang('user.exf_alltype'));
		foreach($mcfg['i'] as $key=>$val){
			$cnts = "<i class='right'>".(empty($stats[$key]) ? 0 : $stats[$key])."</i>";
			$str .= "<a href='".vopUrl::fout("faqs-$key")."' id='qas_$key'>$cnts$val[title]</a>";
			$arr[$key] = $val['title'];
		}
		return $re=='html' ? $str : $arr;
	}
	
	// 统计类别下的问答
	static function statTypes($act='get'){ 
		$arr = array();
		$file = DIR_DTMP."/store/_faqs_types.cfg.php";
		if($act=='get' && file_exists($file)){ 
			include($file);
			$arr = $_faqs_types;
			return $arr;
		}
		$db = glbDBObj::dbObj(); 
		$tabfull = "{$db->pre}docs_faqs{$db->ext}"; 
		$arr['_tags'] = $db->table('coms_qatag')->where("`show`='1'")->count(); 
		$arr['_allt'] = $db->table('docs_faqs')->where("`show`='1'")->count(); 
		$q = $db->query("SELECT catid,count(*) as cnt FROM $tabfull WHERE `show`='1' GROUP BY catid"); 
		foreach($q as $k=>$v){
			$arr[$v['catid']] = $v['cnt'];
		}
		if($act=='upd' || !file_exists($file)){
			glbConfig::save($arr,'faqs_types','store');
		}
		return $arr;
	}
	
	// 统计/重置标签
	static function statTags($act='get'){ 
		$db = glbDBObj::dbObj(); 
		$list = $db->field('tags')->table('docs_faqs')->where("`show`='1'")->select();
		$at = array(); 
		foreach($list as $tags){
			if(empty($tags['tags'])) continue;
			$arr = explode(',',$tags['tags']);
			foreach($arr as $tag){
				if(empty($tag)) continue;
				if(isset($at[$tag])) $at[$tag] += 1;
				else $at[$tag] = 1;
			} //echo "\n<br>{$tags['tags']},";
		}
		$no = 100;
		$db->table('coms_qatag')->where("cid>'0'")->delete(); 
		foreach($at as $tag=>$cnt){ 
			$no += mt_rand(7,13);
			$cid = basKeyid::kidTemp('0').'-'.basKeyid::fmtBase32('',$no,32,5); 
			$data = array('cid'=>$cid,'cno'=>'1','title'=>$tag,'show'=>'1','hotcnt'=>$cnt,);
			$db->table('coms_qatag')->data($data)->insert(); 
		}
	}
	
}

/*

*/



/*******************************************************************************
 File : \code\tpls\umc\b_func\tex_indoc.php 
*******************************************************************************/
<?php
/*
单个模板扩展函数
*/ 
class tex_indoc{ //extends tex_base
	
	#protected $prop1 = array();
	static $ncfgs = array();
	
	static function expwhr($user,$part,$stype,$read=0,$cnt=0){ 
		//print_r($user);
		$db = glbDBObj::dbObj(); 
		if($user->userFlag=='Login'){
			$uname = $user->uinfo['uname'];
			$indep = empty($user->uinfo['indep']) ? '(nologin)' : $user->uinfo['indep'];
		}else{
			$uname = "(nologin)";
			$indep = "(nologin)";
		}
		// exp_xxx
		$whra = array(
			'imy' => " AND touser LIKE '%$uname%'",
			'idep' => " AND todep LIKE '%$indep%'",
			'ipub' => " AND topub='ispub'",
		);
		$where = isset($whra[$part]) ? $whra[$part] : '';
		if(!empty($stype)){
			$where .= " AND catid='$stype'";
		}
		if(!empty($read)){ // in,not
			$dbcfg = glbDBObj::getCfg(); //print_r($dbcfg);
			$subs = "SELECT pid FROM {$db->pre}coms_inread{$db->ext} WHERE auser='$uname'";
			$where .= " AND m.did ".($read=='no' ? 'NOT' : '')." IN($subs)";
		}
		if(!empty($cnt)){
			$where = str_replace('m.did','did',$where);
			return $db->table('docs_indoc')->where(substr($where,5))->count();
		}
		return $where;
	}
	
	// 公开属性修正
	static function fixIspub(&$dop,$isadd){ 
		if($dop->fmv['topub']=='ispub'){
			$dop->fmv['touser'] = $dop->fmv['todep'] = '';
		}
	}
	// 发通知扩展
	static function exNotice($dop,$isadd){ //print_r($dop);
		$db = glbDBObj::dbObj(); 
		$stype = basReq::ark('fm','sendsms') ; 
		//$stype = 'wechat'; 
		if(empty($stype) || $dop->fmv['topub']=='ispub') return;
		$usql = self::tousql($dop->fmv);
		$uarr = self::touarr($usql); 
		$ncfg = array( // sendsms（通知类型）:: nosend=不通知
			'mobmsg' => 'mtel', //短信
			'email' => 'memail', //邮件
			'wechat' => 'wechat', //微信
		);
		if(!isset($ncfg[$stype])) return;
		self::$ncfgs = basLang::ucfg('cfgbase.indoc_notice');
		$method = 'exN'.ucfirst($stype); 
		if(!empty($uarr)){
			$max = 60; $ids = ''; $cnt = 0; // 随机30~80个帐号
			foreach($uarr as $k=>$v){
				if($stype=='wechat'){ 
					$rec = $db->table('users_uppt')->field('pptuid')->where("uname='$k'")->find(); 
					$nid = $rec['pptuid'];
				}else{
					$nid = $v[$ncfg[$stype]]; //[$ncfg[$stype]]
				}
				if($nid){
					$ids .= (empty($ids)?'':',').$nid;
					$cnt++;
				}
				if($cnt>=$max){
					$ids = ''; $cnt = 0;
					if(!empty($ids)) self::$method($dop,$ids); 
				}
			}
			if(!empty($ids)) self::$method($dop,$ids); 
		}
	}
	static function exNMobmsg($dop,$tels){ 
		$info = self::exNInfo($dop); 
		$c = self::$ncfgs; // title, xsub, xpub, xuser, xclick
		$detail = $c['title'];
		$detail .= $c['xsub']."{$info['title']}；";
		$detail .= $c['xpub']."{$info['atime']}；";
		$detail .= $c['xuser']."{$info['auser']}；";
		$detail .= "<a href='{$info['url']}'>{$c['xclick']}</a>";
		$detail .= "【{$info['sys_name']}】";
		$sms = new extSms(); 
		if($sms->isClosed()) return; 
		//dump($detail);
		$res = $sms->sendSMS($tels,$detail,0); 
		if($res[0]!==1){
			$res = implode(':',$res); 
			self::exNLoger($res,$detail);
		}
	}

	static function exNEmail($dop,$mails){ 
		$info = self::exNInfo($dop); 
		$type = 'phpmailer'; //swiftmailer,phpmailer,basReq::val('type');
		$c = self::$ncfgs; // title, xsub, xpub, xuser, xclick
		$detail = $c['title']."\n";
		$detail .= $c['xsub']."{$info['title']}；<br>\n";
		$detail .= $c['xpub']."{$info['atime']}；<br>\n";
		$detail .= $c['xuser']."{$info['auser']}；<br>\n";
		$detail .= "<a href='{$info['url']}'>{$c['xclick']}</a><br>\n";
		$detail .= "【{$info['sys_name']}】";
		//dump($detail);
		$mail = new extEmail($type);
		$res = $mail->send($mails,lang('user.exf_indocmsg'),$detail,"{$info['sys_name']}");
		if($res!=='SentOK'){
			$res = strip_tags($res); 
			self::exNLoger($res,$detail);
		}
	}
	static function exNWechat($dop,$opids){ 
		defined('WERR_RETURN') || define('WERR_RETURN',1);
		$info = self::exNInfo($dop); $color = '"color":"#173177"';
		$detail = '"first":{"value":"'.$c['title'].'",'.$color.'},';
        $detail .= '"title":{"value":"'.$info['title'].'",'.$color.'},';
        $detail .= '"time":{"value":"'.$info['atime'].'",'.$color.'},';
        $detail .= '"auser":{"value":"'.$info['auser'].'",'.$color.'},';
        $detail .= '"remark":{"value":"'.$c['xclick'].'",'.$color.'}';
        //dump($detail);
		$weixin = new wmpMsgmass(wysBasic::getConfig('admin'));
		$data = $weixin->sendTpl($opids, cfg('weixin.tplidIndoc'), $detail, $info['url']);
		$res = '';
		foreach ($data as $opid => $re1) {
			$res .= "{$re1['errcode']}:{$re1['errmsg']}; ";
			//dump($re1);
		}
		self::exNLoger($res,$detail);
	}
	static function exNInfo($dop){ 
		global $_cbase;
		$re['url'] = $_cbase['run']['rsite'].PATH_PROJ."/?indoc.{$dop->fmu['did']}";
		$re['title'] = $dop->fmv['title'];
		$re['sys_name'] = $_cbase['sys_name'];
		$re['auser'] = $dop->fmv['auser'];
		$re['atime'] = date('Y-m-d H:i',$dop->fmv['atime']);
		return $re;
		/*dop:Array(
			[title] => TestSSS     [color] =>      [show] => 1
			[indep] => intech      [catid] => i1016
			[rdtip] => v48         [topub] => isset
			[todep] => ,inadm,intech,incai,inpro,inren
			[touser] => xgezi,ahong,ruby
			[atime] => 1464740404  [etime] => 1464740404
			[auser] => xgezi       [euser] => xgezi
			[aip] => 127.0.0.1     [eip] => 127.0.0.1
		)*/
	}
	static function exNLoger($info=array(),$detail){
		if(is_array($info)) $info = implode(':',$info); 
		$info .= "\ndetail:".$detail;
		//dump($info);
		$debug = cfg('indoc.debug');
		if($debug){
			basDebug::bugLogs('indoc',$info,'detmp','db');
		}
		// #register_shutdown_function('shutdown_handler_ys',$dop);
	}
	
	// toshow
	static function toshow($vars){ 
		$re = array(); 
		$re['tod'] = vopCell::cOpt($vars['todep'],'indep',',','');
		$usql = self::tousql(array('todep'=>'','topub'=>'','touser'=>$vars['touser'],));
		$uarr = self::touarr($usql); 
		$re['tou'] = ''; $null = "<span class='cCCC'>".lang('user.exf_null')."</span>";
		if(empty($uarr)){
			$re['tou'] = $null;
		}else{
			foreach($uarr as $k=>$v){
				$re['tou'] .= "".(empty($re['tou'])?"":", ")."".(count($uarr<5)?"($k)":"")."$v[mname]";
			}
		}
		if($vars['topub']=='ispub'){
			$re['tod'] .= "<span class='c33F'>".lang('user.exf_public')."</span>";
		}
		if(empty($re['tod'])) $re['tod'] = $null;
		return $re;
	}
	// tousql
	static function tousql($vars){ 
		if($vars['topub']=='ispub'){
			$re = '1=1';
		}else{
			$ru = basSql::whrInids($vars['touser']);
			$rd = basSql::whrInids($vars['todep']);
			if($ru && $rd){
				$re = "(uname IN($ru) OR indep IN($rd))";
			}elseif($ru){
				$re = "uname IN($ru)";	
			}elseif($rd){
				$re = "indep IN($rd)";	
			}else{
				$re = '1=2';	
			}
		}
		return $re;
	}
	// touarr
	static function touarr($usql){ 
		$db = glbDBObj::dbObj(); 
		$list = $db->table('users_inmem')->field('uid,uname,grade,mname,mtel,memail,miuid,indep,`show`')->where($usql)->select();
		$re = array();
		if($list){ foreach($list as $r){
			$re[$r['uname']] = $r;
		}}
		return $re;
	}
	
	// 不能查看的原因
	static function noperm($user,$data=array()){ 
		if($data['topub']=='ispub'){
			$nores = 0; //公开文件,可看
		}elseif(usrPerm::issup()){
			$nores = 0; //超管,可看
		}elseif($user->userFlag!='Login'){
			$nores = 'noLogin'; //未登录不能看
		}else{
			$intou = $intod = 0;
			if(!empty($data['touser'])){
				$intou = strpos('(,'.$data['touser'].',)',','.@$user->uinfo['uname'].',') ? 1 : 0;
			}
			if(!empty($data['todep'])){
				$udep = empty($user->uinfo['indep']) ? '(nodep)' : $user->uinfo['indep'];
				$intod = strpos('(,'.$data['todep'].',)',",$udep,") ? 1 : 0;
			}
			$nores = ($intod || $intou) ? 0 : 'notTo'; 
		} //$nores = 'notTo';
		return $nores;
	}
	
	// 是否已查看:noread,isread,0
	// tpl:<i class='tim-{val}'></i>
	static function isread($user,$did,$tpl="(val)",$flag=1){ 
		$cfg = array(
			'isread1' => '<span style="color: #008000; font-weight : bold;" title="'.lang('user.exf_readok').'">&#10004;</span>',
			'noread1' => '<span style="color: #ff0000; font-weight : bold;" title="'.lang('user.exf_unread').'">&#10008;</span>',
			'isread2' => '<span style="color: #008000; font-weight : bold;">&#10004;'.lang('user.exf_readok').'</span>',
			'noread2' => '<span style="color: #ff0000; font-weight : bold;">&#10008;'.lang('user.exf_unread').'</span>',
		);
		$data = array();
		if($user->userFlag!='Login'){
			$re = 0;
		}else{
			$uname = $user->uinfo['uname'];
			$db = glbDBObj::dbObj(); 
			$data = $db->table('coms_inread')->where("pid='$did' AND auser='$uname'")->find(); 
			$re = empty($data) ? 'noread' : 'isread';
		}
		if($tpl=='arr'){
			$data['_flag'] = $re;
			$re = $data; 
		}elseif(!empty($tpl)){
			$re = $re ? str_replace('(val)',$re,$tpl) : '';
			if(isset($cfg["$re$flag"])) $re = $cfg["$re$flag"];
		}
		return $re;
	}

}

/*

*/



/*******************************************************************************
 File : \code\tpls\umc\_config\va_docs.php 
*******************************************************************************/
<?php
/*
 * 文档通用模板配置
/*/
$_va_docs = array(

	//config配置
	'c' => array(
		'vmode' => 'close', //dynamic,static,close
		'stext' => '-m.htm', //后缀
		'stexp' => '2h', //hour(s)
	),
	
	//mod.home模块首页
	'm' => array(
		'0' => 'first', //首页(key=0,first; val=list,home
		'list' => 'c_mod/news_list', //搜索
	), 
	
	//详情页
	'd' => 'c_mod/news_detail',
	
	//类别页
	't' => 'c_mod/news_list',
	
	//单个类别(模板)
	#'serv' => 'c_mod/{mod}_serv', //服务内容

);



/*******************************************************************************
 File : \code\tpls\umc\_config\va_home.php 
*******************************************************************************/
<?php
/*
? 
*/
$_va_home = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,catch,close
		'stexp' => '2h', //30,60,3h,6h,12h,24h,7d
		'stext' => '-m.htm',
	),
	
	//mod.home模块首页模板
	'm' => 'user/home',
	
	//关闭模块
	'close' => array('xxxxx'),
	
	//import导入配置的模块
	'imcfg' => array(
		#'demo' => 'news', // demo按news方式显示
	),
	
	//扩展模块
	'extra' => array('user','order','help'), 
	//info : ,home, noperm, 
	//user : ,edit, edpw, 
	//order : ,list, detail, 
	
	// 权限配置：哪个模板用什么权限？
	// 键与模板关联，如：[tplname] => user/uinfo 则对应 [user][uinfo]；
	// 值与权限设置中的[会员]里面的标示对应
	// !isset-登陆, ''(空)-游客可用, 'xxx'-按设置
	//*
	'u' => array(
		'umc_frees' => array(-1,'faqs','help'), //umc-不需要登录模型
		//'login' => 'chn:user-login', //登录地址，用于提示
		//'apply' => 'chn:user-apply', //注册地址，用于提示
	),//*/
	
);
	


/*******************************************************************************
 File : \code\tpls\umc\_config\vc_faqs.php 
*******************************************************************************/
<?php
/*
 * faqs模板配置
/*/
$_vc_faqs = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
		'stext' => '.htm',
	),
	
	'm' => array(
		'0' => 'faqs/list', //首页
		'list' => 'faqs/list', //搜索
	),
	'd' => 'faqs/detail',
	't' => 'faqs/list', 
	
	// 类别/栏目:就不要设置如下ID了，否则冲突
	'new' => 'faqs/list', //最新
	'tip' => 'faqs/list', //精华
	'hot' => 'faqs/list', //热门
	'tag' => 'faqs/tags', //标签
	
	//'v' => 'my,dep,pub', //可带view参数 

);



/*******************************************************************************
 File : \code\tpls\umc\_config\vc_indoc.php 
*******************************************************************************/
<?php
/*
 * indoc模板配置
/*/
$_vc_indoc = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	
	'm' => 'indoc/main',
	'd' => 'indoc/detail',
	//'t' => 'indoc/list', //my
	
	'iget' => 'indoc/list', //my,dep,pub
	'iadm' => 'indoc/uadm', 
	'iedit' => 'indoc/uedit',
	
	'v' => 'my,dep,pub', //可带view参数 

);



/*******************************************************************************
 File : \code\tpls\umc\_config\ve_help.php 
*******************************************************************************/
<?php
/*
 * order扩展信息模板配置
/*/
$_ve_help = array(

	'c' => array(
		'vmode' => 'static', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
		'stext' => '-umc.htm',
	),
	'm' => 'user/help',
	
);



/*******************************************************************************
 File : \code\tpls\umc\_config\ve_order.php 
*******************************************************************************/
<?php
/*
 * order扩展信息模板配置
/*/
$_ve_order = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	'm' => 'order/list',
	'd' => 'order/detail',
	
	'nodone' => 'order/list', 
	'isdone' => 'order/list', 
	'inquiry' => 'order/inquiry', 

);



/*******************************************************************************
 File : \code\tpls\umc\_config\ve_user.php 
*******************************************************************************/
<?php
/*
 * user扩展信息模板配置
/*/
$_ve_user = array(

	'c' => array(
		'vmode' => 'dynamic', //dynamic,close,static
		'stexp' => '12h', //30,60,3h,6h,12h,24h,7d
	),
	
	'm' => 'user/uinfo',	
	//'home' => 'user/uinfo', //
	'tips' => 'user/tips', //
	
	'uedit' => 'user/uedit', //
	'uedpw' => 'user/uedpw', //
	'mbind' => 'user/mbind', //
	
	'v' => 'tips', //可带view参数
	
	'testlogin' => 'user/test', //
	'testguset' => 'user/test', //
	'testset' => 'user/test', //
	
	'login' => 'user/user_login',
	'apply' => 'user/user_apply',
	//'appdo' => 'c_page/user_acts',
	'getpw' => 'user/user_getpw',
	//'getdo' => 'c_page/user_acts',
	
);
