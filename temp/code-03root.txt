


/*******************************************************************************
 File : \root\a3rd\a3rd_cfgs.php 
*******************************************************************************/
<?php
//$_cbase['skip']['_all_'] = true;
define('RUN_A3RD', 1);
require_once(dirname(dirname(__FILE__)).'/run/_paths.php'); 
require_once(DIR_CODE.'/cfgs/excfg/ex_a3rd.php');

if($_cbase['debug']['err_mode']){
	error_reporting(E_ALL^E_WARNING^E_NOTICE); 
}else{
	error_reporting(0); 
}



/*******************************************************************************
 File : \root\a3rd\alipay_dirbank\alipay.config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/alipay_dirbank');
define('LIBS_PAYRUN', DIR_VENDOR.'/a3rd/alipay_class');
/* *
 * 配置文件
 * 版本：3.3
 * 日期：2012-07-19
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 * 该代码仅供学习和研究支付宝接口使用，只是提供一个参考。
	
 * 提示：如何获取安全校验码和合作身份者id
 * 1.用您的签约支付宝账号登录支付宝网站(www.alipay.com)
 * 2.点击“商家服务”(https://b.alipay.com/order/myorder.htm)
 * 3.点击“查询合作者身份(pid)”、“查询安全校验码(key)”
	
 * 安全校验码查看时，输入支付密码后，页面呈灰色的现象，怎么办？
 * 解决方法：
 * 1、检查浏览器配置，不让浏览器做弹框屏蔽设置
 * 2、更换浏览器或电脑，重新登录查询。
 */
 
//↓↓↓↓↓↓↓↓↓↓请在这里配置您的基本信息↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
//合作身份者id，以2088开头的16位纯数字
$alipay_config['partner']		= $pay_uinfo['ali']['partner'];

//收款支付宝账号
$alipay_config['seller_email']	= $pay_uinfo['ali']['email'];

//安全检验码，以数字和字母组成的32位字符
$alipay_config['key']			= $pay_uinfo['ali']['key'];


//↑↑↑↑↑↑↑↑↑↑请在这里配置您的基本信息↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑


//签名方式 不需修改
$alipay_config['sign_type']    = strtoupper('MD5');

//字符编码格式 目前支持 gbk 或 utf-8
$alipay_config['input_charset']= strtolower('utf-8');

//ca证书路径地址，用于curl中ssl校验
//请保证cacert.pem文件在当前文件夹目录中
$alipay_config['cacert']    = DIR_VENDOR.'/a3rd/alipay_class/cacert.pem';

//访问模式,根据自己的服务器是否支持ssl访问，若支持请选择https；若不支持请选择http
$alipay_config['transport']    = 'http';
?>


/*******************************************************************************
 File : \root\a3rd\alipay_dirbank\index.php 
*******************************************************************************/
<?php
/* *
 * 功能：支付宝纯网关接口接口调试入口页面
 * 版本：3.3
 * 日期：2012-07-23
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 */

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
	<title>支付宝纯网关接口接口</title>
	<meta charset="utf-8">
<style>
*{
	margin:0;
	padding:0;
}
ul,ol{
	list-style:none;
}
.title{
    color: #ADADAD;
    font-size: 14px;
    font-weight: bold;
    padding: 8px 16px 5px 10px;
}
.hidden{
	display:none;
}

.new-btn-login-sp{
	border:1px solid #D74C00;
	padding:1px;
	display:inline-block;
}

.new-btn-login{
    background-color: #ff8c00;
	color: #FFFFFF;
    font-weight: bold;
	border: medium none;
	width:82px;
	height:28px;
}
.new-btn-login:hover{
    background-color: #ffa300;
	width: 82px;
	color: #FFFFFF;
    font-weight: bold;
    height: 28px;
}
.bank-list{
	overflow:hidden;
	margin-top:5px;
}
.bank-list li{
	float:left;
	width:153px;
	margin-bottom:5px;
}

#main{
	width:750px;
	margin:0 auto;
	font-size:14px;
	font-family:'宋体';
}
#logo{
	background-color: transparent;
    background-image: url("images/new-btn-fixed.png");
    border: medium none;
	background-position:0 0;
	width:166px;
	height:35px;
    float:left;
}
.red-star{
	color:#f00;
	width:10px;
	display:inline-block;
}
.null-star{
	color:#fff;
}
.content{
	margin-top:5px;
}

.content dt{
	width:160px;
	display:inline-block;
	text-align:right;
	float:left;
	
}
.content dd{
	margin-left:100px;
	margin-bottom:5px;
}
#foot{
	margin-top:10px;
}
.foot-ul li {
	text-align:center;
}
.note-help {
    color: #999999;
    font-size: 12px;
    line-height: 130%;
    padding-left: 3px;
}

.cashier-nav {
    font-size: 14px;
    margin: 15px 0 10px;
    text-align: left;
    height:30px;
    border-bottom:solid 2px #CFD2D7;
}
.cashier-nav ol li {
    float: left;
}
.cashier-nav li.current {
    color: #AB4400;
    font-weight: bold;
}
.cashier-nav li.last {
    clear:right;
}
.alipay_link {
    text-align:right;
}
.alipay_link a:link{
    text-decoration:none;
    color:#8D8D8D;
}
.alipay_link a:visited{
    text-decoration:none;
    color:#8D8D8D;
}
</style>
</head>
<body text=#000000 bgColor=#ffffff leftMargin=0 topMargin=4>
	<div id="main">
		<div id="head">
            <dl class="alipay_link">
                <a target="_blank" href="http://www.alipay.com/"><span>支付宝首页</span></a>|
                <a target="_blank" href="https://b.alipay.com/home.htm"><span>商家服务</span></a>|
                <a target="_blank" href="http://help.alipay.com/support/index_sh.htm"><span>帮助中心</span></a>
            </dl>
            <span class="title">支付宝纯网关接口快速通道</span>
		</div>
        <div class="cashier-nav">
            <ol>
				<li class="current">1、确认信息 →</li>
				<li>2、点击确认 →</li>
				<li class="last">3、确认完成</li>
            </ol>
        </div>
        <form name=alipayment action=uapi.php method=post target="_blank">
            <div id="body" style="clear:left">
                <dl class="content">
                    <dt>商户订单号：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="ordid" />
                        <span>商户网站订单系统中唯一订单号，必填
</span>
                    </dd>
                    <dt>订单名称：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="title" />
                        <span>必填
</span>
                    </dd>
                    <dt>付款金额：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="feetotle" />
                        <span>必填
</span>
                    </dd>
                    <dt>订单描述
：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="ordbody" />
                        <span></span>
                    </dd>
                    <dt>默认网银：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="WIDdefaultbank" />
                        <span>必填，银行简码请参考接口技术文档
</span>
                    </dd>
                    <dt>商品展示地址：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="showurl" />
                        <span>需以http://开头的完整路径，例如：http://www.商户网址.com/myorder.html
</span>
                    </dd>
					<dt></dt>
                    <dd>
                        <span class="new-btn-login-sp">
                            <button class="new-btn-login" type="submit" style="text-align:center;">确 认</button>
                        </span>
                    </dd>
                </dl>
            </div>
		</form>
        <div id="foot">
			<ul class="foot-ul">
				<li><font class="note-help">如果您点击“确认”按钮，即表示您同意该次的执行操作。 </font></li>
				<li>
					支付宝版权所有 2011-2015 ALIPAY.COM 
				</li>
			</ul>
		</div>
	</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_dirbank\uapi.php 
*******************************************************************************/
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta charset="utf-8">
	<title>支付宝即时到账交易接口接口</title>
    <style type="text/css">.tc { text-align:center; }</style>
</head>
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_submit.class.php");
//logResult('test');
/**************************请求参数**************************/

        //支付类型
        $payment_type = "1"; 
        //必填，不能修改
		
        //服务器异步通知页面路径
        $notify_url = $_cbase['run']['roots']."/a3rd/alipay_direct/unotify.php";
        //需http://格式的完整路径，不能加?id=123这类自定义参数
        //页面跳转同步通知页面路径
        $return_url = $_cbase['run']['roots']."/a3rd/alipay_direct/ureturn.php";
        //需http://格式的完整路径，不能加?id=123这类自定义参数，不能写成http://localhost/

        //商户订单号
        $out_trade_no = $_POST['ordid'];
        //商户网站订单系统中唯一订单号，必填

        //订单名称
        $subject = $_POST['title'];
        //必填

        //付款金额
        $total_fee = $_POST['feetotle'];
        //必填

        //订单描述
        $body = $_POST['ordbody'];
		
        //默认支付方式
        $paymethod = "bankPay";
        //必填
        //默认网银
        $defaultbank = $_POST['WIDdefaultbank'];
        //必填，银行简码请参考接口技术文档
		
        //商品展示地址
        $show_url = $_POST['showurl'];
        //需以http://开头的完整路径，例如：http://www.商户网址.com/myorder.html

        //防钓鱼时间戳
        $anti_phishing_key = "";
        //若要使用请调用类文件submit中的query_timestamp函数

        //客户端的IP地址
        $exter_invoke_ip = "";
        //非局域网的外网IP地址，如：221.0.0.1


/************************************************************/

//构造要请求的参数数组，无需改动
$parameter = array(
		"service" => "create_direct_pay_by_user",
		"partner" => trim($alipay_config['partner']),
		"seller_email" => trim($alipay_config['seller_email']),
		"payment_type"	=> $payment_type,
		"notify_url"	=> $notify_url,
		"return_url"	=> $return_url,
		"out_trade_no"	=> $out_trade_no,
		"subject"	=> $subject,
		"total_fee"	=> $total_fee,
		"body"	=> $body,
		"paymethod"	=> $paymethod,
		"defaultbank"	=> $defaultbank,
		"show_url"	=> $show_url,
		"anti_phishing_key"	=> $anti_phishing_key,
		"exter_invoke_ip"	=> $exter_invoke_ip,
		"_input_charset"	=> trim(strtolower($alipay_config['input_charset']))
);

//建立请求
$alipaySubmit = new AlipaySubmit($alipay_config);
$html_text = $alipaySubmit->buildRequestForm($parameter,"get", "确认");
echo "<p class='tc'>$html_text</p>";

?>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_dirbank\unotify.php 
*******************************************************************************/
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyNotify();

if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表
	
	//商户订单号
	$out_trade_no = $_POST['out_trade_no'];

	//支付宝交易号
	$trade_no = $_POST['trade_no'];

	//交易状态
	$trade_status = $_POST['trade_status'];

    if($_POST['trade_status'] == 'TRADE_FINISHED') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
				
		//注意：
		//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
    else if ($_POST['trade_status'] == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
				
		//注意：
		//付款完成后，支付宝系统发送该交易状态通知

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
        
	echo "success";		//请不要修改或删除
	exvOpay::notifyAliDirect('success');
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    echo "fail";
	exvOpay::notifyAliDirect('fail');

    //调试用，写文本函数记录程序运行情况是否正常
    //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
}



/*******************************************************************************
 File : \root\a3rd\alipay_dirbank\ureturn.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyReturn();
if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代码
	
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表

	//商户订单号
	$out_trade_no = $_GET['out_trade_no'];

	//支付宝交易号
	$trade_no = $_GET['trade_no'];

	//交易状态
	$trade_status = $_GET['trade_status'];

    if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
    }
    else {
      //echo "trade_status=".$_GET['trade_status'];
    }
		
	$msg = "验证成功";

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    //如要调试，请看alipay_notify.php页面的verifyReturn函数
    $msg = "验证失败";
}

$cfg = array(
	'ordid'=>'out_trade_no',
	'feeamount'=>'total_fee',
	'apino'=>'trade_no',
	'status'=>'trade_status',
);
foreach($cfg as $k1=>$k2){ 
	$res[$k1] = basReq::val($k2);  
}
$res['msg'] = $msg;
$res['api'] = 'AliDirect';
$res['stamp'] = basReq::val('notify_time');
require_once(dirname(dirname(__FILE__))."/paydemo_dir/xresult.php");



/*******************************************************************************
 File : \root\a3rd\alipay_direct\alipay.config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/alipay_direct');
define('LIBS_PAYRUN', DIR_VENDOR.'/a3rd/alipay_class');
/* *
 * 配置文件
 * 版本：3.3
 * 日期：2012-07-19
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 * 该代码仅供学习和研究支付宝接口使用，只是提供一个参考。
	
 * 提示：如何获取安全校验码和合作身份者id
 * 1.用您的签约支付宝账号登录支付宝网站(www.alipay.com)
 * 2.点击“商家服务”(https://b.alipay.com/order/myorder.htm)
 * 3.点击“查询合作者身份(pid)”、“查询安全校验码(key)”
	
 * 安全校验码查看时，输入支付密码后，页面呈灰色的现象，怎么办？
 * 解决方法：
 * 1、检查浏览器配置，不让浏览器做弹框屏蔽设置
 * 2、更换浏览器或电脑，重新登录查询。
 */
 
//↓↓↓↓↓↓↓↓↓↓请在这里配置您的基本信息↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
//合作身份者id，以2088开头的16位纯数字
$alipay_config['partner']		= $pay_uinfo['ali']['partner'];

//收款支付宝账号
$alipay_config['seller_email']	= $pay_uinfo['ali']['email'];

//安全检验码，以数字和字母组成的32位字符
$alipay_config['key']			= $pay_uinfo['ali']['key'];


//↑↑↑↑↑↑↑↑↑↑请在这里配置您的基本信息↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑


//签名方式 不需修改
$alipay_config['sign_type']    = strtoupper('MD5');

//字符编码格式 目前支持 gbk 或 utf-8
$alipay_config['input_charset']= strtolower('utf-8');

//ca证书路径地址，用于curl中ssl校验
//请保证cacert.pem文件在当前文件夹目录中
$alipay_config['cacert']    = DIR_VENDOR.'/a3rd/alipay_class/cacert.pem';

//访问模式,根据自己的服务器是否支持ssl访问，若支持请选择https；若不支持请选择http
$alipay_config['transport']    = 'http';
?>


/*******************************************************************************
 File : \root\a3rd\alipay_direct\index.php 
*******************************************************************************/
<?php
/* *
 * 功能：支付宝即时到账交易接口接口调试入口页面
 * 版本：3.3
 * 日期：2012-07-23
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 */
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
	<title>支付宝即时到账交易接口接口</title>
	<meta charset="utf-8">
<style>
*{
	margin:0;
	padding:0;
}
ul,ol{
	list-style:none;
}
.title{
    color: #ADADAD;
    font-size: 14px;
    font-weight: bold;
    padding: 8px 16px 5px 10px;
}
.hidden{
	display:none;
}

.new-btn-login-sp{
	border:1px solid #D74C00;
	padding:1px;
	display:inline-block;
}

.new-btn-login{
    background-color: #ff8c00;
	color: #FFFFFF;
    font-weight: bold;
	border: medium none;
	width:82px;
	height:28px;
}
.new-btn-login:hover{
    background-color: #ffa300;
	width: 82px;
	color: #FFFFFF;
    font-weight: bold;
    height: 28px;
}
.bank-list{
	overflow:hidden;
	margin-top:5px;
}
.bank-list li{
	float:left;
	width:153px;
	margin-bottom:5px;
}

#main{
	width:750px;
	margin:0 auto;
	font-size:14px;
	font-family:'宋体';
}
#logo{
	background-color: transparent;
    background-image: url("images/new-btn-fixed.png");
    border: medium none;
	background-position:0 0;
	width:166px;
	height:35px;
    float:left;
}
.red-star{
	color:#f00;
	width:10px;
	display:inline-block;
}
.null-star{
	color:#fff;
}
.content{
	margin-top:5px;
}

.content dt{
	width:160px;
	display:inline-block;
	text-align:right;
	float:left;
	
}
.content dd{
	margin-left:100px;
	margin-bottom:5px;
}
#foot{
	margin-top:10px;
}
.foot-ul li {
	text-align:center;
}
.note-help {
    color: #999999;
    font-size: 12px;
    line-height: 130%;
    padding-left: 3px;
}

.cashier-nav {
    font-size: 14px;
    margin: 15px 0 10px;
    text-align: left;
    height:30px;
    border-bottom:solid 2px #CFD2D7;
}
.cashier-nav ol li {
    float: left;
}
.cashier-nav li.current {
    color: #AB4400;
    font-weight: bold;
}
.cashier-nav li.last {
    clear:right;
}
.alipay_link {
    text-align:right;
}
.alipay_link a:link{
    text-decoration:none;
    color:#8D8D8D;
}
.alipay_link a:visited{
    text-decoration:none;
    color:#8D8D8D;
}
</style>
</head>
<body text=#000000 bgColor=#ffffff leftMargin=0 topMargin=4>
	<div id="main">
		<div id="head">
            <dl class="alipay_link">
                <a target="_blank" href="http://www.alipay.com/"><span>支付宝首页</span></a>|
                <a target="_blank" href="https://b.alipay.com/home.htm"><span>商家服务</span></a>|
                <a target="_blank" href="http://help.alipay.com/support/index_sh.htm"><span>帮助中心</span></a>
            </dl>
            <span class="title">支付宝即时到账交易接口快速通道</span>
		</div>
        <div class="cashier-nav">
            <ol>
				<li class="current">1、确认信息 →</li>
				<li>2、点击确认 →</li>
				<li class="last">3、确认完成</li>
            </ol>
        </div>
        <form name=alipayment action=uapi.php method=post target="_blank">
            <div id="body" style="clear:left">
                <dl class="content">
                    <dt>商户订单号：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="ordid" value="ord_<?php echo microtime(1); ?>" size="30" />
                        <span>商户网站订单系统中唯一订单号，必填
</span>
                    </dd>
                    <dt>订单名称：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="title" value="testName" size="30" />
                        <span>必填
</span>
                    </dd>
                    <dt>付款金额：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="feetotle" value="0.01" size="30" />
                        <span>必填
</span>
                    </dd>
                    <dt>订单描述
：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="ordbody" value="testDescription" size="30" />
                        <span></span>
                    </dd>
                    <dt>商品展示地址：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="showurl" value="http://www.domain.com/item/1234.php" size="30" />
                        <span>需以http://开头的完整路径，例如：http://www.商户网址.com/myorder.html
</span>
                    </dd>
					<dt></dt>
                    <dd>
                        <span class="new-btn-login-sp">
                            <button class="new-btn-login" type="submit" style="text-align:center;">确 认</button>
                        </span>
                    </dd>
                </dl>
            </div>
		</form>
        <div id="foot">
			<ul class="foot-ul">
				<li><font class="note-help">如果您点击“确认”按钮，即表示您同意该次的执行操作。 </font></li>
				<li>
					支付宝版权所有 2011-2015 ALIPAY.COM 
				</li>
			</ul>
		</div>
	</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_direct\uapi.php 
*******************************************************************************/
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta charset="utf-8">
	<title>支付宝即时到账交易接口接口</title>
    <style type="text/css">.tc { text-align:center; }</style>
</head>
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_submit.class.php");
//logResult('test');
/**************************请求参数**************************/

//支付类型
$payment_type = "1"; 
//必填，不能修改

//服务器异步通知页面路径
$notify_url = $_cbase['run']['roots']."/a3rd/alipay_direct/unotify.php";
//需http://格式的完整路径，不能加?id=123这类自定义参数
//页面跳转同步通知页面路径
$return_url = $_cbase['run']['roots']."/a3rd/alipay_direct/ureturn.php";
//需http://格式的完整路径，不能加?id=123这类自定义参数，不能写成http://localhost/

//商户订单号
$out_trade_no = $_POST['ordid'];
//商户网站订单系统中唯一订单号，必填

//订单名称
$subject = $_POST['title'];
//必填

//付款金额
$total_fee = $_POST['feetotle'];
//必填

//订单描述

$body = $_POST['ordbody'];
//商品展示地址
$show_url = $_POST['showurl'];
//需以http://开头的完整路径，例如：http://www.商户网址.com/myorder.html

//防钓鱼时间戳
$anti_phishing_key = "";
//若要使用请调用类文件submit中的query_timestamp函数

//客户端的IP地址
$exter_invoke_ip = "";
//非局域网的外网IP地址，如：221.0.0.1

/************************************************************/

//构造要请求的参数数组，无需改动
$parameter = array(
		"service" => "create_direct_pay_by_user",
		"partner" => trim($alipay_config['partner']),
		"seller_email" => trim($alipay_config['seller_email']),
		"payment_type"	=> $payment_type,
		"notify_url"	=> $notify_url,
		"return_url"	=> $return_url,
		"out_trade_no"	=> $out_trade_no,
		"subject"	=> $subject,
		"total_fee"	=> $total_fee,
		"body"	=> $body,
		"show_url"	=> $show_url,
		"anti_phishing_key"	=> $anti_phishing_key,
		"exter_invoke_ip"	=> $exter_invoke_ip,
		"_input_charset"	=> trim(strtolower($alipay_config['input_charset']))
);

//建立请求
$alipaySubmit = new AlipaySubmit($alipay_config);
$html_text = $alipaySubmit->buildRequestForm($parameter,"get", "确认");
//$html_text = htmlentities($html_text);
echo "<p class='tc'>$html_text</p>";

?>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_direct\unotify.php 
*******************************************************************************/
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyNotify();

if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表
	
	//商户订单号
	$out_trade_no = $_POST['out_trade_no'];

	//支付宝交易号
	$trade_no = $_POST['trade_no'];

	//交易状态
	$trade_status = $_POST['trade_status'];

    if($_POST['trade_status'] == 'TRADE_FINISHED') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
				
		//注意：
		//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
    else if ($_POST['trade_status'] == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
				
		//注意：
		//付款完成后，支付宝系统发送该交易状态通知

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
        
	echo "success";		//请不要修改或删除
	exvOpay::notifyAliDirect('success');
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    echo "fail";
	exvOpay::notifyAliDirect('fail');

    //调试用，写文本函数记录程序运行情况是否正常
    //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
}



/*******************************************************************************
 File : \root\a3rd\alipay_direct\ureturn.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyReturn();
if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代码
	
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表

	//商户订单号
	$out_trade_no = $_GET['out_trade_no'];

	//支付宝交易号
	$trade_no = $_GET['trade_no'];

	//交易状态
	$trade_status = $_GET['trade_status'];

    if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
    }
    else {
      //echo "trade_status=".$_GET['trade_status'];
    }
		
	$msg = "验证成功";

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    //如要调试，请看alipay_notify.php页面的verifyReturn函数
    $msg = "验证失败";
}

$cfg = array(
	'ordid'=>'out_trade_no',
	'feeamount'=>'total_fee',
	'apino'=>'trade_no',
	'status'=>'trade_status',
);
foreach($cfg as $k1=>$k2){ 
	$res[$k1] = basReq::val($k2);  
}
$res['msg'] = $msg;
$res['api'] = 'AliDirect';
$res['stamp'] = basReq::val('notify_time');
require_once(dirname(dirname(__FILE__))."/paydemo_dir/xresult.php");



/*******************************************************************************
 File : \root\a3rd\alipay_wapdir\alipay.config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/alipay_wapdir');
define('LIBS_PAYRUN', DIR_VENDOR.'/a3rd/alipay_class');
/* *
 * 配置文件
 * 版本：3.3
 * 日期：2012-07-19
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 * 该代码仅供学习和研究支付宝接口使用，只是提供一个参考。
	
 * 提示：如何获取安全校验码和合作身份者id
 * 1.用您的签约支付宝账号登录支付宝网站(www.alipay.com)
 * 2.点击“商家服务”(https://b.alipay.com/order/myorder.htm)
 * 3.点击“查询合作者身份(pid)”、“查询安全校验码(key)”
	
 * 安全校验码查看时，输入支付密码后，页面呈灰色的现象，怎么办？
 * 解决方法：
 * 1、检查浏览器配置，不让浏览器做弹框屏蔽设置
 * 2、更换浏览器或电脑，重新登录查询。
 */
 
//↓↓↓↓↓↓↓↓↓↓请在这里配置您的基本信息↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
//合作身份者id，以2088开头的16位纯数字
$alipay_config['partner']			= $pay_uinfo['ali']['partner'];

//收款支付宝账号
$alipay_config['seller_id']			= $pay_uinfo['ali']['email']; 

//商户的私钥（后缀是.pen）文件相对路径
$alipay_config['private_key_path']	= 'key/rsa_private_key.pem';

//支付宝公钥（后缀是.pen）文件相对路径
$alipay_config['ali_public_key_path']= 'key/alipay_public_key.pem';

//安全检验码，以数字和字母组成的32位字符
$alipay_config['key']			= $pay_uinfo['ali']['key'];

//↑↑↑↑↑↑↑↑↑↑请在这里配置您的基本信息↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑


//签名方式 不需修改
$alipay_config['sign_type']    = 'MD5'; //0001,MD5

//字符编码格式 目前支持 gbk 或 utf-8
$alipay_config['input_charset']= strtolower('utf-8');

//ca证书路径地址，用于curl中ssl校验
//请保证cacert.pem文件在当前文件夹目录中
$alipay_config['cacert']    = DIR_VENDOR.'/a3rd/alipay_class/cacert.pem';

//访问模式,根据自己的服务器是否支持ssl访问，若支持请选择https；若不支持请选择http
$alipay_config['transport']    = 'http';
?>


/*******************************************************************************
 File : \root\a3rd\alipay_wapdir\index.php 
*******************************************************************************/
<?php
/* *
 * 功能：支付宝支付宝手机网页支付调试入口页面
 * 版本：3.3
 * 日期：2012-07-23
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 */

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
	<title>支付宝手机网页支付</title>
	<meta charset="utf-8">
<style>
*{
	margin:0;
	padding:0;
}
ul,ol{
	list-style:none;
}
.title{
    color: #ADADAD;
    font-size: 14px;
    font-weight: bold;
    padding: 8px 16px 5px 10px;
}
.hidden{
	display:none;
}

.new-btn-login-sp{
	border:1px solid #D74C00;
	padding:1px;
	display:inline-block;
}

.new-btn-login{
	background-color: #ff8c00;
	color: #FFFFFF;
	font-weight: bold;
	border: medium none;
	width:82px;
	height:28px;
}
.new-btn-login:hover{
	background-color: #ffa300;
	width: 82px;
	color: #FFFFFF;
	font-weight: bold;
	height: 28px;
}
.bank-list{
	overflow:hidden;
	margin-top:5px;
}
.bank-list li{
	float:left;
	width:153px;
	margin-bottom:5px;
}

#main{
	width:455px;
	margin:0 auto;
	font-size:14px;
	font-family:'宋体';
}
#logo{
	background-color: transparent;
    background-image: url("images/new-btn-fixed.png");
    border: medium none;
	background-position:0 0;
	width:166px;
	height:35px;
    float:left;
}
.red-star{
	color:#f00;
	width:10px;
	display:inline-block;
}
.null-star{
	color:#fff;
}
.content{
	margin-top:5px;
}

.content dt{
	width:160px;
	display:inline-block;
	text-align:right;
	float:left;
	
}
.content dd{
	margin-left:100px;
	margin-bottom:5px;
}
#foot{
	margin-top:10px;
}
.foot-ul li {
	text-align:center;
}
.note-help {
    color: #999999;
    font-size: 12px;
    line-height: 130%;
    padding-left: 3px;
}

.cashier-nav {
    font-size: 14px;
    margin: 15px 0 10px;
    text-align: left;
    height:30px;
    border-bottom:solid 2px #CFD2D7;
}
.cashier-nav ol li {
    float: left;
}
.cashier-nav li.current {
    color: #AB4400;
    font-weight: bold;
}
.cashier-nav li.last {
    clear:right;
}
.alipay_link {
    text-align:right;
}
.alipay_link a:link{
    text-decoration:none;
    color:#8D8D8D;
}
.alipay_link a:visited{
    text-decoration:none;
    color:#8D8D8D;
}
</style>
</head>
<body>
	<div id="main">
		<div id="head">
            <dl class="alipay_link">
                <a target="_blank" href="http://www.alipay.com/"><span>支付宝首页</span></a>|
                <a target="_blank" href="https://b.alipay.com/home.htm"><span>商家服务</span></a>|
                <a target="_blank" href="http://help.alipay.com/support/index_sh.htm"><span>帮助中心</span></a>
            </dl>
            <span class="title">支付宝手机网页支付快速通道</span>
		</div>
        <div class="cashier-nav">
            <ol>
				<li class="current">1、确认信息 →</li>
				<li>2、点击确认 →</li>
				<li class="last">3、确认完成</li>
            </ol>
        </div>
        <form name=alipayment action='uapi.php' method=post target="_blank">
            <div id="body" style="clear:left">
                <dl class="content">
                    <dt>商户订单号：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="WIDout_trade_no" value="ord_<?php echo microtime(1); ?>" />
                        <span></span>
                    </dd>
                    <dt>订单名称：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="WIDsubject" value="<?php echo time(); ?>" />
                        <span></span>
                    </dd>
                    <dt>付款金额：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input size="30" name="WIDtotal_fee" value="0.01" />
                        <span></span>
                    </dd>
					<dt></dt>
                    <dd>
                        <span class="new-btn-login-sp">
                            <button class="new-btn-login" type="submit" style="text-align:center;">确 认</button>
                        </span>
                    </dd>
                </dl>
            </div>
		</form>
        <div id="foot">
			<ul class="foot-ul">
				<li><font class="note-help">如果您点击“确认”按钮，即表示您同意该次的执行操作。 </font></li>
				<li>
					支付宝版权所有 2011-2015 ALIPAY.COM 
				</li>
			</ul>
		</div>
	</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_wapdir\uapi.php 
*******************************************************************************/
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta charset="utf-8">
	<title>支付宝即时到账交易接口接口</title>
    <style type="text/css">.tc { text-align:center; }</style>
</head>
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_smob.class.php");

/**************************调用授权接口alipay.wap.trade.create.direct获取授权码token**************************/
	
//返回格式
$format = "xml";
//必填，不需要修改

//返回格式
$v = "2.0";
//必填，不需要修改

//请求号
$req_id = date('Ymdhis');
//必填，须保证每次请求都是唯一

//**req_data详细信息**

//服务器异步通知页面路径
$notify_url = $_cbase['run']['roots']."/a3rd/alipay_wapdir/unotify.php";
//需http://格式的完整路径，不允许加?id=123这类自定义参数

//页面跳转同步通知页面路径
$call_back_url = $_cbase['run']['roots']."/a3rd/alipay_wapdir/ureturn.php";
//需http://格式的完整路径，不允许加?id=123这类自定义参数

//操作中断返回地址
$merchant_url = "http://127.0.0.1:8800/WS_WAP_PAYWAP-PHP-UTF-8/xxxx.php";
//用户付款中途退出返回商户的地址。需http://格式的完整路径，不允许加?id=123这类自定义参数

//商户订单号
$out_trade_no = $_POST['WIDout_trade_no'];
//商户网站订单系统中唯一订单号，必填

//订单名称
$subject = $_POST['WIDsubject'];
//必填

//付款金额
$total_fee = $_POST['WIDtotal_fee'];
//必填

//请求业务参数详细
$req_data = '<direct_trade_create_req><notify_url>' . $notify_url . '</notify_url><call_back_url>' . $call_back_url . '</call_back_url><seller_account_name>' . trim($alipay_config['seller_id']) . '</seller_account_name><out_trade_no>' . $out_trade_no . '</out_trade_no><subject>' . $subject . '</subject><total_fee>' . $total_fee . '</total_fee><merchant_url>' . $merchant_url . '</merchant_url></direct_trade_create_req>';
//必填

/************************************************************/

//构造要请求的参数数组，无需改动
$para_token = array(
		"service" => "alipay.wap.trade.create.direct",
		"partner" => trim($alipay_config['partner']),
		"sec_id" => trim($alipay_config['sign_type']),
		"format"	=> $format,
		"v"	=> $v,
		"req_id"	=> $req_id,
		"req_data"	=> $req_data,
		"_input_charset"	=> trim(strtolower($alipay_config['input_charset']))
);

//建立请求
$alipaySubmit = new AlipaySubmit($alipay_config);
$html_text = $alipaySubmit->buildRequestHttp($para_token);

//URLDECODE返回的信息
$html_text = urldecode($html_text);

//解析远程模拟提交后返回的信息
$para_html_text = $alipaySubmit->parseResponse($html_text);

//获取request_token
$request_token = $para_html_text['request_token'];

/**************************根据授权码token调用交易接口alipay.wap.auth.authAndExecute**************************/

//业务详细
$req_data = '<auth_and_execute_req><request_token>' . $request_token . '</request_token></auth_and_execute_req>';
//必填

//构造要请求的参数数组，无需改动
$parameter = array(
		"service" => "alipay.wap.auth.authAndExecute",
		"partner" => trim($alipay_config['partner']),
		"sec_id" => trim($alipay_config['sign_type']),
		"format"	=> $format,
		"v"	=> $v,
		"req_id"	=> $req_id,
		"req_data"	=> $req_data,
		"_input_charset"	=> trim(strtolower($alipay_config['input_charset']))
);

//建立请求
$alipaySubmit = new AlipaySubmit($alipay_config);
$html_text = $alipaySubmit->buildRequestForm($parameter, 'get', '确认');
//$html_text = htmlentities($html_text);
echo "<p class='tc'>$html_text</p>";
?>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_wapdir\unotify.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyNotify();

if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表
	
	//商户订单号
	$out_trade_no = $_POST['out_trade_no'];

	//支付宝交易号
	$trade_no = $_POST['trade_no'];

	//交易状态
	$trade_status = $_POST['trade_status'];

    if($_POST['trade_status'] == 'TRADE_FINISHED') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
				
		//注意：
		//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
    else if ($_POST['trade_status'] == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
				
		//注意：
		//付款完成后，支付宝系统发送该交易状态通知

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
        
	echo "success";		//请不要修改或删除
	exvOpay::notifyAliWapdir('success');
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    echo "fail";
	exvOpay::notifyAliWapdir('fail');

    //调试用，写文本函数记录程序运行情况是否正常
    //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
}
?>


/*******************************************************************************
 File : \root\a3rd\alipay_wapdir\ureturn.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyReturn();

if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代码
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表

	//商户订单号
	$out_trade_no = $_GET['out_trade_no'];

	//支付宝交易号
	$trade_no = $_GET['trade_no'];

	//交易状态
	$trade_status = $_GET['trade_status'];

    if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
    }
    else {
      //echo "trade_status=".$_GET['trade_status'];
    }
		
	$msg = "验证成功";

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    //如要调试，请看alipay_notify.php页面的verifyReturn函数
    $msg = "验证失败";
}

$cfg = array(
	'ordid'=>'out_trade_no',
	'feeamount'=>'total_fee',
	'apino'=>'trade_no',
	'status'=>'trade_status',
);
foreach($cfg as $k1=>$k2){ 
	$res[$k1] = basReq::val($k2);  
}
$res['msg'] = $msg;
$res['api'] = 'AliWapdir';
$res['stamp'] = basReq::val('notify_time');
require_once(dirname(dirname(__FILE__))."/paydemo_dir/xresult.php");



/*******************************************************************************
 File : \root\a3rd\alipay_wscow\alipay.config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/alipay_wscow');
define('LIBS_PAYRUN', DIR_VENDOR.'/a3rd/alipay_class');
/* *
 * 配置文件
 * 版本：3.3
 * 日期：2012-07-19
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 * 该代码仅供学习和研究支付宝接口使用，只是提供一个参考。
	
 * 提示：如何获取安全校验码和合作身份者id
 * 1.用您的签约支付宝账号登录支付宝网站(www.alipay.com)
 * 2.点击“商家服务”(https://b.alipay.com/order/myorder.htm)
 * 3.点击“查询合作者身份(pid)”、“查询安全校验码(key)”
	
 * 安全校验码查看时，输入支付密码后，页面呈灰色的现象，怎么办？
 * 解决方法：
 * 1、检查浏览器配置，不让浏览器做弹框屏蔽设置
 * 2、更换浏览器或电脑，重新登录查询。
 */
 
//↓↓↓↓↓↓↓↓↓↓请在这里配置您的基本信息↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
//合作身份者id，以2088开头的16位纯数字
$alipay_config['partner']		= $pay_uinfo['ali']['partner'];

//收款支付宝账号
$alipay_config['seller_email']	= $pay_uinfo['ali']['email'];

//安全检验码，以数字和字母组成的32位字符
$alipay_config['key']			= $pay_uinfo['ali']['key'];


//↑↑↑↑↑↑↑↑↑↑请在这里配置您的基本信息↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑


//签名方式 不需修改
$alipay_config['sign_type']    = strtoupper('MD5');

//字符编码格式 目前支持 gbk 或 utf-8
$alipay_config['input_charset']= strtolower('utf-8');

//ca证书路径地址，用于curl中ssl校验
//请保证cacert.pem文件在当前文件夹目录中
$alipay_config['cacert']    = DIR_VENDOR.'/a3rd/alipay_class/cacert.pem';

//访问模式,根据自己的服务器是否支持ssl访问，若支持请选择https；若不支持请选择http
$alipay_config['transport']    = 'http';
?>


/*******************************************************************************
 File : \root\a3rd\alipay_wscow\index.php 
*******************************************************************************/
<?php
/* *
 * 功能：支付宝纯担保交易接口接口调试入口页面
 * 版本：3.3
 * 日期：2012-07-23
 * 说明：
 * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
 */
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
	<title>支付宝纯担保交易接口接口</title>
	<meta charset="utf-8">
<style>
*{
	margin:0;
	padding:0;
}
ul,ol{
	list-style:none;
}
.title{
    color: #ADADAD;
    font-size: 14px;
    font-weight: bold;
    padding: 8px 16px 5px 10px;
}
.hidden{
	display:none;
}

.new-btn-login-sp{
	border:1px solid #D74C00;
	padding:1px;
	display:inline-block;
}

.new-btn-login{
    background-color: #ff8c00;
	color: #FFFFFF;
    font-weight: bold;
	border: medium none;
	width:82px;
	height:28px;
}
.new-btn-login:hover{
    background-color: #ffa300;
	width: 82px;
	color: #FFFFFF;
    font-weight: bold;
    height: 28px;
}
.bank-list{
	overflow:hidden;
	margin-top:5px;
}
.bank-list li{
	float:left;
	width:153px;
	margin-bottom:5px;
}

#main{
	width:750px;
	margin:0 auto;
	font-size:14px;
	font-family:'宋体';
}
#logo{
	background-color: transparent;
    background-image: url("images/new-btn-fixed.png");
    border: medium none;
	background-position:0 0;
	width:166px;
	height:35px;
    float:left;
}
.red-star{
	color:#f00;
	width:10px;
	display:inline-block;
}
.null-star{
	color:#fff;
}
.content{
	margin-top:5px;
}

.content dt{
	width:160px;
	display:inline-block;
	text-align:right;
	float:left;
	
}
.content dd{
	margin-left:100px;
	margin-bottom:5px;
}
#foot{
	margin-top:10px;
}
.foot-ul li {
	text-align:center;
}
.note-help {
    color: #999999;
    font-size: 12px;
    line-height: 130%;
    padding-left: 3px;
}

.cashier-nav {
    font-size: 14px;
    margin: 15px 0 10px;
    text-align: left;
    height:30px;
    border-bottom:solid 2px #CFD2D7;
}
.cashier-nav ol li {
    float: left;
}
.cashier-nav li.current {
    color: #AB4400;
    font-weight: bold;
}
.cashier-nav li.last {
    clear:right;
}
.alipay_link {
    text-align:right;
}
.alipay_link a:link{
    text-decoration:none;
    color:#8D8D8D;
}
.alipay_link a:visited{
    text-decoration:none;
    color:#8D8D8D;
}
</style>
</head>
<body text=#000000 bgColor=#ffffff leftMargin=0 topMargin=4>
	<div id="main">
		<div id="head">
            <dl class="alipay_link">
                <a target="_blank" href="http://www.alipay.com/"><span>支付宝首页</span></a>|
                <a target="_blank" href="https://b.alipay.com/home.htm"><span>商家服务</span></a>|
                <a target="_blank" href="http://help.alipay.com/support/index_sh.htm"><span>帮助中心</span></a>
            </dl>
            <span class="title">支付宝纯担保交易接口快速通道</span>
		</div>
        <div class="cashier-nav">
            <ol>
				<li class="current">1、确认信息 →</li>
				<li>2、点击确认 →</li>
				<li class="last">3、确认完成</li>
            </ol>
        </div>
        <form name=alipayment action=uapi.php method=post target="_blank">
            <div id="body" style="clear:left">
                <dl class="content">
                    <dt>商户订单号：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="ordid" value="ord_<?php echo microtime(1); ?>" size="30" />
                        <span>商户网站订单系统中唯一订单号，必填
</span>
                    </dd>
                    <dt>订单名称：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="title" value="testName" size="30" />
                        <span>必填
</span>
                    </dd>
                    <dt>付款金额：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="feetotle" value="0.01" size="30" />
                        <span>必填
</span>
                    </dd>
                    <dt>订单描述
：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="ordbody" value="testDescription" size="30" />
                        <span></span>
                    </dd>
                    <dt>商品展示地址：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="showurl" value="http://www.domain.com/item/1234.php" size="30" />
                        <span>需以http://开头的完整路径，如：http://www.商户网站.com/myorder.html
</span>
                    </dd>
                    <dt>收货人姓名：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="receive_name" value="zhsan" size="30" />
                        <span>如：张三
</span>
                    </dd>
                    <dt>收货人地址：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="receive_address" value="zs_dizhi" size="30" />
                        <span>如：XX省XXX市XXX区XXX路XXX小区XXX栋XXX单元XXX号
</span>
                    </dd>
                    <dt>收货人邮编：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="receive_zip" value="123456" size="30" />
                        <span>如：123456
</span>
                    </dd>
                    <dt>收货人电话号码：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="receive_phone" value="0999-12345678" size="30" />
                        <span>如：0571-88158090
</span>
                    </dd>
                    <dt>收货人手机号码：</dt>
                    <dd>
                        <span class="null-star">*</span>
                        <input name="receive_mobile" value="13012345678" size="30" />
                        <span>如：13312341234</span>
                    </dd>
					<dt></dt>
                    <dd>
                        <span class="new-btn-login-sp">
                            <button class="new-btn-login" type="submit" style="text-align:center;">确 认</button>
                        </span>
                    </dd>
                </dl>
            </div>
		</form>
        <div id="foot">
			<ul class="foot-ul">
				<li><font class="note-help">如果您点击“确认”按钮，即表示您同意该次的执行操作。 </font></li>
				<li>
					支付宝版权所有 2011-2015 ALIPAY.COM 
				</li>
			</ul>
		</div>
	</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_wscow\uapi.php 
*******************************************************************************/
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta charset="utf-8">
	<title>支付宝纯担保交易接口接口</title>
    <style type="text/css">.tc { text-align:center; }</style>
</head>
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_submit.class.php");

/**************************请求参数**************************/

        //支付类型
        $payment_type = "1";
        //必填，不能修改
		
        //服务器异步通知页面路径
        $notify_url = $_cbase['run']['roots']."/a3rd/alipay_wscow/unotify_url.php";
        //需http://格式的完整路径，不能加?id=123这类自定义参数

        //页面跳转同步通知页面路径
        $return_url = $_cbase['run']['roots']."/a3rd/alipay_wscow/ureturn_url.php";
        //需http://格式的完整路径，不能加?id=123这类自定义参数，不能写成http://localhost/

        //商户订单号
        $out_trade_no = $_POST['ordid'];
        //商户网站订单系统中唯一订单号，必填

        //订单名称
        $subject = $_POST['title'];
        //必填

        //付款金额
        $price = $_POST['feetotle'];
        //必填

        //商品数量
        $quantity = "1";
        //必填，建议默认为1，不改变值，把一次交易看成是一次下订单而非购买一件商品
        //物流费用
        $logistics_fee = "0.00";
        //必填，即运费
        //物流类型
        $logistics_type = "EXPRESS";
        //必填，三个值可选：EXPRESS（快递）、POST（平邮）、EMS（EMS）
        //物流支付方式
        $logistics_payment = "SELLER_PAY";
        //必填，两个值可选：SELLER_PAY（卖家承担运费）、BUYER_PAY（买家承担运费）
        //订单描述

        $body = $_POST['ordbody'];
        //商品展示地址
        $show_url = $_POST['showurl'];
        //需以http://开头的完整路径，如：http://www.商户网站.com/myorder.html

        //收货人姓名
        $receive_name = $_POST['receive_name'];
        //如：张三

        //收货人地址
        $receive_address = $_POST['receive_address'];
        //如：XX省XXX市XXX区XXX路XXX小区XXX栋XXX单元XXX号

        //收货人邮编
        $receive_zip = $_POST['receive_zip'];
        //如：123456

        //收货人电话号码
        $receive_phone = $_POST['receive_phone'];
        //如：0571-88158090

        //收货人手机号码
        $receive_mobile = $_POST['receive_mobile'];
        //如：13312341234

/************************************************************/

//构造要请求的参数数组，无需改动
$parameter = array(
		"service" => "create_partner_trade_by_buyer",
		"partner" => trim($alipay_config['partner']),
		"seller_email" => trim($alipay_config['seller_email']),
		"payment_type"	=> $payment_type,
		"notify_url"	=> $notify_url,
		"return_url"	=> $return_url,
		"out_trade_no"	=> $out_trade_no,
		"subject"	=> $subject,
		"price"	=> $price,
		"quantity"	=> $quantity,
		"logistics_fee"	=> $logistics_fee,
		"logistics_type"	=> $logistics_type,
		"logistics_payment"	=> $logistics_payment,
		"body"	=> $body,
		"show_url"	=> $show_url,
		"receive_name"	=> $receive_name,
		"receive_address"	=> $receive_address,
		"receive_zip"	=> $receive_zip,
		"receive_phone"	=> $receive_phone,
		"receive_mobile"	=> $receive_mobile,
		"_input_charset"	=> trim(strtolower($alipay_config['input_charset']))
);

//建立请求
$alipaySubmit = new AlipaySubmit($alipay_config);
$html_text = $alipaySubmit->buildRequestForm($parameter,"get", "确认");
echo "<p class='tc'>$html_text</p>";

?>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\alipay_wscow\unotify.php 
*******************************************************************************/
<?php

require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyNotify();

if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表
	
	//商户订单号
	$out_trade_no = $_POST['out_trade_no'];

	//支付宝交易号
	$trade_no = $_POST['trade_no'];

	//交易状态
	$trade_status = $_POST['trade_status'];

	if($_POST['trade_status'] == 'WAIT_BUYER_PAY') {
	//该判断表示买家已在支付宝交易管理中产生了交易记录，但没有付款
	
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
	else if($_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {
	//该判断表示买家已在支付宝交易管理中产生了交易记录且付款成功，但卖家没有发货
	
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
	else if($_POST['trade_status'] == 'WAIT_BUYER_CONFIRM_GOODS') {
	//该判断表示卖家已经发了货，但买家还没有做确认收货的操作
	
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序

        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
	else if($_POST['trade_status'] == 'TRADE_FINISHED') {
	//该判断表示买家已经确认收货，这笔交易完成
	
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
        //调试用，写文本函数记录程序运行情况是否正常
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
    else {
		//其他状态判断
        //调试用，写文本函数记录程序运行情况是否正常
        //logResult ("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }
	
	echo "success";
	exvOpay::notifyAliWscow('fail');
	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    echo "fail";
	exvOpay::notifyAliWscow('fail');

    //调试用，写文本函数记录程序运行情况是否正常
    //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
}



/*******************************************************************************
 File : \root\a3rd\alipay_wscow\ureturn.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/alipay.config.php");
require_once(LIBS_PAYRUN."/alipay_notify.class.php");

//计算得出通知验证结果
$alipayNotify = new AlipayNotify($alipay_config);
$verify_result = $alipayNotify->verifyReturn();
if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代码
	
	//――请根据您的业务逻辑来编写程序（以下代码仅作参考）――
    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表

	//商户订单号
	$out_trade_no = $_GET['out_trade_no'];

	//支付宝交易号
	$trade_no = $_GET['trade_no'];

	//交易状态
	$trade_status = $_GET['trade_status'];

    if($_GET['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {
		//判断该笔订单是否在商户网站中已经做过处理
			//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
			//如果有做过处理，不执行商户的业务程序
    }
    else {
      //echo "trade_status=".$_GET['trade_status'];
    }
		
	$msg = "验证成功";
	//echo "trade_no=".$trade_no;

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    //如要调试，请看alipay_notify.php页面的verifyReturn函数
    $msg = "验证失败";
}

$cfg = array(
	'ordid'=>'out_trade_no',
	'feeamount'=>'total_fee',
	'apino'=>'trade_no',
	'status'=>'trade_status',
);
foreach($cfg as $k1=>$k2){ 
	$res[$k1] = basReq::val($k2);  
}
$res['msg'] = $msg;
$res['api'] = 'AliWscow';
$res['stamp'] = basReq::val('notify_time');
require_once(dirname(dirname(__FILE__))."/paydemo_dir/xresult.php");



/*******************************************************************************
 File : \root\a3rd\paydemo_dir\config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/paydemo_dir');
define('LIBS_PAYRUN', DIR_PAYRUN);

function dmgetPost(){
	$post = array();
	foreach($_POST as $k=>$v){
		if(!strstr($k,'_post_')) continue;
		$key = str_replace('_post_','',$k);
		$post[$key]	= $v;
	}
	return $post;
}
function dmdoSend(){
	$data = dmgetPost();
	$dobj = array();
	$cfgorg = array('payment_type','out_trade_no','subject','total_fee','body');
	$cfgconv = array('service'=>'exterface','partner'=>'seller_id','seller_email'=>'seller_email');
	$cfgadd = array('is_success'=>'T','sign_type'=>'TRADE_SUCCESS','sign_type'=>'MD5','notify_type'=>'trade_status');
	foreach($cfgorg as $key){
		$dobj[$key] = $data[$key];
	}
	foreach($cfgconv as $key=>$val){
		$dobj[$val] = $data[$key];
	}
	foreach($cfgadd as $key=>$val){
		$dobj[$key] = $val;
	}
	$dobj['buyer_email'] = $dobj['buyer_id'] = basReq::ark('fm','uname');
	$dobj['trade_no'] =  basKeyid::kidTemp('(def)').'-'.basKeyid::kidRand('24',8);
	$dobj['notify_time'] = time();
	$dobj['notify_id'] = "{$dobj['notify_time']}.{$dobj['trade_no']}";
	$dobj['sign'] = comConvert::sysEncode($dobj['notify_id']);
	//通过curl post数据 ($data: str:xml,str:json,array)
	$sobj = '';
	foreach($dobj as $key=>$val){
		$sobj .= ($sobj ? '&' : '')."$key=$val";	
	}
	$urls = array('notify','return');
	foreach($urls as $key){
		$url = $data["{$key}_url"];
		$$key = $url.(strpos($url,'?') ? '&' : '?').$sobj;
	}
	$notice = comHttp::doGet($notify, $data, 3);
	//echo $return;
	header('Location:'.$return);
}
function dmdoCheck(){
	$stamp = time();
	$notify_time = basReq::val('notify_time');
	$trade_no = basReq::val('trade_no');
	$sign = basReq::val('sign');
	$enc = comConvert::sysEncode("$notify_time.$trade_no");
	$flag = ($enc==$sign) && ($stamp-$notify_time<60); //var_dump($flag);
	return $flag;
}

//↓↓↓↓↓↓↓↓↓↓请在这里配置您的基本信息↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
//合作身份者id，以2088开头的16位纯数字
$demopay_config['partner']		= $pay_uinfo['demo']['partner'];

//收款演示账号
$demopay_config['seller_email']	= $pay_uinfo['demo']['email'];

//安全检验码，以数字和字母组成的32位字符
$demopay_config['key']			= $pay_uinfo['demo']['key'];

//↑↑↑↑↑↑↑↑↑↑请在这里配置您的基本信息↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑

//签名方式 不需修改
$demopay_config['sign_type']    = strtoupper('MD5');

//字符编码格式 目前支持 gbk 或 utf-8
$demopay_config['input_charset']= strtolower('utf-8');

//访问模式,根据自己的服务器是否支持ssl访问，若支持请选择https；若不支持请选择http
$demopay_config['transport']    = 'http';
?>


/*******************************************************************************
 File : \root\a3rd\paydemo_dir\index.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/config.php");
?>
<!DOCTYPE html><html><head>
<title><?php lang('a3rd.demo_title',0); ?></title>
<meta charset="utf-8">
<style>
* { margin: 0; padding: 0; }
ul, ol { list-style: none; }
.title { color: #ADADAD; font-size: 14px; font-weight: bold; padding: 8px 16px 5px 10px; }
.hidden { display: none; }
.new-btn-login-sp { border: 1px solid #D74C00; padding: 1px; display: inline-block; }
.new-btn-login { background-color: #ff8c00; color: #FFFFFF; font-weight: bold; border: medium none; width: 82px; height: 28px; }
.new-btn-login:hover { background-color: #ffa300; width: 82px; color: #FFFFFF; font-weight: bold; height: 28px; }
.bank-list { overflow: hidden; margin-top: 5px; }
.bank-list li { float: left; width: 153px; margin-bottom: 5px; }
#main { width: 750px; margin: 0 auto; font-size: 14px; font-family: '宋体'; }
#logo { background-color: transparent; background-image: url("images/new-btn-fixed.png"); border: medium none; background-position: 0 0; width: 166px; height: 35px; float: left; }
.red-star { color: #f00; width: 10px; display: inline-block; }
.null-star { color: #fff; }
.content { margin-top: 5px; }
.content dt { width: 160px; display: inline-block; text-align: right; float: left; }
.content dd { margin-left: 100px; margin-bottom: 5px; }
#foot { margin-top: 10px; }
.foot-ul li { text-align: center; }
.note-help { color: #999999; font-size: 12px; line-height: 130%; padding-left: 3px; }
.cashier-nav { font-size: 14px; margin: 15px 0 10px; text-align: left; height: 30px; border-bottom: solid 2px #CFD2D7; }
.cashier-nav ol li { float: left; }
.cashier-nav li.current { color: #AB4400; font-weight: bold; }
.cashier-nav li.last { clear: right; }
.alipay_link { text-align: right; }
.alipay_link a:link { text-decoration: none; color: #8D8D8D; }
.alipay_link a:visited { text-decoration: none; color: #8D8D8D; }
</style>
</head>
<body text=#000000 bgColor=#ffffff leftMargin=0 topMargin=4>
<div id="main">
    <div id="head">
        <dl class="alipay_link">
            <a target="_blank" href="#"><span>Homepage</span></a>| <a target="_blank" href="#"><span>VIP Center</span></a>| <a target="_blank" href="#"><span>Help Center</span></a>
        </dl>
        <span class="title"><?php lang('a3rd.demo_title',0); ?></span> </div>
    <div class="cashier-nav">
        <ol>
            <li class="current">1. Step1 →</li>
            <li>2. Step2 →</li>
            <li class="last">3. Step3</li>
        </ol>
    </div>  

    <form name='demopayment' action='uapi.php' method='post' target="_blank">
        <div id="body" style="clear:left">
            <dl class="content">
                <dt><?php lang('a3rd.index_notitle',0); ?></dt>
                <dd> <span class="null-star">*</span>
                    <input name="out_trade_no" value="<?php echo basKeyid::kidTemp('(def)'); ?>" size="30" />
                    <span><?php lang('a3rd.index_tipno',0); ?></span> </dd>
                <dt><?php lang('a3rd.index_ordtitle',0); ?></dt>
                <dd> <span class="null-star">*</span>
                    <input name="subject" value="testName" size="30" />
                    <span><?php lang('a3rd.index_tipmust',0); ?> </span> </dd>
                <dt><?php lang('a3rd.index_ordamount',0); ?></dt>
                <dd> <span class="null-star">*</span>
                    <input name="total_fee" value="0.01" size="30" />
                    <span><?php lang('a3rd.index_tipmust',0); ?> </span> </dd>
                <dt><?php lang('a3rd.index_ordrem',0); ?></dt>
                <dd> <span class="null-star">*</span>
                    <input name="ordbody" value="testDescription" size="30" />
                    <span></span> </dd>
                <dt><?php lang('a3rd.index_ordurl',0); ?></dt>
                <dd> <span class="null-star">*</span>
                    <input name="show_url" value="http://www.domain.com/item/1234.php" size="30" />
                    <span>eg. http://www.my_domain.com/myorder.html </span> </dd>
                <dt></dt>
                <dd> <span class="new-btn-login-sp">
                    <button class="new-btn-login" type="submit" style="text-align:center;"><?php lang('a3rd.index_confirm',0); ?></button>
                    </span> </dd>
            </dl>
        </div>
    </form>
    <div id="foot">
        <ul class="foot-ul">
            <li><font class="note-help">Its JUST DEMO Pay Flow!</font></li>
            <li> Pay Demo Flow@2011-2016 </li>
        </ul>
    </div>
</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\paydemo_dir\payweb.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/config.php");
safComm::urlFrom();
$act = basReq::val('act');
$rndname = 'user_'.basKeyid::kidRand('24',8).'@domain.com';
$rndpass = 'pass_'.basKeyid::kidRand('fs3',18); 
$out_trade_no = basReq::val('out_trade_no');
$total_fee = basReq::val('total_fee');
if($act=='dologin'){
	$fm = $_POST['fm'];
	$re2 = safComm::formCAll('fmlpay');
	if(empty($re2[0])){ //OK
		$msg = lang('a3rd.payweb_loginok');
		dmdoSend();
	}else{
		$msg = lang('a3rd.payweb_erragain');	
	}
}else{
	$msg = lang('a3rd.payweb_copyto');	
}
?> 
<!DOCTYPE html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<title><?php lang('a3rd.demo_title',0); ?></title>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php"></script>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?act=autoJQ"></script>
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/skin/a_jscss/stpub.css'/>
<style type="text/css">
.pgu_login{ width:640px; border:1px solid #CCC; padding:2px; margin:10px auto; font-size:14px; }
.pgu_login p{ padding:5px; line-height:150%; }
.pgu_login p.button{ padding:0 50px; }
.pgu_login .apply{ width:280px; padding:10px 1px; float:right; }
.pgu_login .apply p{ padding:5px; }
.pgu_login .apply a{ cursor:pointer; }
.pgu_login p.title{ border-bottom:1px solid #CCC; padding-left:20px; }
.pgu_login .login{ width:350px; padding:10px 1px; float:left; }
.login i { font-style:normal; display:inline-block; width:65px; padding-left:10px; }
</style>
<link rel="shortcut icon" href="<?php echo PATH_ROOT; ?>/skin/a_img/favicon.ico" />
</head>
<body>
<div id="topMargin" style="display:none; border:0px solid #999;"></div>

<form action="?" method="post" name="fmlpay" id="fmlpay">
<div id="idx_login" class="pgu_login">
<p class="title">
	<span style="float:right"><?php lang('a3rd.payweb_tradeno',0); ?> <?php echo $out_trade_no; ?> &nbsp; <?php lang('a3rd.payweb_amount',0); ?> <?php echo $total_fee; ?></span>
    <b><?php lang('a3rd.demo_title',0); ?></b>
</p>  
<div class="apply">
  <p> <?php lang('a3rd.payweb_demoid',0); ?> <br>
    <a onClick="osetInfo(this,'uname')"><?php echo $rndname; ?></a> <br>
    <?php lang('a3rd.payweb_demopw',0); ?> <br>
    <a onClick="osetInfo(this,'upass')"><?php echo $rndpass; ?></a></p>
  <p> <?php echo $msg; ?><br><?php lang('a3rd.payweb_idpwtip',0); ?></p>
</div>
<div class="login">
  <p> <i><?php lang('uname',0); ?>: </i>
    <input id="fm[uname]" name="fm[uname]" tabindex="1" type="text" value="" class="txt w250" reg="key:2-48" autocomplete="off" tip="<?php lang('a3rd.payweb_letters316',0); ?>" />
  </p>
  <p> <i><?php lang('upass',0); ?>: </i>
    <input id="fm[upass]" name="fm[upass]" tabindex="2" type="password" value="" class="txt w250" reg="str:6-48" autocomplete="off" tip="<?php lang('a3rd.payweb_letters615',0); ?>" />
  </p>
  <p> <i><?php lang('vcode',0); ?>: </i>
    <script>fsInit('fmlpay');</script>
  </p>
  <p class="button"> <i class="right pt2 f14"><a href="index.php"><?php lang('a3rd.payweb_refresh',0); ?></a></i> 
    <input name="submit" value="<?php lang('submit',0); ?>" tabindex="19830" type="submit" class="btn" />
    <input name="act" type="hidden" value="dologin" />
  </p>
</div>
<div class="clear"></div>
</div>
<?php 
foreach($_POST as $k=>$v){ 
	if(is_array($v)) continue;
	$v = basReq::fmt($v,'','Safe4');
	echo "<input name='_post_{$k}' type='hidden' value='{$v}'>\n"; 
	if(in_array($k,array('out_trade_no','total_fee'))){
		echo "<input name='{$k}' type='hidden' value='{$v}'>\n";
	}
} 
?>
</form>
<script>
function ologinreset(){
	$("[name='fm[uname]']").val('');
	$("[name='fm[upass]']").val('0');
	$("[name='fm[upass]']").val('');
}
function osetInfo(e,key){
	$("[name='fm["+key+"]']").val($(e).html());
}
setTimeout('ologinreset()',300);
</script>

</body>
</html>

<script>winAutoMargin('topMargin');</script>


/*******************************************************************************
 File : \root\a3rd\paydemo_dir\uapi.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/config.php");
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta charset="utf-8">
<title><?php lang('a3rd.uapi_title',0); ?></title>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?act=autoJQ"></script>
<style type="text/css">.tc { text-align:center; }</style>
</head>
<?php
//logResult('test');
/**************************请求参数**************************/

//支付类型
$payment_type = "1"; 
//必填，不能修改

//服务器异步通知页面路径
$notify_url = $_cbase['run']['roots']."/a3rd/paydemo_dir/unotify.php";
//需http://格式的完整路径，不能加?id=123这类自定义参数
//页面跳转同步通知页面路径
$return_url = $_cbase['run']['roots']."/a3rd/paydemo_dir/ureturn.php";
//需http://格式的完整路径，不能加?id=123这类自定义参数，不能写成http://localhost/

//商户订单号
$out_trade_no = basReq::val('out_trade_no');
//商户网站订单系统中唯一订单号，必填

//订单名称
$subject = basReq::val('subject');
//必填

//付款金额
$total_fee = basReq::val('total_fee');
//必填

//订单描述
$body = basReq::val('ordbody');

//商品展示地址
$show_url = basReq::val('showurl','','Safe4');
//需以http://开头的完整路径，例如：http://www.商户网址.com/myorder.html

/************************************************************/

//构造要请求的参数数组，无需改动
$parameter = array(
		"service" => "create_direct_pay_by_user",
		"partner" => trim($demopay_config['partner']),
		"seller_email" => trim($demopay_config['seller_email']),
		"payment_type"	=> $payment_type,
		"notify_url"	=> $notify_url,
		"return_url"	=> $return_url,
		"out_trade_no"	=> $out_trade_no,
		"subject"	=> $subject,
		"total_fee"	=> $total_fee,
		"body"	=> $body,
		"show_url"	=> $show_url,
		"_input_charset"	=> trim(strtolower($demopay_config['input_charset']))
);

?>
<form id='fmopay' name='fmopay' method="post" action="<?php echo PATH_ROOT; ?>/a3rd/paydemo_dir/payweb.php" target="_self">
<?php 
foreach($parameter as $k=>$v){ 
	echo "<input name='{$k}' type='hidden' value='{$v}'>"; 
} 
?>
<p class="tc"><input name="" value="<?php lang('a3rd.uapi_confirm',0); ?>" type="submit" /></p>
</form>
<script>
function opaysubmit(){
	$('#fmopay').submit();
}
setTimeout('opaysubmit()',500);
</script>

</body>
</html>


/*******************************************************************************
 File : \root\a3rd\paydemo_dir\unotify.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/config.php");

//计算得出通知验证结果
$verify_result = dmdoCheck();

if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代

	//商户订单号
	$out_trade_no = basReq::val('out_trade_no');

	//演示交易号
	$trade_no = basReq::val('trade_no');

	//交易状态
	$trade_status = basReq::val('trade_status');

    if($trade_status == 'TRADE_FINISHED') {
		//判断该笔订单是否在商户网站中已经做过处理
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }elseif($trade_status == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
    }

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――
        
	echo "success";		//请不要修改或删除
	exvOpay::notifyDemopay('success');
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    echo "fail";
	exvOpay::notifyDemopay('fail');

    //调试用，写文本函数记录程序运行情况是否正常
    //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
}



/*******************************************************************************
 File : \root\a3rd\paydemo_dir\ureturn.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/config.php");

//计算得出通知验证结果
$verify_result = dmdoCheck();
if($verify_result) {//验证成功
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//请在这里加上商户的业务逻辑程序代码

	//商户订单号
	$out_trade_no = basReq::val('out_trade_no');

	//演示交易号
	$trade_no = basReq::val('trade_no');

	//交易状态
	$trade_status = basReq::val('trade_status');

    if($trade_status == 'TRADE_FINISHED' || $trade_status == 'TRADE_SUCCESS') {
		//判断该笔订单是否在商户网站中已经做过处理
    }else{
   		//echo "trade_status=".basReq::val('trade_status');
    }
		
	$msg = lang('a3rd.ureturn_ok');

	//――请根据您的业务逻辑来编写程序（以上代码仅作参考）――	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
else {
    //验证失败
    //如要调试，请看alipay_notify.php页面的verifyReturn函数
    $msg = lang('a3rd.ureturn_ng');
}

$cfg = array(
	'ordid'=>'out_trade_no',
	'feeamount'=>'total_fee',
	'apino'=>'trade_no',
	'status'=>'trade_status',
);
foreach($cfg as $k1=>$k2){ 
	$res[$k1] = basReq::val($k2);  
}
$res['msg'] = $msg;
$res['api'] = 'Demopay';
$res['stamp'] = date('Y-m-d H:i:s',basReq::val('notify_time','0'));
require_once(dirname(dirname(__FILE__))."/paydemo_dir/xresult.php");



/*******************************************************************************
 File : \root\a3rd\paydemo_dir\xresult.php 
*******************************************************************************/
<?php
$cfg = array('ordid','feeamount','apino','status','msg');
foreach($cfg as $key){ 
	empty($res[$key]) && $res[$key] = '';  
}
defined('PATH_ROOT') || define('PATH_ROOT','../../');
?>
<!DOCTYPE html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<title><?php lang('a3rd.xresult_title',0); ?></title>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php"></script>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?act=autoJQ"></script>
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/skin/a_jscss/stpub.css'/>
<style type="text/css">
.pay_info{ width:640px; border:1px solid #CCC; padding:10px; margin:10px auto; font-size:14px; }

.pay_info .main{ padding:10px 1px 10px 1px; border-bottom:1px dashed #CCCCCC; margin:0px auto 5px auto; }
.pay_info .main i{ display:inline-block; width:120px; }
.pay_info p{ padding:2px 5px; margin:2px 5px; }
.pay_info i{ font-style:normal; }

.pay_info .deget{ width:305px; padding:5px 1px; float:left; }
.pay_info .depost{ width:305px; padding:5px 1px; float:right; }

p.title{ border-bottom:1px solid #CCC; padding:2px 5px 10px 20px; }
p.detail{ width:100%; height:180px; overflow-y:scroll; }

</style>
</head>
<body>
<div id="topMargin" style="display:none; border:0px solid #999;"></div>

<div class="pay_info">

<p class="title">
	<span style="float:right"><?php lang('a3rd.xresult_ordno',0); ?> <?php echo $res['ordid']; ?></span>
    <b><?php lang('a3rd.xresult_title',0); ?></b>
</p>

<div class="main">
  <p><span class="right">@<?php echo @$res['api']; ?></span> <i><?php lang('a3rd.xresult_sysno',0); ?> </i>
  <?php echo $res['ordid']; ?>
  </p>
  <p><span class="right"><?php echo @$res['stamp']; ?></span> <i><?php lang('a3rd.xresult_amount',0); ?> </i>
  <?php echo $res['feeamount']; ?>
  </p>
  <p> <i><?php lang('a3rd.xresult_tradeno',0); ?> </i>
  <?php echo $res['apino']; ?>
  </p>
  <p> <i><?php lang('a3rd.xresult_state',0); ?> </i>
  <?php echo $res['status'].'('.$res['msg'].')'; ?>
  </p>
</div>
<div class="clear"></div>

<div class="depost">
  <p class="fB"> POST DATA：</p>
  <p class="detail"> 
  <?php
  foreach($_POST as $key=>$val){
	 echo "? $key = $val<br>";
  }?>
  </p>
</div>
<div class="deget">
  <p class="fB"> GET DATA：</p>
  <p class="detail"> 
  <?php
  foreach($_GET as $key=>$val){
	 echo "? $key = $val<br>";
  }?>
  </p>
</div>
<div class="clear"></div>

</div>

</body>
</html>

<script>winAutoMargin('topMargin');</script>



/*******************************************************************************
 File : \root\a3rd\paydemo_dir\xsend.php 
*******************************************************************************/
<?php
require_once(dirname(__FILE__)."/config.php");
?>
<!DOCTYPE html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<title><?php lang('a3rd.xsend_title',0); ?></title>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php"></script>
<script src="<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?act=autoJQ"></script>
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/skin/a_jscss/stpub.css'/>
<style type="text/css">

p.nav{ margin:auto auto 10px auto; text-align:center; }
div.out{ width:480px; margin:auto; }

</style>
</head>
<body>
<div id="topMargin" style="display:none; border:0px solid #999;"></div>
<div class="out">

<?php

$ptabs = exvOpay::getCfgs();
$stabs = " # \n"; $i=0;
foreach($ptabs as $k=>$v){
	if($i && !($i%3)) $stabs .= " <br># \n";
	$stabs .= "<a href='?paymode=$k'>$v[method]</a> # \n";
	$i++;
}

$_cbase['tpl']['tpl_dir'] = 'chn';
$kar = glbDBExt::dbAutID('coms_corder','yyyy-md-','32');
$order['cid'] = $order['title'] = $kar[0]; 
$order['cno'] = $kar[1];
$order['ordstat'] = 'new';
$order['atime'] = $_cbase['run']['stamp'];
$order['auser'] = 'uname';
$order['aip'] = $_cbase['run']['userip'];
$order['eip'] = comConvert::sysEncode($order['atime'].@$unqid);
$order['ordpay'] = basReq::val('paymode','paydemo');
$order['feetotle'] = 0.01;

$opay = exvOpay::getParas($order,'Webchn');
$opay['showurl'] = vopUrl::fout(0,'',1)."?"; 
$oadm = @$opay['a']; unset($opay['a']);

echo "<p class='nav'>$stabs</p>";
?>
<form id='fmopay' name='fmopay' method="post" action="<?php echo PATH_ROOT; ?>/a3rd/<?php echo $oadm['apidir']; ?>/uapi.php" target="_blank">
<p class="nav">
<?php foreach(array('title','feetotle') as $k){ ?>
<?php echo "[".$k."] = ".$order[$k]; ?><br>
<?php } ?>
</p>
<p class="nav">
<input type="submit" value="<?php lang('a3rd.xsend_send',0); ?>">
</p>
<?php foreach($opay as $k=>$v){ ?>
<input name="<?php echo $k; ?>" type="hidden" value="<?php echo $v; ?>">
<?php } ?>
</form>

</div>
</body>
</html>

<script>winAutoMargin('topMargin');</script>



/*******************************************************************************
 File : \root\a3rd\paypal_ec\cancel.php 
*******************************************************************************/
<?php include('header.php'); ?>
	<span class="span4">
	</span>
	<span class="span5">
		<div class="hero-unit">
		   You cancelled the order.
		</div>
	</span>
	<span class="span3">
	</span>
<?php include('footer.php'); ?>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/paypal_ec');
define('LIBS_PAYRUN', DIR_VENDOR.'/a3rd/paypal_class');

require_once (LIBS_PAYRUN."/paypal_functions.php"); 



/*******************************************************************************
 File : \root\a3rd\paypal_ec\footer.php 
*******************************************************************************/
			</div> <!-- Row-Fluid ends here -->
		</div>  <!--Container-Fluid ends here -->
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://code.jquery.com/jquery.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.min.js"></script>
	</body>
</html>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\header.php 
*******************************************************************************/
<html>
  <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Checkout with PayPal Demo</title>
      <!--Including Bootstrap style files-->
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="css/bootstrap-responsive.min.css" rel="stylesheet">
  </head>
  <body>
      <div class="container-fluid">
      <div class="well">
         <h2 class="text-center">Checkout with PayPal Demo</h2>
      </div>
      <div class="row-fluid">
      
      


/*******************************************************************************
 File : \root\a3rd\paypal_ec\index.php 
*******************************************************************************/
<!DOCTYPE html>
<?php include('header.php');
      include('paypal_config.php'); ?>
   <div class="span5">
            <!--Form containing item parameters and seller credentials needed for SetExpressCheckout Call-->
            <form class="form" action="paypal_ec_redirect.php" method="POST">
               <div class="row-fluid">
                  <div class="span6 inner-span">
                        <!--Demo Product details -->
                        <table>
                        <tr><h3> DIGITAL SLR CAMERA </h3></tr>
                        <tr><td><p class="lead"> Buyer Credentials:</p></td></tr>
                        <tr><td>Email-id:&nbsp;&nbsp;&nbsp;<input type="text" id="buyer_email" name="buyer_email" readonly></input> </td></tr>
                        <tr><td>Password:<input type="text" id="buyer_password" name="buyer_password" readonly></input></td></tr>
                        </table>
                  </div>
                  <div class="span6 inner-span">
                        <p class="lead"> Item Specifications:</p>
                        <table>
                        <tr><td>Item Name:</td><td><input type="text" name="L_PAYMENTREQUEST_0_NAME0" value="DSLR Camera"></input></td></tr>
                        <tr><td>Item ID: </td><td><input type="text" name="L_PAYMENTREQUEST_0_NUMBER0" value="A0123"></input></td></tr>
                        <tr><td>Description:</td><td><input type="text" name="L_PAYMENTREQUEST_0_DESC0" value="Autofocus Camera"></input></td></tr>
                        <tr><td>Quantity:</td><td><input type="text" name="L_PAYMENTREQUEST_0_QTY0" value="1" readonly></input></td></tr>
                        <tr><td>Price:</td><td><input type="text" name="PAYMENTREQUEST_0_ITEMAMT" value="10.00" readonly></input></td></tr>
                        <tr><td>Tax:</td><td><input type="text" name="PAYMENTREQUEST_0_TAXAMT" value="2" readonly></input></td></tr>
                        <tr><td>Shipping Amount:</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPPINGAMT" value="5" readonly></input></td></tr>
                        <tr><td>Handling Amount:</td><td><input type="text" name="PAYMENTREQUEST_0_HANDLINGAMT" value="1" readonly></input></td></tr>
                        <tr><td>Shipping Discount:</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPDISCAMT" value="-3" readonly></input></td></tr>
                        <tr><td>Insurance Amount:</td><td><input type="text" name="PAYMENTREQUEST_0_INSURANCEAMT" value="2" readonly></input></td></tr>
                        <tr><td>Total Amount:</td><td><input type="text" name="PAYMENTREQUEST_0_AMT" value="17" readonly></input></td></tr>
                        <tr><td><input type="hidden" name="LOGOIMG" value=<?php echo('http://'.$_SERVER['HTTP_HOST'].preg_replace('/index.php/','img/logo.jpg',$_SERVER['SCRIPT_NAME'])); ?>></input></td></tr>
                        <tr><td>Currency Code:</td><td><select name="currencyCodeType">
						<option value="AUD">AUD</option>
						<option value="BRL">BRL</option>
						<option value="CAD">CAD</option>
						<option value="CZK">CZK</option>
						<option value="DKK">DKK</option>
						<option value="EUR">EUR</option>
						<option value="HKD">HKD</option>
						<option value="MYR">MYR</option>
						<option value="MXN">MXN</option>
						<option value="NOK">NOK</option>
						<option value="NZD">NZD</option>
						<option value="PHP">PHP</option>
						<option value="PLN">PLN</option>
						<option value="GBP">GBP</option>
						<option value="RUB">RUB</option>
						<option value="SGD">SGD</option>
						<option value="SEK">SEK</option>
						<option value="CHF">CHF</option>
						<option value="THB">THB</option>
						<option value="USD" selected>USD</option></select><br></td></tr>
                        <tr><td>Payment Type: </td><td><select>
                                                           <option value="Sale">Sale</option>
                                                           <option value="Authorization">Authorization</option>
                                                           <option value="Order">Order</option>
                                                         </select><br></td></tr>

                        <tr><td colspan="2"><br/><br/><div id="myContainer"></div></td></tr>
						<tr><td> -- OR -- </td></tr>
						<tr><td ><input type="Submit" alt="Proceed to Checkout" class="btn btn-primary btn-large" value="Proceed to Checkout" name="checkout"/></td></tr>
                        </table>
                  </div>
               </div>
            </form>
   </div>
   <div class="span2">
   </div>
   <div class="span5">
      <div class="row-fluid">
         <div class="span12 inner-span">
               <h4> README: </h4>
               <h5>BEFORE YOU GET STARTED:</h5>
               This code sample shows the new checkout flow called In-Context checkout experience. You need to meet the <a href="https://developer.paypal.com/webapps/developer/docs/classic/limited-release/express-checkout/enable/#eligibility-review" target="_blank">eligibility criteria </a> to determine whether your integration will be a good candidate for In-Context checkout experience option. Please refer to the <a href="https://developer.paypal.com/webapps/developer/docs/classic/limited-release/express-checkout/enable/#eligibility-review" target="_blank">eligibility criteria </a>. <br>If you are eligible for In-Context checkout based on the eligibility requirements, please refer to the <a href="#incontext">'In-Context Checkout integration steps'</a> below. But, if you are not eligible, please refer to the <a href="#expresscheckout">'Express Checkout integration steps'</a> below.
               <br>
               <h5> PRE-READ: </h5>
               <p>
                  1) Click on ‘Checkout with PayPal’ button and see the experience.
                  <br>
                  2) If you get any Firewall warning, add rule to the Firewall to allow incoming connections for your application.
                  <br>
                  3) Checkout with PayPal using a buyer sandbox account provided on this page. And you're done!
                  <br>
                  4) The sample code uses default sandbox credentials which are set in paypal_config.php. You can create your own credentials by creating PayPal Seller and Buyer accounts on Sandbox  <i><a href="https://developer.paypal.com/webapps/developer/applications/accounts/create" target="_blank">here</a></i>.
                  <br>
                  5) Make following changes in paypal_config.php:<br>
                  - If using your own Sandbox seller account, update PP_USER_SANDBOX, PP_PASSWORD_SANDBOX and PP_SIGNATURE_SANDBOX values with your sandbox credentials<br>
                  - SANDBOX_FLAG: Kept true for working with Sandbox, it will be false for live.<br>
                  </p>
               <h4 id="incontext"> In-Context Checkout integration steps: </h4>
               1) Copy the files and folders under 'Checkout' package to the same location where you have your shopping cart page.
               <br>
               2) Copy the below  &lt;form&gt; .. &lt;/form&gt; to your shopping cart page.
               <br><br>
   <pre><code>&lt;form id="myContainer" action="paypal_ec_redirect.php" method="POST"&gt;
      &lt;input type="hidden" name="PAYMENTREQUEST_0_AMT" value="10.00"&gt;&lt;/input&gt;
      &lt;input type="hidden" name="currencyCodeType" value="USD"&gt;&lt;/input&gt;
      &lt;input type="hidden" name="paymentType" value="Sale"&gt;&lt;/input&gt;
      <i>&lt;!--Pass additional input parameters based on your shopping cart. For complete list of all the parameters <a href="https://developer.paypal.com/webapps/developer/docs/classic/api/merchant/SetExpressCheckout_API_Operation_NVP/" target=_blank>click here</a></i> --&gt;
&lt;/form&gt;</code></pre><br>
               3) Include the following script on your shopping cart page:
               <br><br>
   <pre><code>&lt;script type="text/javascript"&gt;
 window.paypalCheckoutReady = function () {
     paypal.checkout.setup('Your merchant email id', {
         container: 'myContainer', //{String|HTMLElement|Array} where you want the PayPal button to reside
         environment: 'sandbox' //or 'production' depending on your environment
     });
 };
 &lt;/script&gt;
 &lt;script src="//www.paypalobjects.com/api/checkout.js" async&gt;&lt;/script&gt;</code></pre><br>
               4) Open your browser and navigate to your Shopping cart page. Click on 'Checkout with PayPal' button and complete the flow.<br>
               5) Read more details on Express Checkout API <a href="https://developer.paypal.com/webapps/developer/docs/classic/products/#ec" target=_blank>here</a>
             <br><br>
             <h4 id="expresscheckout"> Express Checkout integration steps: </h4>
            1) Copy the files and folders under 'Checkout' package to the same location where you have your shopping cart page.
                           <br>
            2) Copy the below  &lt;form&gt; .. &lt;/form&gt; to your shopping cart page.
                           <br><br>
   <pre><code>&lt;form action="paypal_ec_redirect.php" method="POST"&gt;
  &lt;input type="hidden" name="PAYMENTREQUEST_0_AMT" value="10.00"&gt;&lt;/input&gt;
  &lt;input type="hidden" name="currencyCodeType" value="USD"&gt;&lt;/input&gt;
  &lt;input type="hidden" name="paymentType" value="Sale"&gt;&lt;/input&gt;
  <i>&lt;!--Pass additional input parameters based on your shopping cart. For complete list of all the parameters <a href="https://developer.paypal.com/webapps/developer/docs/classic/api/merchant/SetExpressCheckout_API_Operation_NVP/" target=_blank>click here</a></i> --&gt;
  &lt;input type="image" src="https://www.paypalobjects.com/webstatic/en_US/i/buttons/checkout-logo-large.png" alt="Check out with PayPal"&gt;&lt;/input&gt;
&lt;/form&gt;</code></pre>
            3) In paypal_config.php, uncomment the 'Express Checkout URLs for Sandbox' and comment out the 'In-Context in Express Checkout URLs for Sandbox'.
            Do the same for the 'Live' URLs.<br>
            4) Open your browser and navigate to your Shopping cart page. Click on 'Checkout with PayPal' button and complete the flow.<br>
            5) Read more details on Express Checkout API <a href="https://developer.paypal.com/webapps/developer/docs/classic/products/#ec" target=_blank>here</a>

         </div>
      </div>
   </div>
   <div class="span1">
   </div>
   <!--Script to dynamically choose a seller and buyer account to render on index page-->
   <script type="text/javascript">
      function getRandomNumberInRange(min, max) {
          return Math.floor(Math.random() * (max - min) + min);
      }


      var buyerCredentials = [{"email":"ron@hogwarts.com", "password":"qwer1234"},
                        {"email":"sallyjones1234@gmail.com", "password":"p@ssword1234"},
                        {"email":"joe@boe.com", "password":"123456789"},
                        {"email":"hermione@hogwarts.com", "password":"123456789"},
                        {"email":"lunalovegood@hogwarts.com", "password":"123456789"},
                        {"email":"ginnyweasley@hogwarts.com", "password":"123456789"},
                        {"email":"bellaswan@awesome.com", "password":"qwer1234"},
                        {"email":"edwardcullen@gmail.com", "password":"qwer1234"}];
      var randomBuyer = getRandomNumberInRange(0,buyerCredentials.length);

      document.getElementById("buyer_email").value =buyerCredentials[randomBuyer].email;
      document.getElementById("buyer_password").value =buyerCredentials[randomBuyer].password;


   </script>

   <script type="text/javascript">
   window.paypalCheckoutReady = function () {
       paypal.checkout.setup('<?php echo($merchantID); ?>', {
           container: 'myContainer',
           environment: '<?php echo($env); ?>'
       });
   };
   </script>
   <script src="//www.paypalobjects.com/api/checkout.js" async></script>

<?php include('footer.php') ?>



/*******************************************************************************
 File : \root\a3rd\paypal_ec\lightboxreturn.php 
*******************************************************************************/
<?php
$url = 'review.php?';
foreach($_GET as $key => $value)
{
	$url .= $key . '=' . $value . '&';
}
?>
<html>
  <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>PayPal Demo Portal</title>
      <!--Including Bootstrap style files-->
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="css/bootstrap-responsive.min.css" rel="stylesheet">
  </head>
  <body>
      <div class="container-fluid">
      <div class="row-fluid">
      <div class="span4">
      </div>
      <div class="span5">
<div class="row text-center"><h3>Loading...</h3></div>
<script type="text/javascript">
if (window!=top){top.location.href='<?php echo $url ?>';} //lightbox return
else
window.location.href='<?php echo $url ?>';  //return from full page paypal flow
</script>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\paypal_config.php 
*******************************************************************************/
<?php
//Seller Sandbox Credentials- Sample credentials already provided
define("PP_USER_SANDBOX", "supersandy_api1.gmail.com");
define("PP_PASSWORD_SANDBOX", "1400525332");
define("PP_SIGNATURE_SANDBOX", "AdUaGhfPganVo2IfGf2Ctordn94OASnvL6qF4D-pnHb6hEQCLBWKbzmq");

//Seller Live credentials.
define("PP_USER","seller_username_here");
define("PP_PASSWORD", "seller_password_here");
define("PP_SIGNATURE","seller_signature_here");

//Set this constant EXPRESS_MARK = true to skip review page
define("EXPRESS_MARK", true);

//Set this constant ADDRESS_OVERRIDE = true to prevent from changing the shipping address
define("ADDRESS_OVERRIDE", true);

//Set this constant USERACTION_FLAG = true to skip review page
define("USERACTION_FLAG", false);

//Based on the USERACTION_FLAG assign the page
if(USERACTION_FLAG){
	$page = 'return.php';
} else {	
	$page = 'review.php';
} 

//The URL in your application where Paypal returns control to -after success (RETURN_URL) using Express Checkout Mark Flow
define("RETURN_URL_MARK",'http://'.$_SERVER['HTTP_HOST'].preg_replace('/paypal_ec_redirect.php/','return.php',$_SERVER['SCRIPT_NAME']));

//The URL in your application where Paypal returns control to -after success (RETURN_URL) and after cancellation of the order (CANCEL_URL) 
define("RETURN_URL",'http://'.$_SERVER['HTTP_HOST'].preg_replace('/paypal_ec_redirect.php/','lightboxreturn.php',$_SERVER['SCRIPT_NAME']));
define("CANCEL_URL",'http://'.$_SERVER['HTTP_HOST'].preg_replace('/paypal_ec_redirect.php/','cancel.php',$_SERVER['SCRIPT_NAME']));

//Whether Sandbox environment is being used, Keep it true for testing
define("SANDBOX_FLAG", true);

if(SANDBOX_FLAG){
	$merchantID=PP_USER_SANDBOX;  /* Use Sandbox merchant id when testing in Sandbox */
	$env= 'sandbox';
}
else {
	$merchantID=PP_USER;  /* Use Live merchant ID for production environment */
	$env='production';
}

//Proxy Config
define("PROXY_HOST", "127.0.0.1");
define("PROXY_PORT", "808");

//In-Context in Express Checkout URLs for Sandbox
define("PP_CHECKOUT_URL_SANDBOX", "https://www.sandbox.paypal.com/checkoutnow?token=");
define("PP_NVP_ENDPOINT_SANDBOX","https://api-3t.sandbox.paypal.com/nvp");

//Express Checkout URLs for Sandbox
//define("PP_CHECKOUT_URL_SANDBOX", "https://www.sandbox.paypal.com/cgi-bin/webscr?cmd=_express-checkout&token=");
//define("PP_NVP_ENDPOINT_SANDBOX","https://api-3t.sandbox.paypal.com/nvp");

//In-Context in Express Checkout URLs for Live
define("PP_CHECKOUT_URL_LIVE","https://www.paypal.com/checkoutnow?token=");
define("PP_NVP_ENDPOINT_LIVE","https://api-3t.paypal.com/nvp");

//Express Checkout URLs for Live
//define("PP_CHECKOUT_URL_LIVE","https://www.paypal.com/cgi-bin/webscr?cmd=_express-checkout&token=");
//define("PP_NVP_ENDPOINT_LIVE","https://api-3t.paypal.com/nvp");

//Version of the APIs
define("API_VERSION", "109.0");

//ButtonSource Tracker Code
define("SBN_CODE","PP-DemoPortal-EC-IC-php");
?>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\paypal_ec_mark.php 
*******************************************************************************/
<?php require_once ("config.php"); ?>
<?php
//'------------------------------------
//' Calls the SetExpressCheckout API call
//'
//' The CallMarkExpressCheckout function is defined in the file paypal_functions.php,
//' it is included at the top of this file.
//'-------------------------------------------------

$itemDetail = $_SESSION['post_value'];
$shippingDetail = $_POST;
$paymentAmount = $itemDetail['PAYMENTREQUEST_0_AMT'];
if(isset($_POST['shipping_method'])) {
$new_shipping = $_POST['shipping_method']; //need to change this value, just for testing
	if($itemDetail['PAYMENTREQUEST_0_SHIPPINGAMT'] > 0){
		$paymentAmount = ($paymentAmount + $new_shipping) - $itemDetail['PAYMENTREQUEST_0_SHIPPINGAMT'];
		$itemDetail['PAYMENTREQUEST_0_SHIPPINGAMT'] = $new_shipping;
		$itemDetail['PAYMENTREQUEST_0_AMT'] = $paymentAmount;
	}
}
$resArray = CallMarkExpressCheckout ($paymentAmount, $shippingDetail, $itemDetail);

$ack = strtoupper($resArray["ACK"]);
if($ack=="SUCCESS" || $ack=="SUCCESSWITHWARNING")  //if SetExpressCheckout API call is successful
{
	RedirectToPayPal ( $resArray["TOKEN"] );
} 
else  
{
	//Display a user friendly Error on the page using any of the following error information returned by PayPal
	$ErrorCode = urldecode($resArray["L_ERRORCODE0"]);
	$ErrorShortMsg = urldecode($resArray["L_SHORTMESSAGE0"]);
	$ErrorLongMsg = urldecode($resArray["L_LONGMESSAGE0"]);
	$ErrorSeverityCode = urldecode($resArray["L_SEVERITYCODE0"]);

	echo "SetExpressCheckout API call failed. ";
	echo "Detailed Error Message: " . $ErrorLongMsg;
	echo "Short Error Message: " . $ErrorShortMsg;
	echo "Error Code: " . $ErrorCode;
	echo "Error Severity Code: " . $ErrorSeverityCode;
}

?>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\paypal_ec_redirect.php 
*******************************************************************************/
<?php

   require_once ("config.php");
  
   //Call to SetExpressCheckout using the shopping parameters collected from the shopping form on index.php and few from config.php 

   $returnURL = RETURN_URL;
   $cancelURL = CANCEL_URL; 
   
   if(isset($_POST["PAYMENTREQUEST_0_ITEMAMT"]))
		$_POST["L_PAYMENTREQUEST_0_AMT0"]=$_POST["PAYMENTREQUEST_0_ITEMAMT"];
  
   if(!isset($_POST['Confirm']) && isset($_POST['checkout'])){

		if($_REQUEST["checkout"] || isset($_SESSION['checkout'])) {
			$_SESSION['checkout'] = $_POST['checkout'];
		}
	$_SESSION['post_value'] = $_POST;
	
	//Assign the Return and Cancel to the Session object for ExpressCheckout Mark
	$returnURL = RETURN_URL_MARK;
	$_SESSION['post_value']['RETURN_URL'] = $returnURL;
	$_SESSION['post_value']['CANCEL_URL'] = $cancelURL;
	$_SESSION['EXPRESS_MARK'] = 'ECMark';
   include('header.php');
?>
   <div class="span4">
   </div>
   <div class="span5">
            <!--Form containing item parameters and seller credentials needed for SetExpressCheckout Call-->
            <form class="form" action="paypal_ec_mark.php" method="POST">
               <div class="row-fluid">
                  <div class="span6 inner-span">
                        <p class="lead">Shipping Address</p>
                        <table>
                        <input type="hidden" name="L_PAYMENTREQUEST_0_AMT" value="<?php echo $_POST["PAYMENTREQUEST_0_AMT"]; ?>">
                        <tr><td width="30%">First Name</td><td><input type="text" name="L_PAYMENTREQUEST_FIRSTNAME" value="Alegra"></input></td></tr>
                        <tr><td>Last Name:</td><td><input type="text" name="L_PAYMENTREQUEST_LASTNAME" value="Valava"></input></td></tr>
                        <tr><td>Address</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPTOSTREET" value="55 East 52nd Street"></input></td></tr>
                        <tr><td>Address 1</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPTOSTREET2" value="21st Floor"></input></td></tr>
                        <tr><td>City:</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPTOCITY" value="New York" ></input></td></tr>
                        <tr><td>State:</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPTOSTATE" value="NY" ></input></td></tr>
                        <tr><td>Postal Code:</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPTOZIP" value="10022" ></input></td></tr>
                        <tr><td>Country</td><td><select id="PAYMENTREQUEST_0_SHIPTOCOUNTRY" name="PAYMENTREQUEST_0_SHIPTOCOUNTRY">
							<option value="AF">Afghanistan</option>
							<option value="ZW">Zimbabwe</option>
							</select></td>
						</tr>
                        <tr><td>Telephone:</td><td><input type="text" name="PAYMENTREQUEST_0_SHIPTOPHONENUM" value="" maxlength="12"></input></td></tr>
						
                        <tr><td colspan="2"><p class="lead">Shipping Detail:</p></td></tr>
                        <tr><td>Shipping Type: </td><td><select name="shipping_method" id="shipping_method" style="width: 250px;" class="required-entry">
					<optgroup label="United Parcel Service" style="font-style:normal;">
					<option value="2.00">
					Worldwide Expedited - $2.00</option>
					<option value="3.00">
					Worldwide Express Saver - $3.00</option>
					</optgroup>
					<optgroup label="Flat Rate" style="font-style:normal;">
					<option value="0.00" selected>
					Fixed - $0.00</option>
					</optgroup>
					</select><br>
						</td></tr>
					<tr><td colspan="2"><p class="lead">Payment Methods:</p></td></tr>	
					<tr><td colspan="2">
						<input id="paypal_payment_option" value="paypal_express" type="radio" name="paymentMethod" title="PayPal Express Checkout" class="radio" checked>
						<img src="https://fpdbs.paypal.com/dynamicimageweb?cmd=_dynamic-image&amp;buttontype=ecmark&amp;locale=en_US" alt="Acceptance Mark" class="v-middle">&nbsp;
						<a href="https://www.paypal.com/us/cgi-bin/webscr?cmd=xpt/Marketing/popup/OLCWhatIsPayPal-outside" onclick="javascript:window.open('https://www.paypal.com/us/cgi-bin/webscr?cmd=xpt/Marketing/popup/OLCWhatIsPayPal-outside','olcwhatispaypal','toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, ,left=0, top=0, width=400, height=350'); return false;">What is PayPal?</a>
					</td></tr>
					<tr><td colspan="2"><input id="p_method_paypal_express" value="credit_card" type="radio" name="paymentMethod" title="PayPal Express Checkout" class="radio" disabled>&nbsp;Credit Card</td></tr>
					<tr><td>&nbsp;</td></tr>

                        </table>
                        <input type="submit" id="placeOrderBtn" class="btn btn-primary btn-large" name="PlaceOrder" value="Place Order" />
                  </div>
               </div>
            </form>
   </div>
   <div class="span3">
   </div>
    <script src="//www.paypalobjects.com/api/checkout.js" async></script>
      <script type="text/javascript">
      window.paypalCheckoutReady = function () {
          paypal.checkout.setup('<?php echo($merchantID); ?>', {
              button: 'placeOrderBtn',
              environment: '<?php echo($env); ?>',
              condition: function () {
                      return document.getElementById('paypal_payment_option').checked === true;
                  }
          });
      };
      </script>
   <?php
   } else {

   $resArray = CallShortcutExpressCheckout ($_POST, $returnURL, $cancelURL);
   $ack = strtoupper($resArray["ACK"]);
   if($ack=="SUCCESS" || $ack=="SUCCESSWITHWARNING")  //if SetExpressCheckout API call is successful
   {
		RedirectToPayPal ( $resArray["TOKEN"] );
   } 
   else  
   {
   	//Display a user friendly Error on the page using any of the following error information returned by PayPal
   	$ErrorCode = urldecode($resArray["L_ERRORCODE0"]);
   	$ErrorShortMsg = urldecode($resArray["L_SHORTMESSAGE0"]);
   	$ErrorLongMsg = urldecode($resArray["L_LONGMESSAGE0"]);
   	$ErrorSeverityCode = urldecode($resArray["L_SEVERITYCODE0"]);
   	
   	echo "SetExpressCheckout API call failed. ";
   	echo "Detailed Error Message: " . $ErrorLongMsg;
   	echo "Short Error Message: " . $ErrorShortMsg;
   	echo "Error Code: " . $ErrorCode;
   	echo "Error Severity Code: " . $ErrorSeverityCode;
   }
   }
   
?>



/*******************************************************************************
 File : \root\a3rd\paypal_ec\return.php 
*******************************************************************************/
<?php 
	/*
	* Call to GetExpressCheckoutDetails and DoExpressCheckoutPayment APIs
	*/

	require_once ("config.php"); 

	/*
	* The paymentAmount is the total value of the shopping cart(in real apps), here it was set 
    * in paypalfunctions.php in a session variable 
	*/
	
	$finalPaymentAmount =  $_SESSION["Payment_Amount"];
	if(!isset($_SESSION['payer_id']))
	{
		$_SESSION['payer_id'] =	$_GET['PayerID'];
	}


	// Check to see if the Request object contains a variable named 'token'	or Session object contains a variable named TOKEN 
	$token = "";
	
	if (isset($_REQUEST['token']))
	{
		$token = $_REQUEST['token'];
	} else if(isset($_SESSION['TOKEN']))
	{
		$token = $_SESSION['TOKEN'];
	}
	
	// If the Request object contains the variable 'token' then it means that the user is coming from PayPal site.	
	if ( $token != "" )
	{
		/*
		* Calls the GetExpressCheckoutDetails API call
		*/
		$resArrayGetExpressCheckout = GetShippingDetails( $token );
		$ackGetExpressCheckout = strtoupper($resArrayGetExpressCheckout["ACK"]);	 
		if( $ackGetExpressCheckout == "SUCCESS" || $ackGetExpressCheckout == "SUCESSWITHWARNING") 
		{
			/*
			* The information that is returned by the GetExpressCheckoutDetails call should be integrated by the partner into his Order Review 
			* page		
			*/
			$email 				= $resArrayGetExpressCheckout["EMAIL"]; // ' Email address of payer.
			$payerId 			= $resArrayGetExpressCheckout["PAYERID"]; // ' Unique PayPal customer account identification number.
			$payerStatus		= $resArrayGetExpressCheckout["PAYERSTATUS"]; // ' Status of payer. Character length and limitations: 10 single-byte alphabetic characters.
			$firstName			= $resArrayGetExpressCheckout["FIRSTNAME"]; // ' Payer's first name.
			$lastName			= $resArrayGetExpressCheckout["LASTNAME"]; // ' Payer's last name.
			$cntryCode			= $resArrayGetExpressCheckout["COUNTRYCODE"]; // ' Payer's country of residence in the form of ISO standard 3166 two-character country codes.
			$shipToName			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTONAME"]; // ' Person's name associated with this address.
			$shipToStreet		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOSTREET"]; // ' First street address.
			$shipToCity			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOCITY"]; // ' Name of city.
			$shipToState		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOSTATE"]; // ' State or province
			$shipToCntryCode	= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOCOUNTRYCODE"]; // ' Country code. 
			$shipToZip			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOZIP"]; // ' U.S. Zip code or other country-specific postal code.
			$addressStatus 		= $resArrayGetExpressCheckout["ADDRESSSTATUS"]; // ' Status of street address on file with PayPal 
			$totalAmt   		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_AMT"]; // ' Total Amount to be paid by buyer
			$currencyCode       = $resArrayGetExpressCheckout["CURRENCYCODE"]; // 'Currency being used 
			$shippingAmt        = $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPPINGAMT"]; // 'Shipping amount 
			/*
			* Add check here to verify if the payment amount stored in session is the same as the one returned from GetExpressCheckoutDetails API call
			* Checks whether the session has been compromised
			*/
			if($_SESSION["Payment_Amount"] != $totalAmt || $_SESSION["currencyCodeType"] != $currencyCode)
			exit("Parameters in session do not match those in PayPal API calls");
		} 
		else  
		{
			//Display a user friendly Error on the page using any of the following error information returned by PayPal
			$ErrorCode = urldecode($resArrayGetExpressCheckout["L_ERRORCODE0"]);
			$ErrorShortMsg = urldecode($resArrayGetExpressCheckout["L_SHORTMESSAGE0"]);
			$ErrorLongMsg = urldecode($resArrayGetExpressCheckout["L_LONGMESSAGE0"]);
			$ErrorSeverityCode = urldecode($resArrayGetExpressCheckout["L_SEVERITYCODE0"]);

			echo "GetExpressCheckoutDetails API call failed. ";
			echo "Detailed Error Message: " . $ErrorLongMsg;
			echo "Short Error Message: " . $ErrorShortMsg;
			echo "Error Code: " . $ErrorCode;
			echo "Error Severity Code: " . $ErrorSeverityCode;
		}
	}
	/* Review block start */
	
	if(!USERACTION_FLAG && !isset($_SESSION['EXPRESS_MARK'])){
	if(isset($_POST['shipping_method']))
		$new_shipping = $_POST['shipping_method']; //need to change this value, just for testing
		if($shippingAmt > 0){
			$finalPaymentAmount = ($totalAmt + $new_shipping) - $_SESSION['shippingAmt'];
			$_SESSION['shippingAmt'] = $new_shipping;
		}
	}
	
	/* Review block end */
	/*
	* Calls the DoExpressCheckoutPayment API call
	*/
	//$resArrayDoExpressCheckout = ConfirmPayment ( $newTotalAmt );
	$resArrayDoExpressCheckout = ConfirmPayment ( $finalPaymentAmount );
	$ackDoExpressCheckout = strtoupper($resArrayDoExpressCheckout["ACK"]);
	include('header.php');

	session_unset();   // free all session variables
	session_destroy(); //destroy session
	if( $ackDoExpressCheckout == "SUCCESS" || $ackDoExpressCheckout == "SUCCESSWITHWARNING" )
	{
		$transactionId		= $resArrayDoExpressCheckout["PAYMENTINFO_0_TRANSACTIONID"]; // ' Unique transaction ID of the payment. Note:  If the PaymentAction of the request was Authorization or Order, this value is your AuthorizationID for use with the Authorization & Capture APIs. 
		$transactionType 	= $resArrayDoExpressCheckout["PAYMENTINFO_0_TRANSACTIONTYPE"]; //' The type of transaction Possible values: l  cart l  express-checkout 
		$paymentType		= $resArrayDoExpressCheckout["PAYMENTINFO_0_PAYMENTTYPE"];  //' Indicates whether the payment is instant or delayed. Possible values: l  none l  echeck l  instant 
		$orderTime 			= $resArrayDoExpressCheckout["PAYMENTINFO_0_ORDERTIME"];  //' Time/date stamp of payment
		$amt				= $resArrayDoExpressCheckout["PAYMENTINFO_0_AMT"];  //' The final amount charged, including any shipping and taxes from your Merchant Profile.
		$currencyCode		= $resArrayDoExpressCheckout["PAYMENTINFO_0_CURRENCYCODE"];  //' A three-character currency code for one of the currencies listed in PayPay-Supported Transactional Currencies. Default: USD. 
		/*
		* Status of the payment: 
		* Completed: The payment has been completed, and the funds have been added successfully to your account balance.
		* Pending: The payment is pending. See the PendingReason element for more information. 
		*/
		
		$paymentStatus	= $resArrayDoExpressCheckout["PAYMENTINFO_0_PAYMENTSTATUS"]; 

		/*
		* The reason the payment is pending 
		*/
		$pendingReason	= $resArrayDoExpressCheckout["PAYMENTINFO_0_PENDINGREASON"];  

		/*
		* The reason for a reversal if TransactionType is reversal 
		*/
		$reasonCode		= $resArrayDoExpressCheckout["PAYMENTINFO_0_REASONCODE"];   
		?>
			<span class="span4">
    		</span>
    		<span class="span5">
    			<div class="hero-unit">
    			<!-- Display the Transaction Details-->
    			<h4> <?php echo($firstName); ?>
    				<?php echo($lastName); ?> , Thank you for your Order </h4>
    			
    			<h4> Shipping Details: </h4>
				<?php echo($shipToName) ?><br>
				<?php echo($shipToStreet) ?><br>
				<?php echo($shipToCity) ?><br>
				<?php echo($shipToState) ?>- <?php echo($shipToZip) ?></p>
    			<p>Transaction ID: <?php  echo($transactionId);?> </p>
    			<p>Transaction Type: <?php  echo($transactionType);?> </p>
    			<p>Payment Total Amount: <?php  echo($amt);?> </p>
    			<p>Currency Code: <?php  echo($currencyCode);?> </p>
    			<p>Payment Status: <?php  echo($paymentStatus);?> </p>
    			<p>Payment Type: <?php  echo($paymentType);?> </p>
    			<h3> Click <a href='index.php'>here </a> to return to Home Page</h3>
    			</div>
    		</span>
    		<span class="span3">
    		</span>
		<?php
	}
	else  
	{
		//Display a user friendly Error on the page using any of the following error information returned by PayPal

		$ErrorCode = urldecode($resArrayDoExpressCheckout["L_ERRORCODE0"]);
		$ErrorShortMsg = urldecode($resArrayDoExpressCheckout["L_SHORTMESSAGE0"]);
		$ErrorLongMsg = urldecode($resArrayDoExpressCheckout["L_LONGMESSAGE0"]);
		$ErrorSeverityCode = urldecode($resArrayDoExpressCheckout["L_SEVERITYCODE0"]);

		if($ErrorCode == 10486)  //Transaction could not be completed error because of Funding failure. Should redirect user to PayPal to manage their funds.
		{
			?>
			<!--<div class="hero-unit">
    			 Display the Transaction Details
    			<h4> There is a Funding Failure in your account. You can modify your funding sources to fix it and make purchase later. </h4>
    			Payment Status:-->
    			<?php  //echo($resArrayDoExpressCheckout["PAYMENTINFO_0_PAYMENTSTATUS"]);
						RedirectToPayPal ( $resArray["TOKEN"] );
    			?>
    			<!--<h3> Click <a href='https://www.sandbox.paypal.com/'>here </a> to go to PayPal site.</h3> <!--Change to live PayPal site for production-->
    		<!--</div>-->
			<?php
		}
		else
		{
			echo "DoExpressCheckout API call failed. ";
			echo "Detailed Error Message: " . $ErrorLongMsg;
			echo "Short Error Message: " . $ErrorShortMsg;
			echo "Error Code: " . $ErrorCode;
			echo "Error Severity Code: " . $ErrorSeverityCode;
		}
	}		
?>
<?php include('footer.php'); ?>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\review.php 
*******************************************************************************/
<?php 
	/*
	* Call to GetExpressCheckoutDetails
	*/

	require_once ("config.php");

	/*
    * in paypalfunctions.php in a session variable 
	*/
	$_SESSION['payer_id'] =	$_GET['PayerID'];

	// Check to see if the Request object contains a variable named 'token'	
	$token = "";

	if (isset($_REQUEST['token']))
	{
		$token = $_REQUEST['token'];
		$_SESSION['TOKEN'] = $token;
	}

	// If the Request object contains the variable 'token' then it means that the user is coming from PayPal site.	
	if ( $token != "" )
	{
		/*
		* Calls the GetExpressCheckoutDetails API call
		*/
		$resArrayGetExpressCheckout = GetShippingDetails( $token );
		$ackGetExpressCheckout = strtoupper($resArrayGetExpressCheckout["ACK"]);	 
		if( $ackGetExpressCheckout == "SUCCESS" || $ackGetExpressCheckout == "SUCESSWITHWARNING") 
		{
			/*
			* The information that is returned by the GetExpressCheckoutDetails call should be integrated by the partner into his Order Review 
			* page		
			*/
			$email 				= $resArrayGetExpressCheckout["EMAIL"]; // ' Email address of payer.
			$payerId 			= $resArrayGetExpressCheckout["PAYERID"]; // ' Unique PayPal customer account identification number.
			$payerStatus		= $resArrayGetExpressCheckout["PAYERSTATUS"]; // ' Status of payer. Character length and limitations: 10 single-byte alphabetic characters.
			$firstName			= $resArrayGetExpressCheckout["FIRSTNAME"]; // ' Payer's first name.
			$lastName			= $resArrayGetExpressCheckout["LASTNAME"]; // ' Payer's last name.
			$cntryCode			= $resArrayGetExpressCheckout["COUNTRYCODE"]; // ' Payer's country of residence in the form of ISO standard 3166 two-character country codes.
			$shipToName			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTONAME"]; // ' Person's name associated with this address.
			$shipToStreet		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOSTREET"]; // ' First street address.
			$shipToCity			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOCITY"]; // ' Name of city.
			$shipToState		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOSTATE"]; // ' State or province
			$shipToCntryCode	= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOCOUNTRYCODE"]; // ' Country code. 
			$shipToZip			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOZIP"]; // ' U.S. Zip code or other country-specific postal code.
			$addressStatus 		= $resArrayGetExpressCheckout["ADDRESSSTATUS"]; // ' Status of street address on file with PayPal 
			$totalAmt   		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_AMT"]; // ' Total Amount to be paid by buyer
			$currencyCode       = $resArrayGetExpressCheckout["CURRENCYCODE"]; // 'Currency being used 
			$shippingAmt        = $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPPINGAMT"]; // 'Currency being used 
			/*
			* Add check here to verify if the payment amount stored in session is the same as the one returned from GetExpressCheckoutDetails API call
			* Checks whether the session has been compromised
			*/
			if($_SESSION["Payment_Amount"] != $totalAmt || $_SESSION["currencyCodeType"] != $currencyCode)
			exit("Parameters in session do not match those in PayPal API calls");
		} 
		else  
		{
			//Display a user friendly Error on the page using any of the following error information returned by PayPal
			$ErrorCode = urldecode($resArrayGetExpressCheckout["L_ERRORCODE0"]);
			$ErrorShortMsg = urldecode($resArrayGetExpressCheckout["L_SHORTMESSAGE0"]);
			$ErrorLongMsg = urldecode($resArrayGetExpressCheckout["L_LONGMESSAGE0"]);
			$ErrorSeverityCode = urldecode($resArrayGetExpressCheckout["L_SEVERITYCODE0"]);

			echo "GetExpressCheckoutDetails API call failed. ";
			echo "Detailed Error Message: " . $ErrorLongMsg;
			echo "Short Error Message: " . $ErrorShortMsg;
			echo "Error Code: " . $ErrorCode;
			echo "Error Severity Code: " . $ErrorSeverityCode;
		}
	}
	if(!USERACTION_FLAG){
	include("header.php");
?>	
	<div class="span4">
	</div>
	<div class="span5">
		<table>
			<tbody>
				<tr><td><h4>Shipping Address</h5></td><td><h4>Billing Address</h4></td></tr>
				<tr><td><?php echo $shipToName;		?></td><td><?php echo $shipToName;		?></td></tr>
				<tr><td><?php echo $shipToStreet;	?></td><td><?php echo $shipToStreet;	?></td></tr>
				<tr><td><?php echo $shipToCity;		?></td><td><?php echo $shipToCity;		?></td></tr>
				<tr><td><?php echo $shipToState;	?></td><td><?php echo $shipToState;		?></td></tr>
				<tr><td><?php echo $shipToCntryCode;?></td><td><?php echo $shipToCntryCode;	?></td></tr>
				<tr><td><?php echo $shipToZip;		?></td><td><?php echo $shipToZip;		?></td></tr>
				<tr><td colspan="2">&nbsp;</td></tr>
				<tr><td colspan="2">&nbsp;</td></tr>
				<tr><td>Total Amount:</td><td><?php echo $totalAmt   		?></td></tr>
				<tr><td>Currency Code:</td><td><?php echo $currencyCode   	?></td></tr>
				<tr><td>&nbsp;</td></tr>
				<tr><td><h3>Shipping Method</h3></td></tr>
				<form action="return.php" name="order_confirm" method="POST">
					<tr><td>Shipping methods: </td><td><select name="shipping_method" id="shipping_method" style="width: 250px;" class="required-entry">
						<optgroup label="United Parcel Service" style="font-style:normal;">
						<option value="2.00">
						Worldwide Expedited - $2.00</option>
						<option value="3.00">
						Worldwide Express Saver - $3.00</option>
						</optgroup>
						<optgroup label="Flat Rate" style="font-style:normal;">
						<option value="0.00" selected>
						Fixed - $0.00</option>
						</optgroup>
						</select><br></td></tr>
					<tr><td><input type="Submit" name="confirm" alt="Check out with PayPal" class="btn btn-primary btn-large" value="Confirm Order"></td></tr>
				</form>
			</tbody>
		</table>
	</div>
	<div class="span3">
	</div>
	<?php
	}
	?>
<?php include('footer.php'); ?>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\uapi.php 
*******************************************************************************/
<?php require_once ("config.php"); ?>
<?php
//'------------------------------------
//' Calls the SetExpressCheckout API call
//'
//' The CallMarkExpressCheckout function is defined in the file paypal_functions.php,
//' it is included at the top of this file.
//'-------------------------------------------------

$itemDetail = $_SESSION['post_value'];
$shippingDetail = $_POST;
$paymentAmount = $itemDetail['PAYMENTREQUEST_0_AMT'];
if(isset($_POST['shipping_method'])) {
$new_shipping = $_POST['shipping_method']; //need to change this value, just for testing
	if($itemDetail['PAYMENTREQUEST_0_SHIPPINGAMT'] > 0){
		$paymentAmount = ($paymentAmount + $new_shipping) - $itemDetail['PAYMENTREQUEST_0_SHIPPINGAMT'];
		$itemDetail['PAYMENTREQUEST_0_SHIPPINGAMT'] = $new_shipping;
		$itemDetail['PAYMENTREQUEST_0_AMT'] = $paymentAmount;
	}
}
$resArray = CallMarkExpressCheckout ($paymentAmount, $shippingDetail, $itemDetail);

$ack = strtoupper($resArray["ACK"]);
if($ack=="SUCCESS" || $ack=="SUCCESSWITHWARNING")  //if SetExpressCheckout API call is successful
{
	RedirectToPayPal ( $resArray["TOKEN"] );
} 
else  
{
	//Display a user friendly Error on the page using any of the following error information returned by PayPal
	$ErrorCode = urldecode($resArray["L_ERRORCODE0"]);
	$ErrorShortMsg = urldecode($resArray["L_SHORTMESSAGE0"]);
	$ErrorLongMsg = urldecode($resArray["L_LONGMESSAGE0"]);
	$ErrorSeverityCode = urldecode($resArray["L_SEVERITYCODE0"]);

	echo "SetExpressCheckout API call failed. ";
	echo "Detailed Error Message: " . $ErrorLongMsg;
	echo "Short Error Message: " . $ErrorShortMsg;
	echo "Error Code: " . $ErrorCode;
	echo "Error Severity Code: " . $ErrorSeverityCode;
}

?>


/*******************************************************************************
 File : \root\a3rd\paypal_ec\ureturn.php 
*******************************************************************************/
<?php 
	/*
	* Call to GetExpressCheckoutDetails and DoExpressCheckoutPayment APIs
	*/

	require_once ("config.php");

	/*
	* The paymentAmount is the total value of the shopping cart(in real apps), here it was set 
    * in paypalfunctions.php in a session variable 
	*/
	
	$finalPaymentAmount =  $_SESSION["Payment_Amount"];
	if(!isset($_SESSION['payer_id']))
	{
		$_SESSION['payer_id'] =	$_GET['PayerID'];
	}


	// Check to see if the Request object contains a variable named 'token'	or Session object contains a variable named TOKEN 
	$token = "";
	
	if (isset($_REQUEST['token']))
	{
		$token = $_REQUEST['token'];
	} else if(isset($_SESSION['TOKEN']))
	{
		$token = $_SESSION['TOKEN'];
	}
	
	// If the Request object contains the variable 'token' then it means that the user is coming from PayPal site.	
	if ( $token != "" )
	{
		/*
		* Calls the GetExpressCheckoutDetails API call
		*/
		$resArrayGetExpressCheckout = GetShippingDetails( $token );
		$ackGetExpressCheckout = strtoupper($resArrayGetExpressCheckout["ACK"]);	 
		if( $ackGetExpressCheckout == "SUCCESS" || $ackGetExpressCheckout == "SUCESSWITHWARNING") 
		{
			/*
			* The information that is returned by the GetExpressCheckoutDetails call should be integrated by the partner into his Order Review 
			* page		
			*/
			$email 				= $resArrayGetExpressCheckout["EMAIL"]; // ' Email address of payer.
			$payerId 			= $resArrayGetExpressCheckout["PAYERID"]; // ' Unique PayPal customer account identification number.
			$payerStatus		= $resArrayGetExpressCheckout["PAYERSTATUS"]; // ' Status of payer. Character length and limitations: 10 single-byte alphabetic characters.
			$firstName			= $resArrayGetExpressCheckout["FIRSTNAME"]; // ' Payer's first name.
			$lastName			= $resArrayGetExpressCheckout["LASTNAME"]; // ' Payer's last name.
			$cntryCode			= $resArrayGetExpressCheckout["COUNTRYCODE"]; // ' Payer's country of residence in the form of ISO standard 3166 two-character country codes.
			$shipToName			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTONAME"]; // ' Person's name associated with this address.
			$shipToStreet		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOSTREET"]; // ' First street address.
			$shipToCity			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOCITY"]; // ' Name of city.
			$shipToState		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOSTATE"]; // ' State or province
			$shipToCntryCode	= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOCOUNTRYCODE"]; // ' Country code. 
			$shipToZip			= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPTOZIP"]; // ' U.S. Zip code or other country-specific postal code.
			$addressStatus 		= $resArrayGetExpressCheckout["ADDRESSSTATUS"]; // ' Status of street address on file with PayPal 
			$totalAmt   		= $resArrayGetExpressCheckout["PAYMENTREQUEST_0_AMT"]; // ' Total Amount to be paid by buyer
			$currencyCode       = $resArrayGetExpressCheckout["CURRENCYCODE"]; // 'Currency being used 
			$shippingAmt        = $resArrayGetExpressCheckout["PAYMENTREQUEST_0_SHIPPINGAMT"]; // 'Shipping amount 
			/*
			* Add check here to verify if the payment amount stored in session is the same as the one returned from GetExpressCheckoutDetails API call
			* Checks whether the session has been compromised
			*/
			if($_SESSION["Payment_Amount"] != $totalAmt || $_SESSION["currencyCodeType"] != $currencyCode)
			exit("Parameters in session do not match those in PayPal API calls");
		} 
		else  
		{
			//Display a user friendly Error on the page using any of the following error information returned by PayPal
			$ErrorCode = urldecode($resArrayGetExpressCheckout["L_ERRORCODE0"]);
			$ErrorShortMsg = urldecode($resArrayGetExpressCheckout["L_SHORTMESSAGE0"]);
			$ErrorLongMsg = urldecode($resArrayGetExpressCheckout["L_LONGMESSAGE0"]);
			$ErrorSeverityCode = urldecode($resArrayGetExpressCheckout["L_SEVERITYCODE0"]);

			echo "GetExpressCheckoutDetails API call failed. ";
			echo "Detailed Error Message: " . $ErrorLongMsg;
			echo "Short Error Message: " . $ErrorShortMsg;
			echo "Error Code: " . $ErrorCode;
			echo "Error Severity Code: " . $ErrorSeverityCode;
		}
	}
	/* Review block start */
	
	if(!USERACTION_FLAG && !isset($_SESSION['EXPRESS_MARK'])){
	if(isset($_POST['shipping_method']))
		$new_shipping = $_POST['shipping_method']; //need to change this value, just for testing
		if($shippingAmt > 0){
			$finalPaymentAmount = ($totalAmt + $new_shipping) - $_SESSION['shippingAmt'];
			$_SESSION['shippingAmt'] = $new_shipping;
		}
	}
	
	/* Review block end */
	/*
	* Calls the DoExpressCheckoutPayment API call
	*/
	//$resArrayDoExpressCheckout = ConfirmPayment ( $newTotalAmt );
	$resArrayDoExpressCheckout = ConfirmPayment ( $finalPaymentAmount );
	$ackDoExpressCheckout = strtoupper($resArrayDoExpressCheckout["ACK"]);
	include('header.php');

	session_unset();   // free all session variables
	session_destroy(); //destroy session
	if( $ackDoExpressCheckout == "SUCCESS" || $ackDoExpressCheckout == "SUCCESSWITHWARNING" )
	{
		$transactionId		= $resArrayDoExpressCheckout["PAYMENTINFO_0_TRANSACTIONID"]; // ' Unique transaction ID of the payment. Note:  If the PaymentAction of the request was Authorization or Order, this value is your AuthorizationID for use with the Authorization & Capture APIs. 
		$transactionType 	= $resArrayDoExpressCheckout["PAYMENTINFO_0_TRANSACTIONTYPE"]; //' The type of transaction Possible values: l  cart l  express-checkout 
		$paymentType		= $resArrayDoExpressCheckout["PAYMENTINFO_0_PAYMENTTYPE"];  //' Indicates whether the payment is instant or delayed. Possible values: l  none l  echeck l  instant 
		$orderTime 			= $resArrayDoExpressCheckout["PAYMENTINFO_0_ORDERTIME"];  //' Time/date stamp of payment
		$amt				= $resArrayDoExpressCheckout["PAYMENTINFO_0_AMT"];  //' The final amount charged, including any shipping and taxes from your Merchant Profile.
		$currencyCode		= $resArrayDoExpressCheckout["PAYMENTINFO_0_CURRENCYCODE"];  //' A three-character currency code for one of the currencies listed in PayPay-Supported Transactional Currencies. Default: USD. 
		/*
		* Status of the payment: 
		* Completed: The payment has been completed, and the funds have been added successfully to your account balance.
		* Pending: The payment is pending. See the PendingReason element for more information. 
		*/
		
		$paymentStatus	= $resArrayDoExpressCheckout["PAYMENTINFO_0_PAYMENTSTATUS"]; 

		/*
		* The reason the payment is pending 
		*/
		$pendingReason	= $resArrayDoExpressCheckout["PAYMENTINFO_0_PENDINGREASON"];  

		/*
		* The reason for a reversal if TransactionType is reversal 
		*/
		$reasonCode		= $resArrayDoExpressCheckout["PAYMENTINFO_0_REASONCODE"];   
		?>
			<span class="span4">
    		</span>
    		<span class="span5">
    			<div class="hero-unit">
    			<!-- Display the Transaction Details-->
    			<h4> <?php echo($firstName); ?>
    				<?php echo($lastName); ?> , Thank you for your Order </h4>
    			
    			<h4> Shipping Details: </h4>
				<?php echo($shipToName) ?><br>
				<?php echo($shipToStreet) ?><br>
				<?php echo($shipToCity) ?><br>
				<?php echo($shipToState) ?>- <?php echo($shipToZip) ?></p>
    			<p>Transaction ID: <?php  echo($transactionId);?> </p>
    			<p>Transaction Type: <?php  echo($transactionType);?> </p>
    			<p>Payment Total Amount: <?php  echo($amt);?> </p>
    			<p>Currency Code: <?php  echo($currencyCode);?> </p>
    			<p>Payment Status: <?php  echo($paymentStatus);?> </p>
    			<p>Payment Type: <?php  echo($paymentType);?> </p>
    			<h3> Click <a href='index.php'>here </a> to return to Home Page</h3>
    			</div>
    		</span>
    		<span class="span3">
    		</span>
		<?php
	}
	else  
	{
		//Display a user friendly Error on the page using any of the following error information returned by PayPal

		$ErrorCode = urldecode($resArrayDoExpressCheckout["L_ERRORCODE0"]);
		$ErrorShortMsg = urldecode($resArrayDoExpressCheckout["L_SHORTMESSAGE0"]);
		$ErrorLongMsg = urldecode($resArrayDoExpressCheckout["L_LONGMESSAGE0"]);
		$ErrorSeverityCode = urldecode($resArrayDoExpressCheckout["L_SEVERITYCODE0"]);

		if($ErrorCode == 10486)  //Transaction could not be completed error because of Funding failure. Should redirect user to PayPal to manage their funds.
		{
			?>
			<!--<div class="hero-unit">
    			 Display the Transaction Details
    			<h4> There is a Funding Failure in your account. You can modify your funding sources to fix it and make purchase later. </h4>
    			Payment Status:-->
    			<?php  //echo($resArrayDoExpressCheckout["PAYMENTINFO_0_PAYMENTSTATUS"]);
						RedirectToPayPal ( $resArray["TOKEN"] );
    			?>
    			<!--<h3> Click <a href='https://www.sandbox.paypal.com/'>here </a> to go to PayPal site.</h3> <!--Change to live PayPal site for production-->
    		<!--</div>-->
			<?php
		}
		else
		{
			echo "DoExpressCheckout API call failed. ";
			echo "Detailed Error Message: " . $ErrorLongMsg;
			echo "Short Error Message: " . $ErrorShortMsg;
			echo "Error Code: " . $ErrorCode;
			echo "Error Severity Code: " . $ErrorSeverityCode;
		}
	}		
?>
<?php include('footer.php'); ?>


/*******************************************************************************
 File : \root\a3rd\qqconn\comm\config.php 
*******************************************************************************/
<?php
require(dirname(dirname(dirname(__FILE__))).'/a3rd_cfgs.php');
define('DIR_QQCONN', dirname(dirname(__FILE__))); 
define('PATH_QQCONN', PATH_ROOT.'/a3rd/qqconn');
/**
 * PHP SDK for QQ登录 OpenAPI(based on OAuth2.0)
 *
 * @version 1.0
 * @author connect@qq.com
 * @copyright ? 2011, Tencent Corporation. All rights reserved.
 */

/**
 * @brief 本文件作为demo的配置文件。
 */

/**
 * 正式运营环境请关闭错误信息
 * ini_set("error_reporting", E_ALL);
 * ini_set("display_errors", TRUE);
 * QQDEBUG = true  开启错误提示
 * QQDEBUG = false 禁止错误提示
 * 默认禁止错误信息
 */
/*define("QQDEBUG", true);
if (defined("QQDEBUG") && QQDEBUG)
{
    @ini_set("error_reporting", E_ALL);
    @ini_set("display_errors", TRUE);
}*/

/**
 * session
 */
#include_once("session.php");


/**
 * 在你运行本demo之前请到 http://connect.opensns.qq.com/申请appid, appkey, 并注册callback地址
 */
//申请到的appid
$_SESSION["appid"]    = $pay_uinfo['qqconn']['appid']; 

//申请到的appkey
$_SESSION["appkey"]   = $pay_uinfo['qqconn']['appkey']; 

//QQ登录成功后跳转的地址,请确保地址真实可用，否则会导致登录失败。
$_SESSION["callback"] = $pay_uinfo['qqconn']['callback']; 

//QQ授权api接口.按需调用
$_SESSION["scope"] = "get_user_info"; //get_user_info,add_share,list_album,add_album,upload_pic,add_topic,add_one_blog,add_weibo

//print_r ($_SESSION);
?>



/*******************************************************************************
 File : \root\a3rd\qqconn\comm\session.php 
*******************************************************************************/
<?php
/**
 * PHP SDK for QQ登录 OpenAPI(based on OAuth2.0)
 *
 * @version 1.0
 * @author connect@qq.com
 * @copyright ? 2011, Tencent Corporation. All rights reserved.
 */

/**
 * @brief 设置session配置 
 */

/**
 * CREATE TABLE `tbl_session` (
 *     `session_id` varchar(255) binary NOT NULL default '',
 *     `session_expires` int(10) unsigned NOT NULL default '0',
 *     `session_data` text,
 *     PRIMARY KEY  (`session_id`)
 *    ) ENGINE=MyISAM;
 */

class Session 
{
    //mysql的主机地址
    const db_host = "127.0.0.1"; //需要第三方指定ip地址 

    //数据库用户名
    const db_user = "redfox";   //需要第三方指定自己的用户名

    //数据库密码
    const db_pwd = "redfox@401"; //需要第三方指定自己的库据库密码

    //数据库
    const db_name = "test";      //需要第三方指定数据库

    //数据库表
    const db_table = "tbl_session"; //需要第三方指定数据表

    //mysql-handle
    private $db_handle;

    //session-lifetime
    private $lifeTime;

    function open($savePath, $sessName) 
    {
        // get session-lifetime
        $this->lifeTime = get_cfg_var("session.gc_maxlifetime");

        // open database-connection
        $db_handle = @mysql_connect(self::db_host, self::db_user, self::db_pwd);

        $dbSel = @mysql_select_db(self::db_name, $db_handle);

        // return success
        if(!$db_handle || !$dbSel)
            return false;

        $this->db_handle = $db_handle;
        return true;
    }

    function close() 
    {
        $this->gc(ini_get('session.gc_maxlifetime'));
        // close database-connection
        return @mysql_close($this->db_handle);
    }

    function read($sessID) 
    {
        // fetch session-data
        $res = @mysql_query("SELECT session_data AS d FROM ".self::db_table." 
            WHERE session_id = '$sessID'
            AND session_expires > ".time(), $this->db_handle);

        // return data or an empty string at failure
        if($row = @mysql_fetch_assoc($res))
            return $row['d'];

        return "";
    }

    function write($sessID, $sessData) 
    {
        // new session-expire-time
        $newExp = time() + $this->lifeTime;

        // is a session with this id in the database?
        $res = @mysql_query("SELECT * FROM ".self::db_table." 
            WHERE session_id = '$sessID'", $this->db_handle);

        // if yes,
        if(@mysql_num_rows($res)) 
        {
            // ...update session-data
            @mysql_query("UPDATE ".self::db_table." 
                SET session_expires = '$newExp',
                session_data = '$sessData'
                WHERE session_id = '$sessID'", $this->db_handle);

            // if something happened, return true
            if(@mysql_affected_rows($this->db_handle))
                return true;
        }
        else // if no session-data was found,
        {
            // create a new row
            @mysql_query("INSERT INTO ".self::db_table." (
                session_id,
                session_expires,
                session_data)
                VALUES(
                    '$sessID',
                    '$newExp',
                    '$sessData')", $this->db_handle);
            // if row was created, return true
            if(@mysql_affected_rows($this->db_handle))
                return true;
        }

        // an unknown error occured
        return false;
    }

    function destroy($sessID) 
    {
        // delete session-data
        @mysql_query("DELETE FROM ".self::db_table." WHERE session_id = '$sessID'", $this->db_handle);

        // if session was deleted, return true,
        if(@mysql_affected_rows($this->db_handle))
            return true;

        // ...else return false
        return false;
    }

    function gc($sessMaxLifeTime) 
    {
        // delete old sessions
        @mysql_query("DELETE FROM ".self::db_table." WHERE session_expires < ".time(), $this->db_handle);

        // return affected rows
        return @mysql_affected_rows($this->db_handle);
    }
}

/**
 * 指定session有效的域名
 * ini_set("session.cookie_domain", ".domain.com");
 * .domain.com是站点的主域名,请注意前面个有一个'.'
 */
define("MAIN_DOMAIN", ".oauth.com");   //设置主域名

/**
 * 不同子域名下共享session信息
 * COOKIE_DOMAIN = false 禁止该功能
 * COOKIE_DOMAIN = true  启用该功能
 * 默认禁止
 * 开启前提需要定义MAIN_DOMAIN常量
 */
define("COOKIE_DOMAIN", true); 
if (defined("COOKIE_DOMAIN") && COOKIE_DOMAIN)
{
    if (defined("MAIN_DOMAIN"))
        @ini_set("session.cookie_domain", MAIN_DOMAIN);
}

/**
 * 同一个主域名，不同服务器之间共享session信息
 * USER_SESSION = false 禁用该功能
 * USER_SESSION = true  启用该功能
 * 默认禁止
 * 开启前提需要建立mysql数据表
 */
define("USER_SESSION", false);
if (defined("USER_SESSION") && USER_SESSION)
{
    @ini_set("session.save_handler", "user");
    $session = new Session;
    @session_module_name("user");
    @session_set_save_handler(
        array(&$session, "open"),
        array(&$session, "close"),
        array(&$session, "read"),
        array(&$session, "write"),
        array(&$session, "destroy"),
        array(&$session, "gc"));
}

//@session_id("demo");
@session_start();
?>



/*******************************************************************************
 File : \root\a3rd\qqconn\comm\utils.php 
*******************************************************************************/
<?php
/**
 * PHP SDK for QQ登录 OpenAPI(based on OAuth2.0)
 *
 * @version 1.0
 * @author connect@qq.com
 * @copyright ? 2011, Tencent Corporation. All rights reserved.
 */

/**
 * @brief 本文件包含了OAuth认证过程中会用到的公用方法 
 */

require_once("config.php");

function do_post($url, $data)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); 
    curl_setopt($ch, CURLOPT_POST, TRUE); 
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data); 
    curl_setopt($ch, CURLOPT_URL, $url);
    $ret = curl_exec($ch);

    curl_close($ch);
    return $ret;
}

?>



/*******************************************************************************
 File : \root\a3rd\qqconn\oauth\get_user_info.php 
*******************************************************************************/
<?php

require_once("../comm/config.php");

function get_user_info()
{
    $get_user_info = "https://graph.qq.com/user/get_user_info?"
        . "access_token=" . $_SESSION['access_token']
        . "&oauth_consumer_key=" . $_SESSION["appid"]
        . "&openid=" . $_SESSION["openid"]
        . "&format=json";

    $info = file_get_contents($get_user_info);
    $arr = json_decode($info, true);

    return $arr;
}

//获取用户基本资料
$arr = get_user_info();
//print_r($arr);

echo "<p>";
echo "Gender:".$arr["gender"];
echo "</p>";
echo "<p>";
echo "NickName:".$arr["nickname"];
echo "</p>";
echo "<p>";
echo "<img src=\"".$arr['figureurl']."\">";
echo "<p>";
echo "<p>";
echo "<img src=\"".$arr['figureurl_1']."\">";
echo "<p>";
echo "<p>";
echo "<img src=\"".$arr['figureurl_2']."\">";
echo "<p>";

?>



/*******************************************************************************
 File : \root\a3rd\qqconn\oauth\qq_callback.php 
*******************************************************************************/
<?php 
require_once("../comm/config.php");

function qq_callback()
{
    //debug
    //print_r($_REQUEST);
    //print_r($_SESSION);

    if($_REQUEST['state'] == $_SESSION['state']) //csrf
    {
        $token_url = "https://graph.qq.com/oauth2.0/token?grant_type=authorization_code&"
            . "client_id=" . $_SESSION["appid"]. "&redirect_uri=" . urlencode($_SESSION["callback"])
            . "&client_secret=" . $_SESSION["appkey"]. "&code=" . $_REQUEST["code"];

        $response = file_get_contents($token_url);
        if (strpos($response, "callback") !== false)
        {
            $lpos = strpos($response, "(");
            $rpos = strrpos($response, ")");
            $response  = substr($response, $lpos + 1, $rpos - $lpos -1);
            $msg = json_decode($response);
            if (isset($msg->error))
            {
                echo "<h3>error:</h3>" . $msg->error;
                echo "<h3>msg  :</h3>" . $msg->error_description;
                exit;
            }
        }

        $params = array();
        parse_str($response, $params);

        //debug
        //print_r($params);

        //set access token to session
        $_SESSION["access_token"] = $params["access_token"];

    }
    else 
    {
        echo("The state does not match. You may be a victim of CSRF.");
    }
}

function get_openid()
{
    $graph_url = "https://graph.qq.com/oauth2.0/me?access_token=" 
        . $_SESSION['access_token'];

    $str  = file_get_contents($graph_url);
    if (strpos($str, "callback") !== false)
    {
        $lpos = strpos($str, "(");
        $rpos = strrpos($str, ")");
        $str  = substr($str, $lpos + 1, $rpos - $lpos -1);
    }

    $user = json_decode($str);
    if (isset($user->error))
    {
        echo "<h3>error:</h3>" . $user->error;
        echo "<h3>msg  :</h3>" . $user->error_description;
        exit;
    }

    //debug
    //echo("Hello " . $user->openid);

    //set openid to session
    $_SESSION["openid"] = $user->openid;
}

//QQ登录成功后的回调地址,主要保存access token
qq_callback();

//获取用户标示id
get_openid();

//print_r($_SESSION);
echo "<script>window.close();</script>";
?>



/*******************************************************************************
 File : \root\a3rd\qqconn\oauth\qq_login.php 
*******************************************************************************/
<?php
require_once("../comm/config.php");


function qq_login($appid, $scope, $callback)
{
    $_SESSION['state'] = md5(uniqid(rand(), TRUE)); //CSRF protection
    $login_url = "https://graph.qq.com/oauth2.0/authorize?response_type=code&client_id=" 
        . $appid . "&redirect_uri=" . urlencode($callback)
        . "&state=" . $_SESSION['state']
        . "&scope=".$scope;
    header("Location:$login_url");
}

//用户点击qq登录按钮调用此函数
qq_login($_SESSION["appid"], $_SESSION["scope"], $_SESSION["callback"]);
?>



/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\notify_query.php 
*******************************************************************************/
<?php
//---------------------------------------------------------
//财付通APP接收到财付通的支付成功通知后，通过此接口查询订单的详细情况，
//以确保通知是从财付通发起的，没有被篡改过。
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/NotifyQueryRequest.class.php");

/* 初始化通知验证请求:财付通APP接收到财付通的支付成功通知后，通过此接口查询订单的详细情况，以确保通知是从财付通发起的，没有被篡改过。 */
// 设置在沙箱中运行:正式环境请设置为false
$noqHandler = new NotifyQueryRequest($key);

// 设置在沙箱中运行，正式环境请设置为false,true
$noqHandler->setInSandBox($sandbox);
//----------------------------------------
//以下请求业务参数名称参考开放平台sdk文档-PHP
//----------------------------------------
// 设置财付通App-id: 财付通App注册时，由财付通分配
$noqHandler->setAppid($appid);	

// 设置通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
$noqHandler->setParameter("notify_id", "GamplMcX9Zl0E6shwd8p5c548DHnJWh7ZKkwCocL40j3Qwj6QkJZiOq5H-Ll2tYNRmP2K-NUga4=");          
// ************************************end*******************************

// 发送请求，并获取返回对象
$Response = $noqHandler->send();

// ********************以下返回业务参数名称参考开放平台sdk文档-PHP*************************
if($Response->isPayed()) {// 已经支付
	// 已经支付财付通app订单号
	echo "支付成功，应用订单号：" . $Response->getParameter("out_trade_no") . "<br/>";
	// 财付通app订单号对应的财付通订单号
	echo "财付通订单号:" . $Response->getParameter("transaction_id") . "<br/>";
	// 支付金额，单位：分
	echo "支付金额:" . $Response->getParameter("total_fee") . "<br/>";
	// 支付完成时间,格式为yyyymmddhhmmss,如20091227091010
	echo "支付完成时间:" . $Response->getParameter("time_end") . "<br/>";
}else {// 未正常支付，或者调用异常，如调用超时、网络异常
	echo "支付状态说明:" . $Response->getPayInfo() . "<br/>";
}

?>



/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\notify_url.php 
*******************************************************************************/
<?php

//---------------------------------------------------------
//支付成功回调接收,财付通后台调用此地址
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayResponse.class.php");

/* 创建支付结果反馈响应对象：支付跳转接口为异步返回，用户在财付通完成支付后，财付通通过回调return_url和notify_url向财付通APP反馈支付结果。 */
$resHandler = new PayResponse($key);
//获取通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
echo $resHandler->getNotifyId();

// 告知财付通通知发送成功，如不加上下行代码会导致财付通不停里通知财付通app，即不停里调用财付通app的notify_url进行通知
$resHandler->acknowledgeSuccess();
// 开始通知验证，具体方法请参考notify_query.php的介绍


?>


/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\order_query.php 
*******************************************************************************/
<?php
//---------------------------------------------------------
//根据商户订单号或者财付通订单号查询财付通侧记录的具体订单信息
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayRequest.class.php"); 
require_once(DIR_VENDOR."/a3rd/tenpay_class/OrderQueryRequest.class.php"); 


// 初始化订单查询请求:根据商户订单号或者财付通订单号查询财付通侧记录的具体订单信息.
$ordHandler = new OrderQueryRequest($key);

// 设置在沙箱中运行，正式环境请设置为false
$ordHandler->setInSandBox($sandbox);

//----------------------------------------
//以下请求业务参数名称参考开放平台sdk文档-PHP
//----------------------------------------

// 设置财付通App-id: 财付通App注册时，由财付通分配
$ordHandler->setAppid($appid);		

// 设置财付通App订单号:财付通APP的订单号
$ordHandler->setParameter("out_trade_no", "test100000001");    
// **********************end*************************

// 发送请求，并获取返回对象
$Response = $ordHandler->send();
// ********************以下返回业务参数名称参考开放平台sdk文档-PHP*************************
if($Response->isPayed()) {// 已经支付
	// 已经支付财付通app订单号
	echo "支付成功，应用订单号：" . $Response->getParameter("out_trade_no") . "<br/>";
	// 财付通app订单号对应的财付通订单号
	echo "财付通订单号:" . $Response->getParameter("transaction_id") . "<br/>";
	// 支付金额，单位：分
	echo "支付金额:" . $Response->getParameter("total_fee") . "<br/>";
	// 支付完成时间,格式为yyyymmddhhmmss,如20091227091010
	echo "支付完成时间:" . $Response->getParameter("time_end") . "<br/>";
}else{// 未正常支付，或者调用异常，如调用超时、网络异常
    echo "支付状态说明:" . $Response->getPayInfo() . "<br/>";
}


?>



/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\pay.php 
*******************************************************************************/
<?php
//---------------------------------------------------------
//生成支付请求串示例,用于生成支付请求
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayRequest.class.php"); 

$curDateTime = date("YmdHis");
$randNum = rand(1000, 9999);
  /* 商家的定单号 */
$out_trade_no = $curDateTime . $randNum;

/* 创建支付请求对象 */
$reqHandler = new PayRequest($key); 

// 设置在沙箱中运行，正式环境请设置为false,true
$reqHandler->setInSandBox($sandbox);
//----------------------------------------
//以下业务参数名称参考开放平台sdk文档-PHP
//----------------------------------------
//echo 'xx'; die();
// 设置财付通appid: 财付通app注册时，由财付通分配
$reqHandler->setAppid($appid); 

// 设置商户系统订单号：财付通APP系统内部的订单号,32个字符内、可包含字母,确保在财付通APP系统唯一
$reqHandler->setParameter("out_trade_no", $out_trade_no);           

// 设置订单总金额，单位为分
$reqHandler->setParameter("total_fee", "1");					

// 设置通知url：接收财付通后台通知的URL，用户在财付通完成支付后，财付通会回调此URL，向财付通APP反馈支付结果。
// 此URL可能会被多次回调，请正确处理，避免业务逻辑被多次触发。需给绝对路径，例如：http://wap.isv.com/notify.asp
$reqHandler->setParameter("notify_url", $notify_url);				

// 设置返回url：用户完成支付后跳转的URL，财付通APP应在此页面上给出提示信息，引导用户完成支付后的操作。
// 财付通APP不应在此页面内做发货等业务操作，避免用户反复刷新页面导致多次触发业务逻辑造成不必要的损失。
// 需给绝对路径，例如：http://wap.isv.com/after_pay.asp，通过该路径直接将支付结果以Get的方式返回
$reqHandler->setParameter("return_url", $return_url);				

// 设置商品名称:商品描述，会显示在财付通支付页面上
$reqHandler->setParameter("body", "支付测试");	            

// 设置用户客户端ip:用户IP，指用户浏览器端IP，不是财付通APP服务器IP
$reqHandler->setParameter("spbill_create_ip", $_SERVER['REMOTE_ADDR']);
// **********************end*************************

//支付请求的URL
$reqUrl = $reqHandler->getURL();


?>
<html>
<head>
	<meta charset="utf-8">
	<title>财付通开放平台支付演示</title>
</head>
<body>
<br/><a href="<?php echo $reqUrl ?>" target="_blank">去付款</a>
</body>
</html>



/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\return_url.php 
*******************************************************************************/
<?php

//---------------------------------------------------------
//财付通即时到帐支付应答（处理回调）示例，商户按照此文档进行开发即可
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayResponse.class.php");

/* 创建支付结果反馈响应对象：支付跳转接口为异步返回，用户在财付通完成支付后，财付通通过回调return_url和notify_url向财付通APP反馈支付结果。 */
$resHandler = new PayResponse($key);

//获取通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
echo "<br/>" . "本次支付的通知ID：" . $resHandler->getNotifyId() . "<br/>";

?>


/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\ShareLoginState.php 
*******************************************************************************/
<?php
//---------------------------------------------------------
//共享登录接收当前用户信息
//---------------------------------------------------------
require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/ShareLoginState.class.php");

/* 创建共享登陆态对象：买家转到财付通APP中时，系统将买家的ID传入APP，方便用户订单生成、用户状态更新等相关操作。 */
$shareLogin = new ShareLoginState($key);

// 获取用户id
echo $shareLogin->getUserId();

?>


/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\tenpay_config.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(__FILE__)); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/tenpay_sdk');
/*
	*功能：设置财付通帐户有关信息及返回接收路径
	*日期：2010-07-7
	'备注：
	'该部分代码只是提供一个支付案例，方便商户商户使用及测试，可以帮助开发人员快速入门并掌握开发技能；
	'对于具有WEB程序开发背景的技术开发人员，可以另外开发接口。
*/

//设置财付通App-id: 财付通App注册时，由财付通分配
$appid = $pay_uinfo['ten']['appid']; 

//签名密钥: 开发者注册时，由财付通分配
$key = $pay_uinfo['ten']['key'];  

//sabdbox
$sandbox = $pay_uinfo['ten']['sandbox'];     

// 设置通知url：接收财付通后台通知的URL，用户在财付通完成支付后，财付通会回调此URL，向财付通APP反馈支付结果。
// 此URL可能会被多次回调，请正确处理，避免业务逻辑被多次触发。需给绝对路径，例如：http://wap.isv.com/notify.asp
$notify_url = "http://localhost/tenpay/examples/notify_url.php";  

// 设置返回url：用户完成支付后跳转的URL，财付通APP应在此页面上给出提示信息，引导用户完成支付后的操作。
// 财付通APP不应在此页面内做发货等业务操作，避免用户反复刷新页面导致多次触发业务逻辑造成不必要的损失。
// 需给绝对路径，例如：http://wap.isv.com/after_pay.asp，通过该路径直接将支付结果以Get的方式返回
$return_url = "http://localhost/tenpay/examples/return_url.php"; 



/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\uapi.php 
*******************************************************************************/
<?php
//---------------------------------------------------------
//生成支付请求串示例,用于生成支付请求
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayRequest.class.php"); 

$notify_url = $_cbase['run']['roots']."/a3rd/tenpay_sdk/unotify.php";
$return_url = $_cbase['run']['roots']."/a3rd/tenpay_sdk/ureturn.php";

  /* 商家的定单号 */
$out_trade_no = basReq::val('out_trade_no');

/* 创建支付请求对象 */
$reqHandler = new PayRequest($key); 

// 设置在沙箱中运行，正式环境请设置为false,true
$reqHandler->setInSandBox($sandbox);
//----------------------------------------
//以下业务参数名称参考开放平台sdk文档-PHP
//----------------------------------------
//echo 'xx'; die();
// 设置财付通appid: 财付通app注册时，由财付通分配
$reqHandler->setAppid($appid); 

// 设置商户系统订单号：财付通APP系统内部的订单号,32个字符内、可包含字母,确保在财付通APP系统唯一
$reqHandler->setParameter("out_trade_no", $out_trade_no);           

// 设置订单总金额，单位为分
$reqHandler->setParameter("total_fee", basReq::val('total_fee'));					

// 设置通知url：接收财付通后台通知的URL，用户在财付通完成支付后，财付通会回调此URL，向财付通APP反馈支付结果。
// 此URL可能会被多次回调，请正确处理，避免业务逻辑被多次触发。需给绝对路径，例如：http://wap.isv.com/notify.asp
$reqHandler->setParameter("notify_url", $notify_url);				

// 设置返回url：用户完成支付后跳转的URL，财付通APP应在此页面上给出提示信息，引导用户完成支付后的操作。
// 财付通APP不应在此页面内做发货等业务操作，避免用户反复刷新页面导致多次触发业务逻辑造成不必要的损失。
// 需给绝对路径，例如：http://wap.isv.com/after_pay.asp，通过该路径直接将支付结果以Get的方式返回
$reqHandler->setParameter("return_url", $return_url);				

// 设置商品名称:商品描述，会显示在财付通支付页面上
$reqHandler->setParameter("body", basReq::val('subject')); //basReq::val('subject')           

// 设置用户客户端ip:用户IP，指用户浏览器端IP，不是财付通APP服务器IP
$reqHandler->setParameter("spbill_create_ip", $_SERVER['REMOTE_ADDR']);
// **********************end*************************

//支付请求的URL
$reqUrl = $reqHandler->getURL();

?>
<html>
<head>
<meta charset="utf-8">
<title>财付通开放平台支付演示</title>
<style type="text/css">.tc { text-align:center; }</style>
</head>
<body>
<p class="tc"><a href="<?php echo $reqUrl ?>" target="_self">去付款</a></p>
</body>
</html>



/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\unotify.php 
*******************************************************************************/
<?php

//---------------------------------------------------------
//支付成功回调接收,财付通后台调用此地址
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayResponse.class.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/NotifyQueryRequest.class.php");

/* 创建支付应答对象 */
$resHandler = new PayResponse($config['key']);

//获取通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
$notifyId = $resHandler->getNotifyId();

$resHandler->acknowledgeSuccess();
$status = 'success';

/* 初始化通知验证请求:财付通APP接收到财付通的支付成功通知后，通过此接口查询订单的详细情况，以确保通知是从财付通发起的，没有被篡改过。 */
// 设置在沙箱中运行:正式环境请设置为false
$noqHandler = new NotifyQueryRequest($key);

// 设置在沙箱中运行，正式环境请设置为false
$noqHandler->setInSandBox($sandbox);
//----------------------------------------
//以下请求业务参数名称参考开放平台sdk文档-PHP
//----------------------------------------
// 设置财付通App-id: 财付通App注册时，由财付通分配
$noqHandler->setAppid($appid);

// 设置通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
$noqHandler->setParameter("notify_id", $notifyId);
// ************************************end*******************************

// 发送请求，并获取返回对象
$Response = $noqHandler->send();

// ********************以下返回业务参数名称参考开放平台sdk文档-PHP*************************
if( $Response->isPayed()){    
	 $status = 'success';
	 exvOpay::notifyTenpay('success');
}else{
	$status = 'fail';
	exvOpay::notifyTenpay('fail');
}

exit($status);

/*
// 创建支付结果反馈响应对象：支付跳转接口为异步返回，用户在财付通完成支付后，财付通通过回调return_url和notify_url向财付通APP反馈支付结果。
$resHandler = new PayResponse($key);

//获取通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
$notifyId = $resHandler->getNotifyId(); 

// 告知财付通通知发送成功，如不加上下行代码会导致财付通不停里通知财付通app，即不停里调用财付通app的notify_url进行通知
$resHandler->acknowledgeSuccess();
// 开始通知验证，具体方法请参考notify_query.php的介绍

exvOpay::notifyDemopay('success');
*/

?>


/*******************************************************************************
 File : \root\a3rd\tenpay_sdk\ureturn.php 
*******************************************************************************/
<?php

//---------------------------------------------------------
//财付通即时到帐支付应答（处理回调）示例，商户按照此文档进行开发即可
//---------------------------------------------------------

require_once(dirname(__FILE__)."/tenpay_config.php");
require_once(DIR_VENDOR."/a3rd/tenpay_class/PayResponse.class.php");

/* 创建支付结果反馈响应对象：支付跳转接口为异步返回，用户在财付通完成支付后，财付通通过回调return_url和notify_url向财付通APP反馈支付结果。 */
$resHandler = new PayResponse($key);

//获取通知id:支付结果通知id，支付成功返回通知id，要获取订单详细情况需用此ID调用通知验证接口。
//echo "<br/>" . "本次支付的通知ID：" . $resHandler->getNotifyId() . "<br/>";

$cfg = array(
	'ordid'=>'out_trade_no',
	'feeamount'=>'total_fee',
	'apino'=>'trade_no',
	'status'=>'trade_status',
);
foreach($cfg as $k1=>$k2){ 
	$res[$k1] = basReq::val($k2);  
}
$res['msg'] = "通知ID：" . $resHandler->getNotifyId() . "";
$res['api'] = 'Tenpay';
$res['stamp'] = date('Y-m-d H:i:s',basReq::val('notify_time'));
require_once(dirname(dirname(__FILE__))."/paydemo_dir/xresult.php");

?>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\download.php 
*******************************************************************************/
<?php
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
//require_once "../lib/WxPay.MicroPay.php";

if(isset($_REQUEST["bill_date"]) && $_REQUEST["bill_date"] != ""){
	$bill_date = $_REQUEST["bill_date"];
    $bill_type = $_REQUEST["bill_type"];
	$input = new WxPayDownloadBill();
	$input->SetBill_date($bill_date);
	$input->SetBill_type($bill_type);
	$file = WxPayApi::downloadBill($input);
	echo $file;
	//TODO 对账单文件处理
    exit(0);
}
?>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>微信支付样例-查退款单</title>
</head>
<body>  
	<form action="#" method="post">
        <div style="margin-left:2%;">对账日期：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="bill_date" /><br /><br />
        <div style="margin-left:2%;">账单类型：</div><br/>
        <select style="width:96%;height:35px;margin-left:2%;" name="bill_type">
		  <option value ="ALL">所有订单信息</option>
		  <option value ="SUCCESS">成功支付的订单</option>
		  <option value="REFUND">退款订单</option>
		  <option value="REVOKED">撤销的订单</option>
		</select><br /><br />
       	<div align="center">
			<input type="submit" value="下载订单" style="width:210px; height:50px; border-radius: 15px;background-color:#FE6714; border:0px #FE6714 solid; cursor: pointer;  color:white;  font-size:16px;" type="button" onclick="callpay()" />
		</div>
	</form>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\jsapi.php 
*******************************************************************************/
<?php 
ini_set('date.timezone','Asia/Shanghai');  
//error_reporting(E_ERROR);
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php"; 
require_once "WxPay.JsApiPay.php";
require_once 'log.php'; 

//初始化日??
$logHandler= new CLogFileHandler("./".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);

//打印输出数组信息
function printf_info($data)
{
    foreach($data as $key=>$value){
        echo "<font color='#00ff55;'>$key</font> : $value <br/>";
    }
}

//①、获取用户openid
$tools = new JsApiPay();
$openId = $tools->GetOpenid();

//②、统一下单
$input = new WxPayUnifiedOrder();
$input->SetBody("test");
$input->SetAttach("test");
$input->SetOut_trade_no(WxPayConfig::MCHID.date("YmdHis"));
$input->SetTotal_fee("1");
$input->SetTime_start(date("YmdHis"));
$input->SetTime_expire(date("YmdHis", time() + 600));
$input->SetGoods_tag("test");
$input->SetNotify_url("http://paysdk.weixin.qq.com/example/notify.php");
$input->SetTrade_type("JSAPI");
$input->SetOpenid($openId);
$order = WxPayApi::unifiedOrder($input);
echo '<font color="#f00"><b>统一下单支付单信??/b></font><br/>';
printf_info($order);
$jsApiParameters = $tools->GetJsApiParameters($order);

//获取共享收货地址js函数参数
$editAddress = $tools->GetEditAddressParameters();
//die($editAddress);

//③、在支持成功回调通知中处理成功之后的事宜，见 notify.php
/**
 * 注意??
 * 1、当你的回调地址不可访问的时候，回调通知会失败，可以通过查询订单来确认支付是否成??
 * 2、jsapi支付时需要填入用户openid，WxPay.JsApiPay.php中有获取openid流程 （文档可以参考微信公众平台“网页授权接口”，
 * 参考http://mp.weixin.qq.com/wiki/17/c0f37d5704f0b64713d5d2c37b468d75.html??
 */
?>

<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/> 
    <title>微信支付样例-支付</title>
    <script type="text/javascript">
	//调用微信JS api 支付
	function jsApiCall()
	{
		WeixinJSBridge.invoke(
			'getBrandWCPayRequest',
			<?php echo $jsApiParameters; ?>,
			function(res){
				WeixinJSBridge.log(res.err_msg);
				alert(res.err_code+res.err_desc+res.err_msg);
			}
		);
	}

	function callpay()
	{
		if (typeof WeixinJSBridge == "undefined"){
		    if( document.addEventListener ){
		        document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
		    }else if (document.attachEvent){
		        document.attachEvent('WeixinJSBridgeReady', jsApiCall); 
		        document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
		    }
		}else{
		    jsApiCall();
		}
	}
	</script>
	<script type="text/javascript">
	//获取共享地址
	function editAddress()
	{
		WeixinJSBridge.invoke(
			'editAddress',
			<?php echo $editAddress; ?>,
			function(res){
				var value1 = res.proviceFirstStageName;
				var value2 = res.addressCitySecondStageName;
				var value3 = res.addressCountiesThirdStageName;
				var value4 = res.addressDetailInfo;
				var tel = res.telNumber;
				
				alert(value1 + value2 + value3 + value4 + ":" + tel);
			}
		);
	}
	
	window.onload = function(){
		if (typeof WeixinJSBridge == "undefined"){
		    if( document.addEventListener ){
		        document.addEventListener('WeixinJSBridgeReady', editAddress, false);
		    }else if (document.attachEvent){
		        document.attachEvent('WeixinJSBridgeReady', editAddress); 
		        document.attachEvent('onWeixinJSBridgeReady', editAddress);
		    }
		}else{
			editAddress();
		}
	};
	
	</script>
</head>
<body>
    <br/>
    <font color="#9ACD32"><b>该笔订单支付金额为<span style="color:#f00;font-size:50px">1分</span>钱</b></font><br/><br/>
	<div align="center">
		<button style="width:210px; height:50px; border-radius: 15px;background-color:#FE6714; border:0px #FE6714 solid; cursor: pointer;  color:white;  font-size:16px;" type="button" onclick="callpay()" >立即支付</button>
	</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\log.php 
*******************************************************************************/
<?php
//以下为日志

interface ILogHandler
{
	public function write($msg);
	
}

class CLogFileHandler implements ILogHandler
{
	private $handle = null;
	
	public function __construct($file = '')
	{
		$file = DIR_DTMP.'/debug/'.str_replace(array('../','./','/',),array('','','_',),$file); // ../logs/2016-04-19.log
		$this->handle = fopen($file,'a');
	}
	
	public function write($msg)
	{
		fwrite($this->handle, $msg, 4096);
	}
	
	public function __destruct()
	{
		fclose($this->handle);
	}
}

class Log
{
	private $handler = null;
	private $level = 15;
	
	private static $instance = null;
	
	private function __construct(){}

	private function __clone(){}
	
	public static function Init($handler = null,$level = 15)
	{
		if(!self::$instance instanceof self)
		{
			self::$instance = new self();
			self::$instance->__setHandle($handler);
			self::$instance->__setLevel($level);
		}
		return self::$instance;
	}
	
	
	private function __setHandle($handler){
		$this->handler = $handler;
	}
	
	private function __setLevel($level)
	{
		$this->level = $level;
	}
	
	public static function DEBUG($msg)
	{
		self::$instance->write(1, $msg);
	}
	
	public static function WARN($msg)
	{
		self::$instance->write(4, $msg);
	}
	
	public static function ERROR($msg)
	{
		$debugInfo = debug_backtrace();
		$stack = "[";
		foreach($debugInfo as $key => $val){
			if(array_key_exists("file", $val)){
				$stack .= ",file:" . $val["file"];
			}
			if(array_key_exists("line", $val)){
				$stack .= ",line:" . $val["line"];
			}
			if(array_key_exists("function", $val)){
				$stack .= ",function:" . $val["function"];
			}
		}
		$stack .= "]";
		self::$instance->write(8, $stack . $msg);
	}
	
	public static function INFO($msg)
	{
		self::$instance->write(2, $msg);
	}
	
	private function getLevelStr($level)
	{
		switch ($level)
		{
		case 1:
			return 'debug';
		break;
		case 2:
			return 'info';	
		break;
		case 4:
			return 'warn';
		break;
		case 8:
			return 'error';
		break;
		default:
				
		}
	}
	
	protected function write($level,$msg)
	{
		if(($level & $this->level) == $level )
		{
			$msg = '['.date('Y-m-d H:i:s').']['.$this->getLevelStr($level).'] '.$msg."\n";
			$this->handler->write($msg);
		}
	}
}



/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\micropay.php 
*******************************************************************************/
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>微信支付样例-查退款单</title>
</head>
<?php
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once "WxPay.MicroPay.php";
require_once 'log.php';

//初始化日志
$logHandler= new CLogFileHandler("../logs/".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);

//打印输出数组信息
function printf_info($data)
{
    foreach($data as $key=>$value){
        echo "<font color='#00ff55;'>$key</font> : $value <br/>";
    }
}

if(isset($_REQUEST["auth_code"]) && $_REQUEST["auth_code"] != ""){
	$auth_code = $_REQUEST["auth_code"];
	$input = new WxPayMicroPay();
	$input->SetAuth_code($auth_code);
	$input->SetBody("刷卡测试样例-支付");
	$input->SetTotal_fee("1");
	$input->SetOut_trade_no(WxPayConfig::MCHID.date("YmdHis"));
	
	$microPay = new MicroPay();
	printf_info($microPay->pay($input));
}

/**
 * 注意：
 * 1、提交被扫之后，返回系统繁忙、用户输入密码等错误信息时需要循环查单以确定是否支付成功
 * 2、多次（一半10次）确认都未明确成功时需要调用撤单接口撤单，防止用户重复支付
 */

?>
<body>  
	<form action="#" method="post">
        <div style="margin-left:2%;">商品描述：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" readonly value="刷卡测试样例-支付" name="auth_code" /><br /><br />
        <div style="margin-left:2%;">支付金额：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" readonly value="1分" name="auth_code" /><br /><br />
        <div style="margin-left:2%;">授权码：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="auth_code" /><br /><br />
       	<div align="center">
			<input type="submit" value="提交刷卡" style="width:210px; height:50px; border-radius: 15px;background-color:#FE6714; border:0px #FE6714 solid; cursor: pointer;  color:white;  font-size:16px;" type="button" onclick="callpay()" />
		</div>
	</form>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\native.php 
*******************************************************************************/
<?php
ini_set('date.timezone','Asia/Shanghai');
//error_reporting(E_ERROR);

require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once "WxPay.NativePay.php";
require_once 'log.php';

//模式一
/**
 * 流程：
 * 1、组装包含支付信息的url，生成二维码
 * 2、用户扫描二维码，进行支付
 * 3、确定支付之后，微信服务器会回调预先配置的回调地址，在【微信开放平台-微信支付-支付配置】中进行配置
 * 4、在接到回调通知之后，用户进行统一下单支付，并返回支付信息以完成支付（见：native_notify.php）
 * 5、支付完成之后，微信服务器会通知支付成功
 * 6、在支付成功通知中需要查单确认是否真正支付成功（见：notify.php）
 */
$notify = new NativePay();
$url1 = $notify->GetPrePayUrl("123456789");

//模式二
/**
 * 流程：
 * 1、调用统一下单，取得code_url，生成二维码
 * 2、用户扫描二维码，进行支付
 * 3、支付完成之后，微信服务器会通知支付成功
 * 4、在支付成功通知中需要查单确认是否真正支付成功（见：notify.php）
 */
$input = new WxPayUnifiedOrder();
$input->SetBody("test");
$input->SetAttach("test");
$input->SetOut_trade_no(WxPayConfig::MCHID.date("YmdHis"));
$input->SetTotal_fee("1");
$input->SetTime_start(date("YmdHis"));
$input->SetTime_expire(date("YmdHis", time() + 600));
$input->SetGoods_tag("test");
$input->SetNotify_url("http://paysdk.weixin.qq.com/example/notify.php");
$input->SetTrade_type("NATIVE");
$input->SetProduct_id("123456789");
$result = $notify->GetPayUrl($input);
$url2 = $result["code_url"];
?>

<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>微信支付样例-退款</title>
</head>
<body>
	<div style="margin-left: 10px;color:#556B2F;font-size:30px;font-weight: bolder;">扫描支付模式一</div><br/>
	<img alt="模式一扫码支付" src="http://paysdk.weixin.qq.com/example/qrcode.php?data=<?php echo urlencode($url1);?>" style="width:150px;height:150px;"/>
	<br/><br/><br/>
	<div style="margin-left: 10px;color:#556B2F;font-size:30px;font-weight: bolder;">扫描支付模式二</div><br/>
	<img alt="模式二扫码支付" src="http://paysdk.weixin.qq.com/example/qrcode.php?data=<?php echo urlencode($url2);?>" style="width:150px;height:150px;"/>
	
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\native_notify.php 
*******************************************************************************/
<?php
ini_set('date.timezone','Asia/Shanghai');
error_reporting(E_ERROR);

require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once LIBS_PAYRUN."/WxPay.Notify.php";
require_once 'log.php';

//初始化日志
$logHandler= new CLogFileHandler("../logs/".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);

class NativeNotifyCallBack extends WxPayNotify
{
	public function unifiedorder($openId, $product_id)
	{
		//统一下单
		$input = new WxPayUnifiedOrder();
		$input->SetBody("test");
		$input->SetAttach("test");
		$input->SetOut_trade_no(WxPayConfig::MCHID.date("YmdHis"));
		$input->SetTotal_fee("1");
		$input->SetTime_start(date("YmdHis"));
		$input->SetTime_expire(date("YmdHis", time() + 600));
		$input->SetGoods_tag("test");
		$input->SetNotify_url("http://paysdk.weixin.qq.com/example/notify.php");
		$input->SetTrade_type("NATIVE");
		$input->SetOpenid($openId);
		$input->SetProduct_id($product_id);
		$result = WxPayApi::unifiedOrder($input);
		Log::DEBUG("unifiedorder:" . json_encode($result));
		return $result;
	}
	
	public function NotifyProcess($data, &$msg)
	{
		//echo "处理回调";
		Log::DEBUG("call back:" . json_encode($data));
		
		if(!array_key_exists("openid", $data) ||
			!array_key_exists("product_id", $data))
		{
			$msg = "回调数据异常";
			return false;
		}
		 
		$openid = $data["openid"];
		$product_id = $data["product_id"];
		
		//统一下单
		$result = $this->unifiedorder($openid, $product_id);
		if(!array_key_exists("appid", $result) ||
			 !array_key_exists("mch_id", $result) ||
			 !array_key_exists("prepay_id", $result))
		{
		 	$msg = "统一下单失败";
		 	return false;
		 }
		
		$this->SetData("appid", $result["appid"]);
		$this->SetData("mch_id", $result["mch_id"]);
		$this->SetData("nonce_str", WxPayApi::getNonceStr());
		$this->SetData("prepay_id", $result["prepay_id"]);
		$this->SetData("result_code", "SUCCESS");
		$this->SetData("err_code_des", "OK");
		return true;
	}
}

Log::DEBUG("begin notify!");
$notify = new NativeNotifyCallBack();
$notify->Handle(true);



/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\notify.php 
*******************************************************************************/
<?php
ini_set('date.timezone','Asia/Shanghai');
error_reporting(E_ERROR);

require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once LIBS_PAYRUN."/WxPay.Notify.php";
require_once 'log.php';

//初始化日志
$logHandler= new CLogFileHandler("../logs/".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);

class PayNotifyCallBack extends WxPayNotify
{
	//查询订单
	public function Queryorder($transaction_id)
	{
		$input = new WxPayOrderQuery();
		$input->SetTransaction_id($transaction_id);
		$result = WxPayApi::orderQuery($input);
		Log::DEBUG("query:" . json_encode($result));
		if(array_key_exists("return_code", $result)
			&& array_key_exists("result_code", $result)
			&& $result["return_code"] == "SUCCESS"
			&& $result["result_code"] == "SUCCESS")
		{
			return true;
		}
		return false;
	}
	
	//重写回调处理函数
	public function NotifyProcess($data, &$msg)
	{
		Log::DEBUG("call back:" . json_encode($data));
		$notfiyOutput = array();
		
		if(!array_key_exists("transaction_id", $data)){
			$msg = "输入参数不正确";
			return false;
		}
		//查询订单，判断订单真实性
		if(!$this->Queryorder($data["transaction_id"])){
			$msg = "订单查询失败";
			return false;
		}
		return true;
	}
}

Log::DEBUG("begin notify");
$notify = new PayNotifyCallBack();
$notify->Handle(false);



/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\orderquery.php 
*******************************************************************************/
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>微信支付样例-订单查询</title>
</head>
<?php
ini_set('date.timezone','Asia/Shanghai');
error_reporting(E_ERROR);
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once 'log.php';

//初始化日志
$logHandler= new CLogFileHandler("./".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);

function printf_info($data)
{
    foreach($data as $key=>$value){
        echo "<font color='#f00;'>$key</font> : $value <br/>";
    }
}


if(isset($_REQUEST["transaction_id"]) && $_REQUEST["transaction_id"] != ""){
	$transaction_id = $_REQUEST["transaction_id"];
	$input = new WxPayOrderQuery();
	$input->SetTransaction_id($transaction_id);
	printf_info(WxPayApi::orderQuery($input));
	exit();
}

if(isset($_REQUEST["out_trade_no"]) && $_REQUEST["out_trade_no"] != ""){
	$out_trade_no = $_REQUEST["out_trade_no"];
	$input = new WxPayOrderQuery();
	$input->SetOut_trade_no($out_trade_no);
	printf_info(WxPayApi::orderQuery($input));
	exit();
}
?>
<body>  
	<form action="#" method="post">
        <div style="margin-left:2%;color:#f00">微信订单号和商户订单号选少填一个，微信订单号优先：</div><br/>
        <div style="margin-left:2%;">微信订单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="transaction_id" /><br /><br />
        <div style="margin-left:2%;">商户订单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="out_trade_no" /><br /><br />
		<div align="center">
			<input type="submit" value="查询" style="width:210px; height:50px; border-radius: 15px;background-color:#FE6714; border:0px #FE6714 solid; cursor: pointer;  color:white;  font-size:16px;" type="button" onclick="callpay()" />
		</div>
	</form>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\qrcode.php 
*******************************************************************************/
<?php
require_once dirname(dirname(__FILE__))."/lib/WxPay.Config.php";
error_reporting(E_ERROR); 
require(DIR_STATIC.'/ilibs/QRcodeBase.cls_php');
$data = $_GET["data"];
$url = urldecode($data);
QRcode::png($url);
//$data = 'weixin://wxpay/bizpayurl?sign=XXXXX&appid=XXXXX&mch_id=XXXXX&product_id=XXXXXX&time_stamp=XXXXXX&nonce_str=XXXXX'; 
//$data = 'weixin://wxpay/bizpayurl?appid=wx2421b1c4370ec43b&mch_id=10000100&nonce_str=f6808210402125e30663234f94c87a8c&product_id=1&time_stamp=1415949957&sign=512F68131DD251DA4A45DA79CC7EFE9D';



/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\refund.php 
*******************************************************************************/
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>微信支付样例-退??/title>
</head>
<?php
ini_set('date.timezone','Asia/Shanghai');
error_reporting(E_ERROR);
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once 'log.php';

//初始化日??
$logHandler= new CLogFileHandler("./".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);

function printf_info($data)
{
    foreach($data as $key=>$value){
        echo "<font color='#f00;'>$key</font> : $value <br/>";
    }
}

if(isset($_REQUEST["transaction_id"]) && $_REQUEST["transaction_id"] != ""){
	$transaction_id = $_REQUEST["transaction_id"];
	$total_fee = $_REQUEST["total_fee"];
	$refund_fee = $_REQUEST["refund_fee"];
	$input = new WxPayRefund();
	$input->SetTransaction_id($transaction_id);
	$input->SetTotal_fee($total_fee);
	$input->SetRefund_fee($refund_fee);
    $input->SetOut_refund_no(WxPayConfig::MCHID.date("YmdHis"));
    $input->SetOp_user_id(WxPayConfig::MCHID);
	printf_info(WxPayApi::refund($input));
	exit();
}

//$_REQUEST["out_trade_no"]= "122531270220150304194108";
///$_REQUEST["total_fee"]= "1";
//$_REQUEST["refund_fee"] = "1";
if(isset($_REQUEST["out_trade_no"]) && $_REQUEST["out_trade_no"] != ""){
	$out_trade_no = $_REQUEST["out_trade_no"];
	$total_fee = $_REQUEST["total_fee"];
	$refund_fee = $_REQUEST["refund_fee"];
	$input = new WxPayRefund();
	$input->SetOut_trade_no($out_trade_no);
	$input->SetTotal_fee($total_fee);
	$input->SetRefund_fee($refund_fee);
    $input->SetOut_refund_no(WxPayConfig::MCHID.date("YmdHis"));
    $input->SetOp_user_id(WxPayConfig::MCHID);
	printf_info(WxPayApi::refund($input));
	exit();
}
?>
<body>  
	<form action="#" method="post">
        <div style="margin-left:2%;color:#f00">微信订单号和商户订单号选少填一个，微信订单号优先：</div><br/>
        <div style="margin-left:2%;">微信订单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="transaction_id" /><br /><br />
        <div style="margin-left:2%;">商户订单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="out_trade_no" /><br /><br />
        <div style="margin-left:2%;">订单总金??????/div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="total_fee" /><br /><br />
        <div style="margin-left:2%;">退款金??????/div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="refund_fee" /><br /><br />
		<div align="center">
			<input type="submit" value="提交退?? style="width:210px; height:50px; border-radius: 15px;background-color:#FE6714; border:0px #FE6714 solid; cursor: pointer;  color:white;  font-size:16px;" onclick="callpay()" />
		</div>
	</form>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\refundquery.php 
*******************************************************************************/
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>微信支付样例-查退款单</title>
</head>
<?php
ini_set('date.timezone','Asia/Shanghai');
error_reporting(E_ERROR);
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";
require_once 'log.php';

//初始化日??
$logHandler= new CLogFileHandler("./".date('Y-m-d').'.log');
$log = Log::Init($logHandler, 15);


function printf_info($data)
{
    foreach($data as $key=>$value){
        echo "<font color='#f00;'>$key</font> : $value <br/>";
    }
}

if(isset($_REQUEST["transaction_id"]) && $_REQUEST["transaction_id"] != ""){
	$transaction_id = $_REQUEST["transaction_id"];
	$input = new WxPayRefundQuery();
	$input->SetTransaction_id($transaction_id);
	printf_info(WxPayApi::refundQuery($input));
}

if(isset($_REQUEST["out_trade_no"]) && $_REQUEST["out_trade_no"] != ""){
	$out_trade_no = $_REQUEST["out_trade_no"];
	$input = new WxPayRefundQuery();
	$input->SetOut_trade_no($out_trade_no);
	printf_info(WxPayApi::refundQuery($input));
	exit();
}

if(isset($_REQUEST["out_refund_no"]) && $_REQUEST["out_refund_no"] != ""){
	$out_refund_no = $_REQUEST["out_refund_no"];
	$input = new WxPayRefundQuery();
	$input->SetOut_refund_no($out_refund_no);
	printf_info(WxPayApi::refundQuery($input));
	exit();
}

if(isset($_REQUEST["refund_id"]) && $_REQUEST["refund_id"] != ""){
	$refund_id = $_REQUEST["refund_id"];
	$input = new WxPayRefundQuery();
	$input->SetRefund_id($refund_id);
	printf_info(WxPayApi::refundQuery($input));
	exit();
}
	
?>
<body>  
	<form action="#" method="post">
        <div style="margin-left:2%;color:#f00">微信订单号、商户订单号、微信订单号、微信退款单号选填至少一个，微信退款单号优先：</div><br/>
        <div style="margin-left:2%;">微信订单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="transaction_id" /><br /><br />
        <div style="margin-left:2%;">商户订单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="out_trade_no" /><br /><br />
        <div style="margin-left:2%;">商户退款单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="out_refund_no" /><br /><br />
        <div style="margin-left:2%;">微信退款单号：</div><br/>
        <input type="text" style="width:96%;height:35px;margin-left:2%;" name="refund_id" /><br /><br />
		<div align="center">
			<input value="查询" style="width:210px; height:50px; border-radius: 15px;background-color:#FE6714; border:0px #FE6714 solid; cursor: pointer;  color:white;  font-size:16px;" type="button" onclick="callpay()" />
		</div>
	</form>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\WxPay.JsApiPay.php 
*******************************************************************************/
<?php
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";

/**
 * 
 * JSAPI支付实现类
 * 该类实现了从微信公众平台获取code、通过code获取openid和access_token、
 * 生成jsapi支付js接口所需的参数、生成获取共享收货地址所需的参数
 * 
 * 该类是微信支付提供的样例程序，商户可根据自己的需求修改，或者使用lib中的api自行开发
 * 
 * @author widy
 *
 */
class JsApiPay
{
	/**
	 * 
	 * 网页授权接口微信服务器返回的数据，返回样例如下
	 * {
	 *  "access_token":"ACCESS_TOKEN",
	 *  "expires_in":7200,
	 *  "refresh_token":"REFRESH_TOKEN",
	 *  "openid":"OPENID",
	 *  "scope":"SCOPE",
	 *  "unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL"
	 * }
	 * 其中access_token可用于获取共享收货地址
	 * openid是微信支付jsapi支付接口必须的参数
	 * @var array
	 */
	public $data = null;
	
	/**
	 * 
	 * 通过跳转获取用户的openid，跳转流程如下：
	 * 1、设置自己需要调回的url及其其他参数，跳转到微信服务器https://open.weixin.qq.com/connect/oauth2/authorize
	 * 2、微信服务处理完成之后会跳转回用户redirect_uri地址，此时会带上一些参数，如：code
	 * 
	 * @return 用户的openid
	 */
	public function GetOpenid()
	{
		//通过code获得openid
		if (!isset($_GET['code'])){
			//触发微信返回code码
			$baseUrl = urlencode('http://'.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'].$_SERVER['QUERY_STRING']);
			$url = $this->__CreateOauthUrlForCode($baseUrl);
			Header("Location: $url");
			exit();
		} else {
			//获取code码，以获取openid
		    $code = $_GET['code'];
			$openid = $this->getOpenidFromMp($code);
			return $openid;
		}
	}
	
	/**
	 * 
	 * 获取jsapi支付的参数
	 * @param array $UnifiedOrderResult 统一支付接口返回的数据
	 * @throws WxPayException
	 * 
	 * @return json数据，可直接填入js函数作为参数
	 */
	public function GetJsApiParameters($UnifiedOrderResult)
	{
		if(!array_key_exists("appid", $UnifiedOrderResult)
		|| !array_key_exists("prepay_id", $UnifiedOrderResult)
		|| $UnifiedOrderResult['prepay_id'] == "")
		{
			throw new WxPayException("参数错误");
		}
		$jsapi = new WxPayJsApiPay();
		$jsapi->SetAppid($UnifiedOrderResult["appid"]);
		$timeStamp = time();
		$jsapi->SetTimeStamp("$timeStamp");
		$jsapi->SetNonceStr(WxPayApi::getNonceStr());
		$jsapi->SetPackage("prepay_id=" . $UnifiedOrderResult['prepay_id']);
		$jsapi->SetSignType("MD5");
		$jsapi->SetPaySign($jsapi->MakeSign());
		$parameters = json_encode($jsapi->GetValues());
		return $parameters;
	}
	
	/**
	 * 
	 * 通过code从工作平台获取openid机器access_token
	 * @param string $code 微信跳转回来带上的code
	 * 
	 * @return openid
	 */
	public function GetOpenidFromMp($code)
	{
		$url = $this->__CreateOauthUrlForOpenid($code);
		//初始化curl
		$ch = curl_init();
		//设置超时
		curl_setopt($ch, CURLOPT_TIMEOUT, $this->curl_timeout);
		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER,FALSE);
		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST,FALSE);
		curl_setopt($ch, CURLOPT_HEADER, FALSE);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
		if(WxPayConfig::CURL_PROXY_HOST != "0.0.0.0" 
			&& WxPayConfig::CURL_PROXY_PORT != 0){
			curl_setopt($ch,CURLOPT_PROXY, WxPayConfig::CURL_PROXY_HOST);
			curl_setopt($ch,CURLOPT_PROXYPORT, WxPayConfig::CURL_PROXY_PORT);
		}
		//运行curl，结果以jason形式返回
		$res = curl_exec($ch);
		curl_close($ch);
		//取出openid
		$data = json_decode($res,true);
		$this->data = $data;
		$openid = $data['openid'];
		return $openid;
	}
	
	/**
	 * 
	 * 拼接签名字符串
	 * @param array $urlObj
	 * 
	 * @return 返回已经拼接好的字符串
	 */
	private function ToUrlParams($urlObj)
	{
		$buff = "";
		foreach ($urlObj as $k => $v)
		{
			if($k != "sign"){
				$buff .= $k . "=" . $v . "&";
			}
		}
		
		$buff = trim($buff, "&");
		return $buff;
	}
	
	/**
	 * 
	 * 获取地址js参数
	 * 
	 * @return 获取共享收货地址js函数需要的参数，json格式可以直接做参数使用
	 */
	public function GetEditAddressParameters()
	{	
		$getData = $this->data;
		$data = array();
		$data["appid"] = WxPayConfig::APPID;
		$data["url"] = "http://".$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
		$time = time();
		$data["timestamp"] = "$time";
		$data["noncestr"] = "1234568";
		$data["accesstoken"] = $getData["access_token"];
		ksort($data);
		$params = $this->ToUrlParams($data);
		$addrSign = sha1($params);
		
		$afterData = array(
			"addrSign" => $addrSign,
			"signType" => "sha1",
			"scope" => "jsapi_address",
			"appId" => WxPayConfig::APPID,
			"timeStamp" => $data["timestamp"],
			"nonceStr" => $data["noncestr"]
		);
		$parameters = json_encode($afterData);
		return $parameters;
	}
	
	/**
	 * 
	 * 构造获取code的url连接
	 * @param string $redirectUrl 微信服务器回跳的url，需要url编码
	 * 
	 * @return 返回构造好的url
	 */
	private function __CreateOauthUrlForCode($redirectUrl)
	{
		$urlObj["appid"] = WxPayConfig::APPID;
		$urlObj["redirect_uri"] = "$redirectUrl";
		$urlObj["response_type"] = "code";
		$urlObj["scope"] = "snsapi_base";
		$urlObj["state"] = "STATE"."#wechat_redirect";
		$bizString = $this->ToUrlParams($urlObj);
		return "https://open.weixin.qq.com/connect/oauth2/authorize?".$bizString;
	}
	
	/**
	 * 
	 * 构造获取open和access_toke的url地址
	 * @param string $code，微信跳转带回的code
	 * 
	 * @return 请求的url
	 */
	private function __CreateOauthUrlForOpenid($code)
	{
		$urlObj["appid"] = WxPayConfig::APPID;
		$urlObj["secret"] = WxPayConfig::APPSECRET;
		$urlObj["code"] = $code;
		$urlObj["grant_type"] = "authorization_code";
		$bizString = $this->ToUrlParams($urlObj);
		return "https://api.weixin.qq.com/sns/oauth2/access_token?".$bizString;
	}
}


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\WxPay.MicroPay.php 
*******************************************************************************/
<?php
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";

/**
 * 
 * 刷卡支付实现类
 * 该类实现了一个刷卡支付的流程，流程如下：
 * 1、提交刷卡支付
 * 2、根据返回结果决定是否需要查询订单，如果查询之后订单还未变则需要返回查询（一般反复查10次）
 * 3、如果反复查询10订单依然不变，则发起撤销订单
 * 4、撤销订单需要循环撤销，一直撤销成功为止（注意循环次数，建议10次）
 * 
 * 该类是微信支付提供的样例程序，商户可根据自己的需求修改，或者使用lib中的api自行开发，为了防止
 * 查询时hold住后台php进程，商户查询和撤销逻辑可在前端调用
 * 
 * @author widy
 *
 */
class MicroPay
{
	/**
	 * 
	 * 提交刷卡支付，并且确认结果，接口比较慢
	 * @param WxPayMicroPay $microPayInput
	 * @throws WxpayException
	 * @return 返回查询接口的结果
	 */
	public function pay($microPayInput)
	{
		//①、提交被扫支付
		$result = WxPayApi::micropay($microPayInput, 5);
		//如果返回成功
		if(!array_key_exists("return_code", $result)
			|| !array_key_exists("out_trade_no", $result)
			|| !array_key_exists("result_code", $result))
		{
			echo "接口调用失败,请确认是否输入是否有误！";
			throw new WxPayException("接口调用失败！");
		}
		
		//签名验证
		$out_trade_no = $microPayInput->GetOut_trade_no();
		
		//②、接口调用成功，明确返回调用失败
		if($result["return_code"] == "SUCCESS" &&
		   $result["result_code"] == "FAIL" && 
		   $result["err_code"] != "USERPAYING" && 
		   $result["err_code"] != "SYSTEMERROR")
		{
			return false;
		}

		//③、确认支付是否成功
		$queryTimes = 10;
		while($queryTimes > 0)
		{
			$succResult = 0;
			$queryResult = $this->query($out_trade_no, $succResult);
			//如果需要等待1s后继续
			if($succResult == 2){
				sleep(2);
				continue;
			} else if($succResult == 1){//查询成功
				return $queryResult;
			} else {//订单交易失败
				return false;
			}
		}
		
		//④、次确认失败，则撤销订单
		if(!$this->cancel($out_trade_no))
		{
			throw new WxpayException("撤销单失败！");
		}

		return false;
	}
	
	/**
	 * 
	 * 查询订单情况
	 * @param string $out_trade_no  商户订单号
	 * @param int $succCode         查询订单结果
	 * @return 0 订单不成功，1表示订单成功，2表示继续等待
	 */
	public function query($out_trade_no, &$succCode)
	{
		$queryOrderInput = new WxPayOrderQuery();
		$queryOrderInput->SetOut_trade_no($out_trade_no);
		$result = WxPayApi::orderQuery($queryOrderInput);
		
		if($result["return_code"] == "SUCCESS" 
			&& $result["result_code"] == "SUCCESS")
		{
			//支付成功
			if($result["trade_state"] == "SUCCESS"){
				$succCode = 1;
			   	return $result;
			}
			//用户支付中
			else if($result["trade_state"] == "USERPAYING"){
				$succCode = 2;
				return false;
			}
		}
		
		//如果返回错误码为“此交易订单号不存在”则直接认定失败
		if($result["err_code"] == "ORDERNOTEXIST")
		{
			$succCode = 0;
		} else{
			//如果是系统错误，则后续继续
			$succCode = 2;
		}
		return false;
	}
	
	/**
	 * 
	 * 撤销订单，如果失败会重复调用10次
	 * @param string $out_trade_no
	 * @param 调用深度 $depth
	 */
	public function cancel($out_trade_no, $depth = 0)
	{
		if($depth > 10){
			return false;
		}
		
		$clostOrder = new WxPayReverse();
		$clostOrder->SetOut_trade_no($out_trade_no);
		$result = WxPayApi::reverse($clostOrder);
		
		//接口调用失败
		if($result["return_code"] != "SUCCESS"){
			return false;
		}
		
		//如果结果为success且不需要重新调用撤销，则表示撤销成功
		if($result["result_code"] != "SUCCESS" 
			&& $result["recall"] == "N"){
			return true;
		} else if($result["recall"] == "Y") {
			return $this->cancel($out_trade_no, ++$depth);
		}
		return false;
	}
}


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo\WxPay.NativePay.php 
*******************************************************************************/
<?php
require_once dirname(dirname(__FILE__))."/lib/WxPay.Api.php";

/**
 * 
 * 刷卡支付实现类
 * @author widyhu
 *
 */
class NativePay
{
	/**
	 * 
	 * 生成扫描支付URL,模式一
	 * @param BizPayUrlInput $bizUrlInfo
	 */
	public function GetPrePayUrl($productId)
	{
		$biz = new WxPayBizPayUrl();
		$biz->SetProduct_id($productId);
		$values = WxpayApi::bizpayurl($biz);
		$url = "weixin://wxpay/bizpayurl?" . $this->ToUrlParams($values);
		return $url;
	}
	
	/**
	 * 
	 * 参数数组转换为url参数
	 * @param array $urlObj
	 */
	private function ToUrlParams($urlObj)
	{
		$buff = "";
		foreach ($urlObj as $k => $v)
		{
			$buff .= $k . "=" . $v . "&";
		}
		
		$buff = trim($buff, "&");
		return $buff;
	}
	
	/**
	 * 
	 * 生成直接支付url，支付url有效期为2小时,模式二
	 * @param UnifiedOrderInput $input
	 */
	public function GetPayUrl($input)
	{
		if($input->GetTrade_type() == "NATIVE")
		{
			$result = WxPayApi::unifiedOrder($input);
			return $result;
		}
	}
}


/*******************************************************************************
 File : \root\a3rd\weixin_pay\demo.php 
*******************************************************************************/
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/> 
    <title>微信支付样例</title>
    <style type="text/css">
        ul {
            margin-left:10px;
            margin-right:10px;
            margin-top:10px;
            padding: 0;
        }
        li {
            width: 32%;
            float: left;
            margin: 0px;
            margin-left:1%;
            padding: 0px;
            height: 100px;
            display: inline;
            line-height: 100px;
            color: #fff;
            font-size: x-large;
            word-break:break-all;
            word-wrap : break-word;
            margin-bottom: 5px;
        }
        a {
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        	text-decoration:none;
            color:#fff;
        }
        a:link{
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        	text-decoration:none;
            color:#fff;
        }
        a:visited{
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        	text-decoration:none;
            color:#fff;
        }
        a:hover{
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        	text-decoration:none;
            color:#fff;
        }
        a:active{
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        	text-decoration:none;
            color:#fff;
        }
    </style>
</head>
<body>
	<div align="center">
        <ul>
            <li style="background-color:#FF7F24"><a href="./demo/jsapi.php">JSAPI支付</a></li>
            <li style="background-color:#698B22"><a href="./demo/micropay.php">刷卡支付</a></li>
            <li style="background-color:#8B6914"><a href="./demo/native.php">扫码支付</a></li>
            <li style="background-color:#CDCD00"><a href="./demo/orderquery.php">订单查询</a></li>
            <li style="background-color:#CD3278"><a href="./demo/refund.php">订单退款</a></li>
            <li style="background-color:#848484"><a href="./demo/refundquery.php">退款查询</a></li>
            <li style="background-color:#8EE5EE"><a href="./demo/download.php">下载订单</a></li>
        </ul>
	</div>
</body>
</html>


/*******************************************************************************
 File : \root\a3rd\weixin_pay\doc\README 
*******************************************************************************/
SDK
体验地址
http://paysdk.weixin.qq.com/

快速搭建指南
①、安装配置nginx+phpfpm+php
②、建SDK解压到网站根目录
③、修改lib/WxPay.Config.php为自己申请的商户号的信息（配置详见说明）
⑤、下载证书替换cert下的文件
⑥、搭建完成

SDK目录结构
|-- cert
|   |-- apiclient_cert.pem
|   `-- apiclient_key.pem
|-- index.php
|-- lib
|   |-- WxPay.Api.php
|   |-- WxPay.Config.php
|   |-- WxPay.Data.php
|   |-- WxPay.Exception.php
|   `-- WxPay.Notify.php
|-- logs
|   |-- 2015-03-06.log
|   `-- 2015-03-11.log
`-- example
    |-- WxPay.JsApiPay.php
    |-- WxPay.MicroPay.php
    |-- WxPay.NativePay.php
	|-- download.php
	|-- micropay.php
	|-- native.php
	|-- native_notify.php
	|-- notify.php
	|-- orderquery.php
	|-- qrcode.php
	|-- refund.php
	|-- refundquery.php
	|-- jsapi.php
    |-- log.php
    `-- phpqrcode

目录功能简介
lib
API接口封装代码
WxPay.Api.php 包括所有微信支付API接口的封装
WxPay.Config.php  商户配置
WxPay.Data.php   输入参数封装
WxPay.Exception.php  异常类
WxPay.Notify.php    回调通知基类

cert
证书存放路径，证书可以登录商户平台https://pay.weixin.qq.com/index.php/account/api_cert下载

example
样例程序代码路径

example/phpqrcode
开源二维码php代码

logs
日志文件

※配置指南
MCHID = '1225312702';
这里填开户邮件中的商户号

APPID = 'wx426b3015555a46be';
这里填开户邮件中的（公众账号APPID或者应用APPID）

KEY = 'e10adc3949ba59abbe56e057f20f883e'
这里请使用商户平台登录账户和密码登录http://pay.weixin.qq.com 平台设置的“API密钥”，为了安全，请设置为32字符串。

APPSECRET = '01c6d59a3f9024db6336662ac95c8e74'
改参数在JSAPI支付（open平台账户不能进行JSAPI支付）的时候需要用来获取用户openid，可使用APPID对应的公众平台登录http://mp.weixin.qq.com 的开发者中心获取AppSecret。




/*******************************************************************************
 File : \root\a3rd\weixin_pay\lib\WxPay.Api.php 
*******************************************************************************/
<?php
require_once dirname(__FILE__)."/WxPay.Config.php";
require_once LIBS_PAYRUN."/WxPay.Exception.php";
require_once LIBS_PAYRUN."/WxPay.Data.php";

require_once LIBS_PAYRUN."/WxPay.Api.php";



/*******************************************************************************
 File : \root\a3rd\weixin_pay\lib\WxPay.Config.php 
*******************************************************************************/
<?php 
require(dirname(dirname(dirname(__FILE__))).'/a3rd_cfgs.php'); 
define('DIR_PAYRUN', dirname(dirname(__FILE__))); 
define('PATH_PAYRUN', PATH_ROOT.'/a3rd/weixin_pay');
define('LIBS_PAYRUN', DIR_VENDOR.'/a3rd/weixinpay_lib');
/**
* 	配置账号信息
*/

class WxPayConfig
{
	//=======【基本信息设置】=====================================
	//
	/**
	 * TODO: 修改这里配置为您自己申请的商户信息
	 * 微信公众号信息配置
	 * 
	 * APPID：绑定支付的APPID（必须配置，开户邮件中可查看）
	 * 
	 * MCHID：商户号（必须配置，开户邮件中可查看）
	 * 
	 * KEY：商户支付密钥，参考开户邮件设置（必须配置，登录商户平台自行设置）
	 * 设置地址：https://pay.weixin.qq.com/index.php/account/api_cert
	 * 
	 * APPSECRET：公众帐号secert（仅JSAPI支付的时候需要配置， 登录公众平台，进入开发者中心可设置），
	 * 获取地址：https://mp.weixin.qq.com/advanced/advanced?action=dev&t=advanced/dev&token=2005451881&lang=zh_CN
	 * @var string
	 */
	const APPID = 'wx426b3015555a46be';
	const MCHID = '1225312702';
	const KEY = 'e10adc3949ba59abbe56e057f20f883e';
	const APPSECRET = '01c6d59a3f9024db6336662ac95c8e74';
	
	//=======【证书路径设置】=====================================
	/**
	 * TODO：设置商户证书路径
	 * 证书路径,注意应该填写绝对路径（仅退款、撤销订单时需要，可登录商户平台下载，
	 * API证书下载地址：https://pay.weixin.qq.com/index.php/account/api_cert，下载之前需要安装商户操作证书）
	 * @var path
	 */
	const SSLCERT_PATH = '../cert/apiclient_cert.pem';
	const SSLKEY_PATH = '../cert/apiclient_key.pem';
	
	//=======【curl代理设置】===================================
	/**
	 * TODO：这里设置代理机器，只有需要代理的时候才设置，不需要代理，请设置为0.0.0.0和0
	 * 本例程通过curl使用HTTP POST方法，此处可修改代理服务器，
	 * 默认CURL_PROXY_HOST=0.0.0.0和CURL_PROXY_PORT=0，此时不开启代理（如有需要才设置）
	 * @var unknown_type
	 */
	const CURL_PROXY_HOST = "0.0.0.0";//"10.152.18.220";
	const CURL_PROXY_PORT = 0;//8080;
	
	//=======【上报信息配置】===================================
	/**
	 * TODO：接口调用上报等级，默认紧错误上报（注意：上报超时间为【1s】，上报无论成败【永不抛出异常】，
	 * 不会影响接口调用流程），开启上报之后，方便微信监控请求调用的质量，建议至少
	 * 开启错误上报。
	 * 上报等级，0.关闭上报; 1.仅错误出错上报; 2.全量上报
	 * @var int
	 */
	const REPORT_LEVENL = 1;
}



/*******************************************************************************
 File : \root\a3rd\weixin_pay\wedebug.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/we_cfgs.php');

$act = basReq::val('act','main'); 
$kid = basReq::val('kid','admin');
$debug = basReq::arr('debug','Html');

$dcfg = array('api','appid','token','appsecret','orgid','openid');
$wecfg = wysBasic::getConfig($kid); 

if(@$debug['type']=='qrGet'){ //cookie-header问题,放在echo输出前
	$wxqr = new wysQrcode($wecfg); 
}

glbHtml::page("微信接口调试");
glbHtml::page('imadm');
echo basJscss::imp("/skin/a_jscss/weixin.js"); //glbHtml::page('imps');
glbHtml::page('body',' style="margin:20px;"');
wxDebugNavbar();

//$u = usrBase::userObj(); print_r($u);

foreach($dcfg as $k){
	$$k = empty($debug[$k]) ? (empty($wecfg[$k]) ? '' : $wecfg[$k]) : $debug[$k];
}
$api || $api = $_cbase['run']['roots']."/plus/api/wechat.php?kid=$kid";
$orgid || $orgid = 'gh_'.basKeyid::kidRand(24,12);
$openid || $openid = 'open_'.basKeyid::kidRand(24,24);
$debug['type'] = empty($debug['type']) ? 'Location' : $debug['type'];

if($act=='main'){

	glbHtml::fmt_head('fmlist',"?kid=$kid",'tbdata');
	glbHtml::fmae_row('接口地址',"<input name='debug[api]' type='text' value='$api' class='txt w650' />");
	glbHtml::fmae_row('AppId',"<input name='debug[appid]' type='text' value='$appid' class='txt w650' />");
	glbHtml::fmae_row('AppSecret',"<input name='debug[appsecret]' type='text' value='$appsecret' class='txt w650' />");
	glbHtml::fmae_row('Token',"<input name='debug[token]' type='text' value='$token' class='txt w650' />");
	
	$acta = array(	
		'Signurl'=>'测试接入', //(取消关注) ($wecfg=array())
		'Subscribe'=>'关注', //(取消关注)
		'Send'=>'发信息',
		'qrGet'=>'获取二维码',
		'qrPush'=>'推送二维码',
		'Click'=>'Click相关',
		'Location'=>'地理位置', // 113.740003,23.008843,17   23.018224, 113.760718 (x:0.03, 0.01)
		'oaLink'=>'授权链接(会员中心)',
		'Spic'=>'发图片(传图使用)',
	);
	$acts = '';  
	foreach($acta as $k=>$v){
		if($k=='oaLink') $acts .= "<br>";
		$acts .= "<label><input class=\"radio\" type=\"radio\" name=\"debug[type]\" value=\"$k\" onclick=\"wxSetDebugType('$k')\"".(@$debug['type'] == $k ? ' checked="checked"' : '').">$v</label> &nbsp; ";
	}
	$long = 113.700003+mt_rand(10000,60000)/1000000; 
	$lati = 22.9951234+mt_rand(1000,18000)/1000000; 
	
	glbHtml::fmae_row('调试类型',"$acts");
	
	glbHtml::fmae_row('<!--,Sub,qrP,Cli,-->事件Key',"<input name='debug[key]' type='text' value='".(empty($debug['key']) ? 'KEY_'.strtoupper(basKeyid::kidRand(24,6)) : $debug['key'])."' class='txt w240' /><br>1.关注一般不需要KEY,扫描带参数二维码事件KEY类似:qrscene_123123; <br>2.点菜单事件请填写菜单中对应Click的KEY（Mylocal,Txworks,Cnarea）; <br>3. 推送二维码请填写二维码的场景值;");
	glbHtml::fmae_row('<!--,qrG,-->事件Key',"<input name='debug[qrmod]' type='text' value='".(empty($debug['qrmod']) ? 'login' : $debug['qrmod'])."' class='txt w240' /><br>如：login, getpw, send, upload 等系统能处理的扫描[模块];");
	glbHtml::fmae_row('<!--,qrG,-->附加参数',"<input name='debug[extp]' type='text' value='".(empty($debug['extp']) ? date('H').'_'.date('mdis') : $debug['extp'])."' class='txt w240' /><br>如：cargo.2015-97-dad1, company.2015-7p-hhw1, govern.2015-6x-f401 等系统能处理的扫描[模块];");
	glbHtml::fmae_row('<!--,Sen,-->信息内容',"<textarea name='debug[detial]' rows='8' cols='60' wrap='off' class='txt w560'>你好！微信测试！".date('Y-m-d H:i:s')."</textarea><br>eg：产品, 新闻, zx, hn, gd");
	glbHtml::fmae_row('<!--,Loc,-->Precision',"<input name='debug[prec]' type='text' value='".(mt_rand(500000,3000000)/10000)."' />");
	glbHtml::fmae_row('<!--,Loc,-->坐标位置',"<input id='debug[sitemap]' name='debug[sitemap]' type='text' value='$lati,$long,10' class='txt'  maxlength='48'  style='width:240px'; /><span class='fldicon fmap' onClick=\"mapPick('baidu','debug[sitemap]');\">&nbsp;</span>");
	glbHtml::fmae_row('<!--,Loc,-->自动/主动',"<input name='debug[loctype]' type='text' value='".(empty($debug['loctype']) ? 'auto' : $debug['loctype'])."' class='txt w240' />auto/send");
	glbHtml::fmae_row('<!--,Spi,-->PicUrl',"<input name='debug[PicUrl]' type='text' value='".@$debug['PicUrl']."' class='txt w650' />");
	glbHtml::fmae_row('<!--,Spi,-->MediaId',"<input name='debug[MediaId]' type='text' value='".@$debug['MediaId']."' class='txt w650' />");
	
	glbHtml::fmae_row('OrgID',"<input name='debug[orgid]' type='text' value='".@$orgid."' class='txt w650' />");
	glbHtml::fmae_row('OpenID',"<input name='debug[openid]' type='text' value='".@$openid."' class='txt w650' />");
	glbHtml::fmae_row('提交'," &nbsp; <input name='bsend' type='submit' class='btn w240' value=' ------ 提交 ------ ' /> 
	  &nbsp; <a href='?kid=$kid'>(刷新)</a> # <a href='?kid=$kid&act=tmptest'>(tmptest)</a>");

	glbHtml::fmt_end();
	echo "\r\n<script type='text/javascript'>wxSetDebugType('{$debug['type']}',1);</script>";
	
	echo "<hr><p>调试结果：</p><pre>"; //print_r($debug);
	
	if(!empty($bsend)){
		$data = "<ToUserName><![CDATA[$orgid]]></ToUserName>";
		$data .= "<FromUserName><![CDATA[$openid]]></FromUserName>";
		$data .= "<CreateTime>".time()."</CreateTime>";
		if($debug['type']=='Signurl'){
			$debug['token'] = $token; //保证token一致...
			$signurl = wysTester::getSignurl($debug, $api);
			echo "\n<br>接入链接: <a href='$signurl' target='_blank'>".basStr::cutWidth($signurl,56)."".substr($signurl,-12,12)."</a>";
			echo "\n<br>接入Url: $signurl";
		}
		if($debug['type']=='Subscribe'){
			$data .= "<MsgType><![CDATA[event]]></MsgType>";
			$data .= "<Event><![CDATA[".strtolower($debug['type'])."]]></Event>";
			if($debug['key'] && strstr($debug['key'],'qrscene_')){
				$data .= "<EventKey><![CDATA[{$debug['key']}]]></EventKey>";
			}
		}
		if($debug['type']=='Send'){
			$data .= "<MsgType><![CDATA[text]]></MsgType>";
			$detial = $debug['detial'];
			$data .= "<Content><![CDATA[$detial]]></Content>";
		}
		if($debug['type']=='qrGet'){
			//$wxqr = new wysQrcode($wecfg); 
			$tmp = $wxqr->getQrcode($debug['qrmod'], 'limit', $debug['extp']); 
			echo "\n<br>场景ID: {$tmp['sid']} ; ticket: {$tmp['ticket']} ";
			echo "\n<br>二维码Url: {$tmp['url']}"; 
			echo "\n<br>二维码链接: <a href='{$tmp['url']}' target='_blank'><img src='{$tmp['url']}' width='230'></a>";
		}
		if($debug['type']=='qrPush'){
			$data .= "<MsgType><![CDATA[event]]></MsgType>";
			$data .= "<Event><![CDATA[SCAN]]></Event>";
			$data .= "<EventKey><![CDATA[".$debug['key']."]]></EventKey>";
			$data .= "<Ticket><![CDATA[Ticket_".basKeyid::kidRand(24,24)."]]></Ticket>";
		}
		if($debug['type']=='Click'){
			$data .= "<MsgType><![CDATA[event]]></MsgType>";
			$data .= "<Event><![CDATA[CLICK]]></Event>";
			$data .= "<EventKey><![CDATA[{$debug['key']}]]></EventKey>";
		}
		if($debug['type']=='Location'){
			$smap = explode(',',$debug['sitemap']); 
			if($debug['loctype']=='send'){
				$data .= "<MsgType><![CDATA[location]]></MsgType>";
				$data .= "<Location_X>".$smap[0]."</Location_X>";
				$data .= "<Location_Y>".$smap[1]."</Location_Y>";
				$data .= "<Scale>".mt_rand(5,15)."</Scale>";
				$data .= "<Label><![CDATA[SomePlace]]></Label>";
				//$data .= "<MsgId>1234567890123456</MsgId>	";
			}else{
				$data .= "<MsgType><![CDATA[event]]></MsgType>";
				$data .= "<Event><![CDATA[LOCATION]]></Event>";
				$data .= "<Latitude>".$smap[0]."</Latitude>";
				$data .= "<Longitude>".$smap[1]."</Longitude>";
				$data .= "<Precision>{$debug['prec']}</Precision>";
			}
		}
		if($debug['type']=='oaLink'){ 
			$url = "{root}/mob.php?mkv=user&oauth=snsapi_base&state=mlogin"; //&_tm=".time()."
			$wem = new wysMenu($wecfg);
			$url = $wem->fmtUrl($url);
			echo "\n<br>授权链接Url: <input name='' type='text' value='{$url}' style='width:100%'>"; 
			echo "\n<br>Html链接: <a href='{$url}' target='_blank'>Html链接</a> 点这里不能打开，请复制到手机打开。";
		}
		if($debug['type']=='Spic'){ 
			$data .= "<MsgType><![CDATA[image]]></MsgType>";
			$data .= "<PicUrl><![CDATA[$debug[PicUrl]]]></PicUrl>";
			$data .= "<MediaId><![CDATA[$debug[MediaId]]]></MediaId>";

		}
		
		$data = "<xml>$data</xml>";
		if(in_array($debug['type'],array('Subscribe','Send','qrPush','Click','Location','Spic',))){
			$dstr = wysTester::showInfo($data); 
			echo "提交的数据：<pre>$dstr";
			$data = comHttp::doPost($api, $data, 3);
			echo "<hr>返回的结果：";
			echo empty($data) ? 'NULL' : wysTester::showInfo($data);
			//echo "提示：由于xml中的文字为utf8，如果系统为gbk版，则显示的xml中有乱码算正常现象";
			echo "</pre>";
		}
			
	}
	
	/*


	echo "</td><tr>\n</table>";
	*/


}elseif($act=='tmptest'){
	
	$user['nickname'] = "和平鸽(peace)-测his--223"; //xieys,和平鸽(peace)-测his--223
	$res = wysUser::fmtUserName($user);
	echo ("<br>".$res);
	
	#$unow = usrBase::userObj(); 
	$res = usrMember::addUser('person',$res.date('Hms'),'ssss232333232',$user['nickname']);
	echo "<pre>"; print_r($res);
	
	/*
	#$res = wysUser::addUser("openid_$res",$res,'ssss232333232',$user['nickname'],'person'); 
	#echo "<pre>"; print_r($res);
	
	$res = wysUser::bindUser("openid_$res",'hepinggep_qv8','ssss232333232');
	echo "<pre>"; print_r($res); */
	
	#$res = wysUser::resetPwd("openid_$res",44334,'openid_hepinggepeacece');
	#echo "<pre>"; print_r($res); 
	
	#$res = usrBase::setLogin('m','hepinggep_qv8');
	#echo "<pre>"; print_r($res); 
	
	echo "<br>".dechex(6677);
	echo "<br>".dechex(7173);
	echo "<br>".dechex(13780);
	echo "<br>";
	
	//hepinggep_qv8,[password] => 
	
	
	die('dd');
	
	/*
	$wecfg = wysBasic::getConfig(); 
	//$url = "https://api.weixin.qq.com/cgi-bin/media/get?access_token=%&media_id=%";
	//$url = sprintf($url, $wecfg['actoken'], '6174967231493613929');
	$url = "http://mp.weixin.qq.com/debug/zh_CN/htmledition/images/bg/bg_logo1f2fc8.pngx";
	$url = "http://mmbiz.qpic.cn/mmbiz/kCd8LZdoPibUpCj1IhZLdtNmGTHI8UN6etJATibgCJxTQhTo0ZOBkc5AslmQbC4u7AbtgqUyYIU3xvLTqDyIAgtw/0";
	$media = _08_Http_Request::getResources($url); var_dump($media);
	comFiles::put("./aaa.jpg", $media); die($media);
	return $qrcode;
	//*/

	$openid = 'oyDK8vjjcn3cFbxMLaMBhKEsYbCk';
	$mname08 = 'jp000';
	$password = 'jp000';
	$mchid = 1;
	
	$re = wysUser::bindUser($openid,$mname08,$password);
	print_r($re);
	die();

	$re = wysUser::addUser($openid,$mname08,$password,$mchid);
	print_r($re);
	die();

	$wecfg = wysBasic::getConfig('wx3b915d8db305b742','appid'); //
	
	$wem = new wmpMenu($wecfg);
	$re = $wem->menuGet();
	echo $re.'<pre>';
	print_r($re);
	echo $re.'<br>';
	
	// snsapi_base, snsapi_userinfo
	$url = "{mobileurl}wxlogin.php?test=3&oauth=snsapi_base&state=getpw";
	$wem = new wysMenuBase($wecfg);
	$url = $wem->fmtUrl($url);
	echo $url.'<br>';

	echo ucfirst('abc').'<br>';
	echo ucfirst('ABC').'<br>';
	echo ucfirst('AbC').'<br>';
	$wxqr = new wysQrcode($wecfg);
	//echo wysEventBase::getSceneID('login', 'test');
	$tmp = $wxqr->getQrcode('sendaid_7654321', 'temp', 'test'); print_r($tmp); echo "\n<br>\n";
	$lmt = $wxqr->getQrcode('login', 'limit', 'test'); print_r($lmt);
	
	//93964	 	login	 	好好2	gQEM8DoAAAAAAAAAASxodHRwOi8vd2VpeGluLnFxLmNvbS9xL0dVV1ViRWJsVWpzcmIxckRqV2tNAAIENqUtVgMEAAAAAA==
	$wx2 = new wmpQrcode($wecfg); echo "<pre>";
	$lmt = $wx2->qrcodeTicket(93964, 'fnum'); print_r($lmt); 
	$lmt = $wx2->qrcodeTicket(19927, 'fnum'); print_r($lmt);
	//qrcodeTicket($sid,$type='temp',$exp=86400)
	

}elseif($act=='xxx'){
	
/*	
[User Message]=</b>(_08_M_Weixin_Event::Scan-27a
[ToUserName]=(gh_a94178b33562)
[FromUserName]=(oA1n9tl_fnXi8ouleydL0hkvVBwI)
[CreateTime]=(1437721595)
[MsgType]=(image)
[PicUrl]=(http://mmbiz.qpic.cn/mmbiz/kCd8LZdoPibUpCj1IhZLdtNmGTHI8UN6etJATibgCJxTQhTo0ZOBkc5AslmQbC4u7AbtgqUyYIU3xvLTqDyIAgtw/0)
[MsgId]=(6174967231493613929)
[MediaId]=(fp60ATiIUa80QCr73PZsDfPFw2khbpf641m_d62g19aqwhvLPx_FjNQNWa9OKZyw)
*/

}elseif($act=='xxx'){

	
}elseif($act=='xxx' && $tab=='msgget'){ echo 'xx';


}elseif($act=='xxx'){
	
	echo '完善中…';
	
} //echo "$act=='message' && $tab=='msgget'";

glbHtml::page('end');

?>



/*******************************************************************************
 File : \root\a3rd\weixin_pay\wedemo.php 
*******************************************************************************/
<?php
$_cbase['run']['wedemo'] = 1;
require(dirname(__FILE__).'/we_cfgs.php');

$act = basReq::val('act','main'); 
$kid = basReq::val('kid','admin');
$debug = basReq::arr('debug','Html');

$ubase = PATH_ROOT."/plus/api/wechat.php?";
$dcfg = array('api','appid','token','appsecret','orgid','openid');
$wecfg = wysBasic::getConfig($kid); 
$db = glbDBObj::dbObj(); 

glbHtml::page("微信接口调试");
glbHtml::impub();
echo basJscss::imp("/skin/a_jscss/weixin.js"); //glbHtml::page('imps');
echo '<style type="text/css">
#tester { left:620px; top10px; position:fixed; background:#FFF; padding:10px; border:1px solid #CCC; }
.ngray { color:#F3F; }
#pic_res img { margin:5px; }
</style>';
glbHtml::page('body',' style="margin:20px;"');
wxDebugNavbar();

?>

<div id="tester">

<p>点击出二维码：[<a href="#" onClick="getQrcode('login')">登录</a> 
        # <a href="#" onClick="getQrcode('upload')">上传</a> 
        # <a href="#" onClick="getQrcode('mbind')">mbind</a>
        # <a href="#" onClick="getQrcode('getpw')">getpw</a>] <br>
* <span id="qr_sid">qr_sid</span>；<br>
* <span id="qr_stampys">qr_stampys</span>；<br> 
* <span id="qr_signys">qr_signys</span>；<br>
<img src="#" width="320" id="scanimg">
</p>
</div>

<table width="600" border="1">
    <tr>
        <td>登录结果</td>
        <td>上传结果</td>
    </tr>
    <tr>
        <td id="msg_res">&nbsp;</td>
        <td id="pic_res">&nbsp;</td>
    </tr>
</table>

<hr>

<p class="ngray">电脑扫描登录-流程</p>

<p>1. （电脑）点出二维码，并定时检测：</p>
&nbsp; * a. 一旦二维码出来，定时检测js：checkLogin(data.sid,extp);；<br>
&nbsp; * b. 加参数：sid,extp,stampys,signys是为了安全考虑；<br>

<p>2. （手机）扫描二维码：<br>
&nbsp; * a. 配置在公网上，可直接扫描；<br>
&nbsp; * b. 配置在内网上，可用后台的调试程序，复制qr_sid，推送二维码，把结果的链接复制到手机登录；<br>
</p>

<p>3. 检测结果：见上</p>

<p>4. 登出重新调试：<br>
&nbsp; * a. 因已经是登录状态就无需登录；所以请另开浏览器窗口，在未登录情况下测试；<br>
&nbsp; * b. 如果是登录状态：<a href="<?php echo vopUrl::fout('umc:'); ?>?mkv=user-login&act=doout">登出重新调试</a>
</p>

<hr>

<p class="ngray">电脑扫描上传-流程(还未处理FTP路径)</p>

<p>1. （电脑）点出二维码，并定时检测：</p>
&nbsp; * a. 一旦二维码出来，定时检测js：checkUpload(data.sid,extp);；<br>
&nbsp; * b. 加参数：sid,extp,stampys,signys是为了安全考虑；<br>

<p>2. （手机）扫描二维码：<br>
&nbsp; * a. 配置在公网上，可直接扫描，根据提示在公众号上传图片；<br>
&nbsp; * b. 配置在内网上，可用后台的调试程序，复制qr_sid，推送二维码；并使用【发图片(传图使用)】模拟发图；<br>
&nbsp; * c. 传图片后，观察电脑屏幕变化；<br>
</p>

<p>3. 检测结果：见上</p>

<p>4. 文档（二手车/二手房）保存成功后：<br>
清除相关状态：<br>
weixin_qrlimit - 二维码：atime=0<br>
weixin_msgget - 发送记录：atime=0<br>
</p>

<hr>

<p class="ngray">电脑扫描-发信息到微信</p>
<p>
<select name="sendaid" id="sendaid" onChange="getQrscan(this)">
<option value="">---请选文档（商品）---</option>
<?php
//$list = $db->table('base_model')->field('kid,title')->limit(3)->select(); if($list)foreach($list as $r){}}
$list = $db->table('docs_cargo')->order('did DESC')->select();
foreach($list as $row){
	echo "<option value='cargo.{$row['did']}'>[商品]{$row['did']}:{$row['title']}</option>";
}
?>
</select>
<br>
<select name="sendmid" id="sendmid" onChange="getQrscan(this)">
<option value="">---请选会员（新商家）---</option>
<?php
foreach(array('company'=>'公司','organize'=>'组织','govern'=>'单位') as $umod=>$title){
	$list = $db->table("users_$umod")->order('uid DESC')->select();
	foreach($list as $row){
		echo "<option value='{$umod}.{$row['uid']}'>[$title]{$row['uid']}:{$row['company']}</option>";
	}
}
?>
</select>
</p>

<p>end</p>
<p>&nbsp;</p>
<p>&nbsp; </p>

<script type="text/javascript">
var ubase = '<?php echo $ubase; ?>';
function clearQrcode(){
	$('#scanimg').attr('src','');
}
function getQrscan(obj){
	$('#scanimg').attr('src','');
	var kid = $(obj).val();
	if(!kid){ alert('请选一个会员或文档！'); return; }
	var extp = Math.random().toString(36).substr(2); 
	extp = kid+','+extp;
	var url = 'actys=getQrcode&qrmod=send&extp='+extp+'&datatype=js&varname=data';
	$.getScript(ubase+url, function(){ 
		$('#scanimg').attr('src',data.url);
		$('#qr_sid').html('qr_sid='+data.sid);
		$('#qr_stampys').html('qr_stampys='+data.stampys);
		$('#qr_signys').html('qr_signys='+data.signys);
		jsLog('getQrcode:'+extp); //调试
	});
}

function getQrcode(qrmod){
	clearQrcode();
	var extp = Math.random().toString(36).substr(2); 
	if(qrmod=='mbind'){ extp = '<?php echo comConvert::sysRevert('yufish', 0, '', 600); ?>'; }
	var url = 'actys=getQrcode&qrmod='+qrmod+'&extp='+extp+'&varname=data';
	$.getScript(ubase+url, function(){
		$('#scanimg').attr('src',data.url);
		$('#qr_sid').html('qr_sid='+data.sid);
		$('#qr_stampys').html('qr_stampys='+data.stampys);
		$('#qr_signys').html('qr_signys='+data.signys);
		if(qrmod=='login'){
			checkLogin(data.sid,extp,data.stampys,data.signys);
		}else if(qrmod=='mbind'){
			extp = 'yufish'; 
			//checkMbind(data.sid,extp,data.stampys,data.signys);
		}else if(qrmod=='getpw'){
			extp = ''; 
		}else if(qrmod=='upload'){
			//$('#pic_res').html('检测图片中…');
			checkUpload(data.sid,extp,data.stampys,data.signys);
		}
		jsLog('getQrcode:'+extp); //调试
	});
}

function checkLogin(sid,extp,stampys,signys){
	var url = 'actys=chkLogin&scene='+sid+'&extp='+extp+'&stampys='+stampys+'&signys='+signys+'&varname=data';
	$.getScript(ubase+url, function(){
		jsLog(data);
		if(typeof(data.error)=='undefined' || typeof(data.message)=='undefined' ){
            alert('服务器返回格式错误。');
			return '';
        //}else if(data.user_info.mid=="-1"){
			//$('#msg_res').html("已经是登录状态，请先登出！<br>mid="+data.user_ibak.mid+"<br>mname="+data.user_ibak.mname+"");
			//return '';
        }else if(data.uname){
			$('#msg_res').html("登录成功！<br>mname="+data.uname+"");
			return '';
        } 
		setTimeout("checkLogin('"+sid+"','"+extp+"','"+stampys+"','"+signys+"')",2000);
	});	
}

var pstr = ','; //用这个判断，已经显示了的，就不再显示
function checkUpload(sid,extp,stampys,signys){ //xxx
	var url = 'actys=chkUpload&scene='+sid+'&extp='+extp+'&stampys='+stampys+'&signys='+signys+'&varname=data';
	$.getScript(ubase+url, function(){
		//jsLog(data);
		if(typeof(data.error)=='undefined' || typeof(data.message)=='undefined' ){
            alert('服务器返回格式错误。');
			return '';
        }else if(data.error=='noScan'){
			$('#pic_res').html('['+data.error+']'+data.error);
			//不能return
		}else if(data.error){
			$('#pic_res').html(data.error);
			return '';
        }else if(data.res){
			var nstr = ''; 
			for (var i = 0; i < data.res.length; i++) { 
				var medid = data.res[i].media_id; 
				var imgmid = ubase+'actys=loadFile&mediaid='+medid+'&kid=<?php echo $kid; ?>'; 
				var imgurl = data.res[i].detail; //jsLog(imgurl.indexOf('weixin.qq'));
				var img = imgurl.indexOf('mmbiz.qpic')>0 ? imgmid : imgurl;
				if(pstr.indexOf(medid)<=0){
					nstr += '<a href="'+img+'"><img src="'+img+'" height="60"></a>';
					pstr += medid+','; 
				}
				//jsLog(data.res[i].detail);
			};
			nstr && $('#pic_res').append(nstr);
        } 
		setTimeout("checkUpload('"+sid+"','"+extp+"','"+stampys+"','"+signys+"')",2000);
	});	
}

</script>

<?php

glbHtml::page('end');

?>




/*******************************************************************************
 File : \root\a3rd\weixin_pay\wejsdk.php 
*******************************************************************************/
<?php
$_cbase['run']['wedemo'] = 1;
require(dirname(__FILE__).'/we_cfgs.php');

$wecfg = wysBasic::getConfig(); 
$jssdk = new wmpJssdk($wecfg);
$signPackage = $jssdk->GetSignPackage();
?>
<!DOCTYPE html><html><head>
<meta charset="gbk">
<title>微信JS-SDK</title>
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<link rel="stylesheet" href="http://203.195.235.76/jssdk/css/style.css">
</head>

<body>
<?php wxDebugNavbar(); ?>
<div class="wxapi_container">
    <div class="wxapi_index_container">
      <ul class="label_box lbox_close wxapi_index_list">
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-basic">基础接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-share">分享接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-image">图像接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-voice">音频接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-smart">智能接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-device">设备信息接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-location">地理位置接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-webview">界面操作接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-scan">微信扫一扫接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-shopping">微信小店接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-card">微信卡券接口</a></li>
        <li class="label_item wxapi_index_item"><a class="label_inner" href="#menu-pay">微信支付接口</a></li>
      </ul>
    </div>
    <div class="lbox_close wxapi_form">
      <h3 id="menu-basic">基础接口</h3>
      <span class="desc">判断当前客户端是否支持指定JS接口</span>
      <button class="btn btn_primary" id="checkJsApi">checkJsApi</button>

      <h3 id="menu-share">分享接口</h3>
      <span class="desc">获取“分享到朋友圈”按钮点击状态及自定义分享内容接口</span>
      <button class="btn btn_primary" id="onMenuShareTimeline">onMenuShareTimeline</button>
      <span class="desc">获取“分享给朋友”按钮点击状态及自定义分享内容接口</span>
      <button class="btn btn_primary" id="onMenuShareAppMessage">onMenuShareAppMessage</button>
      <span class="desc">获取“分享到QQ”按钮点击状态及自定义分享内容接口</span>
      <button class="btn btn_primary" id="onMenuShareQQ">onMenuShareQQ</button>
      <span class="desc">获取“分享到腾讯微博”按钮点击状态及自定义分享内容接口</span>
      <button class="btn btn_primary" id="onMenuShareWeibo">onMenuShareWeibo</button>
      <span class="desc">获取“分享到QZone”按钮点击状态及自定义分享内容接口</span>
      <button class="btn btn_primary" id="onMenuShareQZone">onMenuShareQZone</button>

      <h3 id="menu-image">图像接口</h3>
      <span class="desc">拍照或从手机相册中选图接口</span>
      <button class="btn btn_primary" id="chooseImage">chooseImage</button>
      <span class="desc">预览图片接口</span>
      <button class="btn btn_primary" id="previewImage">previewImage</button>
      <span class="desc">上传图片接口</span>
      <button class="btn btn_primary" id="uploadImage">uploadImage</button>
      <span class="desc">下载图片接口</span>
      <button class="btn btn_primary" id="downloadImage">downloadImage</button>

      <h3 id="menu-voice">音频接口</h3>
      <span class="desc">开始录音接口</span>
      <button class="btn btn_primary" id="startRecord">startRecord</button>
      <span class="desc">停止录音接口</span>
      <button class="btn btn_primary" id="stopRecord">stopRecord</button>
      <span class="desc">播放语音接口</span>
      <button class="btn btn_primary" id="playVoice">playVoice</button>
      <span class="desc">暂停播放接口</span>
      <button class="btn btn_primary" id="pauseVoice">pauseVoice</button>
      <span class="desc">停止播放接口</span>
      <button class="btn btn_primary" id="stopVoice">stopVoice</button>
      <span class="desc">上传语音接口</span>
      <button class="btn btn_primary" id="uploadVoice">uploadVoice</button>
      <span class="desc">下载语音接口</span>
      <button class="btn btn_primary" id="downloadVoice">downloadVoice</button>

      <h3 id="menu-smart">智能接口</h3>
      <span class="desc">识别音频并返回识别结果接口</span>
      <button class="btn btn_primary" id="translateVoice">translateVoice</button>

      <h3 id="menu-device">设备信息接口</h3>
      <span class="desc">获取网络状态接口</span>
      <button class="btn btn_primary" id="getNetworkType">getNetworkType</button>

      <h3 id="menu-location">地理位置接口</h3>
      <span class="desc">使用微信内置地图查看位置接口</span>
      <button class="btn btn_primary" id="openLocation">openLocation</button>
      <span class="desc">获取地理位置接口</span>
      <button class="btn btn_primary" id="getLocation">getLocation</button>

      <h3 id="menu-webview">界面操作接口</h3>
      <span class="desc">隐藏右上角菜单接口</span>
      <button class="btn btn_primary" id="hideOptionMenu">hideOptionMenu</button>
      <span class="desc">显示右上角菜单接口</span>
      <button class="btn btn_primary" id="showOptionMenu">showOptionMenu</button>
      <span class="desc">关闭当前网页窗口接口</span>
      <button class="btn btn_primary" id="closeWindow">closeWindow</button>
      <span class="desc">批量隐藏功能按钮接口</span>
      <button class="btn btn_primary" id="hideMenuItems">hideMenuItems</button>
      <span class="desc">批量显示功能按钮接口</span>
      <button class="btn btn_primary" id="showMenuItems">showMenuItems</button>
      <span class="desc">隐藏所有非基础按钮接口</span>
      <button class="btn btn_primary" id="hideAllNonBaseMenuItem">hideAllNonBaseMenuItem</button>
      <span class="desc">显示所有功能按钮接口</span>
      <button class="btn btn_primary" id="showAllNonBaseMenuItem">showAllNonBaseMenuItem</button>

      <h3 id="menu-scan">微信扫一扫</h3>
      <span class="desc">调起微信扫一扫接口</span>
      <button class="btn btn_primary" id="scanQRCode0">scanQRCode(微信处理结果)</button>
      <button class="btn btn_primary" id="scanQRCode1">scanQRCode(直接返回结果)</button>

      <h3 id="menu-shopping">微信小店接口</h3>
      <span class="desc">跳转微信商品页接口</span>
      <button class="btn btn_primary" id="openProductSpecificView">openProductSpecificView</button>

      <h3 id="menu-card">微信卡券接口</h3>
      <span class="desc">批量添加卡券接口</span>
      <button class="btn btn_primary" id="addCard">addCard</button>
      <span class="desc">调起适用于门店的卡券列表并获取用户选择列表</span>
      <button class="btn btn_primary" id="chooseCard">chooseCard</button>
      <span class="desc">查看微信卡包中的卡券接口</span>
      <button class="btn btn_primary" id="openCard">openCard</button>

      <h3 id="menu-pay">微信支付接口</h3>
      <span class="desc">发起一个微信支付请求</span>
      <button class="btn btn_primary" id="chooseWXPay">chooseWXPay</button>
    </div>
  </div>
</body>

<script>
  /*
   * 注意：
   * 1. 所有的JS接口只能在公众号绑定的域名下调用，公众号开发者需要先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。
   * 2. 如果发现在 Android 不能分享自定义内容，请到官网下载最新的包覆盖安装，Android 自定义分享接口需升级至 6.0.2.58 版本及以上。
   * 3. 常见问题及完整 JS-SDK 文档地址：http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html
   *
   * 开发中遇到问题详见文档“附录5-常见错误及解决办法”解决，如仍未能解决可通过以下渠道反馈：
   * 邮箱地址：weixin-open@qq.com
   * 邮件主题：【微信JS-SDK反馈】具体问题
   * 邮件内容说明：用简明的语言描述问题所在，并交代清楚遇到该问题的场景，可附上截屏图片，微信团队会尽快处理你的反馈。
   */
wx.config({
debug: true,
appId: '<?php echo $signPackage["appId"];?>',
timestamp: <?php echo $signPackage["timestamp"];?>,
nonceStr: '<?php echo $signPackage["nonceStr"];?>',
signature: '<?php echo $signPackage["signature"];?>',
jsApiList: [
	'checkJsApi',
	'onMenuShareTimeline',
	'onMenuShareAppMessage',
	'onMenuShareQQ',
	'onMenuShareWeibo',
	'onMenuShareQZone',
	'hideMenuItems',
	'showMenuItems',
	'hideAllNonBaseMenuItem',
	'showAllNonBaseMenuItem',
	'translateVoice',
	'startRecord',
	'stopRecord',
	'onVoiceRecordEnd',
	'playVoice',
	'onVoicePlayEnd',
	'pauseVoice',
	'stopVoice',
	'uploadVoice',
	'downloadVoice',
	'chooseImage',
	'previewImage',
	'uploadImage',
	'downloadImage',
	'getNetworkType',
	'openLocation',
	'getLocation',
	'hideOptionMenu',
	'showOptionMenu',
	'closeWindow',
	'scanQRCode',
	'chooseWXPay',
	'openProductSpecificView',
	'addCard',
	'chooseCard',
	'openCard'
]
});
wx.ready(function () {
  // 1 判断当前版本是否支持指定 JS 接口，支持批量判断
  document.querySelector('#checkJsApi').onclick = function () {
	wx.checkJsApi({
	  jsApiList: [
		'getNetworkType',
		'previewImage'
	  ],
	  success: function (res) {
		alert(JSON.stringify(res));
	  }
	});
  };

  // 2. 分享接口
  // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
  document.querySelector('#onMenuShareAppMessage').onclick = function () {
	wx.onMenuShareAppMessage({
	  title: '互联网之子',
	  desc: '在长大的过程中，我才慢慢发现，我身边的所有事，别人跟我说的所有事，那些所谓本来如此，注定如此的事，它们其实没有非得如此，事情是可以改变的。更重要的是，有些事既然错了，那就该做出改变。',
	  link: 'http://movie.douban.com/subject/25785114/',
	  imgUrl: 'http://demo.open.weixin.qq.com/jssdk/images/p2166127561.jpg',
	  trigger: function (res) {
		// 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
		alert('用户点击发送给朋友');
	  },
	  success: function (res) {
		alert('已分享');
	  },
	  cancel: function (res) {
		alert('已取消');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
	alert('已注册获取“发送给朋友”状态事件');
  };

  // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
  document.querySelector('#onMenuShareTimeline').onclick = function () {
	wx.onMenuShareTimeline({
	  title: '互联网之子',
	  link: 'http://movie.douban.com/subject/25785114/',
	  imgUrl: 'http://demo.open.weixin.qq.com/jssdk/images/p2166127561.jpg',
	  trigger: function (res) {
		// 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
		alert('用户点击分享到朋友圈');
	  },
	  success: function (res) {
		alert('已分享');
	  },
	  cancel: function (res) {
		alert('已取消');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
	alert('已注册获取“分享到朋友圈”状态事件');
  };

  // 2.3 监听“分享到QQ”按钮点击、自定义分享内容及分享结果接口
  document.querySelector('#onMenuShareQQ').onclick = function () {
	wx.onMenuShareQQ({
	  title: '互联网之子',
	  desc: '在长大的过程中，我才慢慢发现，我身边的所有事，别人跟我说的所有事，那些所谓本来如此，注定如此的事，它们其实没有非得如此，事情是可以改变的。更重要的是，有些事既然错了，那就该做出改变。',
	  link: 'http://movie.douban.com/subject/25785114/',
	  imgUrl: 'http://img3.douban.com/view/movie_poster_cover/spst/public/p2166127561.jpg',
	  trigger: function (res) {
		alert('用户点击分享到QQ');
	  },
	  complete: function (res) {
		alert(JSON.stringify(res));
	  },
	  success: function (res) {
		alert('已分享');
	  },
	  cancel: function (res) {
		alert('已取消');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
	alert('已注册获取“分享到 QQ”状态事件');
  };
  
  // 2.4 监听“分享到微博”按钮点击、自定义分享内容及分享结果接口
  document.querySelector('#onMenuShareWeibo').onclick = function () {
	wx.onMenuShareWeibo({
	  title: '互联网之子',
	  desc: '在长大的过程中，我才慢慢发现，我身边的所有事，别人跟我说的所有事，那些所谓本来如此，注定如此的事，它们其实没有非得如此，事情是可以改变的。更重要的是，有些事既然错了，那就该做出改变。',
	  link: 'http://movie.douban.com/subject/25785114/',
	  imgUrl: 'http://img3.douban.com/view/movie_poster_cover/spst/public/p2166127561.jpg',
	  trigger: function (res) {
		alert('用户点击分享到微博');
	  },
	  complete: function (res) {
		alert(JSON.stringify(res));
	  },
	  success: function (res) {
		alert('已分享');
	  },
	  cancel: function (res) {
		alert('已取消');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
	alert('已注册获取“分享到微博”状态事件');
  };

  // 2.5 监听“分享到QZone”按钮点击、自定义分享内容及分享接口
  document.querySelector('#onMenuShareQZone').onclick = function () {
	wx.onMenuShareQZone({
	  title: '互联网之子',
	  desc: '在长大的过程中，我才慢慢发现，我身边的所有事，别人跟我说的所有事，那些所谓本来如此，注定如此的事，它们其实没有非得如此，事情是可以改变的。更重要的是，有些事既然错了，那就该做出改变。',
	  link: 'http://movie.douban.com/subject/25785114/',
	  imgUrl: 'http://img3.douban.com/view/movie_poster_cover/spst/public/p2166127561.jpg',
	  trigger: function (res) {
		alert('用户点击分享到QZone');
	  },
	  complete: function (res) {
		alert(JSON.stringify(res));
	  },
	  success: function (res) {
		alert('已分享');
	  },
	  cancel: function (res) {
		alert('已取消');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
	alert('已注册获取“分享到QZone”状态事件');
  };


  // 3 智能接口
  var voice = {
	localId: '',
	serverId: ''
  };
  // 3.1 识别音频并返回识别结果
  document.querySelector('#translateVoice').onclick = function () {
	if (voice.localId == '') {
	  alert('请先使用 startRecord 接口录制一段声音');
	  return;
	}
	wx.translateVoice({
	  localId: voice.localId,
	  complete: function (res) {
		if (res.hasOwnProperty('translateResult')) {
		  alert('识别结果：' + res.translateResult);
		} else {
		  alert('无法识别');
		}
	  }
	});
  };

  // 4 音频接口
  // 4.2 开始录音
  document.querySelector('#startRecord').onclick = function () {
	wx.startRecord({
	  cancel: function () {
		alert('用户拒绝授权录音');
	  }
	});
  };

  // 4.3 停止录音
  document.querySelector('#stopRecord').onclick = function () {
	wx.stopRecord({
	  success: function (res) {
		voice.localId = res.localId;
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
  };

  // 4.4 监听录音自动停止
  wx.onVoiceRecordEnd({
	complete: function (res) {
	  voice.localId = res.localId;
	  alert('录音时间已超过一分钟');
	}
  });

  // 4.5 播放音频
  document.querySelector('#playVoice').onclick = function () {
	if (voice.localId == '') {
	  alert('请先使用 startRecord 接口录制一段声音');
	  return;
	}
	wx.playVoice({
	  localId: voice.localId
	});
  };

  // 4.6 暂停播放音频
  document.querySelector('#pauseVoice').onclick = function () {
	wx.pauseVoice({
	  localId: voice.localId
	});
  };

  // 4.7 停止播放音频
  document.querySelector('#stopVoice').onclick = function () {
	wx.stopVoice({
	  localId: voice.localId
	});
  };

  // 4.8 监听录音播放停止
  wx.onVoicePlayEnd({
	complete: function (res) {
	  alert('录音（' + res.localId + '）播放结束');
	}
  });

  // 4.8 上传语音
  document.querySelector('#uploadVoice').onclick = function () {
	if (voice.localId == '') {
	  alert('请先使用 startRecord 接口录制一段声音');
	  return;
	}
	wx.uploadVoice({
	  localId: voice.localId,
	  success: function (res) {
		alert('上传语音成功，serverId 为' + res.serverId);
		voice.serverId = res.serverId;
	  }
	});
  };

  // 4.9 下载语音
  document.querySelector('#downloadVoice').onclick = function () {
	if (voice.serverId == '') {
	  alert('请先使用 uploadVoice 上传声音');
	  return;
	}
	wx.downloadVoice({
	  serverId: voice.serverId,
	  success: function (res) {
		alert('下载语音成功，localId 为' + res.localId);
		voice.localId = res.localId;
	  }
	});
  };

  // 5 图片接口
  // 5.1 拍照、本地选图
  var images = {
	localId: [],
	serverId: []
  };
  document.querySelector('#chooseImage').onclick = function () {
	wx.chooseImage({
	  success: function (res) {
		images.localId = res.localIds;
		alert('已选择 ' + res.localIds.length + ' 张图片');
	  }
	});
  };

  // 5.2 图片预览
  document.querySelector('#previewImage').onclick = function () {
	wx.previewImage({
	  current: 'http://img5.douban.com/view/photo/photo/public/p1353993776.jpg',
	  urls: [
		'http://img3.douban.com/view/photo/photo/public/p2152117150.jpg',
		'http://img5.douban.com/view/photo/photo/public/p1353993776.jpg',
		'http://img3.douban.com/view/photo/photo/public/p2152134700.jpg'
	  ]
	});
  };

  // 5.3 上传图片
  document.querySelector('#uploadImage').onclick = function () {
	if (images.localId.length == 0) {
	  alert('请先使用 chooseImage 接口选择图片');
	  return;
	}
	var i = 0, length = images.localId.length;
	images.serverId = [];
	function upload() {
	  wx.uploadImage({
		localId: images.localId[i],
		success: function (res) {
		  i++;
		  //alert('已上传：' + i + '/' + length);

		  images.serverId.push(res.serverId);
		  if (i < length) {
			upload();
		  }
		},
		fail: function (res) {
		  alert(JSON.stringify(res));
		}
	  });
	}
	upload();
  };

  // 5.4 下载图片
  document.querySelector('#downloadImage').onclick = function () {
	if (images.serverId.length === 0) {
	  alert('请先使用 uploadImage 上传图片');
	  return;
	}
	var i = 0, length = images.serverId.length;
	images.localId = [];
	function download() {
	  wx.downloadImage({
		serverId: images.serverId[i],
		success: function (res) {
		  i++;
		  alert('已下载：' + i + '/' + length);
		  images.localId.push(res.localId);
		  if (i < length) {
			download();
		  }
		}
	  });
	}
	download();
  };

  // 6 设备信息接口
  // 6.1 获取当前网络状态
  document.querySelector('#getNetworkType').onclick = function () {
	wx.getNetworkType({
	  success: function (res) {
		alert(res.networkType);
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
  };

  // 7 地理位置接口
  // 7.1 查看地理位置
  document.querySelector('#openLocation').onclick = function () {
	wx.openLocation({
	  latitude: 23.099994,
	  longitude: 113.324520,
	  name: 'TIT 创意园',
	  address: '广州市海珠区新港中路 397 号',
	  scale: 14,
	  infoUrl: 'http://weixin.qq.com'
	});
  };

  // 7.2 获取当前地理位置
  document.querySelector('#getLocation').onclick = function () {
	wx.getLocation({
	  success: function (res) {
		alert(JSON.stringify(res));
	  },
	  cancel: function (res) {
		alert('用户拒绝授权获取地理位置');
	  }
	});
  };

  // 8 界面操作接口
  // 8.1 隐藏右上角菜单
  document.querySelector('#hideOptionMenu').onclick = function () {
	wx.hideOptionMenu();
  };

  // 8.2 显示右上角菜单
  document.querySelector('#showOptionMenu').onclick = function () {
	wx.showOptionMenu();
  };

  // 8.3 批量隐藏菜单项
  document.querySelector('#hideMenuItems').onclick = function () {
	wx.hideMenuItems({
	  menuList: [
		'menuItem:readMode', // 阅读模式
		'menuItem:share:timeline', // 分享到朋友圈
		'menuItem:copyUrl' // 复制链接
	  ],
	  success: function (res) {
		alert('已隐藏“阅读模式”，“分享到朋友圈”，“复制链接”等按钮');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
  };

  // 8.4 批量显示菜单项
  document.querySelector('#showMenuItems').onclick = function () {
	wx.showMenuItems({
	  menuList: [
		'menuItem:readMode', // 阅读模式
		'menuItem:share:timeline', // 分享到朋友圈
		'menuItem:copyUrl' // 复制链接
	  ],
	  success: function (res) {
		alert('已显示“阅读模式”，“分享到朋友圈”，“复制链接”等按钮');
	  },
	  fail: function (res) {
		alert(JSON.stringify(res));
	  }
	});
  };

  // 8.5 隐藏所有非基本菜单项
  document.querySelector('#hideAllNonBaseMenuItem').onclick = function () {
	wx.hideAllNonBaseMenuItem({
	  success: function () {
		alert('已隐藏所有非基本菜单项');
	  }
	});
  };

  // 8.6 显示所有被隐藏的非基本菜单项
  document.querySelector('#showAllNonBaseMenuItem').onclick = function () {
	wx.showAllNonBaseMenuItem({
	  success: function () {
		alert('已显示所有非基本菜单项');
	  }
	});
  };

  // 8.7 关闭当前窗口
  document.querySelector('#closeWindow').onclick = function () {
	wx.closeWindow();
  };

  // 9 微信原生接口
  // 9.1.1 扫描二维码并返回结果
  document.querySelector('#scanQRCode0').onclick = function () {
	wx.scanQRCode();
  };
  // 9.1.2 扫描二维码并返回结果
  document.querySelector('#scanQRCode1').onclick = function () {
	wx.scanQRCode({
	  needResult: 1,
	  desc: 'scanQRCode desc',
	  success: function (res) {
		alert(JSON.stringify(res));
	  }
	});
  };

  // 10 微信支付接口
  // 10.1 发起一个支付请求
  document.querySelector('#chooseWXPay').onclick = function () {
	// 注意：此 Demo 使用 2.7 版本支付接口实现，建议使用此接口时参考微信支付相关最新文档。
	wx.chooseWXPay({
	  timestamp: 1414723227,
	  nonceStr: 'noncestr',
	  package: 'addition=action_id%3dgaby1234%26limit_pay%3d&bank_type=WX&body=innertest&fee_type=1&input_charset=GBK&notify_url=http%3A%2F%2F120.204.206.246%2Fcgi-bin%2Fmmsupport-bin%2Fnotifypay&out_trade_no=1414723227818375338&partner=1900000109&spbill_create_ip=127.0.0.1&total_fee=1&sign=432B647FE95C7BF73BCD177CEECBEF8D',
	  signType: 'SHA1', // 注意：新版支付接口使用 MD5 加密
	  paySign: 'bd5b1933cda6e9548862944836a9b52e8c9a2b69'
	});
  };

  // 11.3  跳转微信商品页
  document.querySelector('#openProductSpecificView').onclick = function () {
	wx.openProductSpecificView({
	  productId: 'pDF3iY_m2M7EQ5EKKKWd95kAxfNw',
	  extInfo: '123'
	});
  };

  // 12 微信卡券接口
  // 12.1 添加卡券
  document.querySelector('#addCard').onclick = function () {
	wx.addCard({
	  cardList: [
		{
		  cardId: 'pDF3iY9tv9zCGCj4jTXFOo1DxHdo',
		  cardExt: '{"code": "", "openid": "", "timestamp": "1418301401", "signature":"f54dae85e7807cc9525ccc127b4796e021f05b33"}'
		},
		{
		  cardId: 'pDF3iY9tv9zCGCj4jTXFOo1DxHdo',
		  cardExt: '{"code": "", "openid": "", "timestamp": "1418301401", "signature":"f54dae85e7807cc9525ccc127b4796e021f05b33"}'
		}
	  ],
	  success: function (res) {
		alert('已添加卡券：' + JSON.stringify(res.cardList));
	  }
	});
  };

  var codes = [];
  // 12.2 选择卡券
  document.querySelector('#chooseCard').onclick = function () {
	wx.chooseCard({
	  cardSign: '8ef8aa071f1d2186cb1355ec132fed04ebba1c3f',
	  timestamp: 1437997723,
	  nonceStr: 'k0hGdSXKZEj3Min5',
	  success: function (res) {
		res.cardList = JSON.parse(res.cardList);
		encrypt_code = res.cardList[0]['encrypt_code'];
		alert('已选择卡券：' + JSON.stringify(res.cardList));
		decryptCode(encrypt_code, function (code) {
		  codes.push(code);
		});
	  }
	});
  };

  // 12.3 查看卡券
  document.querySelector('#openCard').onclick = function () {
	if (codes.length < 1) {
	  alert('请先使用 chooseCard 接口选择卡券。');
	  return false;
	}
	var cardList = [];
	for (var i = 0; i < codes.length; i++) {
	  cardList.push({
		cardId: 'pDF3iY9tv9zCGCj4jTXFOo1DxHdo',
		code: codes[i]
	  });
	}
	wx.openCard({
	  cardList: cardList
	});
  };

  var shareData = {
	title: '微信JS-SDK Demo',
	desc: '微信JS-SDK,帮助第三方为用户提供更优质的移动web服务',
	link: 'http://demo.open.weixin.qq.com/jssdk/',
	imgUrl: 'http://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRt8Qia4lv7k3M9J1SKqKCImxJCt7j9rHYicKDI45jRPBxdzdyREWnk0ia0N5TMnMfth7SdxtzMvVgXg/0'
  };
  wx.onMenuShareAppMessage(shareData);
  wx.onMenuShareTimeline(shareData);

  function decryptCode(code, callback) {
	$.getJSON('/jssdk/decrypt_code.php?code=' + encodeURI(code), function (res) {
	  if (res.errcode == 0) {
		codes.push(res.code);
	  }
	});
  }
});

wx.error(function (res) {
  alert(res.errMsg);
});

</script>

</html>



/*******************************************************************************
 File : \root\a3rd\weixin_pay\wetest.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/we_cfgs.php');

//*
glbHtml::page("微信接口调试");
glbHtml::page('body');
wxDebugNavbar();
echo "<pre>\n";
//*/

$msgCont = '<a href="http://house.txmao.com/newhouse/201103/589868/detail.html">东湖花园-字标题四十个汉字标题四十个汉字标题四十个汉字标题四十个汉字标题四十个汉字</a>
地址：莲东片区是龙岩市唯一一个人居板块，定义为城市的后花园，登高山公园、莲花山公园就在附近
特色：小户型投资地产 教育地产 旅游地产
欢迎关注！<a href="http://house.txmao.com/newhouse/201103/589868/detail.html">点击看详情</a>';
$msgItems = array(
	array('title'=>'测试新闻1','description'=>'描述1','url'=>'http://192.168.1.11/auto/admina.php?','picurl'=>'http://192.168.1.11/auto/images/admina/logo.png',),
	array('title'=>'测试新闻2','description'=>'描述2','url'=>'http://192.168.1.11/auto/admina.php?','picurl'=>'http://192.168.1.11/auto/images/admina/logo.png',),
);

$msgItems = array( //较好的效果为大图360*200，小图200*200,  小语交互,微简历,微名片
	array('title'=>'鸽子小语','description'=>'Peace生命感言','url'=>'http://yscode.txjia.com/about/attitude.htm?','picurl'=>'http://yscode.txjia.com/uimgs/zohe/pi.gif',),
	array('title'=>'微名片','description'=>'和平鸽工作室','url'=>'http://yscode.txjia.com/about/card.htm?','picurl'=>'http://yscode.txjia.com/uimgs/logo/gezi1.jpg',),
	array('title'=>'天气预报','description'=>'全国天气','url'=>'http://yscode.txjia.com/about/tianqi.htm?','picurl'=>'http://yscode.txjia.com/uimgs/logo/gezi-fly.gif',),
);

$articles = array( //360*200，小图200*200
	array('title'=>'测试新闻1','medid'=>'kIdplY3EPMtFbCFIiwvrLIRVrEzHtXYmUfgQDSdhUYc','content'=>'aa图文消息的具体内容，支持HTML标签，必须少于2万字符，小于1M，且此处会去除JS','url'=>'http://192.168.1.11/auto/admina.php?',),
	array('title'=>'测试新闻2','medid'=>'kIdplY3EPMtFbCFIiwvrLIRVrEzHtXYmUfgQDSdhUYc','content'=>'bb图文消息的具体内容，支持HTML标签，必须少于2万字符，小于1M，且此处会去除JS','url'=>'http://192.168.1.11/auto/admina.php?',),
);

$url = 'http://192.168.1.11/08svn/auto_wet/index.php?/weixin/';

////////////////////////////////////////////////////////////////

// test-corp // ozhJVv2TgEaIxgQBcH9KnlWZdbZE,  gh_4d966875a7b4
$_ex_wechat['t08']['token'] = "corp20151234567890QYmxjx"; 
$_ex_wechat['t08']['appid'] = 'wx77827302390ce603'; 
$_ex_wechat['t08']['appsecret'] = 'b9c506dfe132f80255a6bbf7d65ce93d'; 

// zhanTester // ov-P4wv9pfUkcPGMuKdmh82pqD9s,  gh_a7f7e20ee310
// {svrtxmao}/plus/api/wechat.php
$_ex_wechat['zhl']['token'] = "Pe6_zhl_q9a_txjia_kmy"; 
$_ex_wechat['zhl']['appid'] = 'wxb864010c7215b0b1'; 
$_ex_wechat['zhl']['appsecret'] = 'd4624c36b6795d1d99dcf0547af5443d';  

// yangTester // ohcp-wpHkE96En9m59_TcjBls72g,  gh_c0db633da39e
$_ex_wechat['yql']['token'] = "yangqilin"; 
$_ex_wechat['yql']['appid'] = 'wx4b31d531425504bf'; 
$_ex_wechat['yql']['appsecret'] = 'd4624c36b6795d1d99dcf0547af5443d';  

// Tester // oyDK8vjjcn2cFbxMLaMBhKEsYbCk,  gh_70af3f6f3acf
$_ex_wechat['tys']['token'] = "ffckgkq6tbtjk7jaahbv5q8w5y55sdad"; 
$_ex_wechat['tys']['appid'] = 'wx20b06b3c8d4e2a46'; 
$_ex_wechat['tys']['appsecret'] = '331634c914433f3d48b963cd2dacbc4d';  

// peaceys, gh_8b0e4d1bb70c
$_ex_wechat['pys']['token'] = "Z1GNFQwRHqZ5ahfnAepL"; 
$_ex_wechat['pys']['appid'] = 'wxce96c26e3d9b8799'; 
$_ex_wechat['pys']['appsecret'] = '2f86466887576e5c3f0018a4c7e09662';

// corp // oA1n9tlixahY2kgCVm9u2tuNgvcI, gh_a94178b33562
$_ex_wechat['h08']['token'] = "djkskk4ss33fs"; //正式号，不要测试创建菜单... 
$_ex_wechat['h08']['appid'] = 'wx6ada54f4b9754685'; 
$_ex_wechat['h08']['appsecret'] = '3eb11ebe5c16421905d8652c16aaa7ca';

// 张华 // ocrnVwRC6iJqvvghjbCjKnosKWRs
$_ex_wechat['tzh']['token'] = "louistest1234567890"; //
$_ex_wechat['tzh']['appid'] = 'wx3b915d8db305b742'; 
$_ex_wechat['tzh']['appsecret'] = 'cf283cea2f16d06561501a581e5fb90a';

$api = 'tys';
$cfg = $_ex_wechat[$api];

$media_id_mat = 'https://api.weixin.qq.com/cgi-bin/media/get?access_token=oizdEBcYX3sjwEaoB-q6LhjXn4VN72k4BWzXb7lY2OlPWKSINR9Sce44K1XlaoHeUYmtAo4kegOoJoOAQZFSqHWL3sh-PxRx3vKqFVpI2o0CRQjAEAXML&media_id=JFmoZQO2Uv5opkMqklFmGL_75OyOnyAdhqzTpSH0vtJt3KAeTa0e87hh-CW89TGn';
$media_id_news = 'kIdplY3EPMtFbCFIiwvrLIRVrEzHtXYmUfgQDSdhUYc';


$tpl = 'u6DK6CKG8TnCFGaOwglBPUPa_UvE3nwpQU-k8kP1YpA';
$data = '"first": {
                       "value":"您好！您收到一条公文消息：",
                       "color":"#173177"
                   },
                   "title":{
                       "value":"XXX项目启动会",
                       "color":"#173177"
                   },
                   "time": {
                       "value":"2014年1月16日14时",
                       "color":"#173177"
                   },
                   "auser": {
                       "value":"peace",
                       "color":"#173177"
                   },
                   "remark":{
                       "value":"请点击查看！",
                       "color":"#173177"
                   }';
$wxo = new wmpMsgmass($_ex_wechat['tys']);
$data = $wxo->sendTpl('oyDK8vjjcn2cFbxMLaMBhKEsYbCk', $tpl, $data, 'http://txmao.txjia.com/root/run/umc.php?indoc.2015-9m-dq21');
echo "\n"; echo "<pre>"; 
print_r($data); die();

/*
$wxmat = new wmpMaterial($_ex_wechat['tys']);
$data = $wxmat->matAdd('/media/cover/haibao.jpg');
echo "\n"; echo "<pre>"; 
print_r($data); die();
*/

/*
$i=1; $m=100000; $s='"oA1n9tlixahY2kgCVm9u23-100000"';
for($i=1;$i<$m;$i++){
	$s.=",\"oA1n9tlixahY2kgCVm9u23-".(100000+$i)."\"";	
}
$data = '{"total":673,"count":671,"data":{"openid":['.$s.']},"next_openid":"oA1n9tnC0WM26W17uu2f9NFBSc_4"}';
//echo $data;

print_r(json_decode($data,1));
//123456789-123456789-123456789-
//oA1n9tlixahY2kgCVm9u2tuNgvcI
//oA1n9tlixahY2kgCVm9u2-100000
//{"total":673,"count":671,"data":{"openid":["oA1n9tlixahY2kgCVm9u2tuNgvcI","oA1n9tqn9Yu2f9NFBSc_4"}
*/


//$s = '&_#';
//echo urlencode($s); die();



/*
$url = "{$cms_abs}wxlogin.php?test=1&oauth=uinfo&state=";
preg_match("/oauth=(\w+)/i",$url,$m);
echo "<br>aaa: "; print_r($m); echo "<br>";
preg_match("/state=(\w+)/i",$url,$m);
echo "<br>bbb: "; print_r($m); echo "<br>";
//preg_replace("/$key=([^\f\n\r\t\v\&\#]{1,80})/i",$para,$url);
*/


/*/* ??? 失败
$weixin = new wmpSemantic($cfg);
$q = '查一下明天从广州到上海的南航机票'; 
//东莞-郴州,火车票
//' 查一下明天东莞到郴州的火车票 , 查一下明天从北京到上海的南航机票
$city = '广州';
$category = 'hotel'; //,hotel
$uid = 'oyDK8vjjcn2cFbxMLaMBhKEsYbCk';
$data = $weixin->getResult($q, $city, $category, $uid); 
print_r($data);
//*/


/*/*
$data = wysTester::getEvent('Scan');
$data = wysBasic::getResource(array(
	'urls' => $url,
	'timeOut' => 3,
	'method' => 'POST',
	'postData' => $data,
)); 
print_r($data);
//*/




/*/*
$data = wysTester::getMessage();
$data = wysBasic::iconv(cls_env::getBaseIncConfigs('mcharset'),'utf-8',$data);
$data = wysBasic::getResource(array(
	'urls' => $url,
	'timeOut' => 3,
	'method' => 'POST',
	'postData' => $data,
)); 
print_r($data);
//*/

//


/*/ ============= xxxxxxx : 
$wxmat = new wmpMaterial($_ex_wechat['tys']); //tys
echo "\n"; echo "<pre>"; 
$data = $wxmat->mdelMedia('kIdplY3EPMtFbCFIiwvrLOUFWt1b7vONiuYQmIaGaTQ');
print_r($data); 
//
$data = $wxmat->mgetList('image');
print_r($data); 
$data = $wxmat->mgetList('news');
print_r($data); 
$data = $wxmat->mgetList('video');
print_r($data); 
//*/
//echo "</pre>"; echo "\n";
//*/


/*/ ============= xxxxxxx : 
$wxmat = new wmpMaterial($_ex_wechat['tys']);
$data = $wxmat->matNews($articles,'08点点');
echo "\n"; echo "<pre>"; 
print_r($data); 
echo "</pre>"; echo "\n";
//*/


	
/*/ ============= xxxxxxx
$wxmat = new wmpMaterial($_ex_wechat['zhl']);
$data = $wxmat->matAdd('/media/cover/haibao.jpg');
echo "\n"; echo "<pre>"; 
print_r($data); 
$url = @$data['url']; //$wxmat->tmpGet();
echo "<a href='$url'>$url</a>
<br><img src='$url'>";
echo "</pre>"; echo "\n";
//*/

	
/*/echo "<img src='$media_id_t1'>";	
// ============= xxxxxxx
$wxmat = new wmpMaterial($_ex_wechat['tys']);
$data = $wxmat->tmpUpload('/skin/logo/gezi1-40x.jpg');
echo "\n"; echo "<pre>"; 
print_r($data); 
$url = $wxmat->tmpGet(@$data['media_id']);
echo "<a href='$url'>$url</a>
<br><img src='$url'>";
echo "</pre>"; echo "\n";
//*/


/*/ ============= xxxxxxx
$data = wysTester::getMessage(); //print_r($cfg);
$data = wysTester::showInfo($data);
echo "\n"; echo "<pre>$data</pre>"; echo "\n";
//*/


/*/ ============= xxxxxxx
$signurl = wysTester::getSignurl($cfg); //print_r($cfg);
echo "\n"; echo "<a href='$signurl'>$signurl</a>"; echo "\n";
//*/


// ============= xxxxxxx
/*/$wxbase = new wmpBasic($_ex_wechat['h08']);
//$actoken = $wxbase->actoken;
$weixin = new wmpMsgresp('',$_ex_wechat['pys']);
$data = $weixin->getRule($weixin->actoken);
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx // oyDK8vvPhm2vcuI-xehPJUJgTZbo,oyDK8vjjcn2cFbxMLaMBhKEsYbCk
$weixin = new wmpMsgmass($_ex_wechat['tys']);
$data = $weixin->sendText($msgCont,"oyDK8vvPhm2vcuI-xehPJUJgTZbo,oyDK8vjjcn2cFbxMLaMBhKEsYbCk");
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpMsgsend($_ex_wechat['zhl']);
//$data = $weixin->sendText('oyDK8vjjcn2cFbxMLaMBhKEsYbCk',$msgCont);
$data = $weixin->sendNews('ov-P4wv9pfUkcPGMuKdmh82pqD9s',$msgItems);
echo "\n"; print_r($data); echo "\n";
///



// ============= xxxxxxx
$weixin = new wmpBasic($cfg);
$data = $weixin->xxxx();
echo "\n"; print_r($data); echo "\n";
//*/


/*/
$weixin = new wysMenu($cfg);
//$data = $weixin->create($_ex_wechat['menu2']); echo "\n"; print_r($data); echo "\n";
$data = $weixin->get();
echo "\n"; print_r($data); echo "\n";
//*/


/*/
$weixin = new wmpQrcode($_ex_wechat['zhl']); 
$data = $weixin->qrcodeTicket('1001','fnum'); //[1-9]+[999,999
$url = $weixin->qrcodeShowurl($data);
echo "\n"; print_r($data); echo "<img src='$url'>\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpQrcode($_ex_wechat['tzh']);
$data = $weixin->shortUrl('http://192.168.1.11/08svn/auto_wet/admina.php?isframe=1&entry=channels&action=channeledit&mkv=info-coder&tpls=c_page/info_coder,c_pub/ahead,c_pub/amenu,c_page/info_side,c_pub/afeet#s_c_pub/ahead');
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpUser($cfg);
$data = $weixin->groupMove('oyDK8vjjcn2cFbxMLaMBhKEsYbCk',2);
echo "\n"; print_r($data); echo "\n";
$data = $weixin->groupMove('oyDK8vvPhm2vcuI-xehPJUJgTZbo',2);
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpUser($cfg);
$data = $weixin->groupDelete(109);
echo "\n"; print_r($data); echo "\n";
//*/




/*/ ============= xxxxxxx
$weixin = new wmpUser($cfg);
$data = $weixin->groupRename(108,'测试8组');
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpUser($cfg);
$data = $weixin->groupCreate('测试4组');
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpUser($cfg);
$data = $weixin->groupList();
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$weixin = new wmpUser($_ex_wechat['yql']);
$data = $weixin->getUserInfoList();
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= xxxxxxx
$us = 'oA1n9tlixahY2kgCVm9u2tuNgvcI,oA1n9tqn9Yi318wA-w9PmZ2AwRU8';
$weixin = new wmpUser($_ex_wechat['h08']);
$data = $weixin->getUserBatch($us);
echo "\n"; print_r($data); echo "\n";
//*/



/*/ ============= getUserRemark
$weixin = new wmpUser($_ex_wechat['h08']);
$data = $weixin->setUserRemark('oA1n9tlixahY2kgCVm9u2tuNgvcI','备注…'); 
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= getUserInfo
$weixin = new wmpUser($_ex_wechat['tys']);
$data = $weixin->getUserInfo('oyDK8vjjcn2cFbxMLaMBhKEsYbCk'); 
print_r(wysUser::fmtUserName($data));
echo "\n"; print_r($data); echo "\n";
//*/


/*/ ============= WeixinIP
$weixin = new wmpBasic($cfg);
$iplist = $weixin->getWeixinIP();
echo "\n"; print_r($iplist); echo "\n";
//*/


/*/ ============= getAccessToken测试
$weixin1 = new wmpBasic($cfg);
$token1 = $weixin1->actoken;
//管理多个公众号测试
$weixin2 = new wmpBasic($_ex_wechat['tzh']);
$token2 = $weixin2->actoken;
echo "\n".$token1."\n";
echo "\n".$token2."\n";
//*/


/*/ ============= txmao_loader测试
print_r(wmpError::errGet(40001));
echo "\n";
print_r(wmpError::errGet(888));
//*/

/*/ ============= txmao_loader测试
print_r(wysBasic::getConfig());
echo "\n";
//*/



// ============= end 

/*

*/



/*******************************************************************************
 File : \root\a3rd\weixin_pay\we_cfgs.php 
*******************************************************************************/
<?php
//define('RUN_AJAX', 1);  
//if(!isset($_cbase['skip'])) $_cbase['skip']['_all_'] = true;
require(dirname(dirname(dirname(dirname(__FILE__)))).'/root/run/_paths.php'); 

if(empty($_cbase['run']['wedemo'])){
	//usrPerm::run('pmod','apiweixin');
}
extract(basReq::sysVars());

function wxDebugNavbar(){
	$s = "\n<p class='tc'>";
	$s .= "Nav : \n<a href='wedebug.php'>wedebug</a>";
	$s .= " # \n<a href='wedemo.php'>wedemo</a>";
	$s .= " # \n<a href='wejsdk.php'>wejsdk</a>";
	$s .= " # \n<a href='wetest.php'>wetest</a>";
	$s .= "</p><hr>\n";
	echo $s;
}

/*
- 素材管理, wex_material
- 微网 wex_web
- 微店 wex_shop
- 微活动 (签到，场景) wex_acts
*/



/*******************************************************************************
 File : \root\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\plus\ajax\cajax.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php');
//safComm::urlFrom();
glbHtml::head('html');

$db = glbDBObj::dbObj();
$act = basReq::val('act','chkVImg'); 
$mod = basReq::val('mod','','Key'); //basStr::filKey('');
$kid = basReq::ark('fm','kid','Key'); //echo $mod.':'.$kid;
$uid = basReq::ark('fm','uid','Key'); //echo $mod.':'.$uid;
$_groups = glbConfig::read('groups');

// 处理语言
$lang = isset($_GET['lang']) ? $_GET['lang'] : $_cbase['sys']['lang'];
$lang && $_cbase['sys']['lang'] = $lang;

//测试
if($act=='_istest_'){
	
}elseif($act=='fsInit'){
	
	safComm::urlStamp('check',30);
	$restr = safComm::formCInit();
	echo "document.write(\"$restr\");";
	
}elseif($act=='userExists'){ 

	if($re=basKeyid::keepCheck($uname,1,1,1)){ //$key,$chk,$fix,$grp
		die($re);
	}elseif($uinfo = $db->table("users_uacc")->where("uname='$uname'")->find()){
		die(lang('plus.cajax_userid')."[$uname](uacc)".lang('plus.cajax_exsists'));
	}elseif($uinfo = $db->table("users_$mod")->where("uname='$uname'")->find()){
		die(lang('plus.cajax_userid')."[$uname]($mod)".lang('plus.cajax_exsists'));
	}else{
	    die("success");
	}	

	
}elseif($act=='fieldExists'){ 
	
	$db = glbDBObj::dbObj();
	$sy_kids = glbConfig::read('keepid','sy');
	if($re=basKeyid::keepCheck($kid,1,1,0)){ //$key,$chk,$fix,$grp
		die($re);
	}elseif($cmod = $db->table('base_fields')->where("model='$mod' AND kid='$kid'")->find()){
		die(lang('plus.cajax_field')."[$kid]".lang('plus.cajax_exsists'));
	}elseif(isset($_groups[$kid]) && $_groups[$kid]['pid']=='types'){ //系统模型
	    die("success");
	}elseif(isset($_groups[$kid]) || strstr($sy_kids,",$kid,")){ //系统模型
	    die("[$kid]".lang('plus.cajax_sysuesed')."[mod]");
	}elseif(isset($_groups[$kid]) && $_groups[$kid]['pid']!='types'){ //系统模型
		die(lang('plus.cajax_field')."[$kid]".lang('plus.cajax_syskeep')."[k1])");
	}elseif(in_array($kid,fldCfgs::setKeeps())){
		die("[$kid]".lang('plus.cajax_mykeys'));
	}else{
	    die("success");
	}
	
}elseif($act=='fieldCatid'){ 
	
	$catid = basReq::val('catid',''); 
	$ccfg = glbConfig::read($mod,'_c'); 
	$mfields = @$ccfg[$catid]; //var_dump($mfields); 
	
	if($re=basKeyid::keepCheck($kid,1,0,1)){ //$key,$chk,$fix,$grp
		die($re);
	}elseif(!empty($mfields) && isset($mfields[$kid])){
		die(lang('plus.cajax_field')."[$kid]".lang('plus.cajax_exsists'));
	}else{
	    die("success");
	}

}elseif($act=='keyExists'){
	
	$db = glbDBObj::dbObj();
	$tab = basReq::val('tab'); 
	$_f1 = in_array($tab,array('base_catalog','base_fields','base_grade','base_menu','base_model','base_paras','types_common'));
	$_k2 = str_replace('types_','',$tab);
	$_f2 = isset($_groups[$_k2]); 
	if(!$_f1 && !$_f2) die(lang('plus.cajax_erparam'));
	$kre = strtolower(basReq::ark('fm','kre','Key')); //@$fm['kre']
	if(!$kid && $kre) $kid=$kre;
	$old = basReq::val('old_val'); 
	if($re=basKeyid::keepCheck($kid,1,0,1,($_k2?2:3))){ //$key,$chk,$fix,$grp
		die($re);
	}elseif($kid===$old){
	    die("success");
	}elseif(in_array($kid, fldCfgs::setKeeps())){
		echo "[$kid]".lang('plus.cajax_mykeys')."[mysql]";
	}elseif($flag=$db->table($tab)->where((empty($mod) ? '' : "model='$mod' AND ")."kid='$kid'")->find()){
	    echo "[$kid]".lang('plus.cajax_beuesed');
	}else{
	    die("success");
	}
	
}elseif($act=='modExists'){
	
	if($re=basKeyid::keepCheck($kid,1,1,1)){ //$key,$chk,$fix,$grp
		die($re);
	}else{
		die("success");	
	}

}elseif($act=='infoRepeat'){
	
	$fid = basReq::val('fid');
	$kwd = basReq::val('kwd'); // mod,kid(docs,user,coms,advs)
	$msg = lang('plus.cajax_erparam');
	if(!isset($_groups[$mod])) die("var _repeat_res = '$msg';");
	$mcfg = glbConfig::read($mod); 
	$para = "[$mod:$fid=$kwd]";
	if(empty($mcfg['f'][$fid])){
		$re = "$para $msg!";	
	}elseif($kwd && $tab=glbDBExt::getTable($mod)){
		$flag = $db->table($tab)->where("$fid='$kwd'")->find();
		$re = $flag ? "success" : lang('plus.cajax_repeat');
	}else{
		$re = "$para $msg!";	
	}
	echo "var _repeat_res = '$re';";

// VImg
}elseif($act=='chkVImg'){
	
	safComm::urlStamp('check');
	$mod = basReq::val('mod'); $key = basReq::val('key'); 
	$key = "{$mod}_{$key}";
	$vcode = basReq::val($key);
	//echo "$mod, $vcode";
	$re = safComm::formCVimg($mod, $vcode, 'check', 600);
	if(strstr($re,'-Error')){
	    echo lang('plus.cajax_vcerr');
	}elseif(strstr($re,'-Timeout')){
	    echo lang('plus.cajax_vctout');
	}else{
	    echo "success";
	}

}elseif($act=='cfield'){ 

	$_cfg = glbConfig::read($mod);
	$_pid = $_cfg['pid']; 
	$_tmp = array(
		'docs' =>'did',
		'users'=>'uid',
	); //'coms' =>'cid',
	if(!isset($_tmp[$_pid])) glbHtml::end(lang('plus.cajax_erparam').':mod@dop.php');
	$db = glbDBObj::dbObj();
	$data = $db->table("{$_pid}_$mod")->where("$_tmp[$_pid]='$kid'")->find(); 
	fldView::lists($mod,$data,basReq::val('catid'));

}elseif($act=='uLogin'){ 
	
	$uname = basReq::val('uname');
	$uadm = usrBase::userObj('Admin');
	if($uadm->userFlag=='Login'){
		usrBase::setLogin('m',$uname);
		header("Location:".vopUrl::fout("umc:0"));
	}else{
		echo "(uname=$uname)";	
	}
	
}else{
	
	exit('Empty action!');	
	
}





/*******************************************************************************
 File : \root\plus\ajax\comjs.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php'); 
#safComm::urlFrom();
glbHtml::head(); 
extract(basReq::sysVars());
$act = basReq::val('act','sysInit'); 
//echo basDebug::runInfo();

// 初始化js
if($act=='sysInit'){  	
	
	$lang = isset($_GET['lang']) ? $_GET['lang'] : $_cbase['sys']['lang'];
	// ***** js配置区 *****
	$jscfg  = "\n// js Config";
	$jscfg .= "\nvar _cbase={}; _cbase.run={}; _cbase.sys={}; _cbase.path={}; _cbase.ck={};";
	$jscfg .= "\n_cbase.safe={}; _cbase.safil={}; _cbase.jsrun={};"; //_cbase.safe={}; 
	$jscfg .= "\n";
	$jscfg .= "\n_cbase.run.timer = '".$_cbase['run']['timer']."';";
	$jscfg .= "\n_cbase.run.stamp = '".$_cbase['run']['stamp']."';";
	$jscfg .= "\n_cbase.run.userag = '".$_cbase['run']['userag']."';";
	$jscfg .= "\n_cbase.run.jsimp = ',';";
	//sys
	$jscfg .= "\n_cbase.sys.cset = '".$_cbase['sys']['cset']."';";
	$jscfg .= "\n_cbase.sys.tzone = '".$_cbase['sys']['tmzone']."';"; // 时区+-12
	$jscfg .= "\n_cbase.sys.lang = '$lang';";
	$jscfg .= "\n_cbase.run.ref = '".@$_SERVER['HTTP_REFERER']."';"; // 
	$jscfg .= "\n_cbase.run.rsite = '".$_cbase['run']['rsite']."';";
	$jscfg .= "\n_cbase.run.rmain = '".$_cbase['run']['rmain']."';";
	$jscfg .= "\n_cbase.run.roots = '".$_cbase['run']['roots']."';";
	$jscfg .= "\n_cbase.run.dmtop = '".$_cbase['run']['dmtop']."';";
	//tpl
	if($tpldir=basReq::val('tpldir')){
		$tpldir = vopTpls::set($tpldir);
		if(!empty($_cbase["close_$tpldir"])){ //close-for-static-files
			die("location.href='".PATH_PROJ."?close&tpldir=$tpldir';");
		}
		$jscfg .= "\n_cbase.run.mkv = '".basReq::val('mkv')."';";
		$jscfg .= "\n_cbase.run.csname = '".vopUrl::burl()."';";
		$jscfg .= "\n_cbase.run.tpldir = '$tpldir';";
	}
	// Path  
	$jscfg .= "\n_cbase.path.cache   = '".PATH_DTMP."';"; 
	$jscfg .= "\n_cbase.path.vendor  = '".PATH_VENDOR."';"; 
	$jscfg .= "\n_cbase.path.vendui  = '".PATH_VENDUI."';"; 
	$jscfg .= "\n_cbase.path.static  = '".PATH_STATIC."';"; 
	$jscfg .= "\n_cbase.path.editor  = _cbase.path.vendui + '/edt_".@$_cbase['sys_editor']."/';"; 
	// Cookie
	$jscfg .= "\n_cbase.ck.ckpre = '".$_cbase['ck']['pre']."';";
	$jscfg .= "\n_cbase.ck.ckdomain = '".$_cbase['ck']['domain']."';";
	$jscfg .= "\n_cbase.ck.ckpath = '".$_cbase['ck']['path']."';";
	
	// Safil
	$jscfg .= "\n";
	$jscfg .= "\n_cbase.safe.safil = '".$_cbase['safe']['safil']."';";
	$jscfg .= "\n_cbase.safe.safix = '".$_cbase['safe']['safix']."';";
	#$jscfg .= "\n_cbase.safe.rnum = '".$_cbase['safe']['rnum']."';";
	#$jscfg .= "\n_cbase.safe.rspe = '".$_cbase['safe']['rspe']."';";
	$jscfg .= "\n_cbase.safil.url = '".safComm::urlStamp('init')."';";
	
	// Para
	$jscfg .= "\n"; //_cbase.para={};\n
	$jscfg .= "\n_cbase.sys_editor = '".@$_cbase['sys_editor']."';";
	$jscfg .= "\n_cbase.sys_open = ".(empty($_cbase['sys_open']) ? 1 : $_cbase['sys_open']).";";
	$jscfg .= "\n_cbase.sys_pop = ".(empty($_cbase['sys_pop']) ? 1 : $_cbase['sys_pop']).";";
	$jscfg .= "\n_cbase.msg_timea = ".(empty($_cbase['sys_timea']) ? 1500 : $_cbase['sys_timea']).";";
	$jscfg .= "\n_cbase.sys_map = '".@$_cbase['sys_map']."';";
	$jscfg .= "\n";
	
	if(!empty($_GET['user'])){
		$jscfg .= "\n// js Member/Admin"; 
		$jscfg .= "\nvar _minfo={}, _mperm={}, _miadm={}, _mpadm={}; ";
		$user = usrBase::userObj('Member');
		if(!empty($user)){
			$jscfg .= "\n_minfo.userType = '".$user->userType."';";
			$jscfg .= "\n_minfo.userFlag = '".$user->userFlag."';";
			$jscfg .= "\n_minfo.uname = '".$user->usess['uname']."';";
			$jscfg .= "\n_mperm.title = '".@$user->uperm['title']."';";
		}
		$user = usrBase::userObj('Admin');
		if(!empty($user)){
			$jscfg .= "\n_miadm.userType = '".$user->userType."';";
			$jscfg .= "\n_miadm.userFlag = '".$user->userFlag."';";
			$jscfg .= "\n_miadm.uname = '".$user->usess['uname']."';";
			$jscfg .= "\n_mpadm.title = '".@$user->uperm['title']."';";
		}
	} //print_r($user->uperm);
	echo "$jscfg\n";
	
	// ***** 加载Base.js *****
	require(DIR_ROOT.'/skin/jslib/jsbase.js');
	require(DIR_ROOT.'/skin/jslib/jsbext.js'); 
	require(DIR_ROOT.'/skin/jslib/jspop.js'); 
	$flang = DIR_ROOT."/skin/jslib/jcore-$lang.js";
	if(file_exists($flang)) require($flang); 
	//print_r(basDebug::runInfo());

}elseif($act=='autoJQ'){
	
	if(preg_match("/MSIE [6|7|8].0/",$_cbase['run']['userag'])){
		require(DIR_VENDUI.'/jquery/jquery-1.x.imp_js'); 
		require(DIR_VENDUI.'/jquery/html5.imp_js'); 
	}else{
		require(DIR_VENDUI.'/jquery/jquery-2.x.imp_js');
	}
	
}elseif($act=='jsPlus'){

	require(DIR_ROOT.'/skin/jslib/jq_base.js'); 
	//require(DIR_ROOT.'/skin/jslib/jq_play.js'); 
	require(DIR_ROOT.'/skin/jslib/jq_win.js');
	//require(DIR_VENDUI.'/jquery/jq-qrcode.js');
	
// test
}elseif($act=='testInfo'){
	$pprev = isset($_SERVER["HTTP_REFERER"]) ? $_SERVER["HTTP_REFERER"] : '';
	echo "var testInfo = '$pprev';";
	echo "document.write(\"$pprev\")";
// test
}elseif($act=='testSleep'){	
	usleep(1200*1000); //usleep(200000);#暂停200毫秒，防注册机，发帖机爆力破解...
	echo "var testSleep$r = 'ts1_$r'; ";	
}elseif(empty($act)){
	exit('Empty action!');	
}

// 一次一个if()关闭,是因为可能出现类似[?act=jsTypes:cargo,brand;jsRelat:relpb;jsFields:cargo ]参数，同时执行几段代码

// 拼音tab	
if(strstr($act,'pycfgTab')){
	$pyTab = str_replace(array("\r","\n",","),"",comConvert::pycfgTab());
	echo "function pycfgTab(){return '$pyTab';}";
}
// 简繁tab	
if(strstr($act,'jfcfgTab')){
	$tab1 = comConvert::jfcfgTab('Jian');
    $tab2 = comConvert::jfcfgTab('Fan');
	echo "function jfcfgJian(){return '$tab1';}\n";
	echo "function jfcfgFan(){return '$tab2';}\n";
}
// Types	
if(strstr($act,'jsTypes')){
	$mods = exvFunc::actMods($act,'jsTypes'); 
	$moda = explode(',',$mods); 
	$done = ",";
	foreach($moda as $mod){
		if(empty($mod)) continue;
		if(strstr($done,",$mod,")) continue;
		$mcfg = glbConfig::read($mod);
		$s0 = "\nvar _{$mod}_data = ["; $gap = '';
		if(!empty($mcfg['i'])){
		foreach($mcfg['i'] as $k=>$v){
			$frame = empty($v['frame']) ? 0 : $v['frame'];
			$char = empty($v['char']) ? '' : $v['char'];
			$s0 .= "\n{$gap}['$k','$v[pid]','$v[title]',$v[deep],$frame,'$char']";
			$gap = ',';
		}}
		$s0 .= "\n]; ";
		unset($mcfg['f'],$mcfg['i']); 
		echo "var _{$mod}_cfg = ".comParse::jsonEncode($mcfg).";$s0\n\n";
		$done .= "$mod,";
	}
}
// Relat	
if(strstr($act,'jsRelat')){
	$mods = exvFunc::actMods($act,'jsRelat'); 
	$moda = explode(',',$mods); 
	$moda[] = 'relat'; 
	foreach($moda as $mod){ 
		if(empty($mod)) continue;
		//if(strstr($done,",$mod,")) continue;
		$file = DIR_DTMP."/modex/_$mod.cfg_php";
		if(is_file($file)){
			$data = file_get_contents($file);
			//$itms = comParse::jsonDecode($data); 
			echo "\nvar _{$mod}_data = $data;\n";
		}
	}
}
// Type2	
if(strstr($act,'jsType2')){
	$mods = exvFunc::actMods($act,'jsType2');
	$moda = explode(',',$mods);
	$done = ",";
	foreach($moda as $m1){
		if(empty($m1)) continue;
		if(strstr($done,",$m1,")) continue;
		echo glbConfig::read($m1,'modcm','json')."\n";
		$done .= "$m1,";
	}
}
if(strstr($act,'jsFields')){
	//扩展字段
	$mods = exvFunc::actMods($act,'jsFields'); 
	$ccfg = glbConfig::read($mods,'_c');
	//常规字段
	$cmod = basReq::val('cmod');
	$amod = array();
	if($cmod){
		${"_$mods"} = glbConfig::read($mods); 
		if($mfields = @${"_$mods"}['f']){
			foreach($mfields as $k1=>$v1){
				if(($cmod=='(a)'&&in_array($v1['type'],array('select','cbox','radio'))) || strstr($cmod,$k1)){
					$amod[$k1] = $v1;
				}
			}
		}
		if(!empty($amod)){
			$ccfg['f'] = $amod;
		}
	} //print_r($ccfg);
	foreach($ccfg as $k1=>$v1){
		foreach($v1 as $k2=>$v2){ 
			$v3 = &$ccfg[$k1][$k2]; 
			if(!in_array($v3['type'],array('select','cbox','radio'))){
				unset($ccfg[$k1][$k2]);
				continue;
			}
			foreach($v3 as $k4=>$v4){
				if(!in_array($k4,array('title','type','fmline','cfgs'))){
					unset($v3[$k4]);
				} // 'enable','etab','dbtype','dblen','dbdef','vreg','vtip','vmax','fmsize','fmtitle'
			}
			$v3['cfgs'] = str_replace(array("\r\n","\r","\n",";;"),array(";",";",";",";"),$v3['cfgs']);
	}   }  //print_r($ccfg);
	$ccfg = comParse::jsonEncode($ccfg);
	$ccfg = str_replace(array("\\/","\"}},\"",),array("/","\"}}\n,\"",),$ccfg);
	echo "\nvar _{$mods}_fields = $ccfg;\n"; //"\",\"cfgs\":\""
}



/*******************************************************************************
 File : \root\plus\ajax\cron.php 
*******************************************************************************/
<?php
$_cbase['skip']['.none.'] = true;
require(dirname(__FILE__).'/_config.php');

$tpldir = $_cbase['tpl']['tpl_dir'] = basReq::val('tpldir');
$file = basReq::val('file'); 
$static = basReq::val('static'); // 后台静态管理/保存资料
$mkv = basReq::val('mkv');
$act = basReq::val('act');
$mod = basReq::val('mod');
//$q = $_SERVER['QUERY_STRING'];
$safix = $_cbase['safe']['safix'];
$sapp = basReq::ark($safix,'sapp'); 
$skey = basReq::ark($safix,'skey','Safe4'); 

// 处理语言
$lang = isset($_GET['lang']) ? $_GET['lang'] : $_cbase['sys']['lang'];
$lang && $_cbase['sys']['lang'] = $lang;

/*
### dops/dopBase.php :: function svEnd($id,$show=1)
- $js .= basJscss::jscode(0,PATH_ROOT."/plus/ajax/cron.php?static=updkid&tpldir=$tpl&mkv=$mkv");
### jslib\jsbext.js :: function jcronRun(tpldir,mkv,reurl)
- var url = '/plus/ajax/cron.php?tpldir='+tpldir+'&mkv='+mkv+'&'+_cbase.safil.url+'&'+jsRnd();
### admin/static.php :: 
- $cronurl = PATH_ROOT."/plus/ajax/cron.php";
*/

if($static){
	$user = usrBase::userObj();
	if($user->userFlag!='Login') die('// NOT Login!');
}

if($static=='updkid'){ // 保存资料时执行
	echo "// ".vopStatic::toFile($mkv);
	die();
}elseif($static && $act=='add'){ // home,mlist,mdetail
    if($static=='home'){
        $msg = vopStatic::toFile('home'); 
        echo lang('plus.cron_res')."$msg"; 
    }elseif($static=='mlist'){
        $res = vopStatic::batList($mod,$tpldir); 
		vopStatic::showRes($res);
    }elseif($static=='mdetail'){
        $res = vopStatic::batDetail($mod,$tpldir); 
		vopStatic::showRes($res);
    }
    die();
}elseif($static && $act=='del'){
    if($static=='home'){
        $file = vopStatic::getPath('home','home',0);
		$msg = @unlink(DIR_HTML."/$file"); 
        echo $msg ? lang('plus.cron_ok')."$file!" : lang('plus.cron_err')."$file!"; 
    }elseif($static=='mlist'){
        $res = vopStatic::delList($mod,$tpldir); 
		vopStatic::showRes($res);
    }elseif($static=='mdetail'){
        $res = vopStatic::delDetail($mod,''); 
		vopStatic::showRes($res);
    }
    die();
}elseif(!empty($sapp) && !empty($skey) && !empty($file)){ // 指定计划任务
	$ocfgs = glbConfig::read('outdb','ex');
    $f1 = $sapp==$ocfgs['sign']['sapp'];
	$f2 = $skey==$ocfgs['sign']['skey'];
	$chk = ($f1 && $f2) ? '' : 'error'; 
}else{ // jcronRun-执行
	$chk = safComm::urlStamp('flag',90);
	$file = ''; //避免恶意执行
}

$chk && die("$chk"); //error
$cron = new extCron($file); 

if($mkv){
    if(vopStatic::chkNeed($mkv)){
        echo "// ".vopStatic::toFile($mkv);
    }    
}




/*******************************************************************************
 File : \root\plus\ajax\exdb.php 
*******************************************************************************/
<?php
$_cbase['skip']['.none.'] = true;
require(dirname(__FILE__).'/_config.php');
$ocfgs = glbConfig::read('outdb','ex');

$safix = $_cbase['safe']['safix']; 
$sapp = basReq::ark($safix,'sapp'); 
$skey = basReq::ark($safix,'skey','Safe4');
$act = basReq::val('act','pull'); //pull,show,psyn,crawl,oimp,
$method = 'exd'.ucfirst($act);

if(!empty($sapp) && !empty($skey)){
	$f1 = $sapp==$ocfgs['sign']['sapp'];
	$f2 = $skey==$ocfgs['sign']['skey'];
	$chk = ($f1 && $f2) ? '' : 'error';
}else{
	$chk = safComm::urlStamp('flag',90);
}
$chk && die("$chk"); //error
$mod = basReq::val('mod');
$debug = basReq::val('debug'); //links,field
$sysid = basReq::val('sysid');
$job = basReq::val('job');


/*

*/


new exaCrawl(); //加载采集/导入扩展方法
$exd = new exdFunc($mod); 
if(in_array($act,array('pull','show'))){ 
	$res = $exd->$method();
	echo $res;
}elseif(in_array($act,array('oimp','crawl')) && !empty($debug)){
	$jcfg = exdBase::getJCfgs($act,$job);
	$method = "{$method}_Debug";
	$res = $exd->$method($jcfg,$debug); 
	$exd->showBug($res,$exd,$debug);
}elseif(in_array($act,array('oimp','crawl','crawl')) && !empty($sysid)){
	$jcfg = exdBase::getJCfgs($act,$job);
	$method = "{$method}_Update";
	$res = $exd->$method($jcfg,$sysid); 
	$exd->showRes($res);
}elseif(in_array($act,array('psyn','oimp','crawl'))){
	$jcfg = exdBase::getJCfgs($act,$job);
	$res = $exd->$method($jcfg);
	$exd->showRes($res);
}




/*******************************************************************************
 File : \root\plus\ajax\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\plus\ajax\jshow.php 
*******************************************************************************/
<?php
define('RUN_JSHOW', 1);
$_cbase['skip']['.none.'] = true;
require(dirname(__FILE__).'/_config.php');
vopTpls::set(basReq::val('tpldir'));
glbHtml::head();

$q = $_SERVER['QUERY_STRING'];
parse_str($q,$a);
$_cbase['run']['mkv'] = basReq::val('mkv');

$sfie = array(); $scnt = array();
$stag = '';  $sadv = ''; 
foreach($a as $k=>$v){
	//$k = basStr::filKey($k,"-._@:");
	//echo "\n<hr>$k:$v<hr>\n\n";
	if(strstr($k,'jsid_tags_')){ 
		$re = tagCache::jsTag($k,$_cbase['run']['mkv'],$v);
		$stag .= "jtagRep('$k','$re');\n"; 
	}elseif(strstr($k,'jsid_advs_')){
		$sadv .= "jsElm.jeID('$k').innerHTML='".tagCache::showAdv($v)."';\n";
	}elseif(strstr($k,'jsid_field_')){ 
		$sfie[substr($k,11)] = $v;	
	}elseif(strstr($k,'jsid_count_')){
		$scnt[substr($k,11)] = $v;
	}else{ // _cbase.run.mkv,_cbase.run.csname,_rnd
		//;
	}
}

$rfie = vopCell::jsFields($sfie);
$rcnt = vopCell::jsCounts($scnt);

echo $rfie;
echo $rcnt;
echo $stag;
echo $sadv;

$jsrun = ''; //静态控制

/*
注意格式:<i id="jsid_field_news:2013-ff-dcyq:etime">0</i>中
要用[:]不能用[.] 测试代码：
$q = 'aa.bb=1&aa:bb=2'; //&path/file=3
parse_str($q,$b); print_r($b);
Array(
    [aa_bb] => 1
    [aa:bb] => 2
) */

?>


/*******************************************************************************
 File : \root\plus\ajax\pick.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php');
//safComm::urlFrom();
$_groups = glbConfig::read('groups');

glbHtml::page("Pick Data");
glbHtml::page('imadm');
glbHtml::page('body');

$mod = basReq::val('mod','','Key');
$mcfg = glbConfig::read($mod); 
if(empty($mcfg['f'])) { die("Error1 [$mod]!"); }
$_key = substr($mcfg['pid'],0,1).'id'; if($_key=='uid') $_key='uname';
$mfso = dopFunc::vgetFields($mcfg['f']); 
if($_key=='uname'){
	$mcfg['f']['uname'] = $mcfg['f']['mname'];	
	$mcfg['f']['uname']['title'] = lang('plus.pick_uname');
}

$fso = basReq::val('fso','title,company,uname,mname,mtel,memail','Title'); 
$ford = basReq::val('ford','click','Title'); 
$fshow = basReq::val('fshow','title,company,mname,uname,click,mtel,memail','Title'); 
$fso = dopFunc::vchkFields($fso,dopFunc::vgetFields($mcfg['f'],'input,select','varchar'));
$ford = dopFunc::vchkFields($ford,dopFunc::vgetFields($mcfg['f'],'input,select','int,float'));
$fshow = dopFunc::vchkFields($fshow,dopFunc::vgetFields($mcfg['f'],'all','all'));
if(count($fshow)>4) $fshow = array_slice($fshow,0,4); //$cshow = basReq::val('cshow','5','N');
$ford = dopFunc::vordFields($ford);

$cntre = basReq::val('cntre','1','N'); if($cntre<1) $cntre = 1;
$retitle = basReq::val('retitle','','Title'); if(empty($retitle)) $retitle = key($fshow); 
$refval = basReq::val('refval','','Title');
$refname = basReq::val('refname','','Title');

$msg = ''; //echo "$retitle,$refval,$refname ;"; //print_r($mcfg);
//print_r($fso); print_r($ford); print_r($fshow);

$cfg = $mcfg + array(
	'sofields'=>$fso,
	'soorders'=>$ford,
);
if(in_array($mcfg['pid'],array('advs','docs'))) $cfg['typfid'] = 'catid';
if(in_array($mcfg['pid'],array('user'))) $cfg['typfid'] = 'grade';
$dop = new dopExtra(glbDBExt::getTable($mod),$cfg); 
$so = $dop->so; 
$cv = $dop->cv; 

$sbar = $_key=='cid' ? '' : "\n".$so->Type(90,$_key=='uname' ? lang('plus.pick_xgrd') : lang('plus.pick_xcat'));
$sbar .= "\n&nbsp; ".$so->Word(80,80,lang('plus.pick_xso'),$dop->sofields);
if(!empty($dop->soarField)){
	$sbar .= "\n&nbsp; $dop->soarMsg:".$so->Area(1,50,$dop->soarField);
}
$sbar .= "\n&nbsp; ".$so->Order($dop->soorders,100,lang('plus.pick_xord'),'-1');
$dop->so->Form($sbar,$msg,5);
	
glbHtml::fmt_head('fmlist',"?",'tblist');
echo "<th nowrap>".lang('plus.pick_select')."</th>";
$tname = $_key=='cid' ? '' : ($_key=='uname' ? lang('plus.pick_grade') : lang('plus.pick_catalog'));
$colspan = $_key=='cid' ? 1 : 2;
if($tname) echo "<th nowrap>$tname</th>";
foreach($fshow as $k=>$v){ echo "<th nowrap>$v</th>"; }
echo "</tr>\n";	
$idfirst = ''; $idend = ''; 
if($rs=$dop->getRecs('',$_cbase['show']['ppsize'])){ 
	foreach($rs as $r){ 
	  $kid = $r[$_key]; 
	  if($cntre==1){
		   $select = "<input onClick='pickOne(this)' name='fs[$kid]' type='radio' class='rdcb' />";
	  }else{
		   $select = "<input onClick='return pickMul(this)' name='fs[$kid]' type='checkbox' class='rdcb' />"; 
	  } 
	  $select = "<td class='tc'>$select</td>\n";
	  echo "<tr>\n".$select;
	  if($tname) echo $cv->Types($r[$_key=='uname' ? 'grade' : 'catid']);
	  foreach($fshow as $k=>$v){
		if(in_array($k,array('title','company'))){
			$val = $cv->Title($r,0,$k,"",32);
		//}elseif(){
			//.$cv->TKeys($r,$td=0,'mfron',12,'-').
		}else{ //$cv->Time($r['etime'],0) $cv->Types($r['catid']); $cv->Show($r['show']);
			$val = $r[$k];
		}
		$class = in_array($k,array('title','company')) ? 'tl' : 'tc';
		$id = $k==$retitle ? "id='{$k}_$kid'" : '';
		echo "<td class='$class' $id>$val</td>\n";
	  }
	  echo "</tr>";
	}
	$pg = $dop->pg->show($idfirst,$idend);
	$now = $cntre==1 ? '' : lang('plus.pick_selected')."【<span id='sel_cnt'>0</span>】".lang('plus.pick_selunit');
	dopFunc::pageBar($pg,"$now &nbsp; <span id='sel_msg' onClick='popClose();'>【".lang('plus.pick_close')."】</span>",'0',$cntre==1 ? '' : 'pickAll');
}else{
	echo "\n<tr><td class='tc' colspan='".(count($fshow)+$colspan)."'>".lang('plus.pick_nodata')."</td></tr>\n";
}
glbHtml::fmt_end(array("mod|$mod"));

echo basJscss::jscode("var pick_retitle='$retitle', pick_refval='$refval', pick_refname='$refname', pick_max=$cntre; pickInit($cntre); ");
glbHtml::page('end'); 




/*******************************************************************************
 File : \root\plus\ajax\redir.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php');

$qstr = $_SERVER['QUERY_STRING'];
// advs:mod.key

if(strpos($qstr,':')>0){
	$a = explode(':',$qstr);
	$act = $a[0];
	$mkv = $a[1];
}else{
	$act = 'defdir';
	$mkv = $qstr;
}
if(strpos($mkv,'.')>0){
	$a = explode('.',$mkv);
	$mod = $a[0];
	$kid = $a[1];
}else{
	$mod = '';
	$kid = $mkv;
} //echo "$act:$mkv; $mod:$kid<hr>";

// lang:cn:&recbl=redir
if($act=='lang'){ 

	$recbk = basReq::val('recbk',@$_SERVER["HTTP_REFERER"]);
	$lang = $mkv;
	$flang = DIR_CODE."/lang/kvphp/core-$lang.php";
	file_exists($flang) && comCookie::oset('lang',$lang,30*86400); 
	if($recbk && !strpos($recbk,'plus/ajax/redir.php')){
		header("Location: $recbk");
	}else{
		die("::$flang:$recbk::");
	}

// /root/plus/ajax/redir.php?news.2015-a1-fhh1
// /index.php?indoc.1234-56-7890
}elseif($act=='defdir'){ 
	
	$mods = array('indoc');
	if(in_array($mod,$mods)){
		if(basEnv::isWeixin() || basEnv::isMobile()){
			$tpl = 'mob';
		}else{
			$tpl = 'umc';	
		}
	}else{
		$sdirs = vopTpls::etr1('show'); 
		$tpl = $_cbase['tpl']['tpl_dir'] = $sdirs['_defront_'];
		$hid = $sdirs['_hidden_'];
		unset($sdirs['_defront_'],$sdirs['_deadmin_'],$sdirs['_hidden_']);
		foreach($sdirs as $k=>$v){ 
			if(in_array($mod,$v)){
				$tpl = $k;
				break;
			}
		} 
	} 
	$url = vopUrl::fout("$tpl:$mod.$kid"); 
	if(strpos($url,'close#')) basMsg::show("$mod,$kid,$tpl<br>$url",'die');
	header("Location: $url"); 
	
// /root/plus/ajax/redir.php?advs:iaw7EyA9Qyo3q9mrqzwsSvaCEfXGEQe3KVaBiO67KvpHEt6riyXREyJH0du
}elseif($act=='advs'){
	
	//$mkv = basReq::val('mkv');
	$mkv = explode(',',comConvert::sysBase64($mkv,'de'));
	$mod = $mkv[0];
	$aid = @$mkv[1];
	$url = @$mkv[2];
	if(empty($mod) || empty($aid) || empty($url)){
		exit("Error: [$mod,$aid,$url]");
	}else{
		$db = glbDBObj::dbObj();
		$db->query("UPDATE ".$db->table("advs_$mod",2)." SET click=click+1 WHERE aid='$aid'");
		header("Location: $url");	
	}
	//check,click,dir

// /index.php?dir.yscode
}elseif($act=='dir'){
	
	//die($mkv);
	$redir = glbConfig::read('ujump','ex');
	$redir = $redir['redir'];
	if(isset($redir[$mkv])){
		header("Location: ".$redir[$mkv]);
	}//else{ die('xxx'); }
	//header("Location: $url");

}else{ //其实无这种情况
	
	exit('Empty action!');
	
}

die();

/*
//safComm::urlFrom();
//glbHtml::head('html');

$db = glbDBObj::dbObj();
$act = basReq::val('act','chkVImg'); 
$mod = basReq::val('mod','','Key'); //basStr::filKey('');
$kid = basReq::ark('fm','kid','Key'); //echo $mod.':'.$kid;
$uid = basReq::ark('fm','uid','Key'); //echo $mod.':'.$uid;
$_groups = glbConfig::read('groups');

*/



/*******************************************************************************
 File : \root\plus\ajax\vimg.php 
*******************************************************************************/
<?php
$_cbase['skip']['error'] = true;
require(dirname(__FILE__).'/_config.php'); 

safComm::urlFrom();
$mod = basReq::val('mod');
if(in_array($mod,array('(istest)','(emtel)','qrShow','qrVstr','qrVauto','qrVres'))){
	//;
}else{
	safComm::urlStamp('check');
}

// - 验证码
// - tel,email
// - 二纬码

// 字体配置, 字体文件放在：'/static/media/fonts/'目录下
if($mod=='(emtel)'){
	$tta = array(
		//'anty',
		'jura',
		'lconsole',
	);
	$tab = basReq::val('code'); //empty($_cbase['ucfg']['vimg']) ? 'k' : $_cbase['ucfg']['vimg']; // 0,h,H,k
	$tab = comConvert::sysRevert($tab,1);
	//$tab = urldecode($tab); //'peace_xie@08-CMS.com';
// 显示表单qr码
}elseif($mod=='qrShow'){
	$size = basReq::val('size','5');
	$data = basReq::val('data','','Safe4',255); //echo "$data, $size";
	$level = basReq::val('level','2');
	$margin = basReq::val('margin','1');
	extQRcode::show($data, $size, $level, $margin);
	die();
	
}elseif(in_array($mod,array('qrVstr','qrVauto','qrVres'))){
	$vqr = new extQRform();
	$res = $vqr->$mod();
	if($mod=='qrVres'){
		$flag = $res[0];
		glbHtml::page(lang('plus.vimp_res'),'1'); 
		glbHtml::page('body');
		echo '<meta name="viewport" content="width=device-width, initial-scale=1">';
		$msg = '<p>'.($flag=='OK' ? lang('plus.vimp_ok') : lang('plus.vimp_err')."<br>$flag").'</p>';
		echo "<p>$msg</p>";
		foreach($res[1] as $k=>$v){ echo "<br>$k=".@$v; }
		echo "<pre>"; print_r($_GET); echo "</pre>";
		glbHtml::page('end');
	}else{
		die($res);
	}
}else{
	$tta = array(
		'avant',
		'anty',
		'bvsans',
		'jura',
		'lconsole',
	);
	usleep(200000); //暂停200毫秒，防注册机，发帖机爆力破解...
	$tab = '';
}

$ttf = $tta[mt_rand(0,count($tta)-1)];
$vcode = new comVCode($mod, $ttf, $tab);





/*******************************************************************************
 File : \root\plus\ajax\_config.php 
*******************************************************************************/
<?php
define('RUN_AJAX', 1);
$_cbase['ucfg']['lang'] = '(auto)'; 
if(!isset($_cbase['skip'])) $_cbase['skip']['_all_'] = true;
require_once(dirname(dirname(dirname(__FILE__))).'/run/_paths.php'); 



/*******************************************************************************
 File : \root\plus\api\color.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php'); 
glbHtml::page('Types Pick',1);
glbHtml::page('imin'); //adm 
?>
<style TYPE="text/css">
body, td { background:#FFF; font-size:13px;}
table {border:1px #CCC solid; margin:auto;}
td {width:8px;height:8px;border:1px #FFF solid;}
td.tab td{ font-size:8px;line-height:8px;cursor:pointer; }
td.brd {border-right:1px solid #333;border-bottom:1px solid #333;border-top:1px solid #CCC;border-left:1px solid #CCC;}
#resDemo { width:40%; height:15px; border:1px #CCC solid; }
table.brd0{ border:0px; }
input { width:60px; margin:2px; }
button {width:5em; margin:2px 1px; }
body {margin:5px 5px;padding:0px;}
</style>
<script>

var tabHex1 = new Array('0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F');
var tabHex2 = new Array('00','33','66','99','CC','FF');
var tabC216 = new Array(); var n = 0;

for(i=0;i<6;i++){
for(j=0;j<6;j++){
for(k=0;k<6;k++){
	tabC216[n] = tabHex2[i]+tabHex2[j]+tabHex2[k];
	n++; //document.writeln(' ,'+tabC216[n]);
}}}
// 显示一个单元格
function cCell(id,rgb){
	var evt = ' onMouseover="cOver(this)" onClick="cClick(\''+id+'\',this)" ';
	return '<td style="background-color:#'+rgb+'" title='+rgb+' '+evt+'>&nbsp;</td>';
}
// tab216模型
function cTab1(row,col){
  var n = 0;
  for(i=0;i<row;i++){
	document.writeln('<tr>');
	for(j=0;j<col;j++){
	   document.write(cCell(1,tabC216[n]));
	   n++;
	}
	document.write('</tr>');
  }
}
// tab (颜色立方体 调色板) 
//  每行18种颜色,一共12行,上面6行和下面6行循环规律一样,不同的是 
//  RGU颜色表示法中R的初始值不同.所以程序需要在每行结束时处理循环中变量的值,在前6行结束时 
//  初始化后6行循环的初始值.这样做带来的问题是 循环不能结束.所以必须在颜色表颜色数量达到规定 
//  个数时改变变量使循环结束. 
function cTab2(){ 
	var str=""; str += "<tr>"; 
	var i=1,R="",G="",U=""; 
	for (l=0;l<=255;l=l+51){  //列内 0-255 循环 2 次 
		for (j=0;j<=255;j=j+51){  //前6行 0-102 循环,后6行 153-255 循环 
		for (k=0;k<=255;k=k+51){  //行内 0-255 循环 
				R=toHex(j); G=toHex(k); U=toHex(l); 
				if (R.length==1){R="0"+R;} 
				if (G.length==1){G="0"+G;} 
				if (U.length==1){U="0"+U;} 
				if ((i%18)==0){j=0;} 
				str += cCell(2,R+G+U); 
				if ((i%18)==0){l=l+51;if(i<109){j=-51;}
				else{j=102;}if(i!=216){str += "</tr><tr>";}
				if(i==108){j=153;k=-51;l=0;}
			} 
			i++; 
			if (i==217){j=256;k=256;l=256;}  //共216种颜色.达到数量后终止循环 
	}}} 
	document.write(str);
} 
// (连续色调 调色板) 
function cTab3(){ 
	var str = ""; str += "<tr>"; 
	var i=1,R="",G="",U="";  
	var O=1; //表示行内序号 
	for (k=255;k>=0;k=k-51){  //行内 不变 列内  FF-00 后半截 00-FF 
	for (j=204;j>=0;j=j-102){  //行内 FF-00 先正序 
	for (l=255;l>=0;l=l-51){  //行内 不变 列内  FF-00 后半截 00-FF 
		R=toHex(j); 
		if (i>108) {G=toHex(255-k);} else {G=toHex(k);} 
		if(O>6&&O<13){U=toHex(255-l);} else {U=toHex(l);} 
		if (R.length==1){R="0"+R;} 
		if (G.length==1){G="0"+G;} 
		if (U.length==1){U="0"+U;} 
		if ((i%18)==0){j=0;} 
		str += cCell(3,R+G+U);
		if((i%18)==0){k=k-51;O=0;if(i<109){j=306;}
		else{j=357}
		if(i!=216){str += "</tr><tr>";}
		if(i==108){j=255;k=255;l=306;}} 
		i++; O++; 
		if (i==217){j=-1;k=-1;l=-1;}  //共216种颜色.达到数量后终止循环 
	}}}  
	document.write(str);
}
// (灰度 调色板) 
// FFFFFF(16777215)-000000(0)的一个循环,每次循环减去 65793 
// 与前两种不同的是 每行 21 种 色彩  
function cTaba(){ 
	var str = ""; str += "<tr>"; 
	var L=1,RGU=""; 
	for (i=16777215;i>=0;i=i-65793) { 
		RGU=toHex(i); 
		if (RGU.length==5){RGU="0"+RGU;} 
		else if (RGU.length==4){RGU="00"+RGU;} 
		else if (RGU.length==3){RGU="000"+RGU;} 
		else if (RGU.length==2){RGU="0000"+RGU;} 
		else if (RGU.length==1){RGU="00000"+RGU;} 
		str += cCell('a',RGU);
		if ((L%21)==0){if(L!=217){str += "</tr><tr>";}} 
		L++; 
	} 
	str += "<td colspan=\"17\" bgcolor=\"#D6D3CE\"></td>"; 
	document.write(str);
} 
// 灰度,纯色
function cTab6(){ 
	var n=0, q=0;
	var tabm = new Array('xx0000','00xx00','0000xx','00xxxx','xx00xx','xxxx00');
	var tabc = new Array();for(i=0;i<6;i++){tabc[i] = tabHex2[5-i];}
	for(i=0;i<6;i++){ q++;
		c = tabHex2[i]+tabHex2[i]+tabHex2[i]; 
		document.write(cCell(6,c));
	}
	var k = 0;
	for(i=0;i<6;i++){
		var m0 = tabm[i]; 
		for(j=0;j<5;j++){ q++;
			var c0 = tabc[j] ;
			c = m0.replace('xx',c0).replace('xx',c0);
			document.write(cCell(6,c));
			if(q==18) document.write('</tr><tr>');
		}
	}
} 

function btnSEnd(type){ 
  var re = resCode.value;
  if(type=='Cancel') re = '';
  if(parDoc){
  	jsElm.pdID(pcolor).value = re.replace('#','');
  	jsElm.pdID(ptitle).style.color = re;
  	jsElm.pdID(pcolor+'_pop').style.display = 'none';
  }else{
    window.returnValue = '#'+re; 
    window.close(); //alert(re);
  }
}

function setBorder(tid){ 
  tds = jsElm.jeID('tab'+(tid=='6' ? '6'  :'x')).getElementsByTagName('td');
  for(var i=0;i<tds.length;i++){
    tds[i].className = 'c';
  }
}
function setColor(v){ 
  resCode.value = '#'+v;
  resDemo.style.background = '#'+v; //backgroundColor
}
function cOut(){ 
  setColor(resRGB.replace('#',''));
}
function cOver(e){ 
  setColor(e.title);
}
function cClick(id,e){ 
  resRGB = e.title;
  setColor(resRGB);
  setBorder(id);
  e.className = 'c brd';  
}

var _tab = '3'; // 3,2,1

</script>
<?php glbHtml::page('body'); ?>
<table border="0" align="center" cellpadding="0" cellspacing="1">  
  <tr>
    <td class="tab"><!--tab-->
      <table width="230" border="0" cellpadding="0" cellspacing="0" id=tabx onMouseOut="cOut()" align="center">
        <script>
		if(_tab=='1'){cTab1(6,36)}else if(_tab=='2'){cTab2()}else{cTab3()}
        </script>
      </table>
    </td>
  </tr>
  <tr>
    <td class="tab"><!--tab-->
      <table width="230" border="0" cellpadding="0" cellspacing="0" id=tab6 onMouseOut="cOut()" align="center">
        <script>cTab6()</script>
      </table>
    </td>
  </tr>
  <tr>
    <td><!--tab-->
      <table width="230" border="0" align="center" cellpadding="0" cellspacing="1" class="brd0" >
        <tr> 
          <td nowrap style="width:30%;line-height:120%;">
            <?php lang('plus.color_org',0); ?><INPUT id=resOrg value="" />
            <br />
            <?php lang('plus.color_code',0); ?><INPUT id=resCode value="" />
          </td>
          <td align="center" id=resDemo>
          <span style="background-color:#CCC;line-height:100%; display:inline-block;"><?php lang('plus.color_now',0); ?></span>
          </td>
          <td align="right">
          <button TYPE=SUBMIT onClick="btnSEnd('OK')"><?php lang('plus.color_setok',0); ?></button><br>
          <button onClick="btnSEnd('Cancel')"><?php lang('plus.color_cancel',0); ?></button>
          </td>
        </tr>
    </table></td>
  </tr>
</table>

<script> 
var resRGB = '#00FF00';
var resCode = jsElm.jeID('resCode');
var resDemo = jsElm.jeID('resDemo');
var pcolor = urlPara('color');
var ptitle = urlPara('title');
var parDoc = parent.document;
var resOrg = jsElm.jeID('resOrg');
resOrg.value = '#'+jsElm.pdID(pcolor).value; 
try{resOrg.style.color = resOrg.value;}catch(ex){}
//alert(getRGB+':'+pcolor);
</script>
</body>
</html>



/*******************************************************************************
 File : \root\plus\api\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\plus\api\ocar.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php'); 

$act = basReq::val('act','shipfee');
safComm::urlFrom();

if($act=='shipfee'){
	glbHtml::head();
	$from = basReq::val('from','');
	$to = basReq::val('to','');
	$weight = basReq::val('weight','0.1','N');
	//echo "$from,$to,$weight";
	$data = exvOcar::shipfee($from,$to,$weight); 
	if(strlen(basReq::val('debug'))) print_r($data);
	$data = comParse::jsonEncode($data);
	die("var data = $data;");
}elseif($act=='ordstat'){
	$db = glbDBObj::dbObj();
	$ordid = basReq::val('ordid');
	$row = $db->table('plus_paylog')->where("ordid='$ordid' AND stat='success'")->find();
	$db->table('coms_corder')->data(array('ordstat'=>'paid'))->where("cid='$ordid' AND ordstat='new'")->update(); 
	die("var data = '".(empty($row) ? '' : 'YES')."'");	
}



/*******************************************************************************
 File : \root\plus\api\subdir.php 
*******************************************************************************/
<?php
$_cbase['run']['subDirs'] = '1';
require(dirname(__FILE__).'/_config.php'); 
#dump($_cbase['run']);

// ?debug,ip,cfgs,html
$qstr = $_SERVER['QUERY_STRING'];

// 获取ip,可在地址栏输入?ip用于调试
$userip = ($qstr && strpos($qstr,'.')) ? $qstr : comSession::getUIP(); //echo $ip;

#dump($qstr.$userip);
if($qstr=='nav'){

	$data = array('nav','cfgs','html','debug','121.13.197.187','121.13.197.187:debug');
	extSubdir::list($data,'1');

}elseif(in_array($qstr,array('cfgs','html'))){

	$data = extSubdir::getCfgs();
	if($qstr=='html'){
		extSubdir::list($data,'1');
	}else{
		echo comParse::jsonEncode($data);
	}

}else{

	if($qstr && strpos($qstr,':debug')){
		$qstr = 'debug';
		$userip = str_replace(':debug','',$userip);
	}
	// 获取:ip对应地址/跳转url
	$addr = extSubdir::getAddr($userip);
	$durl = extSubdir::getDurl($addr);
	if($qstr=='debug'){
		$data = array('userip'=>$userip,'addr'=>$addr,'dir_url'=>$durl,);
		extSubdir::list($data,0);
	}else{
		header("Location:$durl");  
	}

}




/*******************************************************************************
 File : \root\plus\api\types.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php'); 

glbHtml::page('Types Pick',1);
glbHtml::page('imadm'); //adm
echo basJscss::imp('/skin/jslib/search.js');
//echo basJscss::imp('/skin/jslib/search.js');
?>
<style type="text/css">
.highlight { background: green; font-weight: bold; color: white; padding: 0px 8px; }
.table { }
</style>
<script>
// id(s)对应的项目名称(s),多选-已择项目
function popNames(){
	var val=jsElm.pdID(fid).value; 
	eval("var obj=_wp."+fid2+"_obj;"); 
	var str='', cbs='<span class="c999">'+lang('adm.types_nowsels')+'</span>', gap=''; cnt=0;
	val = val.replace(new RegExp(';',"gm"),',');
	val = '(,'+val+','; // bj;bjxiaqu
	for(var i=0;i<obj.i.length;i++){
		var itm = obj.i[i]; 
		if(val.indexOf(','+itm[0]+',')>0){
			var idnow = 'xid2_inow'+itm[0];
			var act = " onClick=\"popItmCheck('"+itm[0]+"',this)\" "; 
			cbs += '<label id="'+idnow+'" class="inblock ph2"><input type="checkbox" class="rdcb" '+act+' checked="checked">';
			cbs += '<span class="c00F">'+itm[2]+'</span></label>';
			str += gap+dataNams(obj.i,itm[0]);
			gap = ', '; // &laquo; &raquo; ? ? 
			cnt++; 
		}
	}
	if(obj.n>1&&cnt>1){ str = str+' ('+lang('adm.types_nowsels',cnt)+')';}
	jsElm.pdID(fid2+'_name').value = str;
	jsElm.jeID('xid2_now').innerHTML = cbs; 
	var cbnow = jsElm.jeID('xid2_now').getElementsByTagName('label'); 
	if(obj.n>1&&cbnow.length>0) jsElm.jeID('xid2_now').style.display = ''; 
	else jsElm.jeID('xid2_now').style.display = 'none'; 
}
// 级别梯 [?顶级?湖南?郴州?永兴] &laquo; &raquo; ? ? 
function popSetp(pid,type){ // type:init,add,del
	var val=jsElm.pdID(fid).value;
	var step = jsElm.jeID('xid2_step'), str = '';
	eval("var obj=_wp."+fid2+"_obj;"); 
	if(type=='del'){ 
		var labs = step.getElementsByTagName('label');
		for(var i=0;i<labs.length;i++){
			eid = labs[i].id.toString();
			if(eid==fid2+'_nstp_'+pid){
				for(var j=0;j<10;j++){
					var e = labs[i].nextSibling;
					try{
						if(e.tagName.toLowerCase()=='label') step.removeChild(e);
						else break;
					}catch(ex){break;}
				}break;
			}
		}
	}else if(type=='add'){ 
		var aopen = " onClick=\"popList('"+pid+"','del')\" "; 
		step.innerHTML += '<label id="'+fid2+'_nstp_'+pid+'" class="wpop_step" '+aopen+'>&laquo;'+dataName(obj.i,pid)+'</label>';
	}else{ //Init
		//if(val.length==0) return;
		val = dataLays(obj.i,val); 
		var a = val.split(';'), flag = false;
		var aopen = " onClick=\"popList('"+pid+"','del')\" "; 
		str = '<label id="'+fid2+'_nstp_'+pid+'" class="wpop_step" '+aopen+'>&laquo;'+lang('adm.types_top')+'</label>';	
		for(var i=0;i<a.length-2;i++){
			var kid = a[i];
			aopen = " onClick=\"popList('"+kid+"','del')\" "; 
			str += '<label id="'+fid2+'_nstp_'+kid+'" class="wpop_step" '+aopen+'>&laquo;'+dataName(obj.i,kid)+'</label>';	
			var suns = dataSuns(obj.i,kid); 
			if(suns.i.length<=obj.mpage){  
				popList(kid,suns); 
				flag = true; 
			}
		}
		step.innerHTML = str; 
		if(!flag) popList('0');
	}
	var labs = step.getElementsByTagName('label'); //重新计算一次//隐藏
	if(labs.length>1) step.style.display = ''; 
	else step.style.display = 'none'; 
}
// pop主列表
function popList(pid,sobj){	
	var val=jsElm.pdID(fid).value;
	eval("var obj=_wp."+fid2+"_obj;"); 
	if(!sobj||isObj(sobj,'s')) var suns = dataSuns(obj.i,pid); 
	else                       var suns = sobj; 
	var data = suns.i, chkend = false;; 
	var dmin = suns.dmin==0 ? obj.dmin : suns.dmin;
	var dmax = suns.dmax==0 ? obj.dmax : suns.dmax;
	var str='', gap='', deep = 0; 
	for(var i=0;i<data.length;i++){
		var itm = data[i];
		if(dmin==dmax){ //全部为同级，按字母头显示 &&data.length>obj.mchar
			var data2 = dataLetter(data);
			var _n = 0, ch = '';
			for(var k=0;k<=26;k++){
				if(data2[k].length>0){
					_n = k+64; //ch = _n==64 ? '(首选项)' : '首字母['+String.fromCharCode(_n)+']组';
					str += '<div class="wpop_chrdiv"><span class="wpop_chrspan">['+String.fromCharCode(_n)+']</span>';
					for(var j=0;j<data2[k].length;j++){
						str += popItem(data2[k][j],obj.n,'(def)');
					}
					str += '</div>';
				}
			}
			break;
		//}else if(dmin==dmax){ //全部为同级，全部显示
			//str += popItem(itm,obj.n,'(def)');
		}else if(data.length>obj.mpage){ //(不同级别)，>1页显示个数，只显示当前子类
			if(itm[3]==dmin){ 
				if(dataNext(data,i)) str += popItem(itm,obj.n,'step');
				else str += popItem(itm,obj.n,'(def)');
			}
		}else{ //(不同级别)，<1页显示个数 ...
			if(itm[3]<dmax){ //不是最小级别，显示树型，注意判断树型结束
				if(chkend){ //判断树型结束
					str += '</span>';
					chkend = false;
				}
				str += popItem(itm,obj.n,'tree',dmin);
				if(dmax-itm[3]==1){
					str += '<span class="tree_d'+(itm[3]-dmin+2)+'">';
					chkend = true;	//树型结束标记：需要判断结束-true
				}
				if(chkend&&i==data.length-1) str += '</span>'; //判断树型结束
			}else{ //为最小级别，挨个显示
				str += popItem(itm,obj.n,'(def)');	
			}
		}
	}
	jsElm.jeID('xid2_list').innerHTML = str;
	if(sobj=='add'||sobj=='del') popSetp(pid,sobj);
}
// pop一项html --- ['yxx7','c0735','永兴县',3,0,'Y']
function popItem(itm,n,flag,deep){ // flag:def,step,tree
	var val=jsElm.pdID(fid).value; 
	var idout = 'xid2_iout'+itm[0];
	var idin = 'xid2_iin'+itm[0];
	var idcb = 'xid2_icb'+itm[0];
	var str2 = str = act = css = chk = t = '';
	var vcmp = '(,'+val.replace(';',',')+',';
	if(vcmp.indexOf(','+itm[0]+',')>=0){ 
		css = 'c00F';
		chk = ' title="'+lang('adm.types_selected')+'"';
	} //flag='tree';
	if(itm[4]==1) css = 'c666'; // 结构分类灰色
	str = '<span id="'+idin+'" class="'+css+'">'+itm[2]+'</span>';//chk
	if(n>1){ // str2在不是step下使用
		chk = css=='c00F' ? ' checked="checked"' : ''; 
		if(itm[4]==0){ //非结构分类要这个
			act = " onClick=\"popItmCheck('"+itm[0]+"',this)\" ";
			str = '<input id="'+idcb+'" type="checkbox" class="rdcb" '+act+' '+chk+'>'+str;
		}
		str = '<label class="ph0">'+str+'</label>';
	}else{ //step下使用(单选)
		if(itm[4]==0){  //非结构分类要这个
			act = " onClick=\"popSetValue('set','"+itm[0]+"')\" ";
		}
		str = '<label class="ph0" '+act+'>'+str+'</label>';
	}
	if(flag=='step'){
		act = "<span class='tree_bg tree_dA' onClick=\"popList('"+itm[0]+"','add')\" > </span>";
		str = '<span id="'+idout+'" class="inblock ph5" >'+str+act+'</span>';	
	}else if(flag=='tree'){ //jsLog(flag);
		var dot = itm[3]-deep==0 ? 'A' : 'C'; // deep=dmin
		dot = '<span class="tree_bg tree_d'+dot+'"></span>';
		str = '<span id="'+idout+'" class="tree_d'+(itm[3]-deep+1)+'">'+dot+str+'</span>';	
	}else{ //tree
		str = '<span id="'+idout+'" class="inblock ph5">'+str+'</span>';	
	}
	return str;
}
function popItmCheck(kid,e){ 
	var val=jsElm.pdID(fid).value;
	var idnow = 'xid2_inow'+kid; 
	var idin = 'xid2_iin'+kid;
	var idcb = 'xid2_icb'+kid;
	var chked = e.checked; //alert(chked);
	eval("var obj=_wp."+fid2+"_obj;");  //n=obj.n, 
	if(chked){ // Add --- 从:未选-=>选 
		var cbnow = jsElm.jeID('xid2_now').getElementsByTagName('label'); 
		if(cbnow.length>obj.n-1){
			alert(lang('adm.types_tipmaxn',obj.n)); // '提示:最多只能选['+obj.n+']个'
			jsElm.jeID(idcb).checked = false;
			return;
		}
		var act = " onClick=\"popItmCheck('"+kid+"',this)\" "; 
		cbs = '<label id="'+idnow+'" class="inblock ph2"><input type="checkbox" class="rdcb" "'+act+'" checked="checked">';
		cbs += '<span class="c00F">'+dataName(obj.i,kid)+'</span></label>';
		jsElm.jeID('xid2_now').innerHTML += cbs; 
		jsElm.jeID(idin).className = 'c00F';
		popSetValue('add',kid);
	}else{ // Del --- 从:选-=>未选
		try{ jsElm.jeID(idnow).parentNode.removeChild(jsElm.jeID(idnow)); }
		catch(ex){}
		try{ jsElm.jeID(idin).className = ''; jsElm.jeID(idcb).checked = false; }
		catch(ex){}
		popSetValue('del',kid);
	}
}
function popSetValue(type,kval){ 
	var val=jsElm.pdID(fid).value;
	if(type=='clear'){
		jsElm.pdID(fid).value = '';
		jsElm.pdID(fid2+'_name').value = ''; //alert('xx');
		$('#xid2_close').trigger("click");
	}else if(type=='add'){
		if(val.length==0) val = kval;
		else val = val+','+kval; 
		val = val.replace(',,',',');
		if(val==',') val = '';
		jsElm.pdID(fid).value = val;
		popNames();
	}else if(type=='del'){
		val = val.replace(kval+',','').replace(','+kval,'');
		val = val.replace(',,',',');
		if(val==',' || val==kval) val = '';
		jsElm.pdID(fid).value = val; 
		popNames();
	}else{ //set单选 
		eval("var obj=_wp."+fid2+"_obj;");
		jsElm.pdID(fid).value = kval; 
		jsElm.pdID(fid2+'_name').value = dataNams(obj.i,kval);
		$('#xid2_close').trigger("click");
	}
	<?php $cb=basReq::val('cb'); echo $cb ? "window.parent.$cb(kval,jsElm.pdID(fid2+'_name').value);\n" : "\n"; ?>
}
</script>
<?php glbHtml::page('body',' style="padding:3px"'); ?>
<script>
var _wp = window.parent, _pd = parent.document;
var fid = urlPara('fid'), fid2 = jsKey(fid); 
str = '<table width="100%" border="0" cellpadding="3" cellspacing="3" class="table">';
str += '<tr><td><div class="w100 cF00 hand right tr" style="padding-top:3px;">'; 
str += '<span id="xid2_clear" class="ph2" onClick="popSetValue(\'clear\')" title="'+lang('adm.types_cltip')+'">'+lang('adm.types_clear')+'</span>';
str += '<span id="xid2_close" class="ph2" onClick="popClose()" title="'+lang('adm.types_cftip')+'">'+lang('adm.types_confirm')+'</span></div>';
str += '<span id="xid2_title" class="inblock"><input name="schVal" id="schVal" type="text"></span>';
str += '<input name="bsend" type="submit" class="btn" value="'+lang('adm.types_search')+'" onclick="schDone()" /></td></tr>';
str += '<tr><td id="xid2_now" class="h180"></td></tr>';
str += '<tr><td id="xid2_step" class="h180 tr"><span class="c999">'+lang('adm.types_new')+'</span></td></tr>';
str += '<tr><td id="xid2_list" class="h180" style="padding:5px 0 0 0;border-top:1px solid #CCC;">-list-</td></tr>';
str += '</table>';
document.write(str); // Table 初始化
popNames(); // 项目名称,多选-已择项目
popSetp('0'); // 级别梯,&List
</script>
</body>
</html>



/*******************************************************************************
 File : \root\plus\api\update.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php'); 
glbHtml::head('html');

$act = basReq::val('act','sysinfo');
//safComm::urlFrom();

if($act=='version'){ // root/plus/api/update.php?act=version

	die($_cbase['sys']['ver']);

}elseif($act=='server'){ 
	
	echo updInfo::getServerInfo();

}elseif($act=='client'){
	
	$data = updInfo::getClientInfo();
	echo "document.write('".basJscss::jsShow($data, 0)."');";

}elseif($act=='nav'){ 

	foreach(array('version','server','client','nav',) as $key){
		echo " # <a href='?act=$key'>$key</a>";
	} echo " # ";
}



/*******************************************************************************
 File : \root\plus\api\userc.php 
*******************************************************************************/
<?php

//UCenter API

$post = file_get_contents('php://input'); 
print_r(@$post);

print_r(@$_GET);
print_r(@$_POST);
print_r(@$_SERVER);

?>
UC_CLIENT_VERSION


/*******************************************************************************
 File : \root\plus\api\wechat.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php'); 
//autoLoad_ys::ureg('/adpt/wechat');
//autoLoad_ys::ureg('/adpt/weuser');

//define('RUN_WECHAT','1'); 
new wexControl();




/*******************************************************************************
 File : \root\plus\api\_config.php 
*******************************************************************************/
<?php
if(!isset($_cbase['skip'])) $_cbase['skip']['_all_'] = true;
$_cbase['ucfg']['lang'] = '(auto)'; 
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php'); 

$act = basReq::val('act','view');
$frmid = basReq::val('frmid','');
$point = basReq::val('point','');
$title = basReq::val('title','');



/*******************************************************************************
 File : \root\plus\coms\add_coms.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_cfgcom.php'); 

$adeel = dirname(__FILE__)."/{$mod}.php"; 
if(file_exists($adeel)){ die("It must deel with [{$mod}.php]." ); }
$aform = dirname(__FILE__)."/{$mod}_form.php";
$asave = dirname(__FILE__)."/{$mod}_save.php";
 
if(!empty($bsend)){
	
	$re2 = safComm::formCAll('fmcomadd');
	if(!empty($re2[0])){ 
		dopCheck::headComm();
		basMsg::show(lang('plug.coms_errvcode'),'die');
	}
	
	if(file_exists($asave)){
		require($asave);
	}else{
		$dop->svPrep(); 
		$dop->svAKey();
		$dop->svPKey('add');
		$db->table($dop->tbid)->data($dop->fmv)->insert(); 
		dopCheck::headComm();
		basMsg::show(lang('plug.coms_addok',$_groups[$mod]['title']),'prClose');
	}
	
}else{
	
	if(file_exists($aform)){
		require($aform);
	}else{
		dopCheck::headComm();
		$dop->fmo = $fmo = array();
		glbHtml::fmt_head('fmcomadd',"$aurl[1]",'tbdata');
		fldView::lists($mod,$fmo);
		$dop->fmPKey(1,0,1);
		$dop->fmProp(0,1);
		glbHtml::fmae_row(lang('vcode'),"<script>fsInit('fmcomadd');</script>");
		glbHtml::fmae_send('bsend',lang('submit'),0,'tr');
	}
}





/*******************************************************************************
 File : \root\plus\coms\faqs.php 
*******************************************************************************/
<?php
$_mod = basename(__FILE__,'.php'); 
require(dirname(__FILE__).'/_cfgdoc.php'); 

if(!empty($bsend)){
	
	$re2 = safComm::formCAll('fmdocfaqs');
	if(!empty($re2[0])){ 
		dopCheck::headComm();
		basMsg::show(lang('plug.coms_errvcode'),'die');
	}

	$dop->svPrep(); 
	$dop->svAKey();
	//$dop->svPKey('add');
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	dopCheck::headComm();
	basMsg::show(lang('plug.coms_addok',$_groups[$mod]['title']),'prClose');
	
}else{
	
	dopCheck::headComm();
	$dop->fmo = $fmo = array();
	glbHtml::fmt_head('fmdocfaqs',"$aurl[1]",'tbdata'); 
	glbHtml::fmae_row(lang('flow.dops_icat'),$dop->fmType('catid').'');
	glbHtml::fmae_row(lang('flow.dops_ishow'),$dop->fmShow(),1);
	$vals = array();
	$skip = array('0','mpic','hinfo','jump','click','author','bugid','bugst');
	$mfields['detail']['fmsize'] = '480x18';
	foreach($mfields as $k=>$v){ 
		if(!in_array($k,$skip)){
			$item = fldView::fitem($k,$v,$vals);
			$item = fldView::fnext($mfields,$k,$vals,$item,$skip);
			glbHtml::fmae_row($v['title'],$item);
		}
	}
	$dop->fmAE3(1);
	glbHtml::fmae_row(lang('vcode'),"<script>fsInit('fmdocfaqs');</script>");
	glbHtml::fmae_send('bsend',lang('submit'),0,'tr');

}

/*

*/


/*******************************************************************************
 File : \root\plus\coms\gbook.php 
*******************************************************************************/
<?php
$_mod = 'gbook';
require(dirname(__FILE__).'/_cfgcom.php'); 

if(!empty($bsend)){
	
	$re2 = safComm::formCAll('fmcaddgbk');
	if(!empty($re2[0])){ 
		dopCheck::headComm();
		basMsg::show(lang('plug.coms_errvcode'),'die');
	}

	$dop->svPrep(); 
	$dop->svAKey();
	$dop->svPKey('add');
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	dopCheck::headComm();
	basMsg::show(lang('plug.coms_addok',$_groups[$mod]['title']),'prClose');
	
}else{
	
	dopCheck::headComm();
	$dop->fmo = $fmo = array();
	glbHtml::fmt_head('fmcaddgbk',"$aurl[1]",'tbdata');
		$vals = array();
		$skip = array('0','reply');
		foreach($mfields as $k=>$v){ 
			if(!in_array($k,$skip)){
				$item = fldView::fitem($k,$v,$vals);
				$item = fldView::fnext($mfields,$k,$vals,$item,$skip);
				glbHtml::fmae_row($v['title'],$item);
			}
		}
	$dop->fmPKey(1,0,1);
	$dop->fmProp(0,1);
	glbHtml::fmae_row(lang('vcode'),"<script>fsInit('fmcaddgbk');</script>");
	glbHtml::fmae_send('bsend',lang('submit'),0,'tr');

}




/*******************************************************************************
 File : \root\plus\coms\inread.php 
*******************************************************************************/
<?php
$_mod = 'inread';
require(dirname(__FILE__).'/_cfgcom.php'); 

# setting
$gap = 5; //5分钟间隔
$mod = 'inread'; $pmod = 'indoc';
$tbid = "coms_$mod";

# check
$pid = basReq::val('pid');
if(!$pid) die();
$chk = safComm::urlStamp('flag',90);
$chk && die("//$chk");

$user = usrBase::userObj('Member'); 
if($user->userFlag!='Login') die();


# read
$uname = $user->uinfo['uname'];
$pwhr = "pid='$pid' AND auser='$uname'";

$fmc = $db->table($tbid)->where($pwhr)->find(); 
if($fmc){
	if($_cbase['run']['stamp']-$fmc['etime']<$gap*60) die();
	$data = array(
		'eip' => $_cbase['run']['userip'],
		'etime' => $_cbase['run']['stamp'],
		'euser' => $uname,
		'readcnt' => $fmc['readcnt']+1,
	);
	$db->table($tbid)->data($data)->where($pwhr)->update(); 
}else{
	$kar = glbDBExt::dbAutID($tbid,'yyyy-md-','31');
	$data = array(
		'aip' => $_cbase['run']['userip'],
		'atime' => $_cbase['run']['stamp'],
		'auser' => $uname,
		'cid' => $kar[0],
		'cno' => $kar[1],
		'show'=> '1',
		'pid' => $pid,
		'readcnt' => '1',
	);	
	$db->table($tbid)->data($data)->insert(); 
}




/*******************************************************************************
 File : \root\plus\coms\mdown.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_cfgall.php');

if(!empty($mod) && !empty($kid)){

	$tab = $mod=='qarep' ? 'coms_qarep' : 'dext_faqs';
	$fid = $mod=='qarep' ? 'cid' : 'did'; 
	$info = $db->table($tab)->field('detail')->where("$fid='$kid'")->find(); 
	$detail = basStr::filForm(@$info['detail']);
	echo "<textarea cols='' rows='26' style='width:100%'>$detail</textarea>";

}




/*******************************************************************************
 File : \root\plus\coms\qarep.php 
*******************************************************************************/
<?php
$_mod = 'qarep';
require(dirname(__FILE__).'/_cfgcom.php'); 

$pinfo = dopFunc::getMinfo('faqs',$pid); //dump($pinfo);
if($pinfo['bugst']=='close'){
	basMsg::show(lang('plus.coms_closerep'),'die');
}

if(!empty($bsend)){
	
	$re2 = safComm::formCAll('fmqarep');
	if(!empty($re2[0])){ 
		dopCheck::headComm();
		basMsg::show(lang('plug.coms_errvcode'),'die');
	}

	$dop->svPrep(); 
	$dop->svAKey();
	$dop->svPKey('add');
	$db->table($dop->tbid)->data($dop->fmv)->insert(); 
	dopCheck::headComm();
	basMsg::show(lang('plug.coms_addok',$_groups[$mod]['title']),'prClose');
	
}else{

	dopCheck::headComm();
	$dop->fmo = $fmo = array();
	glbHtml::fmt_head('fmqarep',"$aurl[1]",'tbdata');
	fldView::lists($mod,$fmo);
	$dop->fmPKey(1,0,1);
	$dop->fmProp(0,1);
	glbHtml::fmae_row(lang('vcode'),"<script>fsInit('fmqarep');</script>");
	glbHtml::fmae_send('bsend',lang('submit'),0,'tr');
}





/*******************************************************************************
 File : \root\plus\coms\_cfgall.php 
*******************************************************************************/
<?php
define('RUN_COMSADD', 1);
$_cbase['ucfg']['lang'] = '(auto)'; 
#$_cbase['skip']['_all_'] = true;
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php'); 
$lang = $_cbase['sys']['lang']; 

$_groups = glbConfig::read('groups');
$db = glbDBObj::dbObj(); 

safComm::urlFrom();
extract(basReq::sysVars());
$aurl = basReq::getUri(-2);




/*******************************************************************************
 File : \root\plus\coms\_cfgcom.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_cfgall.php'); 

$act = basReq::val('act','view');
$mod = empty($mod) ? (empty($_mod) ? '' : $_mod) : $mod;
if(!$mod || !isset($_groups[$mod]) || $_groups[$mod]['pid']!='coms'){ 
	glbHtml::end(lang('flow.dops_parerr').":{$mod}");
}

$_cfg = glbConfig::read($mod); 
$dop = new dopComs($_cfg,@$_cfg['cfgs']);
$mfields = $_cfg['f'];
unset($_cfg);




/*******************************************************************************
 File : \root\plus\coms\_cfgdoc.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_cfgall.php');

$act = basReq::val('act','view');
$mod = @$_mod; 
if(!$mod || !isset($_groups[$mod]) || $_groups[$mod]['pid']!='docs'){ 
	glbHtml::end(lang('flow.dops_parerr').":{$mod}");
}

$_cfg = glbConfig::read($mod); 
$dop = new dopDocs($_cfg,@$_cfg['cfgs']);
$mfields = $_cfg['f'];
unset($_cfg);




/*******************************************************************************
 File : \root\plus\file\funcs-cn.js 
*******************************************************************************/

Lang.jfile = {

	test_name : '中文名',
	view_times : '浏览{val}次',

	now : '正在提交第[{val}]个项目…',
	all : '共[{val}]个项目提交成功！',
	null : '空项目，未提交！',
	file1 : '至少要有一个文件!',
	filem : '最多一次只能上传24个文件!',
	vpic : '图片预浏',
	expar : '扩展属性',
	pname : '标点名称',
	loop : '循环播放',
	auto : '自动播放',
	inpmtype : '请选择有效的[媒体类型]',
	inpiont : '请输入有效的[地图坐标]',
	inpmurl : '请输入有效的[媒体地址]',
	saf60 : '不支持Safari6.0以下浏览器的图片预览',
	fixfile : '仅支持[{val}]为后缀名的文件',

	test_end : 'Test-End'

};



/*******************************************************************************
 File : \root\plus\file\funcs-en.js 
*******************************************************************************/

Lang.jfile = {

	test_name : 'cn Name',
	view_times : 'Times{val}',

	now : 'Now sending No:[{val}] item...',
	all : 'All [{val}] item send OK!',
	null : 'Null item, Not send!',
	file1 : 'At least pick one file!',
	filem : 'Can only upload 24 files at a time!',
	vpic : 'Pic-View',
	expar : 'Ext-Param',
	pname : 'Piont-Name',
	loop : 'Loop-Play',
	auto : 'Auto-Play',
	inpmtype : 'Please select[Media-Type]',
	inpiont : 'Please select[Map-Piont',
	inpmurl : 'Please select[Media-Url]',
	saf60 : 'Does not support the Safari6.0 following browser picture preview',
	fixfile : 'Support only [{val}] for the suffix files',

	test_end : 'Test-End'

};



/*******************************************************************************
 File : \root\plus\file\funcs.js 
*******************************************************************************/

function batSends(init){ 
	if(init){ //初始化
		jsElm.jeID("btUpload").disabled = true;
		for(i=1;i<=4;i++){ jsElm.jeID("btn"+i).disabled = true; }
		sendCnt = $("#tdfiles div").length;
	}
	if(sendNO<sendCnt){ //提交
		var d = $("div.bat_fdiv").eq(sendNO); 
		$('.bat_delbtn').eq(sendNO).prop('disabled','disabled'); 
		var id = $(d).prop('id').replace('bidiv_',''); 
		//msg & 循环
		$('#res_msg').html(lang('jfile.now',id));
		de = 13; if(batSend1(id)) { de=300; }
		setTimeout("batSends()",de);
		sendNO++;
	}else if(deelNO<sendCnt){ //结果（单项循环）
		deelNO=sendOK=0; 
		$('#tdfiles .bat_fdiv').each(function(index) {
            var t = $(this).html(); //jsLog(index+':'+t);
			//msg & 循环
			if(t.indexOf('[OK!]')>=0) { sendOK++; deelNO++; }
			if(t.indexOf('[Error]')>=0) { deelNO++; }
			$('#res_msg').html(lang('jfile.all',sendOK));
			setTimeout("batSends()",300);
        });
	}else{ //总结果
	  $('#res_msg').html(lang('jfile.all',sendOK));
	}
}

function batSend1(id){ 
    var sDoc = $(window.frames["biifr_"+id].document); //jsLog(sImg);
	var upren = $("#upren").val();
	if($("#file1",sDoc).val().length==0) { $("#bidiv_"+id).html("[Null] "+lang('jfile.null')); }
	else { $("#upren",sDoc).val(upren); $("#fup1",sDoc).submit(); sendOK++; }
	return true;
}

function batDel1(id){
	csm = $("#tdfiles div").length;
	if(csm <=1 ){
		alert(lang('jfile.file1'));	
		return;	
	}
	$('#bidiv_'+id).remove();
}

function batAdd1(n){
	addCnt++;
	var htmp = $('#ftemp').html();
	var k = '', s = '', csm = $("#tdfiles div").length;
	for(var i=0;i<n;i++){
		if(csm+i+1 > 96){
			alert(lang('jfile.filem'));	
			break;
		}
		var k = addCnt+'_'+(i+1); 
		ihtm = htmp.replace(/(0001)/g,k);
		//ihtm = htmp.replace('='+k,'='+k+'&'+$("#upren").val());//
		s += ihtm;
	}
	$('#tdfiles').append(s); 
}

function fviShow(id,url,td){
	var idImg = jsElm.jeID(id);
	if(url){
		idImg.innerHTML = lang('jfile.vpic')+':<br>'+url+'<br><img src="' + url + '" onload="imgShow(this,210,210)" border="0" />'; 
		idImg.className = "idShow";
	}else{
		idImg.innerHTML = ''; 	
		idImg.className = "idHidden";	
	}
}

function fviPath(owFile){
	var fnPos = owFile.lastIndexOf('/')+1; 
	var fsSub = owFile.substring(fnPos,owFile.length);
	jsElm.jeID('fsName').innerHTML = fsSub;	
}

function fviPick(file,type,size){
	var p=window.parent, html='', efm;
	fviPath(file); 
	try{ // For inEditor
		if(type=='image'){
			html = '<img src="'+file+'" >';
		}else{
			html = '<a href="'+file+'">'+file+'</a>';	
		}
		p.edt_Insert(fidForPick, html);
	}catch(ex){ 
	try{ // For Select/Textarea File
		efm = p.jsElm.jeID(fidForPick); 
		if(p.jsElm.jeID(fidForPick+'show')){ //jsLog(efm);
			p.mpic_madd(fidForPick,file);
		}else{
			p.jsElm.jeID(fidForPick).value = file;
			parent.layer.close(parent.layer.getFrameIndex(window.name));
		}
	}catch(ex){ 
	/*try{ // For outEditor( file ); ??? 
		window.top.opener.SetUrl(file) ;
		window.top.close() ;
		window.top.opener.focus() 
	}catch(ex){ 
	try{ // For Select Vdo
		window.opener.fviGet(file,type,size);
	}catch(ex){
		alert("无父窗口!");
		return;
	} }*/ } }
	window.close();
}

function mediaChange(){
	var vtype = otype.value;
	jsElm.jeID('ext_flag').innerHTML = lang('jfile.expar');
	jsElm.jeID('ext').value = '';
	if(vtype=='iframe'){
		jsElm.jeID('ext_flag').innerHTML = 'xx';
		jsElm.jeID('r_ext').style.display = 'none';
	}else if(vtype=='map'){
		jsElm.jeID('ext_flag').innerHTML = lang('jfile.pname');
	}else if(vtype=='bgsnd'){
		jsElm.jeID('ext_flag').innerHTML = lang('jfile.loop');
		jsElm.jeID('ext').value = 'true';
	}else{ //
		jsElm.jeID('ext_flag').innerHTML = lang('jfile.auto');
		jsElm.jeID('ext').value = 'true';
	}
	if(vtype=='map'){
		jsElm.jeID('r_map').style.display = '';
		jsElm.jeID('r_url').style.display = 'none';
	}else{
		jsElm.jeID('r_map').style.display = 'none';
		jsElm.jeID('r_url').style.display = '';
	} // ext_flag">扩展属性
}
function mediaInsert(){
	var vtype = otype.value;
	var val = type=='map' ? jsElm.jeID('map').value : jsElm.jeID('url').value;
	if(vtype==''){ 
		alert(lang('jfile.inpmtype'));
		return;
	}
	if(vtype=='map'){
	if(val.length==0){
		alert(lang('jfile.inpiont'));
		return;
	}}else{
	if(val.length==0){
		alert(lang('jfile.inpmurl'));
		return;
	}}
	var cfg = {};
	if(jsElm.jeID('pw').value.length>0) cfg.w = jsElm.jeID('pw').value;
	if(jsElm.jeID('ph').value.length>0) cfg.h = jsElm.jeID('ph').value;
	if(jsElm.jeID('ext').value.length>0) cfg.ext = jsElm.jeID('ext').value;
	window.parent.edt_InsMedia(fidForPick,vtype,val,cfg);
}

//js本地图片预览，兼容ie[6-9]、火狐、Chrome17+、Opera11+、Maxthon3  
function PreviewImage(fileObj,imgPreviewId,divPreviewId){  
    var allowExtention=".jpg,.jpeg,.gif,.png";//允许上传文件的后缀名jsElm.jeID("hfAllowPicSuffix").value;  
    var extention=fileObj.value.substring(fileObj.value.lastIndexOf(".")+1).toLowerCase();              
    var browserVersion= window.navigator.userAgent.toUpperCase();  
    if(allowExtention.indexOf(extention)>-1){   
        if(fileObj.files){//HTML5实现预览，兼容chrome、火狐7+等  
            if(window.FileReader){  
                var reader = new FileReader();   
                reader.onload = function(e){  
                    jsElm.jeID(imgPreviewId).setAttribute("src",e.target.result);  
                }    
                reader.readAsDataURL(fileObj.files[0]);  
            }else if(browserVersion.indexOf("SAFARI")>-1){  
                alert(lang('jfile.saf60'));  
            }  
        }else if (browserVersion.indexOf("MSIE")>-1){  
            if(browserVersion.indexOf("MSIE 6")>-1){//ie6  
                jsElm.jeID(imgPreviewId).setAttribute("src",fileObj.value);  
            }else{//ie[7-9]  
                fileObj.select();  
                if(browserVersion.indexOf("MSIE 9")>-1)  
                    fileObj.blur();//不加上document.selection.createRange().text在ie9会拒绝访问  
                var newPreview =jsElm.jeID(divPreviewId+"New");  
                if(newPreview==null){  
                    newPreview =document.createElement("div");  
                    newPreview.setAttribute("id",divPreviewId+"New");  
                    newPreview.style.width = jsElm.jeID(imgPreviewId).width+"px";  
                    newPreview.style.height = jsElm.jeID(imgPreviewId).height+"px";  
                    newPreview.style.border="solid 1px #d2e2e2";  
                }  
                newPreview.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='" + document.selection.createRange().text + "')";                              
                var tempDivPreview=jsElm.jeID(divPreviewId);  
                tempDivPreview.parentNode.insertBefore(newPreview,tempDivPreview);  
                tempDivPreview.style.display="none";                      
            }  
        }else if(browserVersion.indexOf("FIREFOX")>-1){//firefox  
            var firefoxVersion= parseFloat(browserVersion.toLowerCase().match(/firefox\/([\d.]+)/)[1]);  
            if(firefoxVersion<7){//firefox7以下版本  
                jsElm.jeID(imgPreviewId).setAttribute("src",fileObj.files[0].getAsDataURL());  
            }else{//firefox7.0+                      
                jsElm.jeID(imgPreviewId).setAttribute("src",window.URL.createObjectURL(fileObj.files[0]));  
            }  
        }else{  
            jsElm.jeID(imgPreviewId).setAttribute("src",fileObj.value);  
        }           
    }else{  
        alert(lang('jfile.fixfile',allowExtention));  
        fileObj.value="";//清空选中文件  
        if(browserVersion.indexOf("MSIE")>-1){                          
            fileObj.select();  
            document.selection.clear();  
        }                  
        fileObj.outerHTML=fileObj.outerHTML;  
    }  
}  



/*******************************************************************************
 File : \root\plus\file\fview.php 
*******************************************************************************/
<?php 
require('_config.php');

$user || basMsg::show('Not Login.','die'); //未登录
$dfile = basReq::val('dfile',''); 
$cfg_dirs = glbConfig::read('urdirs','sy');
//print_r($user); die();

if($parts=='temp'){
	
	$rdir = DIR_DTMP;
	$rpath = PATH_DTMP;
	$ufix = comFiles::getTmpDir(0);
	
}elseif($parts=='now'){
	
	$rdir = DIR_URES;
	$rpath = PATH_URES; 
	if(!isset($groups[$mod]) || strlen($kid)<10){
		glbError::show('Error mod Or kid.');	
	}
	$ufix = comFiles::getResDir($mod,$kid,0);
	
}elseif(isset($cfg_dirs[$dir])){ //
	$cfg = $cfg_dirs[$dir]; 
	$rcfgs = array(
		'wrskin' => array(DIR_ROOT,PATH_ROOT),
		'static' => array(DIR_STATIC,PATH_STATIC),
	);
	$_r = $rcfgs[$cfg[1]];
	$rdir = $_r[0];
	$rpath =$_r[1]; 
	$ufix = $cfg[2];
}else{
	glbError::show('Error Path.');
}

$dmsg = ''; //处理删除
$_admPerm = usrPerm::check('pextra','edtadm'); $_admPerm = !$_admPerm;
$_upPerm = usrPerm::check('pextra','edtup'); $_upPerm = !$_upPerm;
$_delPath = in_array($parts,array('temp','now',));
$_upPath = in_array($parts,array('temp',));
if($dfile && $_admPerm && $_delPath){
	if(strstr($dfile,'./')) glbError::show('Error Path.');
	@$dre = unlink($rdir.$dfile); //var_dump($dre);
	$dmsg = $dre ? lang('plus.fv_delok') : lang('plus.fv_delng');
}
pfileHead($parts,lang('plus.fv_ftitle'));
?>

<table border='1' class='tbdata'>
  <tr>
    <td colspan="4">&nbsp;
	<?php
	$str = "";
	foreach($cfg_dirs as $k=>$v){
		if($parts==$v[0]){
			$str .= (empty($str) ? '' : ' # ')."\n<a href='fview.php?".basReq::getURep($allpars,'dir',$k)."'>$k</a>";
		}
	}
	echo $str ? $str : lang('plus.fv_nusub');
	?>
    </th>
    <th colspan="2" title="<?php lang('plus.fv_click',0); ?>"><?php lang('plus.fv_flist',0); ?></th>
  </tr>
  <tr>
    <td colspan="6">&nbsp;<?php echo "$rpath/$ufix/"; ?><span id="fsName" style="color:#00F;"><?php echo $dmsg; ?></span></td>
    <!--td colspan='2' align="center"> buttons </td-->
  </tr>
<?php 
$nFile = 0;
$nDir = 0;
$sFile = 0;
$i = 0;
?>
  <tr>
    <th nowrap><?php lang('plus.fv_tfiles',0); ?></th>
    <th width="15%" align='center' nowrap><?php lang('plus.fv_tview',0); ?></th>
    <th width="8%" align='center' nowrap><?php lang('plus.fv_tpick',0); ?></th>
    <th width="10%" align='center' nowrap><?php lang('plus.fv_tsize',0); ?></th>
    <th width="18%" align="center" nowrap><?php lang('plus.fv_tadd',0); ?></th>
    <th width="10%" align="center" nowrap><?php lang('plus.fv_tdel',0); ?></th>
  </tr>
<?php 
$re = comFiles::listDir("$rdir/$ufix");
if(!empty($re['dir'])){
foreach($re['dir'] as $file=>$v){
  $i++; //if($i>=120) { break; }
  $iSize = 0; 
  $iTime = date("Y-m-d H:i:s",$v);
  $nDir++;
?>
  <tr>
    <td nowrap><img src="<?php echo PATH_STATIC; ?>/icons/file18/folder.gif" width="18" height="18" border="0" align="absmiddle"><?php echo $file ?>/</td>
    <td align='right' nowrap>&nbsp;</td>
    <td align='right' nowrap>&nbsp;</td>
    <td align='right' nowrap><?php echo $iSize ?></td>
    <td align="center" nowrap class="txtSC"><?php echo $iTime ?></td>
    <td align="center" nowrap class="txtSC">&nbsp;</td>
  </tr>
<?php 
} }
if(!empty($re['file'])){
foreach($re['file'] as $file=>$v){
  $i++; //if($i>=120) { break; }
  $iSize = basStr::showNumber($v[1]);
  $iTime = date("Y-m-d H:i:s",$v[0]);
  $nFile++;
  $sFile += $iSize;
  $fPName = "$rpath/$ufix/$file";
  $ticon = comFiles::getTIcon($file);
  $id = $tdAct = '';
  if(strstr(".db.php.xx.xx2.xx3",$ticon['icon'])) continue;
	if($ticon['icon']=='pic'){
	  $id = str_replace('.','___',str_replace('-','_',$file));
	  $jsAct = " onmouseover=\"fviShow('$id','$fPName',this)\" onmouseout=\"fviShow('$id')\" ";
	  $fSubj = lang('plus.fv_tview'); 
	  $tdAct = $jsAct;
	}else{
	  $fSubj = lang('plus.fv_open');
	} 	
?>
  <tr>
    <td onClick="fviPick(<?php echo "'$fPName','{$ticon['type']}','$iSize'"; ?>);" title="<?php lang('plus.fv_pfile',0); ?>" nowrap>
    <img src="<?php echo PATH_STATIC."/icons/file18/{$ticon['icon']}.gif"; ?>" width="18" height="18" border="0" align="absmiddle"> <?php echo $file ?></td>
    <td align='center' nowrap><a href="<?php echo $fPName ?>" target="_blank"><?php echo $fSubj ?></a></td>
    <td align="center" nowrap style="cursor:hand;color:#0000FF; " title="<?php lang('plus.fv_pfile',0); ?>" <?php echo $tdAct ?> onClick="fviPick(<?php echo "'$fPName','{$ticon['type']}','$iSize'"; ?>);">
    <?php lang('plus.fv_tpick',0); ?><span class="idHidden" id='<?php echo $id ?>'></span></td>
    <td align='right' nowrap><?php echo $iSize ?></td>
    <td align="center" nowrap class="txtSC"><?php echo $iTime ?></td>
    <td align="center" nowrap class="txtSC">
      <?php if($_admPerm && $_delPath){ ?> 
      <a href="#" onClick="urlConfirm('?<?php echo "$allpars&dfile=/$ufix/$file" ?>','<?php echo lang('plus.fv_delq',$file); ?>')"><?php lang('plus.fv_tdel',0); ?></a>
      <?php }else{ ?>
      <span style="color:#999"><?php lang('plus.fv_tdel',0); ?></span>
      <?php } ?></td>
  </tr>
<?php
}}
?>
  <?php if($i>0){ ?>
  <tr>
    <td colspan='7' nowrap>&nbsp;
    <?php lang('plus.fv_file',0); ?>:<font color="#FF0000"><?php echo $nFile ?></font> &nbsp;
    <?php lang('plus.fv_dir',0); ?>:<font color="#FF0000"><?php echo $nDir ?> [<?php echo basStr::showNumber($sFile) ?>]</font> &nbsp;
  </td>
  </tr>
  <?php }else{ ?>
  <tr>
    <td colspan='7' nowrap> <?php lang('plus.fv_nofiles',0); ?> </td>
  </tr>
  <?php } ?>
</table>
<div style="line-height:8px;">&nbsp;</div>

<table width="99%" border='0' align="center" cellpadding='5' cellspacing='1'>
  <?php if(2==1){ ?>
  <form name="ffimg2" id="ffimg2" action="?" method="post">
    <tr>
      <td nowrap><?php lang('plus.fv_dir',0); ?>:
        <input name="Dir" type="text" id="Dir" value="<?php echo $dDir ?>" size="24" maxlength="12" Xreadonly>
        <input name=Button type=submit id="Button2" value="<?php lang('plus.fv_adddir',0); ?>" <?php echo $sDis ?>disabled>
        <input name="Act" type="hidden" id="Act" value="Dir">
        <input name="yPath" type="hidden" id="yPath" value="<?php echo $yPath ?>"> </td>
      <td align="left" nowrap>&nbsp;</td>
    </tr>
  </form>
  <?php } if($_upPerm && $_upPath){ ?>
  <form name="fup1" id="fup1" action="updeel.php?<?php echo $allpars; ?>" enctype="multipart/form-data" method="post">
    <tr>
      <td nowrap><?php lang('plus.fv_uplocal',0); ?>:
        <input name='local' type='file' id="local" class='uploc'> <?php lang('plus.fv_or',0); ?> </td>
      <td rowspan="2" valign="top" nowrap class="tl pv20"><select name="upren" id="upren">
        <option value="auto"><?php lang('plus.fv_atuoname',0); ?></option>
        <option value="keep"><?php lang('plus.fv_orgname',0); ?></option>
      </select>
      <!--input name="recbk" type="hidden" value="refview"-->
      <input name="btUpload" type=submit id="btUpload" value="<?php lang('plus.fv_upload',0); ?>"></td>
    </tr>
    <tr>
      <td nowrap><select name="uptype" class="w80"><option value="remote"><?php lang('plus.fv_rempic',0); ?></option><option value="base64"><?php lang('plus.fv_b64pic',0); ?></option></select>
        <input name='udata' type='text' id="udata" style="width:340px; "></td>
    </tr>
  </form>
  <?php } ?>
  <tr>
    <td colspan='2' class="read">
        <?php basLang::inc('uless','plus_fview'); ?>
    </td>
  </tr>
</table>
<div style='line-height:10px;'>&nbsp;</div>
<script>
var fidForPick = '<?php echo $fid; ?>';
</script>
</body>
</html>



/*******************************************************************************
 File : \root\plus\file\media.php 
*******************************************************************************/
<?php 
require('_config.php');
/*
    error_reporting(E_ERROR|E_WARNING);
    $key =htmlspecialchars($_POST["searchKey"]);
    $type = htmlspecialchars($_POST["videoType"]);
    $html = file_get_contents('http://api.tudou.com/v3/gw?method=item.search&appKey=myKey&format=json&kw='.$key.'&pageNo=1&pageSize=20&channelId='.$type.'&inDays=7&media=v&sort=s');
    echo $html;
*/
pfileHead('media',lang('plus.fop_mdtitle'));
?>

<form name="media" id="media" method="post" action="">
  <table width="80%" border="1" align="center" class="tbdata">
    <tr>
      <td width="20%" align="center"><?php lang('plus.fop_mdtype',0); ?>: </td>
      <td><select name="type" id="type" onChange="mediaChange()">
          <?php echo basElm::setOption(vopMedia::cfgTypes(),''); ?>
        </select></td>
    </tr>
    <tr id="r_url" style="display:none">
      <td align="center"><?php lang('plus.fop_mdadd',0); ?>: </td>
      <td><input type="text" name="url" id="url" class="w360"></td>
    </tr>
    <tr id="r_map" style="display:none">
      <td align="center"><?php lang('plus.fop_piont',0); ?>: </td>
      <td>
      <input id='map' name='map' type='text' value='' class='txt w300'  maxlength='36' />
      <span class='fldicon fmap' onClick="mapPick('<?php echo $_cbase['sys_map']; ?>','map',620,460);">&nbsp;</span>
      </td>
    </tr>
    <tr id="r_ext">
      <td align="center"><span id="ext_flag"><?php lang('plus.fop_expar',0); ?></span>: </td>
      <td>
      <input id='ext' name='ext' type='text' value='' class='txt w360'  maxlength='36' />
      </td>
    </tr>
    <tr>
      <td align="center"><?php lang('plus.fop_size',0); ?>: </td>
      <td><input name="pw" type="text" class="w50" id="pw">
        x
      <input type="text" class="w50" name="ph" id="ph">
       &nbsp; <?php lang('plus.fop_defsize',0); ?>(480x360)px</td>
    </tr>

    <tr>
      <td colspan="2" align="center"><input type="button" name="button" id="button" value="<?php lang('plus.fop_btnok',0); ?>" onClick="mediaInsert()">
        &nbsp;
      <input type="reset" name="button2" id="button2" value="<?php lang('plus.fop_cancel',0); ?>"></td>
    </tr>
    <tr>
      <td colspan="2"><?php lang('plus.fop_note',0); ?>: 
        &nbsp;
    </tr>
  </table>
</form>
<script>
var fidForPick = '<?php echo $fid; ?>';
var otype = jsElm.jeID('type');
</script>
</body>
</html>



/*******************************************************************************
 File : \root\plus\file\upbat.php 
*******************************************************************************/
<?php
require('_config.php'); 
usrPerm::run('pextra','edtup'); //上传权限 
pfileHead('upbat',lang('plus.fop_upbattitle'));
?>

<table border='1' class='tbdata'>
  <tr>
    <th colspan="2"><?php lang('plus.fop_batup',0); ?></th>
  </tr>
  <form name="fup1" id="fup1" action="updeel.php?<?php echo $allpars; ?>" enctype="multipart/form-data" method="post">
    <tr>
      <td nowrap class="tr"><?php lang('plus.fop_add',0); ?>:</td>
      <td nowrap class="tl" id="tdfiles"></td>
    </tr>
    <tr>
      <td nowrap class="tr"><?php lang('plus.fop_add',0); ?>:</td>
      <td nowrap class="tl">
        <input name="btn1" id="btn1" type="button" value="+1" onClick="batAdd1(1)">
        <?php lang('plus.fop_item',0); ?> &nbsp;
        <input name="btn2" id="btn2" type="button" value="+2" onClick="batAdd1(2)">
        <?php lang('plus.fop_item',0); ?> &nbsp;
        <input name="btn3" id="btn3" type="button" value="+4" onClick="batAdd1(4)">
        <?php lang('plus.fop_item',0); ?> &nbsp;
        <input name="btn4" id="btn4" type="button" value="+8" onClick="batAdd1(8)">
        <?php lang('plus.fop_item',0); ?> &nbsp; </td>
    </tr>

    <tr>
      <td nowrap class="tr"><?php lang('plus.fop_set',0); ?>:</td>
      <td nowrap class="tl"><select name="upren" id="upren">
          <option value="auto"><?php lang('plus.fv_atuoname',0); ?></option>
          <option value="keep"><?php lang('plus.fv_orgname',0); ?></option>
        </select>
        &nbsp;
        <input name="btUpload" type=submit id="btUpload" value="<?php lang('plus.fv_upload',0); ?>" onClick="batSends(1)"> <span id="res_msg"></span></td>
    </tr>
  </form>
    <tr>
      <td colspan="2" class="tl pa10 f12">
        <?php basLang::inc('uless','plus_upbat'); ?>
      </td>
    </tr>
</table>
<div id="ftemp" style="display:none">
  <div class="bat_fdiv" id="bidiv_0001">
    <input class="bat_delbtn" type="button" value="<?php lang('plus.fv_tdel',0); ?>" onClick="batDel1('0001')" >
    <iframe id='biifr_0001' name="biifr_0001" src='upone.php?isbat=0001' frameBorder=0 width='480' scrolling='no' height='32'></iframe>
  </div>
</div>
<div style='line-height:10px;'>&nbsp;</div>
<script>
var sendNO = 0;
var sendCnt = 0;
var deelNO = 0;
var sendOK = 0;
var addCnt = 0;
batAdd1(4);
</script>
</body>
</html>



/*******************************************************************************
 File : \root\plus\file\updeel.php 
*******************************************************************************/
<?php
require('_config.php'); 
usrPerm::run('pextra','edtup'); //上传权限 

$recbk = basReq::val('recbk','ref'); 
$udata = basReq::val('udata',''); 
$uptype = basReq::val('uptype','');
$uparr = array(); 
if($udata && in_array($uptype,array('remote','base64'))){
	$uparr[] = $uptype=='remote' ? $udata : 'udata';
}elseif($_FILES){
	foreach($_FILES as $k=>$v){
		if($v['name'] && $v['type']){ 
			$uparr[] = $k;
		}
	} //array_keys($_FILES);
	$uptype = 'upload';
}else{
	die(lang('plus.fop_error'));	
}
///echo "<pre>$uptype\n";print_r($uparr); //print_r($_FILES);

if($uparr){ 
	
    $ucfg = usrPerm::pmUpload($user); 
	$config = array( //上传配置
        "maxSize" => $ucfg['upsize1'], //单位KB
        "allowFiles" => $ucfg['uptypes'], //array(".gif", ".png",'.jpg')
    );
	
	$nok = $smsg = ''; 
	$sum = count($uparr);
	foreach($uparr as $k){
    //生成上传实例对象并完成上传
    	$up = new comUpload($k, $config, $uptype);
		$info = $up->getFileInfo(); 
		if($info['state']=='SUCCESS'){
			$nok++;
			$smsg .= "\\n{$info['original']} -=> ".basename($info['url'])."";
		}else{
			$smsg .= "\\n{$info['original']} -=> ".basename($info['state'])."";	
		}
	}

    if($recbk=='ref') {
		if($nok==0){
			$msg = lang('plus.fop_fupfail')."\\n$smsg";
		}else{
			$mok = $sum>1 ? ($mok==$sum ? lang('plus.fop_alln',$mok) : lang('plus.fop_alln',"$mok/$sum")) : ""; $mok = $mok ? "($mok)" : "";
			$msg = lang('plus.fop_fupok')."$mok \\n$smsg";	
		} 
		echo basJscss::Alert($msg,'Redir',basReq::getURep($_SERVER["HTTP_REFERER"],'dfile',''));
	}elseif($recbk=='pfield'){
        $cmd = $nok>0 ? "window.parent.jsElm.jeID('$fid').value='{$info['url']}';" : "alert('{$info['state']}');";
		echo basJscss::jscode("$cmd;parent.layer.close(parent.layer.getFrameIndex(window.name));"); 
	}elseif(substr($recbk,0,6)=='isbat_'){ 
        $id = substr($recbk,6);
		$cmd = $nok>0 ? " [OK!] ".lang('plus.fop_upok').":{$info['original']}" : " [Error] ".lang('plus.fop_upfail').": {$info['state']}";
		echo basJscss::jscode("window.parent.jsElm.jeID('bidiv_$id').innerHTML='[OK!] ".lang('plus.fop_upok').":{$info['original']}';"); 
    } else {
        echo json_encode($info);
    }
	
	exit(0);
}else{
	exit('Empty!');	
}

/** 得到上传文件所对应的各个参数,数组结构
[state] => SUCCESS
[url] => /08tools/yssina/1/dtmp/@udoc/4728452c2b935b3fdd531f90ad3c4c74/2015-1x-b9u53hm.jpg
[title] => 2015-1x-b9u53hm.jpg
[original] => gezi1-40x.jpg
[type] => .jpg
[size] => 1065
 */



/*******************************************************************************
 File : \root\plus\file\upone.php 
*******************************************************************************/
<?php 
require('_config.php');
$user || basMsg::show('Not Login.','die'); //未登录

$rdir = DIR_DTMP;
$rpath = PATH_DTMP;
$ufix = comFiles::getTmpDir(0);
	
//$dmsg = ''; //处理删除
$_upPerm = '1';//usrPerm::check('pextra','edtup'); $_upPerm = !$_upPerm;
$isbat = basReq::val('isbat','');

glbHtml::page(lang('plus.fop_uponetitle'),1);
glbHtml::page('imadm'); //adm
basLang::jimp("/plus/file/funcs.js");
//echo basJscss::imp("/plus/file/funcs.js",'js');
echo basJscss::imp("/plus/file/style.css");
glbHtml::page('body',' style="margin:'.($isbat ? "3px; 1px;" : "10px 5px;").'"');

?>
<table width="100%" border='0' align="center" cellpadding='1' cellspacing='3'>
  <?php if($_upPerm){ ?>
  <form name="fup1" id="fup1" action="updeel.php?<?php echo $allpars; ?>" enctype="multipart/form-data" method="post">
    <?php if($isbat){ ?>
    <tr>
      <td nowrap class="tc"><input name='file1' type='file' id="file1" class="w320" 
        onChange="PreviewImage(this,'preview','preview_wrapper');">
        <input name="recbk" type="hidden" value="isbat_<?php echo $isbat; ?>">
        <input name="upren" id="upren" type="hidden" value="auto">
      </td>
      <td nowrap class="tc"><div id="preview_wrapper">
          <div id="preview_fake"> <img id="preview" alt="(<?php lang('plus.fop_oview',0); ?>id:<?php echo $isbat; ?>)" onload="imgShow(this,120,20)"/> </div>
        </div></td>
    </tr>
    <?php }else{ ?>
    <tr>
      <td height="30" nowrap class="tl"><input name='file1' type='file' id="file1" class="w210"
        onChange="PreviewImage(this,'preview','preview_wrapper');">
        <input name="recbk" type="hidden" value="pfield"></td>
      <td rowspan="2" nowrap class="tl"><div id="preview_wrapper" style="height:60px;">
          <div id="preview_fake"> <img id="preview" alt="<?php lang('plus.fop_picview',0); ?>" onload="imgShow(this,120,60)"/> </div>
      </div></td>
    </tr>
    <tr>
      <td height="30" nowrap class="tl">
        <select name="upren" id="upren" class="w120">
          <option value="auto"><?php lang('plus.fv_atuoname',0); ?></option>
          <option value="keep"><?php lang('plus.fv_orgname',0); ?></option>
        </select>
        <input name="btUpload" type=submit id="btUpload" value="<?php lang('plus.fv_upload',0); ?>">
      </td>
    </tr>
    <?php } ?>
  </form>
  <?php }else{ echo 'Error!'; } ?>
</table>
<script>

function xx(id)
{
	var idImg = jsElm.jeID(id);
	idImg.innerHTML = ''; 	
	idImg.className="idHidden";
}

</script>
</body>
</html>



/*******************************************************************************
 File : \root\plus\file\_config.php 
*******************************************************************************/
<?php
$_cbase['ucfg']['lang'] = '(auto)'; 
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php'); 
$lang = $_cbase['sys']['lang']; 

function pfcfgParts(){
	$re = basLang::ucfg('urparts'); 
	if(strlen(basReq::val('kid','','Key'))<10){ unset($re['now']); }
	return $re;
}
function pfcfgPars($arr=1){
	$re = array(); $allpars = "";
	foreach(array('act,form','fid,content','parts,comms','dir,logo','mod,demo','kid,,Key') as $t){
		$a = explode(',',$t);
		$v = basReq::val($a[0], $a[1], empty($a[2])?'Title':$a[2]);
		$re[$a[0]] = $v;
		$allpars .= "&$a[0]=$v";
	}
	$allpars = substr($allpars,1);
	if(empty($arr)) return $allpars;
	$re['allpars'] = substr($allpars,1);
	return $re;
}

function pfileHead($parts,$title=''){
	glbHtml::page($title,1);
	glbHtml::page('imadm'); //adm
	basLang::jimp("/plus/file/funcs.js");
	#echo basJscss::imp("/plus/file/funcs.js?".time(),'js');
	echo basJscss::imp("/plus/file/style.css");
	glbHtml::page('body',' style="margin:0px 2px;"');
	$allpars = pfcfgPars(0);
	$cfg_parts = pfcfgParts();
	$cfg_dirs = glbConfig::read('urdirs','sy');
	$mod = basReq::val('mod','demo');
	$str = "\n<table class='file_bar'><tr>";
	$tmppars = basReq::getURep($allpars,'parts','{p}');
	foreach($cfg_parts as $k=>$v){ 
		$v0 = $k; $t0 = $v; 
		if(is_array($v)){ $v0 = $v[1]; $t0 = $v[0]; }
		$paras = basReq::getURep(str_replace('{p}',$k,$tmppars),'dir',$v0);
		$script = in_array($k,array('upbat','media')) ? $k : 'fview';
		$str .= "\n<td ".($parts==$k?'class="act"':'')."><a href='$script.php?".$paras."'>$t0</a></td>";
	} 
	$str .= "\n</tr></table>";
	echo $str;
}

$groups = glbConfig::read('groups');
extract(pfcfgPars(), EXTR_OVERWRITE); 

$user = usrBase::userObj(array('Admin','Member'));



/*******************************************************************************
 File : \root\plus\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\plus\map\baidu.php 
*******************************************************************************/
<?php require_once('_config.php'); ?>
<!--
http://developer.baidu.com/map/jsdemo.htm#h0_4
示例DEMO
-->
<script>
var mpoint = new BMap.Point(<?php echo "$pa[0],$pa[1]";?>);
var map = new BMap.Map("map");
map.centerAndZoom(mpoint, <?php echo $zoom;?>);
map.addControl(new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_ZOOM})); //缩放
map.addControl(new BMap.ScaleControl()); // 比例尺
map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
map.enableScrollWheelZoom();
var marker = new BMap.Marker(mpoint);  
map.addOverlay(marker); 
<?php if($act=='pick'){ ?>
marker.enableDragging(); //可拖拽
marker.addEventListener("dragend", showPoint);
function showPoint(e){
  jsElm.jeID('point').value = e.point.lng + "," + e.point.lat+','+map.getZoom(); 
}
function setPoint(){
  parent.document.getElementById('<?php echo $title;?>').value =jsElm.jeID('point').value; 
  popClose(); //window.close();
}
<?php }else{ ?>
var label = new BMap.Label("<?php echo $title;?>",{offset:new BMap.Size(20,-10)});
marker.setLabel(label);
<?php } ?>
</script>
</body>
</html>




/*******************************************************************************
 File : \root\plus\map\google.php 
*******************************************************************************/
<?php require_once('_config.php'); ?>
<!--
http://sunflowers.iteye.com/blog/743086
【zk开发】zk5.0.3中使用google 地图 v3
-->
<script>
var mpoint = new google.maps.LatLng(<?php echo "$pa[1],$pa[0]";?>);
var map = new google.maps.Map(jsElm.jeID("map"),{
	zoom:13, center:mpoint, scaleControl:true,
	navigationControlOptions:{style: google.maps.NavigationControlStyle.ZOOM_PAN},
	mapTypeId:google.maps.MapTypeId.ROADMAP
});
marker = new google.maps.Marker({
	map :  map,
	<?php if($act=='pick'){ ?>
	draggable : true,
	<?php }else{ ?>
	title : "Title",
	<?php } ?>
	position : mpoint
});
<?php if($act=='pick'){ ?>
google.maps.event.addListener(marker, "dragend", function(){
	var pstr = this.getPosition().toString();
	pstr = pstr.replace(' ','').replace('(','').replace(')','');
	var parr = pstr.split(',');
	var num1 = new Number(parr[1]);
	var num2 = new Number(parr[0]);
	jsElm.jeID('point').value = num1.toFixed(6)+','+num2.toFixed(6)+','+map.zoom; 
});
function setPoint(){
    parent.document.getElementById('<?php echo $title;?>').value =jsElm.jeID('point').value; 
    popClose(); //window.close();
}
window.onresize = function(){window.location.reload();} //jqInit('');
<?php }else{ ?>

<?php } ?>
</script>
</body>
</html>




/*******************************************************************************
 File : \root\plus\map\index.php 
*******************************************************************************/
<?php
require('_config.php'); 

glbHtml::page("{$api} ".lang('plus.map_title'),1);
glbHtml::page('imadm'); //adm
echo basJscss::imp($urls[$api],'js');
echo "<style type='text/css'>body {padding:0px; margin:0px; }\nbody, html,#map {width: 100%;height: 100%;overflow: hidden;margin:0;}</style>";
glbHtml::page('body');

?>

<?php if(@$act=='pick'){ ?>
<div id="bar" style="z-index:666;position:absolute; left:56px; top:5px; font-size:12px;">
  <?php lang('plus.map_piont',0); ?><input name="point" type="text" id="point" size="<?php echo $width; ?>" value="<?php echo $pshow;?>">
  <input type="submit" name="button" id="button" value="<?php lang('plus.map_setok',0); ?>" onClick="setPoint()">
</div>
<?php } ?>
<div id="map" style="z-index:333;"></div>

<?php
require("$api.php"); 
?>




/*******************************************************************************
 File : \root\plus\map\_config.php 
*******************************************************************************/
<?php
$_cbase['skip']['_all_'] = true;
$_cbase['ucfg']['lang'] = '(auto)'; 
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php'); 

$urls = array(
	'baidu' => 'http://api.map.baidu.com/api?v=1.4',
	'google' => 'http://www.google.cn/maps/api/js?sensor=false',
);
$api = basReq::val('api','baidu');

$act = basReq::val('act','view');
$frmid = basReq::val('frmid','');
$title = basReq::val('title','');

$point = basReq::val('point',''); 
$pa = explode(',',"$point,,");
if(empty($pa[0])) $pa[0] = 116.4040;
if(empty($pa[1])) $pa[1] = 39.9151;
//$point = "$pa[0],$pa[1]"; 
$zoom = empty($pa[2]) ? '12' : $pa[2];
$width = 6+strlen($point)*1.5; $width<36 && $width=36;

$pshow = empty($point) ? '' : "$point,$zoom";



/*******************************************************************************
 File : \root\run\adm.php 
*******************************************************************************/
<?php
define('RUN_ADMIN', 1);
$_cbase['tpl']['tpc_on']  = 0; //是否开启模板缓存
$_cbase['tpl']['tpl_dir'] = 'adm';
$_cbase['ucfg']['lang'] = '(auto)'; 
require('./_paths.php');
$vop = new vopShow(0);
$vop->run(usrAdmin::getMkv());


/*******************************************************************************
 File : \root\run\eng.php 
*******************************************************************************/
<?php
define('RUN_FRONT', 1);
//$_cbase['tpl']['tpc_on']  = 1; //是否开启模板缓存，true开启,false不开启 
$_cbase['tpl']['tpl_dir'] = 'ven';
//$_cbase['sys']['lang'] = 'en'; // 切换语言
require('./_paths.php'); 
$vop = new vopShow(); 


/*******************************************************************************
 File : \root\run\front.php 
*******************************************************************************/
<?php
define('RUN_FRONT', 1);
//$_cbase['tpl']['tpc_on']  = 1; //是否开启模板缓存，true开启,false不开启 
$_cbase['tpl']['tpl_dir'] = 'demodir';
//$_cbase['sys']['lang'] = 'cn'; // 切换语言
require('./_paths.php');  
$vop = new vopShow(); 


/*******************************************************************************
 File : \root\run\index.php 
*******************************************************************************/
<?php 
// 导入类库/导入配置
require('./_paths.php'); 
die();


// 获取ip,可在地址栏输入ip=xxxx用于调试
$userip = comSession::getUIP($nsp=''); //echo $ip;
if(!empty($_GET['ip'])) $userip = $_GET['ip']; //调试

// 获取ip对应地址
$ip = new extIPAddr();
$uaddr = $ip->addr($userip); //echo $uaddr;

// 查找需要跳转的url地址
$nurl = exvJump::getDir($uaddr);

// 调试: /index.php?ip=59.108.49.35&debug=1
if(!empty($_GET['debug'])){
    echo "userip = ($userip)<br>\n";
    echo "addr = ($uaddr)<br>\n";
    echo "dir_url = ($nurl)<br>\n";
// 获取分站数据：/index.php?sites=1
}elseif(!empty($_GET['sites'])){
    $data = exvJump::getSites();
    echo $data; //(自行根据需要修改代码...)
// 自动跳转
}else{
    header("Location:$nurl"); 
}




/*******************************************************************************
 File : \root\run\umc.php 
*******************************************************************************/
<?php
define('RUN_UMC', 1);
$_cbase['tpl']['tpc_on']  = 0;
$_cbase['tpl']['tpl_dir'] = 'umc';
$_cbase['ucfg']['lang'] = '(auto)'; 
require('./_paths.php'); 
$vop = new vopShow();


/*******************************************************************************
 File : \root\run\_paths.php 
*******************************************************************************/
<?php
// 项目(project): 访问相对根路径：注意：在根目录设置是空字符串,而不是/，非根目录前面以/开头,后面不要/
define('PATH_PROJ', '/08tools/txmao/main');
// 项目(project): 根目录
define('DIR_PROJ', dirname(dirname(dirname(__FILE__)))); 

//dirs&path : DIR_*实体路径; PATH_*访问路径
define('DIR_ROOT', DIR_PROJ.'/root'); define('PATH_ROOT', PATH_PROJ.'/root'); //web_root入口文件根目录,访问相对路径
define('DIR_CODE', DIR_PROJ.'/code'); //web_code主要流程代码目录,包含模板

define('DIR_VARS', dirname(DIR_PROJ).DIRECTORY_SEPARATOR.'vary'); define('PATH_VARS', '/08tools/txmao/vary'); //variable可变目录
define('DIR_URES', DIR_VARS.'/ures'); define('PATH_URES', PATH_VARS.'/ures'); //upload_resource上传资源文件目录,访问相对路径
define('DIR_HTML', DIR_VARS.'/html'); define('PATH_HTML', PATH_VARS.'/html'); //html_doc静态html文档目录,访问根目录
define('DIR_DTMP', DIR_VARS.'/dtmp'); define('PATH_DTMP', PATH_VARS.'/dtmp'); //dynamic_temp动态临时目录,访问根目录 

define('DIR_IMPS', dirname(DIR_PROJ).DIRECTORY_SEPARATOR.'vimp'); define('PATH_IMPS', '/08tools/txmao/vimp'); //import_root导入目录
define('DIR_VENDOR', DIR_IMPS.'/vendor'); define('PATH_VENDOR', PATH_IMPS.'/vendor'); //vendor_package第三方组件目录,访问相对路径
define('DIR_VENDUI', DIR_IMPS.'/vendui'); define('PATH_VENDUI', PATH_IMPS.'/vendui'); //vendor_ui第三方UI目录,访问相对路径
define('DIR_STATIC', DIR_IMPS.'/static'); define('PATH_STATIC', PATH_IMPS.'/static'); //static_files静态文件目录,访问相对路径	

// 运行模式，同时用于全站判断是否加载了初始化文件; 
define('RUN_MODE', 'com'); //预留几种运行模式: com,debug,setup

//加载启动文件
include(DIR_CODE.'/cfgs/boot/bootstart.php');
//echo DIR_PROJ;



/*******************************************************************************
 File : \root\run\~a3rd.php 
*******************************************************************************/
<?php

define('RUN_AJAX', 1);
$_cbase['ucfg']['lang'] = '(auto)'; 
if(!isset($_cbase['skip'])) $_cbase['skip']['_all_'] = true;
require(dirname(__FILE__).'/_paths.php'); 





/*******************************************************************************
 File : \root\run\~ajax.php 
*******************************************************************************/
<?php

define('RUN_AJAX', 1);
$_cbase['ucfg']['lang'] = '(auto)'; 
if(!isset($_cbase['skip'])) $_cbase['skip']['_all_'] = true;
require(dirname(__FILE__).'/_paths.php'); 





/*******************************************************************************
 File : \root\skin\adm\b_jscss\awtop.js 
*******************************************************************************/
if(top.location!==self.location){top.location=self.location;}
jsElm.jeID('adf_left').innerHTML = admHtmLeft + jsElm.jeID('adf_left').innerHTML;
function admJsClick(id){ 
	var _add = jsElm.ifID('adf_main').jsElm.jeID(id+'_add'); 
	if(_add){ _add.click(); }
	else{ layer.alert(lang('adm.open_nowmod_list')); } 
}
function admSetTab(id,rst){
	var a = admNavTab.split(',');
	var b = admNavName.split(',');
	for(var i=1;i<a.length;i++){ 
		var o = jsElm.jeID('left_'+a[i]); 
		o.style.display = (id==a[i]) ? '' : 'none';
		if(id==a[i]){ 
			$('#adf_title').html(b[i]); 
			if(!rst){
				var flnk = $('#left_'+a[i]+' a:first').attr('href'); 
				$('#adf_main').prop('src',flnk); 
			}
		}
	}
}
admSetTab('m1adm',1); //setTimeout("",300); 
var admReSized = 0;
function admReSize(){
  var h = (winSize().h-27)+'px';
  jsElm.jeID('adf_main').style.height = h;
  jsElm.jeID('adf_left').style.height = h;
  jsElm.jeID('adf_right').style.height = h;
}
window.onresize = function(){ admReSize(); }
if(!admReSized) admReSize();



/*******************************************************************************
 File : \root\skin\adm\b_jscss\comm-cn.js 
*******************************************************************************/

Lang.adm = {

    'open_nowmod_list' : '请定位到当前模型列表',

	'types_nowsels' : '已择:',
	'types_allitems' : '共[{val}]个项目',
	'types_top' : '顶级',
	'types_selected' : '此项目已选中',
	'types_tipmaxn' : '提示:最多只能选[{val}]个',
	'types_cltip' : 'Clear/清除',
	'types_clear' : '[清除]',
	'types_cftip' : '确定/关闭',
	'types_confirm' : '[确定]',
	'types_search' : '搜索',
	'types_new' : '当前:',

	'xxx' : 'xxx'

};



/*******************************************************************************
 File : \root\skin\adm\b_jscss\comm-en.js 
*******************************************************************************/

Lang.adm = {

    'open_nowmod_list' : 'Please Open Now Model List.',

	'types_nowsels' : 'Now:',
	'types_allitems' : 'All[{val}]Items',
	'types_top' : 'Top',
	'types_selected' : 'It is selected',
	'types_tipmaxn' : 'Tips:Max[{val}]Items',
	'types_cltip' : 'Clear/Remove',
	'types_clear' : '[Rem.]',
	'types_cftip' : 'SetOK/Close',
	'types_confirm' : '[SetOK]',
	'types_search' : 'Search',
	'types_new' : 'Now:',

	'xxx' : 'xxx'

};



/*******************************************************************************
 File : \root\skin\adm\b_jscss\comm.js 
*******************************************************************************/

function jsactMenu(menuid){
	if(!menuid){
		var a = _cbase.run.mkv.replace('.','-').split('-');
		menuid = a[0];
	}
	var e = jsElm.jeID('idf_'+menuid); 
	if(e) e.className = 'act';
}

function setEdit(disfms,hdrows,fmfix){
    if(!fmfix) fmfix = 'fm';
    var arr = new Array(disfms,hdrows);
     for(var j=0;j<arr.length;j++){
        var afm = arr[j].split(',');
        for(var i=0;i<afm.length;i++){
            var e1 = jsElm.jeID(fmfix+'['+afm[i]+']');
            var e2 = jsElm.jeID(fmfix+'_'+afm[i]+'_');
            if(j==0){
                $(e1).prop('disabled',true);
                $(e2).prop('disabled',true);
            }else{
                $(e1).parent().parent().hide();
                $(e2).parent().parent().hide();
            }
        }
     }
}

function stsetLink(e){
	var url = $(e).prop('href'); 
	//var type = $("input[name='mtype']:checked").val();
	var limit = $("input[name='limit']").val();
	var offset = $("input[name='offset']").val();
	//offset = offset.length==0 ? 0 : offset;
	url = url+'&limit='+limit+'&offset='+offset+'';
	//jsLog(type+':'+url);
	return winOpen(url,e.innerHTML);
}



/*******************************************************************************
 File : \root\skin\a_jscss\fields.js 
*******************************************************************************/

function gf_setvMust(e){
	var fmreg = jsElm.jeID('fm[vreg]').value; 
	jsElm.jeID('fm[vreg]').value = (e.value=='nul' ? 'nul:' : '')+fmreg.replace('nul:','');
}

// 变更[字段类型]后设置[字段控件]
function gf_setfmType(e){
	var val = e.value;
	var cfgs = {};
	cfgs.input = ",winpop,datetm,map"; //color,
	cfgs.text = ",editor,pics,pick";
	cfgs.hidden = ",color";
	if(val=='input' || val=='text' || val=='hidden'){
		eval('var estr = cfgs.'+val+';');
	}else{
		estr = '';
	}
	var efm = jsElm.jeID('fm[fmextra]'); 
	efm.options[0].selected = true;
	efm.options.length = 1;
	ebak = jsElm.jeID('fmextra_bak'); 
	var ops = ebak.getElementsByTagName('option');
	for(var i=1;i<ops.length;i++){
		if(estr.indexOf(ops[i].value)>0)
		efm.options.add(new Option(ebak[i].text,ebak[i].value)); 
	}
}

// 选择:参考字段
// gf_setType('world|input|winpop')
function gf_setDemoField(e){
	var a = e.split('|');
	jsElm.jeID('fm[kid]').value = a[0];
	jsElm.jeID('fm[type]').value = a[1];
	jsElm.jeID('fm[from]').value = a[0];
	gf_setfmType(jsElm.jeID('fm[type]'));
	jsElm.jeID('fm[fmextra]').value = a[2];
	jsElm.jeID('fm[etab]').value = a[3];
}

function gf_setvType(){
	var v = jsElm.jeID('fm_vtype').value;
	var v1 = jsElm.jeID('fm_vlen').value;
	var v2 = jsElm.jeID('fm[vmax]').value;
	jsElm.jeID('fm[vreg]').value = v;
	if('(str:tit:key:)'.indexOf(v)>0){ 
		jsElm.jeID('fm[vreg]').value += v1+'-'+v2;
	}else{
	  var tab = {
		tel   : '7-24',
		email : '6-255', // x@g.cn 
		uri   : '8-255', // ftp:g.cn
		file  : '7-120', // C:\f.as
		image : '8-120', // C:\f.as
	  };
	  if(v.length==0){
		jsElm.jeID('fm_vlen').value = 1;
		jsElm.jeID('fm[vmax]').value = 255;
	  }else if(v.indexOf('fix:')==0){ 
		t = v.substring(4);
		eval('str = tab.'+t+';');
		var arr = str.split('-');
		jsElm.jeID('fm_vlen').value = arr[0];
		jsElm.jeID('fm[vmax]').value = arr[1];
	  }else if('vimg:'.indexOf(v)==0){
		jsElm.jeID('fm_vlen').value = 3;
		jsElm.jeID('fm[vmax]').value = 6;
	  }else{
		jsElm.jeID('fm_vlen').value = 1;
		jsElm.jeID('fm[vmax]').value = 12;
	  }

	}
}


/*******************************************************************************
 File : \root\skin\a_jscss\i18nbar.js 
*******************************************************************************/

// 多语言翻译工具(i18n_bar)

var i18nb_apis = [
	'baidu.com(,)http://fanyi.baidu.com/transpage?query=(url)&source=url&ie=utf8&from=auto&to=(to)&render=1',
	'google.hk(,)http://translate.google.com.hk/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.tw(,)http://translate.google.com.tw/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.br(,)http://translate.google.com.br/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.au(,)http://translate.google.com.au/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.jp(,)http://translate.google.co.jp/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.uk(,)http://translate.google.co.uk/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.in(,)http://translate.google.co.in/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.fr(,)http://translate.google.fr/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.de(,)http://translate.google.de/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.ru(,)http://translate.google.ru/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.it(,)http://translate.google.it/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.ca(,)http://translate.google.ca/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)',
	'google.com(,)http://translate.google.com/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=(to)&u=(url)'
];

var i18nb_langs = [
	'Arabic(,)  ???? - 阿拉伯       (,)baidu=ar,google=ar',
	'Chinese(,) 汉语 - 中文         (,)baidu=zh,google=zh-CN',
	'English(,) (UK)Britain - 英    (,)baidu=en,google=en',
	'French(,)  Fran?ais - 法       (,)baidu=fr,google=fr',
	'Russian(,) Русский - 俄 (,)baidu=ru,google=ru',
	'Spanish(,) Espa?ol - 西班牙    (,)baidu=spa,google=es',
	'German(,)  Deutsch - 德        (,)baidu=de,google=de',
	'Japanese(,)日本Z - 日         (,)baidu=jp,google=ja',
	'Korean(,)  ??? - 韩         (,)baidu=kor,google=ko',
]; //英法俄，中阿西，德日韩

function i18nb_icfg(mod,key){
	eval("var tab = i18nb_"+mod+";");
	for(var i=0;i<tab.length;i++){
		if(tab[i].indexOf(key+'(,)')==0) return tab[i];
	}
}

function i18nb_fmturl(url){
	url = url ? url : window.location.href; //?=&
	url = url.replace('?','%3F').replace(/\&/g,'%26').replace(/\=/g,'%3D');
	return url;
}

function i18nb_ito(api,cfg){
	var a1 = api.split('.'); // google.ca 
	var a2 = cfg.split('(,)'); // 'English(,) (UK)Britain  (,)baidu=en,google=en', 
	var a3 = a2[2].split(','); 
	var to = '';
	for(var i=0;i<a3.length;i++){
		if(a3[i].indexOf(a1[0]+'=')==0){
			to = a3[i].replace(a1[0]+'=','');
			break;
		}
	}
	return to;
}

function i18nb_main(from,obj,api,url){
	obj = $('#'+obj).val();
	api = $('#'+api).val();
	if(!obj || !api) return '';
	var url = i18nb_fmturl(url);
	var tpl = i18nb_icfg('apis',api).replace(api+'(,)','');
	var to = i18nb_ito(api,i18nb_icfg('langs',obj)); 
	from = i18nb_ito(api,i18nb_icfg('langs',from));
	var re = tpl.replace('(url)',url).replace('(to)',to).replace('(from)',from);
	return re;
}

function i18nb_mui(from,obj,api,btn,cb,url){
	$('#'+btn).click(function(){
		var url = i18nb_main(from,obj,api,url);	
		cb = cb ? cb : 'i18nb_open';
		eval(cb+"('"+url+"');");
	});
	var sapis = '', slangs = '';
	for(var i=0;i<i18nb_langs.length;i++){
		var a = i18nb_langs[i].split('(,)'); if(from==a[0]) continue;
		slangs += "<option value='"+a[0]+"'>"+a[0]+" [ "+a[1].replace(/\ /g,'').replace('-',' ] ')+"</option>";
	}
	for(var i=0;i<i18nb_apis.length;i++){
		var a = i18nb_apis[i].split('(,)');
		sapis += "<option value='"+a[0]+"'>"+a[0]+"</option>";
	}
	$('#'+api).append(sapis);
	$('#'+obj).append(slangs);
}

function i18nb_open(url){
	if(url.length<12) return;
	window.open(url); //jsLog(url);
}

//http://translate.google.com.hk/translate?hl=zh-CN&ie=UTF8&prev=_t&sl=auto&tl=zh-CN&u=http://www.pswpower.com/peng/pic.asp%3FModID%3DPicS224%26TypID%3DS210052
//http://fanyi.baidu.com/transpage?query=http://www.pswpower.com/peng/pic.asp%3FModID%3DPicS224%26TypID%3DS210052&source=url&ie=utf8&from=auto&to=zh&render=1

/*
### Demo : 
<select id="i18nb_obj"><option value="">－选择语言 －</option></select>
<select id="i18nb_api"><option value="">－翻译API －</option></select>
<input id="i18nb_btn" type="button" value="翻译">
i18nb_mui('Chinese','i18nb_obj','i18nb_api','i18nb_btn'); //,'i18nb_open','http://www.xxx.com/path/test.htm'
### Note : 
*/



/*******************************************************************************
 File : \root\skin\a_jscss\mkdown.js 
*******************************************************************************/

// 替换标题或加粗isb=1,替换链接,适合<pre>里显示文本
function mkDown(data,isb){
	var darr = data.split("\n"), tmpb = '', tmpi = '';
	for(var i=0;i<darr.length;i++){
		if(darr[i].length<5){	
			//if(nuls>0) continue;
		}else{
			tmpb = tmpi = darr[i].replace(/\r/g,'');
			tmpi = mkDTitle(tmpi,isb);
			tmpi = mkDLink(tmpi);
			data = data.replace(tmpb,tmpi);
		}
	}
	return data;  
}

// ###-titles
function mkDTitle(str,isb){ 
	for(var i=7;i>0;i--){
		var fix0 = str.substring(0,i);
		fix1 = fix0.replace(/\#/g,'');
		if(fix0 && fix1==''){
			var tag = isb ? 'b' : 'h'+i;
			str = '<'+tag+'>'+str+'</'+tag+'>';	
		}
	}
	return str;
}

// a-link
function mkDLink(str, url){
	if(url){
		str = str.replace(url,"<a href='"+url+"' target='_blank'>"+url+"</a>");
	}else{
		reg = /(http:\/\/[\S]+)(?![^<]+>)/gi; 
		str = str.replace(reg,"<a href='$1' target='_blank'>$1</a>");
	}
	return str;
}



/*******************************************************************************
 File : \root\skin\a_jscss\multpic.js 
*******************************************************************************/

// 图片组操作

var mpic_cfgs = {}; 

//初始化
function mpic_minit(fmid){
	var cfg,i,a;
	cfg = mpic_data(fmid, 1); 
	$('#'+fmid+'show').html('');
	str = ''; 
	for(i=0;i<cfg.data.length;i++){
		a = cfg.data[i].split(',');
		mpic_mshow(fmid,a[0], (a.length>0 ? a[1] : ''));
		str += cfg.data[i]+';\n';
	} 
	mpic_marea(fmid,str);
}
//显示一个图(管理)
function mpic_mshow(fmid,file,val){
	var cfg,sets,pic;
	cfg = mpic_data(fmid); 
	opt = cfg.opt; 
	if(val){ 
		opt = opt.replace("value='"+val+"'","value='"+val+"' selected");	
	}
	sets = "<i class='close' title='"+lang('jcore.mpic_del')+"' onclick=\"mpic_mdel('"+fmid+"',this)\">[X]</i>"+opt;
	pic = "<div class='pitem'>"+sets+"<img src='"+file+"' width=120 height=90 onload='imgShow(this,120,90)'></div>";
	$('#'+fmid+'show').append(pic);
}
//增加一个图
function mpic_madd(fmid,file){
	var cfg, k, i, a, val;
	cfg = mpic_data(fmid); k = 0; 
	for(i=0;i<cfg.data.length;i++){
		a = cfg.data[i].split(',');
		if(a[0]==file){
			k++; break;
		}
	}
	if(!k){
		mpic_mshow(fmid,file,val);
		val = $('#'+fmid).val();
		mpic_marea(fmid,val+file+';\n');
		cfg.data.push(file);
	}else{	
		alert(lang('jcore.mpic_readd')); //jsLog('ss:'+file); 
	}
}
//删除一个图
function mpic_mdel(fmid,e){
	var itm, url, cfg, str, i, a, d;
	itm = $(e).parent(); 
	url = $(itm).find('img').attr('src'); 
	$(itm).remove(); 
	cfg = mpic_data(fmid); //jsLog(cfg);
	str = ''; d=new Array();
	for(i=0;i<cfg.data.length;i++){
		a = cfg.data[i].split(',');
		if(a[0].length>0 && a[0].indexOf(url)>=0){
			continue;
		}else{
			d.push(cfg.data[i]);
			str += cfg.data[i]+';\n';
		}
	}
	cfg.data = d;
	mpic_marea(fmid,str);
}
//设置一个图
function mpic_mset(fmid,e){
	var val,itm,url,cfg,str,d,i,a;
	val = $(e).val(); //jsLog(val);
	itm = $(e).parent(); 
	url = $(itm).find('img').attr('src');
	val = url+','+val;
	cfg = mpic_data(fmid); //jsLog(cfg);
	str = ''; d=new Array();
	for(i=0;i<cfg.data.length;i++){
		a = cfg.data[i].split(',');
		if(a[0].length>0 && a[0]==url){
			cfg.data[i] = val;
		}
		d.push(cfg.data[i]);
		str += cfg.data[i]+';\n';
	}
	cfg.data = d;
	mpic_marea(fmid,str);
}
//重设area的值
function mpic_marea(fmid,val){
	$('#'+fmid).val(val);
	$('#'+fmid).html(val);
}
//清除area的值
function mpic_clear(fmid){
	mpic_marea(fmid,''); 
	$('#'+fmid+'show').html('');
	cfg = mpic_data(fmid);
	cfg.data = new Array();
}

//显示-初始化
function mpic_view(fmid,w,h){
	var cfg,i,a,v,pic,opt,str='';
	cfg = mpic_data(fmid, 1);
	for(i=0;i<cfg.data.length;i++){
		a = cfg.data[i].split(',');
		v = a.length>0 ? a[1] : '';
		pic = "<div class='pview'><img src='"+a[0]+"' width="+w+" height="+h+" data-val='"+v+"' onload='imgShow(this,"+w+","+h+")'></div>";
		str += pic;
	}
	$('#'+fmid+'show').html(str);
	opt = cfg.opt.replace(lang('jcore.mpic_select'),lang('jcore.mpic_allitems')).replace("mpic_mset(","mpic_vtype(");
	$('#'+fmid+'out .seltype').html(opt);
	$('#'+fmid+'out .cntall').html(cfg.data.length);
}
//显示-按类别
function mpic_vtype(fmid,e){ 
	var val, n=0;
	val = $(e).val(); 
	if(val){ 
		$('#'+fmid+'show .pview').each(function(index, element) {
            if($(this).find('img:first').attr('data-val')==val){ 
				$(this).show();
				n++;
			}else{ 
				$(this).hide();
			}
        });
	}
	if(!n){
		if(val){ alert(lang('jcore.mpic_norelate')); $(e).val(''); }
		$('#'+fmid+'show .pview').show();
		n = $('#'+fmid+'show .pview').length;
	}
	$('#'+fmid+'out .cntall').html(n);
}

//初始数据
function mpic_data(fmid, rst){
	var cfg, arr, opt, str, i, re={}, c=new Array(), d=new Array();
	if(rst){
		var cfg = $('#'+fmid+'show').html();
		var str = $('#'+fmid).val();
		eval("mpic_cfgs."+fmid+" = {}; mpic_cfgs."+fmid+".cfg = cfg;");
	}
	eval("re = mpic_cfgs."+fmid+";"); 
	if(rst){
		cfg = cfg.replace(/\n/g,'').replace(/\r/g,'').replace(/ /g,'').split(';');
		arr = str.replace(/\n/g,'').replace(/\r/g,'').replace(/ /g,'').split(';'); 
		opt = "<option value=''>"+lang('jcore.mpic_select')+"</option>"; 
		for(i=0;i<cfg.length;i++){
			if(cfg[i].indexOf('|')>0){ 
				c.push(cfg[i]); a = cfg[i].split('|');
				opt += "<option value='"+a[0]+"'>"+a[1]+"</option>";
			}
		}
		for(i=0;i<arr.length;i++){
			if(arr[i].length>12) d.push(arr[i]);
		}
		re.opt = "<select onchange=\"mpic_mset('"+fmid+"',this)\">"+opt+"</select>"; 
		re.data=d; re.cfg = c; 
	}
	return re;
}

/*

*/



/*******************************************************************************
 File : \root\skin\a_jscss\sordbar.js 
*******************************************************************************/

// 搜索排序工具条(search,order,bar)
// prec=14&ptype=next&pkey=

var sordb_cfgs = {}; // a=0; b='0'; c=''; -=> f,t,f

// 初始化
// sordb_init('{$this->mod}','{$this->key}',0,'stype:brand,price;typ2:fff1,fff2',"<a href='(url)' class='(act)'>(title)</a>"); 
function sordb_init(mod,key,url,rel,tpl){ 
	var unow, stype, org, v;
	unow = window.location.href;
	stype = urlPara('stype','',unow);
	sordb_cfgs.mod = mod; 
	sordb_cfgs.stype = stype ? stype : (key ? key : ''); 
	sordb_cfgs.slay = sordb_typeLay(mod,sordb_cfgs.stype);
	if(url){
		org = url
	}else if(unow.indexOf('?mkv=')>0){ //搜索页
		org = unow; //+(stype); jsLog(unow);
	}else{ //静态, ?cargo-type
		org = _cbase.run.csname+'?mkv='+sordb_cfgs.mod+(sordb_cfgs.stype>0 ? '&stye='+sordb_cfgs.stype : '');
		if(sordb_cfgs.stype && !stype) org += "&stype="+sordb_cfgs.stype;
	}
	if(org.indexOf('?')<=0) org += '?';
	v = sordb_mftUrl(org,'order'); v = sordb_mftUrl(v,'odesc'); v = sordb_mftUrl(v,'page');
	v = sordb_mftUrl(v,'pkey'); v = sordb_mftUrl(v,'ptype'); v = sordb_mftUrl(v,'prec');
	sordb_cfgs.now = org; 
	sordb_cfgs.so = v;
	sordb_cfgs.page = sordb_mftUrl(org,'page'); //jsLog(sordb_cfgs);
	sordb_cfgs.rel = rel ? rel : '';
	sordb_cfgs.tpl = tpl ? tpl : "<a href='(url)' class='(act)'>(title)</a>"; 
}

// 搜索链接:栏目/等级
// sordb_sotype(linktpl,pid,'act','>=Clear'); pid=0,c1024等
function sordb_sotype(tpl,pid,act,clear){
	var key, dval, dlay, data;
	key = 'stype'; pid = pid ? pid : '0';
	dval = sordb_cfgs.stype; //jsLog(pid);
	dlay = sordb_typeLay(sordb_cfgs.mod,dval); 
	data = sordb_data(sordb_cfgs.mod+'-'+pid); 
	return sordb_links(tpl,key,act,clear,data,dlay);
}
// 搜索链接:扩展类别
// sordb_extype(0,'china-pid','act','-'); pid=0,gd等
function sordb_extype(tpl,keyp,act,clear){
	var a, key, dval, dlay, data;
	a = keyp.split('-'); key = a[0]; pid = a.length>0 ? a[1] : '0';
	dval = urlPara(key,''); 
	dlay = sordb_typeLay(key,dval); //jsLog(pid);
	data = sordb_data(keyp+'-'+pid); 
	return sordb_links(tpl,key,act,clear,data,dlay);
}
// 搜索链接:类别关联
// sordb_relat(linktpl,'brand-relpb-pid','act','>=(全部)'); pid=(空),c012等
function sordb_relat(tpl,keyp,act,clear){
	var a, key, dval, dlay, data;
	a = keyp.split('-'); key = a[0]; rel = a.length>0 ? a[1] : ''; pid = a.length>1 ? a[2] : '';
	dval = urlPara(key,''); 
	dlay = sordb_typeLay(key,dval); //jsLog(pid);
	data = sordb_drel(key,rel,pid);
	return sordb_links(tpl,key,act,clear,data,dlay);
	// _relpb_data
}
// 搜索链接:字段,扩展字段
// sordb_field(linktpl,'exp_s01','act','<=[Clear]');
function sordb_field(tpl,key,act,clear){
	var dval, data;
	dval = urlPara(key,''); 
	data = sordb_data(key); 
	return sordb_links(tpl,key,act,clear,data,dval);	
}
// 搜索链接:字段,所有扩展字段
// sordb_fexts('sobar',0,'act');
function sordb_fexts(barid,tpl,act,clear,tpl2){
	var key,keys,k,aprops,itm,str = '';
	if(!tpl2) tpl2 = '<p><b>(title)</b><span>(items)</span></p>';
	keys = sordb_exFields();
	if(keys.length>0){
		eval('aprops = _'+sordb_cfgs.mod+'_fields.'+sordb_cfgs.stype);
		for(k=0;k<keys.length;k++){
			itm = sordb_field(tpl,keys[k],act,clear); 
			if(itm){ 
				str += tpl2.replace('(key)',keys[k]).replace('(title)',aprops[keys[k]].title).replace('(items)',itm);
			}	
		}
	}
	$("#"+barid).append(str);	
}
// 搜索链接:数字区间
// sordb_area(linktpl,'price:10,100,200,300,500,800,1000:元','act','>=[Clear]');
function sordb_area(tpl,keyc,act,clear){
	var a, key, unt, dval, data;
	a = keyc.split(':'); key = a[0]; unt = a.length>1 ? a[2] : lang('jcore.sobar_curunit');
	dval = urlPara(key,''); 
	data = sordb_darea(a[1],unt); //jsLog(data);
	return sordb_links(tpl,key,act,clear,data,dval);
}
// 搜索链接:公用
function sordb_links(tpl,key,act,clear,data,vals){
	var re, burl, i, icfg, iurl, sact, itmp;
	if(!tpl) tpl = sordb_cfgs.tpl;
	burl = sordb_mftUrl(sordb_cfgs.so, key);
	re = ''; vals = '(,'+vals+',)'; //jsLog(vals);
	for(i=0;i<data.length;i++){
		icfg = data[i].split('=');
		if(!icfg[0] || !icfg[1]) continue; // !undefined
		iurl = burl + '&' + key + '=' + icfg[0];
		iurl = sordb_mftUrl(iurl);
		sact = vals.indexOf(','+icfg[0]+',')>0 ? act : '';
		itmp = tpl.replace('(url)',iurl).replace('(title)',icfg[1]).replace('(act)',sact);
		re += itmp+"\n";
	}
	clear = clear ? (clear=='-' ? '' : clear) : '>='+lang('jcore.sobar_all');
	if(re && clear){ 
		icfg = clear.split('='); //jsLog(icfg);
		sact = vals.replace('(null)','').length==4 ? act : ''; //jsLog(sact+':'+vals);
		itmp = tpl.replace('(url)',burl).replace('(title)',icfg[1]).replace('(act)',sact);
		re = (icfg[0]=='<' ? itmp+"\n" : '') + re + (icfg[0]=='>' ? itmp+"\n" : ''); 
	}
	return re;	
}
// 得到类别数组
function sordb_data(keyd){
	var a, key, data, pid, itm, i;
	a = keyd.split('-'); key = a[0]; 
	if(a.length==1){ // selec(字段)
		try{ 
			itm = 'data = _'+sordb_cfgs.mod+'_fields.';
			itm += (keyd.substr(0,4)=='exp_') ? sordb_cfgs.stype+'.'+key+'.cfgs;' : 'f.'+key+';';
			eval(itm); 
		}catch(ex){ data = ''; }
	}else{ // key-pid(类别-pid)
		pid = a[1]; data = ""; 
		eval("var _data = _"+key+"_data;");
		for(i=0;i<_data.length;i++){
			itm = _data[i]; 
			if(pid==itm[1]){
				data += (data.length>0 ? ';' : '')+itm[0]+"="+itm[2];
			}
		} //jsLog(data); 
	}
	return data.split(';');
}
// 得到关联数组
function sordb_drel(key,rel,pid){
	var dorg, drel, dpid, data='';
	if(pid=='(null)') return new Array('');
	eval("dorg = _"+key+"_data;");
	eval("drel = _"+rel+"_data;"); //p2012
	pdip = pid ? eval("dpid = _"+rel+"_data."+pid+";") : ','; 
	dpid = dpid ? dpid : ','; //jsLog(dpid);
	for(i=0;i<dorg.length;i++){
		itm = dorg[i]; 
		if(dpid.indexOf(','+itm[0]+',')>=0){
			data += (data.length>0 ? ';' : '')+itm[0]+"="+itm[2];
		}
	} 
	return data.split(';');
}
// 得到区间数组
function sordb_darea(cfgs,unt){
	var arr, i, data, itm, old;
	arr = cfgs.split(','); //10,100,200,300,500,800,1000
	data = '~'+arr[0]+'=<'+arr[0]+unt; 
	old = arr[0];
	for(i=1;i<arr.length;i++){
		itm = old+"~"+arr[i];
		data += (data.length>0 ? ';' : '')+itm+"="+itm+unt;
		old = arr[i];
	}
	data += ';'+old+'~=>'+old+unt; 
	return data.split(';');
}
// 排序链接
// sordb_ordby("<a href='(url)' class='(act)'>点击</a>",'clicks','oasc,odesc,ondesc,1');
// sordb_ordby("<a href='(url)' class='(act)'>默认</a>",'salse','def-act,def,(def)');
function sordb_ordby(tpl,title,by,opts){
	var burl, vby, vdesc, opts, sdesc, sact, url;
	if(!tpl) tpl = sordb_cfgs.tpl;
	burl = sordb_mftUrl(sordb_cfgs.so,by);
	vby = urlPara('order','',sordb_cfgs.now);
	vdesc = urlPara('odesc','',sordb_cfgs.now);
	opts = opts.split(','); 
	if(opts[2]=='(def)'){
		sact = vby ? opts[1] : opts[0];
	}else{
		sact = opts[2];
		sdesc = opts[3].length>0 ? '&odesc=0' : '';
		if(vby==by){
			sdesc = vdesc.length>0==0 ? '&odesc=0' : '';
			sact = vdesc.length>0==0 ? opts[1] : opts[0];
		}
		burl += '&order=' + by + sdesc;
	}
	burl = tpl.replace('(url)',burl).replace('(title)',title).replace('(act)',sact);
	return sordb_mftUrl(burl); 
}
// 类别的pid-lay关系:p1012,p2012
// btype = sordb_typeLay('china', urlPara('china','')).split(',')
function sordb_typeLay(key,val){
	var re = val ? dataLays(key,val) : '';
	return re ? re.substr(0,re.length-1).replace(/;/g,',') : '(null)';
}
// 得到所有可用扩展字段
function sordb_exFields(){
	var aprops,k2,s='',a=new Array();
	if(sordb_cfgs.stype){
		try{ eval('aprops = _'+sordb_cfgs.mod+'_fields.'+sordb_cfgs.stype); }
		catch(ex){ aprops = null; }
		if(aprops){
			for(k2 in aprops){ 
				a.push(k2);
		}   }
	}
	return a;
}
// 格式化url
function sordb_mftUrl(url,key,val,cb){
	var a,b,c,i,j,keys,k;
	url = urlRep(url,key,val);
	// mkv,stype
	// 处理关联字段:stype:brand,price;type2:fff1,fff2
	if(sordb_cfgs.rel){
		a = sordb_cfgs.rel.split(';');
		for(i=0;i<a.length;i++){
			b = a[i].split(':');
			if(b[0]==key){
				c = b[1].split(',');
				for(j=0;j<c.length;j++){
					if(c[j]=='exp_*' && sordb_cfgs.stype){
						keys = sordb_exFields();
						for(k=0;k<keys.length;k++){
							url = urlRep(url,keys[k]);
						}
					}else{
						url = urlRep(url,c[j]);
					}
			}   }
	}   }
	return cb ? eval(""+cb+"('"+url+"');") : url; 
}
// 设置链接,如果为空则隐藏相关父标签
function sordb_setLinks(key,val,tag){
	if(!tag) tag = 'p';
	if(val){
		$('#'+key).html(val); //jsLog('a:'+val);
	}else{
		//$('#'+key).parent().hide();
		$('#'+key).closest(tag).hide();
	} 
}
function sordb_hideClear(cid,css){
	var i, re, n=0, ub=',mkv,stype,page,', flag='';
	re = sordb_cfgs.so.match(new RegExp("[\?\&][^\?\&]+=[^\?\&]+","g")); 
	if(re){
		for(i = 0; i < re.length; i++){
			t = re[i].substring(1).split('='); 
			if(ub.indexOf(t[0])<=0){
				n++; break;
			}
		}         
	}
	if(!n && cid) $((css ? '.' : '#')+cid).hide();
	return n;
}

//var tpl = "<p class='tree_(lever) (key)'>(lay)<a href='(key)'>(letter)(title)</a></p>";
//tpl,key,letter,sordb_sotype(tpl,pid,act,clear) /*[　][＋][－][｜][├][└]  */
function sotree_init(tpl,key,letter,cid){ 
	var data,s='',s0,i,itm,n,b,lay,j,pid='0';
	eval("data = _"+key+"_data;");
	this.b = new Array(0,0,0,0,0,0,0,0);
	for(i=0;i<data.length;i++){
		itm = data[i]; lay = '';
		n = dataNext(data,i);
		b = this.b[itm[3]] = dataBrother(data,i);
		if(itm[3]>1){
			for(j=1;j<itm[3];j++){
				lay += this.b[j] ? '<i class="line">｜</i>' : '<i class="blank">　</i>';
			}
		}
		if(n){
			lay += '<i class="add" onclick=\"sotree_fold(this,'+itm[3]+')\">＋</i>';
		}else{
			lay += b ? '<i class="item">├</i>' : '<i class="end">└</i>';	
		}
		css = itm[3]==1 ? '' : 'none';
		s0 = tpl.replace(/\(key\)/g,itm[0]).replace('(title)',itm[2]).replace('(lay)',lay);
		s0 = s0.replace('(pid)',itm[1]).replace('(level)',itm[3]).replace('(css)',css);
		if(itm[3]==1){
			s0 = s0.replace('(letter)',itm[5]);
		}else{
			s0 = s0.replace('[(letter)]','').replace('((letter))','').replace('(letter)','');
		}
		s += s0;
	}
	if(cid) $('#'+cid).html(s);
	else return s;
}
function sotree_fold(em,d){ 
	var e,t,ishide,n,char=''; 
	e = $(em).parent();
	t = $(e).prop("tagName");
	ishide = $(em).hasClass("add");
	if($(em).html()=='＋') char = '－';
	if($(em).html()=='－') char = '＋';
	$(em).html(char);
	$(em).toggleClass('add');
	$(em).toggleClass('sub');	
	while(n=$(e).next()){
		if($(n).hasClass("tree_"+d)) break; //同级别 
		if(!(t==$(n).prop("tagName"))) break; //非tree元素（否则最后一个死循环）
		if(ishide){ //只展开一级
			 if($(n).toggleClass('tree_'+(d+1))) $(n).toggleClass('none'); 
		}else{
			$(n).toggleClass('none');	
		}
		e = n;
	}
}
function sotree_act(cid,dkey,val,act){
	var lay,i,p1,a1;
	if(!act) act = 'act';
	lay = dataLays(dkey,val).split(';'); 
	if(lay.length>0){
		for(i=0;i<lay.length;i++){
			p1 = $('#'+cid).find('p.k_'+lay[i])[0];
			i1 = $(p1).find('i:first'); 
			$(i1).click(); //trigger("click");				
			if(lay[i]==val){
				$(p1).find('a:first').toggleClass(act);
				break;
			}
		}
	}
}
// 显示所有
function sotree_open(cid,val,act){
	if(!act) act = 'act';
	$('#'+cid+' p.none').toggleClass('none'); //展开所有
	if(val) $('#'+cid+' p.k_'+val).find('a').toggleClass(act); //当前选种项
	$('#'+cid+' i.add').html('－'); 
	$('#'+cid+' i.add').toggleClass('sub');
	$('#'+cid+' i.add').toggleClass('add');	
}
// 
/*

*/



/*******************************************************************************
 File : \root\skin\a_jscss\weixin.js 
*******************************************************************************/
//微信相关js

function wxMenuClear(imuid){
	$(jsElm.jeID('fm['+imuid+'][name]')).val('');
	$(jsElm.jeID('fm['+imuid+'][val]')).val('');
}

function wxSetDebugType(key,init){
	var kch3 = key.substr(0,3); //console.log(kch3);
	$('.tbdata tr').each(function(index, element) {
        var html = $(this).find('td:first').html(); //console.log(element);
		if(html.indexOf('--,')>0){ 
			 $(this).hide();
		}
		if(html.indexOf(','+kch3+',')>0){ 
			 $(this).show();
		}
    });
	if(init){
		$(':radio[name="deubg[type]"]').last().attr("checked",true);
	}
}
function wxGetUserPage(){
	var pstart = (wu_page-1)*50;
	var pend = pstart+50; if(pend>wu_count) pend=wu_count;
	var arr = wu_list.split(',');
	var ids = '';
	for(var i=pstart;i<pend;i++){
		ids += ','+arr[i];
	}
	var url = 'actys=getUinfo&ustr='+ids+'&kid='+wu_kid+'';
	$('#tip_errors').hide();
	$.getScript(wu_urlbase+url, function(){ 
		if(data.errcode){
			$('#tip_errors').show();
			$('#tip_errors').html('Error:['+data.errcode+']<br>'+data.errmsg);
		}else if(data){ 
			wxSetUserPage(data);
		}  
	});
}
function wxSetUserPage(data){
	data = data.user_info_list;
	$('[id^=wu_row]').hide();
	for(var i=0;i<data.length;i++){ 
		var itm = data[i]; //jsLog(itm);
		var cheadimg = "<a href='"+itm.headimgurl+"' target='_blank'>头像</a>";
		var csex = itm.sex==1 ? '男' : '女';
		var atime = wxFmtLocalTime(itm.subscribe_time);
		var j = i+1, row = jsElm.jeID('wu_row'+j);
		$(row).show();
		$(row).find('td').eq(0).html(itm.nickname+(itm.subscribe?'':'(?)'));
		$(row).find('td').eq(1).html(itm.openid);
		$(row).find('td').eq(2).html(itm.groupid);
		$(row).find('td').eq(3).html(itm.city);
		$(row).find('td').eq(4).html(cheadimg);
		$(row).find('td').eq(5).html(csex);
		$(row).find('td').eq(6).html(atime); //onclick=\"return winOpen(this,'群发信息',780,560);\"
		$(row).find('td').eq(7).html("<a href='"+wu_msgurl+itm.openid+"' onclick=\"return winOpen(this,'发信息')\">发信息</a>");
	}
}
function wxFmtLocalTime(stamp) {     
	return new Date(parseInt(stamp) * 1000).toLocaleString();//.substr(0,17);
} 
function wxGetPageBar(pnow) {
	var pall = Math.ceil((wu_count)/50);
	var pmin = pnow-5; if(pmin<1) pmin=1;
	var pmax = pnow+5; if(pmax>pall) pmax=pall;
	var css = '', i=0; //console.log(wu_count + ':'+ pall);
	var sbar = "";
	if(pmin>1){
		i=1; css = i==pnow ? 'pg_num cF0F' : 'pg_num';
		sbar += "<li class='"+css+"'><a style='cursor:pointer' onclick='wxGetPageAct("+i+")'>"+i+"...</a></li>";	
	}
	for(i=pmin;i<=pmax;i++){
		css = i==pnow ? 'pg_num cF0F' : 'pg_num';
		sbar += "<li class='"+css+"'><a style='cursor:pointer' onclick='wxGetPageAct("+i+")'>"+i+"</a></li>";	
	}
	if(pmax<pall){
		i=pall; css = i==pnow ? 'pg_num cF0F' : 'pg_num';
		sbar += "<li class='"+css+"'><a style='cursor:pointer' onclick='wxGetPageAct("+i+")'>..."+i+"</a></li>";
	}
	sbar += "<li class='pg_total'>"+wu_count+"</li><li class='pg_pagno'>"+pnow+"/"+pall+"</li>";
	$('.pg_bar').html(sbar);
	/*
    <li class='pg_first'>&laquo;||首页</li>
    <li class='pg_prev'>&lt;|上页</li>
    <li class='pg_now'>1</li>
    <li class='pg_next'>下页|&gt;</li>
    <li class='pg_last'>尾页||&raquo;</li>
    <li class='pg_last'><a href='/08tools/yssina/1/root/run/adm.php?file=dops/a&mod=news&prec=22&page=2&ptype=end' >尾页</a></li>
    <li class='pg_total'>2</li>
    <li class='pg_pagno'>1/1</li>
	*/
}
function wxGetPageAct(page) {
	wu_page = page;
	wxGetUserPage(); 
	wxGetPageBar(page);
}

function wxKwdsetSence(istext){ 
	var kobj = jsElm.jeID('fm[keyword]'); 
	kobj.value = istext ? '' : 'follow_autoreply_info'; 
	kobj.readonly = istext ? false : true; 
}

function wxSendType(type){ 
	return;
}

// -------------------------------- 




/*******************************************************************************
 File : \root\skin\chn\b_jscss\comm.js 
*******************************************************************************/

function js_cklogin(id){
	var sinf, ainf='';
	if(_minfo.userFlag=='Guest'){
		var uname = 'Guest';
		sinf = '<span class="uname">'+uname+'</span> 您好！<br><a href="'+umc_url+'?mkv=user-login&recbk=ref">马上登陆…</a>';
	}else{
		var uname = _minfo.uname;
		if(uname.length>9){
			uname = uname.substr(0,6)+'...'+uname.substr(-3,3);
		}
		sinf = '<span class="uname" title="'+_mperm.title+'">'+uname+'</span> 您好！<br><a href="'+umc_url+'?mkv=user-login&act=doout&recbk=ref" target="_blank">登出…</a>';
	}
	if(_miadm.userFlag=='Login'){ 
		ainf = '<a class="cF0F" href="'+_cbase.run.roots+'/run/adm.php?mkv=login&act=doout" target="_blank" title="登出:'+_mpadm.title+'">登出:'+_miadm.uname+'</a>';
	}
	if(typeof(ocar_items)=="undefined"){
		var citems = getCookie('ocar_items');
	}else{
		var citems = ocar_items;
	}
	citems = citems ? citems : 0; //jsLog(citems);
	ainf += '<br><a class="cF0F" href="'+ocar_url+'">购物车('+citems+')</a>';
	if(!id) id = 'top_cklogin';
	if(id) $('#'+id).html("<span class='ainf'>"+ainf+"</span>"+sinf);
	return sinf+ainf;
}

function jsactMenu(menuid){
	if(_cbase.jsrun.menuid){
		menuid = _cbase.jsrun.menuid;
	}else if(!menuid){
		var a = _cbase.run.mkv.replace('.','-').split('-');
		menuid = a[0];
	}
	var e = jsElm.jeID('idf_'+menuid); 
	if(e) e.className = 'act';
}

function js_i18nbar(){
	jQuery.getScript(_cbase.run.roots+'/skin/a_jscss/i18nbar.js',function(){ 
		i18nb_mui('Chinese','i18nb_obj','i18nb_api','i18nb_btn'); 
	});
}

function js_aheight(){ 
	if($('.pgf_side2').html()){
		if($('.pgf_mcon2').height()+20>$('.pgf_mid2').height()){
			$('.pgf_mid2').height($('.pgf_mcon2').height()+20); 
		}		
	}else{
		if($('.pgf_side').height()>$('.pgf_mid').height()){
			$('.pgf_mid').height($('.pgf_side').height()); 
		}
	}
}

// <b class="qrcode_tip" onMouseOver="qrurl_act(id,1)" onMouseOut="qrurl_act(id,0)">扫码<i class="qrcode_pic"></i></b
function qrurl_set(id,url){ 
	cls = 'qrcode_pic';
	if($('#'+cls+id).html().length>24) return;
	url = url.length>12 ? url : window.location.href;
	url = urlEncode(url);
	img = "<img src='"+_cbase.run.roots+"/plus/ajax/vimg.php?mod=qrShow&data="+url+"' width='180' height='180' />";
	$('#'+cls+id).html('扫描网址到手机<br>'+img); // onload='imgShow(this,180,180)'
}
function qrurl_act(id,type,url){
	if(url) qrurl_set(id,url);
	if(type) $('#qrcode_pic'+id).show();
	else $('#qrcode_pic'+id).hide();
}

function qrcargo_act(id,type,url){
	if(url){
		 var src = $('#qrcode_pic'+id).attr('src');
		 if(!src){
			if(url.indexOf('?')>=0){ //08tools/yssina/1/root/run/mob.php?cargo.2015-97-dad1
				url = _cbase.run.rsite+url; //jsLog(url);
				img = _cbase.run.roots+"/plus/ajax/vimg.php?mod=qrShow&data="+url; 
				$('#qrcode_pic'+id).find('img').attr('src',img);
			}else{//cargo.2015-97-dad1
				var extp = Math.random().toString(36).substr(2); 
				extp = url+','+extp;
				var url = 'actys=getQrcode&qrmod=send&extp='+extp+'&datatype=js&varname=data';
				$.getScript(_cbase.run.roots+'/plus/api/wechat.php?'+url, function(){ 
					img = data.url; //jsLog(data);
					$('#qrcode_pic'+id).find('img').attr('src',img);
				});	
			}
		 }
	} //jsLog(img);
	if(type) $('#qrcode_pic'+id).show();
	else $('#qrcode_pic'+id).hide();
}



/*******************************************************************************
 File : \root\skin\demodir\b_jscss\comm.js 
*******************************************************************************/

function jsactMenu(menuid){
	if(_cbase.jsrun.menuid){
		menuid = _cbase.jsrun.menuid;
	}else if(!menuid){
		var a = _cbase.run.mkv.replace('.','-').split('-');
		menuid = a[0];
	}
	var e = jsElm.jeID('idf_'+menuid); 
	if(e) e.className = 'act';
}



/*******************************************************************************
 File : \root\skin\dev\b_jscss\comm.js 
*******************************************************************************/


function jsactMenu(menuid){
	if(_cbase.jsrun.menuid){
		menuid = _cbase.jsrun.menuid;
	}else if(!menuid){
		var a = _cbase.run.mkv.replace('.','-').split('-');
		menuid = a[0];
	} 
	//if(',docs: demo,news,topic,keres,cargo,'.indexOf(menuid)>0) menuid = 'docs';
    //if(',uplog: uplog,'.indexOf(menuid)>0) menuid = 'start';
	//if(',tools: tools,'.indexOf(menuid)>0) menuid = 'tester';
	var e = jsElm.jeID('idf_'+menuid); 
	if(e) e.className = 'act';
}

function js_aheight(){ 
	if($('.pgf_side2').html()){
		if($('.pgf_mcon2').height()+20>$('.pgf_mid2').height()){
			$('.pgf_mid2').height($('.pgf_mcon2').height()+20); 
		}		
	}else{
		if($('.pgf_side').height()>$('.pgf_mid').height()){
			$('.pgf_mid').height($('.pgf_side').height()); 
		}
	}
}



/*******************************************************************************
 File : \root\skin\dev\b_jscss\shapan.js 
*******************************************************************************/


// 通过id得到web元素
function jeID(id) {
	return typeof id == 'string' ? document.getElementById(id) : id;
}

// 初始化-所有点
function sha_init(id){
	movingNow = new moveMain(); 
	mapPos = jePos('MapImages'); //alert(mapPos[0]+':'+mapPos[1]);
	for(var i=0;i<dots_data.length;i++){
		var iarr = dots_data[i].split(':');
		var imsg = iarr[0].split('^');
		var ipos = iarr[1].split(','); 
		sha_idot(imsg[0],imsg[1],ipos[0],ipos[1]);
	}	
}
// 增加一个点
function sha_add(id,msg,offset){
	var idot = jeID('dot_'+id);
	if(idot){
		alert('已经添加！');
		return;
	}
	sha_idot(id,msg,1+offset*2,1+offset*2);
}
// 删除一个点
function sha_del(id){
	var idot = jeID('dot_'+id);
	idot.parentNode.removeChild(idot);
	var icb = jeID('cb_'+id);
	icb.disabled = false;
	icb.checked = false;
	//清理表单项目
}
// 拖动完毕,设置表单项
function sha_moved(id){ //return;
	if(dotMoved>0){
		var ePos = jePos(id);
		jeID('posStr').innerHTML = (ePos[0]-mapPos[0])+':'+(ePos[1]-mapPos[1]);
		dotMoved = 0;
	}
}
// 显示一个点
function sha_idot(id,msg,left,top){
	var idot = document.createElement('DIV'); 
	idot.setAttribute('id','dot_'+id); 
	idot.innerHTML += msg;
	idot.className = 'sha-dot';
	idot.style.left = (mapPos[0]+parseInt(left))+'px';
	idot.style.top = (mapPos[1]+parseInt(top))+'px';
	idot.onmousedown = function(e){ dotMoved=1; movingNow.Move('dot_'+id,e); }
	idot.ondblclick = function(){ sha_del(id); }
	jeID('MapDots').appendChild(idot);
	jeID('cb_'+id).disabled = true;
	//debug::jeID('posStr').innerHTML += id+', ';
	//保存表单项目
}



/*******************************************************************************
 File : \root\skin\doc\b_jscss\comm.js 
*******************************************************************************/


function jsactMenu(menuid){
	if(_cbase.jsrun.menuid){
		menuid = _cbase.jsrun.menuid;
	}else if(!menuid){
		var a = _cbase.run.mkv.replace('.','-').split('-');
		menuid = a[0];
	} 
	//if(',docs: demo,news,topic,keres,cargo,'.indexOf(menuid)>0) menuid = 'docs';
    //if(',uplog: uplog,'.indexOf(menuid)>0) menuid = 'start';
	//if(',tools: tools,'.indexOf(menuid)>0) menuid = 'tester';
	var e = jsElm.jeID('idf_'+menuid); 
	if(e) e.className = 'act';
}

function js_aheight(){ 
	if($('.pgf_side2').html()){
		if($('.pgf_mcon2').height()+20>$('.pgf_mid2').height()){
			$('.pgf_mid2').height($('.pgf_mcon2').height()+20); 
		}		
	}else{
		if($('.pgf_side').height()>$('.pgf_mid').height()){
			$('.pgf_mid').height($('.pgf_side').height()); 
		}
	}
}



/*******************************************************************************
 File : \root\skin\doc\b_jscss\shapan.js 
*******************************************************************************/


// 通过id得到web元素
function jeID(id) {
	return typeof id == 'string' ? document.getElementById(id) : id;
}

// 初始化-所有点
function sha_init(id){
	movingNow = new moveMain(); 
	mapPos = jePos('MapImages'); //alert(mapPos[0]+':'+mapPos[1]);
	for(var i=0;i<dots_data.length;i++){
		var iarr = dots_data[i].split(':');
		var imsg = iarr[0].split('^');
		var ipos = iarr[1].split(','); 
		sha_idot(imsg[0],imsg[1],ipos[0],ipos[1]);
	}	
}
// 增加一个点
function sha_add(id,msg,offset){
	var idot = jeID('dot_'+id);
	if(idot){
		alert('Added!');
		return;
	}
	sha_idot(id,msg,1+offset*2,1+offset*2);
}
// 删除一个点
function sha_del(id){
	var idot = jeID('dot_'+id);
	idot.parentNode.removeChild(idot);
	var icb = jeID('cb_'+id);
	icb.disabled = false;
	icb.checked = false;
	//清理表单项目
}
// 拖动完毕,设置表单项
function sha_moved(id){ //return;
	if(dotMoved>0){
		var ePos = jePos(id);
		jeID('posStr').innerHTML = (ePos[0]-mapPos[0])+':'+(ePos[1]-mapPos[1]);
		dotMoved = 0;
	}
}
// 显示一个点
function sha_idot(id,msg,left,top){
	var idot = document.createElement('DIV'); 
	idot.setAttribute('id','dot_'+id); 
	idot.innerHTML += msg;
	idot.className = 'sha-dot';
	idot.style.left = (mapPos[0]+parseInt(left))+'px';
	idot.style.top = (mapPos[1]+parseInt(top))+'px';
	idot.onmousedown = function(e){ dotMoved=1; movingNow.Move('dot_'+id,e); }
	idot.ondblclick = function(){ sha_del(id); }
	jeID('MapDots').appendChild(idot);
	jeID('cb_'+id).disabled = true;
	//debug::jeID('posStr').innerHTML += id+', ';
	//保存表单项目
}



/*******************************************************************************
 File : \root\skin\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\skin\jslib\base64.js 
*******************************************************************************/
/*
CryptoJS v3.0.2
code.google.com/p/crypto-js
(c) 2009-2012 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
(function(){var h=CryptoJS,i=h.lib.WordArray;h.enc.Base64={stringify:function(b){var e=b.words,f=b.sigBytes,c=this._map;b.clamp();for(var b=[],a=0;a<f;a+=3)for(var d=(e[a>>>2]>>>24-8*(a%4)&255)<<16|(e[a+1>>>2]>>>24-8*((a+1)%4)&255)<<8|e[a+2>>>2]>>>24-8*((a+2)%4)&255,g=0;4>g&&a+0.75*g<f;g++)b.push(c.charAt(d>>>6*(3-g)&63));if(e=c.charAt(64))for(;b.length%4;)b.push(e);return b.join("")},parse:function(b){var b=b.replace(/\s/g,""),e=b.length,f=this._map,c=f.charAt(64);c&&(c=b.indexOf(c),-1!=c&&(e=c));
for(var c=[],a=0,d=0;d<e;d++)if(d%4){var g=f.indexOf(b.charAt(d-1))<<2*(d%4),h=f.indexOf(b.charAt(d))>>>6-2*(d%4);c[a>>>2]|=(g|h)<<24-8*(a%4);a++}return i.create(c,a)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.-="}})();

// $type=='mkv' ? ".-" : "_~";
// "+/" =
function base64_encode(str) {
	var str = CryptoJS.enc.Utf8.parse(str);
	var base64 = CryptoJS.enc.Base64.stringify(str);
	base64 = base64.replace(/=/g,"");
	return base64; 
}
function base64_decode(str) {
	var words = CryptoJS.enc.Base64.parse(str);
	return words.toString(CryptoJS.enc.Utf8);
}



/*******************************************************************************
 File : \root\skin\jslib\Crypto.js 
*******************************************************************************/
/*
CryptoJS v3.0.2
code.google.com/p/crypto-js
(c) 2009-2012 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
var CryptoJS=CryptoJS||function(h,o){var f={},j=f.lib={},k=j.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var c=new a;b&&c.mixIn(b);c.$super=this;return c},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),i=j.WordArray=k.extend({init:function(a,b){a=
this.words=a||[];this.sigBytes=b!=o?b:4*a.length},toString:function(a){return(a||p).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes,a=a.sigBytes;this.clamp();if(d%4)for(var e=0;e<a;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;e<a;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);this.sigBytes+=a;return this},clamp:function(){var a=this.words,b=this.sigBytes;a[b>>>2]&=4294967295<<32-8*(b%4);a.length=h.ceil(b/4)},clone:function(){var a=
k.clone.call(this);a.words=this.words.slice(0);return a},random:function(a){for(var b=[],c=0;c<a;c+=4)b.push(4294967296*h.random()|0);return i.create(b,a)}}),l=f.enc={},p=l.Hex={stringify:function(a){for(var b=a.words,a=a.sigBytes,c=[],d=0;d<a;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16));c.push((e&15).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;d<b;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return i.create(c,b/2)}},n=l.Latin1={stringify:function(a){for(var b=
a.words,a=a.sigBytes,c=[],d=0;d<a;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;d<b;d++)c[d>>>2]|=(a.charCodeAt(d)&255)<<24-8*(d%4);return i.create(c,b)}},q=l.Utf8={stringify:function(a){try{return decodeURIComponent(escape(n.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data");}},parse:function(a){return n.parse(unescape(encodeURIComponent(a)))}},m=j.BufferedBlockAlgorithm=k.extend({reset:function(){this._data=i.create();
this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=q.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(a){var b=this._data,c=b.words,d=b.sigBytes,e=this.blockSize,f=d/(4*e),f=a?h.ceil(f):h.max((f|0)-this._minBufferSize,0),a=f*e,d=h.min(4*a,d);if(a){for(var g=0;g<a;g+=e)this._doProcessBlock(c,g);g=c.splice(0,a);b.sigBytes-=d}return i.create(g,d)},clone:function(){var a=k.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});j.Hasher=m.extend({init:function(){this.reset()},
reset:function(){m.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);this._doFinalize();return this._hash},clone:function(){var a=m.clone.call(this);a._hash=this._hash.clone();return a},blockSize:16,_createHelper:function(a){return function(b,c){return a.create(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return r.HMAC.create(a,c).finalize(b)}}});var r=f.algo={};return f}(Math);


/*******************************************************************************
 File : \root\skin\jslib\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\skin\jslib\jcore-cn.js 
*******************************************************************************/

var Lang = {};

Lang.jcore = {

	test_name : '中文名',
	view_times : '浏览{val}次',

	rplan_nrun : '最近执行[{val}]个计划任务',
	rpaln_null : '最近[无]任务执行',

	jstag_toolong : 'js标签太多，{val}无法显示。',
	hide : '隐藏',
	pleaseselect : '请选择', 
	vcode_upd : '点击刷新/换一组', 

	mpic_del : '删除', 
	mpic_readd : '不要重复加入!',
	mpic_select : '-请选择-', 
	mpic_allitems : '-所有项-', 
	mpic_norelate : '无相关项,显示所有！', 

	sobar_curunit : '元', 
	sobar_all : '[全部]', 

	jqbase_checkform : '请检查表单的规范性与完整性：', 
	jqbase_notrule : '不规范', 

	pop_pickmap : '选择地图坐标', 
	pop_repeat : '该资料重复!', 
	pop_pickmod : '请选模型！', 
	pop_infopick : '信息选取', 
	pop_maxn : '最多个[{val}个]', 
	pop_maxm : '最多个[{val}个],此页不能全选了！', 
	pop_all : '(共{val}个项目)', 

	so_keyword : '搜索关键词未填写！', 
	so_result : '搜索到关键词{val}处', 

	test_end : '测试结束'

};



/*******************************************************************************
 File : \root\skin\jslib\jcore-en.js 
*******************************************************************************/

var Lang = {};

Lang.jcore = {

	test_name : 'English Name',
	view_times : 'Views:{val}',

	rplan_nrun : 'Now Runed [{val}] Task',
	rpaln_null : 'Now [Null] Task Runed',

	jstag_toolong : 'Too many js tags, {val}CAN NOT show.',
	hide : 'Hide',
	pleaseselect : 'Please Select', 
	vcode_upd : 'Click update/Change a set', 

	mpic_del : 'Del', 
	mpic_readd : 'Add Repeat!',
	mpic_select : '-Select-', 
	mpic_allitems : '-All Items-', 
	mpic_norelate : 'No metch Items, Show All!', 

	sobar_curunit : 'Yuan', 
	sobar_all : '[All]', 

	jqbase_checkform : 'Please check form:', 
	jqbase_notrule : 'Non-standard', 

	pop_pickmap : 'Please Pick map piont', 
	pop_repeat : 'Info repeat!', 
	pop_pickmod : 'Please select model!', 
	pop_infopick : 'Info Pick', 
	pop_maxn : 'Max Items:[{val}]', 
	pop_maxm : 'Max Items:[{val}],Can NOT select more!', 
	pop_all : '(All {val} Items)', 

	so_keyword : 'Input keyword!', 
	so_result : 'Match Items:{val}', 
	
	test_end : 'End Test'

};



/*******************************************************************************
 File : \root\skin\jslib\jq_base.js 
*******************************************************************************/

// Cookie操作
// easy_validator.js

// *** Cookie操作 =========================================================================================
// $.cookie('the_cookie'); // 获得cookie
// $.cookie('the_cookie', 'the_value'); // 设置cookie
// $.cookie('the_cookie', 'the_value', { exps: 7 }); //设置带时间的cookie，单位：秒
// $.cookie('the_cookie', '', { exps: -1 }); // 删除
// $.cookie('the_cookie', null); // 删除 cookie
// $.cookie('the_cookie', 'the_value', {exps: 7, path: '/', domain: 'jquery.com', secure: true});//新建一个cookie 包括有效期 路径 域名等

jQuery.cookie = function(name, value, options) {
	if (typeof value != 'undefined') {
		options = options || {};
		if (value === null) {
			value = '';
			options.exps = -1;
		}
		var exps = '';
		if (options.exps && (typeof options.exps == 'number' || options.exps.toUTCString)) {
			var date;
			if (typeof options.exps == 'number') {
				date = new Date();
				date.setTime(date.getTime() + (options.exps * 1000));
			} else {
				date = options.exps;
			}
			exps = '; exps=' + date.toUTCString();
		}
		var path = options.path ? '; path=' + options.path: '';
		var domain = options.domain ? '; domain=' + options.domain: '';
		var secure = options.secure ? '; secure': '';
		document.cookie = [name, '=', encodeURIComponent(value), exps, path, domain, secure].join('');
	} else {
		var cookieValue = null;
		if (document.cookie && document.cookie != '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				if (cookie.substring(0, name.length + 1) == (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
};

//* easy_validator.js =====================================================================================
	//Copyright (C) 2009 - 2012
	//WebSite:	Http://wangking717.javaeye.com/
	//Author:		wangking
	// 1. vtip -=> evf_vtip
	// 2. validate -=> evf_validate
//*/

$(function(){
	var xOffset = -20; // x distance from mouse
    var yOffset = 20; // y distance from mouse  
	//input action
	$("[reg],[url]:not([reg]),[tip]").hover(
		function(e) {
			if($(this).attr('tip') != undefined){
				var top = (e.pageY + yOffset);
				var left = (e.pageX + xOffset);
				if (typeof(_sys_path)=='undefined'){
				   _sys_path = '/';
				}
				$('body').append( '<p id="evf_vtip"><img id="evf_vtipArrow" src="'+_cbase.run.roots+'/skin/a_img/easy_vicon.png"/>' + $(this).attr('tip') + '</p>' );
				$('p#evf_vtip').css("top", top+"px").css("left", left+"px");
				try{$('p#evf_vtip').bgiframe();}catch(ex){}
			}
		},
		function() {
			if($(this).attr('tip') != undefined){
				$("p#evf_vtip").remove();
			}
		}
	).mousemove(
		function(e) {
			if($(this).attr('tip') != undefined){
				var top = (e.pageY + yOffset);
				var left = (e.pageX + xOffset);
				$("p#evf_vtip").css("top", top+"px").css("left", left+"px");
			}
		}
	).blur(function(){
		if($(this).attr("url") != undefined){
			evf_check_ajax($(this));
		}else if($(this).attr("reg") != undefined){
			evf_validate($(this));
		}
	});
	
	$("form").submit(function(){
		var isSubmit = true;
		var msgarr = new Array();
		var userCheck = $(this).attr("usercheck");
		$(this).find("[reg],[url]:not([reg])").each(function(){
			if($(this).attr("reg") == undefined){
				if(!evf_check_ajax($(this))){
					isSubmit = false;
					msgarr.push(evf_errMessage(this));
				}
			}else{
				if(!evf_validate($(this))){
					isSubmit = false;
					msgarr.push(evf_errMessage(this));
				}
			}
		});
		if(userCheck){ 
			eval("isSubmit = evf_"+userCheck+"(msgarr,isSubmit);");
			return isSubmit;
		}else if(typeof(evf_isExtends) != "undefined"){
   			return evf_extendsValidate(msgarr,isSubmit);
   		}else{
			evf_errAlert(msgarr,isSubmit);
			return isSubmit;
		}
	});
	
});
function evf_errAlert(msgarr,isSubmit){
	if(!isSubmit){
		var msgstr = '';
		for(var i=0;i<msgarr.length;i++){
			msgstr += '\n'+i+'. '+msgarr[i];
		}
		alert(lang('jcore.jqbase_checkform')+'\n'+msgstr);	
	}
}	
function evf_errMessage(e){
	var imsg = $(e).attr("tip");
	imsg = imsg ? imsg : $(e).attr("name")+lang('jcore.jqbase_notrule');
	if(imsg.indexOf('</body>')>0 || imsg.indexOf('</BODY>')>0){
		imsg = jsText(imsg);
		imsg = imsg.replace(/\s+/g,"");
		//if(imsg.length>120)	 imsg = imsg.substring(0,100);
	}
	return imsg;
}

// key:3-12,tit:2-12,str:10+
// n(+0-)(id)
// fix:tel,email,url,file,image,
function evf_getRegs(obj){
	var str = obj.attr("reg");
	var re = str, flag = '';
	if(str.substring(0,4)=='nul:'){
		flag = str.substring(0,4);	
		re = str = str.substring(4);
	}
	if(str=='fix:tel'){ // 0769-12345678; 0769-12345678#0123; 0086-769-12345678#0123
        re = '^([0-9]{1})([0-9\-]{3,12})?[0-9]{1}(#[0-9]{2,5})?$';
	}else if(str=='fix:email'){ // peace_xie@qq.com
		re = '^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$';
	}else if(str=='fix:uri'){ // peace_xie@qq.com
		re = '^(http|https|ftp)\\://\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*(\\S)*$';
		// /^\s*https?:\/\/(?:[\w\-]+\.)+[a-z]{2,4}(?:\:\d{1,5})?(?:\/.*)?\s*$/ 
	}else if(str=='fix:file'){ // http://www.txmao.com/?wpwe
		var image = 'gif|jpg|jpeg|png|swf|flv|';
		var media = 'swf|flv|mp3|wav|wma|wmv|mid|avi|mpg|asf|rm|rmvb|';
		var files = 'doc|docx|xls|xlsx|ppt|htm|html|txt|zip|rar|gz|bz2|';
		re = '.+\\.('+image+media+files+'Peace!DB)$';
	}else if(str=='fix:image'){ // 
		re = '.+\\.(gif|jpg|jpeg|png)$';	
	}else if(str=='fix:xid'){ //  xie_ys@08-cms.com  @-_.
		re = '^[0-9]{4}[a-zA-Z0-9@\\-]{6,15}$';
	}else if(str.indexOf('vimg:')==0){ // 认证码
		var a = str.substring(5).split('-'); 
		re = '^[a-zA-Z0-9]{'+a[0]+','+a[1]+'}$';
	}else if(str.indexOf('var:')==0){ //  xie_123
		var a = str.substring(4).split('-'); 
		var a0 = a[0]-1, a1 = a[1]-1;
		re = '^[a-zA-Z][a-zA-Z0-9_]{'+a0+','+a1+'}$';
	}else if(str.indexOf('key:')==0){ //  xie_ys@08-cms.com  @-_.
		var a = str.substring(4).split('-'); 
		var a0 = a[0]-1, a1 = a[1]-1;
		re = '^[a-zA-Z][a-zA-Z0-9@_\\-\\.]{'+a0+','+a1+'}$';
	}else if(str.indexOf('tit:')==0){ // @/_|-.汉字
		var a = str.substring(4).split('-'); 
		re = '^[^\\<\\>\\"\\\'\\\\\\\r\\\n]{'+a[0]+','+a[1]+'}$'; // \\/\\*\\|\\?
		// ^[a-zA-Z@0-9/_\\|\\-\\.\\u4e00-\\u9fa5\\.\\:\\(\\)\\+\\=\\ ]{'+a[0]+','+a[1]+'}$
	}else if(str.indexOf('str:')==0){ //^.{5,100}$
		str = str.replace('+','-123000123');
		var a = (str+"-").substring(4).split('-'); 
		if(a[1].length==0) a[1] = 123000123 //123M,够大了
		re = '^[^\\b]{'+a[0]+','+a[1]+'}$'; 
	//}else if("(n+i:,n-i:,n+d:,n-d:)".indexOf((str+"))))").substr(0,4))>00){ // 
	}else if(str.indexOf('n+i')==0){ // 2,2323
		re = '^[0-9]{1,15}$';
	}else if(str.indexOf('n-i')==0){ // 2,-2323
		re = '^([\\-]{0,1})?[0-9]{1,15}$';
	}else if(str.indexOf('n+d')==0){ // 2,-23.23
		re = '^[0-9]{1,15}([\\.][0-9]{1,15})?$';
	}else if(str.indexOf('n-d')==0){ // 2,-23.23
		re = '^([\\-]{0,1})?[0-9]{1,15}([\\.][0-9]{1,15})?$';
	}
	return reTab = {re:re,flag:flag}; 
}

function evf_validate(obj){
	var objValue = obj.prop("value");
	var reTab = evf_getRegs(obj);
	var reg = new RegExp(reTab.re);
	if(objValue.length==0&&reTab.flag=='nul:') return true;
	if(!reg.test(objValue)){
		evf_change_error(obj,"add");
		evf_change_tip(obj,null,"remove");
		return false;
	}else{
		if(obj.attr("url") == undefined){
			evf_change_error(obj,"remove");
			evf_change_tip(obj,null,"remove");
			return true;
		}else{
			return evf_check_ajax(obj);
		}
	}
}

function evf_check_ajax(obj){
	var url_str = obj.attr("url");
	if(url_str.indexOf("?") != -1){ url_str = url_str+"&"; }
	else                          { url_str = url_str+"?"; }
	url_str += obj.prop("name")+"="+obj.prop("value")+"&"+_cbase.safil.url;
	try{ url_str += '&lang='+_cbase.sys.lang; }
	catch(ex){ }
	var feed_back = $.ajax({url: url_str,cache: false,async: false}).responseText;
	feed_back = feed_back.replace(/(^\s*)|(\s*$)/g, "");
	if(feed_back == 'success'){
		evf_change_error(obj,"remove");
		evf_change_tip(obj,null,"remove");
		return true;
	}else{
		evf_change_error(obj,"add");
		evf_change_tip(obj,feed_back,"add");
		return false;
	}
}

function evf_change_tip(obj,msg,action_type){
	if(obj.attr("tip") == undefined){//初始化判断TIP是否为空
		obj.attr("is_tip_null","yes");
	}
	if(action_type == "add"){
		if(obj.attr("is_tip_null") == "yes"){
			obj.attr("tip",msg);
		}else{
			if(msg != null){
				if(obj.attr("tip_bak") == undefined){
					obj.attr("tip_bak",obj.attr("tip"));
				}
				obj.attr("tip",msg);
			}
		}
	}else{
		if(obj.attr("is_tip_null") == "yes"){
			obj.removeAttr("tip");
			obj.removeAttr("tip_bak");
		}else{
			obj.attr("tip",obj.attr("tip_bak"));
			obj.removeAttr("tip_bak");
		}
	}
}

function evf_change_error(obj,action_type){
	if(action_type == "add"){
		obj.addClass("evf_valid-failed");
	}else{
		obj.removeClass("evf_valid-failed");
	}
}

$.fn.evf_callback = function(msg,action_type,options){
	this.each(function(){
		if(action_type == "failed"){
			evf_change_error($(this),"add");
			evf_change_tip($(this),msg,"add");
		}else{
			evf_change_error($(this),"remove");
			evf_change_tip($(this),null,"remove");
		}
	});
};


// jq_passwordStrength  =======================================================================================

$.fn.passwordStrength = function(options){
	return this.each(function(){
		var that = this;that.opts = {};
		that.opts = $.extend({}, $.fn.passwordStrength.defaults, options);
		
		that.div = $(that.opts.targetDiv);
		that.defaultClass = that.div.attr('class');
		
		that.percents = (that.opts.classes.length) ? 100 / that.opts.classes.length : 100;
		 v = $(this).keyup(function(){
			if( typeof el == "undefined" )
				this.el = $(this);
			var s = getPasswordStrength (this.value);
			var p = this.percents;
			var t = Math.floor( s / p );			
			if( 100 <= s ) t = this.opts.classes.length - 1;	
			this.div.removeAttr('class').addClass( this.defaultClass ).addClass( this.opts.classes[ t ]);	
		})		
	});
	//获取密码强度
	function getPasswordStrength(H){
		var D=(H.length);
		if(D>5){
			D=5
		}
		var F=H.replace(/[0-9]/g,"");
		var G=(H.length-F.length);
		if(G>3){G=3}
		var A=H.replace(/\W/g,"");
		var C=(H.length-A.length);
		if(C>3){C=3}
		var B=H.replace(/[A-Z]/g,"");
		var I=(H.length-B.length);
		if(I>3){I=3}
		var E=((D*10)-20)+(G*10)+(C*15)+(I*10);
		if(E<0){E=0}
		if(E>100){E=100}
		return E
	}
};

$.fn.passwordStrength.defaults = {
	classes : Array('psc_is10','psc_is20','psc_is30','psc_is40','psc_is50','psc_is60','psc_is70','psc_is80','psc_is90','psc_isa0'),
	targetDiv : '#passwordStrengthDiv',
	cache : {}
}

$.passwordStrength = {};

/*
$.passwordStrength.getRandomPassword = function(size){
		var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
		var size = size || 8;
		var i = 1;
		var ret = ""
		while ( i <= size ) {
			$max = chars.length-1;
			$num = Math.floor(Math.random()*$max);
			$temp = chars.substr($num, 1);
			ret += $temp;
			i++;
		}
		return ret;			
}	
//*/


/*******************************************************************************
 File : \root\skin\jslib\jq_win.js 
*******************************************************************************/

// win-tips.js
// win_poplayer
// win_webox.js

// *** tipsWindown - jQuery弹出窗口 By Await [2009-11-22] ================================================
/*参数：[可选参数在调用时可写可不写,其他为必写]
    title:	窗口标题
  content:  内容(可选内容为){ text | id | img | url | iframe }
    width:	内容宽度
   height:	内容高度
	 drag:  是否可以拖动(ture为是,false为否)
     time:	自动关闭等待的时间，为空是则不自动关闭
   showbg:	[可选参数]设置是否显示遮罩层(0为不显示,1为显示)
  cssName:  [可选参数]附加class名称
     示例:  simpleWindown("例子","text:例子","500","400","true","3000","0","exa")
*/
var showWindown = true;
var templateSrc = "http://www.txmao.com"; //设置loading.gif路径
function tipsWindown(title,content,width,height,drag,time,showbg,cssName,backcall) {
	$("#wtips-box").remove(); //请除内容
	var width = width>= 960 ? this.width=960 : this.width=width;	    //设置最大窗口宽度
	var height = height>= 640 ? this.height=640 : this.height=height;  //设置最大窗口高度
	if(showWindown == true) {
		var simpleWindown_html = new String;
			simpleWindown_html = "<div id=\"wtips-bg\" style=\"height:"+$(document).height()+"px;filter:alpha(opacity=0);opacity:0;z-index: 999901\"></div>";
			simpleWindown_html += "<div id=\"wtips-box\">";
			simpleWindown_html += "<div id=\"wtips-title\"><h2></h2><span id=\"wtips-close\">[X]</span></div>";
			simpleWindown_html += "<div id=\"wtips-content-border\"><div id=\"wtips-content\"></div></div>"; 
			simpleWindown_html += "</div>";
			$("body").append(simpleWindown_html);
			show = false;
	}
	contentType = content.substring(0,content.indexOf(":"));
	content = content.substring(content.indexOf(":")+1,content.length);
	switch(contentType) {
		case "text":
		$("#wtips-content").html(content);
		break;
		case "id":
		$("#wtips-content").html($("#"+content+"").html());
		break;
		case "img":
		$("#wtips-content").ajaxStart(function() {
			$(this).html("<img src='"+templateSrc+"/images/loading.gif' class='loading' />");
		});
		$.ajax({
			error:function(){
				$("#wtips-content").html("<p class='wtips-error'>Load Data Error...</p>");
			},
			success:function(html){
				$("#wtips-content").html("<img src="+content+" alt='' />");
			}
		});
		break;
		case "url":
		var content_array=content.split("?");
		$("#wtips-content").ajaxStart(function(){
			$(this).html("<img src='"+templateSrc+"/images/loading.gif' class='loading' />");
		});
		$.ajax({
			type:content_array[0],
			url:content_array[1],
			data:content_array[2],
			error:function(){
				$("#wtips-content").html("<p class='wtips-error'>Load Data Error...</p>");
			},
			success:function(html){
				$("#wtips-content").html(html);
				if(backcall)
					backcall();
			}
		});
		break;
		case "iframe":
		$("#wtips-content").ajaxStart(function(){
			$(this).html("<img src='"+templateSrc+"/images/loading.gif' class='loading' />");
		});
		$.ajax({
			error:function(){
				$("#wtips-content").html("<p class='wtips-error'>Load Data Error...</p>");
			},
			success:function(html){
				$("#wtips-content").html("<iframe src=\""+content+"\" width=\"100%\" height=\""+parseInt(height)+"px"+"\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\" style='overflow-y:hidden;overflow-x:hidden;'></iframe>");
			}
		});
	}
	$("#wtips-title h2").html(title);
	if(showbg == "true") {$("#wtips-bg").show();}else {$("#wtips-bg").remove();};
	$("#wtips-bg").animate({opacity:"0.5"},"normal");//设置透明度
	$("#wtips-box").show();
	if( height >= 527 ) {
		$("#wtips-title").css({width:(parseInt(width)+22)+"px"});
		$("#wtips-content").css({width:(parseInt(width)+17)+"px",height:height+"px"});
	}else {
		$("#wtips-title").css({width:(parseInt(width)+10)+"px"});
		$("#wtips-content").css({width:width+"px",height:height+"px"});
	}
	var	cw = document.documentElement.clientWidth,ch = document.documentElement.clientHeight,est = document.documentElement.scrollTop; 
	$("#wtips-box").css({left:"50%",top:"50%",marginTop:-((parseInt(height)+53)/2)+"px",marginLeft:-((parseInt(width)+32)/2)+"px",zIndex: "999999"}); 
	var Drag_ID = document.getElementById("wtips-box"),DragHead = document.getElementById("wtips-title");
		
	var moveX = 0,moveY = 0,moveTop,moveLeft = 0,moveable = false;
		moveTop = 0;
	var	sw = Drag_ID.scrollWidth,sh = Drag_ID.scrollHeight;
		DragHead.onmouseover = function(e) {
			if(drag == "true"){DragHead.style.cursor = "move";}else{DragHead.style.cursor = "default";}
		};
		DragHead.onmousedown = function(e) {
		if(drag == "true"){moveable = true;}else{moveable = false;}
		e = window.event?window.event:e;
		var ol = Drag_ID.offsetLeft, ot = Drag_ID.offsetTop-moveTop;
		moveX = e.clientX-ol;
		moveY = e.clientY-ot;
		document.onmousemove = function(e) {
			if (moveable) {
				try{ document.selection.empty(); }
				catch(e){ window.getSelection().removeAllRanges();}
				e = window.event?window.event:e;
				var x = e.clientX - moveX;
				var y = e.clientY - moveY;
				//if ( x > 0 &&( x + sw < cw) && y > 0 && (y + sh < ch) ) {
					Drag_ID.style.left = x + "px";
					Drag_ID.style.top = parseInt(y+moveTop) + "px";
					Drag_ID.style.margin = "auto";
				//}
			}
		}
		document.onmouseup = function () {moveable = false;};
		Drag_ID.onselectstart = function(e){return false;}
	}
	$("#wtips-content").attr("class","wtips-"+cssName);
	if( time == "" || typeof(time) == "undefined") {
		$("#wtips-close").click(function() {
			//showselect('t123_')
			$("#wtips-bg").remove();
			$("#wtips-box").fadeOut("slow",function(){$(this).remove();});
		});
	}else { 
		setTimeout(closeWindown,time);
	}
	//hideselect('t123_');
}
var closeWindown = function() {
	//showselect('t123_');
	$("#wtips-bg").remove();
	$("#wtips-box").fadeOut("slow",function(){$(this).remove();});
}

// *** win_PopupLayer ====================================================================================

Function.prototype.binding = function() {
    if (arguments.length < 2 && typeof arguments[0] == "undefined") return this;
    var __method = this, args = jQuery.makeArray(arguments), object = args.shift();
    return function() {
        return __method.apply(object, args.concat(jQuery.makeArray(arguments)));
    }
}

var Class = function(subclass){
	subclass.setOptions = function(options){
		this.options = jQuery.extend({}, this.options,options);
		for(var key in options){
			if(/^on[A-Z][A-Za-z]*$/.test(key)){
				$(this).on(key,'',options[key]);
			}
		}
	}
    var fn =  function(){
        if(subclass._init && typeof subclass._init == 'function'){
            this._init.apply(this,arguments);
        }
    }
    if(typeof subclass == 'object'){
        fn.prototype = subclass;
    }
    return fn;
}

var PopupLayer = new Class({
	options:{
		trigger:null,                            //触发的元素或id,必填参数
		popupBlk:null,                           //弹出内容层元素或id,必填参数
		closeBtn:null,                           //关闭弹出层的元素或id
		popupLayerClass:"popupLayer",            //弹出层容器的class名称
		eventType:"click",                       //触发事件的类型
		offsets:{                                //弹出层容器位置的调整值
			x:0,
			y:0
		},
		useFx:false,                             //是否使用特效
		useOverlay:false,                        //是否使用全局遮罩
		usePopupIframe:true,                     //是否使用容器遮罩
		isresize:true,                           //是否绑定window对象的resize事件
		onBeforeStart:function(){}            //自定义事件
	},
	_init:function(options){
		this.setOptions(options);                //载入设置
		this.isSetPosition = this.isDoPopup = this.isOverlay = true;    //定义一些开关
		this.popupLayer = $(document.createElement("div")).addClass(this.options.popupLayerClass);     //初始化最外层容器
		this.trigger = $(this.options.trigger);                         //把触发元素封装成实例的一个属性，方便使用及理解
		this.popupBlk = $(this.options.popupBlk);                       //把弹出内容层元素封装成实例的一个属性
		this.closeBtn = $(this.options.closeBtn);                       //把关闭按钮素封装成实例的一个属性
		$(this).trigger("onBeforeStart");                               //执行自定义事件。
		this._construct()                                               //通过弹出内容层，构造弹出层，即为其添加外层容器及底层iframe
		this.trigger.on(this.options.eventType,'',function(){            //给触发元素绑定触发事件
			if(this.isSetPosition){
				this.setPosition(this.trigger.offset().left + this.options.offsets.x, this.trigger.offset().top + this.trigger.get(0).offsetHeight + this.options.offsets.y);
			}
			this.options.useOverlay?this._loadOverlay():null;               //如果使用遮罩则加载遮罩元素
			(this.isOverlay && this.options.useOverlay)?this.overlay.show():null;
			if(this.isDoPopup && (this.popupLayer.css("display")== "none")){
				this.options.useFx?this.doEffects("open"):this.popupLayer.show();
			}							 
		}.binding(this));
		this.isresize?$(window).on("resize",'',this.doresize.binding(this)):null;
		this.options.closeBtn?this.closeBtn.on("click",'',this.close.binding(this)):null;   //如果有关闭按钮，则给关闭按钮绑定关闭事件
	},
	_construct:function(){                  //构造弹出层
		this.popupBlk.show(); 
		this.popupLayer.append(this.popupBlk.css({opacity:1})).appendTo($(document.body)).css({position:"absolute",'z-index':2,width:this.popupBlk.get(0).offsetWidth,height:this.popupBlk.get(0).offsetHeight});
		this.options.usePopupIframe?this.popupLayer.append(this.popupIframe):null;
		this.popupLayer.hide();
	},
	_loadOverlay:function(){                //加载遮罩
		pageWidth = ($.browser.version=="6.0")?$(document).width()-21:$(document).width();
		this.overlay?this.overlay.remove():null;
		this.overlay = $(document.createElement("div"));
		this.overlay.css({position:"absolute","z-index":1,left:0,top:0,zoom:1,display:"none",width:pageWidth,height:$(document).height()}).appendTo($(document.body)).append("<div style='position:absolute;z-index:2;width:100%;height:100%;left:0;top:0;opacity:0.3;filter:Alpha(opacity=30);background:#000'></div><iframe frameborder='0' border='0' style='width:100%;height:100%;position:absolute;z-index:1;left:0;top:0;filter:Alpha(opacity=0);'></iframe>")
	},
	doresize:function(){
		this.overlay?this.overlay.css({width:($.browser.version=="6.0")?$(document).width()-21:$(document).width(),height:($.browser.version=="6.0")?$(document).height()-4:$(document).height()}):null;
		if(this.isSetPosition){
			this.setPosition(this.trigger.offset().left + this.options.offsets.x, this.trigger.offset().top + this.trigger.get(0).offsetHeight + this.options.offsets.y);
		}
	},
	setPosition:function(left,top){          //通过传入的参数值改变弹出层的位置
		this.popupLayer.css({left:left,top:top});
	},
	doEffects:function(way){                //做特效
		way == "open"?this.popupLayer.show("slow"):this.popupLayer.hide("slow");
		
	},
	close:function(){                      //关闭方法
		this.options.useOverlay?this.overlay.hide():null;
		this.options.useFx?this.doEffects("close"):this.popupLayer.hide();
	}
});

/***** Jquery.webox_out ======================================================================================
 *	Plugin: Jquery.webox_out
 *	Developer: Blank
 *	Version: 1.0 Beta
 *	Update: 2012.07.08
**/
$.extend({
	webox:function(option){
		var _x,_y,m,allscreen=false;
		if(!option){
			alert('options can\'t be empty');
			return;
		};
		if(!option['html']&&!option['iframe']){
			alert('html attribute and iframe attribute can\'t be both empty');
			return;
		};
		option['parent']='webox';
		option['locked']='locked';
		$(document).ready(function(e){
			$('.webox_out').remove();
			$('.webox_bg').remove();
			var width=option['width']?option['width']:640;
			var height=option['height']?option['height']:480;
			$('body').append('<div class="webox_bg" style="display:none;"></div><div class="webox_out" style="width:'+width+'px;height:'+height+'px;display:none;"><div id="webox_in" style="height:'+height+'px;"><h1 id="locked" onselectstart="return false;">'+(option['title']?option['title']:'webox')+'<a class="span" id="webox_close" href="javascript:void(0);"></a></h1>'+(option['iframe']?'<iframe class="w_iframe" src="'+option['iframe']+'" frameborder="0" width="100%" scrolling="yes" style="border:none;overflow-x:hidden;height:'+parseInt(height-30)+'px;"></iframe>':option['html']?option['html']:'')+'</div></div>');
			if(option['bgvisibel']){
				$('.webox_bg').fadeTo('slow',0.3);
			};
			$('.webox_out').css({display:'block'});
			$('#'+option['locked']+' .span').click(function(){
				$('.webox_out').css({display:'none'});
				$('.webox_bg').css({display:'none'});
			});
			var marginLeft=parseInt(width/2);
			var marginTop=parseInt(height/2);
			var winWidth=parseInt($(window).width()/2);
			var winHeight=parseInt($(window).height()/2.2);
			var left=winWidth-marginLeft; if(left<2) left = 2;
			var top=winHeight-marginTop; if(top<2) top = 2;
			$('.webox_out').css({left:left,top:top});
			//* 拖动,双击事件
			$('#'+option['locked']).mousedown(function(e){
				if(e.which){
					m=true;
					_x=e.pageX-parseInt($('.webox_out').css('left'));
					_y=e.pageY-parseInt($('.webox_out').css('top'));
				}
			}).dblclick(function(){
					if(allscreen){
						$('.webox_out').css({height:height,width:width});
						$('#webox_in').height(height);
						$('.w_iframe').height(height-30);
						$('.webox_out').css({left:left,top:top});
						allscreen = false;
					}else{
						allscreen=true;
						var screenHeight = $(window).height();
						var screenWidth = $(window).width();$
						('.webox_out').css({'width':screenWidth-18,'height':screenHeight-18,'top':'0px','left':'0px'});
						$('#webox_in').height(screenHeight-20);
						$('.w_iframe').height(screenHeight-50);
					}
			});
		}).mousemove(function(e){
			if(m && !allscreen){
				var x=e.pageX-_x;
				var y=e.pageY-_y;
				$('.webox_out').css({left:x});
				$('.webox_out').css({top:y});
				try{ document.selection.empty(); }
				catch(e){ window.getSelection().removeAllRanges();}
			}
		}).mouseup(function(){
				m=false; //*/
		});
		/*$(window).resize(function(){
			if(allscreen){
				var screenHeight = $(window).height();
				var screenWidth = $(window).width();
				$('.webox_out').css({'width':screenWidth-18,'height':screenHeight-18,'top':'0px','left':'0px'});
				$('#webox_in').height(screenHeight-20);
				$('.w_iframe').height(screenHeight-50);
			}
		});	*/
	}
});



/*******************************************************************************
 File : \root\skin\jslib\jsbase.js 
*******************************************************************************/

//---------------------------------------------------
// *** 基础函数
//--------------------------------------------------- \

// 获取文件名
function urlFile(){
	var url = this.location.href
	var pos = url.lastIndexOf("/");
	if(pos == -1){
	   pos = url.lastIndexOf("\\")
	}
	var filename = url.substr(pos +1)
	return filename;
}
// 获取HTML页面参数 flag 为1 获取详细参数
function urlPara(key,def,url){
	url = url ? url : location.href;
	var re = (new RegExp("([^(&|\?)]*)" + key + "=([^(&|#)]*)").test(url+"#")) ? RegExp.$2 : '';
	if(def && !re) re = def;
	return re;
}
// ... 
function urlRep(url,key,val){
	if(url.indexOf('?')<=0) url += '?';
	if(key){
		val = val ? '&'+key+'='+val : ''; // new RegExp('(\\&'+_key+"=(\\d+))")
		url = url.replace(new RegExp('((\\&?)'+key+"=([^(&|#)]*))"),val); //\\w*
	}
	return url.replace('?&','?').replace('&&','&');
}
// Confirm
function urlConfirm(url,msg){
	if(msg=='go_url' || confirm(msg)){
		location.href = url;
		return true;
	}
	return false;
}
// urlEncode
function urlEncode(url,ext,percent){
	if(percent){
		url = url.replace('\\%','%25');	
	}
	var a = [ '\\#' , '\\&' ]; 
	var b = [ '%23' , '%26' ]; 
	var i;
	for(i=0; i<a.length;i++){
		url = url.replace(new RegExp(a[i],"g"),b[i]);
	};
	var c = [ '\\+' ,'\\ ' , '\\"' , "\\'" , '\\<' , '\\>' , "\\\r" , "\\\n" , "\\\\" ];
	var d = [ '%2B' ,'+'   , '%22' , '%27' , '%3C' , '%3E' , '%0D'  , '%0A'  , '%5C'  ];
	if(ext){
		for(i=0; i<c.length;i++){
			url = url.replace(new RegExp(c[i],"g"),d[i]);
		};
	} 
	return url;
}
// 按比例显示图片
function imgShow(obj,w,h){
	img = new Image(); img.src = obj.src; 
	zw = img.width; zh = img.height; 
	zr = zw / zh;
	if(w){ fixw = w; }
	else { fixw = obj.getAttribute('width'); }
	if(h){ fixh = h; }
	else { fixh = obj.getAttribute('height'); }
	if(zw > fixw) {
		zw = fixw; zh = zw/zr;
	}
	if(zh > fixh) {
		zh = fixh; zw = zh*zr;
	} 
	obj.width = zw; obj.height = zh;
}
// Json对象合并：var c=mjson(a,b,1); mjson({},[a,b]);
function jmJson(des, src, override){
    if(src instanceof Array){
        for(var i=0, len=src.length; i<len; i++)
             jmJson(des, src[i], override);
    }
    for(var i in src){
        if(override || !(i in des)){
            des[i] = src[i];
        }
    } 
    return des;
}
// int to hex
function toHex(n){	
	var h, l;
	n = Math.round(n);
	l = n % 16;
	h = Math.floor((n / 16)) % 16;
	return (tabHex1[h] + tabHex1[l]);
}

// getBrowser
function getBrowser(){ 
	// Safari, Android, Opera, Chrome, MSIE
	// MSIE, Firefox, Chrome, Safari, Opera
	var b = {}; 
	//b.WebKit = jsTest('Webkit');
	//b.Gecko = jsTest('Gecko') && !jsTest('Webkit'); 
	//b.Trident = jsTest('Trident');
	b.Safari = jsTest('Safari') && !jsTest('Chrome'); 
	b.Opera = jsTest('Opera');
	b.Firefox = jsTest('Firefox');
	b.Android = jsTest('Android');
	b.Chrome = jsTest('Chrome');
	b.IE = jsTest('Trident') || jsTest('MSIE');
	b.IE6 = jsTest('MSIE 6');
	b.IE7 = jsTest('MSIE 7');
	b.IE8 = jsTest('MSIE 8');
	return b;
}
function setEvent(onAct,doAct,ID,tag) {
	var oItems = jsElm.jeID(ID).getElementsByTagName(tag);
	for(var i = 0;i<oItems.length;i++){
		oItems[i].setAttribute(onAct,doAct+"(this)"); //IE8,isFirefox
		//var b = getBrowser(); if(b.IE6||b.IE7) .setAttribute(onAct,function(){eval(doAct+"(this)")});
	}
}
// jqInit
function jqInit(data){
	eval("jQuery(document).ready(function(){"+data+"});");
}

var jsElm = {}; //通过id得到web相关元素
jsElm.pdID = function(id){ // 获取iframe父窗口id对应的web元素
	return typeof id == 'string' ? parent.document.getElementById(id) : id; 
}
jsElm.ifID = function(id){ // 获取iframe，id为iframe的对应ID
	return document.getElementById(id).contentWindow;
	//return window.frames[id]; //id为name值
}
jsElm.jeID = function(id){ // 通过id得到web元素
	return typeof id == 'string' ? document.getElementById(id) : id;
}
jsElm.jeTag = function(tag){ // 通过tag名称得到web元素(第一个),tag=body,head,p
	return document.getElementsByTagName(tag)[0];
}

// 查找e元素的前一个/下一个/父元素,且元素名称为tag
function jeFind(e,tag,type) {
	e = jsElm.jeID(e); var f;
	if(type=='prev') f = e.previousSibling;
	else if(type=='next') f = e.nextSibling;
	else f = e.parentNode; 
	try{
		while(f.nodeType==3){
			if(type=='prev') f = f.previousSibling;
			if(type=='next') f = f.nextSibling;
		}
	}catch(ex){ return null; }
	if(f.tagName.toLowerCase()==tag) return f;
	else return jeFind(f,tag,type);
}
// 显示/隐藏e元素
function jeShow(xID){
  var elm = jsElm.jeID(xID); 
  if(!elm) return;
  if(elm.style.display=='none') { elm.style.display = ''; }
  else { elm.style.display = 'none'; } 
} 
// 居中显示div，xOffset:百分比
function jeCenter(xID,xOffset){
	var elm = jsElm.jeID(xID); 
	var oSize = jeSize(xID);
	var wSize = winSize();
	var top=0,left=0;
	top = (wSize.winHeight-oSize.height)/2;
	left = (wSize.winWidth-oSize.width)/2;
	if(xOffset) top = top - parseInt(top*xOffset/100);
    elm.style.top = top + "px";
    elm.style.left = left + "px";
}
// 元素大小
function jeSize(xID){
	var elm = jsElm.jeID(xID); 
	var obj = {};
	obj.width = elm.offsetWidth;
	obj.height = elm.offsetHeight;
	return obj;
} 
//获取元素的位置 
function jePos(obj) { 
	var pos = $('#'+obj).offset();
	return [pos.left,pos.top];
	var obj = jsElm.jeID(obj); 
	if (obj == null) return null; 
	var posLeft = obj.offsetLeft; 
	var posTop = obj.offsetTop; 
	//while (obj != null && obj.offsetParent != null && obj.offsetParent.tagName != "BODY") { 
		//posLeft = posLeft + obj.offsetParent.offsetLeft; 
		//posTop = posTop + obj.offsetParent.offsetTop; 
	//} 
	return [posLeft,posTop]; 
}; 

function isObj(obj,type){ 
    var cons = obj.constructor.toString();
	if(type=='a') type='Array';
	if(type=='b') type='Boolean';
	if(type=='f') type='Function';
	if(type=='n') type='Number';
	if(type=='s') type='String';
	if(!type) type = 'Object';
	return (cons.indexOf(type)!= -1);
}
// 正则测试str,如判断ie6浏览器
function jsTest(c,str) {  
	if(!str) str = navigator.userAgent; 
	if(!c) c = 'MSIE 6';
	else if(!isNaN(c)) c = 'MSIE '+c; 
	var pos = str.indexOf(c);
	return pos<0 ? false : true; //reg.test(str);
}
// jsKeys
function jsKey(fid){
	var a = new Array("[",']',' ','/','-','.','&','=','#','?');
	var b = new Array("_",'_','_','_','_','_','_','_','_','_');
	for(var i=0;i<a.length;i++){
		fid = fid.replace(a[i],b[i]).replace(a[i],b[i]).replace(a[i],b[i]); 
	}
	return fid;
}
// jsReplace
function jsRep(str){
	var a = new Array("'",'"','\n','\r');
	var b = new Array("\\'",'\\"','\\n','\\r');
	for(var i=0;i<a.length;i++){
		str = str.replace(new RegExp(a[i],'g'),b[i]);
	}
	return str;
}
// removeHTMLTag
function jsText(str){ 
	str = str.replace(/<\/?[^>]*>/g,''); //去除HTML tag
	str = str.replace(/[ | ]*\n/g,'\n'); //去除行尾空白
	//str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
	str=str.replace(/&nbsp;/ig,'');//去掉&nbsp;
	return str;
}
// lang('jcore.jstag_toolong',id)
// {lang(jcore.sys_name)}
function lang(mk, val){
	if(mk.indexOf('.')<=0) mk = "jcore."+mk;
	try{ 
		vre = eval("Lang."+mk); 
	}catch (ex1){ return '{'+mk+'}'; }
	// jsLog(vre);
	if(typeof(val)=="undefined") return vre;
	vre = vre.replace('{val}',val); 
	return vre;
}
// 动态导入Js/CSS文件 使用 命名空间方式 
function jsImp(sFile,basePath,callback){     
	if(_cbase.run.jsimp.indexOf(sFile)<=0) _cbase.run.jsimp += ','+sFile;
	else return;  
	if(typeof(basePath)=='undefined') basePath = _cbase.run.roots;
	if(basePath.length==0) basePath = _cbase.run.roots;
	bFile = sFile;
	sFile = basePath + sFile; 
	ext = sFile.substr(sFile.length-4); //alert(sFile);
	if(callback=='{code}'){
		var _tpl = "<script src='{file}'></script>"; 
		if(ext=='.css') _tpl = "<link rel='stylesheet' type='text/css' href='{file}'/>";
		var _code = _tpl.replace('{file}',sFile);
		document.write(_code);
	}else if(ext=='.css'){ 
		document.createStyleSheet(sFile); 
	}else{
		try{ 
			jQuery.getScript(sFile,function(){
				if(callback){ try{
					var func = callback + (callback.indexOf('()')<=0 ? '' : '()');
					eval(""+func+";");
				}catch(ex2){ jsLog(ex2); } } 
			}); 
		}catch (ex1){ jsLog(ex1); }
	}
}

// 检测str是否定义,
// 如定义: 返回true,str值
// 未定义: 返回false,''
function jsVar(str, debug){ 
	var re = new Array(false,'');
	try{ 
		eval('var temp = '+str+';');
		re[0] = true;
		re[1] = temp;
	}catch(e){ 
		if(debug) alert('jsVar()'); 
	}
	return re;
}
// runData
function jsTry(data,debug){
	try{ eval(data); }
	catch(ex){ if(debug) alert('jsTry()'); }
}

function jsEval(str){
	if(isObj(str,'f')){
		str();
	}else if(str.indexOf('(')>0){ 
		eval(fn);
	}else{
		eval(fn+'();'); 
	}
}
// 调试信息
function jsLog(msg,color){
	// ?? debug模式
	if(window.console){ 
		var cstr = '';
		if(color){
			var cstr = 'color:'+color;
			msg = '%c'+msg;
		}
		console.log(msg,cstr);
	}else{
		;//	
	}
}
// 调试时间
function jsTime(flag,end){
	if(end) console.timeEnd(flag);
	else console.time(flag);	
}
// jsRnd
function jsRnd(flag,iMax){
	if(iMax) return Math.floor(flag+Math.random()*(iMax-flag));
	if(!flag) flag = '_r';
	var r = new Date().getTime(); //Math.random();
	var s = flag+'='+r;
	try{ s += '&lang='+_cbase.sys.lang; }
	catch(ex){ }
	return s;
}



/*******************************************************************************
 File : \root\skin\jslib\jsbext.js 
*******************************************************************************/

//---------------------------------------------------
// *** 基本扩展函数
//--------------------------------------------------- \

function setCookie(name,value,exp_secs,path,domain){
	var key = _cbase.ck.ckpre+name;
	var never = new Date(); // _cbase.sys.tzone*3600时区...
	never.setTime(never.getTime()+exp_secs*1000); //单位毫秒  
	var sexp = exp_secs ? "; expires="+ never.toGMTString()+";" : ''; 
	path = (path != null && path != '') ? '; path=' + path : '; path='+_cbase.ck.ckpath;
	domain = (domain != null && domain != '') ? '; domain=' + domain : '';
	document.cookie = key+"="+escape(value)+sexp+path+domain;	
}

function getCookie(name){
	var key = _cbase.ck.ckpre+name;
	if (document.cookie.length>0){
		c_start=document.cookie.indexOf(key + "=")
		if (c_start!=-1){ 
			c_start=c_start + key.length+1 
			c_end=document.cookie.indexOf(";",c_start)
			if (c_end==-1) c_end=document.cookie.length
			return unescape(document.cookie.substring(c_start,c_end))
		} 
	}
	return '';
}

// 系统开窗(System)
function winOpen(e,title,width,height,ext){
	var width = width ? width : 640;
	var height = height ? height : 480;
	var url,title,wt=_cbase.sys_open;
	if(isObj(e,'s')){
		url = e;
		title = title ? title : "winOpen";
	}else{ //a
		url = e.href;
		title = title ? title : e.innerHTML;	
	}
	url += (url.indexOf('?')>0 ? '' : '?') + '&' + jsRnd('dialog');
	if(wt==1){ 
		var _x = (screen.width-width)/2, _y = (screen.height-height)/2, id = ext ? '_win_'+jsKey(ext) : '_win_';
		var p = ",left="+_x+",top="+_y+",width="+width+",height="+height+"";
		window.open(url,id,'scrollbars=yes,toolbar=no,location=no,status=no,menubar=no,resizable=yes'+p); 
	}else if(wt==2){ 
		$.webox({title:title, iframe:url, width:width, height:height, bgvisibel:false }); 
	}else if(wt==3){  
		tipsWindown(title,'iframe:'+url,width,height,'true','','0','content-boxCss');
	}else if(wt==4){
		var ops = {type:2, fix:false, maxmin:true, title:[title,true], area:[width+'px',height+'px'], content:[url]};
		layer.open(ops);
	}
	return false; 
}
// 窗口大小-winSize() --- quirksmode.org
function winSize(re){ 
	if(!re) re = 'win';
	if(re=='win'){ //浏览器时下窗口可视区域宽/高度
		w = $(window).width();
		h = $(window).height();
	}else if(re=='doc'){ //浏览器时下窗口文档的宽/高度
		w = $(document).width();
		h = $(document).height(); 
	}else if(re=='body'){ //浏览器时下窗口文档body的宽/高度
		w = $(document.body).width();
		h = $(document.body).height();
	}else if(re=='out'){ //浏览器时下窗口文档body的总宽/高度 包括border padding margin
		w = $(document.body).outerWidth();
		h = $(document.body).outerHeight();	
	}else if(re=='scroll'){ //获取滚动条到左边/顶部的垂直宽/高度
		w = $(document).scrollLeft();
		h = $(document).scrollTop();	
	} //jsLog(h);
	return {w:w,h:h};
}
// 
function winAutoMargin(div,gap){
	if(!div) div = 'topMargin';
	if(!gap) gap = 20;
	wv = winSize('win'); //jsLog(wv);
	wc = winSize('out'); //jsLog(wc);
	if(wv.h>wc.h+gap){ 
		$('#'+div).show();
		$('#'+div).height((wv.h-wc.h-gap/2)*0.33);
	}else{
		$('#'+div).hide();	
	}
}

// 前后台 表单 ===================================================================================================

function fsCHidd(fmid){
	jsElm.jeID(fmid+'_vBox').style.display = 'none';
}
// 认证码初始化(认证码:onFocus触发)
function fsCode(fmid,reLoad,x,y){
	var box = jsElm.jeID(fmid+'_vBox');
	if(box.innerHTML.length<24){
	  x = x ? x : 3; y = y ? y-25 : -20;
	  var img = '<samp class="fs_vimg_span" style="left:'+x+'px;top:'+y+'px;">';
	  img += '<img id="'+fmid+'_vimg" src="'+_cbase.run.roots+'/skin/a_img/blank.gif" onclick=\'fsCode("'+fmid+'","reLoad")\' title="'+lang('jcore.vcode_upd')+'" />';
	  img += '<samp class="fs_vimg_close" onclick=\'fsCHidd("'+fmid+'")\' title="'+lang('jcore.hide')+'">[X]</samp></samp>';
	  box.innerHTML = img; 
	  reLoad = 1;
	} 
	if(box.style.display=='none') box.style.display = ''; 
	//超时检测...
	var fimg = jsElm.jeID(fmid+'_vimg');
	if(reLoad){ 
		var fimg = jsElm.jeID(fmid+'_vimg');
		var para = "?mod="+fmid+"&"+jsRnd()+"&"+_cbase.safil.url;
		fimg.setAttribute("src",_cbase.run.roots+"/plus/ajax/vimg.php"+para);
	}
	$("p#evf_vtip").remove(); //onFocus触发后,保证把前一个tip清理掉,否则挡住了认证码.
}
// 重新加载-安全配置项 ??? 
function fsReLoad(fmid){
	var js = jsElm.jeID('jssrc_'+fmid);
	js.src += 1;
}
// 表单认证码
function fsInit(fmid,css1,css2,tabi){
	url = _cbase.run.roots+'/plus/ajax/cajax.php?act=fsInit&fmid='+fmid;
	if(css1) url += '&css1='+css1;
	if(css2) url += '&css2='+css2;
	if(tabi) url += '&tabi='+tabi;
	para = '&'+_cbase.safil.url+'&'+jsRnd();
	document.write('<script src="'+url+para+'" id="jssrc_'+fmid+'"></'+'script>');
}

// 选择-所有
function fmSelAll(e,fm,r,no) {
	if(!fm) fm = 'fmlist';
	if(!r) r = 'tr';
	if(!no) no = 0;
	var row = jsElm.jeID(fm).getElementsByTagName(r);
	for(var i=0;i<row.length;i++){
		var ir = row[i].getElementsByTagName('input');
		if(ir.length>0) ir[0].checked = e.checked;;
	}
}
// 选择-组, class以cbg_开头,如:class="cbg_types" 
function fmSelGroup(e,part) {
	$("input.cbg_"+part).each(function() {
		$(this).prop("checked", e.checked); 
	});	
}

// 前台ajax调用资料使用 ===================================================================================================

function jcronRun(tpldir,mkv,reurl){
	tpldir = tpldir ? tpldir : ((typeof(_cbase.run.tpldir)=='undefined') ? '' : _cbase.run.tpldir);
	mkv = mkv ? mkv : ((typeof(_cbase.run.mkv)=='undefined') ? '' : _cbase.run.mkv);
	mkv = (typeof(_cbase.run.mkv)=='undefined') ? '' : _cbase.run.mkv;
	var url = '/plus/ajax/cron.php?tpldir='+tpldir+'&mkv='+mkv+'&'+_cbase.safil.url+'&'+jsRnd();
	if(reurl) return url;
	jsImp(url); 
}
function jtagSend(){
	var base = window.location.pathname; //'http://'+window.location.host+
	var url = '/plus/ajax/jshow.php?tpldir='+_cbase.run.tpldir+'&mkv='+_cbase.run.mkv+'&'+jsRnd(); 
	var n = 0, last = 0;
	$("[id^='jsid_']").each(function(){
		var id = this.id; 
		var val = jtagPara(this);
		var data = '&'+id+'='+val; 
		if(id.length>12){ // && val.length>3
			lena = url.length+data.length+base.length;
			if(lena>2000){ // 2038
				jtagRep(id,'<i class="cC3C">'+lang('jcore.jstag_toolong',id)+'('+lena+')</i><br>');
			}else{
				url += data; last = data.length;
			} 
		}
	}); 
	if(url.indexOf('&jsid')>0){ 
		jsImp(url); //console.log((url.length)+':'+(last)+':'+url); 
	}
}
function jtagPara(e){
	var s = $(e).html().replace('0<!--','').replace('<!--','').replace('-->',''); 	
	s = urlEncode(s,1,1);
	return s;
}
function jtagRep(id,rep){
	$('#'+id).after(rep);
	$('#'+id).remove();
}

// 二维码例子(jq) =========================================================================================

function qrCode(id,info,w,h){ //id='qrcodeA1', info='www.txmao.com'
    jQuery('#'+id).qrcode({render:"table",text:info,width:90,height:90,correctLevel:3 });
}

// 拼音/简繁 ===================================================================================================
 
function pinyinMain(str){
  var pyTab = pycfgTab();
  py = ""; //(nou)耨,1;
  for(var i=0;i<str.length;i++){
	  ch = str.charAt(i);
	  code = str.charCodeAt(i);
	  if(code<128){
	  	  py += str.charAt(i); 
	  }else{
		  p = pyTab.indexOf(ch);
		  if(p>0){
			  s = pyTab.substr(0,p);
			  p = s.lastIndexOf("(");
			  s = s.substr(p+1);
			  s = s.substr(0,s.indexOf(')'));
			  py += s; 
		  }
	  }
  }
  return py; 
}

function jianfanMain(str,type){
  var jTab = jfcfgJian();
  var fTab = jfcfgFan();
  if(type=='j2f'){ tab1 = jTab; tab2 = fTab; }
  if(type=='f2j'){ tab2 = jTab; tab1 = fTab; }
  jf = ""; //(nou)耨,1;
  for(var i=0;i<str.length;i++){
	  ch = str.charAt(i);
	  code = str.charCodeAt(i);
	  if(code<128){
	  	  jf += ch; 
	  }else{
		  p1 = tab1.indexOf(ch);
		  if(p1>0){
			  ch = tab2.charAt(p1);
			  jf += ch; 
		  }else{
			  jf += ch; 
		  }
	  }
  }
  return jf; 
}

// 联动select ===================================================================

// 联动select-初始化
// mselInit('typlays','fmxid','china','c0769','省份,地区');
function mselInit(vsid,fmid,dkey,vdef,titles){
	var vlay,a,i,pid,ops,s,j;
	eval("window._msel_"+fmid+"_titles = '"+(titles ? titles : '')+"';");
	vlay = vdef ? dataLays(dkey,vdef) : ';';
	a = vlay.split(';'); 
	s = '<input name="'+fmid+'" id="'+fmid+'" type="hidden" value="'+vdef+'">';
	for(i=0;i<a.length-1;i++){ 
		pid = i ? a[i-1] : '0';
		ops = mselOpts(dkey+'-'+pid,a[i]); 
		s += mselElms(fmid,dkey,i,ops);
		j = i;
	}
	if(!(vlay==';')){
		ops = mselOpts(dkey+'-'+a[j]); 
		if(ops) s += mselElms(fmid,dkey,a.length-1,ops);
	}
	$('#'+vsid).html(s);
}
// 联动select-选择事件
// onchange=mselAct(fmid,dkey,no)
function mselAct(fmid,dkey,no){
	id = fmid+"_"+no;
	val = $('#'+id).val(); 
	$(jsElm.jeID(fmid)).val(val); 
	if(val){
		ops = mselOpts(dkey+'-'+val); 
		if(ops){ 
			s = mselElms(fmid,dkey,no+1,ops);
			$('#'+id).parent().append(s); 
		}
	}else{
		for(i=no+1;i<no+5;i++){
			$('#'+fmid+"_"+i).remove();
		}
	}

}
// 联动select-得到option
function mselOpts(dkey,vdef){
	var i,a,ops='';
	data = sordb_data(dkey);
	for(i=0;i<data.length;i++){
		a = data[i].split('=');
		if(a[0]){
			ops += "<option value='"+a[0]+"' "+(a[0]==vdef ? 'selected' : '')+">"+a[1]+"</option>";
		}
	}
	return ops;
}
// 联动select-得到select
function mselElms(fmid,dkey,no,ops){
	var id,a,op0,s;
	id = fmid+"_"+no; 
	if(jsElm.jeID(id)){
		$('#'+id).remove();
	}
	eval("a = window._msel_"+fmid+"_titles.split(',');");
	op0 = "<option value=''>-"+(a[no] ? a[no] : lang('jcore.pleaseselect'))+"-</option>";
	s = "<select id='"+id+"' onchange=\"mselAct('"+fmid+"','"+dkey+"',"+no+")\">"+op0+ops+"</select>";
	return s;
}

// localStorage/sessionStorage ===================================================================

/**
 * @class multiStore
 * @author Peace@txmao.com
 * @参考: http://www.cnblogs.com/zjcn/archive/2012/07/03/2575026.html#comboWrap
 * Demo: 
	var locStore = new multiStore('local');
	var sesStore = new multiStore('session');
	locStore.set('aa1','bb1');
	var tt1 = locStore.get('aa1');
	console.log(tt1);
	sesStore.set('aa2','bb2');
	var tt2 = sesStore.get('aa2');
	console.log(tt2);
 */
function multiStore(flag){ // local,session
	this.parFlag = flag=='session' ? 'sessionStorage' : 'localStorage';
	this.parStore = flag=='session' ? window.sessionStorage : window.localStorage;
	// 是否支持localStorage/sessionStorage
	this.ready = function(){ 
		return (this.parFlag in window) && (window[this.parFlag] !== null); 
	};
	// 扩展 : 最多设置保存mnum个key(如最近浏览历史记录)
	// demo: locStore|sesStore.setGroup('{$ckpre}chid{$chid}','{aid}',10); // ('_auto_dev52_chid2','542350',10); 
	// ??? 一条记录存储更多信息? 这里没有处理, 统一规范? 目前要扩展, 如类似信息【id|529026;time|14-07-2110:50】
	this.setGroup = function(keyid,nowkey,mnum){
		if(nowkey.length==0) return;
		if(!mnum) mnum = 10;
		var oldkeys = this.get(keyid); 
		if(!oldkeys){ 
			var keystr = nowkey;
		}else{ 
			var oldarr = oldkeys.split(','); 
			var keystr = nowkey; unum = 1;
			for(var i=0;i<oldarr.length;i++){ 
				if(oldarr[i]==nowkey || oldarr[i].length==0) continue;
				if(unum<mnum){
					keystr += ','+oldarr[i];	
					unum++;
				}else{
					break;	
				}
			}
		}
		keystr = keystr.replace(/[^0-9A-Za-z_\.\-\:\,\|\;]/g,''); // setGroup内容字符限制 \=\)\(\]\[  善用ascii码
		this.set(keyid,keystr);
	};
	// 扩展 : 初始化信息(不支持localStorage/sessionStorage)
	// demo: locStore|sesStore.initMessage('itemList','<li class="none">不支持localStorage/sessionStorage(本地存储)</li>')
	this.initMessage = function(id,msg){
		var canFlag = this.ready();
		if(!canFlag) document.getElementById(id).innerHTML = msg;
	};
	// 设置值
	this.set = function(key, value){
		//在iPhone/iPad上有时设置setItem()时会出现诡异的QUOTA_EXCEEDED_ERR错误；这时一般在setItem之前，先removeItem()就ok了
		if( this.get(key) !== null )
			this.remove(key);
		this.parStore.setItem(key, value);
	};
	// 获取值 查询不存在的key时，有的浏览器返回undefined，这里统一返回null
	this.get = function(key){
		var v = this.parStore.getItem(key);
		return v === undefined ? null : v;
	};
	this.each = function(fn){
		var n = this.parStore.length, i = 0, fn = fn || function(){}, key;
		for(; i<n; i++){
			key = this.parStore.key(i);
			if( fn.call(this, key, this.get(key)) === false )
				break;
			//如果内容被删除，则总长度和索引都同步减少
			if( this.parStore.length < n ){
				n --;
				i --;
			}
		}
	};
	this.remove = function(key){
		this.parStore.removeItem(key);
	}
	this.clear = function(){
		this.parStore.clear();
	};
	
}



/*******************************************************************************
 File : \root\skin\jslib\jsmove.js 
*******************************************************************************/

// 鼠标拖动层(jq) =========================================================================================

function moveDiv(idBox,idBar){  
  var isClick = false; //记录鼠标是否按下
  var ClickX,ClickY; //按下鼠标时候的坐标
  var mouseX,mouseY; //移动的时候的坐标
  var nowTop,nowLeft; //移动层距离上边和左边的距离
  var cwin = winSize(); cwin.pageWidth -= 20;
  var dwin = jeSize(idBox.replace('#',''));
  $(idBar).mousedown(function(e){ //按下鼠标
	 isClick = true; 
	 ClickX = e.pageX;
	 ClickY = e.pageY;
	 nowTop = $(idBox).css("top");
	 nowLeft = $(idBox).css("left");
	 nowTop = parseFloat(String(nowTop).substring(0,String(nowTop).indexOf("px")));
	 nowLeft = parseFloat(String(nowLeft).substring(0,String(nowLeft).indexOf("px")));
  }); //moveDiv click fun
  $(idBar).mousemove(function(e){ //移动鼠标
	  mouseX = e.pageX;
	  mouseY = e.pageY;
	  if(isClick &&mouseX>0 &&mouseY>0){ 
		  var newTop = parseFloat(mouseY-ClickY)+nowTop;
		  var newLeft = parseFloat(mouseX-ClickX)+nowLeft;
		  if(newTop<5) newTop = 5;
		  if(newLeft<5) newLeft = 5;
		  if(newLeft+dwin.width>cwin.pageWidth) newLeft = cwin.pageWidth - dwin.width;
		  $(idBox).css({"top":newTop});
		  $(idBox).css({"left":newLeft});
	  } //if end       
  });
  $(idBar).mouseup(function(e){ //松开鼠标
	  isClick = false; 
  }); 
}
// Demo 
// <div id="moveBox" style="position:absolute; width:400px; height:300px; top:20px; left:20px; border:#0C6 1px solid;">
// <div id="moveBar" style="background:#39C; cursor:move; padding:5px;">可以拖动我哦！</div>
// Content </div>
//moveDiv('#moveBox','#moveBar');

// 移动层的类/相关 =======================================================================================
function moveUnSelect(){
	try{ document.selection.empty(); }
	catch(e){ window.getSelection().removeAllRanges();}
}
function moveMain(){
    //if(!movingNow) movingNow = new moveMain();
	this.Move = function(DivID,Evt){
        if(DivID == "") return;
        var DivObj = document.getElementById(DivID);
        evt = Evt?Evt:window.event;
        if(!DivObj) return;
        var DivW = DivObj.offsetWidth;
        var DivH = DivObj.offsetHeight;
        var DivL = DivObj.offsetLeft;
        var DivT = DivObj.offsetTop;
        var TemDiv = document.createElement("div");
        TemDiv.id = DivID + "tem";
        document.body.appendChild(TemDiv);
        TemDiv.style.cssText = "width:"+DivW+"px;height:"+DivH+"px;top:"+DivT+"px;left:"+DivL+"px;position:absolute; border:#ff0000 1px dotted;z-index:500";
        this.MoveStart(DivID,evt);
    }
    this.MoveStart = function(DivID,Evt){
		var tmpMove = document.getElementById(DivID+"tem");
        if(!tmpMove) return;
        evt = Evt?Evt:window.event;
        var rLeft = evt.clientX - tmpMove.offsetLeft;
        var rTop = evt.clientY - tmpMove.offsetTop;
        document.onmousemove = function(e){
            if (!tmpMove) return;
			moveUnSelect();
            e = e ? e : window.event;
            if (e.clientX - rLeft <= 0){
                tmpMove.style.left = 0 +"px";
            }else if(e.clientX - rLeft >= document.documentElement.clientWidth - tmpMove.offsetWidth - 2){
                tmpMove.style.left = (document.documentElement.clientWidth - tmpMove.offsetWidth - 2) +"px";
            }else{
                tmpMove.style.left = e.clientX - rLeft +"px";
            }
            if (e.clientY - rTop <= 1){
              	//;
            }else{
                tmpMove.style.top = e.clientY - rTop +"px";
            }
        }
        document.onmouseup = function(){
            if (!tmpMove){return;}
            var DivObj1 = document.getElementById(DivID);
            if (!DivObj1) return;
            var l0 = tmpMove.offsetLeft;
            var t0 = tmpMove.offsetTop;
            DivObj1.style.top = t0 + "px";
            DivObj1.style.left = l0 + "px";
			try{sha_moved(DivID);}catch(sha){}
            document.body.removeChild(tmpMove);
            tmpMove = null;
        }   
    }
}
// Demo
//<div id="eout" style="position:absolute; width:400px; top: 154px; left: 270px; height:300px; border:1px solid #006">
//<div id="etitle" style="cursor:move; background:#999;" onmousedown="movingNow.Move('eout',event)">Title</div>
//This is the Demo for Move Div ... </div>\
// var movingNow = new moveMain()

/*
function mouseMove(ev) {
	ev2 = ev || window.event;
	mousePos = mouseCoords(ev2);
}
function mouseCoords(ev) {
	if (ev.pageX || ev.pageY) {
		return { x: ev.pageX, y: ev.pageY };
	}
	try{ //IE6下,在开窗中再打开设置窗,显示错误,但不影响功能。
	  return {  
		x: ev.clientX + (document.documentElement.scrollLeft || document.body.scrollLeft),
		y: ev.clientY + (document.documentElement.scrollTop || document.body.scrollTop)
	  };
	}catch(e){}
}
//var mousePos; document.onmousemove = mouseMove;
*/



/*
$(function(){
	var dragging = false;
	var iX, iY;
	$("#drag").mousedown(function(e) {
		dragging = true;
		iX = e.clientX - this.offsetLeft;
		iY = e.clientY - this.offsetTop;
		this.setCapture && this.setCapture();
		return false;
	});
	document.onmousemove = function(e) {
		if (dragging) {
		var e = e || window.event;
		var oX = e.clientX - iX;
		var oY = e.clientY - iY;
		$("#drag").css({"left":oX + "px", "top":oY + "px"});
		return false;
		}
	};
	$(document).mouseup(function(e) {
		dragging = false;
		$("#drag")[0].releaseCapture();
		e.cancelBubble = true;
	})

})
*/
/*
<style type="text/css">
	#drag{width:400px;height:300px;background:url(http://upload.yxgz.cn/uploadfile/2009/0513/20090513052611873.jpg);cursor:move;position:absolute;top:100px;left:100px;border:solid 1px #ccc;}
	h2{color:#fff;background: none repeat scroll 0 0 rgba(16, 90, 31, 0.7);color:#FFFFFF;height:40px;line-height:40px;margin:0;}
</style>
*/
/*--------------拖曳效果----------------
*原理：标记拖曳状态dragging ,坐标位置iX, iY
*         mousedown:fn(){dragging = true, 记录起始坐标位置，设置鼠标捕获}
*         mouseover:fn(){判断如果dragging = true, 则当前坐标位置 - 记录起始坐标位置，绝对定位的元素获得差值}
*         mouseup:fn(){dragging = false, 释放鼠标捕获，防止冒泡}
*/



/*******************************************************************************
 File : \root\skin\jslib\jspop.js 
*******************************************************************************/

function relStore(fm2){
	var sid = 'sid__'+fm2.replace('[','_').replace(']','_');
	if(!jsElm.jeID(sid)){ 
		var html = $(jsElm.jeID(fm2)).html();
		$("body").append("<select id='"+sid+"' style='display:none;'>"+html+"</select>");	
	}
	return $('#'+sid);
}

function relInit(relid,fm1,fm2){
	var rcfg, o1 = jsElm.jeID(fm1), o2 = jsElm.jeID(fm2); 
	eval('rcfg = _'+relid+'_data;'); 
	var key='', val='', html='', _bak = relStore(fm2);
	for(var k in rcfg){ 
		if($(o1).val()==k){
			key = k;
			val = rcfg[k];
			break;
		}
	} //jsLog(key);
	if(val.length>1){
		$(_bak).find('option').each(function(index, element) { //jsLog($(this).html());
			var v2 = $(this).val(), text = $(this).html(), sel = v2==$(o2).val() ? 'selected' : ''; 
			if(v2.length<=1 || val.indexOf(v2)>=0) html += "<option value='"+v2+"' "+sel+">"+text+"</option>"; 
		});
	}else{
		html = $(_bak).html();	
	}
	$(jsElm.jeID(fm2)).html(html);	
	//jsLog(key+':'+val);
}

function relCatid(pid,mod,kid,catid){
	$(".ins_catid_rows").remove(); //移除添加的项目
	catid = catid ? catid : 'fm[catid]'; 
	var val = $(jsElm.jeID(catid)).val();
	if(val.length==0) return; //
	var url = _cbase.run.roots+'/plus/ajax/cajax.php?act=cfield&mod='+mod+'&catid='+val+'&fm[kid]='+kid;
	$.get(url, function (res) { 
		var eobj = $(jsElm.jeID(pid)).parent().parent(); 
		if(res.length>12){  
			var reg = new RegExp('<tr>', "gi"); //添加标记,便于控制
			res = res.replace(reg,'<tr class="ins_catid_rows">');
			$(eobj).after(res); //before
		}
	}); 
}

// wpop_pick.js
// wpop_data.js

// *** wpop_pick.js: color颜色,map地图,popDiv =============================================================
// color颜色
function colorPick(color,title){
	var popid = color+'_pop'; 
	jeShow(popid);
	if(jsElm.jeID(popid).innerHTML.length<24){
		var fpara = '?color='+color+'&title='+title+'&'+jsRnd();
		var fname = ' id="'+jsKey(color)+'_win" name="'+jsKey(color)+'_win" width="100%" height="100%" ';
		var frame = '<iframe '+fname+' src="'+_cbase.run.roots+'/plus/api/color.php'+fpara+'" frameborder="0" scrolling="no"></iframe>'
		jsElm.jeID(popid).innerHTML ='<span class="color_in">'+frame+'</span>';
	}else{
		window.frames[jsKey(color)+'_win'].resOrg.style.color = '#'+jsElm.jeID(color).value;
	}
}
function colorSet(color,title){
	jsElm.jeID('fm['+title+']').style.color = '#'+color;
}
// map地图
function mapPick(type,fid,w,h){
	var point = jsElm.jeID(fid).value; 
	url = _cbase.run.roots+'/plus/map/index.php?type='+type+'&act=pick&point='+point+'&title='+fid+'';
	if(!w) w = 720; if(!h) h = 480;
	popOpen(lang('jcore.pop_pickmap'),url,w,h);
}
// 检查重复 ：id='fm_repeat_' onclick="repCheck('news','title','fid');"
function repeatCheck(mod,fid,kid){
	var para = 'act=infoRepeat&mod='+mod+'&fid='+fid+'&kwd='+jsElm.jeID('fm['+fid+']').value+'';
	jQuery.getScript(_cbase.run.roots+'/plus/ajax/cajax.php?'+para,function(){ 
		var re = _repeat_res=='success' ? lang('jcore.pop_repeat') : _repeat_res;
		layer.tips(re, '#fm_repeat_'+kid, {tips:3});
	});
}
// 资料选取Pick
function pickOpen(modid,retitle,refval,refname,cntre,exparas){
	var emod = jsElm.jeID(modid); 
	var mod = emod ? emod.value : modid;
	if(mod==''){ layer.tips(lang('jcore.pop_pickmod'),'#'+modid); return; }
	var url = _cbase.run.roots+'/plus/ajax/pick.php?';
	refval = encodeURIComponent(refval);
	refname = encodeURIComponent(refname);
	cntre = cntre ? cntre : 1;
	//exparas: fso,ford,fshow,cntre,cshow ; &vdef='+vdef+'
	url += 'mod='+mod+'&retitle='+retitle+'&refval='+refval+'&refname='+refname+'&cntre='+cntre+'';
	popOpen(lang('jcore.pop_infopick'),url,640,320);
}
function pickOne(e){
	var itm = pickRinfo(e); 
	parent.jsElm.jeID(pick_refval).value = itm[0];
	parent.jsElm.jeID(pick_refname).value = itm[1];
	popClose();
	return;
}
function pickMul(e,isdel){ 
	if(isdel){
		$(e).parent().remove();	
		return;
	}
	var itm = pickRinfo(e); //var chk = e.checked;
	pfield = pick_refval+'[]'; //pout = pick_refname;
	if(!e.checked){
		$("[name='"+pfield+"']",window.parent.document).each(function(i, ei) { 
			if($(ei).val()==itm[0]){ 
				var p = $(ei).parent().remove(); //pvals += $(e).val()+',';
				$('#sel_cnt').html(parseInt($('#sel_cnt').html())-1);
				return;
			}
		}); 
	}else{
		var has = $("[value='"+itm[0]+"']",window.parent.document); //jsLog(has);
		if(has && $(has[0]).prop('name')==pfield) return;
		if(e.checked && parseInt($('#sel_cnt').html())>=pick_max){ 
			alert(lang('jcore.pop_maxn',pick_max));
			return false; 
		}
		var html = "<span><input name='"+pfield+"' type='checkbox' class='rdcb' onClick='pickMul(this,1)' value='"+itm[0]+"' checked />"+itm[1]+"</span>";
		$("[id='"+pick_refname+"']",window.parent.document).append(html);
		$('#sel_cnt').html(parseInt($('#sel_cnt').html())+1);  
	}
	return;
}
function pickAll(e){
	var rows = $("#fmlist tr").length-1;
	var inow = parseInt($('#sel_cnt').html());
	if(inow+rows>pick_max){
		alert(lang('jcore.pop_maxm',pick_max));
		return false; 
	}else{ //jsLog(name); //
		fmSelAll(e);
		$('#fmlist tr input').each(function(i, ei) {
			var name = $(ei).prop('name').replace('fs[','').replace(']',''); if(!name || name=='fs_act') return true;
			pickMul(ei);
		});
	}
}
function pickInit(n){
	var cnt = 0, pvals = ',', pfield = n>1 ? pick_refval+'[]' : pick_refval;
	$("[name='"+pfield+"']",window.parent.document).each(function(i, e) { 
		pvals += $(e).val()+',';
		cnt++;
	}); //jsLog(pvals+':'+n);
	if(n) $('#sel_cnt').html(cnt); 
	$('#fmlist tr input').each(function(i, e) {
        var name = $(e).prop('name').replace('fs[','').replace(']',''); if(!name) return true;
		if(pvals.indexOf(name)>0) $(e).attr("checked", true);
    });
}
function pickRinfo(e){
	var key = $(e).prop('name').replace('fs[','').replace(']',''); 
	var title = jsElm.jeID(pick_retitle+'_'+key).innerText; //jsLog(key+'::'+title+':'+pick_retitle);
	return [key,title];
}

// Init 初始化
function popInit(fid,mod,w,n,def,cstr,cb){
	var fid2 = jsKey(fid);
	if(!cstr) cstr = '{}';
	eval("var mcfg=_"+mod+"_cfg;"); //"+fid2+"_obj=
	var cfg = dataCfgs('pop',cstr);
	var pid = cfg.pid == '' ? '0' : cfg.pid; cfg.pid = pid;
	var sobj, obj = {};  
	sobj = dataSuns(mod,pid);
	obj.i = sobj.i;
	obj.c = cfg; //obj.m = mcfg;
	obj.n = n; 
	obj.pid = pid;
	obj.mpage = 1200; //不同级别，一页最多显示个数:72,
	obj.mchar = 60; //同一级别，超过多少个按首字母显示:360
	obj.title = mcfg.title; 
	obj.dmin = sobj.dmin == 0 ? 1 : sobj.dmin;
	obj.dmax = sobj.dmax == 0 ? mcfg.deep : sobj.dmax; 
	if(pid!='0'){
		eval("var data = _"+mod+"_data;");
		obj.title = dataName(data,pid); 
	}
	eval(""+fid2+"_obj=obj;"); 
	var url = _cbase.run.roots+'/plus/api/types.php?fid='+fid+'&cb='+(cb?cb:'')+'';
	var act = " onClick=\"popOpen('"+obj.title+"','"+url+"')\"";
	var sty = 'class="wpop_icon txt" style="width:'+w+'px; background-position:'+(w-20)+'px -22px;"';
	var str = '<input id="'+fid+'" name="'+fid+'" type="hidden" value="'+def+'" />';
	var vstr = jsElm.jeID(fid2+'_pop').innerHTML; if(vstr.length>4) vstr = ' reg="'+vstr.replace('key:','str:')+'"';
	str += '<input id='+fid2+'_name name='+fid2+'_name type="text" value=""; '+sty+act+vstr+' />'; //reg="str:2-24" 
	jsElm.jeID(fid2+'_pop').innerHTML = str; 
	if(def.length>0){ //处理选中项目(名称)
		var str='', t='', g='', k=0; va=def.split(',');
		for(var i=0;i<va.length;i++){ 
			t = dataNams(obj.i,va[i]);
			if(t.length>0){
				str += g+dataNams(obj.i,va[i]);
				g = ', '; k++;
			}
		}
		if(n>1&&k>1){ str = str+lang('jcore.pop_all',k);}
		jsElm.jeID(fid2+'_name').value = str;
	}
}
function popOpen(title,url,w,h){
	var w = w ? w : 450;
	var h = h ? h : 360; 
	if(_cbase.sys_pop==4){ 
		var ops = {type:2, fix:false, maxmin:true, title:[title,true], area:[w+'px',h+'px'], content:[url], close:function(index){layer.close(index);}};
		layer.open(ops); // type:2, shade:[0], border:[5,0.7,'#0A246A',true], moveOut:true, offset:['50%','50%'],
	}else if(_cbase.sys_pop==3){ 
		tipsWindown(title,'iframe:'+url+'',w,h,'true','','true','content-boxCss');
	}else if(_cbase.sys_pop==2){ 
		$.webox({title:title, iframe:url, width:w, height:h, bgvisibel:false }); 
	}else{ //=3
		tipsWindown(title,'iframe:'+url+'',w,h,'true','','true','content-boxCss');
		//drag:      是否可以拖动(ture为是,false为否)
		//time:      自动关闭等待的时间，为空是则不自动关闭
		//showbg:      [可选参数]设置是否显示遮罩层(0为不显示,1为显示)
		//cssName:      [可选参数]附加class名称
	}
}
function popClose(){
	if(_cbase.sys_pop==4){ 
		var index = parent.layer.getFrameIndex(window.name);
		parent.layer.close(index);
	}else if(_cbase.sys_pop==3){ 
		$("#wtips-close", window.parent.document).trigger("click");
	}else if(_cbase.sys_pop==2){ 
		parent.$("#webox_close").trigger("click");
	}else{ //=3
		$("#wtips-close", window.parent.document).trigger("click");
		//$('#wtips-close',window.parent.parent.document).trigger("click");
		//window.parent.document.getElementById("#wtips-close")
		//parent.$("#wtips-close").trigger("click");
	}		
}

// *** wpop_data.js ======================================================================================
// 是否有子项目，data-item格式
// [key,pid,title,deep,frame,char]
// ['yxx7','c0735','永兴县',3,0,'Y']
function dataNext(data,k){
	var kitm,knxt;
	if(k==data.length-1) return false;
	kitm = data[k];
	knxt = data[k+1];
	return knxt[1]==kitm[0] ? true : false;
	/*
	var d = -1;
	for(var i=k;i<data.length;i++){
		var itm = data[i];
		if(i==k){
			d = itm[3]; 
			continue;
		}else{ // && lays.indexOf(itm[3])>=0
			if(itm[3]>d) return true;
			break;
		}
	}
	return false;*/
}
// 是否有兄弟项
function dataBrother(data,k){
	if(k==data.length-1) return false;
	kitm = data[k];
	for(var i=k+1;i<data.length;i++){
		var itm = data[i];
		if(itm[3]==kitm[3] && itm[1]==kitm[1]) return true; //级别和pid相同
		if(itm[3]<kitm[3]) return false; //比它级别小了肯定没有,退出提高效率！
		//if(itm[3]>kitm[3]) continue;
	}
	return false;
}
// 所有pid下的suns,返回array
function dataSuns(datu,pid,lays){
	if(isObj(datu,'s')) eval("var data = _"+datu+"_data;");
	else if(isObj(datu,'a')) var data = datu;
	else if(isObj(datu)){ return datu; }
	if(!pid) pid = '0'; if(!lays) lays = '123456789';
	if((pid=='0')&&(lays.length==9)){ 
		return {i:data,dmin:0,dmax:0}; //dmax:obj.dmax
	}
	var save = pid=='0' ? true : false;
	var arr = new Array(), deep = 0, dmin = 99, dmax = 0;
	for(var i=0;i<data.length;i++){
		var itm = data[i];
		if(pid.length!='0'&&pid==itm[0]){
			save = true;
			deep = itm[3]; 
			continue;
		}
		if(pid.length!='0'&&save&&(itm[3]<=deep)){ 
			break;
		}
		if(save&&lays.indexOf(itm[3])>=0){ 
			arr.push(itm);	
			dmin = Math.min(dmin,itm[3]);
			dmax = Math.max(dmax,itm[3]);
		}
	} 
	return {i:arr,dmin:dmin,dmax:dmax};
}
// Letter按首字母，分组
function dataLetter(data){
	var xn = 0, ch = '', a = new Array();
	for(var i=0;i<=26;i++){
		a[i] = new Array();
	}
	for(var i=0;i<data.length;i++){
		var itm = data[i];
		ch = data[i][5]; 
		if(ch=='') a[0].push(itm);
		else{ //string.fromCharCode(asc);
			xn = ch.charCodeAt()-64; 
			a[xn].push(itm);	
		}
	}
	return a;
}
// kid对应的lays
function dataLays(data,kid,cpid){
	if(isObj(data,'s')) eval("data = _"+data+"_data;");
	ida = kid.split(',');
	for(var i=0;i<ida.length;i++){
		if(ida.length>0) kid = ida[i];
	}
	var str = '', pid = kid, t = ''; //, flag = false
	for(var i=data.length-1;i>=0;i--){
		var itm = data[i];
		if(pid==itm[0]){
			pid = itm[1]; 
			str = itm[0]+';'+str;
			if(pid==cpid||pid=='0') break;
		}
	}
	return str;
}
// kid对应的Nams,湖南?郴州
function dataNams(data,kid){
	val = dataLays(data,kid);
	var str='', gap=''; 
	val = val.replace(new RegExp(';',"gm"),',');
	val = '(,'+val+','; // bj;bjxiaqu
	for(var i=0;i<data.length;i++){
		var itm = data[i]; 
		if(val.indexOf(','+itm[0]+',')>0){
			str += gap+itm[2];
			gap = '?'; // &laquo; &raquo; ? ?  
		}
	}
	return str;
}
// kid对应的Name
function dataName(data,kid){
	for(var i=0;i<data.length-1;i++){
		if(kid==data[i][0]){
			return data[i][2];
		}
	}
	return '';
}
// configs 配置
function dataCfgs(type,cfgu){
	if(isObj(cfgu)) var cfgr = cfgu;
	else eval("var cfgr = "+cfgu+";");
	if(type=='pop') var cfg = {pid:'',lays:'123456789',w:420,y:1};
	else if(type=='x') var cfg = {}; 
	else var cfg = {pid:'',lays:'123456789'}; 
	return jmJson(cfg,cfgr,1); 
}
// Test数组
function dataTest(data){
	var s = '';
	for(var i=0;i<data.length;i++){
		var itm = data[i]; 
		if(isObj(itm,'a')){
			s += '<br>';
			for(var j=0;j<itm.length;j++)
			s += ':'+itm[j];
		}else{
			s += ','+itm;	
		}
	}
	return s;
}





/*******************************************************************************
 File : \root\skin\jslib\search.js 
*******************************************************************************/

// Search - Start
function schEnc(s){
	return s.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/([\\\.\*\[\]\(\)\$\^])/g,"\\$1");
}
function schDec(s){
	return s.replace(/\\([\\\.\*\[\]\(\)\$\^])/g,"$1").replace(/>/g,">").replace(/</g,"<").replace(/&/g,"&");
}	
function schDone(s){
	var s = s ? s : jsElm.jeID('schVal').value;
	if (s.length==0){
		alert(lang('jcore.so_keyword'));
		return false;
	}
	s=schEnc(s); 
	var obj=document.getElementsByTagName("body")[0];
	var t=obj.innerHTML.replace(/<span\s+class=.?highlight.?>([^<>]*)<\/span>/gi,"$1");
	obj.innerHTML=t;
	var cnt=schLoop(s,obj);
	t=obj.innerHTML
	var r=/{searchHL}(({(?!\/searchHL})|[^{])*){\/searchHL}/g
	t=t.replace(r,"<span class='highlight'>$1</span>");
	obj.innerHTML=t;
	alert(lang('jcore.so_result',cnt));
}
function schLoop(s,obj){
	var cnt=0;
	if (obj.nodeType==3){
		cnt=schAddTags(s,obj);
		return cnt;
	}
	for (var i=0,c;c=obj.childNodes[i];i++){
	if (!c.className||c.className!="highlight")
		cnt+=schLoop(s,c);
	}
	if(cnt>1) cnt--;
	return cnt;
}
function schAddTags(s,dest){
	var r=new RegExp(s,"g");
	var tm=null;
	var t=dest.nodeValue;
	var cnt=0;
	if (tm=t.match(r)){
		cnt=tm.length;
		t=t.replace(r,"{searchHL}"+schDec(s)+"{/searchHL}")
		dest.nodeValue=t;
	}
	return cnt;
}
// Search - End
function schCase(e,ex1,ex2,dir,key){
	ex1 = '('+ex1+')'; ex2 = '('+ex2+')';
	chk = (e.checked==true)?true:false;
	itm = document.getElementsByTagName('input');
	for(var i=0;i<itm.length;i++){
		id = itm[i].id.toString(); //if(i<3)alert(id);
		v = itm[i].value; //.schAddTags('.','')
		if(id.indexOf('dir')>=0){ 
			itm[i].checked = false;
			if(dir.indexOf(v)>=0) itm[i].checked = chk;
		}
		if(id.indexOf('ex1')>=0){ 
			itm[i].checked = false;
			if(ex1.indexOf(v)>0) itm[i].checked = chk;
		}
		if(id.indexOf('ex2')>=0){ 
			itm[i].checked = false;
			if(ex2.indexOf(v)>0) itm[i].checked = chk;
		}
		if(id.indexOf('key')>=0){ 
			okey = document.getElementById('key');
			if(okey.value.length==0) okey.value = key;
			else{
				okey.value = okey.value.replace('$','').replace('function ','').replace('class ','')
				if(okey.value.indexOf(key)<0) okey.value = key+okey.value;
			}
		}
	}	
}



/*******************************************************************************
 File : \root\skin\mob\b_jscss\comm.js 
*******************************************************************************/


function jsActNav(clsid){
	$('nav ul.'+clsid).toggle(300);
	$('nav i.'+clsid).toggleClass('ico-folder-collapsed');
	$('nav i.'+clsid).toggleClass('ico-folder-open');	
}

function jsactMenu(menuid){
	if(!menuid){
		var a = _cbase.run.mkv.replace('.','-').split('-');
		menuid = a[0];
	}
	var e = jsElm.jeID('idf_'+menuid); 
	if(e) e.className = 'act';
}


/*******************************************************************************
 File : \root\skin\umc\b_jscss\comm-cn.js 
*******************************************************************************/

Lang.adm = {

    'xx' : ''

};



/*******************************************************************************
 File : \root\skin\umc\b_jscss\comm-en.js 
*******************************************************************************/

Lang.adm = {

    'xx' : ''

};



/*******************************************************************************
 File : \root\skin\umc\b_jscss\comm.js 
*******************************************************************************/

// qas_(id/key), qat_(id/key)
function jsactMfaqs(){
	var e = jsElm.jeID('qas_'+qas_id); 
	if(e) e.className = 'act';
	var e = jsElm.jeID('qat_'+qat_id); 
	if(e) e.className = 'act';
	//else jsElm.jeID('qat_all').className = 'act';
}

function jsactMenu(menuid){
	var e = jsElm.jeID('idf_'+cm); 
	if(e) e.className = 'act';
	var sid = ck ? ck : cm[0]+'home'; //jsLog(cm[0]+'home:'+ck);
	var s = jsElm.jeID('ids_'+sid);
	if(s) s.className = 'act';
}

function jsactInread(pid){
	jsImp('/plus/coms/inread.php?pid='+pid+'&'+_cbase.safil.url);
}

function jsqaSearch(e){
	var key = $(e).val(); //jsLog(); 
	$('#keywd').prop('name',key);
}




/*******************************************************************************
 File : \root\skin\umc\b_jscss\cseal.js 
*******************************************************************************/

function sealMove(e){
	var tab1 = 'cseal_tl,cseal_tr,cseal_tc,cseal_bl,cseal_br,cseal_bc', 
	    tab2 = 'cseal_tr,cseal_tl,cseal_tl,cseal_br,cseal_bl,cseal_bl';
	var a1 = tab1.split(','), a2 = tab2.split(',');
	var ncls = $(e).prop('class')+''; //jsLog(ncls);
	for(i=0;i<a1.length;i++){
		if((','+ncls+',').indexOf(a1[i])>0){
			ncls = ncls.replace(a1[i],a2[i]);
			break;
		}
	} //jsLog(ncls);
	$(e).prop('className',ncls);
}


/*******************************************************************************
 File : \root\tools\adbug\binfo.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php'); 

if($qstr=='logout'){
	$_SESSION[$sess_id] = '';
}elseif($qstr=='dologin'){ 
	$user = @$_POST['user'];
	$pass = @$_POST['pass'];
	if($user==$out_user && $pass==$out_pass){
		$_SESSION[$sess_id] = 'pstools';
	}
}

function userInfo($type='local'){	
	$a = array('HTTP_USER_AGENT','HTTP_X_REAL_FORWARDED_FOR','HTTP_X_FORWARDED_FOR','HTTP_CLIENT_IP','REMOTE_ADDR','HTTP_VIA'); 
	$s = ''; 
	foreach($a as $k) if(isset($_SERVER[$k])) $s .= "<li><i>$k:</i>{$_SERVER[$k]}</li>\n";
	$na = explode('.',$_SERVER['REMOTE_ADDR']);
	$b = array(
		'sinaapp.com'=>'http://int.dpool.sina.com.cn/iplookup/iplookup.php?ip=',
		'pconline.com'=>'http://www.ip138.com/ips138.asp',
		'1616.net'=>'http://chaxun.1616.net/ip.htm',
	);
	$s .= "<li><i>My Out IP:</i>";
	foreach($b as $k=>$v){ $s .= "<a href='$v' target='_blank'>@$k</a>\n"; }
	$s .= "</li>\n";
	return $s;
}	

function pageFrame($key,$ext=''){
  $s = '<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>{text}</body></html>';
  return str_replace('{text}',"[$key] Support(".lang('tools.adcfg_yes').")! $ext ",$s);
}

if($qstr=='iframe') die(pageFrame('Iframe'));
if($qstr=='frame') die(pageFrame('Frameset'));

if(strstr($qstr,'phpinfo')){ 
	$no = str_replace('phpinfo','',$qstr);
	$no = empty($no) ? '1' : max(1,intval($no));
	phpinfo($no);
	die();
}
if($qstr=='fset'){
	echo <<<HTML
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title>frameset</title>
<frameset rows="36,*" cols="*" border="false" id="frames">
  <frame name="top" src="?frame">
  <frame name="main" src="?frame">
</frameset>
<noframes>
<body>
<p><?php lang('tools.binf_lowbrowser',0);?></p>
</body>
</noframes>	
HTML;
	die();
}
?>
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title><?php lang('tools.binf_userenv',0);?>-(COOKIE,SERVER,phpinfo(4,8),Login,Logout)</title>
<meta name='robots' content='noindex, nofollow'>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../../skin/jslib/jsbase.js"></script>
<link rel='stylesheet' type='text/css' href='../../skin/a_jscss/stpub.css'/>
<link rel='stylesheet' type='text/css' href='../../skin/adm/b_jscss/comm.css'/>
<link rel='stylesheet' type='text/css' href='./style.css'/>
<link rel='shortcut icon' href='../../skin/a_img/favicon.ico' />
</head>
<body>
<div>
    <table width="100%" border="1" class="tblist">
        <?php tadbugNave(); ?>
        <tr class="tc">
            <td colspan="4">
            <a href="?" target="_self">[Home]</a> | <a href="?testError" target="_self">Error</a> | 
            <a href="?cookie" target="_self">COOKIE</a> | <a href="?server" target="_self">SERVER</a> | 
            <a  href='?phpinfo1' target='_blank'>phpinfo</a>(<a href='?phpinfo4' target='_blank'>4</a>,<a href='?phpinfo8' target='_blank'>8</a>) | 
            <a href="?login" target="_self">Login</a> | <a href="?logout" target="_self">Logout</a></td>
        </tr>
    </table>
</div>  

<?php
if($qstr=='testError'){
	echo "<div>".lang('tools.binf_showerror')."<br> --- ".lang('tools.binf_sererror')."<br>\n";
	$er1 = 234/0;
	$er2 = $er3;
	die('<p>-End-</p></div>');
}
if($qstr=='server'){
	echo '<div>';
	foreach($_SERVER as $k=>$v){ 
		echo "<li>$k: $v</li>\n";
	}
	echo '</div>';
}
if($qstr=='cookie'){
	echo '<div>';
	$a = explode('; ',$_SERVER['HTTP_COOKIE']);
	foreach($a as $k=>$v){ 
		echo "<li>$k: $v</li>\n";
	}
	echo '</div>';
}
?>
<?php if(in_array($qstr,array('login','logout','dologin'))){ ?>
<div>
    <?php if(@!strstr($_SESSION[$sess_id],'pstools')){ ?>
    <p>Login ……</p>
    <form action="?dologin" method="post" target="_self">
        <ul class="tc">
            User
            <input type="text" name="user" id="user" value="">
            Pass
            <input type="password" name="pass" id="pass" value="">
            <input type="submit" name="act" id="act" value="Login">
        </ul>
    </form>
    <?php }else{ ?>
    <p>Login OK!</p>
    <?php } ?>
    <p class="notice"><?php lang('tools.binf_usenotes',0);?></p>
</div>
<?php } ?>
<?php if($qstr=='binfo'){ ?>
<div>
    <p>(PHP)User Info # <a href="#" onClick="show('plugs')">(js)Plugs</a></p>
    <ul>
        <?php echo userInfo(); ?> <?php echo '<li><i>Server Time:</i>'.date('r').'</li>'; ?>
        <li><i>(js)USER_AGENT:</i><span id="jsua">JS NOT Support(<?php lang('tools.binf_nosupport',0);?>JavaScript)!</span></li>
        <li id="jsnow"></li>
        <li id="jscook"></li>
        <li id="jsplat"></li>
    </ul>
    <p class="test" id="plugs" style="display:none"></p>
</div>

<div>
    <p>Iframe/Frameset (<?php lang('tools.binf_frames',0);?>) &gt;&gt; <a href='?fset' target='_blank'>Open</a></p>
    <iframe src="?fset" height="60" style="width:48%;"></iframe>
    <iframe src="?iframe" height="60" style="width:48%;"></iframe>
</div>
<div>
    <p title="svg,canvas,audio,localStorage,contenteditable">Html5 (<?php lang('tools.binf_html5base',0);?>)</p>
    <span id="lsSection"> &nbsp; [localStorage]<?php lang('tools.binf_nosuplocal',0);?></span>
    <section style="width:120px; float:right;"> <svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="100">
        <polygon points="50,10 20,90 100,30 10,30 80,90"
    style="fill:rgb(120,120,120);stroke:rgb(60,60,60);stroke-width:2;fill-rule:evenodd;" />
        </svg> </section>
    <section contenteditable="true" title="[contenteditable]"><?php lang('tools.binf_editp',0);?></section>
    <canvas id="h5Canvas" width="180" height="24"><?php lang('tools.binf_nosupport',0);?> HTML5[canvas]。</canvas>
    <section> Datalist:
        <input type="url" list="url_list" name="link" />
        <datalist id="url_list">
            <option label="W3School" value="http://www.W3School.com.cn" />
            <option label="Google" value="http://www.google.com" />
            <option label="Microsoft" value="http://www.microsoft.com" />
        </datalist>
        <br>
        Placeholder:
        <input type="text" id="fmdata[keywords]" name="fmdata[keywords]" placeholder="placeholder"  value="" />
    </section>
    <section style="clear:left">
        <ruby>中文 - h字 - 拼音
            <rt>zhongwen - ㄏㄢA - pinyin</rt>
        </ruby>
    </section>
    <details>
        <summary>summary & details</summary><?php lang('tools.binf_details',0);?></details>
</div>
<div class="css3">
    <p>CSS3 (<?php lang('tools.binf_css3r',0);?>)</p>
    <section> 看到[圆角/阴影]效果了吗？没有看到，表示不支持CSS3。</section>
    <section></section>
</div>
<div>
    <p>字体样式:span:bold # <a href="#" onClick="show('fonts')"><?php lang('tools.binf_detail',0);?></a></p>
    <p class="test" id="fonts" style="display:none"> 字体样式：默认-Default:<br>
        <strong>字体样式：Tag-strong；</strong><br>
        <b>字体样式：Tag-b；</b><br>
        <span style="font-weight:bold">字体样式：span:bold:</span><br>
        <span style="font-weight:bolder">字体样式：span:bolder:</span><br>
        <span style="font-weight:100">字体样式：span:100:</span><br>
        <span style="font-weight:300">字体样式：span:300:</span><br>
        <span style="font-weight:500">字体样式：span:500:</span><br>
        <span style="font-weight:700">字体样式：span:700:</span><br>
        <span style="font-weight:900">字体样式：span:900:</span></p>
</div>

<script>
function plugs(){ //获取插件所有的名称
   var info = "";
   var plugins = navigator.plugins;
   if (plugins.length>0) { 
	  for (i=0; i < navigator.plugins.length; i++ ) { 
	   info += ''+(i+1)+': '+navigator.plugins[i].name+";<br>";
	  }
   } 
   jsElm.jeID('plugs').innerHTML = info;
}
function show(id){
	var d = jsElm.jeID(id);
	var v = d.style.display;
	d.style.display = v=='none' ? '' : 'none';
}
jsElm.jeID('jsua').innerHTML = navigator.userAgent;
jsElm.jeID('jsnow').innerHTML = '<i>Client Time(js):</i>'+new Date().toLocaleString();
jsElm.jeID('jscook').innerHTML = '<i class="w1">navigator.cookieEnabled:</i>'+navigator.cookieEnabled;
jsElm.jeID('jsplat').innerHTML = '<i class="w1">navigator.platform:</i>'+navigator.platform;
var lsSupport = (('localStorage' in window) && (window['localStorage'] !== null));
if(lsSupport) jsElm.jeID('lsSection').innerHTML = '&nbsp;<?php lang('tools.binf_suplocal',0);?>[localStorage]。';
var h5cnv = jsElm.jeID("h5Canvas");
var h5cxt = h5cnv.getContext("2d");
h5cxt.moveTo(10,1);
h5cxt.lineTo(70,20);
h5cxt.lineTo(10,20);
h5cxt.stroke();
plugs();
</script>
<?php } ?>

</body>
</html>



/*******************************************************************************
 File : \root\tools\adbug\cbaidu.php 
*******************************************************************************/
<?php
require('_config.php');

$act = basReq::val('act');
$d = basReq::val('d','txjia.com');
$kw = basReq::val('kw'); 
$pn = basReq::val('pn','74','N'); 

$mpage = 0;
if(!empty($act)){
    $crw = new exmCrawl($d,$kw,$pn);
    $data = $crw->data;
    $mpage = end($data['pages']);
    if(empty($mpage)){
        $mpage = empty($data['links']) ? 0 : 1;
    }
    if($act=='json'){
        die(json_encode($crw->data));
    }
}

glbHtml::page("Baidu - Search Engine Scan",1);
glbHtml::page('imp'); //adm
?>
<style type="text/css">
div, form, h4{ margin:10px; }
div, hr{ display:block; text-align:left; clear: both;}
#divs p { width: 300px; display:inline-block; float: left; margin: 5px; }
iframe { width: 300px; height: 200px; }
</style>
<?php glbHtml::page('body'); ?>
<form action="?" method="get">
domain=<input type="text" name="d" id="d" value="<?php echo $d; ?>"> # 
pn=<input type="text" name="pn" id="pn" value="<?php echo $pn; ?>" size="2">
kw=<input type="text" name="kw" id="kw" value="<?php echo $kw; ?>" size="8">
<input type="submit" name="act" id="act" value="do" style="width:60px">
<br>
<a href="?d=txjia.com&kw=">txjia.com</a> : 
<a href="?d=txjia.com&kw=贴心猫">贴心猫</a> : 
<a href="?d=txjia.com&kw=IntimateCat">IntimateCat</a> : 
<a href="?d=txmao.txjia.com">txmao.txjia.com</a> - 
<a href="?d=yscode.txjia.com">yscode.txjia.com</a> # 
<a href="?d=dg.gd.cn">dg.gd.cn</a> - 
<a href="?d=elifebike.com">elifebike.com</a> -
</form>

<?php
if($act=='do'){
    $bar = "<h4>pn=$mpage; d=$d # <a href='?d=$d&pn=$pn&kw=$kw&act=debug'>@debug</a> - <a href='{$crw->data['url']}'>@baidu</a></h4>";
    echo "<hr>$bar<div id='idlinks'>\n"; 
    for($i=0;$i<$mpage+1;$i++) {
        $pnstr = $i ? "pn={$i}0" : "pn=0";
        $url = str_replace("pn={$pn}0",$pnstr,$crw->data['url']);
        echo "\n<pre id='pg$i'><b>no:$i: <a href='$url'>$url</a></b></pre>";
    }
    echo "</div>";
}elseif(!empty($data)){
    dump($data);
}
?>

<script>

var mpages = <?php echo $mpage; ?>; // 6~12
var wmax = 6; // 6~12

function funcOpen(){
    for(var i=0;i<wmax+1;i++){ window.open('','_w'+i); }
    $('#idlinks').find('a').each(function(no, ilink) {
        var xr = jsRnd(1000,2000);
        if(mpages>60 && xr>1000&&xr<1380) return true;
        if(mpages>45 && xr>1000&&xr<1320) return true;
        if(mpages>30 && xr>1000&&xr<1260) return true;
        if(mpages>15 && xr>1000&&xr<1200) return true;
        var ra = jsRnd(1700,4300); //jsLog(i)
        setTimeout("funcOset("+no+");",(no+1)*2500+ra);
    });
}
function funcOset(no){
    var ilink = $('#idlinks').find('a')[no];
    var url = $(ilink).prop('href');
    var text = $(ilink).html().replace('https://www.baidu.com','');
    text = (text.indexOf('?wd=')>0 ? text : '')+' --- opened!';
    $(ilink).html(text);
    window.open(url,'_w'+(no%wmax));
}

function runPages(){
    for(var i=0;i<mpages+1;i++){
        var xr = jsRnd(1000,2000); if(i==mpages) xr = 317; //最大值,不忽略
        if(mpages>60 && xr>1000&&xr<1380) continue;
        if(mpages>45 && xr>1000&&xr<1320) continue;
        if(mpages>30 && xr>1000&&xr<1260) continue;
        if(mpages>15 && xr>1000&&xr<1200) continue;
        var rw = jsRnd(1700,2300);
        if(i>0){
            rw = i*3700+rw; //3700
        }
        setTimeout("oneLinks("+i+");",rw);
    }
}

function oneLinks(no){
    url = '<?php echo "?d=$d&kw=$kw&pn=(0)&act=json"; ?>&'+jsRnd();
    url = url.replace('(0)',''+no);
    $.get(url, function(re){ //jsLog(re);
        eval("var _arr="+re+";"); 
        var links = _arr.links;
        var str = '';
        for(i=0;i<links.length;i++){ 
            str += '<br><a href='+links[i]+'>'+links[i]+'</a>';
        }
        $('#pg'+no).html($('#pg'+no).html()+str);
        if(no==mpages){
            funcOpen();
        }
    });
}

<?php if($act=='do'){ ?>
runPages();
<?php } ?>

</script>

<?php
echo "\n<div>".basDebug::runInfo()."</div>";
basDebug::runLoad();
?>

</body>
</html>


/*******************************************************************************
 File : \root\tools\adbug\check.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php'); 

$act = @$_GET['act']; $act || $act = 'check'; 
$inptype = @$_GET['inptype']; 
$inpval = @$_GET['inpval'];
$rem_url = empty($_GET['rem_url']) ? 'http://www.baidu.com/' : $_GET['rem_url'];
$rem_type = empty($_GET['rem_type']) ? '' : $_GET['rem_type'];

$cfg = array(
	'check'=>lang('tools.chk_envbaisc'),
	'memory'=>'Memory',
	'upload'=>'Upload',
	'bomcheck'=>'BOMCheck',
	'remote'=>'Remote',
);
$title = isset($cfg[$act]) ? $cfg[$act] : '？'.$act;

if($act=='image'){
	devRun::runGdlib();
	die(); // jpeg
}elseif($rem_type && $rem_url){
	$cfg = array(
		'curl_init'=>'1',
		'fsockopen'=>'2',
		'file_get_contents'=>'3',
	);
	comHttp::setWay($cfg[$rem_type]);
	$text = comHttp::doGet($rem_url);
	echo dfmtRemote($text,"$rem_type : $rem_url");
	die();	
}

glbHtml::page(lang('tools.chk_envcheck')."-$title",1);
glbHtml::page('imp');

$iniPath = get_cfg_var('cfg_file_path');
$iniInfo = $iniPath ? "PHP configuration is using THIS file: [$iniPath]" : "WARNING: No configuration file (php.ini) used by PHP!";

?>
<link rel='stylesheet' type='text/css' href='./style.css'/>
</head><body>

<div>
  <table width="100%" border="1" class="tblist">
    <?php tadbugNave(); ?>
    <tr class="tc">
      <td colspan="5">
        <a href="?">Basic</a> | <a 
    href='?act=define'>Define</a> | <a 
    href='?act=image' target="_blank">Image</a> | <a 
    href='?act=upload'>Upload</a> | <a 
    href='?act=remote'>Remote</a>
      </td>
    </tr>
  </table>
</div>

<?php 
if($act=='check'){ 
?>

<div>
<p class="tip"><?php lang('tools.chk_envcheck',0); ?> --- <?php lang('tools.chk_envbaisc',0); ?></p>

  <table width="100%" border="1" class="tblist">
    <tr>
      <th class="tc"><?php lang('tools.chk_envname',0); ?></th>
      <th class="tc"><?php lang('tools.chk_envres',0); ?></th>
      <th><?php lang('tools.chk_envstat',0); ?></th>
      <th><?php lang('tools.chk_envrem',0); ?></th>
    </tr>
	<?php 
    $a = array('upfile','reset'); 
    foreach($a as $k){ $key = "can_$k";
    ?>
    <tr>
      <td class="tc"><?php echo $key; ?></td>
      <td class="tc"><span style="color: #<?php echo $$key ? "ff0000" : "008000"; ?>; font-weight : bold;"><?php echo $$key ? lang('tools.chk_risk') : lang('tools.chk_safe'); ?></span></td>
      <td><?php echo $key; ?>=<?php echo $$key; ?> (@code/cfgs/boot/cfg_adbug.php)</td>
      <td><?php lang('tools.chk_set0',0); ?></td>
    </tr>
    <?php }?>
    
	<?php 
    $a = array('verPHP','verGdlib','runRemote'); 
    foreach($a as $k){ $re = devRun::$k();
    ?>
    <tr>
      <td class="tc"><?php echo $re['title']; ?></td>
      <td class="tc"><?php echo $re['res']; ?></td>
      <td><?php echo $re['info']; ?></td>
      <td><?php echo $re['tip'].(empty($re['demo']) ? '' : " &nbsp; -=&gt;<a href='{$re['demo']}'>".lang('tools.chk_demo')."</a>"); ?></td>
    </tr>
    <?php }?>

	<?php 
    $__a = array(array('Mail','mail'),array('FTP','ftp_connect')); //array('ob_gzhandler'),
    foreach($__a as $__a1){ $__f1 = isset($__a1[1]) ? $__a1[1] : $__a1[0];
    ?>
    <tr>
      <td class="tc"><?php echo $__a1[0]?></td>
      <td class="tc"><?php echo function_exists($__f1) ? FLAGYES : FLAGNO?></td>
      <td>-</td>
      <td>-</td>
    </tr>
    <?php }?>
    <form id="fmb" name="fmb2" method="get" action="?">
    <tr>
      <td class="tc"><?php lang('tools.chk_usptest',0); ?></td>
      <td class="tc">-</td>
      <td colspan="2">
    <select name="inptype" onChange="setInpval(this)" style="width:200px;">
      <option value="">---<?php lang('tools.chk_pick1',0); ?>---</option>
      <option value="memory"><?php lang('tools.chk_cmemory',0); ?></option>
      <option value="funcs"><?php lang('tools.chk_cfunc',0); ?></option>
    </select>
    <input name="inpval" type="text" id="inpval" value="<?php echo $inpval; ?>" style="width:100px;"/>
    <input type="submit" name="submit" id="submit" value="Submit" class="btn" />   
<script>
function setInpval(e){
	var type = e.value,res = '';
	if(type=='memory')  res = 32;
	if(type=='funcs')  res = 'phpinfo';
	document.getElementById('inpval').value = res;
}
</script>
      </td>
    </tr>
    <?php if($inptype && $inpval){ ?>
    <?php if($inptype=='memory'){ ?>
    <tr>
      <td class="tc">Memory Test</td>
      <td class="tc" colspan="3"><?php echo devRun::runMemory($inpval); ?></td>
    </tr>
    <?php } if($inptype=='funcs'){ ?>
    <tr>
      <td class="tc"><?php echo $inpval; ?></td>
      <td class="tc" colspan="3"><?php echo fchkFuncs($inpval); ?></td>
    </tr>
    <?php } } ?>
    </form>
    <tr>
      <td class="tip" colspan="4"><?php echo $iniInfo; ?></td>
    </tr>
    
  </table>

</div>

<div>
<p class="tip"><?php lang('tools.chk_envcheck',0); ?> --- <?php lang('tools.chk_sysdirs',0); ?></p>

  <table width="100%" border="1" class="tblist">
    <tr>
      <th class="tc"><?php lang('tools.chk_envname',0); ?></th>
      <th class="tc"><?php lang('tools.chk_envres',0); ?></th>
      <th width="30%">Dir</th>
      <th width="40%">Path</th>
    </tr>
	<?php 
	//if(empty($_isOut)){
	$cfg = devRun::runPath($k); $rea = '';
    foreach($cfg as $k=>$re){ $rea .= $re['res'];
    ?>
    <tr>
      <td class="tc">*_<?php echo $re['ukey']; ?></td>
      <td class="tc"><?php echo $re['res']; ?></td>
      <td><input class="r" value="<?php echo $re['dir']; ?>"></td>
      <td><input class="r" value="<?php echo $re['path']; ?>"></td>
    </tr> 
    <?php
    } if(strstr($rea,FLAGNO)){
    ?>
    <tr>
      <td class="tip" colspan="4"><?php lang('tools.chk_dirset',0); ?></td>
    </tr> 
    <?php } //} ?>
  </table>
</div>

<div>
<p class="tip"><?php lang('tools.chk_envcheck',0); ?> --- <?php lang('tools.chk_dblink',0); ?></p>

  <table width="100%" border="1" class="tblist">
    <tr>
      <th class="tc"><?php lang('tools.chk_envname',0); ?></th>
      <th class="tc"><?php lang('tools.chk_envres',0); ?></th>
      <th width="70%"><?php lang('tools.chk_dbstatus',0); ?></th>
    </tr>
    
	<?php 
    $a3 = devRun::runMydb3(); $nocnt = 0;
    foreach($a3 as $k=>$re){ $nocnt += $re['res']==FLAGNO ? 1 : 0;
    ?>
    <tr>
      <td class="tc">[<?php echo $k; ?>] <?php lang('tools.chk_dbextra',0); ?></td>
      <td class="tc"><?php echo $re['res']; ?></td>
      <td><?php echo $re['info']; ?></td>
    </tr>
    <?php } if($nocnt){ ?>
    <tr>
      <td class="tip" colspan="4"><?php lang('tools.chk_dbset',0); ?></td>
    </tr> 
    <?php } ?>
    
  </table>
</div>

<?php 
}if($act=='define'){
?>

<div style="height:500px; overflow-y:scroll;">
<p class="tip"><?php lang('tools.chk_envcheck',0); ?> --- define</p>
  <table width="100%" border="1" class="tblist">
	<?php 
    $df = get_defined_constants(true);
    foreach(array('user','Core','mhash','internal','pcre') as $gk){ 
		if(!isset($df[$gk])) continue;
		$gv = $df[$gk];
    ?>
    <tr>
      <th><?php echo $gk; ?></th>
      <th>Key</th>
      <th>Value</th>
    </tr>
	<?php 
    foreach($gv as $k=>$v){ 
	?>
    <tr>
      <td class="tr" colspan="2"><?php echo $k; ?></td>
      <td class="tl"><?php echo $v; ?></td>
    </tr>
    <?php } } ?>
  </table>
</div>

<?php
}if($act=='upload'){ 
?>
<div>
  <form id="fmup" name="fmup" method="post" action="?act=upload" enctype="multipart/form-data">
    <p class="tc tip"><?php lang('tools.cf_fupload',0); ?></p>
    <ul>
	<?php
    if(!empty($_POST['upLoad'])){	// LINKOK,FAILED
        $uppath = $_POST['uppath'];
        foreach($_FILES as $f){
            if(empty($can_upfile)) die("Please SET [ \$can_upfile = '1' ]"); 
			if($f['name']){ 
                $fp = $uppath.$f['name']; 
                $r = move_uploaded_file($f['tmp_name'],$fp); 
                chmod($fp, 0755);//设定上传的文件的属性 
                echo "<li><i class='w2'>res:</i>$fp ".lang('tools.cf_upok')."</li>"; 
        }	}
    }
    ?>
	<li><i class="w2"><?php lang('tools.cf_file',0); ?></i><input type="file" name="fileup1" id="fileup1"></li>
    <li>
    <i class="w2"><?php lang('tools.cf_path',0); ?></i><input name="uppath" type="text" id="uppath" value="./" size="18"/>
    <input type="submit" name="upLoad" id="upLoad" value="<?php lang('tools.cf_upbtn',0); ?>" />
    </li>
    </ul>
  </form>
</div>
<?php } ?>

<?php 
if($act=='remote'){ 
?>
<div>
  <form id="fmremote" name="fmremote" method="get" action="?" target="_blank">
    <p class="tc tip"><?php lang('tools.cf_remote',0); ?></p>
    <ul>
    <li>
      <i class="w2">Url: </i>
      <input name="rem_url" type="text" value="<?php echo $rem_url; ?>" style="width:360px;"> 
      <br>
      https://api.weixin.qq.com/cgi-bin/token<br>
      http://www.baidu.com/<br>
      https://www.baidu.com/    </li>
    <li><i class="w2"><?php lang('tools.cf_remext',0); ?></i>
        <select name="rem_type" style="width:360px;">
          <option value="curl_init">(curl:curl_init,curl_setopt)</option>
          <option value="file_get_contents">(file_get_contents)</option>
          <option value="fsockopen">(fsockopen)</option>
        </select>
    </li>
    <li><i class="w2"><?php lang('tools.cf_show',0); ?></i>
        <select name="rem_show" style="width:150px;">
          <option value="">---<?php lang('tools.cf_shmode',0); ?>---</option>
          <option value="script_style"><?php lang('tools.cf_tdef',0); ?></option>
          <option value="script_style_tags"><?php lang('tools.cf_text',0); ?></option>
          <option value="_null_"><?php lang('tools.cf_torg',0); ?></option>
        </select>
        <select name="rem_cset" style="width:150px;">
          <option value="">---(default:utf-8)---</option>
          <option value="gbk"><?php lang('tools.cf_gbk',0); ?></option>
          <option value="gb2312"><?php lang('tools.cf_gb2312',0); ?></option>
          <option value="big5"><?php lang('tools.cf_big5',0); ?></option>
        </select>
        <input type="submit" name="submit" id="submit" value="<?php lang('tools.cf_send',0); ?>" />
    </li>
    </ul>
    <input name="remote" type="hidden" value="1">
    <input name="act" type="hidden" value="remote">
  </form>
</div>
<?php } ?>

</body></html>



/*******************************************************************************
 File : \root\tools\adbug\cscan.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php'); 

$act = basReq::val('act','');
$part = $ntpl = basReq::val('part','');

glbHtml::page("Check/Scan",1);
glbHtml::page('imp');

if($act=='scanInit'){
  $bcfg = array('code'=>DIR_CODE, 'root'=>DIR_ROOT, 'tpls'=>DIR_CODE.'/tpls', 'a3rd'=>DIR_ROOT.'/a3rd'); @$burl = $bcfg[$part]; 
  $dcfg = array('code'=>'',       'root'=>'',       'tpls'=>'/code',          'a3rd'=>'/root');          @$durl = $dcfg[$part];
  if(!empty($burl)){
    $re = devBase::scanInit($burl,$_cbase['run']['rmain']."$durl/$part");
    echo "<base target='_blank'/>[$durl/$part]<pre>"; print_r($re); 
    echo "\n</pre>".basDebug::runInfo(); die();
  } 
}elseif($act=='scanMkvs'){
  $re = devBase::scanMkvs($part);
  echo "<base target='_blank'/>[$part]<pre>"; print_r($re); 
  echo "\n</pre>".basDebug::runInfo(); die();
}elseif($act=='scanCnchr'){ 
    $skip = array('ex_sfdata','safData','exvOcar','wmpError','sy_fdemo','sy_fsystem','sy_nava','derun'); 
    $re = devBase::scanCnchr(DIR_PROJ."/$part",array('yscode','utest'),$skip);
    echo "\n</pre>".basDebug::runInfo(); die();  
}elseif($act=='scanDblang'){ 
    $re = devBase::scanDblang();
    echo "\n</pre>".basDebug::runInfo(); die();  
}elseif($act=='curlDown'){  
    $ref = array('_ref'=>'http://down.chinaz.com/soft/37712.htm');
    $url = "http://down.chinaz.com/download.asp?id=37712&dp=1&fid=$part&f=yes";
    $res = comHttp::curlCrawl($url,$ref);
    echo basStr::filForm($res)." [$part] "; die();
}elseif($act=='curlDasp'){  
    $ref = array('_ref'=>'http://down.chinaz.com/soft/38283.htm');
    $url = "http://down.chinaz.com/download.asp?id=38283&dp=1&fid=$part&f=yes";
    $res = comHttp::curlCrawl($url,$ref);
    echo basStr::filForm($res)." [$part] "; die();
}

?>

<link rel='stylesheet' type='text/css' href='./style.css'/>
</head><body>

<div>
  <table width="100%" border="1" class="tblist">
    <?php tadbugNave(); ?>
    <tr class="tc">
      <td colspan="5">
        <a 
    href='?act=bomcheck'>BOMCheck</a> # <a 
    href='cstudy.php' target="_blank">study</a> | <a 
    href='cyahei.php' target="_blank">yahei</a> | <a 
    href='search.php' target="_blank">Search</a>
      </td>
    </tr>
  </table>
</div>

<?php if($act=='bomcheck'){ ?>

<?php 
$bomroot = empty($_GET['bomroot']) ? '../../../' : $_GET['bomroot'];
defined('DIR_PROJ') || define('DIR_PROJ',dirname(__FILE__));
if(empty($can_upfile)){
	if(!strstr($bomreal,DIR_PROJ)) $bomroot = '../../../';
}
$bompath = empty($_GET['bompath']) ? '' : $_GET['bompath'];
$bomfile = @$_GET['bomfile']; $bommsg = '';
$bomreal = str_replace("\\","/",realpath($bomroot)); //echo $bomreal;
?>

<div>
  <?php
  if(!empty($bomfile)){
	  if(empty($can_upfile)) die("Please SET [ \$can_upfile = '1' ]"); 
	  if(devRun::bomRemove($bomfile)) $bommsg = "<li class='rmok'>BOM Remove OK! ------ $bomfile</li>\n";
  }
  ?>
  <form id="fmbom" name="fmbom" method="get" action="?">
    <p class="tc tip">BOM Check</p>
    <ul>
	<?php echo $bommsg; ?>
    <li>
      <i class="w2"><?php lang('tools.scan_root',0); ?></i><input name="bomroot" type="text" value="<?php echo $bomroot; ?>" size="36"> 
      <input type="submit" value="<?php lang('tools.scan_set',0); ?>">
      <br>
      <span title="<?php lang('tools.scan_tip1',0); ?>"><?php lang('tools.scan_tip2',0); ?></span> &nbsp; 
     </li>
    <li>
    <i class="w2"><?php lang('tools.scan_dirs',0); ?></i>
    <?php 
	$handle = opendir($bomroot);
	while($file=readdir($handle)){
		if(in_array($file,array('.','..','.svn',))) continue;
		if(is_dir("$bomroot/$file")){
			echo " : <a href='?act=bomcheck&bomroot=$bomroot&bompath=$file'>$file</a>\n";
		}
	}
	closedir($handle);
	?>
    </li>
    </ul>
    <input name="act" type="hidden" value="bomcheck">
  </form>
  <?php
  if($bompath){
      devRun::bomScan($bomreal,$bompath);
  }
  ?>
</div>

<?php }else{ ?>

<div>
<p class="tip">Check/Scan</p>

  <table width="100%" border="1" class="tblist">
    <tr>
      <td class="tc">lang,down</td>
      <td class="tc" colspan="3">
       # <a href='?act=openDowns&part=120'>openDowns</a>
       # <a href='?act=scanDblang&part='>scanDblang</a>
       # <a href='cbaidu.php'>scanBaidu</a>
       #
      </td>
    </tr> 
    <tr>
      <td class="tc">Open[hlist]Entry</td>
      <td class="tc" colspan="3">
       # <a href='?act=openLinks&part=umc'>open_umc</a>
       | <a href='?act=openLinks&part=mob'>open_mob</a>
       | <a href='?act=openLinks&part=chn'>open_chn</a>
       | <a href='?act=openLinks&part=dev'>open_dev</a>
       | <a href='?act=openLinks&part=doc'>open_doc</a>
       #
      </td>
    </tr> 
    <tr>
      <td class="tc">Check[file]Entry</td>
      <td class="tc" colspan="3">
       # <a href='?act=scanInit&part=code' target="_blank">init_code</a> 
       | <a href='?act=scanInit&part=root' target="_blank">init_root</a>
       | <a href='?act=scanInit&part=tpls' target="_blank">init_tpls</a>
       | <a href='?act=scanInit&part=a3rd' target="_blank">init_a3rd</a>
       #
      </td>
    </tr> 
    <tr>
      <td class="tc">Check[mkv]Entry</td>
      <td class="tc" colspan="3">
       # <a href='?act=scanMkvs&part=adm' target="_blank">mkv_adm</a> 
       | <a href='?act=scanMkvs&part=umc' target="_blank">mkv_umc</a>
       | <a href='?act=scanMkvs&part=mob' target="_blank">mkv_mob</a>
       | <a href='?act=scanMkvs&part=chn' target="_blank">mkv_chn</a>
       | <a href='?act=scanMkvs&part=dev' target="_blank">mkv_dev</a>
       #
      </td>
    </tr> 
    <tr>
      <td class="tc">Check[Cnchr]Char</td>
      <td class="tc" colspan="3">
         <a href='?act=scanCnchr&part=code/adpt' target="_blank">adpt</a> 
       | <a href='?act=scanCnchr&part=code/cfgs' target="_blank">cfgs</a>
       | <a href='?act=scanCnchr&part=code/core' target="_blank">core</a>
       | <a href='?act=scanCnchr&part=code/flow' target="_blank">flow</a>
       # <a href='?act=scanCnchr&part=code/tpls/adm' target="_blank">adm</a>
       | <a href='?act=scanCnchr&part=code/tpls/umc' target="_blank">umc</a>
       | <a href='?act=scanCnchr&part=code/tpls/doc' target="_blank">doc</a>
       # <a href='?act=scanCnchr&part=root/a3rd' target="_blank">a3rd</a> 
       | <a href='?act=scanCnchr&part=root/plus' target="_blank">plus</a>
       | <a href='?act=scanCnchr&part=root/skin' target="_blank">skin</a>
       | <a href='?act=scanCnchr&part=root/tools' target="_blank">tools</a>
      </td>
    </tr> 
  </table>

</div>

<?php
if($act=='openLinks'){ 
	$_cbase['tpl']['tpl_dir'] = empty($ntpl) ? $_cbase['tpl']['def_static'] : $ntpl;
	$ncfg = vopTpls::entry($part,'ehlist','ehlist');
?>
<div>
  <p>[<?php echo "$ntpl"; ?>]openLinks</p>
  <table width="100%" border="1" class="tblist" id="idlinks">
    <?php foreach($ncfg as $mod=>$vals){ ?>
    <tr id="res">
      <td>
	  --- <b><?php echo $mod; ?></b><br>
      <?php foreach($vals as $key=>$val){ 
	  	if(is_array($val)) continue; 
		if(!strpos($val,'/')) continue; 
		$mkv = $key=='m' ? $mod : "$mod-$key";
		$url = vopUrl::fout($mod=='home' ? '' : "$mkv");
	  ?>
      <a href="<?php echo "$url"; ?>" target="_blank"><?php echo "$val"; ?></a><br>
      <?php } ?>
      </td>
    </tr> 
    <?php } ?>
    <tr>
      <td class="tip">……</td>
    </tr> 
  </table>
</div>
<script>
var wmax = 6; // 6~12
function funcOpen(){
  for(var i=0;i<wmax+1;i++){ window.open('','_w'+i); }
  $('#idlinks').find('a').each(function(no, ilink) {
        var r = jsRnd(100,400);
        setTimeout("funcOset("+no+");",(no+1)*1500+r);
    //jsLog(i);
    });
}
function funcOset(no){
  var ilink = $('#idlinks').find('a')[no];
  var url = $(ilink).prop('href');
  var html = $(ilink).html()+' --- ';
  if(url.indexOf('close#')<=0){
    window.open(url,'_w'+(no%wmax));
    //var wobj = wobj.blur();
    html += url;
  }else{
    html += 'Error!'
  }
  $(ilink).html(html.replace(_cbase.run.rsite,''));
}
funcOpen();
</script>
<?php } ?>

<?php
if($act=='openDowns'){ 
?>
<div>
  <p>[<?php echo "$ntpl"; ?>]openDowns</p>
  <table width="100%" border="1" class="tblist" id="idlinks">
    <tr id="res">
      <td>
            --- <b>demo</b><br>
            <a href="http://down.chinaz.com/soft/37712.htm" target="_blank">chinaz/37712</a><br>
            <a href="http://down.chinaz.com/soft/38283.htm" target="_blank">chinaz/38283</a><br>
            --- <b>open</b><br>
            <?php 
            $dcfg=array(28,7,22,19,10,20,16); 
            for ($ia=0;$ia<$part;$ia++) {
            foreach ($dcfg as $dkey) {
              echo "<a href='?act=curlDown&part=$dkey' target='_blank'>part=curlDown:$dkey</a><br>";
              echo "<a href='?act=curlDasp&part=$dkey' target='_blank'>part=curlDasp:$dkey</a><br>";
            }}?>
      </td>
    </tr> 
    <tr>
      <td class="tip">……</td>
    </tr> 
  </table>
</div>
<?php } ?>

<?php
if(in_array($act,array('openDowns','openDasp'))){ 
?>
<script>
var wmax = 6; // 6~12
function funcOpen(){
  for(var i=0;i<wmax+1;i++){ window.open('','_w'+i); }
  $('#idlinks').find('a').each(function(no, ilink) {
        var r = jsRnd(1700,4300); //jsLog(i)
        setTimeout("funcOset("+no+");",(no+1)*2500+r);
    });
}
function funcOset(no){
  var xr = jsRnd(1000,2000);
  if(xr>1000&&xr<1200) return true;
  var ilink = $('#idlinks').find('a')[no];
  var url = $(ilink).prop('href');
  var html = $(ilink).html()+' --- opoend ';
  window.open(url,'_w'+(no%wmax));
  $(ilink).html(html);
}
funcOpen();
</script>
<?php } ?>

<?php } ?>

<?php
glbHtml::page('end');
?>


/*******************************************************************************
 File : \root\tools\adbug\cstudy.php 
*******************************************************************************/
<?php 
$_cbase['run']['outer'] = 1; 
require(dirname(__FILE__).'/_config.php'); 

require(DIR_STATIC.'/ilibs/check_study.img_php');



/*******************************************************************************
 File : \root\tools\adbug\cyahei.php 
*******************************************************************************/
<?php 
$_cbase['run']['outer'] = 1; 
require(dirname(__FILE__).'/_config.php'); 

require(DIR_STATIC.'/ilibs/check_yahei.img_php');



/*******************************************************************************
 File : \root\tools\adbug\dbadm.php 
*******************************************************************************/
<?php 
$_cbase['run']['outer'] = 1; 
require(dirname(__FILE__).'/_config.php'); 

require(DIR_STATIC.'/ilibs/adminer.imp_php');



/*******************************************************************************
 File : \root\tools\adbug\reset.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php'); 

$act = basReq::val('act','');
$part = basReq::val('part','');
$inptype = @$_GET['inptype']; 
$inpval = @$_GET['inpval'];

$exmod = basReq::val('exmod','');
$exmenu = basReq::val('exmenu','');

$orguser = 'adm_'.basKeyid::kidRand(0,3);
$orgpass = 'pass_'.basKeyid::kidRand(0,3);

glbHtml::page(lang('tools.rst_title'),1);
glbHtml::page('imp');
?>
<link rel='stylesheet' type='text/css' href='./style.css'/>
</head><body>

<div>
  <table width="100%" border="1" class="tblist">
    <?php tadbugNave(); ?>
  </table>
</div>

<div>
<p class="tip"><?php lang('tools.rst_title',0); ?> / <?php lang('tools.rst_dbops',0); ?></p>

  <table width="100%" border="1" class="tblist">
    <tr>
      <td class="tc" colspan="4">(@code/cfgs/boot/cfg_adbug.php)
      &nbsp; [can_reset=<?php echo $can_reset; ?>] &nbsp; 
      <span style="color: #<?php echo $can_reset ? "ff0000" : "008000"; ?>; font-weight : bold;"><?php echo $can_reset ? lang('tools.chk_risk') : lang('tools.chk_safe'); ?></span>
      <?php lang('tools.chk_set0',0); ?>
      </td>
    </tr>
    <tr class="tc">
      <td width="25%"><?php lang('tools.rst_clear',0); ?></td>
      <td width="25%"><a href="?act=clrTmps"><?php lang('tools.rst_clrtmpfiles',0); ?></a></td>
      <td width="25%"><a href="?act=clrLogs"><?php lang('tools.rst_clrdblogs',0); ?></a></td>
      <td width="25%"><a href="?act=clrCTpl"><?php lang('tools.rst_clrtplcache',0); ?></a></td>
    </tr>     
    <tr class="tc">
      <td><?php lang('tools.rst_dbcheck',0); ?></td>
      <td><a href="?act=cdbPKey"><?php lang('tools.rst_dbnopk',0); ?></a></td>
      <td><a href="?act=cdbV255"><?php lang('tools.rst_dbvar255',0); ?></a></td>
      <td><a href="?act=cdbMKey"><?php lang('tools.rst_dbcindex',0); ?></a></td>
    </tr>
    <tr class="tc">
      <td><?php lang('tools.rst_export',0); ?></td>
      <td><a href="?act=expStru"><?php lang('tools.rst_expframe',0); ?></a></td>
      <td><a href="?act=expData"><?php lang('tools.rst_expall',0); ?></a></td>
      <td><a href="?act=expBack"><?php lang('tools.rst_exback',0); ?></a></td>
      </td>
    </tr> 

    <tr class="tc">
      <td><?php lang('tools.rst_reset',0); ?></td>
      <td><a href="?act=rstRndata"><?php lang('tools.rst_rstdata',0); ?></a> , 
      <a href="?act=rstTabcode"><?php lang('tools.rst_rstcomp',0); ?></a> , 
      <a href="?act=rstTabmini"><?php lang('tools.rst_rstmini',0); ?></a></td>
      <td><a href="?act=rstPub&part=main"><?php lang('tools.rst_rstpub',0); ?></a> : 
      (<a href="?act=rstPub&part=vary">vary</a> , 
      <a href="?act=rstPub&part=vimp">vimp</a>)</td>
      <td><a href="?act=rstCache"><?php lang('tools.rst_rstcache',0); ?></a></td>
    </tr>

    <form name="reidpw" action="?" method="get">
    <tr class="tc">
      <td><?php lang('tools.rst_rstidpw',0); ?></td>
      <td><input name="uname" value="<?php echo $orguser; ?>" type="text" onBlur="chkIdpass(this,0,3)" maxlength="12" class='w150'></td>
      <td><input name="upass" value="<?php echo $orgpass; ?>" type="text" onBlur="chkIdpass(this,1,6)" maxlength="18" class='w150'></td>
      <td><input name="" value="<?php lang('tools.rst_reset',0); ?>" class="btn" type="submit"><input name="act" type="hidden" value="rstIDPW"></td>
    </tr> 
    </form>

    <?php
      $arr = admPFunc::modList(array('docs','users','coms','type','advs'),0); 
      $muadm = glbConfig::read('muadm'); $muadm = $muadm['i'];
      $arm = array(); $pid = '';
      foreach($muadm as $k=>$v){
          if($v['deep']>2) continue;
          if(empty($pid)){
            if(empty($muadm[$v['pid']])) continue;
            $arm["^group^[$k]"] = "[$k]-{$muadm[$v['pid']]['title']}";
          }else{
            $arm[$k] = "  &nbsp; [$k]$v[title]";
          }
          $pid = $v['pid'];
      }
    ?>
    <form name="reins" action="?" method="get">
    <tr class="tc">
      <td>Export</td>
      <td><select id='exmod' name='exmod' class='w150'><?php echo basElm::setOption($arr,$exmod); ?></select></td>
      <td><select id='exmenu' name='exmenu' class='w150'><?php echo basElm::setOption($arm,$exmenu); ?></select></td>
      <td><input name="" value="Export" class="btn" type="submit"><input name="act" type="hidden" value="expMod"></td>
    </tr> 
    </form>

  </table>

</div>

<?php
$re = '-';

$names = array(

	'clrTmps'=>lang('tools.rst_clrtmpfiles'),
	'clrLogs'=>lang('tools.rst_clrdblogs'),
	'clrCTpl'=>lang('tools.rst_clrtplcache'),
	
	'rstCache'=>lang('tools.rst_rstcache'),
	'rstIDPW'=>lang('tools.rst_setidpw'),
	'rstPub'=>lang('tools.rst_rstpub'), 
	
	'cdbPKey'=>lang('tools.rst_dbnopk'),
	'cdbV255'=>lang('tools.rst_dbvar255'),
	'cdbMKey'=>lang('tools.rst_dbcindex'),
	
	'expStru'=>lang('tools.rst_expframe'),
	'expData'=>lang('tools.rst_export'),

  'expMod'=>'Export',

);

if(in_array($act,array('expData','expBack'))){
	$method = $act=='expBack' ?  "dataExpGroup" : 'dataExp';
	$dpre = $act=='expBack' ?  "gbak" : 'data';
	devData::$method("/dbexp/$dpre~",$part); 
}elseif(in_array($act,array('expStru'))){
	devData::struExp('/dbexp/');
}elseif($act=='rstIDPW'){
	if(empty($can_reset)){
		$exmsg = "<br>".lang('tools.rst_idpw_set',0)."<span class='cF03'>[ \$can_reset = '1' ]</span>";
		$_res = 'Error';
	}else{
		$uname = basReq::val('uname');
		$upass = basReq::val('upass');
		if($uname && $upass){ 
			devData::rstIDPW($uname,$upass);
			$exmsg = "<br>".lang('tools.rst_idpw_id')."[<span class='cF03'>$uname</span>] ".lang('tools.rst_idpw_pw')."[<span class='cF03'>$upass</span>] ".lang('tools.rst_idpw_memory')."";
		}else{
			$exmsg = lang('tools.rst_idpw_error');	
		}
	}
}elseif($act=='expMod'){
  $exmsg = "<br>Export file to: ".devSetup::expGroup($exmod,$exmenu).".(php|dbsql)";
//}elseif($act=='xxx'){
}elseif(in_array($act,array('cdbPKey','cdbV255','cdbMKey'))){
	$_res = devScan::cdbStrus($act);
}elseif(method_exists('devData',$act)){
	devData::$act(); 
}elseif(method_exists('devScan',$act)){
  devScan::$act(); 
}elseif($act){
	echo "Error:$act";	
}
@$re = $act ? $names[$act].' ['."$act:".$part.'] - '.(empty($_res) ? lang('tools.rst_end') : $_res) : '';
$re .= '<br> @ '.date('Y-m-d H:i:s');

?>

<div>
  <p><?php lang('tools.rst_res',0); ?></p>
  <table width="100%" border="1" class="tblist">
    <tr id="res" class="tc">
      <td><?php echo $re.@$exmsg; ?></td>
    </tr> 
    <tr>
      <td class="tip"><?php lang('tools.rst_idpw_tip1',0); ?></td>
    </tr> 
  </table>
</div>

<script>
function chkIdpass(e,no,len){
	var orgcfgs = '<?php echo "$orguser,$orgpass"; ?>'.split(',');
	var simpass = ',<?php echo implode(',',glbConfig::read('simpass','ex')); ?>,';
	var tmp = $(e).val().replace(/\W/g, ""); //jsLog(tmp);
	if(simpass.indexOf(tmp)>0 || tmp.length<len){
		tmp = orgcfgs[no];
		alert('<?php lang('tools.rst_idpw_tip2',0); ?>'+simpass);
	}
	$(e).val(tmp);
}
</script>

<?php
glbHtml::page('end');
?>


/*******************************************************************************
 File : \root\tools\adbug\search.php 
*******************************************************************************/
<?php
require(dirname(__FILE__).'/_config.php'); 

// install;patch;updatedata;
define('SKIP',';.svn;_svn;.git;_git;'); 
define('SDIR',';@skipdir;');
define('BASE',DIR_PROJ);
// .log .js .asa .css .cs .config .inc .txt .as .asc .asr .vb .htaccess .htpasswd
define('FEXT','php;xml;txt;js;html;htm;css;tpl'); 
define('FMAX',1024); // 最大文件(KB)
define('CSET','utf-8'); // 默认编码(gb2312,gbk,big5,utf-8)

$file_arr = array();
include_once(DIR_CODE."/core/uext/exaSearch.php");

$path = isset($_REQUEST['path'])?$_REQUEST['path']:'';
$act = isset($_REQUEST['act'])?$_REQUEST['act']:'Form'; // Form,(Data,File),View,Light
$react = isset($_REQUEST['react'])?$_REQUEST['react']:'Data';

$dir = isset($_REQUEST['dir'])?$_REQUEST['dir']:''; if(!$dir) $dir = array('include'); 
$skip = isset($_REQUEST['skip'])?$_REQUEST['skip']:SDIR; 
$ex1 = isset($_REQUEST['ex1'])?$_REQUEST['ex1']:array('.php'); 
$ex2 = isset($_REQUEST['ex2'])?$_REQUEST['ex2']:array('.gif','.jpg','.jpeg','.png'); 
$key = isset($_REQUEST['key'])?$_REQUEST['key']:''; //echo $key;
$key = stripslashes($key); $keyBak = $key; $key = strtolower($key); 

$file = isset($_REQUEST['file'])?$_REQUEST['file']:'';
$cset = isset($_REQUEST['cset'])?$_REQUEST['cset']:'';
$cset2 = ($cset)?$cset:'utf-8';


?>
<!DOCTYPE html><html><head>
<meta charset="<?php echo $cset2; ?>">
<title>files-Search</title>
<style type="text/css">
body, td, th { font-size: 14px; line-height: 150%; }
.item, .iext { height: 12; float: left; overflow: hidden; border-bottom: 1px solid #CCC; white-space: nowrap; word-break: keep-all; padding: 1px; }
.item { width: 85px; margin: 0px 1px 0px 5px; }
.iext { width: 58px; margin: 0px 1px 0px 1px; }
.tab1 { width: 720px; margin: auto auto 12px auto; }
.subj { font-weight: bold; color: #333; background-color: #DDD; }
table.tab2 { background-color: #CCC; margin: 5px; }
table.tab2 td { background-color: #FFF; line-height: 120%; }
table.tab2 tr.subj td { background-color: #DDD; }
</style>
<script src='<?php echo PATH_ROOT; ?>/plus/ajax/comjs.php?_r=1456459912'></script>
<script src='<?php echo PATH_ROOT; ?>/skin/jslib/search.js?_r=1456459912'></script>
<style type="text/css">
.highlight { background: green; font-weight: bold; color: white; padding: 5px 2px; }
</style>
</head>
<body>
<?php
if(strstr('(View,Light)',$act)){ 
  // mb_convert_encoding ($fContents, $to, $from);
  header("content-Type: text/html; charset=$cset2;");
  //$key = str_replace('function ','',$key);
  echo "\n<b>File:$file</b> ( <span id='div_key_peace_xieys' style='color:#30F'></span> )<hr>"; 
  if($act=='Light'){
    highlight_file(BASE."/$file");
  }else{
	$data = file_get_contents(BASE."$file"); // null,lower
	echo "<pre>".htmlspecialchars($data,1)."\n</pre>\n"; 
  }
  $divkey = "document.getElementById('div_key_peace_xieys').innerHTML = 'keywords: $keyBak';";
  echo "<script type='text/javascript'>var n=0; schDone('$keyBak'); $divkey</script>";
  die("\n<body>\n<html>\n");
}
?>
<table border="1" class="tab1">
    <tr>
        <td width="18%" align="center"><strong><?php lang('tools.so_title',0); ?></strong></td>
        <td align="right"><a href="?">Refresh</a> &nbsp; </td>
    </tr>
</table>
<?php if($act=='Form'){ ?>
<table border="1" class="tab1">
    <form id="fm1" name="fm1" method="post" action="?">
        <tr>
            <td align="right">path.路径：<br />
                [<a href="<?php echo "?path=$path&key=$key"; ?>"><?php lang('tools.so_refresh',0); ?></a>]：</td>
            <td><table border="0" cellpadding="0" cellspacing="1">
                    <tr>
                        <td><a href='?dir=' class='item'>(Root)</a><?php echo fsget_dirs($path); ?></td>
                    </tr>
                    <tr>
                        <td><input name="path" type="text" id="path" value="<?php echo $path; ?>" size="56" /></td>
                    </tr>
                </table></td>
        </tr>

        <tr>
            <td align="right">case.方案：</td>
            <td><span class='item'>
                <input type="checkbox" onclick="schCase(this,'.php.class.tpl','.htm.html.txt.xml.css.js','code,core,adpt,flow','')" />
                <?php lang('tools.so_ptext',0); ?> </span> <span class='item'>
                <input type="checkbox" onclick="schCase(this,'.php.class.tpl','.htm.html.txt.xml.css.js','code,core','function ')" />
                <?php lang('tools.so_pfunc',0); ?> </span> <span class='item'>
                <input type="checkbox" onclick="schCase(this,'.php.class.tpl','.htm.html.txt.xml.css.js','cache,dynamic,pcache','$')" />
                <?php lang('tools.so_pvar',0); ?> </span> <span class='item'>
                <input type="checkbox" onclick="schCase(this,'.js.htm.html','.txt.xml.css','skin,jslib,a_jscss','')" />
                <?php lang('tools.so_js',0); ?> </span> <span class='item'>
                <input type="checkbox" onclick="schCase(this,'.htm.html.js.css.xml','.php','skin,jslib,a_jscss','')" />
                <?php lang('tools.so_html',0); ?> </span> <span class='item'>
                <input type="checkbox" onclick="schCase(this,'.php.tpl.js.css','.xml.txt.log','code,tpls,skin','class ')" />
                <?php lang('tools.so_tpl',0); ?> </span></td>
        </tr>
        <tr>
            <td align="right">dir.目录：</td>
            <td><?php echo fsdir_cbox($path); ?></td>
        </tr>
        <tr>
            <td align="right">skip.忽略： </td>
            <td><input name="skip" type="text" id="skip" value="<?php echo $skip; ?>" size="56" /></td>
        </tr>
        <tr>
            <td align="right">ext.后缀：</td>
            <td><?php echo fsext_list(1); ?></td>
        </tr>
        <tr>
            <td align="right">exu.排除：</td>
            <td><?php echo fsext_list(2); ?></td>
        </tr>
        <tr>
            <td align="right">key.关键字：</td>
            <td><input name="key" type="text" id="key" value="<?php echo $keyBak; ?>" size="56" /></td>
        </tr>

        <tr>
            <td width="18%" align="right"> Option.提交：</td>
            <td align="left"><select name="act" id="act">
                    <option value="Data">Data:内容</option>
                    <option value="File" <?php if($react=='File') echo ' selected="selected"'; ?>>File:文件</option>
                </select>
                <input type="submit" name="submit" id="submit" value="<?php lang('tools.so_send',0); ?>" />
                <?php lang('tools.so_tips',0); ?>
                <input type="hidden" name="dirs" id="dirs" value=";;" /></td>
        </tr>
    </form>
</table>
<script type="text/javascript"> 

</script>
<?php } ?>
<?php 
if(strstr('(Data,File)',$act)){ 
  $redir = ''; foreach($dir as $v) $redir .= ",$v";
  //if(count($ex1)==count(explode(';',FEXT))) $reex1 = '';
  //else { $reex1 = ''; foreach($ex1 as $v) $reex1 .= ",$v"; }
  $reex1 = ''; foreach($ex1 as $v) $reex1 .= ",$v";
  $reex2 = ''; foreach($ex2 as $v) $reex2 .= ",$v";
  $reskip = ($skip==SDIR)?'':$skip; 
?> 
<table border="1" class="tab1">
    <tr>
        <td><strong><?php lang('tools.so_res',0); ?></strong></td>
        <td colspan="2" align="center"><a href="?<?php echo "path=$path&skip=$reskip&key=$keyBak&react=$act&redir=$redir&reex1=$reex1&reex2=$reex2"; ?>"><?php lang('tools.so_back',0); ?></a></td>
    </tr>
    <tr>
        <td>Path-File</td>
        <td width="15%">Size(KB)</td>
        <td width="20%">Modify</td>
    </tr>
    <?php   
fsget_file($path);
for($i=0;$i<count($file_arr);$i++){
  $b = $file_arr[$i]; $f = $b['file']; $cset = $b['cset'];
  if(strlen($f)>50) $fname = substr($f,0,24).'(...)'.substr($f,strlen($f)-24);
  else $fname = $f;
?>
    <tr>
        <td><a href="?<?php echo "act=View&file=$f&key=$keyBak&cset=$cset"; ?>" target="_blank"><?php echo $fname; ?></a></td>
        <td><?php echo $b['size'] ?></td>
        <td nowrap="nowrap"><a href="?<?php echo "act=Light&file=$f&key=$keyBak&cset=$cset"; ?>" target="_blank"><?php echo $b['time'] ?></a></td>
    </tr>
    <?php
}
?>
</table>
<?php } ?>
</body>
</html>



/*******************************************************************************
 File : \root\tools\adbug\start.php 
*******************************************************************************/
<?php
require(dirname(dirname(__FILE__)).'/adbug/_config.php');

$proot = devRun::prootGet(); 
$fmsg = array();
if($qstr=='FixProot' && $proot!=PATH_PROJ){
    $fixres = devRun::prootFix($proot);
    $qstr = $fixres ? 'FixPrOkey' : 'FixPrError';
    $fmsg = devRun::prootMsg($proot, $qstr);
}else{
    $qstr = 'start';
}
if(!in_array($qstr,array('FixPrError','FixPrOkey')) && $proot!=PATH_PROJ){ 
    header("Location:../adbug/start.php?FixProot"); 
}

$umsg = devRun::startCheck(); 
if(!empty($fmsg)){
    $pmsg['fpath'] = $fmsg;
    $umsg = $pmsg + $umsg; 
}

$vcfg = vopTpls::etr1('tpl');

?>
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title><?php echo $_cbase['sys_name'].' - '.lang('tools.start_title'); ?></title>
<meta name='robots' content='noindex, nofollow'>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/skin/a_jscss/stpub.css'/>
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/skin/adm/b_jscss/comm.css'/>
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/tools/adbug/style.css'/>
<base target="_blank"/>
</head><body>
<!--[if lt IE 9]>
<h4 class='LowIE'>IE浏览器过低！建议你更换浏览器，如Chrome,Firefox,IE9+！</h4>
<![endif]-->
<dd class="langbar">
  <?php echo basLang::links("<a href='{url}' class='c666' target='_self'>{title}</a>"); ?>
</dd>
<div style="max-width:720px;margin:10px auto;">
  <table width="100%" border="1" class="tblist">
    <?php if(!empty($umsg)){ foreach($umsg as $k=>$v){ ?>
    <tr class="tc">
        <td class="tip"><?php echo $v['msg']; ?></td>
        <td class="tip"><h4><?php echo $v['tip']; ?></h4></td>
    </tr>
    <?php } } ?>
    <tr class="tc">
      <td>
      <h4><?php echo $_cbase['sys_name'].' - '.lang('tools.start_title'); ?> </h4>
      </td>
      <td width="25%" class="tc"><p class="txcode_logopub txcode_logostart"></p></td>
    </tr> 
  </table>
</div>

<?php
if(!empty($fmsg)){ die('</body></html>'); }
$mapurl = PATH_ROOT.'/plus/map/index.php?type=';
?>
<div>
  <p><?php lang('tools.bug_tools',0); ?></p>
  <table width="100%" border="1" class="tblist">
    <tr class="tc">
      <td><a href="binfo.php?phpinfo1" target="_self">phpinfo</a></td>
      <td colspan="2" class="tip">
	  <a href="../setup/">Setup - <?php lang('tools.start_setup',0) ?></a>
      </td>
      <td><a href="search.php">search</a></td>
    </tr>
    <?php tadbugNave(1); ?>
    <tr class="tc">
      <td><a href="cstudy.php">study</a>-<a href='cyahei.php'>yahei</a></td>
      <td><a href="<?php echo PATH_ROOT; ?>/plus/api/color.php">Color Pick</a></td>
      <td><a href="<?php echo $mapurl; ?>baidu">baidu<?php lang('tools.start_map',0) ?></a>-<a href="<?php echo $mapurl; ?>baidu&act=pick&point=113.756963,23.02224,17">pick</a></td>
      <td><a href="<?php echo $mapurl; ?>google">google<?php lang('tools.start_map',0) ?></a>-<a href="<?php echo $mapurl; ?>google&act=pick&point=113.750633,23.016454,16">pick</a></a></td>
    </tr> 
    <tr class="tc">
      <td><a href="binfo.php?login"><?php lang('tools.start_login',0) ?></a></td>
      <td><a href="../exdiy/rplan.php">rplan</a>-<a href="../exdiy/mktpl.php">mktpl</a></td>
      <td><a href="../exdiy/index.php">tools</a>-<a href="../exdiy/derun.php">derun</a></td>
      <td><a href="dbadm.php"><?php lang('tools.start_dbadmin',0) ?></a></td>
    </tr> 
  </table>
</div>

<?php
$col = 4; $ti = 0; 
$tm = count($vcfg)%$col; 
if($tm>0){ 
    $tm = $col - $tm;
}else{ 
    $tm = $col;
}
for($i=1;$i<$tm;$i++){
    $vcfg[$i] = array('','-');
}
$vcfg['---'] = array('HOME','');
?>
<div>
  <p>CMS<?php lang('tools.start_cmsentry',0) ?></p>
  <table width="100%" border="1" class="tblist">
    <tr class="tc">
	  <?php foreach($vcfg as $k=>$v){ $ti++; $url=($k=='---')?'../../':PATH_PROJ.@$v[1]; ?>
      <td width="25%"><a href="<?php echo $url; ?>"><?php echo !empty($v[0]) ? "($k)".basLang::pick(0,$v[0]) : ''; ?></a></td>
      <?php if(($ti)%$col==0 && $ti<count($vcfg)){ echo "</tr><tr class='tc'>\n"; }  } ?>
    </tr>
    <tr class="tc">
      <td><a href="<?php echo $_cbase['server']['txcode']; ?>/">yscode@txjia.com</a></td>
      <td><a href="http://txmao.txjia.com/">txmao@txjia.com</a></td>
      <td><a href="http://txjia.com/peace/txbox.htm">txbox@txjia.com</a></td>
      <td><a href="http://txjia.com/peace/txasp.htm">txasp@txjia.com</a></td>
    </tr> 
    <tr>
      <td colspan="4" class="tl"><?php 
	  $rtime = 1000*(microtime(1)-$_cbase['run']['timer']); 
	  $rinfo = basDebug::runInfo();
	  echo "<pre>"; echo "$rtime : $rinfo\n"; print_r($_cbase); echo "</pre>"; 
	  ?></td>
    </tr> 
    <tr>
      <td colspan="4" class="tip tc">Hi, I am <?php echo "<a href='{$_cbase['server']['txmao']}'>{$_cbase['sys_name']}</a>! I run @ <strong>{$_SERVER['HTTP_HOST']}</strong>";?></td>
    </tr> 
  </table>
</div>

</body></html>




/*******************************************************************************
 File : \root\tools\adbug\_config.php 
*******************************************************************************/
<?php
// 辅助调试工具，请用于合法用途，使用后请删除本文件或移动到网站目录之外！
//$_cbase['tpl']['tpl_dir'] = 'adm'; 
//$_cbase['run']['outer'] = 1;
//$_cbase['skip']['_sess_'] = true;
if(!session_id()) session_start();
$_cbase['ucfg']['lang'] = '(auto)'; 
include(dirname(dirname(dirname(__FILE__))).'/run/_paths.php');
include(DIR_CODE.'/cfgs/boot/cfg_adbug.php');
$sess_id = 'pmSessid_'.preg_replace("/[^\w]/", '', @$_cbase['safe']['safil']);

$qstr = $_SERVER['QUERY_STRING'];
$qstr || $qstr = 'binfo'; 
$_selfname = $_SERVER['PHP_SELF']; 
$allowb = array('binfo','phpinfo1','cookie','login','dologin','iframe','frame','fset');
$allowc = array('binfo');

if(strstr($_selfname,'start.php')){ 
	;//
}elseif(strstr($_selfname,'binfo.php') && in_array($qstr,$allowb)){ 
	;//
}elseif(strstr($_selfname,'check.php') && in_array($qstr,$allowc)){  
	;//
}else{
	bootPerm_ys('pstools','','<p><a href="binfo.php?login">login</a></p>');
	//else { $_isOut = 1; @include(dirname(__FILE__).'/devRun.php'); }
} 

function tadbugNave($path=''){
	if(empty($path)){
	echo "<tr class='tc'>
      <td class='tip'><a href='start.php'>&lt;&lt;".lang('tools.adcfg_start')."</a></td>
      <th colspan='2'>".lang('tools.bug_tools')."</th>
      <td class='tip'><a href='../setup/'>".lang('tools.adcfg_setup')."&gt;&gt;</a></td>";
	}
    echo "</tr><tr class='tc'>
      <td width='25%'><a href='binfo.php'>".lang('tools.adcfg_binfo')."</a></td>
      <td width='25%'><a href='check.php'>".lang('tools.adcfg_chkenv')."</a></td>
	  <td width='25%'><a href='cscan.php'>Check/Scan</a></td>
      <td width='25%'><a href='reset.php'>".lang('tools.adcfg_reset')."</a></td>
    </tr>";
}

function fchkFuncs($name) { return function_exists($name)?FLAGYES.' - Support('.lang('tools.adcfg_yes').') ':FLAGNO.' --- (X) ';}

function dfmtRemote($str,$method=''){
	$rem_cset = empty($_GET['rem_cset']) ? '' : $_GET['rem_cset'];
	if($rem_cset) $str = iconv($rem_cset,'utf-8',$str);
	$rem_show = empty($_GET['rem_show']) ? 'script,style' : $_GET['rem_show'];
	if(strstr($rem_show,'script')) $str=preg_replace("/<(script.*?)>(.*?)<(\/script.*?)>/si","",$str);
	if(strstr($rem_show,'style')) $str=preg_replace("/<(style.*?)>(.*?)<(\/style.*?)>/si","",$str);
	if(strstr($rem_show,'tags')) $str = strip_tags($str);
	if(strstr($rem_show,'_null_')) {
		$str=preg_replace("/<(style.*?)>(.*?)<(\/style.*?)>/si","",$str);
	}else{
		$str = nl2br($str);
		$str = htmlspecialchars($str); 
		$str = str_replace(array('&lt;br /&gt;','&amp;nbsp;'),array('<br />',' '),$str); 
	}
	return "<h1>$method</h1>\n$str";
}




/*******************************************************************************
 File : \root\tools\exdiy\derun.php 
*******************************************************************************/
<?php 
$_cbase['skip']['_paths'] = true;
$_fpcfg = dirname(__FILE__).'/_config.php';
if(file_exists($_fpcfg)) require($_fpcfg); 

// 辅助调试工具，请用于合法用途，使用后请删除本文件或移动到网站目录之外！
$_abase['out']['user'] = 'maotools'; // 如果有_config.php，则使用_config.php中的设置；
$_abase['out']['pass'] = 'maopass'; // 请每次使用,都改个新密码；否则安全问题,请后果自负！

if(!session_id()) session_start();
$sessid = 'usessid_'.$_SERVER['SCRIPT_NAME'].'_'.date('Y-m-d').''; 

define('YES', '<span style="color: #008000; font-weight : bold;">Yes</span>');
define('NO', '<span style="color: #ff0000; font-weight : bold;">No</span>');
define('LINKOK', '<span style="color: #008000; font-weight: bold;">OK</span>');
define('FAILED', '<span style="color: #ff0000; font-weight: bold;">Failed</span>');
define('SROOT', $_SERVER['DOCUMENT_ROOT']); 

$qstr = $_SERVER['QUERY_STRING'];
$inptype = @$_GET['inptype']; 
$inpval = @$_GET['inpval'];

$bomroot = empty($_GET['bomroot']) ? '../../../' : $_GET['bomroot']; //dirname(__FILE__)
$bompath = empty($_GET['bompath']) ? '' : $_GET['bompath'];
$bomfile = @$_GET['bomfile']; $bommsg = '';
if(!empty($bomfile)){
	if(bomRemove($bomroot,$bomfile)) $bommsg = "<li class='rmok'>BOM Remove OK! ------ $bomfile</li>\n";
} 

if(empty($qstr) || in_array($qstr,array('cook','fset','frame','iframe','myoutip','uoutip','login'))){
	//;
}elseif($qstr=='logout'){
	$_SESSION[$sessid] = '';
}elseif($qstr=='dologin'){ 
	$user = @$_POST['user'];
	$pass = @$_POST['pass'];
	$pget = function_exists('outPass') ? outPass($pass,$_abase['out']['pass']) : $_abase['out']['pass'];
	if($user==$_abase['out']['user'] && $pass==$pget){
		$_SESSION[$sessid] = 'pstools';
	}
}else{
	if(@!strstr($_SESSION[$sessid],'pstools')) die('Not Login!');
}

function funcExists($name) { return function_exists($name)?YES.' - Support(支持) ':NO.' --- (X) ';}
function gdlibInfo($name) { $info = gd_info(); $name = str_replace(array('bundled','compatible'),'',$info[$name]); return $name; }
function userInfo(){	
	$a = array('HTTP_X_REAL_FORWARDED_FOR','HTTP_X_FORWARDED_FOR','HTTP_CLIENT_IP','REMOTE_ADDR','HTTP_VIA','HTTP_USER_AGENT',); 
	$s = ''; 
	foreach($a as $k) if(isset($_SERVER[$k])) $s .= "<li><i>$k:</i>{$_SERVER[$k]}</li>\n";
	$s .= "</li>\n";
	return $s;
}	

function memoryTest($max){// 内存测试
	$timer = microtime(1);
	//len:12345678901234567890123456789012-34567890
	$t = 'Test string : memory_get_usage! ';
	$sUnit = ''; // *32=1M
	for($i=0;$i<1024*16;$i++) $sUnit .= $t;
	$mbit = ($max-1)*1024*1024; $t = '';
	while($max){
		$t .= $sUnit; $m = memory_get_usage(); 
		if($m>$mbit){
			$timer = microtime(1) - $timer;
			return "\nMemory test({$max}M) is OK!<br>
			  Now memory used is ".round($m/1024/1024,3)." MB,<br>
			  Test string length is ".strlen($t)." bit.<br>
			  Run time: $timer(s)";
		}
	}
}

function bomScan($bomroot,$rsub='',$flag=0) {  
	if(empty($rsub)) return;
	static $frstr,$bonum; 
	if(empty($frstr)){ 
		$frstr = "\n<ul>\n<li><b> ====== [root]: ====== </b></li>\n";
		$bonum = 0;
	}
	$full = "$bomroot/$rsub";
	$handle = opendir($full);
	while($file=readdir($handle)){
		//if(!is_file("$full/$file")) continue;
		if(in_array($file,array('.','..','.svn',))) continue;
		if(is_dir("$full/$file")){
			$bonum++; if($bonum>1000) die("<p> 文件太多,请设置目录缩小范围.</p>");
			$real = str_replace(SROOT,'',realpath("$full/$file"));
			echo "\n<ul>\n";
			echo "<li><b>$real:</b></li>\n";
			bomScan($full,$file,$flag+1);
			echo "</ul>\n";
		}else{
			$bonum++; if($bonum>1000) die("<p> 文件太多,请设置目录缩小范围.</p>");
			$fext = strtolower(strrchr($file,'.'));
			$fskip = array('.gif','.jpg','.jpeg','.png','.swf','.flv','.avi','.mpg','.doc','.docx','.zip','.rar','.gz');
			$size = round(filesize("$full/$file")/1024*100)/100 .' KB';
			$sutf = in_array($fext,$fskip) ? '' : bomCheck($full,$file);
			$ifile = "<li>$file <i class='size'>($size)</i> <i class='size'>$sutf</i></li>\n";
			if(!$flag) $frstr .= $ifile;
			else echo $ifile;
		}
	}
	if(!$flag) echo "$frstr</ul>\n";
	closedir($handle);
}
function bomDetect($data) {  
	$charset[1] = substr($data, 0, 1);  
	$charset[2] = substr($data, 1, 1);  
	$charset[3] = substr($data, 2, 1);  
	if (ord($charset[1]) == 239 && ord($charset[2]) == 187 && ord($charset[3]) == 191) return true;
	return false;
}  
function bomCheck($now,$file) {   
	$bomroot = @$_GET['bomroot'];
	$bompath = @$_GET['bompath'];
	if(!is_file("$now/$file")) return;
	$fp = fopen("$now/$file","r"); $data = fread($fp,8192); fclose($fp); 
	$fbom = bomDetect($data);
	$cset = mb_detect_encoding($data,array('ASCII','GB2312','BIG5','GBK','UTF-8'));
	$reutf8 = $cset=='UTF-8' ? "<i class='utf8'>[UTF-8]</i>" : '';
	$reubom = $fbom ? "<i class='red'>[BOM]</i>" : '';
	if($reubom && filesize("$now/$file")<=10*1024*1024 && !strstr($file,'.(bak)')){
		$bomfile = str_replace($bomroot,'',"$now/$file");
		$reubom = "<a href='?bomroot=$bomroot&bompath=$bompath&bomfile=$bomfile'>$reubom</a>";	
	}
	return "$reutf8$reubom";
} 
function bomRemove($dir,$file) {  
	$filename = str_replace('//','/',"$dir/$file");
	$data = file_get_contents($filename); 
	$fbom = bomDetect($data); 
	if($fbom){
		$orgext = strrchr($file,'.'); 
		$objext = str_replace('.','.(bak)',$orgext); 
		$objname = str_replace($orgext,$objext,$filename); 
		copy($filename,$objname); //有BOM才备份
		$data = substr($data,3);  
		$filenum = fopen($filename,"w");  
		flock($filenum, LOCK_EX);  
		fwrite($filenum, $data);  
		fclose($filenum); 
		return true; 
	}
	return false;
} 
function rem_Text($str,$method=''){
	$rem_cset = empty($_GET['rem_cset']) ? '' : $_GET['rem_cset'];
	if($rem_cset) $str = iconv($rem_cset,'utf-8',$str);
	$rem_show = empty($_GET['rem_show']) ? 'script,style' : $_GET['rem_show'];
	if(strstr($rem_show,'script')) $str=preg_replace("/<(script.*?)>(.*?)<(\/script.*?)>/si","",$str);
	if(strstr($rem_show,'style')) $str=preg_replace("/<(style.*?)>(.*?)<(\/style.*?)>/si","",$str);
	if(strstr($rem_show,'tags')) $str = strip_tags($str);
	$str = nl2br($str);
	$str = htmlspecialchars($str); 
	$str = str_replace(array('&lt;br /&gt;','&amp;nbsp;'),array('<br />',' '),$str); 
	return "<hr><h1>$method</h1><br>$str";
}
function rem_fsockopen($url){
	$url2 = parse_url($url);
	$url2["path"] = isset($url2["path"])? $url2["path"]: "/" ;
	$url2["port"] = isset($url2["port"])? $url2["port"] : 80;
	$url2["query"] = isset($url2["query"])? "?".$url2["query"] : "";
	$fp = fsockopen($url2['host'], $url2["port"], $errno, $errstr, 3);   
	if (!$fp) {   
		return "$errstr ($errno)<br />\n";   
	} else {   
		$out = "GET ".$url2["path"].$url2["query"]." HTTP/1.1\r\n";   
		$out .= "Host: www.baidu.com\r\n";   
		$out .= "Connection: Close\r\n\r\n";   
		fwrite($fp, $out); 
		$re = '';  
		while (!feof($fp)) {   
			$re .= fgets($fp, 128);   
		}   
		fclose($fp); 
		return $re; 
	} 
}
function rem_curl_init($url){
	$curl = curl_init();
	curl_setopt($curl, CURLOPT_URL, $url);
	curl_setopt($curl, CURLOPT_HEADER, 1);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
	$re = curl_exec($curl);
	curl_close($curl);
	return $re; 
}
function rem_file_get_contents($url){
	$re = file_get_contents($url);
	return $re; 
}	

if(strstr($qstr,'memory')){
	die(memoryTest($inpval));
}
if(strstr($qstr,'funcs')){
	echo '<meta charset="utf-8">';
	$res = funcExists($inpval); 
	die($res);
}
if($qstr=='image'){
	$w = 240; $h = 180; $im = imagecreate($w,$h);
	imagefill($im,0,0,imagecolorallocate($im,245,245,245)); //背景
	for($i=0;$i<5;$i++){
	  $ctab = 'ABCDEFGHJKLMNPQRSTUVWXY3456789'; 
	  $char = $ctab{mt_rand(0,strlen($ctab)-1)}; 
	  $color = imagecolorallocate($im,rand(100,255),rand(0,100),rand(100,255));
	  $xPos=($w/2-60)+rand(5,11);
	  $yPos=($h/2-20)+rand(3,7);
	  imagestring($im,5,$i*15+$xPos,$yPos,$char,$color);
	}
	for($i=0;$i<180;$i++){ //加入干扰象素
	  $color = imagecolorallocate($im,rand(0,255),rand(0,255),rand(0,255));
	  imagesetpixel($im,rand(10,$w-10),rand(10,$h-10),$color);
	} 
	imagerectangle($im,0,0,$w-1,$h-1,imagecolorallocate($im,rand(30,240),rand(30,240),rand(30,240)));
	header("Content-type: image/png");
	imagepng($im); imagedestroy($im);
	die(); // jpeg
}
if(strstr($qstr,'phpinfo')){ 
	$no = str_replace('phpinfo','',$qstr);
	$no = empty($no) ? '1' : max(1,intval($no));
	phpinfo($no);
	die();
}

?>
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<title>Debuger</title>
<meta name='robots' content='noindex, nofollow'>
<style type="text/css">
body { padding: 1px; margin: 1px; }
div { border: 1px solid #999; padding: 10px; max-width: 620px; margin: 10px auto; }
table { border: 1px solid #999; padding: 2px; width: 620px; margin: 1px auto; }
p { font-weight: bold; text-align: center; background: #CCC; border: 1px dashed #999; padding: 3px; margin: 5px 0px; }
section { margin: 5px; }
.css3 { font-size: larger; color: #009; text-shadow: 0px -3px 0px #FFF, 0px 2px 3px #333; border-radius: 32px; }
<?php if(strstr($qstr,'bom')){ ?>
li i { font-style:normal; }
li i.size { color:#ccc; }
li i.red { color:#F00; }
li i.utf8 { color:#999; }
li.rmok { color: #ff0000; font-weight: bold; }
<?php }else{ ?>
li { border-bottom:1px solid #CCC; margin:1px 0px; }
li,a { vertical-align:top; line-height:120%; }
i { width:150px; font-style:normal; display:inline-block; overflow:hidden; padding:0px 3px; margin:0px; }
i.w1 { width:240px; }
i.w2 { width:80px; }
<?php } ?>
.notice { font-size:small; color:#F00; background:#FF9; display:block; padding:5px; }
</style>
</head><body>
<?php
if($qstr=='full'){
	foreach($_SERVER as $k=>$v){ 
		$v = str_replace(SROOT,'{ROOT}',$v);
		if($k!='HTTP_COOKIE'){
			echo "<li>$k: $v</li>\n";
		}
	}
}elseif($qstr=='testError'){
	ini_set('display_errors', 'On');
	error_reporting(E_ALL); 
	echo "<div>测试是否看到[Warning/Notice]提示和最后的[-End-]标记；<br> --- 开发化境如不能看到,请设置环境以便于调试? <br>\n";
	$er1 = 234/0;
	$er2 = $er3;
	echo("<p>-End-</p></div>\n\n");
}elseif($qstr=='cook'){
	$a = explode('; ',$_SERVER['HTTP_COOKIE']);
	foreach($a as $k=>$v){ 
		echo "<li>$k: $v</li>\n";
	}
}elseif($qstr=='sysvar'){
	echo "\r\n<pre style='line-height:150%;'>"; 
	print_r($GLOBALS); //$_GET,
	echo "</pre>\r\n";
}
?>

<?php if(in_array($qstr,array('login','logout','dologin'))){ ?>
<div>
  <?php if(@!strstr($_SESSION[$sessid],'pstools')){ ?>
  <p>Login ……</p>
  <form action="?dologin" method="post" target="_self">
    User<input type="text" name="user" id="user" value="">
    Pass<input type="password" name="pass" id="pass" value="">
    <input type="submit" name="act" id="act" value="Login">
  </form>
  <?php }else{ ?>
  <p>Login OK!</p>
  <?php } ?>
  <ul>
  <li>Home : <a href="?login" target="_self">Login</a> | <a href="?logout" target="_self">Logout</a> | <a href="?">uinfo</a></li>
  </ul>
  <span class="notice">Peace提示：请用于合法用途；使用前前改密码，使用后请删除本文件或移动到网站目录之外！</span>
</div>
<?php } ?>

<?php 
if(strstr($qstr,'remote')){ 
$rem_url = empty($_GET['rem_url']) ? 'http://www.baidu.com/' : $_GET['rem_url'];
$rem_type = empty($_GET['rem_type']) ? '' : $_GET['rem_type'];
?>
<div>
  <form id="fmremote" name="fmremote" method="get" action="?">
    <p><a href='?remote'>Remote抓取</a> </p>
    <ul>
    <li>
      <i class="w2">Url: </i>
      <input name="rem_url" type="text" value="<?php echo $rem_url; ?>" style="width:360px;"> 
    </li>
    <li><i class="w2">扩展:</i>
        <select name="rem_type" style="width:360px;">
          <option value="">---选一个操作---</option>
          <option value="file_get_contents">函数(file_get_contents)</option>
          <option value="fsockopen">函数(fsockopen)</option>curl_init
          <option value="curl_init">函数(curl:curl_init,curl_setopt)</option>
        </select>
    </li>
    <li><i class="w2">显示:</i>
        <select name="rem_show" style="width:150px;">
          <option value="">---显示方式---</option>
          <option value="script_style">去script,style(默认)</option>
          <option value="script_style_tags">文本(包含默认)</option>
          <option value="_null_">原文(原本html)</option>
        </select>
        <select name="rem_cset" style="width:150px;">
          <option value="">---(默认utf-8)---</option>
          <option value="gbk">gbk编码</option>
          <option value="gb2312">gb2312编码</option>
          <option value="big5">big5编码</option>
        </select>
        <input type="submit" name="submit" id="submit" value="提交" />
    </li>
    </ul>
    <input name="remote" type="hidden" value="1">
  </form>
</div>
<?php
if($rem_type && $rem_url){
	$func = "rem_$rem_type";
	echo rem_Text($func($rem_url),"$rem_type : $rem_url");		
} 
?>
<?php die('</body></html>'); } ?>

<?php if(strstr($qstr,'bom')){ ?>
<div>
  <form id="fmbom" name="fmbom" method="get" action="?bomcheck">
    <p><a href='?bomcheck'>BOM检测</a> </p>
    <ul>
	<?php echo $bommsg; ?>
    <li>
      <i class="w2">根目录: </i><input name="bomroot" type="text" value="<?php echo $bomroot; ?>" size="15"> 
      <input type="submit" value="设置">
      <span title="点[BOM]连接,将移除BOM">点击[子目录], [Ctrl+F]搜索[BOM]</span> &nbsp; 
     </li>
    <li>
    <i class="w2">子目录：</i>
    <?php 
	$handle = opendir($bomroot);
	while($file=readdir($handle)){
		if(in_array($file,array('.','..','.svn',))) continue;
		if(is_dir("$bomroot/$file")){
			echo " : <a href='?bomroot=$bomroot&bompath=$file'>$file</a>\n";
		}
	}
	closedir($handle);
	?>
    </li>
    </ul>
  </form>
</div>
<?php
if($bompath){
	bomScan($bomroot,$bompath);
} 
?>
<?php } ?>

<?php if($qstr=='comext'){ ?>
<div>
  <form id="fmup" name="fmup" method="post" action="?comext" enctype="multipart/form-data">
    <p>文件上传 &gt;&gt; <a href='?bomcheck' target='_blank'>BOM检测</a> </p>
    <ul>
	<?php
    if(!empty($_POST['upLoad'])){	// LINKOK,FAILED
        $uppath = $_POST['uppath'];
        foreach($_FILES as $f){
            if($f['name']){ 
                $fp = $uppath.$f['name']; 
                $r = move_uploaded_file($f['tmp_name'],$fp); 
                chmod($fp, 0755);//设定上传的文件的属性 
                echo "<li><i class='w2'>结果:</i>$fp 上传OK</li>"; 
        }	}
    }
    ?>
	<li><i class="w2">文件：</i><input type="file" name="fileup1" id="fileup1"></li>
    <li>
    <i class="w2">路径：</i><input name="uppath" type="text" id="uppath" value="./" size="18"/>
    <input type="submit" name="upLoad" id="upLoad" value="上传" />
    </li>
    </ul>
  </form>
</div>

<div>
  <form id="fmy" name="fmy" method="post" action="?comext">
    <p>MySQL 连接测试</p>
    <ul>
	  <?php
      if(!empty($_POST['Connect'])){	// LINKOK,FAILED
          $host = @$_POST['host'];
          $user = @$_POST['user'];
          $dbname = @$_POST['mysqlDb'];
          $link = @mysql_connect($host, $user, @$_POST['pass']);
          $svrstr = $link ? LINKOK." Server Version:".mysql_get_server_info($link) : FAILED." [".mysql_errno()."] ".mysql_error();  
          $dbflag = @mysql_select_db($dbname,$link);
          $dbstr = ($dbflag ?  LINKOK." $dbname" : FAILED." [".mysql_errno()."] ".mysql_error());  
          echo "<li><i>连接-服务器:</i>$svrstr</li>";
          echo "<li><i>连接-数据库:</i>$dbstr</li>";
      }else{
          $host = 'localhost'; 
          $user = 'root';
          $dbname = 'test';
      }
      ?>
      <li>
      <i class="w2">服务器:</i><input name="host" type="text" value="<?php echo $host ?>" size="18" />
      <i class="w2">数据库:</i><input name="mysqlDb" type="text" value="<?php echo $dbname ?>" size="18" />
      </li>
      <li>
      <i class="w2">用户名:</i><input name="user" type="text" value="<?php echo $user ?>" size="18" />
      <i class="w2">密码:</i><input name="pass" type="text" size="18" />
      </li>
      <li><i class="w1">连接…:</i><input name="Connect" type="submit" id="Connect" value="连接" /></li>
    </ul>
  </form>
</div>

<div>
  <form id="fmb" name="fmb2" method="get" action="?" target="_blank">
    <p>(PHP)Server Info</p>
    <ul>
      <li><i>OS:</i><?php echo PHP_OS.' (PROCESSORS:'.@$_SERVER['NUMBER_OF_PROCESSORS'].')'; ?></li>
      <li><i>Web Server:</i><?php echo $_SERVER['SERVER_SOFTWARE']; ?></li>
      <li><i>PHP:</i><?php echo PHP_VERSION.' (SAPI:'.PHP_SAPI.')'; ?></li>
      
      <li><i>Zend Optimizer:</i><?php echo defined('OPTIMIZER_VERSION') ? YES.' / '.OPTIMIZER_VERSION : NO.' --- (X)'?></li>
      <li><i>MySQL 支持:</i><?php echo function_exists('mysql_close') ? YES.' / '.substr(mysql_get_client_info(),0,30) : NO?></li>
      <li><i>GD library:</i><?php echo function_exists('gd_info') ? YES.' / '.gdlibInfo('GD Version') : NO?></li>

      <?php 
	  $__a = array(array('curl_init'),array('fsockopen'),array('file_get_contents'),array('ob_gzhandler'),array('eAccelerator','eaccelerator_info'),array('Memcache','memcache_connect'),array('Mail','mail'),array('FTP','ftp_connect'));
	  foreach($__a as $__a1){ $__f1 = isset($__a1[1]) ? $__a1[1] : $__a1[0];
	  ?>
      <li><?php echo '<i>'.$__a1[0].':</i>'.funcExists($__f1)?></li>
      <?php }?>

      <li><i>超级测试:</i>
        <select name="inptype" onChange="setInpval(this)" style="width:200px;">
          <option value="">---选一个操作---</option>
          <option value="memory">内存(填数字,出错表示不支持)</option>
          <option value="funcs">函数(填字符,Support表示支持)</option>
        </select>
        <input name="inpval" type="text" id="inpval" value="<?php echo $inpval; ?>" style="width:100px;"/>
        <input type="submit" name="submit" id="submit" value="Submit" />
      </li>
    </ul>
  </form>
</div>
<script type="text/javascript">
function setInpval(e){
	var type = e.value,res = '';
	if(type=='memory')  res = 32;
	if(type=='funcs')  res = 'phpinfo';
	document.getElementById('inpval').value = res;
}
</script>
<?php } ?>

<?php if($qstr=='define'){ ?>
<p class="tip">环境检测 --- define</p>
  <table width="100%" border="1" class="tblist">
	<?php 
    $df = get_defined_constants(true);
    foreach(array('user','Core','mhash','internal','pcre') as $gk){ 
		if(!isset($df[$gk])) continue;
		$gv = $df[$gk];
    ?>
    <tr>
      <th><?php echo $gk; ?></th>
      <th>Key</th>
      <th>Value</th>
    </tr>
	<?php 
    foreach($gv as $k=>$v){ 
	?>
    <tr>
      <td class="tr" colspan="2"><?php echo $k; ?></td>
      <td class="tl"><?php echo $v; ?></td>
    </tr>
    <?php } } ?>
  </table>
<?php } ?>

<?php if(empty($qstr)){ ?>
<div>
  <p>(PHP) Debuger --- by Peace</p>
  <ul>
    <li><i>Server&gt;&gt;&gt;:</i><a 
    href='?full' target='_blank'>Server</a> | <a 
    href='?cook' target='_blank'>Cookie</a> | <a  
    href='?sysvar' target='_blank'>Sysvar</a> | <a  
    href='?phpinfo1' target='_blank'>phpinfo</a>(<a 
    href='?phpinfo4' target='_blank'>4</a>,<a 
    href='?phpinfo8' target='_blank'>8</a>,<a 
    href='?phpinfo16' target='_blank'>16</a>,<a 
    href='?phpinfo255' target='_blank'>255</a>)</li>
    <li><i>Advanced&gt;&gt;&gt;:</i><a 
    href='?image' target='_blank'>Image</a> | <a 
    href='?comext' target='_blank'>MySQL</a>-<a  
    href='?comext' target='_blank'>Extens</a>-<a 
    href='?comext' target='_blank'>Upload</a> | <a 
    href='?bomcheck' target='_blank'>BOMCheck</a> | <a  
    href='?remote' target='_blank'>Remote</a></li>
    <li><i>Extend&gt;&gt;&gt;:</i><a 
    href='?testError' target='_blank'>Error</a> | <a 
    href='?define' target='_blank'>Define</a> | <a 
    href='?null' target='_blank'>(null)</a> | <a  
    href='?login' target='_blank'>login</a></li>
    <?php echo '<li><i>Server Time:</i>'.date('r').'</li>'; echo userInfo(); ?>
  </ul>
  <span class="notice">Peace提示：请用于合法用途；使用前前改密码，使用后请删除本文件或移动到网站目录之外！</span>
</div>
<?php } ?>

</body></html>



/*******************************************************************************
 File : \root\tools\exdiy\index.php 
*******************************************************************************/
<?php 
include(dirname(__FILE__).'/_config.php'); 

// This script is only accessible from: <br>localhost (127.0.0.1, ::1)
// for your dir debug ... 
$list = comFiles::listDir(dirname(DIR_PROJ).'/tester'); 
$svlink = '';
foreach ($list['dir'] as $dir=>$ctime) {
	$svlink .= "<a href='?dir=$dir&part=tester'>$dir</a> #";
}
echo "<meta charset='utf-8'>\n<style type='text/css'>p{margin:20px;line-height:150%;}</style>\n";
echo "<p>
	<a href='?dir=exdiy'>exdiy:扩展功能</a>
	# <a href='?dir=08data&part=08data'>08data:导数据</a> 
	<br> $svlink
</p>\n";

$part = basReq::val('part','(root)');
$dir = basReq::val('dir','utest');
$pcfg = array(
	'(root)' => array(dirname(dirname(__FILE__)), '..'),
	'tester' => array(dirname(DIR_PROJ)."/tester", '../../../../tester'),
	'08data' => array(dirname(DIR_PROJ), '../../../..'),
);
$dbase = $pcfg[$part][0]; 

function listDir($dbase,$dir='',$part=''){
	global $pcfg;
	$list = comFiles::listDir("$dbase/$dir"); 
	if(empty($list['file'])) die('(null)');
	foreach ($list['file'] as $file => $val) {
		if(!strpos($file,'.php')) continue;
		if(in_array($file,array('index.php','_config.php'))) continue;
		$b2 = $pcfg[$part][1]; 
		echo " --- <a href='{$b2}/$dir/$file' target='_blank'>$file</a><br>\n";
	}
}

/*
$ex = new Exception();
$ex->__construct();
//error_get_last(); 
$trace = $ex->getTrace();
dump($trace);
//
@$s = 222/0;
//new glbError(); 
*/

echo "\n<p>";
if(!strstr($dir,'./')) listDir($dbase,$dir,$part);
echo "</p>\n";




/*******************************************************************************
 File : \root\tools\exdiy\mktpl.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php');  

glbHtml::page("Create Suit Template - (sys_name)",1);
glbHtml::page('imin');
#echo basJscss::imp("/tools/exdiy/sfunc.js");
echo basJscss::imp("/tools/exdiy/style.css");
glbHtml::page('body');

$dir = basReq::val('dir');
$front = basReq::val('front');
$mod = basReq::val('mod');
$dmsg = '';

if($dir && $front && $mod){
	$flag = 'done';
	$dmsg = devApp::create($dir, $front, $mod);
	$smsg = $dmsg=='OK' ? lang('tools.mktpl_crtok') : lang('tools.mktpl_crtng').$dmsg;
	$fmsg = $dmsg=='OK' ? 'OK' : lang('tools.mktpl_error');
}

include(vopShow::inc('/tools/exdiy/mktpl.htm',DIR_ROOT));

glbHtml::page('end');



/*******************************************************************************
 File : \root\tools\exdiy\rplan.js 
*******************************************************************************/

var wNames = new Array("Sun", "Mon", "Tue", "Wen","Thu", "Fri", "Sat");
// 执行一个任务
function jobRun(hm,i){
	//jsLog('do:'+jid);
	var jid = pLists[i][0];
	if(!jsElm.jeID('job_'+jid)){
		//var url = _cbase.run.roots + jcronRun(0,0,1) + '&file=' + jid;
		var url = _cbase.run.roots + '/plus/ajax/cron.php?file='+jid+'&'+urlp+'&'+jsRnd();
		var title = jid + ' @ <b>' + hm + '</b><input class="url" value="'+url+'">';
		var str = '<li id="job_'+jid+'">'+title+'<iframe src="'+url+'"" width="100%" height="40"></iframe></li>';
    	$('#job_lists').append(str);
    }
}
// 整理任务列表
function jobReset(hm,s){
	if(s && s%5==0){ 
		$('#job_lists li').each(function(i,e){
			var t = $(this).find('b').html(); 
			if(t!=hm) $(this).remove();
		});
	}
	num = $('#job_lists li').length;
	idSate.innerHTML = num ? lang('jcore.rplan_nrun',num) : lang('jcore.rplan_nrun',rpaln_null); 
}
// 获取现在时间
function timeNow(){
	var oTime = new Date();
	var hh = oTime.getHours(); if(hh<=9) hh="0"+hh;
	var mm = oTime.getMinutes(); if(hh<=9) mm="0"+mm;
	var ss = s = oTime.getSeconds(); if(ss<=9) ss="0"+ss;
	var y = oTime.getFullYear();
	var m = oTime.getMonth(); m++;
	var d = oTime.getDate();
	var w = oTime.getDay();
	idNow.innerHTML = y+'-'+m+'-'+d+' '+hh+':'+mm+':'+ss+'('+wNames[w]+')';
	return {'hm':hh+':'+mm, 'w':w, 's':s};
}
// 定时器
function timeSec(){
	var now = timeNow();
	for(var i=0;i<pLists.length;i++){
		var t = pLists[i][1].split('@');
		if(t[0]==now.hm){
			if(t[1] && parseInt(t[1])!=now.w) continue;
			jobRun(now.hm,i);
		}
	}
	jobReset(now.hm,now.s);
	setTimeout("timeSec()",1000); 
}




/*******************************************************************************
 File : \root\tools\exdiy\rplan.php 
*******************************************************************************/
<?php 
require(dirname(__FILE__).'/_config.php');  

glbHtml::page("Run Plan - (sys_name)",1);
echo "<meta http-equiv='refresh' content='14400' />\n";
glbHtml::page('imin');
echo basJscss::imp("/plus/ajax/comjs.php?act=autoJQ");
echo basJscss::imp("/tools/exdiy/style.css");
echo basJscss::imp("/tools/exdiy/rplan.js");
glbHtml::page('body');

$ocfgs = glbConfig::read('outdb','ex');
$safix = $_cbase['safe']['safix'];
$sapp = $ocfgs['sign']['sapp'];
$skey = $ocfgs['sign']['skey'];

$act = basReq::val('act','');
include(vopShow::inc('/tools/exdiy/rplan.htm',DIR_ROOT));
glbHtml::page('end');
?>

<script>
// >勿P]! 定rXX 瘸绦

<?php echo "var urlp = '{$safix}[sapp]=$sapp&{$safix}[skey]=$skey';\n"; ?>
var pLists = [
    // configs
    /*
    new Array("clear_acts", "00:20"),
    new Array("clear_logs", "00:40"),
    new Array("clear_wex",  "01:00"),
    */
    <?php if($act=='utest') echo exvCron::plistTest(); ?>
]; 
<?php if($act!='alist') echo "setTimeout('timeSec()',1000);"; ?>

</script>




/*******************************************************************************
 File : \root\tools\exdiy\_config.php 
*******************************************************************************/
<?php
if(empty($_cbase['skip']['_paths'])){
	include(dirname(dirname(dirname(__FILE__))).'/run/_paths.php');
}

// idea From : Symfony : config.php
if (!isset($_SERVER['HTTP_HOST'])) {
    exit('This script cannot be run from the CLI. <br>Please run it from a browser.');
}
if (!in_array(@$_SERVER['REMOTE_ADDR'], array(
    '127.0.0.1',
    '::1',
))) {
    header('HTTP/1.0 403 Forbidden');
    exit('This script is only accessible from: <br>localhost (127.0.0.1, ::1).');
}




/*******************************************************************************
 File : \root\tools\index.php 
*******************************************************************************/
<?php header('Location:../index.php');?>


/*******************************************************************************
 File : \root\tools\rhome\@read.js 
*******************************************************************************/

document.write("<script src='../root/skin/jslib/jsbase.js'></script>");
document.write("<script src='../root/skin/a_jscss/mkdown.js'></script>");

var doc_url = '../code/tpls/dev/d_start/doc_down'+cfg.lang+'.txt';
window.onload = function (){
	setTimeout('_readInit()',100);
} 

function _readInit(){
	rdfStyle(); 
	rdfMDown();
	rdfDShow();
	//try{}catch(ex){}
}

function rdfDShow(){
    url = doc_url+'?_r='+(new Date).getTime(); 
	var http = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Msxml2.XMLHttp"); 
    http.open("get", url, true);  
    http.onreadystatechange = function(){
		if(http.readyState==4){ if(http.status==200){ 
			var data = mkDown(http.responseText,1); 
			data = '<hr><pre>['+doc_url+']'+data+'</pre>'; 
			jsElm.jeTag('body').innerHTML += data;
		} }    
	} 
	http.send(null); 
}

function rdfMDown(){
	var obody = jsElm.jeTag('body'); 
	var data = obody.innerHTML; 
	data = mkDown(data,1); 
	data = mkDLink(data, doc_url);
	obody.innerHTML = data;
}

function rdfStyle(){
	var text = 'html{line-height:120%;}';
	var style = document.createElement("style"); 
	jsElm.jeTag('head').appendChild(style);
	if(style.styleSheet){ //for ie
		style.styleSheet.cssText = text;
	}else{ //for w3c
		style.appendChild(document.createTextNode(text)); 
	}
}




/*******************************************************************************
 File : \root\tools\rhome\hfunc.js 
*******************************************************************************/

function qrActs(){
	$('nav').on('mouseover','a',function(){
		var href = $(this).prop('href'); 
		var mod = $(this).find('i').prop('id').replace('qrcode_pic',''); 
		qrurl_act(mod,1,href); //jsLog(href);
	});
	$('nav').on('mouseout','a',function(){
		var mod = $(this).find('i').prop('id').replace('qrcode_pic',''); 
		qrurl_act(mod,0);
	});
	$('.qrcode_home').on('mouseover','',function(){
		var href = $(this).attr('_url');
		qrurl_act('home',1,_burl+href); //jsLog(_burl+href);
	});
	$('.qrcode_home').on('mouseout','',function(){
		qrurl_act('home',0);
	});
}

function winReset(){
	var swin = winSize(); //jsLog(swin); 
	var sdiv = jeSize('outer'); 
	// width:960px; height:540px;
	var tmpw = swin.w-20; if(tmpw>960) tmpw = 960;
	$('#outer').width(tmpw);
	tmph = swin.h-20; if(tmph>540) tmph = 540;
	$('#outer').height(tmph);
	// toph,ftop
	var toph = (swin.h - tmph)/3; 
	$('.ptop').height(parseInt(toph));
	$('.ptop').show();
	var ftop = $('#outer').height()-35;
	$(".foot").css({"top":ftop+"px"});
	var hkid = tmpw<tmph ? 1 : 0;
	impCssText(adpCssText(hkid),'peaceStyle');
}

function adpCssText(ismoble){
	var s = new Array('','');
	s[0] = "nav { margin:10px 1px 1px 10px; text-align:left; }";
	s[0] = "nav a { margin:0px 0px 5px 5px }";
	s[0] += "p.logo, h1.title { text-align: center; display:inline-block; position:absolute; }";
	s[0] += "p.logo { left:25px; top:60px; border-radius:3px; margin:0px; }";
	s[0] += "h1.title{ left:155px; top:92px; font-size:large; line-height:160%; padding:0px; margin:0px; }";
	s[1] += "nav { margin:10px auto 10px auto; text-align:center; }";
	s[1] += "nav a { margin:5px 5px 5px 5px; }";
	s[1] += "p.logo, h1.title { left:auto; top:auto; position:relative; display:block; clear:both; margin:10px auto 10px auto; }";
	return s[ismoble];
}

function impCssText(text,cssId){
	if($('#'+cssId)){ $('#'+cssId).remove(); }
	var style = document.createElement("style"); 
	style.id = cssId;
	document.getElementsByTagName("head")[0].appendChild(style);
	if(style.styleSheet){ //for ie
		style.styleSheet.cssText = text;
	}else{ //for w3c
		style.appendChild(document.createTextNode(text)); 
	}
}
//impCssText("#div{background-color:#F30;color:#FF;}","ucss01");



/*******************************************************************************
 File : \root\tools\rhome\home.php 
*******************************************************************************/
<?php
(!defined('RUN_MODE')) && die('No Init');
$_cbase['tpl']['tpl_dir'] = 'chn';
$isMobile = basEnv::isMobile();
$vcfg = vopTpls::etr1('tpl'); 
$qrActs = $isMobile ? '' : "qrActs();"; 
?>
<!DOCTYPE html><html><head>
<meta charset="utf-8">
<?php glbHtml::page('imvop'); ?>
<script src="<?php echo PATH_ROOT; ?>/tools/rhome/hfunc.js?v12"></script>
<link rel='stylesheet' type='text/css' href='<?php echo PATH_ROOT; ?>/tools/rhome/hstyle.css?v12'/>
<title><?php echo $_cbase['sys_name']; ?> - 通用PHP建站系统 </title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content="<?php echo $_cbase['sys_name']; ?>,轻量免费,开源共享,PHP CMS,微信接口" />
<meta name="description" content="<?php echo $_cbase['sys_name']; ?>是一款轻量、免费、共享的通用PHP网站应用系统；PC版-手机版-微信接口一站搞定！" />
<style type="text/css">
div.outer { 
	background-image:url(<?php echo PATH_STATIC; ?>/media/cover/green_02_1024x576.jpg); 
}
<?php if($isMobile){ ?>
nav { margin:10px auto 10px auto; text-align:center; }
nav a { margin:5px 5px 5px 5px; }
p.logo, h1.title { left:auto; top:auto; position:relative; display:block; clear:both; margin:10px auto 10px auto; }
<?php } ?>
</style>
</head>
<body>
<?php glbHtml::ieLow_html(); ?>

<p class="ptop" style="display:none;">
</p>
<div class="outer" id="outer">
	<nav id="nav">
      <?php foreach($vcfg as $k=>$v){ ?>
      <a href="<?php echo PATH_PROJ.$v[1]; ?>" class="qrcode_tip"><?php echo $v ? "($k)$v[0]" : ''; ?><i class="qrcode_pic" id="qrcode_pic<?php echo $k; ?>" style="display:none;"></i></a>
      <?php } ?>
    </nav>
    <p class="logo"><img src="<?php echo PATH_ROOT; ?>/skin/a_img/logo120x60.jpg" width="120" height="60" ></p>
    <h1 class="title"><b><?php echo $_cbase['sys_name']; ?></b></h1>
    
    <div class="vnote">
        ● 管理中心
         --- 您的网站您做主！<br>
        ● 中文版 
         --- 传统经典PC主要展示版本<br>
        ● 演示版 
         --- 为您指点迷津;二次开发DIY!<br>
        ● 手机版 
         --- 精简移动端展示模块<br>
        ● 会员中心
         --- 用户:订单/公文/问答
    </div>
    
    <p class="foot">
    [<a href="?start">Start</a>] # 
     <a href="tencent://message/?uin=80893510&Site=贴心猫&Menu=yes">QQ</a> # 
     <a href="mailto:xpigeon#163.com">E-mail</a>
    [<a class="qrcode_home" _url='<?php echo PATH_PROJ; ?>'>Scan<i class="qrcode_hpic" id="qrcode_pichome" style="display:none;"></i></a>]
    <br>
    Copyright ? <?php echo $_cbase['sys_name']; ?> 
    </p>
</div>

<script type="text/javascript">
<?php echo "var _burl = '{$_cbase['run']['rsite']}'\n"; ?>
$(function(){ winReset(); <?php echo $qrActs; ?> });
$(window).resize(function(){ winReset(); });
</script>
<?php echo "<!--".basDebug::runInfo()."-->"; ?>

</body>
</html>



/*******************************************************************************
 File : \root\tools\setup\index.php 
*******************************************************************************/
<?php 
$_cbase['ucfg']['lang'] = '(auto)'; 
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php');  

// Check proot
$proot = devRun::prootGet();
if($proot!=PATH_PROJ){ 
	header("Location:../adbug/start.php?FixProot"); 
	die();
}
// Check start
$csmsg = devRun::startCheck(); 
if(!empty($csmsg)){ 
	header('Location:../adbug/start.php'); 
	die(); 
}

$setCfgs = devSetup::supCfgs();

$act = basReq::val('act');
$step = basReq::val('step');
$tab = basReq::val('tab');
$func = "sup$act"; //print_r(devSetup::$func($tab)); //echo $func;

if($act=='EditDB'){ 
	$dbname = basReq::val('dbname'); 
	$dbnold = basReq::val('dbnold');
	if($dbname!==$dbnold){
		devData::rstVals(DIR_CODE."/cfgs/boot/cfg_db.php",array('db_name'=>$dbname),0);
	}else{
		devRun::startDbadd($dbname);
	}
	header('Location:?');
}elseif($act=='Mark'){
	@die(devSetup::$func($step));
}elseif(method_exists('devSetup',$func)){
	devSetup::$func($tab);
}

glbHtml::page(lang('tools.setup_title')." - ".$_cbase['sys_name'],1);
glbHtml::page('imp');
echo basJscss::imp("/tools/setup/sfunc.js");
echo basJscss::imp("/tools/setup/sfunc-{$_cbase['sys']['lang']}.js");
echo basJscss::imp("/tools/setup/style.css");
glbHtml::page('body');

$cmydb3 = devRun::runMydb3();
$cmynow = $cmydb3[glbDBObj::getCfg('db_class')];
include(DIR_CODE.'/cfgs/boot/cfg_db.php'); //print_r($cmynow);

$orguser = 'adm_'.basKeyid::kidRand(0,3);
$orgpass = 'pass_'.basKeyid::kidRand(0,3);

require(dirname(__FILE__).'/sflow.htm');
#vopShow::inc('/tools/rhome/home.htm',DIR_ROOT); //通过模板解析
glbHtml::page('end');
?>


/*******************************************************************************
 File : \root\tools\setup\sfunc-cn.js 
*******************************************************************************/

Lang.setup = {

    'idpw_rule' : '帐号密码不规范: \n字母/数字/下划线组成, 且字母开头\n帐号:3~15个字符, 密码:6~24个字符\n且不能是如下简单字串:\n',
    'dbcreat' : '创建',
    'dbedit' : '修改',
    'end_notrefresh' : '安装结束,请不要刷新',
    'userid' : '帐号:',
    'password' : '密码:',
    'url_frant' : '前台地址:',
    'url_admin' : '后台登录地址:',
    'doing' : '正在处理:[第{val}步]',
    'step_no' : '[第{val}步]',
    'step_flow' : '请按先后顺序执行',
    'do_error' : '处理失败',
    'error' : '错误',
    'done' : '已处理:',
    'start' : '-开始-',
    'impres' : '表{val}导入结果: ',
    'result' : '处理结果: ',

    'xx' : 'xx'

};



/*******************************************************************************
 File : \root\tools\setup\sfunc-en.js 
*******************************************************************************/

Lang.setup = {

    'idpw_rule' : 'id/pw rule:\nletter/number/underline,and begins with letter\nid:3~15 letters, pass:6~24 letters\nbut CAN NOT as below:\n',
    'dbcreat' : 'Create',
    'dbedit' : 'Edit',
    'end_notrefresh' : 'Setup End, NOT Refresh!',
    'userid' : 'Userid:',
    'password' : 'Password:',
    'url_frant' : 'Frant Url:',
    'url_admin' : 'Admin Url:',
    'doing' : 'Doing:[step {val}]',
    'step_no' : '[step {val}]',
    'step_flow' : 'Please follow the order',
    'do_error' : 'Done Failure',
    'error' : 'Error',
    'done' : 'Done:',
    'start' : '-Start-',
    'impres' : 'Table:{val} Import Result: ',
    'result' : 'Deel Result: ',

    'xx' : 'xx'

};



/*******************************************************************************
 File : \root\tools\setup\sfunc.js 
*******************************************************************************/


function upInit(){
	$('#alltips').hide();
	var n = 0;
	$("[type='button']").each(function(index, element) {
		var id = $(this).attr("id"); //jsLog(id);
		if(steps.indexOf(id)>0){
			$(this).prop('disabled',true);
			$(this).removeClass('btn');
			$(this).addClass('dis');
		}else if(n==0 && steps.indexOf(id)<=0){
			n++;
		}else{
			$(this).prop('disabled',true);
			$(this).removeClass('btn');
			$(this).addClass('dis');
		}
	});
}

function upDir(e){
	var id = $(e).attr("id");
	location.href = '?step='+id;
}
function upTip(e){
	var id = $(e).attr("id");
	var msg = $('#tips_'+id).html(); 
	$('#reinfo').html(msg);
}

/*
function clear1(){
	if(confirm("确定要清空数据吗？")){
		document.main.text1.value="";
	}
}
*/

function chkIdpass(e,no,len){
	var tmp = $(e).val().replace(/\W/g, ""); //jsLog(tmp);
	if(simpass.indexOf(tmp)>0 || tmp.length<len){
		tmp = orgcfgs[no];
		alert(lang('setup.idpw_rule')+simpass);
	}
	$(e).val(tmp);
}
function chkDbname(){
	var msg = $('#dbname').val()==$('#dbnold').val() ? lang('setup.dbcreat') : lang('setup.dbedit');
	$('#bdbedit').val(msg);
}

function setStp12(step){
	var url = '?step='+step+'&act='+steps[step]+'&'+jsRnd();
	$.get(url, function(re){
		re = setJSON(step,re);
		if(re.res=='OK'){
			setState('step'+step,2,step); 
		}else{ 
			setState(step); 
		}
	});
}

function setStp34(step,id){
	if(step){
		var tabs = step==3 ? base_tabs : demo_tabs;
		var arr = tabs.split(',');
		var id = id ? id : 0; var tab = arr[id]; 
		var url = '?step='+step+'&act=Imps&tab='+tab+'&'+jsRnd();
		$.get(url, function(re){ 
			re = setJSON(step,re,tab);
			if(re.res=='OK'){
				id++; 
				if(id<arr.length){
					setTimeout("setStp34("+step+","+id+")",10);	
				}else{
					setTimeout("setStp34(0,"+step+")",10);
				}
			}else{ setState(step); }
		});
	}else{ //Finish //console.log(re);
		setJSON(id,"{'res':'OK','msg':''}");
		setState('step'+id,2,id); //step = id;
	}
}

function setStp5s(step,send){
	$('#xform').toggle();
	$('#xinfo').toggle();	
	if(!send) return;
	loadShow();
	var name = $('#name').val(), uid = $('#uid').val(), upw = $('#upw').val();
	var url = '?step='+step+'&act=Idpw&uid='+uid+'&upw='+upw+'&name='+encodeURIComponent(name)+'&'+jsRnd();
	$.get(url, function(re){ 
		re = setJSON(step,re);
		if(re.res=='OK'){
			setState('step'+step,2,step); 
			var urla = ''+_cbase.run.roots+'/run/adm.php';
			urla = '<a href="'+urla+'" target="_blank" class="c30F">'+urla+'</a>';
			var urlh = ''+_cbase.run.rmain+'';
			urlh = '<a href="'+urlh+'" target="_blank" class="c30F">'+urlh+'</a>';
			var msg = '<a class="f14 fB">['+name+']</a> '+lang('setup.end_notrefresh');
			msg += '<br>'+lang('setup.userid')+'[<span class="cF03 f16">'+uid+'</span>]';
			msg += ' '+lang('setup.password')+'[<span class="cF03 f16">'+upw+'</span>] ';
			msg += '<br>'+lang('setup.url_frant')+' '+urlh+'';
			msg += '<br>'+lang('setup.url_admin')+' '+urla+'<hr>';
			$('#reinfo').html(msg+$('#reinfo').html());
		}else{ setState(step); }
	});
}

function setMain(step){
	if(!nowStep){ $('#reinfo').html(''); } nowStep = step;
	$('#resone td').eq(0).html(lang('setup.doing',step));	
	if(step>1){
		var html = $('#step'+(step-1)+' td').eq(2).html();
		if(html.indexOf('isYes')<0) { alert(lang('setup.step_flow')); return; }
	}
	if(step<5) loadShow(); // tip : 正在处理, 请稍候…… 
	if(step==1||step==2){
		setStp12(step);
	}else if(step==3||step==4){
		setStp34(step);
	}else if(step==5){
		setStp5s(step);
	}
}

function setState(trPart,tdNo,step){ 
	if(!trPart){ //初始化
		for(var i=1;i<=5;i++){
			eval('var tmp=step'+i+';');
			if(tmp=='OK'){ setState('step'+i,2,i); }	
			else{ break; }
		}
		$('#resone td').eq(0).html(fRes);		
	}else if(isObj(trPart,'n')){ //setp:出错
		$('#resone td').eq(0).html(lang('setup.step_no',step)+':'+lang('setup.do_error'));	
		$('#step'+' td').eq(2).html(fNO.replace('No',lang('setup.error')));	
	}else{ //成功 if(trPart)
		var url = '?step='+step+'&act=Mark&'+jsRnd();
		$.get(url, function(re){ 
			$('#'+trPart+' td').eq(tdNo).html(fYES);
			$('#resone td').eq(0).html(lang('setup.done')+lang('setup.step_no',step)+'');
			if(step<5){
				$('#step'+(step+1)+' input').eq(0).val(lang('setup.start'));
			}
		});
	}
	loadStop();
}

function setJSON(step,data,tab){ 
	try{ eval('var re = '+data+''); } 
	catch(e){ 
		var re = {};
		re.res = e.name;
		re.msg = e.name+' @ '+e.message+' ::: '+data; 
	} //jsLog(re);
	msg = (tab ? lang('setup.impres',tab) : '<b>'+lang('setup.step_no',step)+lang('setup.result'))+re.res+re.msg+'</b><br>';
	$('#reinfo').html(msg+$('#reinfo').html());
	return re;
}

// 定时器-显示
function loadShow(){
	$('#idLoad').show(); //jsLog('a, ');
	$('#idLoad img').toggle();
	otimer = setTimeout("loadShow()",1000); 
}
// 定时器-清除
function loadStop(){
	$('#idLoad').hide();
	clearTimeout(otimer);
}
//otimer = setLoading("loadShow()",1000);
//clearTimeout(otimer);



/*******************************************************************************
 File : \root\tools\setup\upvimp.php 
*******************************************************************************/
<?php
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php');

//check, re:cfgs:
$cfg = updDbcmp::uimpCheck(); //print_r($cfg);

$act = basReq::val('act');
$ano = basReq::val('ano','0'); 
$nav = '';

$groups = devBase::_tabGroup();
foreach($groups as $kg){
	$igap = $kg=='exd' ? '<br>' : '#';
	$nav .= "\n $igap <a href='?act={a}&ano=$kg'>$kg</a>";
}

glbHtml::page(lang('tools.upi_title').' - '.$_cbase['sys_name'],1);
glbHtml::page('imp');
echo basJscss::imp("/tools/setup/sfunc.js?".time());
echo basJscss::imp("/tools/setup/style.css");
glbHtml::page('body');

include(vopShow::inc('/tools/setup/upvimp.htm',DIR_ROOT));

$cnew = updBase::cacGet('uimp_new');
$cold = updBase::cacGet('uimp_old');

echo "<div class='upgres'>";
if($act=='cpcfg'){
	
	updDbcmp::uimpInit();
	echo lang('tools.upi_recache');
	
}elseif($act=='cptables'){

	$ctab = updDbcmp::cmpTable($cnew,$cold);
	echo "<pre>"; print_r($ctab); echo "</pre>"; 

}elseif($act=='cpfields'){
	
	$cfields = updDbcmp::cmpField($cnew,$cold,0);
	echo "<pre>"; print_r($cfields); echo "</pre>"; 
	updBase::cacSave($cfields,'uimp_fields');
	
}elseif($act=='cpindexs'){
	
	$cindexs = updDbcmp::cmpIndex($cnew,$cold,1);
	echo "<pre>"; print_r($cindexs); echo "</pre>"; 
	updBase::cacSave($cindexs,'cimp_indexs');

}elseif($act=='sqlins' || $act=='sqlrep'){
	 
	$pr0 = in_array($ano,$groups) ? "{$ano}_" : '';
	$sqls = updDbcmp::uimpTabs($cnew,$cold,$pr0);
    $dbnc = $cfg['new'];
    $r1 = array("{pre}",            "{ext}",            "dbnew.",             "dbold.",                   "\n");
    $r2 = array($dbnc['db_prefix'], $dbnc['db_suffix'], $dbnc['db_name'].".", $cfg['old']['db_name'].".", "<br>");
	foreach($sqls as $sql){
		if($act=='sqlrep') $sql = str_replace(array("INSERT INTO "),array("REPLACE INTO "),$sql);
		$sql = str_replace($r1,$r2,$sql); 
		echo "<br><br>\n$sql";	
	}
	echo "<br><br>\n";

}
echo "</div>";

glbHtml::page('end'); 

/*
	$pr[1] = array("8:archives","5:commu","7:members",);
	$pr[2] = array("7:aalbums","7:coclass","9:farchives","4:push",); 
	$pr[3] = 'currency1,currency2,dbfields,userfiles';
	$pr[4] = 'arctemp15,housesrecords,weituos';
*/

?>



/*******************************************************************************
 File : \root\tools\setup\upvnow.php 
*******************************************************************************/
<?php 
require(dirname(dirname(dirname(__FILE__))).'/run/_paths.php'); 

$act = basReq::val('act');
$step = basReq::val('step');
$flag = basReq::val('flag'); 

bootPerm_ys('pstools','','<p><a href="../adbug/binfo.php?login" target="x">login</a></p>');
$upc = updBase::preCheck(); //print_r($upc);

$msg = lang('tools.upn_tip1');
$res = "";
if($step=='null'){
	
}elseif(in_array($step,array('code_init','root_init'))){
	$res = updAdmin::doFileInit($upc,$step);
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('code_add','root_add'))){
	$res = updAdmin::doFileAE($upc,$step,'fileAdd');
	$msg = lang('tools.upn_afres');
	updAdmin::setStep($upc,$step);
	$upc['steps'] .= "$step`";
}elseif(in_array($step,array('code_edit','root_edit'))){
	$res = updAdmin::doFileAE($upc,$step,'fileEdit');
	$msg = lang('tools.upn_ofres');
	updAdmin::setStep($upc,$step);
	$upc['steps'] .= "$step`";
}elseif(in_array($step,array('code_comp','root_comp')) && empty($flag)){
	$res = updAdmin::doFileComp($upc,$step);
	$msg = lang('tools.upn_cpres');
	$msg .= " &gt; <a href='?step=$step&flag=1'>".lang('tools.upn_cnfm')."</a>";
}elseif(in_array($step,array('code_comp','root_comp')) && $flag){
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('code_tpls','root_skin'))){
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('dir_dtmp'))){
	$res = updAdmin::doDirDtmp($upc);
	$msg = lang('tools.upn_dtmp');
	updAdmin::setStep($upc,$step);
	$upc['steps'] .= "$step`";	
}elseif(in_array($step,array('dir_vimp3'))){	
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('db_init'))){	
	$res = updAdmin::doDbInit($upc); 
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('db_table'))){	
	$res = updAdmin::doDbTable($upc);
	$msg = lang('tools.upn_addtb');
	updAdmin::setStep($upc,$step);
	$upc['steps'] .= "$step`";
}elseif(in_array($step,array('db_fadd'))){ // && empty($flag)
	$res = updAdmin::doDbFAdd($upc);
	$msg = lang('tools.upn_addfld');
	updAdmin::setStep($upc,$step);
	$upc['steps'] .= "$step`";
}elseif(in_array($step,array('db_fcomp')) && empty($flag)){
	$res = updAdmin::doDbFComp($upc,$step);
	$msg = lang('tools.upn_cmpfld');
	$msg .= " &gt; <a href='?step=$step&flag=1'>".lang('tools.upn_cnfm')."</a>";
}elseif(in_array($step,array('db_fcomp')) && $flag){
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('db_data'))){
	updAdmin::setStep($upc,$step,1);
}elseif(in_array($step,array('end_ver'))){
	updAdmin::doVerset($upc);
	updAdmin::setStep($upc,$step,1); 
}elseif(in_array($step,array('end_flag'))){
	$upc['done'] = 'locked';
	updAdmin::setStep($upc,$step,1);
} 

$carrs = array('cmpfile','cmptable','cmpdata');
if(in_array($act,$carrs)){ 
	//
}elseif($act=='reset'){ 
	$f = updBase::preReset(basReq::val('path','','Html'));
	header('Location:?');
}else{
	$act = 'upmain';
} 
if(empty($upc['path'])){
	$act = 'reform';
}else{
	$pp = updBase::prePsyn($upc['path']); 
} // $act = 'upmain';

glbHtml::page(lang('tools.upn_title').' - '.$_cbase['sys_name'],1);
glbHtml::page('imp');
echo basJscss::imp("/tools/setup/sfunc.js?".time());
echo basJscss::imp("/tools/setup/style.css");
glbHtml::page('body');

if(in_array($act,$carrs)){ 
	include(vopShow::inc('/tools/setup/upcomp.htm',DIR_ROOT));
}else{
	include(vopShow::inc('/tools/setup/upflow.htm',DIR_ROOT));
}

//echo "<pre>";
//print_r($upc); print_r($rep); 
glbHtml::page('end');
?>
